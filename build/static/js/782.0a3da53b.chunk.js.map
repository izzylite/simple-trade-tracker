{"version":3,"file":"static/js/782.0a3da53b.chunk.js","mappings":"8JAUA,MAAMA,EAAqB,I,QAAIC,GAalBC,EAAsBC,MAAOC,EAAoBC,KAC5D,IACE,MAAMC,EAAM,IAAIC,KACVC,EAAiB,IAAID,KAAKD,EAAIG,UAAaC,cAE3CV,EAAmBW,OAAOP,EAAY,CAC1CQ,WAAYN,EACZO,WAAYR,EACZG,eAAgBA,EAChBM,WAAYR,IAGdS,EAAAA,OAAOC,IAAI,YAADC,OAAab,EAAU,mBACnC,CAAE,MAAOc,GAEP,MADAH,EAAAA,OAAOG,MAAM,kCAAmCA,GAC1CA,CACR,E","sources":["services/trashService.ts"],"sourcesContent":["/**\r\n * Trash Service - Supabase Repository Pattern\r\n * Handles soft delete and trash management for calendars\r\n * All types use snake_case to match Supabase schema\r\n */\r\n\r\nimport { Calendar } from '../types/dualWrite';\r\nimport { logger } from '../utils/logger';\r\nimport { CalendarRepository } from './repository/repositories/CalendarRepository';\r\n\r\nconst calendarRepository = new CalendarRepository();\r\nconst TRASH_RETENTION_DAYS = 30;\r\n\r\nexport interface TrashCalendar extends Calendar {\r\n  deleted_at: Date;\r\n  deleted_by: string;\r\n  auto_delete_at: Date;\r\n}\r\n\r\n/**\r\n * Move a calendar to trash (soft delete)\r\n * Marks the calendar as deleted and sets deletion timestamps\r\n */\r\nexport const moveCalendarToTrash = async (calendarId: string, userId: string): Promise<void> => {\r\n  try {\r\n    const now = new Date();\r\n    const auto_delete_at = new Date(now.getTime() + (TRASH_RETENTION_DAYS * 24 * 60 * 60 * 1000));\r\n\r\n    await calendarRepository.update(calendarId, {\r\n      deleted_at: now,\r\n      deleted_by: userId,\r\n      auto_delete_at: auto_delete_at,\r\n      updated_at: now\r\n    });\r\n\r\n    logger.log(`Calendar ${calendarId} moved to trash`);\r\n  } catch (error) {\r\n    logger.error('Error moving calendar to trash:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Restore a calendar from trash\r\n * Removes deletion markers and restores the calendar\r\n */\r\nexport const restoreCalendarFromTrash = async (calendarId: string): Promise<void> => {\r\n  try {\r\n    const calendar = await calendarRepository.findById(calendarId);\r\n\r\n    if (!calendar) {\r\n      throw new Error('Calendar not found');\r\n    }\r\n\r\n    if (!calendar.deleted_at) {\r\n      throw new Error('Calendar is not in trash');\r\n    }\r\n\r\n    // Remove deletion markers\r\n    await calendarRepository.update(calendarId, {\r\n      deleted_at: undefined,\r\n      deleted_by: undefined,\r\n      auto_delete_at: undefined,\r\n      updated_at: new Date()\r\n    });\r\n\r\n    logger.log(`Calendar ${calendarId} restored from trash`);\r\n  } catch (error) {\r\n    logger.error('Error restoring calendar from trash:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Permanently delete a calendar from trash\r\n * Marks the calendar for deletion\r\n * The webhook will handle actual cleanup and final deletion\r\n */\r\nexport const permanentlyDeleteCalendar = async (calendarId: string): Promise<void> => {\r\n  try {\r\n    const calendar = await calendarRepository.findById(calendarId);\r\n\r\n    if (!calendar) {\r\n      throw new Error('Calendar not found');\r\n    }\r\n\r\n    if (!calendar.deleted_at) {\r\n      throw new Error('Calendar is not in trash');\r\n    }\r\n\r\n    // Mark for deletion - webhook will handle actual deletion\r\n    await calendarRepository.delete(calendarId);\r\n\r\n    logger.log(`Calendar ${calendarId} marked for permanent deletion`);\r\n  } catch (error) {\r\n    logger.error('Error marking calendar for permanent deletion:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Get all calendars in trash for a user\r\n * Returns soft-deleted calendars that haven't been marked for final deletion\r\n */\r\nexport const getTrashCalendars = async (userId: string): Promise<TrashCalendar[]> => {\r\n  try {\r\n    const calendars = await calendarRepository.findTrashByUserId(userId);\r\n\r\n    return calendars.map(cal => ({\r\n      ...cal,\r\n      deleted_at: cal.deleted_at!,\r\n      deleted_by: cal.deleted_by || userId,\r\n      auto_delete_at: cal.auto_delete_at || new Date()\r\n    } as TrashCalendar));\r\n  } catch (error) {\r\n    logger.error('Error getting trash calendars:', error);\r\n    throw error;\r\n  }\r\n};\r\n \r\n\r\n/**\r\n * Get days remaining until permanent deletion\r\n */\r\nexport const getDaysUntilDeletion = (auto_delete_at: Date): number => {\r\n  const now = new Date();\r\n  const timeDiff = auto_delete_at.getTime() - now.getTime();\r\n  const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));\r\n  return Math.max(0, daysDiff);\r\n};\r\n \r\n"],"names":["calendarRepository","CalendarRepository","moveCalendarToTrash","async","calendarId","userId","now","Date","auto_delete_at","getTime","TRASH_RETENTION_DAYS","update","deleted_at","deleted_by","updated_at","logger","log","concat","error"],"sourceRoot":""}