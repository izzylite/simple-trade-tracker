{"version":3,"file":"static/js/727.a98779b8.chunk.js","mappings":"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AEnB3V,EAAM2V,WAAa,YAqBvB,GAAI+F,EAAO0B,cACT,IAAK,MAAOhK,EAAKzlB,KAAU+L,OAAOoL,QAAQ4W,EAAO0B,oBACnBx2B,IAAvBoZ,EAAcoT,KAChBpT,EAAcoT,GAAOzlB,GAM5B,MAAM0vB,EAA+B,CAAC,SAAU,cAChD,IAAK,MAAM5B,KAAS4B,OACYz2B,IAAzBoZ,EAAcyb,IACjBc,EAAOrS,KAAK,CACV0N,IAAK0E,EACLT,OAAQJ,EACRA,QACAzf,SAAU,QACV5E,QAAQ,mBAAD3Q,OAAqBw0B,GAAqBQ,GAAOP,YAAW,kBAgBzE,OAVKlb,EAAMxW,MACTgzB,EAAStS,KAAK,CACZ0N,IAAK0E,EACLT,OAAQ,OACRJ,MAAO,OACPzf,SAAU,UACV5E,QAAS,wBAIN,CAAE4I,QAAOuc,SAAQC,WAC1B,CC1UA,MAAMc,GAA+C,CACnDjI,WAAY,CACV,OACA,aACA,aACA,YACA,MACA,YACA,OACA,WACA,iBACA,cAEFpV,OAAQ,CACN,SACA,MACA,MACA,SACA,OACA,cACA,cACA,MACA,aACA,SACA,MAEF0V,WAAY,CACV,OACA,aACA,aACA,YACA,SACA,UACA,SACA,WACA,YAEFnsB,KAAM,CACJ,OACA,aACA,aACA,YACA,QACA,SACA,SACA,aACA,QACA,OACA,eAEFwsB,YAAa,CACX,QACA,cACA,cACA,aACA,YACA,MACA,aACA,OACA,iBACA,KACA,eAEFC,WAAY,CACV,OACA,aACA,aACA,YACA,aACA,OACA,cACA,QACA,aACA,MACA,cAEFoF,UAAW,CACT,YACA,YACA,WACA,KACA,MACA,MACA,OACA,cAEFC,YAAa,CACX,cACA,cACA,aACA,KACA,MACA,MACA,SACA,eACA,iBAEFlF,eAAgB,CACd,iBACA,iBACA,eACA,MACA,KACA,MACA,MACA,cACA,cACA,cACA,eAEFmF,eAAgB,CACd,WACA,iBACA,iBACA,UACA,iBACA,aACA,YACA,gBAEFjF,QAAS,CACP,UACA,kBACA,iBACA,eACA,SACA,SAEFE,MAAO,CACL,QACA,OACA,WACA,UACA,cACA,UACA,UA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","sources":["components/common/UnifiedDrawer.tsx","components/CalendarFormDialog.tsx","services/tagService.ts","components/aiChat/AIChatDrawer.tsx","components/trades/DayDialog.tsx","components/TargetBadge.tsx","components/SelectDateDialog.tsx","components/TagManagementDialog.tsx","components/TagCreateDialog.tsx","components/TagManagementDrawer.tsx","components/TradeCardShimmer.tsx","components/SearchDrawer.tsx","components/CalendarGrid.tsx","utils/tradeExportImport.ts","utils/statsUtils.ts","utils/typeConverters.ts","utils/importValidation.ts","utils/columnDetection.ts","components/import/ColumnMapper.tsx","components/import/ImportPreview.tsx","components/import/ValidationSummary.tsx","components/import/TypeConverterPanel.tsx","utils/importMappingStorage.ts","components/import/MappingTemplateManager.tsx","components/import/ImportMappingDialog.tsx","utils/scoreUtils.ts","workers/utils/workerManager.ts","workers/tagPatternWorker.ts","services/tagPatternService.ts","services/scoreService.ts","components/scoring/ScoreCard.tsx","components/scoring/ScoreBreakdown.tsx","components/scoring/ScoreHistory.tsx","components/scoring/ExcludedTagsSelector.tsx","components/scoring/TagSelector.tsx","components/scoring/ScoreSettings.tsx","components/TagPatternAnalysis.tsx","components/scoring/ScoreSection.tsx","utils/chartDataUtils.ts","components/common/ShimmerChartLoader.tsx","components/charts/CumulativePnLChart.tsx","components/charts/DailyPnLChart.tsx","components/charts/PnLChartsWrapper.tsx","components/charts/WinLossDistribution.tsx","components/charts/WinLossStats.tsx","components/TagFilterDialog.tsx","services/performanceCalculationService.ts","components/charts/TagPerformanceAnalysis.tsx","components/charts/TagDayOfWeekAnalysis.tsx","components/charts/DailySummaryTable.tsx","components/charts/SessionPerformanceAnalysis.tsx","components/charts/TradesListDialog.tsx","components/charts/RiskRewardChart.tsx","components/charts/EconomicEventCorrelationAnalysis.tsx","components/PerformanceCharts.tsx","components/MonthlyStats.tsx","components/AccountStats.tsx","components/PinnedTradesDrawer.tsx","components/TradeGalleryDialog.tsx","components/reminderNotes/NoteCard.tsx","components/reminderNotes/PlaceholderNoteCard.tsx","components/reminderNotes/NotesBottomSheet.tsx","components/reminderNotes/StackedNotesWidget.tsx","components/reminderNotes/useReminderNotes.ts","components/FloatingMonthNavigation.tsx","services/economicEventWatcher.ts","components/notifications/EconomicEventNotification.tsx","hooks/useHighImpactEvents.ts","utils/notificationSound.ts","hooks/useCalendarTrades.ts","pages/TradeCalendarPage.tsx","hooks/useEconomicEventWatcher.ts","utils/formatters.ts","services/repository/repositories/ConversationRepository.ts","hooks/useAIChat.ts","components/notes/NoteListItem.tsx","components/ImageZoomDialog.tsx","components/heroImage/ImagePickerDialog.tsx","utils/dialogUtils.ts","services/repository/repositories/NoteRepository.ts","services/notesService.ts","utils/dynamicRiskUtils.ts","components/common/AnimatedBackground.tsx","components/trades/TradeFormDialog.tsx","components/notes/NoteEditorDialog.tsx","components/TagEditDialog.tsx","components/aiChat/AnimatedText.tsx","components/aiChat/EventCard.tsx","components/aiChat/ExpandableCardList.tsx","components/aiChat/HtmlMessageRenderer.tsx","components/aiChat/CitationsSection.tsx","components/aiChat/MarkdownRenderer.tsx","components/aiChat/ChatMessage.tsx","components/aiChat/AIChatMentionInput.tsx","components/aiChat/AIChatInterface.tsx","components/trades/TagsInput.tsx","utils/tradeNameSuggestions.ts","components/trades/TradeForm.tsx","components/trades/ImageGrid.tsx","components/trades/ImageUploader.tsx","components/trades/ProgressSection.tsx","components/aiChat/TradeCard.tsx","components/trades/DayHeader.tsx","components/common/RichTextEditor/RichTextViewer.tsx","components/notes/NoteViewerDialog.tsx","components/notes/NotesDrawer.tsx","hooks/useNotes.ts"],"sourcesContent":["import React, { ReactNode } from 'react';\r\nimport {\r\n  Drawer,\r\n  Box,\r\n  Typography,\r\n  IconButton,\r\n  alpha,\r\n  useTheme,\r\n  SxProps,\r\n  Theme\r\n} from '@mui/material';\r\nimport { Close as CloseIcon } from '@mui/icons-material';\r\n\r\nexport interface UnifiedDrawerProps {\r\n  // Basic drawer props\r\n  open: boolean;\r\n  onClose: () => void;\r\n  anchor?: 'left' | 'right' | 'top' | 'bottom';\r\n  keepMounted?: boolean; // Keep drawer mounted when closed to preserve state\r\n\r\n  // Header configuration\r\n  title: string;\r\n  subtitle?: string;\r\n  icon?: ReactNode;\r\n  headerActions?: ReactNode; // Additional actions in header (badges, buttons, etc.)\r\n\r\n  // Content\r\n  children: ReactNode;\r\n\r\n  // Styling options\r\n  width?: { xs?: string | number; sm?: string | number };\r\n  maxWidth?: string;\r\n  zIndex?: number;\r\n\r\n  // Header styling variants\r\n  headerVariant?: 'default' | 'enhanced'; // enhanced = gradient background with blur\r\n\r\n  // Custom styles\r\n  sx?: SxProps<Theme>;\r\n  headerSx?: SxProps<Theme>;\r\n  contentSx?: SxProps<Theme>;\r\n}\r\n\r\nconst UnifiedDrawer: React.FC<UnifiedDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  anchor = 'right',\r\n  keepMounted = false,\r\n  title,\r\n  subtitle,\r\n  icon,\r\n  headerActions,\r\n  children,\r\n  width = { xs: '100%', sm: 450 },\r\n  maxWidth = '100vw',\r\n  zIndex = 1300,\r\n  headerVariant = 'enhanced',\r\n  sx,\r\n  headerSx,\r\n  contentSx\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Enhanced styling (used by SearchDrawer and EconomicCalendarDrawer)\r\n  const enhancedDrawerStyles = {\r\n    background: theme.palette.mode === 'dark'\r\n      ? 'linear-gradient(135deg, rgba(18, 18, 18, 0.95) 0%, rgba(30, 30, 30, 0.95) 100%)'\r\n      : 'linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%)',\r\n    backdropFilter: 'blur(20px)',\r\n    borderLeft: anchor === 'right' ? `1px solid ${alpha(theme.palette.divider, 0.1)}` : undefined,\r\n    borderRight: anchor === 'left' ? `1px solid ${alpha(theme.palette.divider, 0.1)}` : undefined,\r\n    boxShadow: theme.palette.mode === 'dark'\r\n      ? '0 8px 32px rgba(0, 0, 0, 0.4)'\r\n      : '0 8px 32px rgba(0, 0, 0, 0.12)'\r\n  };\r\n\r\n  // Enhanced header styling\r\n  const enhancedHeaderStyles = {\r\n    p: 3,\r\n    borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    gap: 2,\r\n    background: alpha(theme.palette.background.paper, 0.8),\r\n    backdropFilter: 'blur(10px)'\r\n  };\r\n\r\n  // Default header styling (used by PinnedTradesDrawer)\r\n  const defaultHeaderStyles = {\r\n    p: 2,\r\n    borderBottom: `1px solid ${theme.palette.divider}`,\r\n    display: 'flex',\r\n    alignItems: 'center',\r\n    gap: 2\r\n  };\r\n\r\n  const headerStyles = headerVariant === 'enhanced' ? enhancedHeaderStyles : defaultHeaderStyles;\r\n\r\n  return (\r\n    <Drawer\r\n      anchor={anchor}\r\n      open={open}\r\n      onClose={onClose}\r\n      ModalProps={{ keepMounted }}\r\n      sx={{\r\n        zIndex,\r\n        '& .MuiDrawer-paper': {\r\n          width,\r\n          maxWidth,\r\n          zIndex,\r\n          ...(headerVariant === 'enhanced' ? enhancedDrawerStyles : {})\r\n        },\r\n        ...sx\r\n      }}\r\n    >\r\n      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>\r\n        {/* Header */}\r\n        <Box sx={{ ...headerStyles, ...headerSx }}>\r\n          {/* Icon */}\r\n          {icon && (\r\n            <Box sx={{\r\n              p: headerVariant === 'enhanced' ? 1.5 : 1,\r\n              borderRadius: headerVariant === 'enhanced' ? 2 : 1,\r\n              background: headerVariant === 'enhanced'\r\n                ? `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.1)} 0%, ${alpha(theme.palette.primary.main, 0.05)} 100%)`\r\n                : alpha(theme.palette.primary.main, 0.1),\r\n              border: headerVariant === 'enhanced' \r\n                ? `1px solid ${alpha(theme.palette.primary.main, 0.2)}`\r\n                : undefined,\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'center'\r\n            }}>\r\n              {React.isValidElement(icon) && typeof icon.type !== 'string'\r\n                ? React.cloneElement(icon as React.ReactElement<any>, {\r\n                    sx: {\r\n                      color: 'primary.main',\r\n                      fontSize: headerVariant === 'enhanced' ? 22 : 20\r\n                    }\r\n                  })\r\n                : React.isValidElement(icon)\r\n                ? React.cloneElement(icon as React.ReactElement<any>, {\r\n                    style: {\r\n                      color: 'var(--mui-palette-primary-main)',\r\n                      fontSize: headerVariant === 'enhanced' ? 22 : 20\r\n                    }\r\n                  })\r\n                : icon\r\n              }\r\n            </Box>\r\n          )}\r\n\r\n          {/* Title and Subtitle */}\r\n          <Box sx={{ flex: 1 }}>\r\n            <Typography variant=\"h6\" sx={{ \r\n              fontWeight: headerVariant === 'enhanced' ? 700 : 600,\r\n              mb: subtitle ? 0.5 : 0\r\n            }}>\r\n              {title}\r\n            </Typography>\r\n            {subtitle && (\r\n              <Typography variant=\"caption\" sx={{\r\n                color: 'text.secondary',\r\n                fontSize: '0.75rem'\r\n              }}>\r\n                {subtitle}\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n\r\n          {/* Header Actions */}\r\n          {headerActions}\r\n\r\n          {/* Close Button */}\r\n          <IconButton\r\n            onClick={onClose}\r\n            size=\"small\"\r\n          >\r\n            <CloseIcon />\r\n          </IconButton>\r\n        </Box>\r\n\r\n        {/* Content */}\r\n        <Box sx={{ \r\n          flex: 1, \r\n          overflow: 'auto',\r\n          ...contentSx \r\n        }}>\r\n          {children}\r\n        </Box>\r\n      </Box>\r\n    </Drawer>\r\n  );\r\n};\r\n\r\nexport default UnifiedDrawer;\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Button,\r\n  TextField,\r\n  Stack,\r\n  Box,\r\n  CircularProgress,\r\n  Typography,\r\n  FormControlLabel,\r\n  Switch,\r\n  Card,\r\n  CardMedia,\r\n  IconButton,\r\n  Tooltip,\r\n  alpha,\r\n  useTheme\r\n} from '@mui/material';\r\nimport {\r\n  Image as ImageIcon,\r\n  Delete as DeleteIcon,\r\n\r\n} from '@mui/icons-material';\r\nimport { Calendar } from '../types/calendar';\r\nimport { BaseDialog } from './common';\r\nimport { ImagePickerDialog, ImageAttribution } from './heroImage';\r\n\r\nexport interface CalendarFormData {\r\n  name: string;\r\n  account_balance: number;\r\n  max_daily_drawdown: number;\r\n  weekly_target?: number;\r\n  monthly_target?: number;\r\n  yearly_target?: number;\r\n  risk_per_trade?: number;\r\n  dynamic_risk_enabled?: boolean;\r\n  increased_risk_percentage?: number;\r\n  profit_threshold_percentage?: number;\r\n  hero_image_url?: string;\r\n  hero_image_attribution?: ImageAttribution;\r\n\r\n}\r\n\r\ninterface CalendarFormDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onSubmit: (calendarData: CalendarFormData) => Promise<void>;\r\n  initialData?: Partial<Calendar>;\r\n  isSubmitting: boolean;\r\n  mode: 'create' | 'edit';\r\n  title: string;\r\n  submitButtonText: string;\r\n}\r\n\r\nexport const CalendarFormDialog: React.FC<CalendarFormDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  onSubmit,\r\n  initialData,\r\n  isSubmitting,\r\n  mode,\r\n  title,\r\n  submitButtonText\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Form state\r\n  const [name, setName] = useState('');\r\n  const [account_balance, setAccount_balance] = useState('');\r\n  const [max_daily_drawdown, setMax_daily_drawdown] = useState('');\r\n  const [weekly_target, setWeekly_target] = useState('');\r\n  const [monthly_target, setMonthly_target] = useState('');\r\n  const [yearly_target, setYearly_target] = useState('');\r\n  const [risk_per_trade, setRisk_per_trade] = useState('');\r\n  const [dynamic_risk_enabled, setDynamicRiskEnabled] = useState(false);\r\n  const [increased_risk_percentage, setIncreasedRiskPercentage] = useState('');\r\n  const [profit_threshold_percentage, setProfitThresholdPercentage] = useState('');\r\n\r\n  // Hero image state\r\n  const [hero_image_url, setHeroImageUrl] = useState<string>('');\r\n  const [hero_image_attribution, setHeroImageAttribution] = useState<ImageAttribution | undefined>(undefined);\r\n\r\n  const [isImagePickerOpen, setIsImagePickerOpen] = useState(false);\r\n\r\n  // Initialize form with initial data when in edit mode or when initial data is provided, or reset when dialog opens/closes\r\n  useEffect(() => {\r\n    if (open) {\r\n      if (initialData) {\r\n        setName(initialData.name || '');\r\n        setAccount_balance(initialData.account_balance?.toString() || '');\r\n        setMax_daily_drawdown(initialData.max_daily_drawdown?.toString() || '');\r\n        setWeekly_target(initialData.weekly_target?.toString() || '');\r\n        setMonthly_target(initialData.monthly_target?.toString() || '');\r\n        setYearly_target(initialData.yearly_target?.toString() || '');\r\n        setRisk_per_trade(initialData.risk_per_trade?.toString() || '');\r\n        setDynamicRiskEnabled(initialData.dynamic_risk_enabled || false);\r\n        setIncreasedRiskPercentage(initialData.increased_risk_percentage?.toString() || '');\r\n        setProfitThresholdPercentage(initialData.profit_threshold_percentage?.toString() || '');\r\n        setHeroImageUrl(initialData.hero_image_url || '');\r\n        setHeroImageAttribution(initialData.hero_image_attribution);\r\n\r\n      } else {\r\n        // Reset form for create mode without initial data\r\n        resetForm();\r\n      }\r\n    }\r\n  }, [open, initialData, mode]);\r\n\r\n  const resetForm = () => {\r\n    setName('');\r\n    setAccount_balance('');\r\n    setMax_daily_drawdown('');\r\n    setWeekly_target('');\r\n    setMonthly_target('');\r\n    setYearly_target('');\r\n    setRisk_per_trade('');\r\n    setDynamicRiskEnabled(false);\r\n    setIncreasedRiskPercentage('');\r\n    setProfitThresholdPercentage('');\r\n    setHeroImageUrl('');\r\n    setHeroImageAttribution(undefined);\r\n\r\n  };\r\n\r\n  const handleSubmit = async () => {\r\n    if (name.trim() && account_balance.trim() && max_daily_drawdown.trim()) {\r\n      const balance = parseFloat(account_balance);\r\n      const maxDrawdown = parseFloat(max_daily_drawdown);\r\n      const weeklyTargetValue = weekly_target.trim() ? parseFloat(weekly_target) : undefined;\r\n      const monthlyTargetValue = monthly_target.trim() ? parseFloat(monthly_target) : undefined;\r\n      const yearlyTargetValue = yearly_target.trim() ? parseFloat(yearly_target) : undefined;\r\n      const riskPerTradeValue = risk_per_trade.trim() ? parseFloat(risk_per_trade) : undefined;\r\n      const increasedRiskValue = increased_risk_percentage.trim() ? parseFloat(increased_risk_percentage) : undefined;\r\n      const profitThresholdValue = profit_threshold_percentage.trim() ? parseFloat(profit_threshold_percentage) : undefined;\r\n\r\n      if (!isNaN(balance) && balance >= 0 && !isNaN(maxDrawdown) && maxDrawdown > 0 &&\r\n          (weeklyTargetValue === undefined || (!isNaN(weeklyTargetValue) && weeklyTargetValue > 0)) &&\r\n          (monthlyTargetValue === undefined || (!isNaN(monthlyTargetValue) && monthlyTargetValue > 0)) &&\r\n          (yearlyTargetValue === undefined || (!isNaN(yearlyTargetValue) && yearlyTargetValue > 0)) &&\r\n          (riskPerTradeValue === undefined || (!isNaN(riskPerTradeValue) && riskPerTradeValue > 0)) &&\r\n          (increasedRiskValue === undefined || (!isNaN(increasedRiskValue) && increasedRiskValue > 0)) &&\r\n          (profitThresholdValue === undefined || (!isNaN(profitThresholdValue) && profitThresholdValue > 0))) {\r\n\r\n        await onSubmit({\r\n          name: name.trim(),\r\n          account_balance: balance,\r\n          max_daily_drawdown: maxDrawdown,\r\n          weekly_target: weeklyTargetValue,\r\n          monthly_target: monthlyTargetValue,\r\n          yearly_target: yearlyTargetValue,\r\n          risk_per_trade: riskPerTradeValue,\r\n          dynamic_risk_enabled,\r\n          increased_risk_percentage: increasedRiskValue,\r\n          profit_threshold_percentage: profitThresholdValue,\r\n          hero_image_url: hero_image_url || undefined,\r\n          hero_image_attribution: hero_image_attribution,\r\n\r\n        });\r\n      }\r\n    }\r\n  };\r\n\r\n  // Hero image handlers\r\n  const handleImageSelect = (imageUrl: string, attribution?: ImageAttribution) => {\r\n    setHeroImageUrl(imageUrl);\r\n    setHeroImageAttribution(attribution);\r\n    setIsImagePickerOpen(false);\r\n  };\r\n\r\n  const handleRemoveImage = () => {\r\n    setHeroImageUrl('');\r\n    setHeroImageAttribution(undefined);\r\n\r\n  };\r\n\r\n\r\n\r\n  const isFormValid = name.trim() && account_balance.trim() && max_daily_drawdown.trim();\r\n\r\n  const dialogTitle = title;\r\n\r\n  const dialogActions = (\r\n    <>\r\n      <Button\r\n        onClick={onClose}\r\n        disabled={isSubmitting}\r\n      >\r\n        Cancel\r\n      </Button>\r\n      <Button\r\n        onClick={handleSubmit}\r\n        variant=\"contained\"\r\n        disabled={!isFormValid || isSubmitting}\r\n        sx={{\r\n          minWidth: 100,\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: 1\r\n        }}\r\n      >\r\n        {submitButtonText}\r\n        {isSubmitting && (\r\n          <CircularProgress\r\n            size={20}\r\n            color=\"inherit\"\r\n          />\r\n        )}\r\n      </Button>\r\n    </>\r\n  );\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={() => !isSubmitting && onClose()}\r\n      maxWidth=\"xs\"\r\n      fullWidth\r\n      title={dialogTitle}\r\n      actions={dialogActions}\r\n      hideFooterCancelButton={true}\r\n    >\r\n      <Stack spacing={2} sx={{ mt: 1 }}>\r\n          <TextField\r\n            label=\"Calendar Name\"\r\n            fullWidth\r\n            value={name}\r\n            onChange={(e) => setName(e.target.value)}\r\n            autoFocus\r\n          />\r\n\r\n          {/* Hero Image Section */}\r\n          <Box>\r\n            <Typography variant=\"subtitle2\" sx={{ mb: 1.5, fontWeight: 600 }}>\r\n              Cover Image (Optional)\r\n            </Typography>\r\n\r\n            {hero_image_url ? (\r\n              <Card sx={{\r\n                position: 'relative',\r\n                borderRadius: 2,\r\n                overflow: 'hidden',\r\n                border: '1px solid',\r\n                borderColor: 'divider'\r\n              }}>\r\n                <CardMedia\r\n                  component=\"div\"\r\n                  sx={{\r\n                    height: 120,\r\n                    backgroundImage: `url(${hero_image_url})`,\r\n                    backgroundSize: 'cover',\r\n                    backgroundPosition: 'center',\r\n                    backgroundRepeat: 'no-repeat',\r\n                    position: 'relative',\r\n                    '&::before': {\r\n                      content: '\"\"',\r\n                      position: 'absolute',\r\n                      top: 0,\r\n                      left: 0,\r\n                      right: 0,\r\n                      bottom: 0,\r\n                      background: `linear-gradient(to bottom, ${alpha(theme.palette.common.black, 0.1)}, ${alpha(theme.palette.common.black, 0.3)})`,\r\n                      zIndex: 1\r\n                    }\r\n                  }}\r\n                />\r\n\r\n                {/* Image controls overlay */}\r\n                <Box sx={{\r\n                  position: 'absolute',\r\n                  top: 8,\r\n                  right: 8,\r\n                  display: 'flex',\r\n                  gap: 1,\r\n                  zIndex: 2\r\n                }}>\r\n\r\n\r\n                  <Tooltip title=\"Remove image\">\r\n                    <IconButton\r\n                      size=\"small\"\r\n                      onClick={handleRemoveImage}\r\n                      sx={{\r\n                        backgroundColor: alpha(theme.palette.error.main, 0.9),\r\n                        color: 'white',\r\n                        '&:hover': {\r\n                          backgroundColor: theme.palette.error.main,\r\n                        }\r\n                      }}\r\n                    >\r\n                      <DeleteIcon fontSize=\"small\" />\r\n                    </IconButton>\r\n                  </Tooltip>\r\n                </Box>\r\n\r\n                {/* Attribution */}\r\n                {hero_image_attribution && (\r\n                  <Box sx={{\r\n                    position: 'absolute',\r\n                    bottom: 4,\r\n                    right: 4,\r\n                    backgroundColor: alpha(theme.palette.common.black, 0.7),\r\n                    color: 'white',\r\n                    px: 1,\r\n                    py: 0.5,\r\n                    borderRadius: 0.5,\r\n                    zIndex: 2\r\n                  }}>\r\n                    <Typography variant=\"caption\" sx={{ fontSize: '0.6rem' }}>\r\n                       {hero_image_attribution.photographer}\r\n                    </Typography>\r\n                  </Box>\r\n                )}\r\n              </Card>\r\n            ) : (\r\n              <Button\r\n                variant=\"outlined\"\r\n                startIcon={<ImageIcon />}\r\n                onClick={() => setIsImagePickerOpen(true)}\r\n                sx={{\r\n                  height: 120,\r\n                  borderStyle: 'dashed',\r\n                  borderColor: 'divider',\r\n                  color: 'text.secondary',\r\n                  '&:hover': {\r\n                    borderColor: 'primary.main',\r\n                    color: 'primary.main',\r\n                    backgroundColor: alpha(theme.palette.primary.main, 0.04)\r\n                  }\r\n                }}\r\n                fullWidth\r\n              >\r\n                Add Cover Image\r\n              </Button>\r\n            )}\r\n          </Box>\r\n          <TextField\r\n            label={mode === 'create' ? \"Initial Account Balance\" : \"Account Balance\"}\r\n            fullWidth\r\n            value={account_balance}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setAccount_balance(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              startAdornment: <Box component=\"span\" sx={{ mr: 1 }}>$</Box>\r\n            }}\r\n          />\r\n          <TextField\r\n            label=\"Max Daily Drawdown (%)\"\r\n            fullWidth\r\n            value={max_daily_drawdown}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setMax_daily_drawdown(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n            }}\r\n            helperText=\"Maximum allowed loss percentage per day\"\r\n          />\r\n          <TextField\r\n            label=\"Weekly Target (%)\"\r\n            fullWidth\r\n            value={weekly_target}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setWeekly_target(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n            }}\r\n            helperText=\"Target profit percentage per week\"\r\n          />\r\n          <TextField\r\n            label=\"Monthly Target (%)\"\r\n            fullWidth\r\n            value={monthly_target}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setMonthly_target(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n            }}\r\n            helperText=\"Target profit percentage per month\"\r\n          />\r\n          <TextField\r\n            label=\"Yearly Target (%)\"\r\n            fullWidth\r\n            value={yearly_target}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setYearly_target(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n            }}\r\n            helperText=\"Target profit percentage per year\"\r\n          />\r\n          <TextField\r\n            label=\"Risk Per Trade (%)\"\r\n            fullWidth\r\n            value={risk_per_trade}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                setRisk_per_trade(value);\r\n              }\r\n            }}\r\n            type=\"number\"\r\n            InputProps={{\r\n              endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n            }}\r\n            helperText=\"Percentage of account balance to risk per trade (optional)\"\r\n          />\r\n\r\n          {risk_per_trade && (\r\n            <Box sx={{ border: '1px solid', borderColor: 'divider', borderRadius: 1, p: 2, mt: 1 }}>\r\n              <Typography variant=\"subtitle2\" sx={{ mb: 1.5, fontWeight: 600 }}>\r\n                Dynamic Risk Settings\r\n              </Typography>\r\n\r\n              <FormControlLabel\r\n                control={\r\n                  <Switch\r\n                    checked={dynamic_risk_enabled}\r\n                    onChange={(e) => setDynamicRiskEnabled(e.target.checked)}\r\n                    color=\"primary\"\r\n                  />\r\n                }\r\n                label=\"Enable Dynamic Risk\"\r\n                sx={{ mb: 1.5 }}\r\n              />\r\n\r\n              {dynamic_risk_enabled && (\r\n                <Stack spacing={2}>\r\n                  <TextField\r\n                    label=\"Profit Threshold (%)\"\r\n                    fullWidth\r\n                    value={profit_threshold_percentage}\r\n                    onChange={(e) => {\r\n                      const value = e.target.value;\r\n                      if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                        setProfitThresholdPercentage(value);\r\n                      }\r\n                    }}\r\n                    type=\"number\"\r\n                    InputProps={{\r\n                      endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n                    }}\r\n                    helperText=\"Increase risk when profit exceeds this percentage\"\r\n                    size=\"small\"\r\n                  />\r\n\r\n                  <TextField\r\n                    label=\"Increased Risk (%)\"\r\n                    fullWidth\r\n                    value={increased_risk_percentage}\r\n                    onChange={(e) => {\r\n                      const value = e.target.value;\r\n                      if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n                        setIncreasedRiskPercentage(value);\r\n                      }\r\n                    }}\r\n                    type=\"number\"\r\n                    InputProps={{\r\n                      endAdornment: <Box component=\"span\" sx={{ ml: 1 }}>%</Box>\r\n                    }}\r\n                    helperText=\"New risk percentage when profit threshold is exceeded\"\r\n                    size=\"small\"\r\n                  />\r\n                </Stack>\r\n              )}\r\n            </Box>\r\n          )}\r\n        </Stack>\r\n\r\n        {/* Image Picker Dialog */}\r\n        <ImagePickerDialog\r\n          open={isImagePickerOpen}\r\n          onClose={() => setIsImagePickerOpen(false)}\r\n          onImageSelect={handleImageSelect}\r\n          title=\"Choose a cover image for your calendar\"\r\n        />\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default CalendarFormDialog;\r\n","import { supabase } from '../config/supabase';\r\nimport { logger } from '../utils/logger';\r\n\r\n/**\r\n * Service for managing tag definitions and metadata\r\n */\r\nexport const tagService = {\r\n  /**\r\n   * Fetches all tag definitions for a specific user\r\n   */\r\n  async fetchTagDefinitions(userId: string): Promise<Record<string, string>> {\r\n    if (!userId) return {};\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('tag_definitions')\r\n        .select('tag_name, definition')\r\n        .eq('user_id', userId);\r\n\r\n      if (error) {\r\n        logger.error('Error fetching tag definitions:', error);\r\n        return {};\r\n      }\r\n\r\n      const definitions: Record<string, string> = {};\r\n      data?.forEach((item) => {\r\n        definitions[item.tag_name] = item.definition;\r\n      });\r\n      return definitions;\r\n    } catch (err) {\r\n      logger.error('Error fetching tag definitions:', err);\r\n      return {};\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Fetches the definition for a specific tag\r\n   */\r\n  async fetchTagDefinition(userId: string, tagName: string): Promise<string> {\r\n    if (!userId || !tagName) return '';\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('tag_definitions')\r\n        .select('definition')\r\n        .eq('user_id', userId)\r\n        .eq('tag_name', tagName)\r\n        .single();\r\n\r\n      if (error && error.code !== 'PGRST116') {\r\n        // PGRST116 = no rows returned\r\n        logger.error('Error fetching tag definition:', error);\r\n      }\r\n\r\n      return data?.definition || '';\r\n    } catch (err) {\r\n      logger.error('Error fetching tag definition:', err);\r\n      return '';\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Saves or updates a tag definition\r\n   */\r\n  async saveTagDefinition(\r\n    userId: string,\r\n    tagName: string,\r\n    definition: string,\r\n    originalDefinition?: string\r\n  ): Promise<void> {\r\n    if (!userId || !tagName) return;\r\n\r\n    const trimmedDef = definition.trim();\r\n\r\n    // If originalDefinition is provided, skip if no change\r\n    if (originalDefinition !== undefined && trimmedDef === originalDefinition.trim()) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      if (trimmedDef) {\r\n        // Upsert definition\r\n        const { error } = await supabase\r\n          .from('tag_definitions')\r\n          .upsert({\r\n            user_id: userId,\r\n            tag_name: tagName,\r\n            definition: trimmedDef,\r\n            updated_at: new Date().toISOString()\r\n          }, { onConflict: 'user_id,tag_name' });\r\n\r\n        if (error) {\r\n          logger.error('Error saving tag definition:', error);\r\n          throw error;\r\n        }\r\n      } else if (originalDefinition) {\r\n        // Delete definition if cleared and it existed before\r\n        await this.deleteTagDefinition(userId, tagName);\r\n      }\r\n    } catch (err) {\r\n      logger.error('Error saving tag definition:', err);\r\n      throw err;\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Deletes a tag definition\r\n   */\r\n  async deleteTagDefinition(userId: string, tagName: string): Promise<void> {\r\n    if (!userId || !tagName) return;\r\n\r\n    try {\r\n      const { error } = await supabase\r\n        .from('tag_definitions')\r\n        .delete()\r\n        .eq('user_id', userId)\r\n        .eq('tag_name', tagName);\r\n\r\n      if (error) {\r\n        logger.error('Error deleting tag definition:', error);\r\n        throw error;\r\n      }\r\n    } catch (err) {\r\n      logger.error('Error deleting tag definition:', err);\r\n      throw err;\r\n    }\r\n  }\r\n};\r\n","/**\r\n * AI Chat Bottom Sheet Component\r\n * Modern bottom sheet interface for AI trading analysis\r\n * Uses the useAIChat hook for core AI chat functionality\r\n * Uses AIChatInterface for the reusable chat UI\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Box,\r\n  IconButton,\r\n  Button,\r\n  Typography,\r\n  Alert,\r\n  Tooltip,\r\n  Divider,\r\n  useTheme,\r\n  alpha,\r\n  Avatar,\r\n  List,\r\n  ListItem,\r\n  ListItemButton,\r\n  Chip,\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogContentText,\r\n  DialogActions,\r\n  TextField,\r\n  InputAdornment,\r\n  CircularProgress\r\n} from '@mui/material';\r\nimport {\r\n  SmartToy as AIIcon,\r\n  Close as CloseIcon,\r\n  AddComment as NewChatIcon,\r\n  History as HistoryIcon,\r\n  ArrowBack as ArrowBackIcon,\r\n  Delete as DeleteIcon,\r\n  Schedule as ScheduleIcon,\r\n  Settings as SettingsIcon,\r\n  Search as SearchIcon\r\n} from '@mui/icons-material';\r\nimport { format } from 'date-fns';\r\nimport Shimmer from '../Shimmer';\r\nimport AIChatInterface, { AIChatInterfaceRef } from './AIChatInterface';\r\nimport { AIConversation } from '../../types/aiChat';\r\nimport { Trade } from '../../types/trade';\r\nimport { Calendar } from '../../types/calendar';\r\nimport { EconomicEvent } from '../../types/economicCalendar';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { logger } from '../../utils/logger';\r\nimport { useAuthState } from '../../contexts/AuthStateContext';\r\nimport { useAIChat } from '../../hooks/useAIChat';\r\nimport EconomicEventDetailDialog from '../economicCalendar/EconomicEventDetailDialog';\r\nimport ApiKeySettingsDialog from './ApiKeySettingsDialog';\r\nimport NoteEditorDialog from '../notes/NoteEditorDialog';\r\nimport { Note } from '../../types/note';\r\nimport { TradeOperationsProps } from '../../types/tradeOperations';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\n\r\ninterface AIChatDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  trades?: Trade[];\r\n  calendar?: Calendar;\r\n  isReadOnly?: boolean;\r\n  tradeOperations: TradeOperationsProps;\r\n}\r\n\r\n// Bottom sheet heights\r\nconst BOTTOM_SHEET_HEIGHTS = {\r\n  default: 780\r\n} as const;\r\n\r\nconst AIChatDrawer: React.FC<AIChatDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  trades,\r\n  calendar,\r\n  isReadOnly = false,\r\n  tradeOperations\r\n}) => {\r\n  // Destructure trade operations directly\r\n  const {\r\n    onOpenGalleryMode,\r\n    onUpdateTradeProperty,\r\n    onEditTrade,\r\n    onDeleteTrade,\r\n    onDeleteMultipleTrades,\r\n    onZoomImage,\r\n    onUpdateCalendarProperty,\r\n    isTradeUpdating\r\n  } = tradeOperations;\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n  const chatInterfaceRef = useRef<AIChatInterfaceRef>(null);\r\n\r\n  // Use the AI Chat hook for core functionality\r\n  const {\r\n    messages,\r\n    isLoading,\r\n    isTyping,\r\n    toolExecutionStatus,\r\n    conversations,\r\n    loadingConversations,\r\n    loadingMoreConversations,\r\n    hasMoreConversations,\r\n    totalConversationsCount,\r\n    isAtMessageLimit,\r\n    sendMessage,\r\n    cancelRequest,\r\n    setInputForEdit,\r\n    loadConversations,\r\n    loadMoreConversations,\r\n    selectConversation,\r\n    deleteConversation,\r\n    startNewChat,\r\n    setMessages,\r\n    getWelcomeMessage\r\n  } = useAIChat({\r\n    userId: user?.uid,\r\n    calendar,\r\n    messageLimit: 50,\r\n    autoSaveConversation: true\r\n  });\r\n\r\n  // Local UI state for drawer-specific features\r\n  const [showHistoryView, setShowHistoryView] = useState(false);\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\r\n  const [conversationToDelete, setConversationToDelete] = useState<string | null>(null);\r\n  const [historySearchQuery, setHistorySearchQuery] = useState<string>('');\r\n\r\n  // Economic event detail dialog state\r\n  const [selectedEvent, setSelectedEvent] = useState<EconomicEvent | null>(null);\r\n  const [eventDetailDialogOpen, setEventDetailDialogOpen] = useState(false);\r\n\r\n  // Note editor dialog state\r\n  const [selectedNote, setSelectedNote] = useState<Note | null>(null);\r\n  const [noteEditorOpen, setNoteEditorOpen] = useState(false);\r\n\r\n  // API Key settings dialog state\r\n  const [apiKeySettingsOpen, setApiKeySettingsOpen] = useState(false);\r\n\r\n  // Prevent body scroll when drawer is open to fix mention dialog positioning\r\n  useEffect(() => {\r\n    if (open) {\r\n      const originalOverflow = document.body.style.overflow;\r\n      document.body.style.overflow = 'hidden';\r\n      return () => {\r\n        document.body.style.overflow = originalOverflow;\r\n      };\r\n    }\r\n  }, [open]);\r\n\r\n  // Filter conversations based on search query\r\n  const filteredConversations = React.useMemo(() => {\r\n    if (!historySearchQuery.trim()) {\r\n      return conversations;\r\n    }\r\n\r\n    const query = historySearchQuery.toLowerCase();\r\n    return conversations.filter(conversation => {\r\n      if (conversation.title?.toLowerCase().includes(query)) {\r\n        return true;\r\n      }\r\n      if ((conversation as any).preview?.toLowerCase().includes(query)) {\r\n        return true;\r\n      }\r\n      if (conversation.messages && Array.isArray(conversation.messages)) {\r\n        const foundInMessages = conversation.messages.some(message =>\r\n          message.content?.toLowerCase().includes(query)\r\n        );\r\n        if (foundInMessages) {\r\n          return true;\r\n        }\r\n      }\r\n      return false;\r\n    });\r\n  }, [conversations, historySearchQuery]);\r\n\r\n  // Focus input when drawer opens\r\n  useEffect(() => {\r\n    if (open && !isLoading) {\r\n      setTimeout(() => chatInterfaceRef.current?.focus(), 100);\r\n    }\r\n  }, [open, isLoading]);\r\n\r\n  // Load conversations when drawer opens (only if calendar is provided)\r\n  useEffect(() => {\r\n    if (open && calendar?.id && user) {\r\n      loadConversations();\r\n    }\r\n  }, [open, calendar?.id, user, loadConversations]);\r\n\r\n  // =====================================================\r\n  // UI EVENT HANDLERS (Drawer-specific)\r\n  // =====================================================\r\n\r\n  const handleNewChat = async () => {\r\n    await startNewChat();\r\n    setShowHistoryView(false);\r\n  };\r\n\r\n  const handleSelectConversation = (conversation: AIConversation) => {\r\n    selectConversation(conversation);\r\n    setShowHistoryView(false);\r\n  };\r\n\r\n  const handleDeleteClick = (conversationId: string, event: React.MouseEvent) => {\r\n    event.stopPropagation();\r\n    setConversationToDelete(conversationId);\r\n    setDeleteDialogOpen(true);\r\n  };\r\n\r\n  const handleConfirmDelete = async () => {\r\n    if (!conversationToDelete) return;\r\n\r\n    const success = await deleteConversation(conversationToDelete);\r\n    if (success) {\r\n      logger.log('Conversation deleted:', conversationToDelete);\r\n    }\r\n    setDeleteDialogOpen(false);\r\n    setConversationToDelete(null);\r\n  };\r\n\r\n  const handleCancelDelete = () => {\r\n    setDeleteDialogOpen(false);\r\n    setConversationToDelete(null);\r\n  };\r\n\r\n  const getPreviewText = (conversation: AIConversation): string => {\r\n    const firstUserMessage = conversation.messages.find(msg => msg.role === 'user');\r\n    if (firstUserMessage && firstUserMessage.content) {\r\n      return firstUserMessage.content.substring(0, 80) +\r\n        (firstUserMessage.content.length > 80 ? '...' : '');\r\n    }\r\n    return 'No messages';\r\n  };\r\n\r\n\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop - Click to close */}\r\n      <Box\r\n        onClick={onClose}\r\n        sx={{\r\n          position: 'fixed',\r\n          top: 0,\r\n          left: 0,\r\n          right: 0,\r\n          bottom: 0,\r\n          backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n          backdropFilter: 'blur(4px)',\r\n          zIndex: Z_INDEX.AI_DRAWER_BACKDROP,\r\n          opacity: open ? 1 : 0,\r\n          visibility: open ? 'visible' : 'hidden',\r\n          transition: 'opacity 0.3s ease-in-out, visibility 0.3s ease-in-out',\r\n          cursor: 'pointer'\r\n        }}\r\n      />\r\n\r\n      {/* Bottom Sheet Drawer */}\r\n      <Box\r\n        sx={{\r\n          position: 'fixed',\r\n          bottom: 0,\r\n          right: { xs: 0, sm: 20 },\r\n          left: { xs: 0, sm: 'auto' },\r\n          zIndex: Z_INDEX.AI_DRAWER,\r\n          height: open ? BOTTOM_SHEET_HEIGHTS.default : 0,\r\n          maxHeight: '85vh',\r\n          width: '100%',\r\n          maxWidth: { xs: '100%', sm: '420px', md: '460px', lg: '500px' },\r\n          borderTopLeftRadius: 20,\r\n          borderTopRightRadius: 20,\r\n          borderBottomLeftRadius: 0,\r\n          borderBottomRightRadius: 0,\r\n          background: theme.palette.mode === 'dark'\r\n            ? 'linear-gradient(135deg, rgba(18, 18, 18, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%)'\r\n            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%)',\r\n          backdropFilter: 'blur(20px)',\r\n          boxShadow: theme.palette.mode === 'dark'\r\n            ? '0 -8px 32px rgba(0, 0, 0, 0.6)'\r\n            : '0 -8px 32px rgba(0, 0, 0, 0.15)',\r\n          border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          borderBottom: 'none',\r\n          transition: 'height 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n          transform: open ? 'translateY(0)' : 'translateY(100%)',\r\n          overflow: 'hidden',\r\n          pointerEvents: open ? 'auto' : 'none' // Allow interaction only when open\r\n        }}\r\n      >\r\n        <Box sx={{\r\n          height: '100%',\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          overflow: 'hidden'\r\n        }}>\r\n          {/* Header */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            p: 2,\r\n            pb: 1,\r\n            borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n            background: alpha(theme.palette.background.paper, 0.8),\r\n            backdropFilter: 'blur(10px)'\r\n          }}\r\n          >\r\n            {/* Left side - Logo and Title */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>\r\n              <Avatar sx={{\r\n                width: 36,\r\n                height: 36,\r\n                background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.primary.dark} 100%)`,\r\n                border: `2px solid ${alpha(theme.palette.primary.main, 0.2)}`\r\n              }}>\r\n                <AIIcon sx={{ fontSize: 20, color: 'white' }} />\r\n              </Avatar>\r\n\r\n              <Box>\r\n                <Typography variant=\"h6\" sx={{\r\n                  fontWeight: 700,\r\n                  fontSize: '1.1rem',\r\n                  lineHeight: 1.2\r\n                }}>\r\n                  AI Trading Assistant\r\n                </Typography>\r\n                <Typography variant=\"caption\" sx={{\r\n                  color: 'text.secondary',\r\n                  fontSize: '0.75rem'\r\n                }}>\r\n                  {calendar\r\n                    ? (() => {\r\n                        // Calculate total trade count from year_stats\r\n                        const totalTrades = calendar.year_stats\r\n                          ? Object.values(calendar.year_stats).reduce((sum, yearStats) => sum + (yearStats.total_trades || 0), 0)\r\n                          : 0;\r\n                        return totalTrades > 0\r\n                          ? `${totalTrades} trade${totalTrades !== 1 ? 's' : ''} in ${calendar.name}`\r\n                          : `${calendar.name} - Ready for analysis`;\r\n                      })()\r\n                    : 'Ready for trading analysis across all calendars'\r\n                  }\r\n                </Typography>\r\n              </Box>\r\n            </Box>\r\n\r\n            {/* Right side - Action buttons */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n              {/* Conversation features only available when calendar is provided */}\r\n              {calendar && (\r\n                <>\r\n                  <Tooltip title=\"New Chat\">\r\n                    <IconButton\r\n                      size=\"small\"\r\n                      onClick={handleNewChat}\r\n                      disabled={messages.length === 0}\r\n                      sx={{\r\n                        color: 'primary.main',\r\n                        '&:hover': { backgroundColor: alpha(theme.palette.primary.main, 0.1) },\r\n                        '&:disabled': { color: 'text.disabled' }\r\n                      }}\r\n                    >\r\n                      <NewChatIcon fontSize=\"small\" />\r\n                    </IconButton>\r\n                  </Tooltip>\r\n\r\n                  <Tooltip title={showHistoryView ? \"Back to Chat\" : \"Conversation History\"}>\r\n                    <IconButton\r\n                      size=\"small\"\r\n                      onClick={() => setShowHistoryView(!showHistoryView)}\r\n                      sx={{\r\n                        color: showHistoryView ? 'primary.main' : 'text.secondary',\r\n                        '&:hover': { backgroundColor: alpha(theme.palette.action.hover, 0.5) }\r\n                      }}\r\n                    >\r\n                      {showHistoryView ? <ArrowBackIcon fontSize=\"small\" /> : <HistoryIcon fontSize=\"small\" />}\r\n                    </IconButton>\r\n                  </Tooltip>\r\n                </>\r\n              )}\r\n\r\n              <Tooltip title=\"API Key Settings\">\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={() => setApiKeySettingsOpen(true)}\r\n                  sx={{\r\n                    color: 'text.secondary',\r\n                    '&:hover': { backgroundColor: alpha(theme.palette.action.hover, 0.5) }\r\n                  }}\r\n                >\r\n                  <SettingsIcon fontSize=\"small\" />\r\n                </IconButton>\r\n              </Tooltip>\r\n\r\n              <Tooltip title=\"Close\">\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={onClose}\r\n                  sx={{\r\n                    color: 'text.secondary',\r\n                    '&:hover': { backgroundColor: alpha(theme.palette.action.hover, 0.5) }\r\n                  }}\r\n                >\r\n                  <CloseIcon fontSize=\"small\" />\r\n                </IconButton>\r\n              </Tooltip>\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Content - Sliding Pager */}\r\n          <Box sx={{\r\n            height: '720px',\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            overflow: 'hidden',\r\n            position: 'relative'\r\n          }}>\r\n            {/* Pager Container */}\r\n            <Box sx={{\r\n              display: 'flex',\r\n              width: '200%',\r\n              height: '100%',\r\n              transform: showHistoryView ? 'translateX(-50%)' : 'translateX(0)',\r\n              transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)'\r\n            }}>\r\n              {/* Chat View */}\r\n              <Box sx={{\r\n                width: '50%',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                overflow: 'hidden'\r\n              }}>\r\n                <AIChatInterface\r\n                  ref={chatInterfaceRef}\r\n                  messages={messages}\r\n                  isLoading={isLoading}\r\n                  isTyping={isTyping}\r\n                  toolExecutionStatus={toolExecutionStatus}\r\n                  isAtMessageLimit={isAtMessageLimit}\r\n                  sendMessage={sendMessage}\r\n                  cancelRequest={cancelRequest}\r\n                  setInputForEdit={setInputForEdit}\r\n                  startNewChat={startNewChat}\r\n                  setMessages={setMessages}\r\n                  getWelcomeMessage={getWelcomeMessage}\r\n                  userId={user?.uid}\r\n                  calendar={calendar}\r\n                  trades={trades}\r\n                  onTradeClick={(tradeId, contextTrades) => {\r\n                    if (onOpenGalleryMode) {\r\n                      const clickedTrade = contextTrades.find(t => t.id === tradeId);\r\n                      if (clickedTrade) {\r\n                        onOpenGalleryMode(contextTrades, tradeId, 'AI Chat - Trade Gallery');\r\n                      }\r\n                    } else {\r\n                      logger.log('Trade clicked but gallery mode not available:', tradeId);\r\n                    }\r\n                  }}\r\n                  onEventClick={(event) => {\r\n                    logger.log('Economic event clicked:', event);\r\n                    setSelectedEvent(event);\r\n                    setEventDetailDialogOpen(true);\r\n                  }}\r\n                  onNoteClick={(noteId, note) => {\r\n                    logger.log('Note clicked:', noteId);\r\n                    if (note) {\r\n                      setSelectedNote(note);\r\n                      setNoteEditorOpen(true);\r\n                    } else {\r\n                      logger.warn('Note not found in embedded notes:', noteId);\r\n                    }\r\n                  }}\r\n                  isReadOnly={isReadOnly}\r\n                  messageLimit={50}\r\n                />\r\n              </Box>\r\n              {/* End Chat View */}\r\n\r\n              {/* History View */}\r\n              <Box sx={{\r\n                width: '50%',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                overflow: 'hidden'\r\n              }}>\r\n                {/* Search Bar */}\r\n                <Box sx={{ p: 2, pb: 1 }}>\r\n                  <TextField\r\n                    fullWidth\r\n                    size=\"small\"\r\n                    placeholder=\"Search conversations...\"\r\n                    value={historySearchQuery}\r\n                    onChange={(e) => setHistorySearchQuery(e.target.value)}\r\n                    InputProps={{\r\n                      startAdornment: (\r\n                        <InputAdornment position=\"start\">\r\n                          <SearchIcon fontSize=\"small\" sx={{ color: 'text.secondary' }} />\r\n                        </InputAdornment>\r\n                      ),\r\n                    }}\r\n                    sx={{\r\n                      '& .MuiOutlinedInput-root': {\r\n                        borderRadius: 2,\r\n                        backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n                        '&:hover': {\r\n                          backgroundColor: theme.palette.background.paper,\r\n                        },\r\n                        '&.Mui-focused': {\r\n                          backgroundColor: theme.palette.background.paper,\r\n                        }\r\n                      }\r\n                    }}\r\n                  />\r\n                </Box>\r\n\r\n                {/* History Content */}\r\n                <Box sx={{\r\n                  flex: 1,\r\n                  overflow: 'auto',\r\n                  ...scrollbarStyles(theme)\r\n                }}>\r\n                  {loadingConversations ? (\r\n                    <List sx={{ p: 0 }}>\r\n                      {Array.from({ length: 10 }).map((_, index) => (\r\n                        <React.Fragment key={index}>\r\n                          <ListItem sx={{ py: 2, px: 2 }}>\r\n                            <Box sx={{ width: '100%' }}>\r\n                              {/* Title and chip */}\r\n                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\r\n                                <Shimmer\r\n                                  height={20}\r\n                                  width=\"60%\"\r\n                                  borderRadius={4}\r\n                                  variant=\"wave\"\r\n                                  intensity=\"medium\"\r\n                                />\r\n                                <Shimmer\r\n                                  height={20}\r\n                                  width={60}\r\n                                  borderRadius={10}\r\n                                  variant=\"pulse\"\r\n                                  intensity=\"low\"\r\n                                />\r\n                              </Box>\r\n\r\n                              {/* Preview text */}\r\n                              <Shimmer\r\n                                height={16}\r\n                                width=\"90%\"\r\n                                borderRadius={4}\r\n                                variant=\"default\"\r\n                                intensity=\"low\"\r\n                                sx={{ mb: 0.5 }}\r\n                              />\r\n\r\n\r\n                              {/* Date */}\r\n                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                                <Shimmer\r\n                                  height={14}\r\n                                  width={120}\r\n                                  borderRadius={4}\r\n                                  variant=\"default\"\r\n                                  intensity=\"low\"\r\n                                />\r\n                              </Box>\r\n                            </Box>\r\n                          </ListItem>\r\n                          {index < 4 && <Divider />}\r\n                        </React.Fragment>\r\n                      ))}\r\n                    </List>\r\n                  ) : filteredConversations.length === 0 ? (\r\n                    <Box sx={{ p: 3 }}>\r\n                      <Alert severity=\"info\">\r\n                        {historySearchQuery.trim() ? `No conversations found matching \"${historySearchQuery}\"` : 'No conversation history yet. Start chatting with the AI to create your first conversation!'}\r\n                      </Alert>\r\n                    </Box>\r\n                  ) : (\r\n                    <List sx={{ p: 0 }}>\r\n                      {filteredConversations.map((conversation, index) => (\r\n                        <React.Fragment key={conversation.id}>\r\n                          <ListItem disablePadding>\r\n                            <ListItemButton\r\n                              onClick={() => handleSelectConversation(conversation)}\r\n                              sx={{\r\n                                py: 2,\r\n                                px: 2,\r\n                                display: 'flex',\r\n                                alignItems: 'flex-start',\r\n                                gap: 1,\r\n                                '&:hover': {\r\n                                  backgroundColor: alpha(theme.palette.primary.main, 0.08)\r\n                                }\r\n                              }}\r\n                            >\r\n                              <Box sx={{ flex: 1, minWidth: 0 }}>\r\n                                {/* Title and chip */}\r\n                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>\r\n                                  <Typography\r\n                                    variant=\"subtitle1\"\r\n                                    sx={{\r\n                                      fontWeight: 600,\r\n                                      fontSize: '0.95rem',\r\n                                      flex: 1,\r\n                                      overflow: 'hidden',\r\n                                      textOverflow: 'ellipsis',\r\n                                      whiteSpace: 'nowrap'\r\n                                    }}\r\n                                  >\r\n                                    {conversation.title}\r\n                                  </Typography>\r\n                                  <Chip\r\n                                    label={`${conversation.message_count} msgs`}\r\n                                    size=\"small\"\r\n                                    sx={{\r\n                                      height: 20,\r\n                                      fontSize: '0.7rem',\r\n                                      backgroundColor: alpha(theme.palette.primary.main, 0.1),\r\n                                      color: 'primary.main'\r\n                                    }}\r\n                                  />\r\n                                </Box>\r\n\r\n                                {/* Preview text */}\r\n                                <Typography\r\n                                  variant=\"body2\"\r\n                                  color=\"text.secondary\"\r\n                                  sx={{\r\n                                    fontSize: '0.85rem',\r\n                                    overflow: 'hidden',\r\n                                    textOverflow: 'ellipsis',\r\n                                    display: '-webkit-box',\r\n                                    WebkitLineClamp: 2,\r\n                                    WebkitBoxOrient: 'vertical',\r\n                                    mb: 0.5\r\n                                  }}\r\n                                >\r\n                                  {getPreviewText(conversation)}\r\n                                </Typography>\r\n\r\n                                {/* Date */}\r\n                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                                  <ScheduleIcon sx={{ fontSize: 14, color: 'text.disabled' }} />\r\n                                  <Typography variant=\"caption\" color=\"text.disabled\">\r\n                                    {format(conversation.updated_at, 'MMM d, yyyy  h:mm a')}\r\n                                  </Typography>\r\n                                </Box>\r\n                              </Box>\r\n\r\n                              {/* Delete button */}\r\n                              <IconButton\r\n                                onClick={(e) => handleDeleteClick(conversation.id, e)}\r\n                                size=\"small\"\r\n                                sx={{\r\n                                  color: 'error.main',\r\n                                  flexShrink: 0,\r\n                                  mt: 0.5,\r\n                                  '&:hover': {\r\n                                    backgroundColor: alpha(theme.palette.error.main, 0.1)\r\n                                  }\r\n                                }}\r\n                              >\r\n                                <DeleteIcon fontSize=\"small\" />\r\n                              </IconButton>\r\n                            </ListItemButton>\r\n                          </ListItem>\r\n                          {index < conversations.length - 1 && <Divider />}\r\n                        </React.Fragment>\r\n                      ))}\r\n                    </List>\r\n                  )}\r\n                </Box>\r\n\r\n                {/* Load More Button */}\r\n                {!loadingConversations && hasMoreConversations && (\r\n                  <Box sx={{\r\n                    p: 2,\r\n                    display: 'flex',\r\n                    justifyContent: 'center',\r\n                    borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n                  }}>\r\n                    <Button\r\n                      variant=\"outlined\"\r\n                      size=\"small\"\r\n                      onClick={loadMoreConversations}\r\n                      disabled={loadingMoreConversations}\r\n                      startIcon={loadingMoreConversations ? (\r\n                        <CircularProgress size={16} color=\"inherit\" />\r\n                      ) : null}\r\n                      sx={{\r\n                        borderRadius: 2,\r\n                        textTransform: 'none',\r\n                        px: 3\r\n                      }}\r\n                    >\r\n                      {loadingMoreConversations ? 'Loading...' : 'Load More'}\r\n                    </Button>\r\n                  </Box>\r\n                )}\r\n\r\n                {/* Footer Info */}\r\n                {!loadingConversations && conversations.length > 0 && (\r\n                  <Box sx={{\r\n                    p: 2,\r\n                    pt: hasMoreConversations ? 0 : 2,\r\n                    borderTop: hasMoreConversations ? 'none' : `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n                    backgroundColor: alpha(theme.palette.background.default, 0.5)\r\n                  }}>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\" sx={{ fontSize: '0.75rem' }}>\r\n                      Showing {conversations.length} of {totalConversationsCount} conversation{totalConversationsCount !== 1 ? 's' : ''}\r\n                    </Typography>\r\n                  </Box>\r\n                )}\r\n              </Box>\r\n              {/* End History View */}\r\n            </Box>\r\n            {/* End Pager Container */}\r\n          </Box>\r\n          {/* End Content */}\r\n\r\n        </Box>\r\n      </Box>\r\n\r\n      {/* Economic Event Detail Dialog */}\r\n      {selectedEvent && calendar && (\r\n        <EconomicEventDetailDialog\r\n          open={eventDetailDialogOpen}\r\n          onClose={() => {\r\n            setEventDetailDialogOpen(false);\r\n            setSelectedEvent(null);\r\n          }}\r\n          event={selectedEvent}\r\n          calendarId={calendar.id}\r\n          tradeOperations={tradeOperations}\r\n          isReadOnly={isReadOnly}\r\n        />\r\n      )}\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <Dialog\r\n        open={deleteDialogOpen}\r\n        onClose={handleCancelDelete}\r\n        maxWidth=\"xs\"\r\n        fullWidth\r\n        sx={{\r\n          zIndex: Z_INDEX.DIALOG\r\n        }}\r\n      >\r\n        <DialogTitle>Delete Conversation?</DialogTitle>\r\n        <DialogContent>\r\n          <DialogContentText>\r\n            Are you sure you want to delete this conversation? This action cannot be undone.\r\n          </DialogContentText>\r\n        </DialogContent>\r\n        <DialogActions sx={{ p: 2, pt: 1 }}>\r\n          <Button onClick={handleCancelDelete} color=\"inherit\">\r\n            Cancel\r\n          </Button>\r\n          <Button\r\n            onClick={handleConfirmDelete}\r\n            color=\"error\"\r\n            variant=\"contained\"\r\n            autoFocus\r\n          >\r\n            Delete\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n\r\n      {/* API Key Settings Dialog */}\r\n      <ApiKeySettingsDialog\r\n        open={apiKeySettingsOpen}\r\n        onClose={() => setApiKeySettingsOpen(false)}\r\n      />\r\n\r\n      {/* Note Editor Dialog */}\r\n      {noteEditorOpen && selectedNote && calendar && (\r\n        <NoteEditorDialog\r\n          open={noteEditorOpen}\r\n          onClose={() => {\r\n            setNoteEditorOpen(false);\r\n            setSelectedNote(null);\r\n          }}\r\n          note={selectedNote}\r\n          calendarId={calendar.id}\r\n          onSave={(updatedNote) => {\r\n            // Update the note in embedded notes across all messages\r\n            setMessages(prevMessages =>\r\n              prevMessages.map(msg => {\r\n                if (msg.embeddedNotes && msg.embeddedNotes[updatedNote.id]) {\r\n                  return {\r\n                    ...msg,\r\n                    embeddedNotes: {\r\n                      ...msg.embeddedNotes,\r\n                      [updatedNote.id]: updatedNote\r\n                    }\r\n                  };\r\n                }\r\n                return msg;\r\n              })\r\n            );\r\n          }}\r\n          onDelete={(noteId) => {\r\n            // Remove the note from embedded notes across all messages\r\n            setMessages(prevMessages =>\r\n              prevMessages.map(msg => {\r\n                if (msg.embeddedNotes && msg.embeddedNotes[noteId]) {\r\n                  const { [noteId]: _, ...remainingNotes } = msg.embeddedNotes;\r\n                  return {\r\n                    ...msg,\r\n                    embeddedNotes: remainingNotes\r\n                  };\r\n                }\r\n                return msg;\r\n              })\r\n            );\r\n            setNoteEditorOpen(false);\r\n            setSelectedNote(null);\r\n          }}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default AIChatDrawer;\r\n","import React, { useState, useMemo, useCallback, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Button,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport { ViewCarousel as GalleryIcon, Event as EventIcon } from '@mui/icons-material';\r\nimport { format, isAfter, startOfDay } from 'date-fns';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { BaseDialog } from '../common';\r\nimport { DayHeader, TradeList, ProgressSection } from './';\r\nimport { startOfNextDay } from './TradeFormDialog';\r\nimport { calculateCumulativePnLToDateAsync } from '../../utils/dynamicRiskUtils';\r\nimport { TradeOperationsProps } from '../../types/tradeOperations';\r\nimport { TradeRepository } from '../../services/repository/repositories/TradeRepository';\r\nimport { logger } from '../../utils/logger';\r\nimport EconomicCalendarDrawer from '../economicCalendar/EconomicCalendarDrawer';\r\n\r\ninterface DayDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  date: Date;\r\n  trades: Trade[];\r\n  account_balance: number;\r\n  onDateChange: (date: Date) => void;\r\n  // Form handler - DayDialog-specific, not part of tradeOperations\r\n  showAddForm: (editTrade?: Trade | null) => void;\r\n  // Unified trade operations from parent\r\n  tradeOperations: TradeOperationsProps;\r\n  // AI chat mode opener - needs trades context from DayDialog\r\n  onOpenAIChatMode?: (trades: Trade[], tradeId: string, title?: string) => void;\r\n  // Optional pre-fetched trades for the week (avoids redundant DB query in ProgressSection)\r\n  weekTrades?: Trade[];\r\n}\r\n\r\n\r\n\r\n  \r\n\r\nconst DayDialog: React.FC<DayDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  date,\r\n  trades,\r\n  account_balance,\r\n  showAddForm,\r\n  onDateChange,\r\n  tradeOperations,\r\n  onOpenAIChatMode,\r\n  weekTrades\r\n}) => {\r\n  // Destructure from tradeOperations\r\n  const {\r\n    calendarId,\r\n    calendar,\r\n    onOpenGalleryMode,\r\n    isReadOnly = false\r\n  } = tradeOperations;\r\n\r\n  // State\r\n  const [expandedTradeId, setExpandedTradeId] = useState<string | null>(null);\r\n  const [dayTotalPnL, setDayTotalPnL] = useState<number>(0);\r\n  const [cumulativePnL, setCumulativePnL] = useState<number>(0);\r\n  const [eventsDrawerOpen, setEventsDrawerOpen] = useState(false);\r\n\r\n  // Use stable primitives for useEffect dependencies to prevent infinite re-renders\r\n  const dateTime = date.getTime();\r\n  const calendarIdForEffect = calendar?.id;\r\n\r\n  // Fetch cumulative P&L when dialog opens or date changes\r\n  useEffect(() => {\r\n    const fetchCumulativePnL = async () => {\r\n      if (!open || !calendar) return;\r\n\r\n      try {\r\n        const targetDate = startOfNextDay(date);\r\n        const pnl = await calculateCumulativePnLToDateAsync(targetDate, calendar);\r\n        setCumulativePnL(pnl);\r\n      } catch (error) {\r\n        logger.error('Error fetching cumulative P&L:', error);\r\n        setCumulativePnL(0);\r\n      }\r\n    };\r\n\r\n    fetchCumulativePnL();\r\n  }, [open, dateTime, calendarIdForEffect]);\r\n\r\n  // Fetch day's total P&L when dialog opens or date changes\r\n  useEffect(() => {\r\n    const fetchDayTotalPnL = async () => {\r\n      if (!open || !calendarId) return;\r\n\r\n      try {\r\n        const tradeRepo = new TradeRepository();\r\n        const dayTrades = await tradeRepo.getTradesByDay(calendarId, date, ['amount']);\r\n        const total = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n        setDayTotalPnL(total);\r\n      } catch (error) {\r\n        logger.error('Error fetching day total P&L:', error);\r\n        setDayTotalPnL(0);\r\n      }\r\n    };\r\n\r\n    fetchDayTotalPnL();\r\n  }, [open, dateTime, calendarId]);\r\n  \r\n \r\n\r\n  // Handlers - wrapped in useCallback to prevent child re-renders\r\n  const handlePrevDay = useCallback(() => {\r\n    const prevDay = new Date(date);\r\n    prevDay.setDate(prevDay.getDate() - 1);\r\n    onDateChange(prevDay);\r\n  }, [date, onDateChange]);\r\n\r\n  const handleNextDay = useCallback(() => {\r\n    const nextDay = startOfNextDay(date);\r\n    // Don't allow navigating to future dates\r\n    if (!isAfter(nextDay, startOfDay(new Date()))) {\r\n      onDateChange(nextDay);\r\n    }\r\n  }, [date, onDateChange]);\r\n\r\n  const handleTradeClick = useCallback((tradeId: string) => {\r\n    setExpandedTradeId(prev => prev === tradeId ? null : tradeId);\r\n  }, []);\r\n\r\n  const handleAddClick = useCallback(async () => {\r\n    showAddForm(null);\r\n  }, [showAddForm]);\r\n\r\n\r\n\r\n  const handleEditClick = useCallback((trade: Trade) => {\r\n    showAddForm(trade);\r\n  }, [showAddForm]);\r\n\r\n  const handleGalleryModeClick = useCallback(() => {\r\n    if (onOpenGalleryMode && trades && trades.length > 0) {\r\n      const title = `${format(date, 'EEEE, MMMM d, yyyy')} - ${trades.length} Trade${trades.length > 1 ? 's' : ''}`;\r\n      onOpenGalleryMode(trades, expandedTradeId || trades[0].id, title);\r\n      onClose(); // Close the day dialog when opening gallery mode\r\n    }\r\n  }, [onOpenGalleryMode, trades, date, expandedTradeId, onClose]);\r\n\r\n  const handleOpenAIChat = useCallback((trade: Trade) => {\r\n    if (onOpenAIChatMode) {\r\n      const title = `AI Analysis - ${trade.name || format(date, 'MMM d, yyyy')}`;\r\n      setExpandedTradeId(null); // Collapse trade so TradeGalleryDialog fully overlaps\r\n      onOpenAIChatMode(trades, trade.id, title);\r\n      // Don't close DayDialog - only close when opening gallery mode\r\n    }\r\n  }, [onOpenAIChatMode, trades, date]);\r\n\r\n  const handleOpenEventsDrawer = useCallback(() => {\r\n    setEventsDrawerOpen(true);\r\n  }, []);\r\n\r\n  const tradesLength = trades?.length || 0;\r\n\r\n  // Merge parent's tradeOperations with DayDialog-specific overrides\r\n  const mergedTradeOperations: TradeOperationsProps = useMemo(() => ({\r\n    ...tradeOperations,\r\n    // Override onEditTrade to use DayDialog's form handler\r\n    onEditTrade: isReadOnly ? undefined : handleEditClick,\r\n    // Override onOpenAIChat to include trades context from DayDialog\r\n    onOpenAIChat: onOpenAIChatMode ? handleOpenAIChat : undefined\r\n  }), [tradeOperations, isReadOnly, handleEditClick, onOpenAIChatMode, handleOpenAIChat]);\r\n\r\n  return (\r\n    <>\r\n      <BaseDialog\r\n        open={open}\r\n        onClose={() => {\r\n          // Only allow closing if we're not in the process of creating an empty trade\r\n          onClose();\r\n        }}\r\n        title=\"Daily Trades\"\r\n        maxWidth=\"md\"\r\n        fullWidth\r\n        hideCloseButton={false}\r\n        primaryButtonText={isReadOnly ? undefined : 'Add Trade'}\r\n        primaryButtonAction={isReadOnly ? undefined : () => handleAddClick()}\r\n        hideFooterCancelButton={false}\r\n        actions={\r\n          <>\r\n            {calendar && (\r\n              <Tooltip title=\"View economic events for this day\">\r\n                <Button\r\n                  variant=\"outlined\"\r\n                  startIcon={<EventIcon />}\r\n                  onClick={handleOpenEventsDrawer}\r\n                  sx={{ mr: 1 }}\r\n                >\r\n                  Events\r\n                </Button>\r\n              </Tooltip>\r\n            )}\r\n            {onOpenGalleryMode && tradesLength > 0 && (\r\n              <Tooltip title=\"View trades in gallery mode\">\r\n                <Button\r\n                  variant=\"outlined\"\r\n                  startIcon={<GalleryIcon />}\r\n                  onClick={handleGalleryModeClick}\r\n                  sx={{ mr: 1 }}\r\n                >\r\n                  Gallery View\r\n                </Button>\r\n              </Tooltip>\r\n            )}\r\n          </>\r\n        }\r\n      >\r\n        <Box sx={{ p: 3 }}>\r\n\r\n          <DayHeader\r\n            title={format(date, 'EEEE, MMMM d, yyyy')}\r\n            account_balance={account_balance + cumulativePnL}\r\n            formInputVisible={false}\r\n            total_pnl={dayTotalPnL}\r\n            onPrevDay={handlePrevDay}\r\n            onNextDay={handleNextDay}\r\n          />\r\n\r\n          {calendarId && calendar && (\r\n            <ProgressSection\r\n              calendarId={calendarId}\r\n              currentBalance={account_balance + cumulativePnL}\r\n              currentDate={date}\r\n              calendar={calendar}\r\n              weekTrades={weekTrades}\r\n            />\r\n          )}\r\n\r\n          <TradeList\r\n            trades={trades}\r\n            expandedTradeId={expandedTradeId}\r\n            onTradeClick={handleTradeClick}\r\n            tradeOperations={mergedTradeOperations}\r\n            hideActions={isReadOnly} // Hide edit/delete actions in read-only mode\r\n            enableBulkSelection={isReadOnly ? false : tradesLength > 1} // Disable bulk selection in read-only mode\r\n          />\r\n        </Box>\r\n      </BaseDialog>\r\n\r\n      {calendar && (\r\n        <EconomicCalendarDrawer\r\n          open={eventsDrawerOpen}\r\n          onClose={() => setEventsDrawerOpen(false)}\r\n          calendar={calendar}\r\n          tradeOperations={tradeOperations}\r\n          isReadOnly={isReadOnly}\r\n          initialDate={date}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default DayDialog;\r\n\r\n\r\n","import React from 'react';\r\nimport { Box, Typography, useTheme, Tooltip } from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport { CheckCircle, Flag } from '@mui/icons-material';\r\n\r\ninterface TargetBadgeProps {\r\n  progress: number;\r\n  isMet: boolean;\r\n  tooltipText?: string;\r\n}\r\n\r\nconst TargetBadge: React.FC<TargetBadgeProps> = ({\r\n  progress,\r\n  isMet,\r\n  tooltipText = 'Shows progress towards your target goal'\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  const badgeContent = (\r\n    <Box sx={{\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      bgcolor: isMet ? alpha(theme.palette.success.main, 0.9) : alpha(theme.palette.primary.main, 0.1),\r\n      color: isMet ? 'white' : 'primary.main',\r\n      borderRadius: '12px',\r\n      width: 'auto',\r\n      height: 22,\r\n      px: 0.8,\r\n      border: `1px solid ${alpha(theme.palette.primary.main, 0.2)}`\r\n    }}>\r\n      {isMet ? (\r\n        <CheckCircle sx={{ fontSize: '0.875rem', mr: 0.3 }} />\r\n      ) : (\r\n        <Flag sx={{ fontSize: '0.875rem', mr: 0.3 }} />\r\n      )}\r\n      <Typography variant=\"caption\" sx={{ fontWeight: 600, fontSize: isMet ? '0.5rem' : '0.7rem' }}>\r\n        {Math.min(Math.max(progress, 0), 100).toFixed(0)}%\r\n      </Typography>\r\n    </Box>\r\n  );\r\n\r\n  return (\r\n    <Tooltip title={tooltipText} arrow placement=\"top\">\r\n      {badgeContent}\r\n    </Tooltip>\r\n  );\r\n};\r\n\r\nexport default TargetBadge;\r\n","import React from 'react';\r\nimport {\r\n  Button,\r\n  Typography,\r\n  IconButton,\r\n  Box,\r\n  Paper,\r\n  useTheme,\r\n  useMediaQuery\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  TrendingUp,\r\n  EmojiEvents,\r\n  CalendarMonth,\r\n  CalendarToday,\r\n  ViewCarousel as GalleryIcon\r\n} from '@mui/icons-material';\r\nimport { addYears, subYears } from 'date-fns';\r\nimport { Trade, YearStats } from '../types/dualWrite';\r\nimport TargetBadge from '../components/TargetBadge';\r\nimport { BaseDialog } from './common';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\n\r\ninterface SelectDateDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onDateSelect: (date: Date) => void;\r\n  initialDate?: Date;\r\n  accountBalance: number;\r\n  monthlyTarget?: number;\r\n  yearlyTarget?: number;\r\n  yearStats: Record<string, YearStats>; // Pre-calculated year statistics\r\n  onOpenGalleryMode?: (trades: Trade[], initialTradeId?: string, title?: string, fetchYear?: number) => void;\r\n}\r\n\r\nconst SelectDateDialog: React.FC<SelectDateDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  onDateSelect,\r\n  initialDate,\r\n  accountBalance,\r\n  monthlyTarget,\r\n  yearlyTarget,\r\n  yearStats,\r\n  onOpenGalleryMode\r\n}) => {\r\n  const theme = useTheme();\r\n  const isSmDown = useMediaQuery(theme.breakpoints.down('sm'));\r\n  const [currentDate, setCurrentDate] = React.useState(initialDate || new Date());\r\n  const currentYear = currentDate.getFullYear();\r\n  const months = [\r\n    'January', 'February', 'March', 'April', 'May', 'June',\r\n    'July', 'August', 'September', 'October', 'November', 'December'\r\n  ];\r\n\r\n  React.useEffect(() => {\r\n    if (initialDate) {\r\n      setCurrentDate(initialDate);\r\n    }\r\n  }, [initialDate]);\r\n\r\n  const handlePrevYear = () => setCurrentDate(prev => subYears(prev, 1));\r\n  const handleNextYear = () => setCurrentDate(prev => addYears(prev, 1));\r\n  const handleToday = () => setCurrentDate(new Date());\r\n\r\n  const handleMonthSelect = (monthIndex: number) => {\r\n    const newDate = new Date(currentYear, monthIndex, 1);\r\n    onDateSelect(newDate);\r\n    onClose();\r\n  };\r\n\r\n  const handleYearlyGalleryMode = () => {\r\n    if (onOpenGalleryMode) {\r\n      const yearData = yearStats[currentYear.toString()];\r\n      const totalTrades = yearData?.total_trades || 0;\r\n      const title = `${currentYear} - All Trades (${totalTrades} trades)`;\r\n      // Use fetch mode with empty trades array and fetchYear\r\n      // TradeGalleryDialog derives totalCount from calendar.year_stats\r\n      onOpenGalleryMode([], undefined, title, currentYear);\r\n      onClose();\r\n    }\r\n  };\r\n\r\n  const currentMonth = currentDate.getMonth();\r\n\r\n  // Get yearly statistics from pre-calculated year_stats\r\n  // Falls back to empty stats if year data not available\r\n  const yearlyStats = React.useMemo(() => {\r\n    const stats = yearStats[currentYear.toString()];\r\n    const startOfYear = new Date(currentYear, 0, 1);\r\n\r\n    if (!stats) {\r\n      // Fallback for years with no trades or not yet calculated\r\n      return {\r\n        totalTrades: 0,\r\n        yearlyPnL: 0,\r\n        yearlyWinCount: 0,\r\n        yearlyLossCount: 0,\r\n        yearlyWinRate: '0',\r\n        yearlyGrowthPercentage: '0',\r\n        accountValueAtStartOfYear: accountBalance,\r\n        startOfYear\r\n      };\r\n    }\r\n\r\n    // Calculate account value at start of year from previous years' PnL\r\n    let accountValueAtStartOfYear = accountBalance;\r\n    Object.entries(yearStats).forEach(([year, yearData]) => {\r\n      if (parseInt(year) < currentYear) {\r\n        accountValueAtStartOfYear += yearData.yearly_pnl;\r\n      }\r\n    });\r\n\r\n    return {\r\n      totalTrades: stats.total_trades,\r\n      yearlyPnL: stats.yearly_pnl,\r\n      yearlyWinCount: stats.win_count,\r\n      yearlyLossCount: stats.loss_count,\r\n      yearlyWinRate: stats.win_rate.toFixed(1),\r\n      yearlyGrowthPercentage: stats.yearly_growth_percentage.toFixed(2),\r\n      accountValueAtStartOfYear,\r\n      startOfYear\r\n    };\r\n  }, [currentYear, yearStats, accountBalance]);\r\n\r\n  const {\r\n    totalTrades,\r\n    yearlyPnL,\r\n    yearlyWinCount,\r\n    yearlyLossCount,\r\n    yearlyWinRate,\r\n    yearlyGrowthPercentage,\r\n    accountValueAtStartOfYear,\r\n    startOfYear\r\n  } = yearlyStats;\r\n\r\n  // Get monthly statistics from pre-calculated year_stats\r\n  const monthlyStats = React.useMemo(() => {\r\n    const stats = new Map<number, {\r\n      monthPnL: number;\r\n      tradeCount: number;\r\n      accountValueAtStartOfMonth: number;\r\n      targetProgress: {\r\n        progress: number;\r\n        isMet: boolean;\r\n        rawProgress: number;\r\n      } | null;\r\n      growthPercentage: string;\r\n    }>();\r\n\r\n    const yearData = yearStats[currentYear.toString()];\r\n\r\n    if (!yearData) {\r\n      // Fallback: create empty stats for all 12 months\r\n      for (let monthIndex = 0; monthIndex < 12; monthIndex++) {\r\n        stats.set(monthIndex, {\r\n          monthPnL: 0,\r\n          tradeCount: 0,\r\n          accountValueAtStartOfMonth: accountBalance,\r\n          targetProgress: null,\r\n          growthPercentage: '0'\r\n        });\r\n      }\r\n      return stats;\r\n    }\r\n\r\n    // Use pre-calculated monthly stats from year_stats\r\n    for (let monthIndex = 0; monthIndex < 12; monthIndex++) {\r\n      const monthStats = yearData.monthly_stats[monthIndex];\r\n\r\n      // Calculate target progress if monthly target is set using pre-calculated values\r\n      let targetProgress = null;\r\n      if (monthlyTarget && monthlyTarget > 0 && monthStats.account_value_at_start > 0) {\r\n        const targetAmount = (monthlyTarget / 100) * monthStats.account_value_at_start;\r\n        const rawProgress = targetAmount > 0 ? (monthStats.month_pnl / targetAmount) * 100 : 0;\r\n        targetProgress = {\r\n          progress: Math.min(rawProgress, 100),\r\n          isMet: monthStats.month_pnl >= targetAmount,\r\n          rawProgress\r\n        };\r\n      }\r\n\r\n      stats.set(monthIndex, {\r\n        monthPnL: monthStats.month_pnl,\r\n        tradeCount: monthStats.trade_count,\r\n        accountValueAtStartOfMonth: monthStats.account_value_at_start,\r\n        targetProgress,\r\n        growthPercentage: monthStats.growth_percentage.toFixed(2)\r\n      });\r\n    }\r\n\r\n    return stats;\r\n  }, [currentYear, yearStats, accountBalance, monthlyTarget]);\r\n\r\n  // Get best month from pre-calculated year_stats\r\n  const bestMonth = React.useMemo(() => {\r\n    const yearData = yearStats[currentYear.toString()];\r\n\r\n    if (!yearData || yearData.best_month_pnl <= 0) {\r\n      return {\r\n        name: 'None',\r\n        pnl: 0\r\n      };\r\n    }\r\n\r\n    return {\r\n      name: months[yearData.best_month_index],\r\n      pnl: yearData.best_month_pnl\r\n    };\r\n  }, [currentYear, yearStats, months]);\r\n\r\n  // Calculate yearly target progress using pre-calculated values\r\n  const yearlyTargetProgress = React.useMemo(() => {\r\n    if (!yearlyTarget || yearlyTarget <= 0 || accountValueAtStartOfYear <= 0) return null;\r\n\r\n    const targetAmount = (yearlyTarget / 100) * accountValueAtStartOfYear;\r\n    const rawProgress = targetAmount > 0 ? (yearlyPnL / targetAmount) * 100 : 0;\r\n\r\n    return {\r\n      progress: Math.min(rawProgress, 100),\r\n      isMet: yearlyPnL >= targetAmount,\r\n      rawProgress\r\n    };\r\n  }, [yearlyTarget, accountValueAtStartOfYear, yearlyPnL]);\r\n\r\n  const dialogTitle = (\r\n    <Box sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>\r\n      <CalendarToday sx={{\r\n        fontSize: { xs: '1.5rem', sm: '1.6rem', md: '1.75rem' },\r\n        color: theme.palette.primary.main\r\n      }} />\r\n      <Typography\r\n        variant=\"h5\"\r\n        sx={{\r\n          fontWeight: 700,\r\n          flex: 1,\r\n          color: 'text.primary',\r\n          fontSize: { xs: '1.25rem', sm: '1.35rem', md: '1.5rem' },\r\n          ml: { xs: 1, sm: 1.25, md: 1.5 }\r\n        }}\r\n      >\r\n        Select Month\r\n      </Typography>\r\n      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n        {currentYear !== new Date().getFullYear() && (\r\n          <Button\r\n            onClick={handleToday}\r\n            size={isSmDown ? 'small' : 'medium'}\r\n            variant=\"outlined\"\r\n            startIcon={<CalendarToday sx={{ fontSize: '1.05rem' }} />}\r\n            sx={{\r\n              ml: 1,\r\n              textTransform: 'none',\r\n              fontWeight: 600,\r\n              borderRadius: 1.5,\r\n              px: { xs: 1.5, sm: 1.75, md: 2 }\r\n            }}\r\n          >\r\n            Today\r\n          </Button>\r\n        )}\r\n        <IconButton onClick={handlePrevYear} sx={{ color: 'text.primary', bgcolor: alpha(theme.palette.primary.main, 0.05) }}>\r\n          <ChevronLeft />\r\n        </IconButton>\r\n        <Typography\r\n          variant=\"h5\"\r\n          sx={{\r\n            fontWeight: 800,\r\n            color: 'text.primary',\r\n            minWidth: { xs: 64, sm: 72, md: 80 },\r\n            textAlign: 'center',\r\n            letterSpacing: '-0.5px'\r\n          }}\r\n        >\r\n          {currentYear}\r\n        </Typography>\r\n        <IconButton onClick={handleNextYear} sx={{ color: 'text.primary', bgcolor: alpha(theme.palette.primary.main, 0.05) }}>\r\n          <ChevronRight />\r\n        </IconButton>\r\n      </Box>\r\n    </Box>\r\n  );\r\n\r\n  const dialogActions = (\r\n    <Box sx={{ display: 'flex', gap: { xs: 1.5, sm: 2 } }}>\r\n\r\n      <Button\r\n        onClick={onClose}\r\n        variant=\"outlined\"\r\n        size={isSmDown ? 'medium' : 'large'}\r\n        sx={{\r\n          textTransform: 'none',\r\n          fontWeight: 600,\r\n          borderRadius: 1.5,\r\n          px: { xs: 2, sm: 2.5, md: 3 }\r\n        }}\r\n      >\r\n        Cancel\r\n      </Button>{onOpenGalleryMode && totalTrades > 0 && (\r\n        <Button\r\n          onClick={handleYearlyGalleryMode}\r\n          variant=\"contained\"\r\n          size={isSmDown ? 'medium' : 'large'}\r\n          startIcon={<GalleryIcon />}\r\n          sx={{\r\n            textTransform: 'none',\r\n            fontWeight: 600,\r\n            borderRadius: 1.5,\r\n            px: { xs: 2, sm: 2.5, md: 3 }\r\n          }}\r\n        >\r\n          Gallery View\r\n        </Button>\r\n      )}\r\n\r\n    </Box>\r\n  );\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={onClose}\r\n      title={dialogTitle}\r\n      actions={dialogActions}\r\n      maxWidth=\"sm\"\r\n      fullWidth\r\n      hideFooterCancelButton\r\n    >\r\n      <Box sx={{\r\n        pt: { xs: '12px', sm: '16px', md: '24px' },\r\n        pb: { xs: '12px', sm: '16px', md: '24px' },\r\n        ...scrollbarStyles(theme)\r\n      }}>\r\n        <Paper elevation={0} sx={{\r\n          px: { xs: 2, sm: 2.5, md: 3 },\r\n          py: { xs: 1.5, sm: 2, md: 2 },\r\n          mb: 2,\r\n          borderRadius: 2,\r\n          bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n          border: '1px solid',\r\n          borderColor: theme => theme.palette.divider,\r\n          position: 'relative',\r\n          overflow: 'hidden',\r\n        }}>\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            mb: { xs: 2, sm: 2.25, md: 2.5 },\r\n            pl: 1\r\n          }}>\r\n            <Box sx={{ display: 'flex', flexDirection: 'row', gap: 0.5 }}>\r\n              <Typography\r\n                variant=\"h6\"\r\n                sx={{\r\n                  color: 'text.primary',\r\n                  fontSize: { xs: '1rem', sm: '1.05rem', md: '1.1rem' },\r\n                  fontWeight: 600\r\n                }}\r\n              >\r\n                Yearly Statistics\r\n              </Typography>\r\n              {yearlyTargetProgress && (\r\n                <TargetBadge\r\n                  progress={yearlyTargetProgress.rawProgress}\r\n                  isMet={yearlyTargetProgress.isMet}\r\n                  tooltipText={`${yearlyTargetProgress.isMet ? 'Yearly target achieved' : 'Progress towards yearly target'}: ${yearlyTargetProgress.rawProgress.toFixed(0)}%`}\r\n                />\r\n              )}\r\n            </Box>\r\n\r\n            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>\r\n              <Box sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                gap: 1,\r\n                bgcolor: theme => alpha(theme.palette.success.light, 0.1),\r\n                py: 0.75,\r\n                px: 1.5,\r\n                borderRadius: 1,\r\n                border: '1px solid',\r\n                borderColor: 'success.light'\r\n              }}>\r\n                <Typography variant=\"body2\" sx={{\r\n                  fontSize: '0.85rem',\r\n                  fontWeight: 500,\r\n                  color: 'text.secondary'\r\n                }}>\r\n                  Best Month:\r\n                </Typography>\r\n                <Typography variant=\"body2\" sx={{\r\n                  fontSize: '0.85rem',\r\n                  fontWeight: 700,\r\n                  color: 'success.main'\r\n                }}>\r\n                  {bestMonth.name} (${bestMonth.pnl.toLocaleString()})\r\n                </Typography>\r\n              </Box>\r\n\r\n\r\n            </Box>\r\n\r\n          </Box>\r\n\r\n          <Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', sm: '1fr 1fr', md: '1fr 1fr 1fr' }, gap: { xs: 2, sm: 3, md: 4 }, width: '100%' }}>\r\n            <Box>\r\n              <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 1 }}>\r\n                <Box sx={{\r\n                  p: 0.7,\r\n                  borderRadius: 1,\r\n                  bgcolor: theme => alpha(theme.palette.primary.main, 0.1),\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  mb: 1\r\n                }}>\r\n                  <TrendingUp sx={{\r\n                    fontSize: { xs: '1.05rem', sm: '1.15rem', md: '1.2rem' },\r\n                    color: 'primary.main'\r\n                  }} />\r\n                </Box>\r\n                <Typography variant=\"body1\" sx={{\r\n                  fontSize: '1rem',\r\n                  fontWeight: 600,\r\n                  color: 'text.primary',\r\n                  textAlign: 'center'\r\n                }}>\r\n                  Yearly P&L\r\n                </Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 0.5 }}>\r\n                <Typography\r\n                  variant=\"h5\"\r\n                  sx={{\r\n                    fontWeight: 700,\r\n                    fontSize: { xs: '1.35rem', sm: '1.4rem', md: '1.5rem' },\r\n                    color: theme => {\r\n                      if (yearlyPnL > 0) return theme.palette.success.main;\r\n                      if (yearlyPnL < 0) return theme.palette.error.main;\r\n                      return theme.palette.mode === 'dark' ? 'grey.300' : 'text.primary';\r\n                    },\r\n                    textAlign: 'center'\r\n                  }}\r\n                >\r\n                  ${Math.abs(yearlyPnL).toLocaleString()}\r\n                </Typography>\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  flexDirection: 'row',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  gap: 0.5,\r\n                }}>\r\n                  <Typography variant=\"body2\" sx={{\r\n                    fontWeight: 500,\r\n                    color: 'text.secondary',\r\n                    fontSize: { xs: '0.85rem', sm: '0.9rem' },\r\n                    textAlign: 'center'\r\n                  }}>\r\n                    Growth\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{\r\n                    fontWeight: 700,\r\n                    color: theme => {\r\n                      if (yearlyPnL > 0) return theme.palette.success.main;\r\n                      if (yearlyPnL < 0) return theme.palette.error.main;\r\n                      return theme.palette.mode === 'dark' ? 'grey.300' : 'text.primary';\r\n                    },\r\n                    fontSize: '1rem',\r\n                    textAlign: 'center'\r\n                  }}>\r\n                    {yearlyGrowthPercentage}%\r\n                  </Typography>\r\n                </Box>\r\n              </Box>\r\n            </Box>\r\n            <Box>\r\n              <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 1 }}>\r\n                <Box sx={{\r\n                  p: 0.7,\r\n                  borderRadius: 1,\r\n                  bgcolor: theme => alpha(theme.palette.success.main, 0.1),\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  mb: 1\r\n                }}>\r\n                  <EmojiEvents sx={{\r\n                    fontSize: { xs: '1.05rem', sm: '1.15rem', md: '1.2rem' },\r\n                    color: 'success.main'\r\n                  }} />\r\n                </Box>\r\n                <Typography variant=\"body1\" sx={{\r\n                  fontSize: '1rem',\r\n                  fontWeight: 600,\r\n                  color: 'text.primary',\r\n                  textAlign: 'center'\r\n                }}>\r\n                  Win Rate\r\n                </Typography>\r\n              </Box>\r\n              <Typography variant=\"h5\" sx={{\r\n                fontWeight: 700,\r\n                fontSize: { xs: '1.35rem', sm: '1.4rem', md: '1.5rem' },\r\n                color: parseFloat(yearlyWinRate) > 50 ? 'success.main' : 'text.primary',\r\n                textAlign: 'center'\r\n              }}>\r\n                {yearlyWinRate}%\r\n              </Typography>\r\n              <Typography variant=\"body1\" sx={{\r\n                fontWeight: 500,\r\n                fontSize: '1rem',\r\n                color: 'text.secondary',\r\n                mt: 0.5,\r\n                textAlign: 'center'\r\n              }}>\r\n                {yearlyWinCount} Ws / {yearlyLossCount} Ls\r\n              </Typography>\r\n            </Box>\r\n            <Box>\r\n              <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 1 }}>\r\n                <Box sx={{\r\n                  p: 0.7,\r\n                  borderRadius: 1,\r\n                  bgcolor: theme => alpha(theme.palette.info.main, 0.1),\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  mb: 1\r\n                }}>\r\n                  <CalendarMonth sx={{\r\n                    fontSize: { xs: '1.05rem', sm: '1.15rem', md: '1.2rem' },\r\n                    color: 'info.main'\r\n                  }} />\r\n                </Box>\r\n                <Typography variant=\"body1\" sx={{\r\n                  fontSize: '1rem',\r\n                  fontWeight: 600,\r\n                  color: 'text.primary',\r\n                  textAlign: 'center'\r\n                }}>\r\n                  Total Trades\r\n                </Typography>\r\n              </Box>\r\n              <Typography variant=\"h5\" sx={{\r\n                fontWeight: 700,\r\n                fontSize: { xs: '1.35rem', sm: '1.4rem', md: '1.5rem' },\r\n                color: 'text.primary',\r\n                textAlign: 'center'\r\n              }}>\r\n                {totalTrades}\r\n              </Typography>\r\n              <Typography variant=\"body1\" sx={{\r\n                fontWeight: 500,\r\n                fontSize: '1rem',\r\n                color: 'text.secondary',\r\n                mt: 0.5,\r\n                textAlign: 'center'\r\n              }}>\r\n                Trades this year\r\n              </Typography>\r\n            </Box>\r\n          </Box>\r\n        </Paper>\r\n        <Typography\r\n          variant=\"h6\"\r\n          sx={{\r\n            color: 'text.primary',\r\n            mb: { xs: 1.5, sm: 1.75, md: 2 },\r\n            fontSize: { xs: '1rem', sm: '1.05rem', md: '1.1rem' },\r\n            fontWeight: 600,\r\n            pl: 1\r\n          }}\r\n        >\r\n          Select a Month\r\n        </Typography>\r\n        <Box sx={{\r\n          display: 'grid',\r\n          gridTemplateColumns: { xs: '1fr', sm: 'repeat(2, 1fr)', md: 'repeat(3, 1fr)' },\r\n          gap: { xs: 1, sm: 1.25, md: 1.5 }\r\n        }}>\r\n          {months.map((month, index) => {\r\n            const stats = monthlyStats.get(index)!;\r\n            const { monthPnL, targetProgress, growthPercentage, tradeCount } = stats;\r\n            const hasEntries = monthPnL !== 0;\r\n\r\n            return (\r\n              <Paper\r\n                key={month}\r\n                onClick={() => handleMonthSelect(index)}\r\n                elevation={0}\r\n                sx={{\r\n                  p: { xs: 1.5, sm: 2, md: 2.5 },\r\n                  cursor: 'pointer',\r\n                  display: 'flex',\r\n                  flexDirection: 'column',\r\n                  gap: { xs: 0.75, sm: 0.85, md: 1 },\r\n                  height: '100%',\r\n                  bgcolor: theme => {\r\n                    if (hasEntries) {\r\n                      return theme.palette.mode === 'dark'\r\n                        ? alpha('#fff', 0.08)\r\n                        : alpha(theme.palette.primary.main, 0.04);\r\n                    }\r\n                    return theme.palette.mode === 'dark' ? 'transparent' : '#f5f5f5';\r\n                  },\r\n                  border: '1px solid',\r\n                  borderColor: theme =>\r\n                    currentMonth === index && currentYear === initialDate?.getFullYear()\r\n                      ? theme.palette.primary.main\r\n                      : theme.palette.mode === 'dark' ? alpha('#fff', 0.12) : theme.palette.grey[200],\r\n                  borderRadius: 2,\r\n                  transition: 'all 0.2s',\r\n                  position: 'relative',\r\n                  overflow: 'hidden',\r\n                  ...(currentMonth === index && currentYear === initialDate?.getFullYear() && {\r\n                    '&::before': {\r\n                      content: '\"\"',\r\n                      position: 'absolute',\r\n                      top: 0,\r\n                      left: 0,\r\n                      width: '100%',\r\n                      height: '4px',\r\n                      backgroundColor: 'primary.main',\r\n                    }\r\n                  }),\r\n                  '&:hover': {\r\n                    bgcolor: theme => theme.palette.mode === 'dark'\r\n                      ? alpha('#fff', 0.12)\r\n                      : alpha(theme.palette.primary.main, 0.08),\r\n                    borderColor: 'primary.main',\r\n                    transform: 'translateY(-2px)',\r\n                    boxShadow: theme => `0 4px 12px ${alpha(theme.palette.primary.main, 0.2)}`\r\n                  }\r\n                }}\r\n              >\r\n                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 0.5, mr: 1 }}>\r\n                  <Typography\r\n                    variant=\"h6\"\r\n                    sx={{\r\n                      color: theme =>\r\n                        currentMonth === index && currentYear === initialDate?.getFullYear()\r\n                          ? theme.palette.primary.main\r\n                          : theme.palette.text.primary,\r\n                      fontWeight: 700,\r\n                      fontSize: { xs: '1rem', sm: '1.05rem', md: '1.1rem' },\r\n                      whiteSpace: 'nowrap',\r\n                      overflow: 'hidden',\r\n                      textOverflow: 'ellipsis'\r\n                    }}\r\n                  >\r\n                    {month}\r\n                  </Typography>\r\n\r\n                  {targetProgress && hasEntries && (\r\n                    <Box sx={{ ml: 1 }}>\r\n                      <TargetBadge\r\n                        progress={targetProgress.rawProgress}\r\n                        isMet={targetProgress.isMet}\r\n                        tooltipText={`${targetProgress.isMet ? 'Monthly target achieved' : 'Progress towards monthly target'}: ${targetProgress.rawProgress.toFixed(0)}%`}\r\n                      />\r\n                    </Box>\r\n                  )}\r\n                </Box>\r\n                {hasEntries && (\r\n                  <>\r\n                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>\r\n                      <Typography\r\n                        variant=\"h6\"\r\n                        sx={{\r\n                          color: monthPnL > 0 ? 'success.main' : 'error.main',\r\n                          fontSize: { xs: '1.1rem', sm: '1.15rem', md: '1.2rem' },\r\n                          fontWeight: 700,\r\n                          display: 'flex',\r\n                          alignItems: 'center',\r\n                          gap: 0.5\r\n                        }}\r\n                      >\r\n                        ${Math.abs(monthPnL).toLocaleString()}\r\n                        <Box component=\"span\" sx={{ fontSize: { xs: '0.8rem', sm: '0.85rem', md: '0.9rem' }, fontWeight: 600 }}>\r\n                          {monthPnL > 0 ? '' : ''}\r\n                        </Box>\r\n                      </Typography>\r\n\r\n                      <Box sx={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        gap: 0.5,\r\n                      }}>\r\n                        <Typography variant=\"caption\" sx={{ fontWeight: 500, color: 'text.secondary', fontSize: '0.75rem' }}>\r\n                          Growth\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" sx={{\r\n                          fontWeight: 600,\r\n                          color: monthPnL > 0 ? 'success.main' : 'error.main',\r\n                          fontSize: '0.75rem'\r\n                        }}>\r\n                          {growthPercentage}%\r\n                        </Typography>\r\n                      </Box>\r\n\r\n                      <Box sx={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        gap: 0.5,\r\n                      }}>\r\n                        <Typography variant=\"caption\" sx={{ fontWeight: 500, color: 'text.secondary', fontSize: '0.75rem' }}>\r\n                          Trades:\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" sx={{\r\n                          fontWeight: 600,\r\n                          color: 'text.primary',\r\n                          fontSize: '0.75rem'\r\n                        }}>\r\n                          {tradeCount}\r\n                        </Typography>\r\n                      </Box>\r\n                    </Box>\r\n\r\n                  </>\r\n                )}\r\n              </Paper>\r\n            );\r\n          })}\r\n        </Box>\r\n      </Box>\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default SelectDateDialog;","import React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  IconButton,\r\n  Divider,\r\n  TextField,\r\n  InputAdornment,\r\n  Chip,\r\n  useTheme,\r\n  alpha,\r\n  Tooltip,\r\n  Button,\r\n  FormControlLabel,\r\n  Switch,\r\n  Select,\r\n  MenuItem,\r\n  FormControl\r\n} from '@mui/material';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport {\r\n  Edit as EditIcon,\r\n  Search as SearchIcon,\r\n  FilterList as FilterListIcon,\r\n  Info as InfoIcon\r\n} from '@mui/icons-material';\r\nimport { BaseDialog } from './common';\r\nimport TagEditDialog from './TagEditDialog';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups\r\n} from '../utils/tagColors';\r\nimport { Calendar } from '../types/calendar';\r\nimport { logger } from '../utils/logger';\r\n\r\ninterface TagManagementDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  allTags: string[];\r\n  calendarId: string;\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n  requiredTagGroups?: string[];\r\n  onUpdateCalendarProperty?: (calendarId: string, updateCallback: (calendar: Calendar) => Calendar) => Promise<Calendar | undefined>;\r\n}\r\n\r\nconst TagManagementDialog: React.FC<TagManagementDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  allTags,\r\n  calendarId,\r\n  onTagUpdated,\r\n  requiredTagGroups = [],\r\n  onUpdateCalendarProperty\r\n}) => {\r\n  const theme = useTheme();\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedTagGroup, setSelectedTagGroup] = useState<string>('');\r\n  const [tagToEdit, setTagToEdit] = useState<string | null>(null);\r\n  const [localRequiredGroups, setLocalRequiredGroups] = useState<string[]>(requiredTagGroups);\r\n\r\n  // Update local state when props change\r\n  useEffect(() => {\r\n    setLocalRequiredGroups(requiredTagGroups);\r\n  }, [requiredTagGroups]);\r\n\r\n  // Get all unique tag groups\r\n  const tagGroups = useMemo(() => {\r\n    return getUniqueTagGroups(allTags);\r\n  }, [allTags]);\r\n\r\n  // Reset selected tag group if it no longer exists in the available tag groups\r\n  useEffect(() => {\r\n    if (selectedTagGroup && !tagGroups.includes(selectedTagGroup)) {\r\n      setSelectedTagGroup('');\r\n    }\r\n  }, [tagGroups, selectedTagGroup]);\r\n\r\n  // Filter tags based on search term and selected group\r\n  const filteredTags = useMemo(() => {\r\n    let filtered = allTags;\r\n\r\n    // Filter by group if selected\r\n    if (selectedTagGroup) {\r\n      filtered = filtered.filter(tag =>\r\n        isGroupedTag(tag) && getTagGroup(tag) === selectedTagGroup\r\n      );\r\n    }\r\n\r\n    // Filter by search term\r\n    if (searchTerm) {\r\n      const term = searchTerm.toLowerCase();\r\n      filtered = filtered.filter(tag =>\r\n        tag.toLowerCase().includes(term) ||\r\n        formatTagForDisplay(tag).toLowerCase().includes(term)\r\n      );\r\n    }\r\n\r\n    return filtered;\r\n  }, [allTags, searchTerm, selectedTagGroup]);\r\n\r\n  // Group tags by their group\r\n  const groupedTags = useMemo(() => {\r\n    const groups: Record<string, string[]> = {};\r\n\r\n    filteredTags.forEach(tag => {\r\n      if (isGroupedTag(tag)) {\r\n        const group = getTagGroup(tag);\r\n        if (!groups[group]) {\r\n          groups[group] = [];\r\n        }\r\n        groups[group].push(tag);\r\n      } else {\r\n        if (!groups['Ungrouped']) {\r\n          groups['Ungrouped'] = [];\r\n        }\r\n        groups['Ungrouped'].push(tag);\r\n      }\r\n    });\r\n\r\n    return groups;\r\n  }, [filteredTags]);\r\n\r\n  const handleTagEditSuccess = (oldTag: string, newTag: string, tradesUpdated: number) => {\r\n    logger.log(`Tag update completed: ${oldTag} -> ${newTag}, ${tradesUpdated} trades updated`);\r\n\r\n    // Check if this was a tag group name change\r\n    const oldGroup = isGroupedTag(oldTag) ? getTagGroup(oldTag) : null;\r\n    const newGroup = isGroupedTag(newTag) ? getTagGroup(newTag) : null;\r\n\r\n    // If the selected tag group was the old group name, update it to the new group name\r\n    if (oldGroup && newGroup && oldGroup !== newGroup && selectedTagGroup === oldGroup) {\r\n      setSelectedTagGroup(newGroup);\r\n    }\r\n\r\n    // Update local required groups if a group name changed\r\n    if (oldGroup && newGroup && oldGroup !== newGroup) {\r\n      const updatedRequiredGroups = localRequiredGroups.map(group =>\r\n        group === oldGroup ? newGroup : group\r\n      );\r\n      setLocalRequiredGroups(updatedRequiredGroups);\r\n    }\r\n\r\n    // If the tag was deleted (newTag is empty) and we were filtering by its group,\r\n    // check if the group still has other tags, if not, reset the filter\r\n    if (!newTag.trim() && oldGroup && selectedTagGroup === oldGroup) {\r\n      // We'll let the memoized tagGroups handle this - if the group no longer exists,\r\n      // the filter will show no results, which is correct behavior\r\n      // Alternatively, we could reset to show all groups:\r\n      // setSelectedTagGroup('');\r\n    }\r\n\r\n    if (onTagUpdated) {\r\n      onTagUpdated(oldTag, newTag);\r\n    }\r\n  };\r\n\r\n  const handleTagDelete = (deletedTag: string, tradesUpdated: number) => {\r\n    logger.log(`Tag deletion completed: ${deletedTag}, ${tradesUpdated} trades updated`);\r\n\r\n    // Check if the deleted tag was from a group we're currently filtering by\r\n    const deletedGroup = isGroupedTag(deletedTag) ? getTagGroup(deletedTag) : null;\r\n\r\n    // If we were filtering by the deleted tag's group, check if the group still has other tags\r\n    if (deletedGroup && selectedTagGroup === deletedGroup) {\r\n      // The memoized tagGroups will handle this - if the group no longer exists,\r\n      // the filter will show no results, which is correct behavior\r\n      // Alternatively, we could reset to show all groups:\r\n      // setSelectedTagGroup('');\r\n    }\r\n\r\n    // Remove the deleted tag from required groups if it was there\r\n    if (deletedGroup && localRequiredGroups.includes(deletedGroup)) {\r\n      // Check if there are any other tags in this group\r\n      const otherTagsInGroup = allTags.filter(tag =>\r\n        tag !== deletedTag && isGroupedTag(tag) && getTagGroup(tag) === deletedGroup\r\n      );\r\n\r\n      // If no other tags in this group, remove it from required groups\r\n      if (otherTagsInGroup.length === 0) {\r\n        const updatedRequiredGroups = localRequiredGroups.filter(group => group !== deletedGroup);\r\n        setLocalRequiredGroups(updatedRequiredGroups);\r\n        handleRequiredTagGroupsChange(updatedRequiredGroups);\r\n      }\r\n    }\r\n\r\n    if (onTagUpdated) {\r\n      onTagUpdated(deletedTag, ''); // Pass empty string to indicate deletion\r\n    }\r\n  };\r\n\r\n  const handleRequiredTagGroupsChange = (groups: string[]) => {\r\n    setLocalRequiredGroups(groups);\r\n\r\n    if (onUpdateCalendarProperty) {\r\n      onUpdateCalendarProperty(calendarId, (calendar) => ({\r\n        ...calendar,\r\n        required_tag_groups: groups\r\n      }));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={onClose}\r\n      title=\"Tag Management\"\r\n      maxWidth=\"md\"\r\n      fullWidth\r\n    >\r\n      <Box sx={{ p: 2 }}>\r\n        <Box sx={{ mb: 3 }}>\r\n          <Typography variant=\"body1\" gutterBottom>\r\n            Manage your tags and set required tag groups for new trades.\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            When a tag group is set as required, every new trade must include at least one tag from this group.\r\n          </Typography>\r\n        </Box>\r\n\r\n        <Box sx={{ mb: 3 }}>\r\n          <Typography variant=\"subtitle1\" fontWeight={600} gutterBottom>\r\n            Required Tag Groups\r\n          </Typography>\r\n          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, mb: 2 }}>\r\n            {localRequiredGroups.length > 0 ? (\r\n              localRequiredGroups.map(group => (\r\n                <Chip\r\n                  key={group}\r\n                  label={group}\r\n                  color=\"primary\"\r\n                  variant=\"outlined\"\r\n                  sx={{ fontWeight: 600 }}\r\n                />\r\n              ))\r\n            ) : (\r\n              <Typography variant=\"body2\" color=\"text.secondary\">\r\n                No required tag groups set. Edit a tag group to make it required.\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n        </Box>\r\n\r\n        <Box sx={{ mb: 3 }}>\r\n          <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>\r\n            <TextField\r\n              fullWidth\r\n              placeholder=\"Search tags...\"\r\n              value={searchTerm}\r\n              onChange={(e) => setSearchTerm(e.target.value)}\r\n              InputProps={{\r\n                startAdornment: (\r\n                  <InputAdornment position=\"start\">\r\n                    <SearchIcon />\r\n                  </InputAdornment>\r\n                )\r\n              }}\r\n              size=\"small\"\r\n            />\r\n            <FormControl size=\"small\" sx={{ minWidth: 150 }}>\r\n              <Select\r\n                value={selectedTagGroup}\r\n                onChange={(e) => setSelectedTagGroup(e.target.value)}\r\n                displayEmpty\r\n                startAdornment={\r\n                  <InputAdornment position=\"start\">\r\n                    <FilterListIcon fontSize=\"small\" />\r\n                  </InputAdornment>\r\n                }\r\n              >\r\n                <MenuItem value=\"\">All Groups</MenuItem>\r\n                {tagGroups.map(group => (\r\n                  <MenuItem key={group} value={group}>{group}</MenuItem>\r\n                ))}\r\n              </Select>\r\n            </FormControl>\r\n          </Box>\r\n\r\n          <Box sx={{\r\n            maxHeight: '400px',\r\n            overflow: 'auto',\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            borderRadius: 1,\r\n            ...theme.typography.body2,\r\n            ...scrollbarStyles(theme)\r\n          }}>\r\n            {Object.entries(groupedTags).length > 0 ? (\r\n              Object.entries(groupedTags).map(([group, tags]) => (\r\n                <Box key={group}>\r\n                  <Box sx={{\r\n                    p: 1.5,\r\n                    bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'space-between'\r\n                  }}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                        {group}\r\n                      </Typography>\r\n                      {group !== 'Ungrouped' && (\r\n                        <Box sx={{ display: 'flex', alignItems: 'center', ml: 1 }}>\r\n                          <FormControlLabel\r\n                            control={\r\n                              <Switch\r\n                                checked={localRequiredGroups.includes(group)}\r\n                                onChange={(e) => {\r\n                                  const isChecked = e.target.checked;\r\n                                  const updatedGroups = isChecked\r\n                                    ? [...localRequiredGroups, group]\r\n                                    : localRequiredGroups.filter(g => g !== group);\r\n                                  handleRequiredTagGroupsChange(updatedGroups);\r\n                                }}\r\n                                color=\"primary\"\r\n                                size=\"small\"\r\n                              />\r\n                            }\r\n                            label={\r\n                              <Typography variant=\"caption\" sx={{ fontWeight: 500 }}>\r\n                                Required\r\n                              </Typography>\r\n                            }\r\n                          />\r\n                          <Tooltip title=\"When a tag group is set as required, every new trade must include at least one tag from this group\">\r\n                            <InfoIcon sx={{ ml: 0.5, color: 'text.secondary', fontSize: '0.875rem' }} />\r\n                          </Tooltip>\r\n                        </Box>\r\n                      )}\r\n                    </Box>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\">\r\n                      {tags.length} tag{tags.length !== 1 ? 's' : ''}\r\n                    </Typography>\r\n                  </Box>\r\n                  <Divider />\r\n                  <List disablePadding>\r\n                    {tags.map((tag) => (\r\n                      <ListItem\r\n                        key={tag}\r\n                        secondaryAction={\r\n                          <Button\r\n                            color=\"primary\"\r\n                            sx={{ minWidth: 'auto', p: 0.5 }}\r\n                            onClick={() => setTagToEdit(tag)}\r\n                          >\r\n                            Edit\r\n                          </Button>\r\n                      \r\n                            \r\n                        }\r\n                        sx={{\r\n                          '&:hover': {\r\n                            bgcolor: alpha(theme.palette.primary.main, 0.05)\r\n                          }\r\n                        }}\r\n                      >\r\n                        <ListItemText\r\n                          primary={\r\n                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                              <Chip\r\n                                label={formatTagForDisplay(tag,true)}\r\n                                size=\"small\"\r\n                                sx={getTagChipStyles(tag, theme)}\r\n                              />\r\n                               \r\n                            </Box>\r\n                          }\r\n                        />\r\n                      </ListItem>\r\n                    ))}\r\n                  </List>\r\n                </Box>\r\n              ))\r\n            ) : (\r\n              <Box sx={{ p: 3, textAlign: 'center' }}>\r\n                <Typography color=\"text.secondary\">\r\n                  No tags found matching your search criteria.\r\n                </Typography>\r\n              </Box>\r\n            )}\r\n          </Box>\r\n        </Box>\r\n      </Box>\r\n\r\n      {tagToEdit && (\r\n        <TagEditDialog\r\n          open={!!tagToEdit}\r\n          onClose={() => setTagToEdit(null)}\r\n          tag={tagToEdit}\r\n          calendarId={calendarId}\r\n          onSuccess={handleTagEditSuccess}\r\n          onDelete={handleTagDelete}\r\n          onTagUpdated={onTagUpdated}\r\n        />\r\n      )}\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default TagManagementDialog;\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n    TextField,\r\n    Typography,\r\n    Box,\r\n    alpha,\r\n    useTheme,\r\n    CircularProgress\r\n} from '@mui/material';\r\nimport { AutoAwesome as AIIcon } from '@mui/icons-material';\r\nimport { formatTagWithCapitalizedGroup } from '../utils/tagColors';\r\nimport { BaseDialog } from './common';\r\nimport { logger } from '../utils/logger';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport { tagService } from '../services/tagService';\r\nimport { useAuthState } from '../contexts/AuthStateContext';\r\n\r\ninterface TagCreateDialogProps {\r\n    open: boolean;\r\n    onClose: (created?: boolean) => void;\r\n    calendarId: string;\r\n    allTags: string[];\r\n    onTagCreated?: (newTag: string) => Promise<void>;\r\n}\r\n\r\nconst TagCreateDialog: React.FC<TagCreateDialogProps> = ({\r\n    open,\r\n    onClose,\r\n    calendarId,\r\n    allTags,\r\n    onTagCreated\r\n}) => {\r\n    const theme = useTheme();\r\n    const { user } = useAuthState();\r\n    const [tagName, setTagName] = useState('');\r\n    const [tagGroup, setTagGroup] = useState('');\r\n    const [definition, setDefinition] = useState('');\r\n    const [isSubmitting, setIsSubmitting] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Reset state when dialog opens\r\n    useEffect(() => {\r\n        if (open) {\r\n            setTagName('');\r\n            setTagGroup('');\r\n            setDefinition('');\r\n            setError(null);\r\n        }\r\n    }, [open]);\r\n\r\n    const handleSubmit = async (e?: React.FormEvent) => {\r\n        if (e) e.preventDefault();\r\n\r\n        const trimmedTagName = tagName.trim();\r\n        if (!trimmedTagName) {\r\n            setError('Tag name is required');\r\n            return;\r\n        }\r\n\r\n        // Capitalize the group name and build full tag\r\n        const trimmedGroup = tagGroup.trim();\r\n        const fullTag = trimmedGroup\r\n            ? formatTagWithCapitalizedGroup(`${trimmedGroup}:${trimmedTagName}`)\r\n            : trimmedTagName;\r\n\r\n        // Check if tag already exists\r\n        if (allTags.includes(fullTag)) {\r\n            setError('This tag already exists');\r\n            return;\r\n        }\r\n\r\n        setIsSubmitting(true);\r\n        setError(null);\r\n\r\n        try {\r\n            // 1. Save definition if provided\r\n            if (definition.trim() && user?.id) {\r\n                await tagService.saveTagDefinition(user.id, fullTag, definition);\r\n            }\r\n\r\n            // 2. Add tag to calendar\r\n            if (onTagCreated) {\r\n                await onTagCreated(fullTag);\r\n            }\r\n\r\n            onClose(true);\r\n        } catch (err) {\r\n            logger.error('Error creating tag:', err);\r\n            setError(err instanceof Error ? err.message : 'Failed to create tag');\r\n        } finally {\r\n            setIsSubmitting(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <BaseDialog\r\n            open={open}\r\n            onClose={() => !isSubmitting && onClose()}\r\n            maxWidth=\"sm\"\r\n            fullWidth\r\n            title=\"Create New Tag\"\r\n            primaryButtonText={isSubmitting ? 'Creating...' : 'Create Tag'}\r\n            primaryButtonAction={handleSubmit}\r\n            isSubmitting={isSubmitting}\r\n            cancelButtonText=\"Cancel\"\r\n            cancelButtonAction={() => onClose()}\r\n            hideCloseButton={isSubmitting}\r\n        >\r\n            <Box component=\"form\" onSubmit={handleSubmit} sx={{ display: 'flex', flexDirection: 'column', gap: 3, mt: 1 }}>\r\n                <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Add a new tag to your calendar. You can also group it by category for better organization.\r\n                </Typography>\r\n\r\n                <Box sx={{ display: 'flex', gap: 2 }}>\r\n                    <TextField\r\n                        label=\"Group (optional)\"\r\n                        value={tagGroup}\r\n                        onChange={(e) => {\r\n                            const value = e.target.value;\r\n                            if (value.includes(':')) return;\r\n                            setTagGroup(value);\r\n                        }}\r\n                        fullWidth\r\n                        placeholder=\"e.g. Strategy\"\r\n                        disabled={isSubmitting}\r\n                    />\r\n                    <TextField\r\n                        label=\"Tag Name\"\r\n                        value={tagName}\r\n                        onChange={(e) => {\r\n                            const value = e.target.value;\r\n                            if (value.includes(':')) return;\r\n                            setTagName(value);\r\n                        }}\r\n                        fullWidth\r\n                        required\r\n                        autoFocus\r\n                        error={!!error}\r\n                        helperText={error}\r\n                        placeholder=\"e.g. Breakout\"\r\n                        disabled={isSubmitting}\r\n                    />\r\n                </Box>\r\n\r\n                <TextField\r\n                    label=\"Definition (optional)\"\r\n                    value={definition}\r\n                    onChange={(e) => setDefinition(e.target.value)}\r\n                    fullWidth\r\n                    multiline\r\n                    rows={3}\r\n                    disabled={isSubmitting}\r\n                    placeholder=\"What does this tag mean? Helps the AI analyze your trades.\"\r\n                    inputProps={{ maxLength: 2024 }}\r\n                    helperText={\r\n                        <Box component=\"span\" sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                            <AIIcon sx={{ fontSize: 14 }} />\r\n                            Help the AI understand your trading context\r\n                        </Box>\r\n                    }\r\n                    sx={{\r\n                        '& .MuiInputBase-input': {\r\n                            ...scrollbarStyles(theme)\r\n                        }\r\n                    }}\r\n                />\r\n            </Box>\r\n        </BaseDialog>\r\n    );\r\n};\r\n\r\nexport default TagCreateDialog;\r\n","import React, { useState, useEffect, useMemo, useCallback } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  ListItemButton,\r\n  IconButton,\r\n  Divider,\r\n  TextField,\r\n  InputAdornment,\r\n  Chip,\r\n  useTheme,\r\n  alpha,\r\n  Tooltip,\r\n  Button,\r\n  FormControlLabel,\r\n  Switch,\r\n  Select,\r\n  MenuItem,\r\n  FormControl,\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogActions,\r\n  Collapse\r\n} from '@mui/material';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport {\r\n  Edit as EditIcon,\r\n  Search as SearchIcon,\r\n  FilterList as FilterListIcon,\r\n  Info as InfoIcon,\r\n  Tag as TagIcon,\r\n  Close as CloseIcon,\r\n  Add as AddIcon,\r\n  ExpandMore as ExpandMoreIcon,\r\n  ExpandLess as ExpandLessIcon\r\n} from '@mui/icons-material';\r\nimport UnifiedDrawer from './common/UnifiedDrawer';\r\nimport TagEditDialog from './TagEditDialog';\r\nimport TagCreateDialog from './TagCreateDialog';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups\r\n} from '../utils/tagColors';\r\nimport { Calendar } from '../types/calendar';\r\nimport { logger } from '../utils/logger';\r\nimport { tagService } from '../services/tagService';\r\nimport { useAuthState } from '../contexts/AuthStateContext';\r\n\r\ninterface TagManagementDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  allTags: string[];\r\n  calendarId: string;\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n  requiredTagGroups?: string[];\r\n  onUpdateCalendarProperty?: (calendarId: string, updateCallback: (calendar: Calendar) => Calendar) => Promise<Calendar | undefined>;\r\n  // Read-only mode for shared calendars\r\n  isReadOnly?: boolean;\r\n  // Calendar owner's user ID (for fetching tag definitions in read-only mode)\r\n  calendarOwnerId?: string;\r\n}\r\n\r\nconst TagManagementDrawer: React.FC<TagManagementDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  allTags,\r\n  calendarId,\r\n  onTagUpdated,\r\n  requiredTagGroups = [],\r\n  onUpdateCalendarProperty,\r\n  isReadOnly = false,\r\n  calendarOwnerId\r\n}) => {\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [selectedTagGroup, setSelectedTagGroup] = useState<string>('');\r\n  const [tagToEdit, setTagToEdit] = useState<string | null>(null);\r\n  const [tagToView, setTagToView] = useState<string | null>(null);\r\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\r\n  const [localRequiredGroups, setLocalRequiredGroups] = useState<string[]>(requiredTagGroups);\r\n  const [tagDefinitions, setTagDefinitions] = useState<Record<string, string>>({});\r\n  const [collapsedGroups, setCollapsedGroups] = useState<Record<string, boolean>>({});\r\n\r\n  const toggleGroup = (group: string) => {\r\n    setCollapsedGroups(prev => ({\r\n      ...prev,\r\n      [group]: !prev[group]\r\n    }));\r\n  };\r\n\r\n  // Update local state when props change\r\n  useEffect(() => {\r\n    setLocalRequiredGroups(requiredTagGroups);\r\n  }, [requiredTagGroups]);\r\n\r\n  // Fetch tag definitions\r\n  // In read-only mode, fetch from the calendar owner's definitions\r\n  const fetchTagDefinitions = useCallback(async () => {\r\n    // Use calendarOwnerId for shared calendars, otherwise use current user\r\n    const userId = isReadOnly ? calendarOwnerId : user?.id;\r\n    if (!userId) return;\r\n\r\n    try {\r\n      const definitions = await tagService.fetchTagDefinitions(userId);\r\n      setTagDefinitions(definitions);\r\n    } catch (err) {\r\n      logger.error('Error fetching tag definitions:', err);\r\n    }\r\n  }, [user?.id, isReadOnly, calendarOwnerId]);\r\n\r\n  // Fetch tag definitions when drawer opens\r\n  useEffect(() => {\r\n    if (open) {\r\n      fetchTagDefinitions();\r\n    }\r\n  }, [open, fetchTagDefinitions]);\r\n\r\n  // Get all unique tag groups\r\n  const tagGroups = useMemo(() => {\r\n    return getUniqueTagGroups(allTags);\r\n  }, [allTags]);\r\n\r\n  // Reset selected tag group if it no longer exists in the available tag groups\r\n  useEffect(() => {\r\n    if (selectedTagGroup && !tagGroups.includes(selectedTagGroup)) {\r\n      setSelectedTagGroup('');\r\n    }\r\n  }, [tagGroups, selectedTagGroup]);\r\n\r\n  // Filter tags based on search term and selected group\r\n  const filteredTags = useMemo(() => {\r\n    let filtered = allTags;\r\n\r\n    // Filter by group if selected\r\n    if (selectedTagGroup) {\r\n      filtered = filtered.filter(tag =>\r\n        isGroupedTag(tag) && getTagGroup(tag) === selectedTagGroup\r\n      );\r\n    }\r\n\r\n    // Filter by search term\r\n    if (searchTerm) {\r\n      const term = searchTerm.toLowerCase();\r\n      filtered = filtered.filter(tag =>\r\n        tag.toLowerCase().includes(term) ||\r\n        formatTagForDisplay(tag).toLowerCase().includes(term)\r\n      );\r\n    }\r\n\r\n    return filtered;\r\n  }, [allTags, searchTerm, selectedTagGroup]);\r\n\r\n  // Group tags by their group\r\n  const groupedTags = useMemo(() => {\r\n    const groups: Record<string, string[]> = {};\r\n\r\n    filteredTags.forEach(tag => {\r\n      if (isGroupedTag(tag)) {\r\n        const group = getTagGroup(tag);\r\n        if (!groups[group]) {\r\n          groups[group] = [];\r\n        }\r\n        groups[group].push(tag);\r\n      } else {\r\n        if (!groups['Ungrouped']) {\r\n          groups['Ungrouped'] = [];\r\n        }\r\n        groups['Ungrouped'].push(tag);\r\n      }\r\n    });\r\n\r\n    return groups;\r\n  }, [filteredTags]);\r\n\r\n  const handleTagEditSuccess = (oldTag: string, newTag: string, tradesUpdated: number) => {\r\n    logger.log(`Tag update completed: ${oldTag} -> ${newTag}, ${tradesUpdated} trades updated`);\r\n\r\n    // Check if this was a tag group name change\r\n    const oldGroup = isGroupedTag(oldTag) ? getTagGroup(oldTag) : null;\r\n    const newGroup = isGroupedTag(newTag) ? getTagGroup(newTag) : null;\r\n\r\n    // If the selected tag group was the old group name, update it to the new group name\r\n    if (oldGroup && newGroup && oldGroup !== newGroup && selectedTagGroup === oldGroup) {\r\n      setSelectedTagGroup(newGroup);\r\n    }\r\n\r\n    if (onTagUpdated) {\r\n      onTagUpdated(oldTag, newTag);\r\n    }\r\n  };\r\n\r\n  const handleTagDelete = (deletedTag: string, tradesUpdated: number) => {\r\n    logger.log(`Tag deletion completed: ${deletedTag}, ${tradesUpdated} trades updated`);\r\n\r\n    // Check if the deleted tag was from a group we're currently filtering by\r\n    const deletedGroup = isGroupedTag(deletedTag) ? getTagGroup(deletedTag) : null;\r\n\r\n    // If we were filtering by the deleted tag's group, reset the filter to show all groups\r\n    if (deletedGroup && selectedTagGroup === deletedGroup) {\r\n      // Check if there are any other tags in this group\r\n      const otherTagsInGroup = allTags.filter(tag =>\r\n        tag !== deletedTag && isGroupedTag(tag) && getTagGroup(tag) === deletedGroup\r\n      );\r\n\r\n      // If no other tags in this group, reset the filter\r\n      if (otherTagsInGroup.length === 0) {\r\n        setSelectedTagGroup('');\r\n      }\r\n    }\r\n\r\n    if (onTagUpdated) {\r\n      onTagUpdated(deletedTag, ''); // Pass empty string to indicate deletion\r\n    }\r\n  };\r\n\r\n  const handleRequiredTagGroupsChange = (groups: string[]) => {\r\n    setLocalRequiredGroups(groups);\r\n\r\n    if (onUpdateCalendarProperty) {\r\n      onUpdateCalendarProperty(calendarId, (calendar) => ({\r\n        ...calendar,\r\n        required_tag_groups: groups\r\n      }));\r\n    }\r\n  };\r\n\r\n  const handleTagCreated = async (newTag: string) => {\r\n    if (onUpdateCalendarProperty) {\r\n      await onUpdateCalendarProperty(calendarId, (calendar) => {\r\n        const currentTags = calendar.tags || [];\r\n        if (currentTags.includes(newTag)) return calendar;\r\n        return {\r\n          ...calendar,\r\n          tags: [...currentTags, newTag]\r\n        };\r\n      });\r\n      // Refresh definitions to include the new one\r\n      fetchTagDefinitions();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <UnifiedDrawer\r\n      open={open}\r\n      onClose={onClose}\r\n      title=\"Tag Management\"\r\n      icon={<TagIcon />}\r\n      width={{ xs: '100%', sm: 500 }}\r\n      headerVariant=\"enhanced\"\r\n      headerActions={\r\n        !isReadOnly && (\r\n          <Tooltip title=\"Create new tag\" arrow>\r\n            <IconButton\r\n              color=\"primary\"\r\n              onClick={() => setIsCreateDialogOpen(true)}\r\n              sx={{\r\n                bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                '&:hover': {\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.2)\r\n                }\r\n              }}\r\n            >\r\n              <AddIcon />\r\n            </IconButton>\r\n          </Tooltip>\r\n        )\r\n      }\r\n      contentSx={{ p: 2, ...scrollbarStyles(theme) }}\r\n    >\r\n      {/* Content */}\r\n      <Box>\r\n        <Box sx={{ mb: 3 }}>\r\n          <Typography variant=\"body1\" gutterBottom>\r\n            {isReadOnly ? \"View tags and their definitions to better understand this trader's terminology.\" : \"Manage your tags and set required tag groups for new trades.\"}\r\n          </Typography>\r\n          {!isReadOnly && (\r\n            <>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" gutterBottom>\r\n                When a tag group is set as required, every new trade must include at least one tag from this group.\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 4 }}>\r\n                Adding definitions to your tags helps the AI assistant and traders understand your trading terminology and provide more accurate analysis.\r\n              </Typography>\r\n            </>\r\n          )}\r\n        </Box>\r\n\r\n        {!isReadOnly && (\r\n          <Box sx={{ mb: 3 }}>\r\n            <Typography variant=\"subtitle1\" fontWeight={600} gutterBottom>\r\n              Required Tag Groups\r\n            </Typography>\r\n            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, mb: 2 }}>\r\n              {localRequiredGroups.length > 0 ? (\r\n                localRequiredGroups.map(group => (\r\n                  <Chip\r\n                    key={group}\r\n                    label={group}\r\n                    color=\"primary\"\r\n                    variant=\"outlined\"\r\n                    sx={{ fontWeight: 600 }}\r\n                    onDelete={() => {\r\n                      const updatedGroups = localRequiredGroups.filter(g => g !== group);\r\n                      handleRequiredTagGroupsChange(updatedGroups);\r\n                    }}\r\n                  />\r\n                ))\r\n              ) : (\r\n                <Typography variant=\"body2\" color=\"text.secondary\">\r\n                  No required tag groups set. Edit a tag group to make it required.\r\n                </Typography>\r\n              )}\r\n            </Box>\r\n          </Box>\r\n        )}\r\n\r\n        <Box sx={{ mb: 3 }}>\r\n          <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>\r\n            <TextField\r\n              fullWidth\r\n              placeholder=\"Search tags...\"\r\n              value={searchTerm}\r\n              onChange={(e) => setSearchTerm(e.target.value)}\r\n              InputProps={{\r\n                startAdornment: (\r\n                  <InputAdornment position=\"start\">\r\n                    <SearchIcon />\r\n                  </InputAdornment>\r\n                )\r\n              }}\r\n              size=\"small\"\r\n            />\r\n            <FormControl size=\"small\" sx={{ minWidth: 150 }}>\r\n              <Select\r\n                value={selectedTagGroup}\r\n                onChange={(e) => setSelectedTagGroup(e.target.value)}\r\n                displayEmpty\r\n                startAdornment={\r\n                  <InputAdornment position=\"start\">\r\n                    <FilterListIcon fontSize=\"small\" />\r\n                  </InputAdornment>\r\n                }\r\n              >\r\n                <MenuItem value=\"\">All Groups</MenuItem>\r\n                {tagGroups.map(group => (\r\n                  <MenuItem key={group} value={group}>{group}</MenuItem>\r\n                ))}\r\n              </Select>\r\n            </FormControl>\r\n          </Box>\r\n\r\n          <Box sx={{\r\n            maxHeight: '100%',\r\n            overflow: 'auto',\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            borderRadius: 1,\r\n            ...theme.typography.body2,\r\n            ...scrollbarStyles(theme)\r\n          }}>\r\n            {Object.entries(groupedTags).length > 0 ? (\r\n              Object.entries(groupedTags).map(([group, tags]) => (\r\n                <Box key={group}>\r\n                  <Box sx={{\r\n                    p: 1.5,\r\n                    bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'space-between'\r\n                  }}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                        {group}\r\n                      </Typography>\r\n                      {group !== 'Ungrouped' && !isReadOnly && (\r\n                        <Box sx={{ display: 'flex', alignItems: 'center', ml: 1 }}>\r\n                          <FormControlLabel\r\n                            control={\r\n                              <Switch\r\n                                checked={localRequiredGroups.includes(group)}\r\n                                onChange={(e) => {\r\n                                  const isChecked = e.target.checked;\r\n                                  const updatedGroups = isChecked\r\n                                    ? [...localRequiredGroups, group]\r\n                                    : localRequiredGroups.filter(g => g !== group);\r\n                                  handleRequiredTagGroupsChange(updatedGroups);\r\n                                }}\r\n                                color=\"primary\"\r\n                                size=\"small\"\r\n                              />\r\n                            }\r\n                            label={null}\r\n                          />\r\n                          <Tooltip title=\"When a tag group is set as required, every new trade must include at least one tag from this group\">\r\n                            <InfoIcon sx={{ ml: -1.5, color: 'text.secondary', fontSize: '0.875rem' }} />\r\n                          </Tooltip>\r\n                        </Box>\r\n                      )}\r\n                    </Box>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        {tags.length} tag{tags.length !== 1 ? 's' : ''}\r\n                      </Typography>\r\n                      <IconButton size=\"small\" onClick={() => toggleGroup(group)}>\r\n                        {collapsedGroups[group] ? <ExpandMoreIcon fontSize=\"small\" /> : <ExpandLessIcon fontSize=\"small\" />}\r\n                      </IconButton>\r\n                    </Box>\r\n                  </Box>\r\n                  <Divider />\r\n                  <Collapse in={!collapsedGroups[group]} timeout=\"auto\" unmountOnExit>\r\n                    <List disablePadding>\r\n                      {tags.map((tag) => (\r\n                        <ListItem\r\n                          key={tag}\r\n                          disablePadding\r\n                          secondaryAction={\r\n                            !isReadOnly ? (\r\n                              <Button\r\n                                color=\"primary\"\r\n                                sx={{ minWidth: 'auto', p: 0.5 }}\r\n                                onClick={(e) => {\r\n                                  e.stopPropagation();\r\n                                  setTagToEdit(tag);\r\n                                }}\r\n                              >\r\n                                Edit\r\n                              </Button>\r\n                            ) : undefined\r\n                          }\r\n                        >\r\n                          <ListItemButton\r\n                            onClick={() => setTagToView(tag)}\r\n                            sx={{\r\n                              '&:hover': {\r\n                                bgcolor: alpha(theme.palette.primary.main, 0.05)\r\n                              }\r\n                            }}\r\n                          >\r\n                            <ListItemText\r\n                              primary={\r\n                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                                  <Chip\r\n                                    label={formatTagForDisplay(tag, true)}\r\n                                    size=\"small\"\r\n                                    sx={getTagChipStyles(tag, theme)}\r\n                                  />\r\n                                </Box>\r\n                              }\r\n                              secondary={\r\n                                <Typography\r\n                                  variant=\"caption\"\r\n                                  color=\"text.secondary\"\r\n                                  sx={{\r\n                                    display: '-webkit-box',\r\n                                    WebkitLineClamp: 4,\r\n                                    WebkitBoxOrient: 'vertical',\r\n                                    overflow: 'hidden',\r\n                                    textOverflow: 'ellipsis',\r\n                                    mt: 0.5,\r\n                                    ml: 0.5,\r\n                                    opacity: tagDefinitions[tag] ? 1 : 0.6\r\n                                  }}\r\n                                >\r\n                                  {tagDefinitions[tag] || (isReadOnly ? 'No definition' : 'No definition  click Edit to add one')}\r\n                                </Typography>\r\n                              }\r\n                            />\r\n                          </ListItemButton>\r\n                        </ListItem>\r\n                      ))}\r\n                    </List>\r\n                  </Collapse>\r\n                </Box>\r\n              ))\r\n            ) : (\r\n              <Box sx={{ p: 3, textAlign: 'center' }}>\r\n                <Typography color=\"text.secondary\">\r\n                  No tags found matching your search criteria.\r\n                </Typography>\r\n              </Box>\r\n            )}\r\n          </Box>\r\n        </Box>\r\n      </Box>\r\n\r\n\r\n      {tagToEdit && (\r\n        <TagEditDialog\r\n          open={!!tagToEdit}\r\n          onClose={(definitionUpdated) => {\r\n            setTagToEdit(null);\r\n            if (definitionUpdated) {\r\n              fetchTagDefinitions();\r\n            }\r\n          }}\r\n          tag={tagToEdit}\r\n          calendarId={calendarId}\r\n          onSuccess={handleTagEditSuccess}\r\n          onDelete={handleTagDelete}\r\n          onTagUpdated={onTagUpdated}\r\n          initialDefinition={tagDefinitions[tagToEdit] || ''}\r\n        />\r\n      )}\r\n\r\n      <TagCreateDialog\r\n        open={isCreateDialogOpen}\r\n        onClose={(created) => {\r\n          setIsCreateDialogOpen(false);\r\n          if (created) fetchTagDefinitions();\r\n        }}\r\n        calendarId={calendarId}\r\n        allTags={allTags}\r\n        onTagCreated={handleTagCreated}\r\n      />\r\n\r\n      {/* Tag View Dialog */}\r\n      <Dialog\r\n        open={!!tagToView}\r\n        onClose={() => setTagToView(null)}\r\n        maxWidth=\"sm\"\r\n        fullWidth\r\n      >\r\n        <DialogTitle sx={{\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'space-between',\r\n          pb: 1\r\n        }}>\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n            <TagIcon sx={{ color: 'primary.main' }} />\r\n            <Typography variant=\"h6\" component=\"span\">\r\n              Tag Details\r\n            </Typography>\r\n          </Box>\r\n          <IconButton\r\n            onClick={() => setTagToView(null)}\r\n            size=\"small\"\r\n            sx={{ color: 'text.secondary' }}\r\n          >\r\n            <CloseIcon />\r\n          </IconButton>\r\n        </DialogTitle>\r\n        <DialogContent dividers sx={{ ...scrollbarStyles(theme) }}>\r\n          {tagToView && (\r\n            <Box>\r\n              <Box sx={{ mb: 3 }}>\r\n                <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mb: 0.5, display: 'block' }}>\r\n                  Tag\r\n                </Typography>\r\n                <Chip\r\n                  label={formatTagForDisplay(tagToView, true)}\r\n                  sx={{\r\n                    ...getTagChipStyles(tagToView, theme),\r\n                    fontSize: '1rem',\r\n                    height: 36,\r\n                    '& .MuiChip-label': {\r\n                      px: 2\r\n                    }\r\n                  }}\r\n                />\r\n              </Box>\r\n              <Box>\r\n                <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mb: 1, display: 'block' }}>\r\n                  Definition\r\n                </Typography>\r\n                <Typography\r\n                  variant=\"body1\"\r\n                  sx={{\r\n                    whiteSpace: 'pre-wrap',\r\n                    color: tagDefinitions[tagToView] ? 'text.primary' : 'text.secondary',\r\n                    fontStyle: tagDefinitions[tagToView] ? 'normal' : 'italic'\r\n                  }}\r\n                >\r\n                  {tagDefinitions[tagToView] || 'No definition available for this tag.'}\r\n                </Typography>\r\n              </Box>\r\n            </Box>\r\n          )}\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={() => setTagToView(null)}>\r\n            Close\r\n          </Button>\r\n          {!isReadOnly && tagToView && (\r\n            <Button\r\n              variant=\"contained\"\r\n              onClick={() => {\r\n                setTagToEdit(tagToView);\r\n                setTagToView(null);\r\n              }}\r\n            >\r\n              Edit Tag\r\n            </Button>\r\n          )}\r\n        </DialogActions>\r\n      </Dialog>\r\n    </UnifiedDrawer>\r\n  );\r\n};\r\n\r\nexport default TagManagementDrawer;\r\n","import React from 'react';\r\nimport { Box, alpha, useTheme } from '@mui/material';\r\nimport Shimmer from './Shimmer';\r\n\r\ninterface TradeCardShimmerProps {\r\n  /** Number of shimmer cards to display */\r\n  count?: number;\r\n  /** Custom styling for the container */\r\n  containerSx?: object;\r\n}\r\n\r\n/**\r\n * Reusable shimmer loading component for trade cards.\r\n * Displays skeleton cards that match the TradeCard component layout.\r\n */\r\nconst TradeCardShimmer: React.FC<TradeCardShimmerProps> = ({\r\n  count = 3,\r\n  containerSx = {}\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  return (\r\n    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, ...containerSx }}>\r\n      {Array.from({ length: count }, (_, index) => (\r\n        <Box\r\n          key={index}\r\n          sx={{\r\n            p: 2,\r\n            borderRadius: 2,\r\n            bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n            border: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n          }}\r\n        >\r\n          {/* Header - Name and Amount */}\r\n          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', mb: 1 }}>\r\n            <Shimmer height={20} width=\"40%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n              <Shimmer height={16} width={16} borderRadius=\"50%\" variant=\"wave\" intensity=\"medium\" />\r\n              <Shimmer height={20} width={80} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Info Icons Row */}\r\n          <Box sx={{ display: 'flex', gap: 1, alignItems: 'center', mb: 1 }}>\r\n            <Shimmer height={14} width={14} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n            <Shimmer height={14} width={14} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n            <Shimmer height={12} width={80} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n            <Shimmer height={14} width={14} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n            <Shimmer height={12} width={60} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n          </Box>\r\n\r\n          {/* Tags Row */}\r\n          <Box sx={{ display: 'flex', gap: 0.5, flexWrap: 'wrap' }}>\r\n            <Shimmer height={20} width={80} borderRadius={10} variant=\"wave\" intensity=\"medium\" />\r\n            <Shimmer height={20} width={60} borderRadius={10} variant=\"wave\" intensity=\"medium\" />\r\n            <Shimmer height={20} width={70} borderRadius={10} variant=\"wave\" intensity=\"medium\" />\r\n          </Box>\r\n        </Box>\r\n      ))}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default TradeCardShimmer;\r\n","import React, { useState, useMemo, useCallback, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  useTheme,\r\n  TextField,\r\n  alpha,\r\n  Chip,\r\n  InputAdornment,\r\n  Autocomplete,\r\n  Button,\r\n  FormControl,\r\n  RadioGroup,\r\n  FormControlLabel,\r\n  Radio,\r\n  IconButton,\r\n  Pagination,\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogActions,\r\n  Badge,\r\n  Divider\r\n} from '@mui/material';\r\nimport {\r\n  Search as SearchIcon,\r\n  FilterAlt as FilterIcon,\r\n  DateRange as DateRangeIcon,\r\n  Close as CloseIcon\r\n} from '@mui/icons-material';\r\nimport { DatePicker } from '@mui/x-date-pickers';\r\nimport { Trade } from '../types/dualWrite';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups,\r\n  filterTagsByGroup\r\n} from '../utils/tagColors';\r\nimport { SelectInput } from './common';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport UnifiedDrawer from './common/UnifiedDrawer';\r\nimport TradeCard from './aiChat/TradeCard';\r\nimport TradeCardShimmer from './TradeCardShimmer';\r\nimport { getTradeRepository } from '../services/calendarService';\r\n\r\ninterface SearchDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  calendarId: string;\r\n  allTags: string[];\r\n  onTradeClick?: (trade: Trade) => void;\r\n  // Tag filtering props\r\n  selectedTags?: string[];\r\n  onTagsChange?: (tags: string[]) => void;\r\n}\r\n\r\n// Date filter types\r\ntype DateFilterType = 'all' | 'single' | 'range';\r\n\r\ninterface DateFilter {\r\n  type: DateFilterType;\r\n  startDate: Date | null;\r\n  endDate: Date | null;\r\n}\r\n\r\n// Pagination configuration\r\nconst ITEMS_PER_PAGE = 20;\r\n\r\nconst SearchDrawer: React.FC<SearchDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  calendarId,\r\n  allTags,\r\n  onTradeClick,\r\n  selectedTags = [],\r\n  onTagsChange\r\n}) => {\r\n  const theme = useTheme();\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n\r\n  // Pagination state\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n\r\n  // Server search state\r\n  const [searchResults, setSearchResults] = useState<Trade[]>([]);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n  const [totalCount, setTotalCount] = useState(0);\r\n  const [totalPages, setTotalPages] = useState(0);\r\n  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState('');\r\n\r\n  // Filter dialog state\r\n  const [isFilterDialogOpen, setIsFilterDialogOpen] = useState(false);\r\n  const [selectedTagGroup, setSelectedTagGroup] = useState<string>('');\r\n\r\n  // Date filtering state\r\n  const [dateFilter, setDateFilter] = useState<DateFilter>({\r\n    type: 'all',\r\n    startDate: null,\r\n    endDate: null\r\n  });\r\n\r\n  // Get all unique tag groups\r\n  const tagGroups = useMemo(() => {\r\n    return getUniqueTagGroups(allTags);\r\n  }, [allTags]);\r\n\r\n  // Filter tags by selected group\r\n  const filteredTagOptions = useMemo(() => {\r\n    if (!selectedTagGroup) return allTags;\r\n    return filterTagsByGroup(allTags, selectedTagGroup);\r\n  }, [allTags, selectedTagGroup]);\r\n\r\n  // Calculate active filter count\r\n  const activeFilterCount = useMemo(() => {\r\n    let count = 0;\r\n    if (selectedTags.length > 0) count++;\r\n    if (dateFilter.type !== 'all') count++;\r\n    return count;\r\n  }, [selectedTags, dateFilter]);\r\n\r\n  // Debounce search input (300ms)\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      setDebouncedSearchQuery(searchQuery);\r\n    }, 300);\r\n    return () => clearTimeout(timer);\r\n  }, [searchQuery]);\r\n\r\n  // Reset pagination when filters change\r\n  useEffect(() => {\r\n    setCurrentPage(1);\r\n  }, [debouncedSearchQuery, selectedTags, dateFilter]);\r\n\r\n  // Server-side search effect\r\n  useEffect(() => {\r\n    const performSearch = async () => {\r\n      // Only search if we have active filters\r\n      if (!debouncedSearchQuery.trim() && selectedTags.length === 0 && dateFilter.type === 'all') {\r\n        setSearchResults([]);\r\n        setTotalCount(0);\r\n        setTotalPages(0);\r\n        return;\r\n      }\r\n\r\n      setIsSearching(true);\r\n      try {\r\n        const result = await getTradeRepository().searchTrades(\r\n          calendarId,\r\n          {\r\n            searchQuery: debouncedSearchQuery.trim() || undefined,\r\n            selectedTags: selectedTags.length > 0 ? selectedTags : undefined,\r\n            dateFilter: dateFilter.type !== 'all' ? {\r\n              type: dateFilter.type,\r\n              startDate: dateFilter.startDate || undefined,\r\n              endDate: dateFilter.endDate || undefined\r\n            } : undefined,\r\n            page: currentPage,\r\n            pageSize: ITEMS_PER_PAGE\r\n          }\r\n        );\r\n\r\n        setSearchResults(result.trades);\r\n        setTotalCount(result.totalCount);\r\n        setTotalPages(result.totalPages);\r\n      } catch (error) {\r\n        console.error('Search failed:', error);\r\n        setSearchResults([]);\r\n        setTotalCount(0);\r\n        setTotalPages(0);\r\n      } finally {\r\n        setIsSearching(false);\r\n      }\r\n    };\r\n\r\n    performSearch();\r\n  }, [calendarId, debouncedSearchQuery, selectedTags, dateFilter, currentPage]);\r\n\r\n  // Tag filtering handlers (removed - using new handlers with pagination reset)\r\n\r\n  // Date filtering handlers\r\n  const handleDateFilterChange = useCallback((type: DateFilterType) => {\r\n    setDateFilter(prev => ({\r\n      ...prev,\r\n      type,\r\n      // Clear dates when switching to 'all'\r\n      startDate: type === 'all' ? null : prev.startDate,\r\n      endDate: type === 'all' ? null : prev.endDate\r\n    }));\r\n  }, []);\r\n\r\n  const handleStartDateChange = useCallback((date: Date | null) => {\r\n    setDateFilter(prev => ({\r\n      ...prev,\r\n      startDate: date\r\n    }));\r\n  }, []);\r\n\r\n  const handleEndDateChange = useCallback((date: Date | null) => {\r\n    setDateFilter(prev => ({\r\n      ...prev,\r\n      endDate: date\r\n    }));\r\n  }, []);\r\n\r\n  const handleClearDateFilter = useCallback(() => {\r\n    setDateFilter({\r\n      type: 'all',\r\n      startDate: null,\r\n      endDate: null\r\n    });\r\n  }, []);\r\n\r\n  const handleClearAllFilters = useCallback(() => {\r\n    onTagsChange?.([]);\r\n    setDateFilter({\r\n      type: 'all',\r\n      startDate: null,\r\n      endDate: null\r\n    });\r\n    setSelectedTagGroup('');\r\n  }, [onTagsChange]);\r\n\r\n  const handleTradeClick = useCallback((trade: Trade) => {\r\n    onTradeClick?.(trade);\r\n    onClose();\r\n  }, [onTradeClick, onClose]);\r\n\r\n  return (\r\n    <>\r\n    <UnifiedDrawer\r\n      open={open}\r\n      onClose={onClose}\r\n      title=\"Search & Filter Trades\"\r\n      subtitle=\"Find trades by tags, notes, or date ranges\"\r\n      icon={<SearchIcon />}\r\n      width={{ xs: '100%', sm: 450 }}\r\n      contentSx={{...scrollbarStyles(theme) }}\r\n      headerVariant=\"enhanced\"\r\n    >\r\n\r\n        {/* Search Input with Filter Button */}\r\n        <Box sx={{\r\n          p: 3,\r\n          borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          background: alpha(theme.palette.background.default, 0.3)\r\n        }}>\r\n          <Box sx={{ display: 'flex', gap: 1, alignItems: 'flex-start' }}>\r\n            <TextField\r\n              fullWidth\r\n              placeholder=\"Search by ID, name, tags, events, or session...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              slotProps={{\r\n                input: {\r\n                  startAdornment: (\r\n                    <InputAdornment position=\"start\">\r\n                      <SearchIcon sx={{ color: 'text.secondary' }} />\r\n                    </InputAdornment>\r\n                  )\r\n                }\r\n              }}\r\n              variant=\"outlined\"\r\n              size=\"medium\"\r\n              sx={{\r\n                '& .MuiOutlinedInput-root': {\r\n                  borderRadius: 2,\r\n                  backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n                  backdropFilter: 'blur(8px)',\r\n                  '&:hover': {\r\n                    backgroundColor: alpha(theme.palette.background.paper, 0.9)\r\n                  },\r\n                  '&.Mui-focused': {\r\n                    backgroundColor: alpha(theme.palette.background.paper, 1)\r\n                  }\r\n                }\r\n              }}\r\n            />\r\n            <Badge\r\n              badgeContent={activeFilterCount}\r\n              color=\"primary\"\r\n              sx={{\r\n                '& .MuiBadge-badge': {\r\n                  fontSize: '0.65rem',\r\n                  height: 18,\r\n                  minWidth: 18\r\n                }\r\n              }}\r\n            >\r\n              <IconButton\r\n                onClick={() => setIsFilterDialogOpen(true)}\r\n                size=\"large\"\r\n                sx={{\r\n                  bgcolor: activeFilterCount > 0\r\n                    ? alpha(theme.palette.primary.main, 0.15)\r\n                    : alpha(theme.palette.text.secondary, 0.15),\r\n                  borderRadius: 2,\r\n                  border: activeFilterCount > 0\r\n                    ? `1px solid ${alpha(theme.palette.primary.main, 0.3)}`\r\n                    : `1px solid ${alpha(theme.palette.divider, 0.3)}`,\r\n                  '&:hover': {\r\n                    bgcolor: activeFilterCount > 0\r\n                      ? alpha(theme.palette.primary.main, 0.25)\r\n                      : alpha(theme.palette.text.secondary, 0.25)\r\n                  }\r\n                }}\r\n              >\r\n                <FilterIcon sx={{\r\n                  color: activeFilterCount > 0 ? 'primary.main' : 'text.secondary'\r\n                }} />\r\n              </IconButton>\r\n            </Badge>\r\n          </Box>\r\n\r\n          <Typography variant=\"caption\" color=\"text.secondary\" sx={{\r\n            mt: 1.5,\r\n            display: 'block',\r\n            fontSize: '0.75rem',\r\n          }}>\r\n             Use multiple tags separated by spaces, commas, or semicolons to find trades with ALL specified tags\r\n          </Typography>\r\n\r\n          {/* Active Filters Display */}\r\n          {activeFilterCount > 0 && (\r\n            <Box sx={{ display: 'flex', gap: 0.5, mt: 1.5, flexWrap: 'wrap', alignItems: 'center' }}>\r\n              {selectedTags.length > 0 && (\r\n                <Chip\r\n                  label={`${selectedTags.length} tag${selectedTags.length > 1 ? 's' : ''}`}\r\n                  size=\"small\"\r\n                  color=\"primary\"\r\n                  variant=\"outlined\"\r\n                  onDelete={() => onTagsChange?.([])}\r\n                  sx={{ height: 24, fontSize: '0.75rem' }}\r\n                />\r\n              )}\r\n              {dateFilter.type !== 'all' && (\r\n                <Chip\r\n                  label={dateFilter.type === 'single' ? 'Date filter' : 'Date range'}\r\n                  size=\"small\"\r\n                  color=\"secondary\"\r\n                  variant=\"outlined\"\r\n                  onDelete={handleClearDateFilter}\r\n                  sx={{ height: 24, fontSize: '0.75rem' }}\r\n                />\r\n              )}\r\n              <Button\r\n                size=\"small\"\r\n                onClick={handleClearAllFilters}\r\n                sx={{\r\n                  fontSize: '0.7rem',\r\n                  py: 0,\r\n                  minHeight: 24,\r\n                  color: 'text.secondary'\r\n                }}\r\n              >\r\n                Clear all\r\n              </Button>\r\n            </Box>\r\n          )}\r\n        </Box>\r\n\r\n        {/* Content */}\r\n        <Box sx={{\r\n          flex: 1,\r\n          overflow: 'auto',\r\n          ...scrollbarStyles(theme)\r\n        }}>\r\n          {/* Search Results */}\r\n          {(searchQuery.trim() || selectedTags.length > 0 || dateFilter.type !== 'all') && (\r\n            <Box sx={{\r\n              flex: 1,\r\n              overflow: 'auto',\r\n              background: alpha(theme.palette.background.default, 0.2),\r\n              ...scrollbarStyles(theme)\r\n            }}>\r\n              <Box sx={{ p: 3 }}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1, flexWrap: 'wrap' }}>\r\n                <Typography variant=\"subtitle2\" sx={{ fontWeight: 600 }}>\r\n                  {searchQuery.trim() ? 'Search Results' : 'Filtered Results'} ({totalCount})\r\n                </Typography>\r\n\r\n                {selectedTags.length > 0 && (\r\n                  <Chip\r\n                    label={`${selectedTags.length} tag filter${selectedTags.length > 1 ? 's' : ''}`}\r\n                    size=\"small\"\r\n                    color=\"secondary\"\r\n                    variant=\"outlined\"\r\n                    sx={{ fontSize: '0.7rem', height: 20 }}\r\n                  />\r\n                )}\r\n                {dateFilter.type !== 'all' && (\r\n                  <Chip\r\n                    label={`${dateFilter.type === 'single' ? 'Single date' : 'Date range'} filter`}\r\n                    size=\"small\"\r\n                    color=\"info\"\r\n                    variant=\"outlined\"\r\n                    sx={{ fontSize: '0.7rem', height: 20 }}\r\n                  />\r\n                )}\r\n              </Box>\r\n\r\n              {/* Loading State */}\r\n              {isSearching ? (\r\n                <TradeCardShimmer count={6} />\r\n              ) : searchResults.length === 0 ? (\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  flexDirection: 'column',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  minHeight: 'calc(100vh - 400px)',\r\n                  textAlign: 'center'\r\n                }}>\r\n                  <SearchIcon sx={{ fontSize: 48, color: 'text.disabled', mb: 2 }} />\r\n                  <Typography variant=\"body1\" color=\"text.secondary\">\r\n                    No trades found\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Try searching with different keywords\r\n                  </Typography>\r\n                </Box>\r\n              ) : (\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  flexDirection: 'column',\r\n                  gap: 2,\r\n                  ...scrollbarStyles(theme)\r\n                }}>\r\n                  {searchResults.map((trade) => (\r\n                    <TradeCard\r\n                      key={trade.id}\r\n                      trade={trade}\r\n                      onClick={() => handleTradeClick(trade)}\r\n                      showTags={true}\r\n                      showImages={false}\r\n                    />\r\n                  ))}\r\n                </Box>\r\n              )}\r\n\r\n              {/* Pagination */}\r\n              {totalPages > 1 && searchResults.length > 0 && (\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  justifyContent: 'center',\r\n                  alignItems: 'center',\r\n                  py: 3,\r\n                  borderTop: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n                  gap: 2\r\n                }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Showing {((currentPage - 1) * ITEMS_PER_PAGE) + 1}-{Math.min(currentPage * ITEMS_PER_PAGE, totalCount)} of {totalCount} trades\r\n                  </Typography>\r\n                  <Pagination\r\n                    count={totalPages}\r\n                    page={currentPage}\r\n                    onChange={(_, page) => setCurrentPage(page)}\r\n                    color=\"primary\"\r\n                    size=\"small\"\r\n                    showFirstButton\r\n                    showLastButton\r\n                    sx={{\r\n                      '& .MuiPaginationItem-root': {\r\n                        borderRadius: 2\r\n                      }\r\n                    }}\r\n                  />\r\n                </Box>\r\n              )}\r\n              </Box>\r\n            </Box>\r\n          )}\r\n\r\n          {/* Empty State */}\r\n          {!searchQuery.trim() && selectedTags.length === 0 && dateFilter.type === 'all' && (\r\n            <Box sx={{ textAlign: 'center', py: 6, px: 3 }}>\r\n              <SearchIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\r\n              <Typography variant=\"h6\" sx={{ mb: 1, fontWeight: 600, color: 'text.secondary' }}>\r\n                Search Your Trades\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ textAlign: 'center', maxWidth: 400, mx: 'auto', mb: 2 }}>\r\n                Search by trade name, tags, notes, events or session. Use the filter button to narrow down results.\r\n              </Typography>\r\n\r\n            </Box>\r\n          )}\r\n        </Box>\r\n    </UnifiedDrawer>\r\n\r\n    {/* Filter Dialog */}\r\n    <Dialog\r\n      open={isFilterDialogOpen}\r\n      onClose={() => setIsFilterDialogOpen(false)}\r\n      maxWidth=\"xs\"\r\n      fullWidth\r\n      PaperProps={{\r\n        sx: {\r\n          borderRadius: 3,\r\n          maxHeight: '80vh'\r\n        }\r\n      }}\r\n    >\r\n      <DialogTitle sx={{ pb: 1 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n            <FilterIcon color=\"primary\" />\r\n            <Typography variant=\"h6\">Filters</Typography>\r\n          </Box>\r\n          <IconButton onClick={() => setIsFilterDialogOpen(false)} size=\"small\">\r\n            <CloseIcon />\r\n          </IconButton>\r\n        </Box>\r\n      </DialogTitle>\r\n\r\n      <DialogContent sx={{ pt: 2 }}>\r\n        {/* Tag Filter Section */}\r\n        {onTagsChange && (\r\n          <Box sx={{ mb: 3 }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>\r\n              <FilterIcon sx={{ fontSize: 20, color: 'text.secondary' }} />\r\n              <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                Filter by Tags\r\n              </Typography>\r\n              {selectedTags.length > 0 && (\r\n                <Chip\r\n                  label={selectedTags.length}\r\n                  size=\"small\"\r\n                  color=\"primary\"\r\n                  sx={{ height: 20, fontSize: '0.7rem' }}\r\n                />\r\n              )}\r\n            </Box>\r\n\r\n            {tagGroups.length > 0 && (\r\n              <SelectInput\r\n                label=\"Tag Group\"\r\n                value={selectedTagGroup}\r\n                onChange={(e) => setSelectedTagGroup(e.target.value as string)}\r\n                options={[\r\n                  { value: \"\", label: \"All Tags\" },\r\n                  ...tagGroups.map(group => ({ value: group, label: group }))\r\n                ]}\r\n                size=\"small\"\r\n                sx={{ mb: 2 }}\r\n              />\r\n            )}\r\n\r\n            <Autocomplete\r\n              multiple\r\n              options={filteredTagOptions}\r\n              value={selectedTags}\r\n              onChange={(_, newValue) => onTagsChange?.(newValue)}\r\n              slotProps={{\r\n                listbox: {\r\n                  sx: { ...scrollbarStyles(theme) }\r\n                }\r\n              }}\r\n              renderInput={(params) => (\r\n                <TextField\r\n                  {...params}\r\n                  variant=\"outlined\"\r\n                  label=\"Select Tags\"\r\n                  placeholder=\"Choose tags\"\r\n                  fullWidth\r\n                  size=\"small\"\r\n                />\r\n              )}\r\n              renderTags={(value, getTagProps) =>\r\n                value.map((option, index) => {\r\n                  const { key, ...chipProps } = getTagProps({ index });\r\n                  return (\r\n                    <Chip\r\n                      key={key}\r\n                      label={formatTagForDisplay(option, true)}\r\n                      {...chipProps}\r\n                      sx={getTagChipStyles(option, theme)}\r\n                      title={isGroupedTag(option) ? `Group: ${getTagGroup(option)}` : undefined}\r\n                    />\r\n                  );\r\n                })\r\n              }\r\n              renderOption={(props, option) => {\r\n                const { key, ...restProps } = props;\r\n                return (\r\n                  <li key={key} {...restProps}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      {isGroupedTag(option) && (\r\n                        <Chip\r\n                          label={getTagGroup(option)}\r\n                          size=\"small\"\r\n                          sx={{\r\n                            ...getTagChipStyles(option, theme),\r\n                            height: '18px',\r\n                            fontSize: '0.7rem'\r\n                          }}\r\n                        />\r\n                      )}\r\n                      {formatTagForDisplay(option, true)}\r\n                    </Box>\r\n                  </li>\r\n                );\r\n              }}\r\n            />\r\n          </Box>\r\n        )}\r\n\r\n        <Divider sx={{ my: 2 }} />\r\n\r\n        {/* Date Filter Section */}\r\n        <Box>\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>\r\n            <DateRangeIcon sx={{ fontSize: 20, color: 'text.secondary' }} />\r\n            <Typography variant=\"subtitle2\" fontWeight={600}>\r\n              Filter by Date\r\n            </Typography>\r\n            {dateFilter.type !== 'all' && (\r\n              <Chip\r\n                label={dateFilter.type === 'single' ? 'Single' : 'Range'}\r\n                size=\"small\"\r\n                color=\"secondary\"\r\n                sx={{ height: 20, fontSize: '0.7rem' }}\r\n              />\r\n            )}\r\n          </Box>\r\n\r\n          <FormControl component=\"fieldset\" sx={{ width: '100%', mb: 2 }}>\r\n            <RadioGroup\r\n              value={dateFilter.type}\r\n              onChange={(e) => handleDateFilterChange(e.target.value as DateFilterType)}\r\n              sx={{ gap: 0.5 }}\r\n            >\r\n              <FormControlLabel\r\n                value=\"all\"\r\n                control={<Radio size=\"small\" />}\r\n                label=\"All dates\"\r\n                sx={{ margin: 0 }}\r\n              />\r\n              <FormControlLabel\r\n                value=\"single\"\r\n                control={<Radio size=\"small\" />}\r\n                label=\"Specific date\"\r\n                sx={{ margin: 0 }}\r\n              />\r\n              <FormControlLabel\r\n                value=\"range\"\r\n                control={<Radio size=\"small\" />}\r\n                label=\"Date range\"\r\n                sx={{ margin: 0 }}\r\n              />\r\n            </RadioGroup>\r\n          </FormControl>\r\n\r\n          {dateFilter.type === 'single' && (\r\n            <DatePicker\r\n              label=\"Select Date\"\r\n              value={dateFilter.startDate}\r\n              onChange={handleStartDateChange}\r\n              slotProps={{\r\n                textField: {\r\n                  fullWidth: true,\r\n                  size: 'small'\r\n                }\r\n              }}\r\n            />\r\n          )}\r\n\r\n          {dateFilter.type === 'range' && (\r\n            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\r\n              <DatePicker\r\n                label=\"Start Date\"\r\n                value={dateFilter.startDate}\r\n                onChange={handleStartDateChange}\r\n                slotProps={{\r\n                  textField: {\r\n                    fullWidth: true,\r\n                    size: 'small'\r\n                  }\r\n                }}\r\n              />\r\n              <DatePicker\r\n                label=\"End Date\"\r\n                value={dateFilter.endDate}\r\n                onChange={handleEndDateChange}\r\n                minDate={dateFilter.startDate || undefined}\r\n                slotProps={{\r\n                  textField: {\r\n                    fullWidth: true,\r\n                    size: 'small'\r\n                  }\r\n                }}\r\n              />\r\n            </Box>\r\n          )}\r\n        </Box>\r\n      </DialogContent>\r\n\r\n      <DialogActions sx={{ px: 3, pb: 2 }}>\r\n        <Button\r\n          onClick={handleClearAllFilters}\r\n          color=\"inherit\"\r\n          disabled={activeFilterCount === 0}\r\n        >\r\n          Clear All\r\n        </Button>\r\n        <Button\r\n          onClick={() => setIsFilterDialogOpen(false)}\r\n          variant=\"contained\"\r\n          color=\"primary\"\r\n        >\r\n          Apply\r\n        </Button>\r\n      </DialogActions>\r\n    </Dialog>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default SearchDrawer;\r\n","import { Box } from '@mui/material';\r\nimport { styled } from '@mui/material/styles';\r\n\r\nexport const CalendarGrid = styled(Box)(({ theme }) => ({\r\n  display: 'grid',\r\n  gridTemplateColumns: 'repeat(7, 1fr)',\r\n  gap: theme.spacing(1),\r\n  padding: theme.spacing(2),\r\n  backgroundColor: theme.palette.background.paper,\r\n  borderRadius: theme.shape.borderRadius,\r\n  boxShadow: theme.shadows[1],\r\n  width: '100%',\r\n  minHeight: '600px',\r\n  alignContent: 'start'\r\n}));\r\n\r\nexport const CalendarCell = styled(Box)(({ theme }) => ({\r\n  aspectRatio: '1',\r\n\r\n  minHeight: '30px',\r\n  borderRadius: theme.shape.borderRadius,\r\n  overflow: 'hidden',\r\n  backgroundColor: theme.palette.background.default,\r\n  // Removed border to prevent double border with StyledCalendarDay\r\n  [theme.breakpoints.down('sm')]: {\r\n    aspectRatio: 'auto',\r\n    minHeight: '56px'\r\n  }\r\n}));\r\n\r\nexport const WeekdayHeader = styled(Box)(({ theme }) => ({\r\n  padding: theme.spacing(1),\r\n  textAlign: 'center',\r\n  color: theme.palette.text.secondary,\r\n  fontSize: '0.875rem',\r\n  fontWeight: 500,\r\n  border: `1px solid ${theme.palette.divider}`,\r\n  backgroundColor: theme.palette.background.default,\r\n  borderRadius: theme.shape.borderRadius,\r\n})); ","import { Trade } from '../types/dualWrite';\r\nimport { format, parse } from 'date-fns';\r\nimport * as XLSX from 'xlsx';\r\nimport { error, warn } from './logger';\r\nimport { formatTagsWithCapitalizedGroups } from './tagColors';\r\n\r\n// Helper function to prepare trade data for export\r\nconst prepareTradeDataForExport = (trades: Trade[], initial_balance: number = 0) => {\r\n  // Sort trades by date\r\n  const sortedTrades = [...trades].sort((a, b) => new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime());\r\n\r\n  // Calculate cumulative P&L and account balance\r\n  let cumulativePnL = 0;\r\n  let currentBalance = initial_balance;\r\n  const tradesWithBalances = sortedTrades.map(trade => {\r\n    cumulativePnL += trade.amount;\r\n    currentBalance += trade.amount;\r\n    return {\r\n      ...trade,\r\n      cumulativePnL,\r\n      accountBalance: currentBalance\r\n    };\r\n  });\r\n\r\n  // Transform trades into a format suitable for export\r\n  return tradesWithBalances.map(trade => ({\r\n    Date: format(new Date(trade.trade_date), 'MM/dd/yyyy'),\r\n    Name: trade.name ? trade.name : '',\r\n    Type: trade.trade_type.charAt(0).toUpperCase() + trade.trade_type.slice(1),\r\n    Amount: trade.amount,\r\n    'P&L': trade.amount > 0 ? `+${trade.amount.toFixed(2)}` : trade.amount.toFixed(2),\r\n    'Cumulative P&L': trade.cumulativePnL > 0 ? `+${trade.cumulativePnL.toFixed(2)}` : trade.cumulativePnL.toFixed(2),\r\n    'Account Balance': trade.accountBalance.toFixed(2),\r\n    'Entry Price': trade.entry_price || '',\r\n    'Exit Price': trade.exit_price || '',\r\n    Tags: trade.tags?.join(', ') || '',\r\n    'Risk to Reward': trade.risk_to_reward?.toFixed(2) || '',\r\n    Session: trade.session || '',\r\n    Notes: trade.notes || '',\r\n    Images: trade.images?.map(img => img.url).join(', ') || ''\r\n  }));\r\n};\r\n\r\n// Export trades to Excel format\r\nconst exportToExcel = (data: any[], fileName: string): void => {\r\n  // Create workbook and worksheet\r\n  const wb = XLSX.utils.book_new();\r\n  const ws = XLSX.utils.json_to_sheet(data);\r\n\r\n  // Set column widths\r\n  const colWidths = [\r\n    { wch: 12 }, // Date\r\n    { wch: 25 }, // Name\r\n    { wch: 8 },  // Type\r\n    { wch: 10 }, // Amount\r\n    { wch: 10 }, // P&L\r\n    { wch: 15 }, // Cumulative P&L\r\n    { wch: 15 }, // Account Balance\r\n    { wch: 15 }, // Entry Price\r\n    { wch: 15 }, // Exit Price\r\n    { wch: 30 }, // Tags\r\n    { wch: 12 }, // Risk to Reward\r\n    { wch: 12 }, // Session\r\n    { wch: 50 }, // Notes\r\n    { wch: 50 }  // Images\r\n  ];\r\n  ws['!cols'] = colWidths;\r\n\r\n  // Add the worksheet to the workbook\r\n  XLSX.utils.book_append_sheet(wb, ws, 'Trades');\r\n\r\n  // Generate Excel file\r\n  XLSX.writeFile(wb, fileName);\r\n};\r\n\r\n// Export trades to CSV format\r\nconst exportToCsv = (data: any[], fileName: string): void => {\r\n  // Convert data to CSV string\r\n  const headers = Object.keys(data[0]);\r\n  const csvRows = [];\r\n\r\n  // Add header row\r\n  csvRows.push(headers.join(','));\r\n\r\n  // Add data rows\r\n  for (const row of data) {\r\n    const values = headers.map(header => {\r\n      const value = row[header];\r\n      // Handle values that need to be quoted (contain commas, quotes, or newlines)\r\n      const escaped = String(value).replace(/\"/g, '\"\"');\r\n      if (escaped.includes(',') || escaped.includes('\"') || escaped.includes('\\n')) {\r\n        return `\"${escaped}\"`;\r\n      }\r\n      return value;\r\n    });\r\n    csvRows.push(values.join(','));\r\n  }\r\n\r\n  // Create CSV content\r\n  const csvContent = csvRows.join('\\n');\r\n\r\n  // Create a blob and download the file\r\n  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\r\n  const url = URL.createObjectURL(blob);\r\n  const link = document.createElement('a');\r\n  link.setAttribute('href', url);\r\n  link.setAttribute('download', fileName);\r\n  link.style.visibility = 'hidden';\r\n  document.body.appendChild(link);\r\n  link.click();\r\n  document.body.removeChild(link);\r\n};\r\n\r\n// Main export function that supports both Excel and CSV formats\r\nexport const exportTrades = (trades: Trade[], initial_balance: number = 0, fileFormat: 'xlsx' | 'csv' = 'xlsx'): void => {\r\n  if (trades.length === 0) return;\r\n\r\n  // Prepare data for export\r\n  const exportData = prepareTradeDataForExport(trades, initial_balance);\r\n\r\n  // Generate file name with current date\r\n  const dateStr = format(new Date(), 'yyyy-MM-dd');\r\n  const fileName = `trades_${dateStr}.${fileFormat}`;\r\n\r\n  // Export in the requested format\r\n  if (fileFormat === 'xlsx') {\r\n    exportToExcel(exportData, fileName);\r\n  } else {\r\n    exportToCsv(exportData, fileName);\r\n  }\r\n};\r\n\r\n// Import trades from Excel format\r\nconst importFromExcel = async (data: ArrayBuffer): Promise<Trade[]> => {\r\n  try {\r\n    const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });\r\n\r\n    // Check if the workbook has any sheets\r\n    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {\r\n      throw new Error('Excel file does not contain any sheets');\r\n    }\r\n\r\n    const worksheet = workbook.Sheets[workbook.SheetNames[0]];\r\n\r\n    // Check if the worksheet exists\r\n    if (!worksheet) {\r\n      throw new Error('Excel sheet is empty or invalid');\r\n    }\r\n\r\n    const jsonData = XLSX.utils.sheet_to_json(worksheet);\r\n\r\n    // Check if we have any data\r\n    if (!jsonData || jsonData.length === 0) {\r\n      throw new Error('No data found in the Excel file');\r\n    }\r\n\r\n    // Check if we have the required Date column\r\n    const firstRow = jsonData[0] as any;\r\n    if (!firstRow.Date) {\r\n      throw new Error('Excel file must contain a \"Date\" column');\r\n    }\r\n\r\n    try {\r\n      return parseTradeData(jsonData);\r\n    } catch (parseError) {\r\n      error('Trade data parsing error:', parseError);\r\n      // Provide more specific error messages for common issues\r\n      if (parseError instanceof Error) {\r\n        if (parseError.message.includes('Invalid time value')) {\r\n          throw new Error('Could not parse one or more dates in the Excel file. Please ensure dates are in a standard format like \"MM/DD/YYYY\" or \"Month Day, Year\".');\r\n        }\r\n        throw parseError;\r\n      }\r\n      throw new Error('Failed to parse trade data from Excel file.');\r\n    }\r\n  } catch (err) {\r\n    error('Excel parsing error:', err);\r\n    throw err; // Re-throw to be handled by the caller\r\n  }\r\n};\r\n\r\n// Import trades from CSV format\r\nconst importFromCsv = async (data: string): Promise<Trade[]> => {\r\n  try {\r\n    // Parse CSV string to JSON\r\n    const rows = data.split('\\n');\r\n\r\n    // Check if we have at least a header row\r\n    if (rows.length === 0) {\r\n      throw new Error('CSV file is empty');\r\n    }\r\n\r\n    // Parse headers\r\n    const headers = rows[0].split(',').map(header => {\r\n      // Remove quotes if present\r\n      return header.replace(/^\"|\"$/g, '').trim();\r\n    });\r\n\r\n    // Check if we have the required Date header\r\n    if (!headers.includes('Date')) {\r\n      throw new Error('CSV file must contain a \"Date\" column');\r\n    }\r\n\r\n    const jsonData = [];\r\n\r\n    for (let i = 1; i < rows.length; i++) {\r\n      if (!rows[i].trim()) continue; // Skip empty rows\r\n\r\n      // Handle quoted values with commas inside\r\n      const values = [];\r\n      let inQuotes = false;\r\n      let currentValue = '';\r\n\r\n      try {\r\n        for (let j = 0; j < rows[i].length; j++) {\r\n          const char = rows[i][j];\r\n\r\n          if (char === '\"') {\r\n            inQuotes = !inQuotes;\r\n          } else if (char === ',' && !inQuotes) {\r\n            values.push(currentValue);\r\n            currentValue = '';\r\n          } else {\r\n            currentValue += char;\r\n          }\r\n        }\r\n\r\n        // Add the last value\r\n        values.push(currentValue);\r\n\r\n        // Create object from headers and values\r\n        const obj: any = {};\r\n        for (let j = 0; j < headers.length; j++) {\r\n          if (j < values.length) {\r\n            // Remove quotes if present\r\n            obj[headers[j]] = values[j].replace(/^\"|\"$/g, '').trim();\r\n          }\r\n        }\r\n\r\n        // Only add rows that have a Date value\r\n        if (obj.Date) {\r\n          jsonData.push(obj);\r\n        }\r\n      } catch (err) {\r\n        warn(`Skipping row ${i} due to parsing error:`, err);\r\n        // Continue with the next row\r\n      }\r\n    }\r\n\r\n    if (jsonData.length === 0) {\r\n      throw new Error('No valid data rows found in the CSV file');\r\n    }\r\n\r\n    try {\r\n      return parseTradeData(jsonData);\r\n    } catch (parseError) {\r\n      error('Trade data parsing error:', parseError);\r\n      // Provide more specific error messages for common issues\r\n      if (parseError instanceof Error) {\r\n        if (parseError.message.includes('Invalid time value')) {\r\n          throw new Error('Could not parse one or more dates in the CSV file. Please ensure dates are in a standard format like \"MM/DD/YYYY\" or \"Month Day, Year\".');\r\n        }\r\n        throw parseError;\r\n      }\r\n      throw new Error('Failed to parse trade data from CSV file.');\r\n    }\r\n  } catch (err) {\r\n    error('CSV parsing error:', err);\r\n    throw err; // Re-throw to be handled by the caller\r\n  }\r\n};\r\n\r\n// Known trade properties that should not be converted to tags\r\nconst knownTradeProperties = [\r\n  'id', 'date', 'Date', 'amount', 'Amount', 'P&L', 'type', 'Type', 'name', 'Name',\r\n  'entry', 'Entry Price', 'exit', 'Exit Price', 'tags', 'Tags', 'riskToReward', 'Risk to Reward',\r\n  'partialsTaken', 'Partials Taken', 'session', 'Session', 'notes', 'Notes',\r\n  'images', 'Images', 'Cumulative P&L', 'Account Balance'\r\n];\r\n\r\n// Common date formats to try when parsing\r\nconst DATE_FORMATS = [\r\n  'MM/dd/yyyy',    // 01/31/2023\r\n  'M/d/yyyy',      // 1/31/2023\r\n  'yyyy-MM-dd',    // 2023-01-31\r\n  'yyyy/MM/dd',    // 2023/01/31\r\n  'dd/MM/yyyy',    // 31/01/2023\r\n  'dd-MM-yyyy',    // 31-01-2023\r\n  'MM-dd-yyyy',    // 01-31-2023\r\n  'M-d-yyyy',      // 1-31-2023\r\n  'MMMM d, yyyy',  // March 7, 2025\r\n  'MMM d, yyyy',   // Mar 7, 2025\r\n  'MMMM dd, yyyy', // March 07, 2025\r\n  'MMM dd, yyyy'   // Mar 07, 2025\r\n];\r\n\r\n// Parse a date string using multiple formats\r\nconst parseDate = (dateStr: string): Date => {\r\n  // Normalize the date string to handle potential inconsistencies\r\n  const normalizedDateStr = dateStr.trim();\r\n\r\n  // Try to parse with each format\r\n  for (const format of DATE_FORMATS) {\r\n    try {\r\n      const parsedDate = parse(normalizedDateStr, format, new Date());\r\n      // Check if the date is valid (not Invalid Date)\r\n      if (!isNaN(parsedDate.getTime())) {\r\n        return parsedDate;\r\n      }\r\n    } catch (error) {\r\n      // Continue to the next format if this one fails\r\n    }\r\n  }\r\n\r\n  // Special handling for month name formats (e.g., \"March 7, 2025\")\r\n  const monthNameRegex = /(January|February|March|April|May|June|July|August|September|October|November|December)\\s+(\\d{1,2})(?:st|nd|rd|th)?(?:,)?\\s+(\\d{4})/i;\r\n  const monthNameMatch = normalizedDateStr.match(monthNameRegex);\r\n\r\n  if (monthNameMatch) {\r\n    const [, month, day, year] = monthNameMatch;\r\n    const monthIndex = [\r\n      'january', 'february', 'march', 'april', 'may', 'june',\r\n      'july', 'august', 'september', 'october', 'november', 'december'\r\n    ].indexOf(month.toLowerCase());\r\n\r\n    if (monthIndex !== -1) {\r\n      const date = new Date(parseInt(year), monthIndex, parseInt(day));\r\n      if (!isNaN(date.getTime())) {\r\n        return date;\r\n      }\r\n    }\r\n  }\r\n\r\n  // If all formats fail, try to create a date directly\r\n  const directDate = new Date(normalizedDateStr);\r\n  if (!isNaN(directDate.getTime())) {\r\n    return directDate;\r\n  }\r\n\r\n  // If all attempts fail, use the current date and log a warning\r\n  warn(`Could not parse date: ${normalizedDateStr}. Using current date instead.`);\r\n  return new Date();\r\n};\r\n\r\n// Parse trade data from JSON format\r\nconst parseTradeData = (jsonData: any[]): Trade[] => {\r\n  return jsonData.map((row: any) => {\r\n    // Parse date from various possible formats\r\n    const date = row.Date ? parseDate(row.Date) : new Date();\r\n\r\n    // Handle both the Amount and P&L columns\r\n    let amount = 0;\r\n    try {\r\n      amount = row.Amount !== undefined ?\r\n        (typeof row.Amount === 'string' ? parseFloat(row.Amount) : row.Amount) :\r\n        parseFloat(row['P&L'] || '0');\r\n    } catch (err) {\r\n      warn(`Could not parse amount: ${row.Amount || row['P&L']}. Using 0 instead.`);\r\n    }\r\n\r\n    // Parse tags from the Tags column\r\n    let tags = row.Tags ? row.Tags.split(',').map((tag: string) => tag.trim()).filter(Boolean) : [];\r\n\r\n    // Process unknown headers as tag categories\r\n    for (const header in row) {\r\n      // Skip known properties and empty values\r\n      if (knownTradeProperties.includes(header) || !row[header] || row[header] === '') {\r\n        continue;\r\n      }\r\n\r\n      // Convert the header to a tag category\r\n      const categoryName = header.trim();\r\n      const values = String(row[header]).split(',');\r\n\r\n      // Add each value as a tag in the format \"Category:Value\"\r\n      for (const value of values) {\r\n        const trimmedValue = value.trim();\r\n        if (trimmedValue) {\r\n          tags.push(`${categoryName}:${trimmedValue}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Capitalize tag groups\r\n    tags = formatTagsWithCapitalizedGroups(tags);\r\n\r\n    // Determine the trade type based on amount or Type column\r\n    let tradeType: 'win' | 'loss' | 'breakeven';\r\n    if (row.Type && typeof row.Type === 'string') {\r\n      const typeStr = row.Type.toLowerCase();\r\n      if (typeStr === 'win' || typeStr === 'loss' || typeStr === 'breakeven') {\r\n        tradeType = typeStr as 'win' | 'loss' | 'breakeven';\r\n      } else {\r\n        // Fallback to amount-based type\r\n        tradeType = amount > 0 ? 'win' : amount < 0 ? 'loss' : 'breakeven';\r\n      }\r\n    } else {\r\n      // Determine type based on amount\r\n      tradeType = amount > 0 ? 'win' : amount < 0 ? 'loss' : 'breakeven';\r\n    }\r\n\r\n    return {\r\n      id: crypto.randomUUID(),\r\n      date,\r\n      type: tradeType,\r\n      amount: amount,\r\n      ...(row.Name && { name: row.Name }),\r\n      ...(row['Entry Price'] && { entry: row['Entry Price'] }),\r\n      ...(row['Exit Price'] && { exit: row['Exit Price'] }),\r\n\r\n      ...(tags.length > 0 && { tags }),\r\n      ...(row['Risk to Reward'] && { riskToReward: parseFloat(row['Risk to Reward']) }),\r\n      ...(row.Session && { session: row.Session }),\r\n      ...(row.Notes && { notes: row.Notes })\r\n    };\r\n  });\r\n};\r\n\r\n// Main import function that supports both Excel and CSV formats\r\nexport const importTrades = async (file: File): Promise<Trade[]> => {\r\n  return new Promise((resolve, reject) => {\r\n    const reader = new FileReader();\r\n    const fileType = file.name.split('.').pop()?.toLowerCase();\r\n\r\n    reader.onload = async (e) => {\r\n      try {\r\n        let trades: Trade[] = [];\r\n\r\n        // Handle different file types\r\n        if (fileType === 'csv') {\r\n          // CSV import\r\n          const csvContent = e.target?.result as string;\r\n          trades = await importFromCsv(csvContent);\r\n        } else {\r\n          // Excel import\r\n          const data = e.target?.result as ArrayBuffer;\r\n          trades = await importFromExcel(data);\r\n        }\r\n\r\n        resolve(trades);\r\n      } catch (err) {\r\n        error('Import error:', err);\r\n        let errorMessage = 'Failed to parse import file. ';\r\n\r\n        if (err instanceof Error) {\r\n          if (err.message.includes('Invalid time value')) {\r\n            errorMessage += 'There was an issue with a date format in your file. Please ensure all dates are in a standard format like MM/DD/YYYY.';\r\n          } else if (err.message.includes('is not a function')) {\r\n            errorMessage += 'There was an issue with the file structure. Please ensure the file has proper headers and data.';\r\n          } else {\r\n            errorMessage += err.message;\r\n          }\r\n        } else {\r\n          errorMessage += 'Please ensure the file format is correct.';\r\n        }\r\n\r\n        reject(new Error(errorMessage));\r\n      }\r\n    };\r\n\r\n    reader.onerror = () => {\r\n      reject(new Error('Failed to read import file.'));\r\n    };\r\n\r\n    // Read file based on type\r\n    if (fileType === 'csv') {\r\n      reader.readAsText(file);\r\n    } else {\r\n      reader.readAsArrayBuffer(file);\r\n    }\r\n  });\r\n};","import { Trade } from '../types/dualWrite';\r\nimport { isAfter, isBefore, isSameDay, isSameMonth, isSameWeek, isSameYear, startOfDay } from 'date-fns';\r\nimport { calculateEffectiveMaxDailyDrawdown, calculatePercentageOfValueAtDate, DynamicRiskSettings } from './dynamicRiskUtils';\r\nimport { \r\n  DayStatus\r\n} from '../components/StyledComponents'; \r\n\r\n/**\r\n * Calculate total PnL for a set of trades\r\n * @param trades Array of trades\r\n * @returns Total PnL\r\n */\r\nexport const calculateTotalPnL = (trades: Trade[]): number => {\r\n  return trades.reduce((sum, trade) => sum + trade.amount, 0);\r\n};\r\n\r\n/**\r\n * Calculate win rate for a set of trades\r\n * @param trades Array of trades\r\n * @returns Win rate percentage (excludes breakeven trades from calculation)\r\n */\r\nexport const calculateWinRate = (trades: Trade[]): number => {\r\n  if (trades.length === 0) return 0;\r\n\r\n  const winCount = trades.filter(trade => trade.trade_type === 'win').length;\r\n  const lossCount = trades.filter(trade => trade.trade_type === 'loss').length;\r\n  const totalWinLossTrades = winCount + lossCount;\r\n\r\n  // If no wins or losses, return 0\r\n  if (totalWinLossTrades === 0) return 0;\r\n\r\n  return (winCount / totalWinLossTrades) * 100;\r\n};\r\n\r\n/**\r\n * Calculate profit factor for a set of trades\r\n * @param trades Array of trades\r\n * @returns Profit factor (gross profit / gross loss)\r\n */\r\nexport const calculateProfitFactor = (trades: Trade[]): number => {\r\n  const grossProfit = trades\r\n    .filter(trade => trade.amount > 0)\r\n    .reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n  const grossLoss = Math.abs(trades\r\n    .filter(trade => trade.amount < 0 || trade.trade_type === 'loss')\r\n    .reduce((sum, trade) => sum + trade.amount, 0));\r\n     \r\n  // If no losses, return a high but reasonable number instead of 999\r\n  // This represents an excellent profit factor without looking like an error\r\n  if (grossLoss === 0) return grossProfit > 0 ? 50.0 : 0;\r\n  return grossProfit / grossLoss;\r\n};\r\n\r\n/**\r\n * Calculate maximum drawdown for a set of trades\r\n * @param trades Array of trades\r\n * @returns Maximum drawdown percentage\r\n */\r\nexport const calculateMaxDrawdown = (trades: Trade[]): {\r\n  max_drawdown: number;\r\n  drawdown_start_date?: Date;\r\n  drawdown_end_date?: Date;\r\n  drawdown_recovery_needed: number;\r\n  drawdown_duration: number;\r\n} => {\r\n  if (trades.length === 0) {\r\n    return {\r\n      max_drawdown: 0,\r\n      drawdown_recovery_needed: 0,\r\n      drawdown_duration: 0\r\n    };\r\n  }\r\n\r\n  // Sort trades by date\r\n  const sortedTrades = [...trades].sort((a, b) =>\r\n    new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime()\r\n  );\r\n\r\n  let balance = 0;\r\n  let peak = 0;\r\n  let maxDrawdown = 0;\r\n  let drawdown_start_date: Date | undefined;\r\n  let drawdown_end_date: Date | undefined;\r\n  let currentDrawdownStartDate: Date | undefined;\r\n  let drawdownDuration = 0;\r\n\r\n  sortedTrades.forEach(trade => {\r\n    balance += trade.amount;\r\n\r\n    if (balance > peak) {\r\n      peak = balance;\r\n      currentDrawdownStartDate = undefined;\r\n    } else if (peak > 0) {\r\n      const drawdown = (peak - balance) / peak * 100;\r\n\r\n      if (drawdown > maxDrawdown) {\r\n        maxDrawdown = drawdown;\r\n        drawdown_start_date = currentDrawdownStartDate || trade.trade_date;\r\n        drawdown_end_date = trade.trade_date;\r\n\r\n        // Calculate drawdown duration (number of trades)\r\n        if (drawdown_start_date && drawdown_end_date) {\r\n          const startIndex = sortedTrades.findIndex(t => t.trade_date === drawdown_start_date);\r\n          const endIndex = sortedTrades.findIndex(t => t.trade_date === drawdown_end_date);\r\n          if (startIndex !== -1 && endIndex !== -1) {\r\n            drawdownDuration = endIndex - startIndex + 1;\r\n          } else {\r\n            // Fallback if dates can't be found\r\n            drawdownDuration = 1;\r\n          }\r\n        } else {\r\n          drawdownDuration = 1;\r\n        }\r\n      }\r\n\r\n      if (!currentDrawdownStartDate) {\r\n        currentDrawdownStartDate = trade.trade_date;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Calculate recovery needed\r\n  const drawdownRecoveryNeeded = maxDrawdown > 0\r\n    ? (maxDrawdown / (100 - maxDrawdown)) * 100\r\n    : 0;\r\n\r\n  return {\r\n    max_drawdown: maxDrawdown,\r\n    drawdown_start_date,\r\n    drawdown_end_date,\r\n    drawdown_recovery_needed: drawdownRecoveryNeeded,\r\n    drawdown_duration: drawdownDuration\r\n  };\r\n};\r\n\r\n\r\n/**\r\n * Calculate target progress for a set of trades\r\n * @param trades Array of trades\r\n * @param accountBalance Initial account balance\r\n * @param target Target percentage\r\n * @param startDate Optional start date to calculate account value at start of period\r\n * @param allTrades Optional all trades array for calculating account value at start date\r\n * @returns Target progress percentage (capped at 100%)\r\n */\r\nexport const calculateTargetProgress = (\r\n  trades: Trade[],\r\n  accountBalance: number,\r\n  target: number,\r\n  startDate?: Date,\r\n  allTrades?: Trade[]\r\n): number => {\r\n  if (!target || target <= 0 || !accountBalance) return 0;\r\n\r\n  const totalPnL = calculateTotalPnL(trades);\r\n\r\n  // Calculate account value at start of period if startDate and allTrades are provided\r\n  let baselineAccountValue = accountBalance;\r\n  if (startDate && allTrades) {\r\n    const tradesBeforePeriod = allTrades.filter(trade => new Date(trade.trade_date) < startDate);\r\n    baselineAccountValue = accountBalance + tradesBeforePeriod.reduce((sum, trade) => sum + trade.amount, 0);\r\n  }\r\n\r\n  if (baselineAccountValue <= 0) return 0;\r\n\r\n  const targetAmount = (target / 100) * baselineAccountValue;\r\n\r\n  // Cap progress at 100% to prevent overflow in UI components\r\n  return Math.min(Math.max((totalPnL / targetAmount) * 100, 0), 100);\r\n};\r\n\r\n/**\r\n * Filter trades by date range\r\n * @param trades Array of trades\r\n * @param startDate Start date\r\n * @param endDate End date\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByDateRange = (\r\n  trades: Trade[],\r\n  startDate: Date,\r\n  endDate: Date\r\n): Trade[] => {\r\n  return trades.filter(trade => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    return (\r\n      !isBefore(tradeDate, startOfDay(startDate)) &&\r\n      !isAfter(tradeDate, startOfDay(endDate))\r\n    );\r\n  });\r\n};\r\n\r\n/**\r\n * Filter trades by week\r\n * @param trades Array of trades\r\n * @param date Date within the week\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByWeek = (\r\n  trades: Trade[],\r\n  date: Date\r\n): Trade[] => {\r\n  return trades.filter(trade => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    return isSameWeek(tradeDate, date, { weekStartsOn: 1 });\r\n  });\r\n};\r\n\r\n/**\r\n * Filter trades by month\r\n * @param trades Array of trades\r\n * @param date Date within the month\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByMonth = (\r\n  trades: Trade[],\r\n  date: Date\r\n): Trade[] => {\r\n  return trades.filter(trade => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    return isSameMonth(tradeDate, date) && isSameYear(tradeDate, date);\r\n  });\r\n};\r\n\r\n/**\r\n * Filter trades by year\r\n * @param trades Array of trades\r\n * @param date Date within the year\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByYear = (\r\n  trades: Trade[],\r\n  date: Date\r\n): Trade[] => {\r\n  return trades.filter(trade => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    return isSameYear(tradeDate, date);\r\n  });\r\n};\r\n\r\n/**\r\n * Filter trades by day\r\n * @param trades Array of trades\r\n * @param date Date\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByDay = (\r\n  trades: Trade[],\r\n  date: Date\r\n): Trade[] => {\r\n  return trades.filter(trade => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    return isSameDay(tradeDate, date);\r\n  });\r\n};\r\n\r\n/**\r\n * Filter trades by tags\r\n * @param trades Array of trades\r\n * @param tags Array of tags to filter by\r\n * @returns Filtered trades\r\n */\r\nexport const filterTradesByTags = (\r\n  trades: Trade[],\r\n  tags: string[]\r\n): Trade[] => {\r\n  if (!tags.length) return trades;\r\n\r\n  return trades.filter(trade => {\r\n    if (!trade.tags || !trade.tags.length) return false;\r\n    return tags.some(tag => trade.tags?.includes(tag));\r\n  });\r\n};\r\n\r\n/**\r\n * Calculate average win and loss amounts\r\n * @param trades Array of trades\r\n * @returns Object with average win and loss\r\n */\r\nexport const calculateAverages = (trades: Trade[]): {\r\n  avg_win: number;\r\n  avg_loss: number;\r\n} => {\r\n  const winTrades = trades.filter(trade => trade.trade_type === 'win');\r\n  const lossTrades = trades.filter(trade => trade.trade_type === 'loss');\r\n\r\n  const avgWin = winTrades.length\r\n    ? winTrades.reduce((sum, trade) => sum + trade.amount, 0) / winTrades.length\r\n    : 0;\r\n\r\n  const avgLoss = lossTrades.length\r\n    ? Math.abs(lossTrades.reduce((sum, trade) => sum + trade.amount, 0)) / lossTrades.length\r\n    : 0;\r\n\r\n  return { avg_win: avgWin, avg_loss: avgLoss };\r\n};\r\n\r\n\r\ninterface DayStats {\r\n  netAmount: number;\r\n  status: DayStatus;\r\n  percentage: string;\r\n  isDrawdownViolation: boolean;\r\n}\r\n\r\nexport const calculateDayStats = (\r\n  dayTrades: Trade[],\r\n  accountBalance: number,\r\n  maxDailyDrawdown: number,\r\n  dynamicRiskSettings?: DynamicRiskSettings,\r\n  allTrades?: Trade[],\r\n  dayDate?: Date\r\n): DayStats => {\r\n  // Calculate net amount for the day\r\n  const netAmount = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n  // Calculate percentage loss/gain relative to account value at start of day (excluding current day trades)\r\n  const percentage = allTrades && dayDate\r\n    ? calculatePercentageOfValueAtDate(netAmount, accountBalance, allTrades, startOfDay(dayDate)).toFixed(1)\r\n    : accountBalance > 0 ? ((netAmount / accountBalance) * 100).toFixed(1) : '0';\r\n\r\n  let status: DayStatus = 'neutral';\r\n  if (dayTrades.length > 0) {\r\n    status = netAmount > 0 ? 'win' : netAmount < 0 ? 'loss' : dayTrades.find(trade => trade.trade_type === 'breakeven') ? 'breakeven' : 'neutral';\r\n  }\r\n\r\n  // Calculate effective max daily drawdown based on dynamic risk settings\r\n  let effectiveMaxDailyDrawdown = maxDailyDrawdown;\r\n \r\n  if (dynamicRiskSettings && allTrades) {\r\n    effectiveMaxDailyDrawdown = calculateEffectiveMaxDailyDrawdown(\r\n      maxDailyDrawdown,\r\n      allTrades,\r\n      dynamicRiskSettings\r\n    );\r\n  }\r\n\r\n  // Check for drawdown violation - if the loss percentage exceeds effectiveMaxDailyDrawdown\r\n  const percentageValue = parseFloat(percentage);\r\n  const isDrawdownViolation = status === 'loss' && Math.abs(percentageValue) > effectiveMaxDailyDrawdown;\r\n\r\n  return { netAmount, status, percentage, isDrawdownViolation };\r\n};\r\n\r\n ","/**\r\n * Type Conversion Utilities\r\n * Handles converting values from file formats to Trade field types\r\n */\r\n\r\nimport { parse } from 'date-fns';\r\nimport { FieldType } from '../types/import';\r\nimport { warn } from './logger';\r\n\r\n/**\r\n * Common date formats to try when parsing\r\n */\r\nconst DATE_FORMATS = [\r\n  'MM/dd/yyyy',    // 01/31/2023\r\n  'M/d/yyyy',      // 1/31/2023\r\n  'yyyy-MM-dd',    // 2023-01-31\r\n  'yyyy/MM/dd',    // 2023/01/31\r\n  'dd/MM/yyyy',    // 31/01/2023\r\n  'dd-MM-yyyy',    // 31-01-2023\r\n  'MM-dd-yyyy',    // 01-31-2023\r\n  'M-d-yyyy',      // 1-31-2023\r\n  'MMMM d, yyyy',  // March 7, 2025\r\n  'MMM d, yyyy',   // Mar 7, 2025\r\n  'MMMM dd, yyyy', // March 07, 2025\r\n  'MMM dd, yyyy'   // Mar 07, 2025\r\n];\r\n\r\n/**\r\n * Result of a type conversion attempt\r\n */\r\nexport interface ConversionResult<T = any> {\r\n  success: boolean;\r\n  value?: T;\r\n  error?: string;\r\n  originalValue: any;\r\n}\r\n\r\n/**\r\n * Parse a flexible date string using multiple formats\r\n */\r\nexport function parseFlexibleDate(value: any): ConversionResult<Date> {\r\n  const originalValue = value;\r\n\r\n  // If already a Date object\r\n  if (value instanceof Date) {\r\n    return { success: true, value, originalValue };\r\n  }\r\n\r\n  // If null or undefined\r\n  if (value === null || value === undefined || value === '') {\r\n    return { success: false, error: 'Empty or null date', originalValue };\r\n  }\r\n\r\n  // Convert to string and normalize\r\n  const dateStr = String(value).trim();\r\n\r\n  // Try to parse with each format\r\n  for (const format of DATE_FORMATS) {\r\n    try {\r\n      const parsedDate = parse(dateStr, format, new Date());\r\n      // Check if the date is valid (not Invalid Date)\r\n      if (!isNaN(parsedDate.getTime())) {\r\n        return { success: true, value: parsedDate, originalValue };\r\n      }\r\n    } catch (error) {\r\n      // Continue to the next format\r\n    }\r\n  }\r\n\r\n  // Special handling for month name formats (e.g., \"March 7, 2025\")\r\n  const monthNameRegex = /(January|February|March|April|May|June|July|August|September|October|November|December)\\s+(\\d{1,2})(?:st|nd|rd|th)?(?:,)?\\s+(\\d{4})/i;\r\n  const monthNameMatch = dateStr.match(monthNameRegex);\r\n\r\n  if (monthNameMatch) {\r\n    const [, month, day, year] = monthNameMatch;\r\n    const monthIndex = [\r\n      'january', 'february', 'march', 'april', 'may', 'june',\r\n      'july', 'august', 'september', 'october', 'november', 'december'\r\n    ].indexOf(month.toLowerCase());\r\n\r\n    if (monthIndex !== -1) {\r\n      const date = new Date(parseInt(year), monthIndex, parseInt(day));\r\n      if (!isNaN(date.getTime())) {\r\n        return { success: true, value: date, originalValue };\r\n      }\r\n    }\r\n  }\r\n\r\n  // Try direct Date constructor as last resort\r\n  const directDate = new Date(dateStr);\r\n  if (!isNaN(directDate.getTime())) {\r\n    return { success: true, value: directDate, originalValue };\r\n  }\r\n\r\n  return {\r\n    success: false,\r\n    error: `Could not parse date: \"${dateStr}\"`,\r\n    originalValue\r\n  };\r\n}\r\n\r\n/**\r\n * Parse a flexible number from various formats\r\n * Handles: $1,234.56, 1.234,56 (EU), (100), -100, +100\r\n */\r\nexport function parseFlexibleNumber(value: any, format: 'us' | 'eu' = 'us'): ConversionResult<number> {\r\n  const originalValue = value;\r\n\r\n  // If already a number\r\n  if (typeof value === 'number') {\r\n    return { success: true, value, originalValue };\r\n  }\r\n\r\n  // If null or undefined\r\n  if (value === null || value === undefined || value === '') {\r\n    return { success: false, error: 'Empty or null number', originalValue };\r\n  }\r\n\r\n  // Convert to string and normalize\r\n  let numStr = String(value).trim();\r\n\r\n  // Handle empty strings after trim\r\n  if (numStr === '') {\r\n    return { success: false, error: 'Empty string', originalValue };\r\n  }\r\n\r\n  // Handle parentheses notation for negative numbers: (100) -> -100\r\n  const parenMatch = numStr.match(/^\\(([0-9,.]+)\\)$/);\r\n  if (parenMatch) {\r\n    numStr = `-${parenMatch[1]}`;\r\n  }\r\n\r\n  // Remove currency symbols\r\n  numStr = numStr.replace(/[$]/g, '');\r\n\r\n  // Handle percentages\r\n  if (numStr.includes('%')) {\r\n    numStr = numStr.replace('%', '');\r\n    const percentResult = parseFlexibleNumber(numStr, format);\r\n    if (percentResult.success && percentResult.value !== undefined) {\r\n      return {\r\n        success: true,\r\n        value: percentResult.value / 100,\r\n        originalValue\r\n      };\r\n    }\r\n  }\r\n\r\n  // Handle EU format (1.234,56) vs US format (1,234.56)\r\n  if (format === 'eu') {\r\n    // EU: thousands separator is dot, decimal separator is comma\r\n    numStr = numStr.replace(/\\./g, ''); // Remove thousands separator\r\n    numStr = numStr.replace(/,/g, '.'); // Convert decimal comma to dot\r\n  } else {\r\n    // US: thousands separator is comma, decimal separator is dot\r\n    numStr = numStr.replace(/,/g, ''); // Remove thousands separator\r\n  }\r\n\r\n  // Try to parse as float\r\n  const parsed = parseFloat(numStr);\r\n\r\n  if (isNaN(parsed)) {\r\n    return {\r\n      success: false,\r\n      error: `Could not parse number: \"${value}\"`,\r\n      originalValue\r\n    };\r\n  }\r\n\r\n  return { success: true, value: parsed, originalValue };\r\n}\r\n\r\n/**\r\n * Parse a boolean value from various formats\r\n */\r\nexport function parseFlexibleBoolean(value: any): ConversionResult<boolean> {\r\n  const originalValue = value;\r\n\r\n  // If already a boolean\r\n  if (typeof value === 'boolean') {\r\n    return { success: true, value, originalValue };\r\n  }\r\n\r\n  // If null or undefined\r\n  if (value === null || value === undefined) {\r\n    return { success: false, error: 'Empty or null boolean', originalValue };\r\n  }\r\n\r\n  // Convert to string and normalize\r\n  const strValue = String(value).trim().toLowerCase();\r\n\r\n  // True values\r\n  if (['true', '1', 'yes', 'y', 't', 'on', 'checked'].includes(strValue)) {\r\n    return { success: true, value: true, originalValue };\r\n  }\r\n\r\n  // False values\r\n  if (['false', '0', 'no', 'n', 'f', 'off', 'unchecked', ''].includes(strValue)) {\r\n    return { success: true, value: false, originalValue };\r\n  }\r\n\r\n  return {\r\n    success: false,\r\n    error: `Could not parse boolean: \"${value}\"`,\r\n    originalValue\r\n  };\r\n}\r\n\r\n/**\r\n * Parse an array from various formats\r\n * Handles: \"tag1, tag2, tag3\" or [\"tag1\", \"tag2\"] or \"tag1;tag2\"\r\n */\r\nexport function parseFlexibleArray(value: any, delimiter: string = ','): ConversionResult<string[]> {\r\n  const originalValue = value;\r\n\r\n  // If already an array\r\n  if (Array.isArray(value)) {\r\n    return {\r\n      success: true,\r\n      value: value.map(v => String(v).trim()).filter(Boolean),\r\n      originalValue\r\n    };\r\n  }\r\n\r\n  // If null or undefined\r\n  if (value === null || value === undefined || value === '') {\r\n    return { success: true, value: [], originalValue };\r\n  }\r\n\r\n  // Convert to string and split\r\n  const strValue = String(value);\r\n  const items = strValue\r\n    .split(delimiter)\r\n    .map(item => item.trim())\r\n    .filter(Boolean);\r\n\r\n  return { success: true, value: items, originalValue };\r\n}\r\n\r\n/**\r\n * Parse trade type from various formats\r\n */\r\nexport function parseTradeType(value: any): ConversionResult<'win' | 'loss' | 'breakeven'> {\r\n  const originalValue = value;\r\n\r\n  // If null or undefined\r\n  if (value === null || value === undefined || value === '') {\r\n    return { success: false, error: 'Empty trade type', originalValue };\r\n  }\r\n\r\n  // Convert to string and normalize\r\n  const strValue = String(value).trim().toLowerCase();\r\n\r\n  // Win variants\r\n  if (['win', 'profit', 'w', 'positive', '+', 'green'].includes(strValue)) {\r\n    return { success: true, value: 'win', originalValue };\r\n  }\r\n\r\n  // Loss variants\r\n  if (['loss', 'lose', 'l', 'negative', '-', 'red'].includes(strValue)) {\r\n    return { success: true, value: 'loss', originalValue };\r\n  }\r\n\r\n  // Breakeven variants\r\n  if (['breakeven', 'break-even', 'be', 'b', 'flat', 'zero', '0', 'neutral'].includes(strValue)) {\r\n    return { success: true, value: 'breakeven', originalValue };\r\n  }\r\n\r\n  return {\r\n    success: false,\r\n    error: `Could not parse trade type: \"${value}\"`,\r\n    originalValue\r\n  };\r\n}\r\n\r\n/**\r\n * Convert a value to the expected field type\r\n */\r\nexport function convertToFieldType(\r\n  value: any,\r\n  targetType: FieldType,\r\n  options: { numberFormat?: 'us' | 'eu'; arrayDelimiter?: string } = {}\r\n): ConversionResult {\r\n  switch (targetType) {\r\n    case 'date':\r\n      return parseFlexibleDate(value);\r\n\r\n    case 'number':\r\n      return parseFlexibleNumber(value, options.numberFormat);\r\n\r\n    case 'boolean':\r\n      return parseFlexibleBoolean(value);\r\n\r\n    case 'array':\r\n      return parseFlexibleArray(value, options.arrayDelimiter);\r\n\r\n    case 'string':\r\n      // String conversion always succeeds\r\n      if (value === null || value === undefined) {\r\n        return { success: true, value: '', originalValue: value };\r\n      }\r\n      return { success: true, value: String(value), originalValue: value };\r\n\r\n    default:\r\n      return {\r\n        success: false,\r\n        error: `Unknown field type: ${targetType}`,\r\n        originalValue: value\r\n      };\r\n  }\r\n}\r\n\r\n/**\r\n * Validate that a value is of the expected type\r\n */\r\nexport function validateFieldType(value: any, expectedType: FieldType): boolean {\r\n  switch (expectedType) {\r\n    case 'string':\r\n      return typeof value === 'string';\r\n\r\n    case 'number':\r\n      return typeof value === 'number' && !isNaN(value);\r\n\r\n    case 'date':\r\n      return value instanceof Date && !isNaN(value.getTime());\r\n\r\n    case 'boolean':\r\n      return typeof value === 'boolean';\r\n\r\n    case 'array':\r\n      return Array.isArray(value);\r\n\r\n    default:\r\n      warn(`Unknown field type for validation: ${expectedType}`);\r\n      return false;\r\n  }\r\n}\r\n","/**\r\n * Import Validation Utilities\r\n * Validates imported data and generates validation summaries\r\n */\r\n\r\nimport { Trade } from '../types/dualWrite';\r\nimport {\r\n  ValidationError,\r\n  ValidationSummary,\r\n  ImportPreviewRow,\r\n  ColumnMapping,\r\n  FieldMetadata,\r\n  TradeField,\r\n  TypeConversion,\r\n  ImportConfig\r\n} from '../types/import';\r\nimport {\r\n  convertToFieldType,\r\n  validateFieldType,\r\n  parseTradeType,\r\n  ConversionResult\r\n} from './typeConverters';\r\nimport { formatTagWithCapitalizedGroup } from './tagColors';\r\n\r\n/**\r\n * Field metadata for all Trade fields\r\n */\r\nexport const TRADE_FIELD_METADATA: Record<TradeField, FieldMetadata> = {\r\n  trade_date: {\r\n    name: 'trade_date',\r\n    displayName: 'Trade Date',\r\n    type: 'date',\r\n    required: true,\r\n    description: 'Date when the trade was executed',\r\n    examples: ['2025-01-15', '01/15/2025', 'January 15, 2025']\r\n  },\r\n  amount: {\r\n    name: 'amount',\r\n    displayName: 'Amount (P&L)',\r\n    type: 'number',\r\n    required: true,\r\n    description: 'Profit or loss amount (positive for wins, negative for losses)',\r\n    examples: ['100.50', '-50.25', '$1,234.56']\r\n  },\r\n  trade_type: {\r\n    name: 'trade_type',\r\n    displayName: 'Trade Type',\r\n    type: 'string',\r\n    required: false,\r\n    description: 'Type of trade result (win/loss/breakeven). Auto-derived from amount if not provided.',\r\n    examples: ['win', 'loss', 'breakeven']\r\n  },\r\n  name: {\r\n    name: 'name',\r\n    displayName: 'Name',\r\n    type: 'string',\r\n    required: false,\r\n    description: 'Name or symbol of the trade',\r\n    examples: ['AAPL', 'EUR/USD', 'Gold Futures']\r\n  },\r\n  entry_price: {\r\n    name: 'entry_price',\r\n    displayName: 'Entry Price',\r\n    type: 'number',\r\n    required: false,\r\n    description: 'Price at which the trade was entered',\r\n    examples: ['150.25', '1.2345']\r\n  },\r\n  exit_price: {\r\n    name: 'exit_price',\r\n    displayName: 'Exit Price',\r\n    type: 'number',\r\n    required: false,\r\n    description: 'Price at which the trade was exited',\r\n    examples: ['155.75', '1.2450']\r\n  },\r\n  stop_loss: {\r\n    name: 'stop_loss',\r\n    displayName: 'Stop Loss',\r\n    type: 'number',\r\n    required: false,\r\n    description: 'Stop loss price level',\r\n    examples: ['148.00', '1.2300']\r\n  },\r\n  take_profit: {\r\n    name: 'take_profit',\r\n    displayName: 'Take Profit',\r\n    type: 'number',\r\n    required: false,\r\n    description: 'Take profit price level',\r\n    examples: ['160.00', '1.2600']\r\n  },\r\n  risk_to_reward: {\r\n    name: 'risk_to_reward',\r\n    displayName: 'Risk to Reward',\r\n    type: 'number',\r\n    required: false,\r\n    description: 'Risk to reward ratio',\r\n    examples: ['2', '3.5', '1:2']\r\n  },\r\n  partials_taken: {\r\n    name: 'partials_taken',\r\n    displayName: 'Partials Taken',\r\n    type: 'boolean',\r\n    required: false,\r\n    description: 'Whether partial profits were taken',\r\n    examples: ['true', 'false', 'yes', 'no']\r\n  },\r\n  session: {\r\n    name: 'session',\r\n    displayName: 'Session',\r\n    type: 'string',\r\n    required: false,\r\n    description: 'Trading session',\r\n    examples: ['London', 'New York', 'Asian']\r\n  },\r\n  notes: {\r\n    name: 'notes',\r\n    displayName: 'Notes',\r\n    type: 'string',\r\n    required: false,\r\n    description: 'Trade notes and comments',\r\n    examples: ['Good entry', 'Breakout trade', 'Revenge trading - avoid']\r\n  },\r\n  tags: {\r\n    name: 'tags',\r\n    displayName: 'Tags',\r\n    type: 'array',\r\n    required: false,\r\n    description: 'Tags for categorization',\r\n    examples: ['Strategy:Breakout', 'Setup:Flag, Market:Bullish']\r\n  },\r\n  images: {\r\n    name: 'images',\r\n    displayName: 'Images',\r\n    type: 'array',\r\n    required: false,\r\n    description: 'Image URLs (single URL or comma-separated list)',\r\n    examples: ['https://example.com/image.jpg', 'https://example.com/img1.jpg, https://example.com/img2.jpg']\r\n  }\r\n};\r\n\r\n/**\r\n * Validate and convert a single field value\r\n */\r\nfunction validateField(\r\n  field: TradeField,\r\n  value: any,\r\n  config: ImportConfig\r\n): { isValid: boolean; convertedValue?: any; error?: ValidationError } {\r\n  const metadata = TRADE_FIELD_METADATA[field];\r\n\r\n  // Handle empty values\r\n  if (value === null || value === undefined || value === '') {\r\n    if (metadata.required) {\r\n      return {\r\n        isValid: false,\r\n        error: {\r\n          row: 0,\r\n          column: field,\r\n          field,\r\n          severity: 'error',\r\n          message: `Required field \"${metadata.displayName}\" is empty`\r\n        }\r\n      };\r\n    }\r\n    return { isValid: true, convertedValue: undefined };\r\n  }\r\n\r\n  // Convert to expected type\r\n  const conversionOptions = {\r\n    numberFormat: config.numberFormat,\r\n    arrayDelimiter: ','\r\n  };\r\n\r\n  const conversionResult: ConversionResult = convertToFieldType(\r\n    value,\r\n    metadata.type,\r\n    conversionOptions\r\n  );\r\n\r\n  if (!conversionResult.success) {\r\n    return {\r\n      isValid: false,\r\n      error: {\r\n        row: 0,\r\n        column: field,\r\n        field,\r\n        severity: 'error',\r\n        message: conversionResult.error || `Failed to convert ${field}`,\r\n        value,\r\n        suggestedFix: `Expected ${metadata.type}, got: ${typeof value}`\r\n      }\r\n    };\r\n  }\r\n\r\n  // Validate converted value\r\n  if (!validateFieldType(conversionResult.value, metadata.type)) {\r\n    return {\r\n      isValid: false,\r\n      error: {\r\n        row: 0,\r\n        column: field,\r\n        field,\r\n        severity: 'error',\r\n        message: `Invalid ${field} value after conversion`,\r\n        value: conversionResult.value\r\n      }\r\n    };\r\n  }\r\n\r\n  return {\r\n    isValid: true,\r\n    convertedValue: conversionResult.value\r\n  };\r\n}\r\n\r\n/**\r\n * Convert a raw row to a mapped Trade object\r\n */\r\nexport function mapRowToTrade(\r\n  row: Record<string, any>,\r\n  mappings: ColumnMapping[],\r\n  config: ImportConfig,\r\n  rowIndex: number\r\n): {\r\n  trade: Partial<Trade>;\r\n  errors: ValidationError[];\r\n  warnings: ValidationError[];\r\n} {\r\n  const trade: Partial<Trade> = {};\r\n  const errors: ValidationError[] = [];\r\n  const warnings: ValidationError[] = [];\r\n\r\n  // Apply column mappings\r\n  for (const mapping of mappings) {\r\n    const { fileColumn, target } = mapping;\r\n    const value = row[fileColumn];\r\n\r\n    // Skip ignored columns\r\n    if (target === 'ignore') continue;\r\n\r\n    // Handle tag creation\r\n    if (target === 'create_tag') {\r\n      if (value && String(value).trim()) {\r\n        if (!trade.tags) trade.tags = [];\r\n        const tagValue = `${fileColumn}:${String(value).trim()}`;\r\n        // Capitalize the group name\r\n        const formattedTag = formatTagWithCapitalizedGroup(tagValue);\r\n        trade.tags.push(formattedTag);\r\n      }\r\n      continue;\r\n    }\r\n\r\n    // Validate and convert field\r\n    const field = target as TradeField;\r\n    const validation = validateField(field, value, config);\r\n\r\n    if (validation.isValid) {\r\n      if (validation.convertedValue !== undefined) {\r\n        // Special handling for images field - convert URL strings to TradeImageEntity array\r\n        if (field === 'images' && Array.isArray(validation.convertedValue)) {\r\n          const imageUrls = validation.convertedValue as string[];\r\n          (trade as any)[field] = imageUrls.map((url, index) => ({\r\n            id: crypto.randomUUID(),\r\n            url: url.trim(),\r\n            calendar_id: '' // Will be set when trade is saved\r\n          }));\r\n        } else {\r\n          (trade as any)[field] = validation.convertedValue;\r\n        }\r\n      }\r\n    } else if (validation.error) {\r\n      validation.error.row = rowIndex;\r\n      validation.error.column = fileColumn;\r\n      errors.push(validation.error);\r\n    }\r\n  }\r\n\r\n  // Auto-derive trade_type if not mapped\r\n  if (!trade.trade_type && trade.amount !== undefined) {\r\n    if (trade.amount > 0) {\r\n      trade.trade_type = 'win';\r\n    } else if (trade.amount < 0) {\r\n      trade.trade_type = 'loss';\r\n    } else {\r\n      trade.trade_type = 'breakeven';\r\n    }\r\n  } else if (trade.trade_type && typeof trade.trade_type === 'string') {\r\n    // Validate trade_type if provided\r\n    const typeResult = parseTradeType(trade.trade_type);\r\n    if (typeResult.success) {\r\n      trade.trade_type = typeResult.value;\r\n    } else {\r\n      errors.push({\r\n        row: rowIndex,\r\n        column: 'trade_type',\r\n        field: 'trade_type',\r\n        severity: 'error',\r\n        message: 'Invalid trade type',\r\n        value: trade.trade_type,\r\n        suggestedFix: 'Must be \"win\", \"loss\", or \"breakeven\"'\r\n      });\r\n    }\r\n  }\r\n\r\n  // Apply default values\r\n  if (config.defaultValues) {\r\n    for (const [key, value] of Object.entries(config.defaultValues)) {\r\n      if ((trade as any)[key] === undefined) {\r\n        (trade as any)[key] = value;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Check required fields\r\n  const requiredFields: TradeField[] = ['amount', 'trade_date'];\r\n  for (const field of requiredFields) {\r\n    if ((trade as any)[field] === undefined) {\r\n      errors.push({\r\n        row: rowIndex,\r\n        column: field,\r\n        field,\r\n        severity: 'error',\r\n        message: `Required field \"${TRADE_FIELD_METADATA[field].displayName}\" is missing`\r\n      });\r\n    }\r\n  }\r\n\r\n  // Add warnings for potentially missing important fields\r\n  if (!trade.name) {\r\n    warnings.push({\r\n      row: rowIndex,\r\n      column: 'name',\r\n      field: 'name',\r\n      severity: 'warning',\r\n      message: 'Trade name is empty'\r\n    });\r\n  }\r\n\r\n  return { trade, errors, warnings };\r\n}\r\n\r\n/**\r\n * Validate all rows and generate preview data\r\n */\r\nexport function validateImportData(\r\n  rows: Array<Record<string, any>>,\r\n  mappings: ColumnMapping[],\r\n  config: ImportConfig\r\n): {\r\n  previewRows: ImportPreviewRow[];\r\n  validationSummary: ValidationSummary;\r\n} {\r\n  const previewRows: ImportPreviewRow[] = [];\r\n  const allErrors: ValidationError[] = [];\r\n  const conversions = new Map<TradeField, TypeConversion>();\r\n\r\n  let validRows = 0;\r\n  let rowsWithWarnings = 0;\r\n  let rowsWithErrors = 0;\r\n\r\n  // Process each row\r\n  rows.forEach((row, index) => {\r\n    const { trade, errors, warnings } = mapRowToTrade(row, mappings, config, index);\r\n\r\n    const isValid = errors.length === 0;\r\n    if (isValid) validRows++;\r\n    if (warnings.length > 0) rowsWithWarnings++;\r\n    if (errors.length > 0) rowsWithErrors++;\r\n\r\n    previewRows.push({\r\n      rowIndex: index,\r\n      data: row,\r\n      mappedData: trade,\r\n      errors,\r\n      warnings,\r\n      isValid\r\n    });\r\n\r\n    allErrors.push(...errors);\r\n\r\n    // Track conversions\r\n    for (const mapping of mappings) {\r\n      if (mapping.target === 'ignore' || mapping.target === 'create_tag') continue;\r\n\r\n      const field = mapping.target as TradeField;\r\n      const metadata = TRADE_FIELD_METADATA[field];\r\n      const originalValue = row[mapping.fileColumn];\r\n      const convertedValue = (trade as any)[field];\r\n\r\n      if (originalValue !== undefined && convertedValue !== undefined) {\r\n        const originalType = typeof originalValue;\r\n        const needsConversion = originalType !== metadata.type &&\r\n          !(metadata.type === 'date' && originalValue instanceof Date) &&\r\n          !(metadata.type === 'array' && Array.isArray(originalValue));\r\n\r\n        if (needsConversion) {\r\n          if (!conversions.has(field)) {\r\n            conversions.set(field, {\r\n              field,\r\n              fromType: originalType,\r\n              toType: metadata.type,\r\n              affectedRows: 0,\r\n              examples: [],\r\n              warnings: 0\r\n            });\r\n          }\r\n\r\n          const conversion = conversions.get(field)!;\r\n          conversion.affectedRows++;\r\n\r\n          if (conversion.examples.length < 3) {\r\n            conversion.examples.push({\r\n              original: originalValue,\r\n              converted: convertedValue\r\n            });\r\n          }\r\n\r\n          // Count conversion warnings\r\n          const hasWarning = warnings.some(w => w.field === field);\r\n          if (hasWarning) conversion.warnings++;\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  // Generate validation summary\r\n  const validationSummary: ValidationSummary = {\r\n    totalRows: rows.length,\r\n    validRows,\r\n    rowsWithWarnings,\r\n    rowsWithErrors,\r\n    willImport: config.skipErrorRows ? validRows : rows.length,\r\n    conversions: Array.from(conversions.values()),\r\n    errors: allErrors\r\n  };\r\n\r\n  return { previewRows, validationSummary };\r\n}\r\n\r\n/**\r\n * Get field metadata by name\r\n */\r\nexport function getFieldMetadata(field: TradeField): FieldMetadata {\r\n  return TRADE_FIELD_METADATA[field];\r\n}\r\n\r\n/**\r\n * Get all available trade fields\r\n */\r\nexport function getAllTradeFields(): TradeField[] {\r\n  return Object.keys(TRADE_FIELD_METADATA) as TradeField[];\r\n}\r\n\r\n/**\r\n * Get required trade fields\r\n */\r\nexport function getRequiredFields(): TradeField[] {\r\n  return Object.values(TRADE_FIELD_METADATA)\r\n    .filter(m => m.required)\r\n    .map(m => m.name);\r\n}\r\n","/**\r\n * Column Detection Utility\r\n * Auto-detects column mappings from file headers\r\n */\r\n\r\nimport { TradeField, ColumnMapping, ColumnSuggestion } from '../types/import';\r\n\r\n/**\r\n * Mapping patterns for each trade field\r\n * Key: TradeField, Value: array of patterns to match (case-insensitive)\r\n */\r\nconst FIELD_PATTERNS: Record<TradeField, string[]> = {\r\n  trade_date: [\r\n    'date',\r\n    'trade date',\r\n    'trade_date',\r\n    'tradedate',\r\n    'day',\r\n    'timestamp',\r\n    'time',\r\n    'executed',\r\n    'execution date',\r\n    'entry date'\r\n  ],\r\n  amount: [\r\n    'amount',\r\n    'p&l',\r\n    'pnl',\r\n    'profit',\r\n    'loss',\r\n    'profit/loss',\r\n    'profit loss',\r\n    'net',\r\n    'net amount',\r\n    'result',\r\n    'pl'\r\n  ],\r\n  trade_type: [\r\n    'type',\r\n    'trade type',\r\n    'trade_type',\r\n    'tradetype',\r\n    'result',\r\n    'outcome',\r\n    'status',\r\n    'win/loss',\r\n    'win loss'\r\n  ],\r\n  name: [\r\n    'name',\r\n    'trade name',\r\n    'trade_name',\r\n    'tradename',\r\n    'title',\r\n    'symbol',\r\n    'ticker',\r\n    'instrument',\r\n    'asset',\r\n    'pair',\r\n    'description'\r\n  ],\r\n  entry_price: [\r\n    'entry',\r\n    'entry price',\r\n    'entry_price',\r\n    'entryprice',\r\n    'buy price',\r\n    'buy',\r\n    'open price',\r\n    'open',\r\n    'purchase price',\r\n    'in',\r\n    'entry point'\r\n  ],\r\n  exit_price: [\r\n    'exit',\r\n    'exit price',\r\n    'exit_price',\r\n    'exitprice',\r\n    'sell price',\r\n    'sell',\r\n    'close price',\r\n    'close',\r\n    'sale price',\r\n    'out',\r\n    'exit point'\r\n  ],\r\n  stop_loss: [\r\n    'stop loss',\r\n    'stop_loss',\r\n    'stoploss',\r\n    'sl',\r\n    's/l',\r\n    's.l',\r\n    'stop',\r\n    'stop price'\r\n  ],\r\n  take_profit: [\r\n    'take profit',\r\n    'take_profit',\r\n    'takeprofit',\r\n    'tp',\r\n    't/p',\r\n    't.p',\r\n    'target',\r\n    'target price',\r\n    'profit target'\r\n  ],\r\n  risk_to_reward: [\r\n    'risk to reward',\r\n    'risk_to_reward',\r\n    'risktoreward',\r\n    'r:r',\r\n    'rr',\r\n    'r/r',\r\n    'r2r',\r\n    'risk reward',\r\n    'risk:reward',\r\n    'reward risk',\r\n    'reward:risk'\r\n  ],\r\n  partials_taken: [\r\n    'partials',\r\n    'partials taken',\r\n    'partials_taken',\r\n    'partial',\r\n    'partial profit',\r\n    'scaled out',\r\n    'scale out',\r\n    'partials_out'\r\n  ],\r\n  session: [\r\n    'session',\r\n    'trading session',\r\n    'market session',\r\n    'time session',\r\n    'period',\r\n    'shift'\r\n  ],\r\n  notes: [\r\n    'notes',\r\n    'note',\r\n    'comments',\r\n    'comment',\r\n    'description',\r\n    'details',\r\n    'remarks',\r\n    'memo',\r\n    'observations'\r\n  ],\r\n  tags: [\r\n    'tags',\r\n    'tag',\r\n    'categories',\r\n    'category',\r\n    'labels',\r\n    'label',\r\n    'keywords'\r\n  ],\r\n  images: [\r\n    'images',\r\n    'image',\r\n    'imgs',\r\n    'img',\r\n    'pictures',\r\n    'picture',\r\n    'photos',\r\n    'photo',\r\n    'screenshots',\r\n    'screenshot',\r\n    'image url',\r\n    'image urls',\r\n    'image_url',\r\n    'image_urls',\r\n    'imageurl',\r\n    'imageurls'\r\n  ]\r\n};\r\n\r\n/**\r\n * Calculate similarity score between two strings (0-1)\r\n * Uses Levenshtein distance normalized\r\n */\r\nexport function calculateSimilarity(str1: string, str2: string): number {\r\n  const s1 = str1.toLowerCase().trim();\r\n  const s2 = str2.toLowerCase().trim();\r\n\r\n  // Exact match\r\n  if (s1 === s2) return 1;\r\n\r\n  // Contains match\r\n  if (s1.includes(s2) || s2.includes(s1)) return 0.8;\r\n\r\n  // Levenshtein distance\r\n  const matrix: number[][] = [];\r\n  const len1 = s1.length;\r\n  const len2 = s2.length;\r\n\r\n  // Initialize matrix\r\n  for (let i = 0; i <= len1; i++) {\r\n    matrix[i] = [i];\r\n  }\r\n  for (let j = 0; j <= len2; j++) {\r\n    matrix[0][j] = j;\r\n  }\r\n\r\n  // Fill matrix\r\n  for (let i = 1; i <= len1; i++) {\r\n    for (let j = 1; j <= len2; j++) {\r\n      const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;\r\n      matrix[i][j] = Math.min(\r\n        matrix[i - 1][j] + 1,      // deletion\r\n        matrix[i][j - 1] + 1,      // insertion\r\n        matrix[i - 1][j - 1] + cost // substitution\r\n      );\r\n    }\r\n  }\r\n\r\n  const distance = matrix[len1][len2];\r\n  const maxLength = Math.max(len1, len2);\r\n  return 1 - distance / maxLength;\r\n}\r\n\r\n/**\r\n * Find the best matching trade field for a file column\r\n */\r\nfunction findBestFieldMatch(fileColumn: string): { field: TradeField | null; confidence: number; reason: string } {\r\n  let bestMatch: TradeField | null = null;\r\n  let highestScore = 0;\r\n  let matchReason = '';\r\n\r\n  const normalizedColumn = fileColumn.toLowerCase().trim();\r\n\r\n  // Check each field's patterns\r\n  for (const [field, patterns] of Object.entries(FIELD_PATTERNS)) {\r\n    for (const pattern of patterns) {\r\n      const similarity = calculateSimilarity(normalizedColumn, pattern);\r\n\r\n      if (similarity > highestScore) {\r\n        highestScore = similarity;\r\n        bestMatch = field as TradeField;\r\n        matchReason = similarity === 1 ? 'exact match' : similarity >= 0.8 ? 'contains match' : 'similar match';\r\n      }\r\n    }\r\n  }\r\n\r\n  // Only return match if confidence is reasonable\r\n  const confidenceThreshold = 0.6;\r\n  if (highestScore < confidenceThreshold) {\r\n    return { field: null, confidence: 0, reason: 'no clear match found' };\r\n  }\r\n\r\n  return {\r\n    field: bestMatch,\r\n    confidence: Math.round(highestScore * 100),\r\n    reason: matchReason\r\n  };\r\n}\r\n\r\n/**\r\n * Auto-detect column mappings from file columns\r\n */\r\nexport function detectColumnMapping(fileColumns: string[]): ColumnMapping[] {\r\n  const mappings: ColumnMapping[] = [];\r\n  const usedFields = new Set<TradeField>();\r\n\r\n  for (const fileColumn of fileColumns) {\r\n    const { field, confidence, reason } = findBestFieldMatch(fileColumn);\r\n\r\n    // If we found a match and it hasn't been used yet\r\n    if (field && !usedFields.has(field)) {\r\n      mappings.push({\r\n        fileColumn,\r\n        target: field,\r\n        confidence,\r\n        autoDetected: true\r\n      });\r\n      usedFields.add(field);\r\n    } else {\r\n      // No match or duplicate - don't map by default\r\n      mappings.push({\r\n        fileColumn,\r\n        target: 'ignore',\r\n        confidence: 0,\r\n        autoDetected: false\r\n      });\r\n    }\r\n  }\r\n\r\n  return mappings;\r\n}\r\n\r\n/**\r\n * Get suggestions for unmapped columns\r\n */\r\nexport function getSuggestedMapping(fileColumn: string, alreadyMappedFields: TradeField[]): ColumnSuggestion {\r\n  const { field, confidence, reason } = findBestFieldMatch(fileColumn);\r\n\r\n  // If field is already mapped, don't suggest it\r\n  if (field && alreadyMappedFields.includes(field)) {\r\n    return {\r\n      fileColumn,\r\n      suggestedField: null,\r\n      confidence: 0,\r\n      reason: 'field already mapped'\r\n    };\r\n  }\r\n\r\n  return {\r\n    fileColumn,\r\n    suggestedField: field,\r\n    confidence,\r\n    reason\r\n  };\r\n}\r\n\r\n/**\r\n * Analyze sample data to help with field detection\r\n * Returns enhanced suggestions based on data patterns\r\n */\r\nexport function analyzeColumnData(\r\n  fileColumn: string,\r\n  sampleValues: any[]\r\n): {\r\n  likelyType: 'date' | 'number' | 'string' | 'boolean' | 'unknown';\r\n  suggestedField: TradeField | null;\r\n  confidence: number;\r\n} {\r\n  // Filter out null/undefined values\r\n  const validValues = sampleValues.filter(v => v !== null && v !== undefined && v !== '');\r\n\r\n  if (validValues.length === 0) {\r\n    return {\r\n      likelyType: 'unknown',\r\n      suggestedField: null,\r\n      confidence: 0\r\n    };\r\n  }\r\n\r\n  // Analyze data types\r\n  let dateCount = 0;\r\n  let numberCount = 0;\r\n  let booleanCount = 0;\r\n  let stringCount = 0;\r\n\r\n  for (const value of validValues) {\r\n    if (typeof value === 'number' || !isNaN(parseFloat(String(value)))) {\r\n      numberCount++;\r\n    } else if (value instanceof Date || !isNaN(Date.parse(String(value)))) {\r\n      dateCount++;\r\n    } else if (typeof value === 'boolean' || ['true', 'false', 'yes', 'no', '1', '0'].includes(String(value).toLowerCase())) {\r\n      booleanCount++;\r\n    } else {\r\n      stringCount++;\r\n    }\r\n  }\r\n\r\n  const total = validValues.length;\r\n  let likelyType: 'date' | 'number' | 'string' | 'boolean' | 'unknown';\r\n\r\n  // Determine most likely type (need >70% confidence)\r\n  if (dateCount / total > 0.7) {\r\n    likelyType = 'date';\r\n  } else if (numberCount / total > 0.7) {\r\n    likelyType = 'number';\r\n  } else if (booleanCount / total > 0.7) {\r\n    likelyType = 'boolean';\r\n  } else if (stringCount / total > 0.7) {\r\n    likelyType = 'string';\r\n  } else {\r\n    likelyType = 'unknown';\r\n  }\r\n\r\n  // Get base field suggestion\r\n  const { field: suggestedField, confidence } = findBestFieldMatch(fileColumn);\r\n\r\n  // Boost confidence if data type matches expected field type\r\n  let adjustedConfidence = confidence;\r\n  if (suggestedField) {\r\n    const expectedTypes: Record<TradeField, Array<'date' | 'number' | 'string' | 'boolean'>> = {\r\n      trade_date: ['date'],\r\n      amount: ['number'],\r\n      trade_type: ['string'],\r\n      name: ['string'],\r\n      entry_price: ['number'],\r\n      exit_price: ['number'],\r\n      stop_loss: ['number'],\r\n      take_profit: ['number'],\r\n      risk_to_reward: ['number'],\r\n      partials_taken: ['boolean'],\r\n      session: ['string'],\r\n      notes: ['string'],\r\n      tags: ['string'],\r\n      images: ['string']\r\n    };\r\n\r\n    const expectedType = expectedTypes[suggestedField];\r\n    if (expectedType && likelyType !== 'unknown' && expectedType.includes(likelyType)) {\r\n      adjustedConfidence = Math.min(100, adjustedConfidence + 20);\r\n    }\r\n  }\r\n\r\n  return {\r\n    likelyType,\r\n    suggestedField,\r\n    confidence: adjustedConfidence\r\n  };\r\n}\r\n\r\n/**\r\n * Get confidence level as a label\r\n */\r\nexport function getConfidenceLabel(confidence: number): 'high' | 'medium' | 'low' | 'none' {\r\n  if (confidence >= 80) return 'high';\r\n  if (confidence >= 60) return 'medium';\r\n  if (confidence >= 40) return 'low';\r\n  return 'none';\r\n}\r\n\r\n/**\r\n * Validate that required fields are mapped\r\n */\r\nexport function validateRequiredFieldsMapped(mappings: ColumnMapping[]): {\r\n  isValid: boolean;\r\n  missingFields: TradeField[];\r\n} {\r\n  const requiredFields: TradeField[] = ['amount', 'trade_date'];\r\n  const mappedFields = mappings\r\n    .filter(m => m.target !== 'ignore' && m.target !== 'create_tag')\r\n    .map(m => m.target as TradeField);\r\n\r\n  const missingFields = requiredFields.filter(field => !mappedFields.includes(field));\r\n\r\n  return {\r\n    isValid: missingFields.length === 0,\r\n    missingFields\r\n  };\r\n}\r\n\r\n/**\r\n * Check if a column's data is compatible with a target field type\r\n * Returns true if the mapping is valid, false if it would cause invalid conversions\r\n */\r\nexport function isColumnCompatibleWithField(\r\n  sampleValues: any[],\r\n  targetField: TradeField\r\n): {\r\n  isCompatible: boolean;\r\n  reason?: string;\r\n  validPercentage: number;\r\n} {\r\n  // Filter out null/undefined/empty values\r\n  const validValues = sampleValues.filter(v => v !== null && v !== undefined && v !== '');\r\n\r\n  if (validValues.length === 0) {\r\n    return { isCompatible: true, validPercentage: 100 }; // Empty column is always compatible\r\n  }\r\n\r\n  // Define expected types for number fields\r\n  const numberFields: TradeField[] = ['amount', 'entry_price', 'exit_price', 'stop_loss', 'take_profit', 'risk_to_reward'];\r\n  const dateFields: TradeField[] = ['trade_date'];\r\n  const booleanFields: TradeField[] = ['partials_taken'];\r\n\r\n  // Check compatibility for number fields\r\n  if (numberFields.includes(targetField)) {\r\n    let validCount = 0;\r\n\r\n    for (const value of validValues) {\r\n      const str = String(value).trim();\r\n\r\n      // Check if it's a valid number\r\n      // Allow formats: \"123\", \"123.45\", \"-123\", \"$123.45\", \"1,234.56\"\r\n      const cleanedStr = str.replace(/[$,]/g, ''); // Remove dollar signs and commas\r\n      const num = parseFloat(cleanedStr);\r\n\r\n      if (!isNaN(num) && isFinite(num)) {\r\n        validCount++;\r\n      }\r\n    }\r\n\r\n    const validPercentage = Math.round((validCount / validValues.length) * 100);\r\n\r\n    // Require at least 70% of values to be convertible to valid numbers\r\n    if (validPercentage < 70) {\r\n      return {\r\n        isCompatible: false,\r\n        reason: `Only ${validPercentage}% of values are valid numbers. Column contains non-numeric values like text.`,\r\n        validPercentage\r\n      };\r\n    }\r\n\r\n    return { isCompatible: true, validPercentage };\r\n  }\r\n\r\n  // Check compatibility for date fields\r\n  if (dateFields.includes(targetField)) {\r\n    let validCount = 0;\r\n\r\n    for (const value of validValues) {\r\n      if (value instanceof Date || !isNaN(Date.parse(String(value)))) {\r\n        validCount++;\r\n      }\r\n    }\r\n\r\n    const validPercentage = Math.round((validCount / validValues.length) * 100);\r\n\r\n    if (validPercentage < 70) {\r\n      return {\r\n        isCompatible: false,\r\n        reason: `Only ${validPercentage}% of values are valid dates.`,\r\n        validPercentage\r\n      };\r\n    }\r\n\r\n    return { isCompatible: true, validPercentage };\r\n  }\r\n\r\n  // Check compatibility for boolean fields\r\n  if (booleanFields.includes(targetField)) {\r\n    let validCount = 0;\r\n    const validBooleanValues = ['true', 'false', 'yes', 'no', '1', '0', 'y', 'n'];\r\n\r\n    for (const value of validValues) {\r\n      const str = String(value).toLowerCase().trim();\r\n      if (typeof value === 'boolean' || validBooleanValues.includes(str)) {\r\n        validCount++;\r\n      }\r\n    }\r\n\r\n    const validPercentage = Math.round((validCount / validValues.length) * 100);\r\n\r\n    if (validPercentage < 70) {\r\n      return {\r\n        isCompatible: false,\r\n        reason: `Only ${validPercentage}% of values are valid boolean values.`,\r\n        validPercentage\r\n      };\r\n    }\r\n\r\n    return { isCompatible: true, validPercentage };\r\n  }\r\n\r\n  // String fields (name, session, notes, tags, etc.) are always compatible\r\n  return { isCompatible: true, validPercentage: 100 };\r\n}\r\n\r\n/**\r\n * Validate and auto-correct column mappings based on data compatibility\r\n * Returns updated mappings with incompatible mappings set to 'ignore'\r\n */\r\nexport function validateAndCorrectMappings(\r\n  mappings: ColumnMapping[],\r\n  fileData: { columns: string[]; rows: Array<Record<string, any>> }\r\n): {\r\n  correctedMappings: ColumnMapping[];\r\n  corrections: Array<{ column: string; originalTarget: string; reason: string }>;\r\n} {\r\n  const corrections: Array<{ column: string; originalTarget: string; reason: string }> = [];\r\n  const correctedMappings = mappings.map(mapping => {\r\n    // Skip if already ignored or if it's a special action\r\n    if (mapping.target === 'ignore' || mapping.target === 'create_tag') {\r\n      return mapping;\r\n    }\r\n\r\n    // Get sample values for this column\r\n    const sampleValues = fileData.rows.slice(0, 100).map(row => row[mapping.fileColumn]);\r\n\r\n    // Check compatibility\r\n    const compatibility = isColumnCompatibleWithField(sampleValues, mapping.target as TradeField);\r\n\r\n    if (!compatibility.isCompatible) {\r\n      // Auto-correct to 'ignore'\r\n      corrections.push({\r\n        column: mapping.fileColumn,\r\n        originalTarget: mapping.target,\r\n        reason: compatibility.reason || 'Incompatible data type'\r\n      });\r\n\r\n      return {\r\n        ...mapping,\r\n        target: 'ignore' as const,\r\n        autoDetected: false\r\n      };\r\n    }\r\n\r\n    return mapping;\r\n  });\r\n\r\n  return { correctedMappings, corrections };\r\n}\r\n","import React from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  Select,\r\n  MenuItem,\r\n  FormControl,\r\n  Chip,\r\n  alpha,\r\n  Tooltip,\r\n  useTheme\r\n} from '@mui/material';\r\nimport {\r\n  CheckCircle,\r\n  Warning,\r\n  Error as ErrorIcon,\r\n  Help\r\n} from '@mui/icons-material';\r\nimport { ColumnMapping, MappingTarget, TradeField } from '../../types/import';\r\nimport { TRADE_FIELD_METADATA, getAllTradeFields } from '../../utils/importValidation';\r\nimport { getConfidenceLabel } from '../../utils/columnDetection';\r\n\r\ninterface ColumnMapperProps {\r\n  fileColumns: string[];\r\n  columnMappings: ColumnMapping[];\r\n  sampleData: Array<Record<string, any>>;\r\n  onMappingChange: (fileColumn: string, target: MappingTarget) => void;\r\n}\r\n\r\nexport const ColumnMapper: React.FC<ColumnMapperProps> = ({\r\n  fileColumns,\r\n  columnMappings,\r\n  sampleData,\r\n  onMappingChange\r\n}) => {\r\n  const theme = useTheme();\r\n  const availableFields = getAllTradeFields();\r\n  const mappedFields = new Set(\r\n    columnMappings\r\n      .filter(m => m.target !== 'ignore' && m.target !== 'create_tag')\r\n      .map(m => m.target as TradeField)\r\n  );\r\n\r\n  // Calculate missing and valid columns\r\n  const requiredFields = availableFields.filter(field => TRADE_FIELD_METADATA[field].required);\r\n  const missingFields = requiredFields.filter(field => !mappedFields.has(field));\r\n  const validMappings = columnMappings\r\n    .filter(m => m.target !== 'ignore' && m.target !== 'create_tag')\r\n    .map(m => ({\r\n      fileColumn: m.fileColumn,\r\n      targetField: TRADE_FIELD_METADATA[m.target as TradeField].displayName\r\n    }));\r\n\r\n  const getConfidenceIcon = (confidence?: number) => {\r\n    if (!confidence) return null;\r\n\r\n    const label = getConfidenceLabel(confidence);\r\n\r\n    switch (label) {\r\n      case 'high':\r\n        return <CheckCircle sx={{ fontSize: 16, color: 'success.main' }} />;\r\n      case 'medium':\r\n        return <Warning sx={{ fontSize: 16, color: 'warning.main' }} />;\r\n      case 'low':\r\n        return <ErrorIcon sx={{ fontSize: 16, color: 'error.main' }} />;\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  const getSampleValues = (fileColumn: string, count: number = 3) => {\r\n    const values = sampleData\r\n      .slice(0, count)\r\n      .map(row => row[fileColumn])\r\n      .filter(v => v !== null && v !== undefined && v !== '')\r\n      .map(v => String(v));\r\n\r\n    // Return unique values only\r\n    return Array.from(new Set(values));\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Typography variant=\"h6\" gutterBottom>\r\n        Column Mapping\r\n      </Typography>\r\n      <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 2 }}>\r\n        Map each file column to a trade field, ignore it, or choose \"Create Tag\" to convert it to a tag.\r\n      </Typography>\r\n       \r\n\r\n      {/* Mapping Summary */}\r\n      <Box\r\n        sx={{\r\n          mb: 3,\r\n          p: 2,\r\n          bgcolor: 'background.paper',\r\n          border: '1px solid',\r\n          borderColor: 'divider',\r\n          borderRadius: 1\r\n        }}\r\n      >\r\n        {missingFields.length > 0 && (\r\n          <Box sx={{ mb: validMappings.length > 0 ? 1.5 : 0 }}>\r\n            <Typography variant=\"body2\" component=\"span\" color=\"text.secondary\">\r\n              Missing columns:{' '}\r\n            </Typography>\r\n            {missingFields.map((field, idx) => (\r\n              <Typography\r\n                key={field}\r\n                variant=\"body2\"\r\n                component=\"span\"\r\n                sx={{\r\n                  fontWeight: 700,\r\n                  color: 'error.main'\r\n                }}\r\n              >\r\n                {TRADE_FIELD_METADATA[field].displayName}\r\n                {idx < missingFields.length - 1 ? ', ' : ''}\r\n              </Typography>\r\n            ))}\r\n          </Box>\r\n        )}\r\n\r\n        {validMappings.length > 0 && (\r\n          <Box>\r\n            <Typography variant=\"body2\" component=\"span\" color=\"text.secondary\">\r\n              Valid columns:{' '}\r\n            </Typography>\r\n            {validMappings.map((mapping, idx) => (\r\n              <Typography\r\n                key={mapping.fileColumn}\r\n                variant=\"body2\"\r\n                component=\"span\"\r\n                sx={{\r\n                  fontWeight: 700,\r\n                  color: 'success.main'\r\n                }}\r\n              >\r\n                {mapping.fileColumn}  {mapping.targetField}\r\n                {idx < validMappings.length - 1 ? ', ' : ''}\r\n              </Typography>\r\n            ))}\r\n          </Box>\r\n        )}\r\n\r\n        {missingFields.length === 0 && validMappings.length === 0 && (\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            No columns mapped yet. Start mapping columns below.\r\n          </Typography>\r\n        )}\r\n      </Box>\r\n\r\n      {/* File Columns */}\r\n      <Box>\r\n          <Card sx={{ border: '1px solid', borderColor: 'divider' }}>\r\n            <CardContent>\r\n              <Typography variant=\"subtitle2\" fontWeight={600} gutterBottom>\r\n                File Columns\r\n              </Typography>\r\n\r\n              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, mt: 2 }}>\r\n                {fileColumns.map(fileColumn => {\r\n                  const mapping = columnMappings.find(m => m.fileColumn === fileColumn);\r\n                  const sampleValues = getSampleValues(fileColumn);\r\n\r\n                  return (\r\n                    <Box\r\n                      key={fileColumn}\r\n                      sx={{\r\n                        p: 1.5,\r\n                        bgcolor: 'background.paper',\r\n                        border: '1px solid',\r\n                        borderColor: 'divider',\r\n                        borderRadius: 1\r\n                      }}\r\n                    >\r\n                      <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, mb: 0.5 }}>\r\n                        <Typography variant=\"caption\" fontWeight={600} sx={{  color: 'text.secondary' }}>\r\n                          File Column:\r\n                        </Typography>\r\n                          <Typography variant=\"body2\" fontWeight={600} sx={{flex: 1, mb: 1 }}>\r\n                        {fileColumn}\r\n                      </Typography>\r\n                        {mapping?.autoDetected && mapping.confidence && (\r\n                          <Tooltip title={`${mapping.confidence}% confidence - Auto-detected`}>\r\n                            <Box sx={{ display: 'flex', alignItems: 'center' }}>\r\n                              {getConfidenceIcon(mapping.confidence)}\r\n                            </Box>\r\n                          </Tooltip>\r\n                        )}\r\n                      </Box>\r\n\r\n                    \r\n\r\n                      {sampleValues.length > 0 && (\r\n                        <Box sx={{ mb: 1.5, display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n                          <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block', mb: 0.5 }}>\r\n                            Sample data:\r\n                          </Typography>\r\n                          {sampleValues.map((value, idx) => (\r\n                            <Chip\r\n                              key={idx}\r\n                              label={value.length > 20 ? `${value.substring(0, 20)}...` : value}\r\n                              size=\"small\"\r\n                              sx={{\r\n                                mr: 0.5,\r\n                                mb: 0.5,\r\n                                height: 20,\r\n                                fontSize: '0.7rem',\r\n                                bgcolor: alpha(theme.palette.secondary.main, 0.1)\r\n                              }}\r\n                            />\r\n                          ))}\r\n                        </Box>\r\n                      )}\r\n\r\n                      <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block', mb: 0.5 }}>\r\n                        Map column \"{fileColumn}\" to:\r\n                      </Typography>\r\n\r\n                      <FormControl fullWidth size=\"small\">\r\n                        <Select\r\n                          value={mapping?.target || 'ignore'}\r\n                          onChange={(e) => onMappingChange(fileColumn, e.target.value as MappingTarget)}\r\n                          sx={{ fontSize: '0.875rem' }}\r\n                        >\r\n                          <MenuItem value=\"ignore\">\r\n                            <em>Ignore this column</em>\r\n                          </MenuItem>\r\n                          <MenuItem value=\"create_tag\">Create Tag from this column</MenuItem>\r\n                          <MenuItem disabled sx={{ opacity: 0.5, fontSize: '0.75rem' }}>\r\n                             Trade Fields \r\n                          </MenuItem>\r\n                          {availableFields.map(field => {\r\n                            const metadata = TRADE_FIELD_METADATA[field];\r\n                            const isAlreadyMapped = mappedFields.has(field) && mapping?.target !== field;\r\n\r\n                            return (\r\n                              <MenuItem\r\n                                key={field}\r\n                                value={field}\r\n                                disabled={isAlreadyMapped}\r\n                                sx={{ fontSize: '0.875rem' }}\r\n                              >\r\n                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>\r\n                                  <Typography variant=\"body2\" sx={{ flex: 1 }}>\r\n                                    {metadata.displayName}\r\n                                  </Typography>\r\n                                  {metadata.required && (\r\n                                    <Chip\r\n                                      label=\"Required\"\r\n                                      size=\"small\"\r\n                                      sx={{\r\n                                        height: 16,\r\n                                        fontSize: '0.65rem',\r\n                                        bgcolor: alpha('#f44336', 0.1),\r\n                                        color: 'error.main'\r\n                                      }}\r\n                                    />\r\n                                  )}\r\n                                  {isAlreadyMapped && (\r\n                                    <Chip\r\n                                      label=\"Mapped\"\r\n                                      size=\"small\"\r\n                                      sx={{\r\n                                        height: 16,\r\n                                        fontSize: '0.65rem',\r\n                                        bgcolor: alpha('#2196f3', 0.1),\r\n                                        color: 'info.main'\r\n                                      }}\r\n                                    />\r\n                                  )}\r\n                                </Box>\r\n                              </MenuItem>\r\n                            );\r\n                          })}\r\n                        </Select>\r\n                      </FormControl>\r\n\r\n                      {mapping?.target && mapping.target !== 'ignore' && mapping.target !== 'create_tag' && (\r\n                        <Box sx={{ mt: 1, display: 'flex', alignItems: 'start', gap: 0.5 }}>\r\n                          <Help sx={{ fontSize: 14, color: 'text.secondary', mt: 0.25 }} />\r\n                          <Typography variant=\"caption\" color=\"text.secondary\">\r\n                            {TRADE_FIELD_METADATA[mapping.target as TradeField].description}\r\n                          </Typography>\r\n                        </Box>\r\n                      )}\r\n                    </Box>\r\n                  );\r\n                })}\r\n              </Box>\r\n            </CardContent>\r\n          </Card>\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Box,\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableContainer,\r\n  TableHead,\r\n  TableRow,\r\n  Typography,\r\n  Chip,\r\n  IconButton,\r\n  Tooltip,\r\n  alpha,\r\n  Button,\r\n  Collapse\r\n} from '@mui/material';\r\nimport {\r\n  CheckCircle,\r\n  Warning,\r\n  Error as ErrorIcon,\r\n  ExpandMore,\r\n  ExpandLess\r\n} from '@mui/icons-material';\r\nimport { ImportPreviewRow, TradeField } from '../../types/import';\r\nimport { TRADE_FIELD_METADATA } from '../../utils/importValidation';\r\nimport { format } from 'date-fns';\r\n\r\ninterface ImportPreviewProps {\r\n  previewRows: ImportPreviewRow[];\r\n  mappedFields: TradeField[];\r\n  maxRows?: number;\r\n}\r\n\r\nexport const ImportPreview: React.FC<ImportPreviewProps> = ({\r\n  previewRows,\r\n  mappedFields,\r\n  maxRows = 10\r\n}) => {\r\n  const [showAll, setShowAll] = useState(false);\r\n  const [expandedRow, setExpandedRow] = useState<number | null>(null);\r\n\r\n  const displayRows = showAll ? previewRows : previewRows.slice(0, maxRows);\r\n  const hasMore = previewRows.length > maxRows;\r\n\r\n  const handleToggleRow = (index: number) => {\r\n    setExpandedRow(expandedRow === index ? null : index);\r\n  };\r\n\r\n  const formatCellValue = (value: any, field: TradeField): string => {\r\n    if (value === null || value === undefined) return '-';\r\n\r\n    const metadata = TRADE_FIELD_METADATA[field];\r\n\r\n    switch (metadata.type) {\r\n      case 'date':\r\n        return value instanceof Date ? format(value, 'MM/dd/yyyy') : String(value);\r\n\r\n      case 'number':\r\n        return typeof value === 'number' ? value.toFixed(2) : String(value);\r\n\r\n      case 'boolean':\r\n        return value ? 'Yes' : 'No';\r\n\r\n      case 'array':\r\n        if (Array.isArray(value)) {\r\n          // Special handling for images field - show URLs from TradeImageEntity\r\n          if (field === 'images' && value.length > 0 && typeof value[0] === 'object' && 'url' in value[0]) {\r\n            return value.map(img => img.url).join(', ');\r\n          }\r\n          return value.join(', ');\r\n        }\r\n        return String(value);\r\n\r\n      default:\r\n        return String(value);\r\n    }\r\n  };\r\n\r\n  const getRowIcon = (row: ImportPreviewRow) => {\r\n    if (row.errors.length > 0) {\r\n      return <ErrorIcon sx={{ fontSize: 20, color: 'error.main' }} />;\r\n    }\r\n    if (row.warnings.length > 0) {\r\n      return <Warning sx={{ fontSize: 20, color: 'warning.main' }} />;\r\n    }\r\n    return <CheckCircle sx={{ fontSize: 20, color: 'success.main' }} />;\r\n  };\r\n\r\n  const getRowColor = (row: ImportPreviewRow) => {\r\n    if (row.errors.length > 0) {\r\n      return alpha('#f44336', 0.05);\r\n    }\r\n    if (row.warnings.length > 0) {\r\n      return alpha('#ff9800', 0.05);\r\n    }\r\n    return 'transparent';\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>\r\n        <Typography variant=\"h6\">\r\n          Data Preview\r\n        </Typography>\r\n        <Typography variant=\"caption\" color=\"text.secondary\">\r\n          Showing {displayRows.length} of {previewRows.length} rows\r\n        </Typography>\r\n      </Box>\r\n\r\n      <TableContainer\r\n        sx={{\r\n          border: '1px solid',\r\n          borderColor: 'divider',\r\n          borderRadius: 1,\r\n          maxHeight: 500,\r\n          overflow: 'auto',\r\n          // Custom scrollbar styling to match app\r\n          '&::-webkit-scrollbar': {\r\n            width: '8px',\r\n            height: '8px'\r\n          },\r\n          '&::-webkit-scrollbar-track': {\r\n            bgcolor: alpha('#000', 0.05),\r\n            borderRadius: 1\r\n          },\r\n          '&::-webkit-scrollbar-thumb': {\r\n            bgcolor: alpha('#000', 0.2),\r\n            borderRadius: 1,\r\n            '&:hover': {\r\n              bgcolor: alpha('#000', 0.3)\r\n            }\r\n          }\r\n        }}\r\n      >\r\n        <Table stickyHeader size=\"small\">\r\n          <TableHead>\r\n            <TableRow>\r\n              <TableCell sx={{ width: 40, bgcolor: 'background.paper' }}>\r\n                Status\r\n              </TableCell>\r\n              <TableCell sx={{ width: 60, bgcolor: 'background.paper' }}>\r\n                Row\r\n              </TableCell>\r\n              {mappedFields.map(field => (\r\n                <TableCell key={field} sx={{ bgcolor: 'background.paper', minWidth: 120 }}>\r\n                  <Typography variant=\"caption\" fontWeight={600}>\r\n                    {TRADE_FIELD_METADATA[field].displayName}\r\n                  </Typography>\r\n                 \r\n                </TableCell>\r\n              ))}\r\n              <TableCell sx={{ width: 40, bgcolor: 'background.paper' }} />\r\n            </TableRow>\r\n          </TableHead>\r\n          <TableBody>\r\n            {displayRows.map((row, index) => {\r\n              const isExpanded = expandedRow === index;\r\n              const hasIssues = row.errors.length > 0 || row.warnings.length > 0;\r\n\r\n              return (\r\n                <React.Fragment key={row.rowIndex}>\r\n                  <TableRow\r\n                    sx={{\r\n                      bgcolor: getRowColor(row),\r\n                      '&:hover': {\r\n                        bgcolor: alpha('#000', 0.02)\r\n                      }\r\n                    }}\r\n                  >\r\n                    <TableCell>\r\n                      <Tooltip\r\n                        title={\r\n                          row.errors.length > 0\r\n                            ? `${row.errors.length} error(s)`\r\n                            : row.warnings.length > 0\r\n                            ? `${row.warnings.length} warning(s)`\r\n                            : 'Valid'\r\n                        }\r\n                      >\r\n                        {getRowIcon(row)}\r\n                      </Tooltip>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        {row.rowIndex + 1}\r\n                      </Typography>\r\n                    </TableCell>\r\n                    {mappedFields.map(field => {\r\n                      const value = row.mappedData[field];\r\n                      const hasError = row.errors.some(e => e.field === field);\r\n                      const hasWarning = row.warnings.some(w => w.field === field);\r\n\r\n                      return (\r\n                        <TableCell\r\n                          key={field}\r\n                          sx={{\r\n                            bgcolor: hasError\r\n                              ? alpha('#f44336', 0.08)\r\n                              : hasWarning\r\n                              ? alpha('#ff9800', 0.08)\r\n                              : 'transparent',\r\n                            maxWidth: 200,\r\n                            overflow: 'hidden',\r\n                            textOverflow: 'ellipsis',\r\n                            whiteSpace: 'nowrap'\r\n                          }}\r\n                        >\r\n                          <Tooltip title={formatCellValue(value, field)} placement=\"top\">\r\n                            <Typography\r\n                              variant=\"caption\"\r\n                              sx={{\r\n                                color: hasError ? 'error.main' : hasWarning ? 'warning.main' : 'text.primary',\r\n                                fontWeight: hasError || hasWarning ? 600 : 400,\r\n                                overflow: 'hidden',\r\n                                textOverflow: 'ellipsis',\r\n                                whiteSpace: 'nowrap',\r\n                                display: 'block'\r\n                              }}\r\n                            >\r\n                              {formatCellValue(value, field)}\r\n                            </Typography>\r\n                          </Tooltip>\r\n                        </TableCell>\r\n                      );\r\n                    })}\r\n                    <TableCell>\r\n                      {hasIssues && (\r\n                        <IconButton\r\n                          size=\"small\"\r\n                          onClick={() => handleToggleRow(index)}\r\n                        >\r\n                          {isExpanded ? <ExpandLess /> : <ExpandMore />}\r\n                        </IconButton>\r\n                      )}\r\n                    </TableCell>\r\n                  </TableRow>\r\n\r\n                  {hasIssues && (\r\n                    <TableRow>\r\n                      <TableCell colSpan={mappedFields.length + 3} sx={{ p: 0, border: 'none' }}>\r\n                        <Collapse in={isExpanded} timeout=\"auto\">\r\n                          <Box\r\n                            sx={{\r\n                              p: 2,\r\n                              bgcolor: alpha(row.errors.length > 0 ? '#f44336' : '#ff9800', 0.05),\r\n                              borderBottom: '1px solid',\r\n                              borderColor: 'divider'\r\n                            }}\r\n                          >\r\n                            {row.errors.length > 0 && (\r\n                              <Box sx={{ mb: row.warnings.length > 0 ? 2 : 0 }}>\r\n                                <Typography variant=\"caption\" fontWeight={600} color=\"error.main\" sx={{ display: 'block', mb: 1 }}>\r\n                                  Errors:\r\n                                </Typography>\r\n                                {row.errors.map((error, errorIndex) => (\r\n                                  <Box\r\n                                    key={errorIndex}\r\n                                    sx={{\r\n                                      display: 'flex',\r\n                                      alignItems: 'start',\r\n                                      gap: 1,\r\n                                      mb: 0.5,\r\n                                      p: 0.75,\r\n                                      bgcolor: 'background.paper',\r\n                                      borderRadius: 0.5,\r\n                                      border: '1px solid',\r\n                                      borderColor: alpha('#f44336', 0.3)\r\n                                    }}\r\n                                  >\r\n                                    <ErrorIcon sx={{ fontSize: 16, color: 'error.main', mt: 0.25 }} />\r\n                                    <Box sx={{ flex: 1 }}>\r\n                                      <Typography variant=\"caption\" color=\"error.main\">\r\n                                        {error.column}: {error.message}\r\n                                      </Typography>\r\n                                      {error.suggestedFix && (\r\n                                        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block', mt: 0.25 }}>\r\n                                           {error.suggestedFix}\r\n                                        </Typography>\r\n                                      )}\r\n                                    </Box>\r\n                                  </Box>\r\n                                ))}\r\n                              </Box>\r\n                            )}\r\n\r\n                            {row.warnings.length > 0 && (\r\n                              <Box>\r\n                                <Typography variant=\"caption\" fontWeight={600} color=\"warning.main\" sx={{ display: 'block', mb: 1 }}>\r\n                                  Warnings:\r\n                                </Typography>\r\n                                {row.warnings.map((warning, warningIndex) => (\r\n                                  <Box\r\n                                    key={warningIndex}\r\n                                    sx={{\r\n                                      display: 'flex',\r\n                                      alignItems: 'start',\r\n                                      gap: 1,\r\n                                      mb: 0.5,\r\n                                      p: 0.75,\r\n                                      bgcolor: 'background.paper',\r\n                                      borderRadius: 0.5,\r\n                                      border: '1px solid',\r\n                                      borderColor: alpha('#ff9800', 0.3)\r\n                                    }}\r\n                                  >\r\n                                    <Warning sx={{ fontSize: 16, color: 'warning.main', mt: 0.25 }} />\r\n                                    <Typography variant=\"caption\" color=\"warning.main\">\r\n                                      {warning.column}: {warning.message}\r\n                                    </Typography>\r\n                                  </Box>\r\n                                ))}\r\n                              </Box>\r\n                            )}\r\n                          </Box>\r\n                        </Collapse>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  )}\r\n                </React.Fragment>\r\n              );\r\n            })}\r\n          </TableBody>\r\n        </Table>\r\n      </TableContainer>\r\n\r\n      {hasMore && !showAll && (\r\n        <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>\r\n          <Button\r\n            variant=\"outlined\"\r\n            size=\"small\"\r\n            onClick={() => setShowAll(true)}\r\n          >\r\n            Show All {previewRows.length} Rows\r\n          </Button>\r\n        </Box>\r\n      )}\r\n\r\n      {showAll && hasMore && (\r\n        <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>\r\n          <Button\r\n            variant=\"outlined\"\r\n            size=\"small\"\r\n            onClick={() => setShowAll(false)}\r\n          >\r\n            Show Less\r\n          </Button>\r\n        </Box>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n","import React from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  List,\r\n  ListItem,\r\n  ListItemIcon,\r\n  ListItemText,\r\n  Chip,\r\n  alpha,\r\n  LinearProgress\r\n} from '@mui/material';\r\nimport {\r\n  CheckCircle,\r\n  Warning,\r\n  Error as ErrorIcon,\r\n  Info,\r\n  SwapHoriz\r\n} from '@mui/icons-material';\r\nimport { ValidationSummary as ValidationSummaryType } from '../../types/import';\r\n\r\ninterface ValidationSummaryProps {\r\n  summary: ValidationSummaryType;\r\n}\r\n\r\nexport const ValidationSummary: React.FC<ValidationSummaryProps> = ({ summary }) => {\r\n  const {\r\n    totalRows,\r\n    validRows,\r\n    rowsWithWarnings,\r\n    rowsWithErrors,\r\n    willImport,\r\n    conversions\r\n  } = summary;\r\n\r\n  const validPercentage = totalRows > 0 ? (validRows / totalRows) * 100 : 0;\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        bgcolor: 'background.paper',\r\n        border: '1px solid',\r\n        borderColor: 'divider'\r\n      }}\r\n    >\r\n      <CardContent>\r\n        <Typography variant=\"h6\" gutterBottom>\r\n          Validation Summary\r\n        </Typography>\r\n\r\n        <Box sx={{ mb: 3 }}>\r\n          <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Valid Rows\r\n            </Typography>\r\n            <Typography variant=\"body2\" fontWeight={600}>\r\n              {validRows} / {totalRows} ({validPercentage.toFixed(0)}%)\r\n            </Typography>\r\n          </Box>\r\n          <LinearProgress\r\n            variant=\"determinate\"\r\n            value={validPercentage}\r\n            sx={{\r\n              height: 8,\r\n              borderRadius: 1,\r\n              bgcolor: alpha('#f44336', 0.1),\r\n              '& .MuiLinearProgress-bar': {\r\n                bgcolor: validPercentage >= 80 ? 'success.main' : validPercentage >= 50 ? 'warning.main' : 'error.main',\r\n                borderRadius: 1\r\n              }\r\n            }}\r\n          />\r\n        </Box>\r\n\r\n        <List dense disablePadding>\r\n          <ListItem disablePadding sx={{ mb: 1 }}>\r\n            <ListItemIcon sx={{ minWidth: 36 }}>\r\n              <CheckCircle sx={{ color: 'success.main', fontSize: 20 }} />\r\n            </ListItemIcon>\r\n            <ListItemText\r\n              primary={\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"body2\">Valid rows</Typography>\r\n                  <Chip\r\n                    label={validRows}\r\n                    size=\"small\"\r\n                    sx={{\r\n                      bgcolor: alpha('#4caf50', 0.1),\r\n                      color: 'success.main',\r\n                      fontWeight: 600\r\n                    }}\r\n                  />\r\n                </Box>\r\n              }\r\n            />\r\n          </ListItem>\r\n\r\n          {rowsWithWarnings > 0 && (\r\n            <ListItem disablePadding sx={{ mb: 1 }}>\r\n              <ListItemIcon sx={{ minWidth: 36 }}>\r\n                <Warning sx={{ color: 'warning.main', fontSize: 20 }} />\r\n              </ListItemIcon>\r\n              <ListItemText\r\n                primary={\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                    <Typography variant=\"body2\">Rows with warnings</Typography>\r\n                    <Chip\r\n                      label={rowsWithWarnings}\r\n                      size=\"small\"\r\n                      sx={{\r\n                        bgcolor: alpha('#ff9800', 0.1),\r\n                        color: 'warning.main',\r\n                        fontWeight: 600\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                }\r\n              />\r\n            </ListItem>\r\n          )}\r\n\r\n          {rowsWithErrors > 0 && (\r\n            <ListItem disablePadding sx={{ mb: 1 }}>\r\n              <ListItemIcon sx={{ minWidth: 36 }}>\r\n                <ErrorIcon sx={{ color: 'error.main', fontSize: 20 }} />\r\n              </ListItemIcon>\r\n              <ListItemText\r\n                primary={\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                    <Typography variant=\"body2\">Rows with errors</Typography>\r\n                    <Chip\r\n                      label={rowsWithErrors}\r\n                      size=\"small\"\r\n                      sx={{\r\n                        bgcolor: alpha('#f44336', 0.1),\r\n                        color: 'error.main',\r\n                        fontWeight: 600\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                }\r\n              />\r\n            </ListItem>\r\n          )}\r\n\r\n          {conversions.length > 0 && (\r\n            <ListItem disablePadding sx={{ mb: 1 }}>\r\n              <ListItemIcon sx={{ minWidth: 36 }}>\r\n                <SwapHoriz sx={{ color: 'info.main', fontSize: 20 }} />\r\n              </ListItemIcon>\r\n              <ListItemText\r\n                primary={\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                    <Typography variant=\"body2\">Type conversions</Typography>\r\n                    <Chip\r\n                      label={conversions.length}\r\n                      size=\"small\"\r\n                      sx={{\r\n                        bgcolor: alpha('#2196f3', 0.1),\r\n                        color: 'info.main',\r\n                        fontWeight: 600\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                }\r\n              />\r\n            </ListItem>\r\n          )}\r\n        </List>\r\n\r\n        {conversions.length > 0 && (\r\n          <Box sx={{ mt: 2, pt: 2, borderTop: '1px solid', borderColor: 'divider' }}>\r\n            <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block', mb: 1 }}>\r\n              Conversions:\r\n            </Typography>\r\n            {conversions.map((conversion, index) => (\r\n              <Box\r\n                key={index}\r\n                sx={{\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  gap: 1,\r\n                  mb: 0.5,\r\n                  p: 0.5,\r\n                  bgcolor: alpha('#2196f3', 0.05),\r\n                  borderRadius: 0.5\r\n                }}\r\n              >\r\n                <Info sx={{ fontSize: 16, color: 'info.main' }} />\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  {conversion.affectedRows} {conversion.field} values: {conversion.fromType}  {conversion.toType}\r\n                </Typography>\r\n              </Box>\r\n            ))}\r\n          </Box>\r\n        )}\r\n\r\n        <Box\r\n          sx={{\r\n            mt: 2,\r\n            pt: 2,\r\n            borderTop: '1px solid',\r\n            borderColor: 'divider',\r\n            display: 'flex',\r\n            justifyContent: 'space-between',\r\n            alignItems: 'center'\r\n          }}\r\n        >\r\n          <Typography variant=\"body2\" fontWeight={600}>\r\n            Will import:\r\n          </Typography>\r\n          <Chip\r\n            label={`${willImport} trades`}\r\n            size=\"small\"\r\n            color=\"primary\"\r\n            sx={{ fontWeight: 600 }}\r\n          />\r\n        </Box>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n","import React from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  Chip,\r\n  Collapse,\r\n  IconButton,\r\n  alpha,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport {\r\n  SwapHoriz,\r\n  ExpandMore,\r\n  ExpandLess,\r\n  Info\r\n} from '@mui/icons-material';\r\nimport { TypeConversion } from '../../types/import';\r\nimport { TRADE_FIELD_METADATA } from '../../utils/importValidation';\r\n\r\ninterface TypeConverterPanelProps {\r\n  conversions: TypeConversion[];\r\n}\r\n\r\nexport const TypeConverterPanel: React.FC<TypeConverterPanelProps> = ({ conversions }) => {\r\n  const [expandedIndex, setExpandedIndex] = React.useState<number | null>(null);\r\n\r\n  const handleToggleExpand = (index: number) => {\r\n    setExpandedIndex(expandedIndex === index ? null : index);\r\n  };\r\n\r\n  if (conversions.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        bgcolor: 'background.paper',\r\n        border: '1px solid',\r\n        borderColor: 'divider'\r\n      }}\r\n    >\r\n      <CardContent>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>\r\n          <SwapHoriz sx={{ color: 'info.main' }} />\r\n          <Typography variant=\"h6\">\r\n            Type Conversions\r\n          </Typography>\r\n          <Chip\r\n            label={conversions.length}\r\n            size=\"small\"\r\n            color=\"info\"\r\n            sx={{ ml: 'auto' }}\r\n          />\r\n        </Box>\r\n\r\n        <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 2 }}>\r\n          The following data type conversions will be applied during import:\r\n        </Typography>\r\n\r\n        <List disablePadding>\r\n          {conversions.map((conversion, index) => {\r\n            const isExpanded = expandedIndex === index;\r\n            const fieldMetadata = TRADE_FIELD_METADATA[conversion.field];\r\n\r\n            return (\r\n              <ListItem\r\n                key={index}\r\n                disablePadding\r\n                sx={{\r\n                  mb: 1,\r\n                  flexDirection: 'column',\r\n                  alignItems: 'stretch',\r\n                  bgcolor: alpha('#2196f3', 0.05),\r\n                  borderRadius: 1,\r\n                  border: '1px solid',\r\n                  borderColor: alpha('#2196f3', 0.2),\r\n                  overflow: 'hidden'\r\n                }}\r\n              >\r\n                <Box\r\n                  sx={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    p: 1.5,\r\n                    cursor: 'pointer',\r\n                    '&:hover': {\r\n                      bgcolor: alpha('#2196f3', 0.08)\r\n                    }\r\n                  }}\r\n                  onClick={() => handleToggleExpand(index)}\r\n                >\r\n                  <Box sx={{ flex: 1 }}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>\r\n                      <Typography variant=\"body2\" fontWeight={600}>\r\n                        {fieldMetadata.displayName}\r\n                      </Typography>\r\n                      <Chip\r\n                        label={`${conversion.affectedRows} rows`}\r\n                        size=\"small\"\r\n                        sx={{\r\n                          height: 20,\r\n                          fontSize: '0.7rem',\r\n                          bgcolor: alpha('#2196f3', 0.15),\r\n                          color: 'info.main'\r\n                        }}\r\n                      />\r\n                    </Box>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      <Chip\r\n                        label={conversion.fromType}\r\n                        size=\"small\"\r\n                        variant=\"outlined\"\r\n                        sx={{\r\n                          height: 22,\r\n                          fontSize: '0.7rem',\r\n                          borderColor: alpha('#666', 0.3)\r\n                        }}\r\n                      />\r\n                      <SwapHoriz sx={{ fontSize: 16, color: 'text.secondary' }} />\r\n                      <Chip\r\n                        label={conversion.toType}\r\n                        size=\"small\"\r\n                        sx={{\r\n                          height: 22,\r\n                          fontSize: '0.7rem',\r\n                          bgcolor: alpha('#4caf50', 0.1),\r\n                          color: 'success.main',\r\n                          border: '1px solid',\r\n                          borderColor: alpha('#4caf50', 0.3)\r\n                        }}\r\n                      />\r\n                      {conversion.warnings > 0 && (\r\n                        <Tooltip title={`${conversion.warnings} warnings`}>\r\n                          <Chip\r\n                            label={` ${conversion.warnings}`}\r\n                            size=\"small\"\r\n                            sx={{\r\n                              height: 22,\r\n                              fontSize: '0.7rem',\r\n                              bgcolor: alpha('#ff9800', 0.1),\r\n                              color: 'warning.main'\r\n                            }}\r\n                          />\r\n                        </Tooltip>\r\n                      )}\r\n                    </Box>\r\n                  </Box>\r\n\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    sx={{ ml: 1 }}\r\n                  >\r\n                    {isExpanded ? <ExpandLess /> : <ExpandMore />}\r\n                  </IconButton>\r\n                </Box>\r\n\r\n                <Collapse in={isExpanded} timeout=\"auto\">\r\n                  <Box sx={{ px: 1.5, pb: 1.5, pt: 0 }}>\r\n                    <Box\r\n                      sx={{\r\n                        bgcolor: 'background.paper',\r\n                        borderRadius: 1,\r\n                        p: 1.5,\r\n                        border: '1px solid',\r\n                        borderColor: 'divider'\r\n                      }}\r\n                    >\r\n                      <Box sx={{ display: 'flex', alignItems: 'start', gap: 1, mb: 1 }}>\r\n                        <Info sx={{ fontSize: 16, color: 'text.secondary', mt: 0.25 }} />\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          {fieldMetadata.description}\r\n                        </Typography>\r\n                      </Box>\r\n\r\n                      {conversion.examples.length > 0 && (\r\n                        <Box sx={{ mt: 1.5 }}>\r\n                          <Typography variant=\"caption\" fontWeight={600} sx={{ display: 'block', mb: 1 }}>\r\n                            Example conversions:\r\n                          </Typography>\r\n                          {conversion.examples.map((example, exIndex) => (\r\n                            <Box\r\n                              key={exIndex}\r\n                              sx={{\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                gap: 1,\r\n                                mb: 0.5,\r\n                                p: 0.75,\r\n                                bgcolor: alpha('#000', 0.02),\r\n                                borderRadius: 0.5,\r\n                                fontSize: '0.75rem'\r\n                              }}\r\n                            >\r\n                              <Typography\r\n                                variant=\"caption\"\r\n                                sx={{\r\n                                  fontFamily: 'monospace',\r\n                                  px: 0.75,\r\n                                  py: 0.25,\r\n                                  bgcolor: alpha('#f44336', 0.1),\r\n                                  color: 'error.dark',\r\n                                  borderRadius: 0.5\r\n                                }}\r\n                              >\r\n                                {String(example.original)}\r\n                              </Typography>\r\n                              <SwapHoriz sx={{ fontSize: 14, color: 'text.secondary' }} />\r\n                              <Typography\r\n                                variant=\"caption\"\r\n                                sx={{\r\n                                  fontFamily: 'monospace',\r\n                                  px: 0.75,\r\n                                  py: 0.25,\r\n                                  bgcolor: alpha('#4caf50', 0.1),\r\n                                  color: 'success.dark',\r\n                                  borderRadius: 0.5\r\n                                }}\r\n                              >\r\n                                {typeof example.converted === 'object'\r\n                                  ? JSON.stringify(example.converted)\r\n                                  : String(example.converted)}\r\n                              </Typography>\r\n                            </Box>\r\n                          ))}\r\n                        </Box>\r\n                      )}\r\n                    </Box>\r\n                  </Box>\r\n                </Collapse>\r\n              </ListItem>\r\n            );\r\n          })}\r\n        </List>\r\n\r\n        <Box\r\n          sx={{\r\n            mt: 2,\r\n            p: 1.5,\r\n            bgcolor: alpha('#2196f3', 0.05),\r\n            borderRadius: 1,\r\n            border: '1px solid',\r\n            borderColor: alpha('#2196f3', 0.2)\r\n          }}\r\n        >\r\n          <Typography variant=\"caption\" color=\"text.secondary\">\r\n            <strong>Note:</strong> All conversions are automatic and will be applied when you import the data.\r\n            If any conversion fails, that row will be marked with an error.\r\n          </Typography>\r\n        </Box>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n","/**\r\n * Import Mapping Storage Utility\r\n * Manages saving and loading of import mapping templates\r\n */\r\n\r\nimport { ImportMappingTemplate, ColumnMapping } from '../types/import';\r\nimport { warn, error as logError } from './logger';\r\nimport { calculateSimilarity } from './columnDetection';\r\n\r\nconst STORAGE_KEY = 'trade_import_mappings';\r\nconst MAX_TEMPLATES = 50; // Limit to prevent storage overflow\r\n\r\n/**\r\n * Load all saved mapping templates from localStorage\r\n */\r\nexport function loadMappingTemplates(): ImportMappingTemplate[] {\r\n  try {\r\n    const stored = localStorage.getItem(STORAGE_KEY);\r\n    if (!stored) return [];\r\n\r\n    const templates = JSON.parse(stored) as ImportMappingTemplate[];\r\n\r\n    // Parse date strings back to Date objects\r\n    return templates.map(template => ({\r\n      ...template,\r\n      createdAt: new Date(template.createdAt),\r\n      lastUsed: template.lastUsed ? new Date(template.lastUsed) : undefined\r\n    }));\r\n  } catch (err) {\r\n    logError('Failed to load mapping templates:', err);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Save a mapping template to localStorage\r\n */\r\nexport function saveMappingTemplate(\r\n  name: string,\r\n  columnMappings: ColumnMapping[],\r\n  fileColumns: string[],\r\n  description?: string\r\n): ImportMappingTemplate {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n\r\n    // Check for duplicate name\r\n    const existingIndex = templates.findIndex(t => t.name === name);\r\n\r\n    const newTemplate: ImportMappingTemplate = {\r\n      id: existingIndex >= 0 ? templates[existingIndex].id : crypto.randomUUID(),\r\n      name,\r\n      description,\r\n      createdAt: existingIndex >= 0 ? templates[existingIndex].createdAt : new Date(),\r\n      lastUsed: new Date(),\r\n      columnMappings,\r\n      fileColumns\r\n    };\r\n\r\n    // Update or add template\r\n    if (existingIndex >= 0) {\r\n      templates[existingIndex] = newTemplate;\r\n    } else {\r\n      templates.push(newTemplate);\r\n    }\r\n\r\n    // Limit number of templates\r\n    if (templates.length > MAX_TEMPLATES) {\r\n      // Remove oldest unused templates\r\n      templates.sort((a, b) => {\r\n        const aDate = a.lastUsed || a.createdAt;\r\n        const bDate = b.lastUsed || b.createdAt;\r\n        return bDate.getTime() - aDate.getTime();\r\n      });\r\n      templates.splice(MAX_TEMPLATES);\r\n    }\r\n\r\n    // Save to localStorage\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));\r\n\r\n    return newTemplate;\r\n  } catch (err) {\r\n    logError('Failed to save mapping template:', err);\r\n    throw new Error('Failed to save mapping template');\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a mapping template\r\n */\r\nexport function deleteMappingTemplate(templateId: string): boolean {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n    const filteredTemplates = templates.filter(t => t.id !== templateId);\r\n\r\n    if (filteredTemplates.length === templates.length) {\r\n      warn(`Template with ID ${templateId} not found`);\r\n      return false;\r\n    }\r\n\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredTemplates));\r\n    return true;\r\n  } catch (err) {\r\n    logError('Failed to delete mapping template:', err);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Update last used timestamp for a template\r\n */\r\nexport function updateTemplateLastUsed(templateId: string): void {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n    const template = templates.find(t => t.id === templateId);\r\n\r\n    if (template) {\r\n      template.lastUsed = new Date();\r\n      localStorage.setItem(STORAGE_KEY, JSON.stringify(templates));\r\n    }\r\n  } catch (err) {\r\n    logError('Failed to update template last used:', err);\r\n  }\r\n}\r\n\r\n/**\r\n * Calculate similarity between two column lists\r\n */\r\nfunction calculateColumnListSimilarity(columns1: string[], columns2: string[]): number {\r\n  if (columns1.length === 0 || columns2.length === 0) return 0;\r\n\r\n  // Calculate how many columns match\r\n  let matchCount = 0;\r\n  const normalizedColumns2 = columns2.map(c => c.toLowerCase().trim());\r\n\r\n  for (const col1 of columns1) {\r\n    const normalized1 = col1.toLowerCase().trim();\r\n\r\n    // Exact match\r\n    if (normalizedColumns2.includes(normalized1)) {\r\n      matchCount++;\r\n      continue;\r\n    }\r\n\r\n    // Similar match (using similarity function from columnDetection)\r\n    const bestSimilarity = Math.max(\r\n      ...normalizedColumns2.map(col2 => {\r\n        const s1 = normalized1;\r\n        const s2 = col2;\r\n\r\n        // Simple similarity check\r\n        if (s1 === s2) return 1;\r\n        if (s1.includes(s2) || s2.includes(s1)) return 0.8;\r\n\r\n        // Levenshtein-like approximation\r\n        const len1 = s1.length;\r\n        const len2 = s2.length;\r\n        const maxLen = Math.max(len1, len2);\r\n\r\n        let matches = 0;\r\n        for (let i = 0; i < Math.min(len1, len2); i++) {\r\n          if (s1[i] === s2[i]) matches++;\r\n        }\r\n\r\n        return matches / maxLen;\r\n      })\r\n    );\r\n\r\n    if (bestSimilarity >= 0.7) {\r\n      matchCount += bestSimilarity;\r\n    }\r\n  }\r\n\r\n  // Calculate similarity score (0-1)\r\n  const avgLength = (columns1.length + columns2.length) / 2;\r\n  return matchCount / avgLength;\r\n}\r\n\r\n/**\r\n * Find the best matching template for given file columns\r\n */\r\nexport function findMatchingTemplate(\r\n  fileColumns: string[],\r\n  minSimilarity: number = 0.7\r\n): ImportMappingTemplate | null {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n\r\n    if (templates.length === 0) return null;\r\n\r\n    // Calculate similarity for each template\r\n    const scored = templates.map(template => ({\r\n      template,\r\n      similarity: calculateColumnListSimilarity(fileColumns, template.fileColumns)\r\n    }));\r\n\r\n    // Sort by similarity\r\n    scored.sort((a, b) => b.similarity - a.similarity);\r\n\r\n    // Return best match if above threshold\r\n    const best = scored[0];\r\n    if (best.similarity >= minSimilarity) {\r\n      return best.template;\r\n    }\r\n\r\n    return null;\r\n  } catch (err) {\r\n    logError('Failed to find matching template:', err);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get recently used templates (sorted by last used date)\r\n */\r\nexport function getRecentTemplates(limit: number = 5): ImportMappingTemplate[] {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n\r\n    // Filter templates that have been used\r\n    const usedTemplates = templates.filter(t => t.lastUsed);\r\n\r\n    // Sort by last used date (most recent first)\r\n    usedTemplates.sort((a, b) => {\r\n      const aDate = a.lastUsed || a.createdAt;\r\n      const bDate = b.lastUsed || b.createdAt;\r\n      return bDate.getTime() - aDate.getTime();\r\n    });\r\n\r\n    return usedTemplates.slice(0, limit);\r\n  } catch (err) {\r\n    logError('Failed to get recent templates:', err);\r\n    return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Export templates to JSON file\r\n */\r\nexport function exportTemplates(): void {\r\n  try {\r\n    const templates = loadMappingTemplates();\r\n    const json = JSON.stringify(templates, null, 2);\r\n    const blob = new Blob([json], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `trade-import-templates-${new Date().toISOString().split('T')[0]}.json`;\r\n    document.body.appendChild(link);\r\n    link.click();\r\n    document.body.removeChild(link);\r\n    URL.revokeObjectURL(url);\r\n  } catch (err) {\r\n    logError('Failed to export templates:', err);\r\n    throw new Error('Failed to export templates');\r\n  }\r\n}\r\n\r\n/**\r\n * Import templates from JSON file\r\n */\r\nexport function importTemplates(jsonData: string): number {\r\n  try {\r\n    const importedTemplates = JSON.parse(jsonData) as ImportMappingTemplate[];\r\n    const currentTemplates = loadMappingTemplates();\r\n\r\n    let importedCount = 0;\r\n\r\n    for (const template of importedTemplates) {\r\n      // Check if template already exists\r\n      const exists = currentTemplates.some(t => t.id === template.id);\r\n\r\n      if (!exists) {\r\n        // Parse dates\r\n        template.createdAt = new Date(template.createdAt);\r\n        if (template.lastUsed) {\r\n          template.lastUsed = new Date(template.lastUsed);\r\n        }\r\n\r\n        currentTemplates.push(template);\r\n        importedCount++;\r\n      }\r\n    }\r\n\r\n    // Save updated templates\r\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentTemplates));\r\n\r\n    return importedCount;\r\n  } catch (err) {\r\n    logError('Failed to import templates:', err);\r\n    throw new Error('Failed to import templates');\r\n  }\r\n}\r\n\r\n/**\r\n * Clear all saved templates\r\n */\r\nexport function clearAllTemplates(): boolean {\r\n  try {\r\n    localStorage.removeItem(STORAGE_KEY);\r\n    return true;\r\n  } catch (err) {\r\n    logError('Failed to clear templates:', err);\r\n    return false;\r\n  }\r\n}\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogActions,\r\n  Button,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  ListItemSecondaryAction,\r\n  IconButton,\r\n  Typography,\r\n  Box,\r\n  Chip,\r\n  TextField,\r\n  alpha,\r\n  Snackbar,\r\n  Alert\r\n} from '@mui/material';\r\nimport {\r\n  Delete,\r\n  FileDownload,\r\n  FileUpload,\r\n  CheckCircle\r\n} from '@mui/icons-material';\r\nimport { ImportMappingTemplate } from '../../types/import';\r\nimport {\r\n  loadMappingTemplates,\r\n  deleteMappingTemplate,\r\n  exportTemplates,\r\n  importTemplates\r\n} from '../../utils/importMappingStorage';\r\nimport { format } from 'date-fns';\r\n\r\ninterface MappingTemplateManagerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onApplyTemplate: (template: ImportMappingTemplate) => void;\r\n}\r\n\r\nexport const MappingTemplateManager: React.FC<MappingTemplateManagerProps> = ({\r\n  open,\r\n  onClose,\r\n  onApplyTemplate\r\n}) => {\r\n  const [templates, setTemplates] = useState<ImportMappingTemplate[]>([]);\r\n  const [selectedTemplate, setSelectedTemplate] = useState<string | null>(null);\r\n  const [snackbarOpen, setSnackbarOpen] = useState(false);\r\n  const [snackbarMessage, setSnackbarMessage] = useState('');\r\n  const [snackbarSeverity, setSnackbarSeverity] = useState<'success' | 'error'>('success');\r\n  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);\r\n  const [templateToDelete, setTemplateToDelete] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (open) {\r\n      loadTemplates();\r\n    }\r\n  }, [open]);\r\n\r\n  const loadTemplates = () => {\r\n    const loaded = loadMappingTemplates();\r\n    setTemplates(loaded);\r\n  };\r\n\r\n  const handleDeleteClick = (templateId: string) => {\r\n    setTemplateToDelete(templateId);\r\n    setDeleteConfirmOpen(true);\r\n  };\r\n\r\n  const handleDeleteConfirm = () => {\r\n    if (templateToDelete) {\r\n      deleteMappingTemplate(templateToDelete);\r\n      loadTemplates();\r\n      setDeleteConfirmOpen(false);\r\n      setTemplateToDelete(null);\r\n    }\r\n  };\r\n\r\n  const handleDeleteCancel = () => {\r\n    setDeleteConfirmOpen(false);\r\n    setTemplateToDelete(null);\r\n  };\r\n\r\n  const handleApply = () => {\r\n    const template = templates.find(t => t.id === selectedTemplate);\r\n    if (template) {\r\n      onApplyTemplate(template);\r\n      onClose();\r\n    }\r\n  };\r\n\r\n  const handleExport = () => {\r\n    exportTemplates();\r\n  };\r\n\r\n  const handleImport = (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    const reader = new FileReader();\r\n    reader.onload = (e) => {\r\n      try {\r\n        const jsonData = e.target?.result as string;\r\n        const count = importTemplates(jsonData);\r\n        setSnackbarMessage(`Successfully imported ${count} template(s)`);\r\n        setSnackbarSeverity('success');\r\n        setSnackbarOpen(true);\r\n        loadTemplates();\r\n      } catch (err) {\r\n        setSnackbarMessage('Failed to import templates');\r\n        setSnackbarSeverity('error');\r\n        setSnackbarOpen(true);\r\n      }\r\n    };\r\n    reader.readAsText(file);\r\n    event.target.value = '';\r\n  };\r\n\r\n  return (\r\n    <Dialog\r\n      open={open}\r\n      onClose={onClose}\r\n      maxWidth=\"sm\"\r\n      fullWidth\r\n      PaperProps={{\r\n        sx: {\r\n          '& .MuiDialogContent-root': {\r\n            // Custom scrollbar styling to match app\r\n            '&::-webkit-scrollbar': {\r\n              width: '8px'\r\n            },\r\n            '&::-webkit-scrollbar-track': {\r\n              bgcolor: alpha('#000', 0.05),\r\n              borderRadius: 1\r\n            },\r\n            '&::-webkit-scrollbar-thumb': {\r\n              bgcolor: alpha('#000', 0.2),\r\n              borderRadius: 1,\r\n              '&:hover': {\r\n                bgcolor: alpha('#000', 0.3)\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }}\r\n    >\r\n      <DialogTitle>\r\n        Mapping Templates\r\n      </DialogTitle>\r\n      <DialogContent>\r\n        {templates.length === 0 ? (\r\n          <Box sx={{ py: 4, textAlign: 'center' }}>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              No saved templates yet. Create templates by mapping columns and saving them for future use.\r\n            </Typography>\r\n          </Box>\r\n        ) : (\r\n          <List>\r\n            {templates.map(template => (\r\n              <ListItem\r\n                key={template.id}\r\n                onClick={() => setSelectedTemplate(template.id)}\r\n                sx={{\r\n                  mb: 1,\r\n                  border: '1px solid',\r\n                  borderColor: selectedTemplate === template.id ? 'primary.main' : 'divider',\r\n                  borderRadius: 1,\r\n                  bgcolor: selectedTemplate === template.id ? alpha('#2196f3', 0.05) : 'transparent',\r\n                  cursor: 'pointer',\r\n                  '&:hover': {\r\n                    bgcolor: alpha('#2196f3', 0.08)\r\n                  }\r\n                }}\r\n              >\r\n                <ListItemText\r\n                  primary={\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                      <Typography variant=\"body2\" fontWeight={600}>\r\n                        {template.name}\r\n                      </Typography>\r\n                      {selectedTemplate === template.id && (\r\n                        <CheckCircle sx={{ fontSize: 18, color: 'primary.main' }} />\r\n                      )}\r\n                    </Box>\r\n                  }\r\n                  secondary={\r\n                    <Box>\r\n                      {template.description && (\r\n                        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block' }}>\r\n                          {template.description}\r\n                        </Typography>\r\n                      )}\r\n                      <Box sx={{ display: 'flex', gap: 0.5, mt: 0.5, flexWrap: 'wrap' }}>\r\n                        <Chip\r\n                          label={`${template.fileColumns.length} columns`}\r\n                          size=\"small\"\r\n                          sx={{ height: 18, fontSize: '0.65rem' }}\r\n                        />\r\n                        <Chip\r\n                          label={format(template.createdAt, 'MM/dd/yyyy')}\r\n                          size=\"small\"\r\n                          sx={{ height: 18, fontSize: '0.65rem' }}\r\n                        />\r\n                        {template.lastUsed && (\r\n                          <Chip\r\n                            label={`Used ${format(template.lastUsed, 'MM/dd/yyyy')}`}\r\n                            size=\"small\"\r\n                            sx={{ height: 18, fontSize: '0.65rem' }}\r\n                          />\r\n                        )}\r\n                      </Box>\r\n                    </Box>\r\n                  }\r\n                />\r\n                <ListItemSecondaryAction>\r\n                  <IconButton\r\n                    edge=\"end\"\r\n                    size=\"small\"\r\n                    onClick={(e) => {\r\n                      e.stopPropagation();\r\n                      handleDeleteClick(template.id);\r\n                    }}\r\n                  >\r\n                    <Delete />\r\n                  </IconButton>\r\n                </ListItemSecondaryAction>\r\n              </ListItem>\r\n            ))}\r\n          </List>\r\n        )}\r\n\r\n        <Box sx={{ mt: 2, display: 'flex', gap: 1 }}>\r\n          <input\r\n            type=\"file\"\r\n            accept=\".json\"\r\n            style={{ display: 'none' }}\r\n            id=\"import-templates\"\r\n            onChange={handleImport}\r\n          />\r\n          <label htmlFor=\"import-templates\" style={{ flex: 1 }}>\r\n            <Button\r\n              component=\"span\"\r\n              size=\"small\"\r\n              variant=\"outlined\"\r\n              startIcon={<FileUpload />}\r\n              fullWidth\r\n            >\r\n              Import\r\n            </Button>\r\n          </label>\r\n          <Button\r\n            size=\"small\"\r\n            variant=\"outlined\"\r\n            startIcon={<FileDownload />}\r\n            onClick={handleExport}\r\n            disabled={templates.length === 0}\r\n            sx={{ flex: 1 }}\r\n          >\r\n            Export\r\n          </Button>\r\n        </Box>\r\n      </DialogContent>\r\n      <DialogActions>\r\n        <Button onClick={onClose}>\r\n          Cancel\r\n        </Button>\r\n        <Button\r\n          onClick={handleApply}\r\n          variant=\"contained\"\r\n          disabled={!selectedTemplate}\r\n        >\r\n          Apply Template\r\n        </Button>\r\n      </DialogActions>\r\n\r\n      <Snackbar\r\n        open={snackbarOpen}\r\n        autoHideDuration={3000}\r\n        onClose={() => setSnackbarOpen(false)}\r\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n      >\r\n        <Alert\r\n          onClose={() => setSnackbarOpen(false)}\r\n          severity={snackbarSeverity}\r\n          variant=\"filled\"\r\n          sx={{ width: '100%' }}\r\n        >\r\n          {snackbarMessage}\r\n        </Alert>\r\n      </Snackbar>\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <Dialog\r\n        open={deleteConfirmOpen}\r\n        onClose={handleDeleteCancel}\r\n        maxWidth=\"xs\"\r\n        fullWidth\r\n      >\r\n        <DialogTitle>Delete Template?</DialogTitle>\r\n        <DialogContent>\r\n          <Typography variant=\"body2\">\r\n            Are you sure you want to delete this template? This action cannot be undone.\r\n          </Typography>\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={handleDeleteCancel}>\r\n            Cancel\r\n          </Button>\r\n          <Button onClick={handleDeleteConfirm} variant=\"contained\" color=\"error\">\r\n            Delete\r\n          </Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n    </Dialog>\r\n  );\r\n};\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  DialogActions,\r\n  Button,\r\n  Stepper,\r\n  Step,\r\n  StepLabel,\r\n  Box,\r\n  Typography,\r\n  CircularProgress,\r\n  Alert,\r\n  IconButton,\r\n  Snackbar,\r\n  alpha\r\n} from '@mui/material';\r\nimport {\r\n  Close,\r\n  Save,\r\n  Folder\r\n} from '@mui/icons-material';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport {\r\n  ImportFileData,\r\n  ImportStep,\r\n  ColumnMapping,\r\n  ImportConfig,\r\n  MappingTarget,\r\n  ImportPreviewRow,\r\n  ValidationSummary as ValidationSummaryType,\r\n  ImportMappingTemplate\r\n} from '../../types/import';\r\nimport { ColumnMapper } from './ColumnMapper';\r\nimport { ImportPreview } from './ImportPreview';\r\nimport { ValidationSummary } from './ValidationSummary';\r\nimport { TypeConverterPanel } from './TypeConverterPanel';\r\nimport { MappingTemplateManager } from './MappingTemplateManager';\r\nimport { detectColumnMapping, validateRequiredFieldsMapped, validateAndCorrectMappings, isColumnCompatibleWithField } from '../../utils/columnDetection';\r\nimport { validateImportData } from '../../utils/importValidation';\r\nimport {\r\n  findMatchingTemplate,\r\n  saveMappingTemplate,\r\n  updateTemplateLastUsed\r\n} from '../../utils/importMappingStorage';\r\nimport * as XLSX from 'xlsx';\r\n\r\ninterface ImportMappingDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onImport: (trades: Partial<Trade>[]) => void;\r\n  file: File | null;\r\n}\r\n\r\nconst STEPS = ['Upload & Parse', 'Map Columns', 'Preview & Validate'];\r\n\r\nexport const ImportMappingDialog: React.FC<ImportMappingDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  onImport,\r\n  file\r\n}) => {\r\n  const [currentStep, setCurrentStep] = useState<number>(0);\r\n  const [fileData, setFileData] = useState<ImportFileData | null>(null);\r\n  const [columnMappings, setColumnMappings] = useState<ColumnMapping[]>([]);\r\n  const [previewRows, setPreviewRows] = useState<ImportPreviewRow[]>([]);\r\n  const [validationSummary, setValidationSummary] = useState<ValidationSummaryType | null>(null);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [showTemplateManager, setShowTemplateManager] = useState(false);\r\n  const [saveTemplateName, setSaveTemplateName] = useState('');\r\n  const [showSaveTemplate, setShowSaveTemplate] = useState(false);\r\n  const [snackbarOpen, setSnackbarOpen] = useState(false);\r\n  const [snackbarMessage, setSnackbarMessage] = useState('');\r\n  const [snackbarSeverity, setSnackbarSeverity] = useState<'success' | 'error'>('success');\r\n\r\n  const config: ImportConfig = {\r\n    skipErrorRows: true,\r\n    createTagsFromUnmapped: true,\r\n    numberFormat: 'us'\r\n  };\r\n\r\n  // Parse file on open\r\n  useEffect(() => {\r\n    if (open && file) {\r\n      parseFile(file);\r\n    } else if (!open) {\r\n      // Reset state on close\r\n      setCurrentStep(0);\r\n      setFileData(null);\r\n      setColumnMappings([]);\r\n      setPreviewRows([]);\r\n      setValidationSummary(null);\r\n      setError(null);\r\n    }\r\n  }, [open, file]);\r\n\r\n  // Auto-validate when mappings change\r\n  useEffect(() => {\r\n    if (fileData && columnMappings.length > 0 && currentStep >= 1) {\r\n      validateData();\r\n    }\r\n  }, [columnMappings, fileData]);\r\n\r\n  const parseFile = async (file: File) => {\r\n    setIsProcessing(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const fileType = file.name.split('.').pop()?.toLowerCase() as 'xlsx' | 'csv';\r\n      let parsedData: ImportFileData;\r\n\r\n      if (fileType === 'csv') {\r\n        parsedData = await parseCSV(file);\r\n      } else {\r\n        parsedData = await parseExcel(file);\r\n      }\r\n\r\n      setFileData(parsedData);\r\n\r\n      // Auto-detect column mappings (no auto-load of templates)\r\n      const detectedMappings = detectColumnMapping(parsedData.columns);\r\n\r\n      // Validate and auto-correct mappings based on actual data\r\n      const { correctedMappings, corrections } = validateAndCorrectMappings(detectedMappings, parsedData);\r\n\r\n      // Show warnings if any mappings were auto-corrected\r\n      if (corrections.length > 0) {\r\n        const correctionMessages = corrections.map(c =>\r\n          `\"${c.column}\" cannot be mapped to \"${c.originalTarget}\": ${c.reason}`\r\n        ).join('\\n');\r\n\r\n        setSnackbarMessage(\r\n          ` Auto-corrected ${corrections.length} incompatible mapping(s):\\n${correctionMessages}\\n\\nThese columns have been set to \"Ignore\".`\r\n        );\r\n        setSnackbarSeverity('error');\r\n        setSnackbarOpen(true);\r\n      }\r\n\r\n      setColumnMappings(correctedMappings);\r\n\r\n      setCurrentStep(1);\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to parse file');\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  const parseExcel = async (file: File): Promise<ImportFileData> => {\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n\r\n      reader.onload = (e) => {\r\n        try {\r\n          const data = new Uint8Array(e.target?.result as ArrayBuffer);\r\n          const workbook = XLSX.read(data, { type: 'array' });\r\n          const worksheet = workbook.Sheets[workbook.SheetNames[0]];\r\n          const jsonData = XLSX.utils.sheet_to_json(worksheet) as Array<Record<string, any>>;\r\n\r\n          if (jsonData.length === 0) {\r\n            throw new Error('No data found in file');\r\n          }\r\n\r\n          const columns = Object.keys(jsonData[0]);\r\n\r\n          resolve({\r\n            columns,\r\n            rows: jsonData,\r\n            fileType: 'xlsx',\r\n            fileName: file.name,\r\n            rowCount: jsonData.length\r\n          });\r\n        } catch (err) {\r\n          reject(err);\r\n        }\r\n      };\r\n\r\n      reader.onerror = () => reject(new Error('Failed to read file'));\r\n      reader.readAsArrayBuffer(file);\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Parse a CSV line properly handling commas within quoted fields\r\n   */\r\n  const parseCSVLine = (line: string): string[] => {\r\n    const result: string[] = [];\r\n    let current = '';\r\n    let inQuotes = false;\r\n\r\n    for (let i = 0; i < line.length; i++) {\r\n      const char = line[i];\r\n      const nextChar = line[i + 1];\r\n\r\n      if (char === '\"') {\r\n        // Handle escaped quotes (double quotes)\r\n        if (inQuotes && nextChar === '\"') {\r\n          current += '\"';\r\n          i++; // Skip next quote\r\n        } else {\r\n          // Toggle quote state\r\n          inQuotes = !inQuotes;\r\n        }\r\n      } else if (char === ',' && !inQuotes) {\r\n        // End of field\r\n        result.push(current.trim());\r\n        current = '';\r\n      } else {\r\n        current += char;\r\n      }\r\n    }\r\n\r\n    // Add the last field\r\n    result.push(current.trim());\r\n\r\n    return result;\r\n  };\r\n\r\n  const parseCSV = async (file: File): Promise<ImportFileData> => {\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n\r\n      reader.onload = (e) => {\r\n        try {\r\n          const text = e.target?.result as string;\r\n          const lines = text.split('\\n').filter(line => line.trim());\r\n\r\n          if (lines.length < 2) {\r\n            throw new Error('CSV file must have at least a header and one data row');\r\n          }\r\n\r\n          const headers = parseCSVLine(lines[0]);\r\n          const rows: Array<Record<string, any>> = [];\r\n\r\n          for (let i = 1; i < lines.length; i++) {\r\n            const values = parseCSVLine(lines[i]);\r\n            const row: Record<string, any> = {};\r\n\r\n            headers.forEach((header, index) => {\r\n              row[header] = values[index] || '';\r\n            });\r\n\r\n            rows.push(row);\r\n          }\r\n\r\n          resolve({\r\n            columns: headers,\r\n            rows,\r\n            fileType: 'csv',\r\n            fileName: file.name,\r\n            rowCount: rows.length\r\n          });\r\n        } catch (err) {\r\n          reject(err);\r\n        }\r\n      };\r\n\r\n      reader.onerror = () => reject(new Error('Failed to read file'));\r\n      reader.readAsText(file);\r\n    });\r\n  };\r\n\r\n  const validateData = () => {\r\n    if (!fileData) return;\r\n\r\n    const { previewRows: rows, validationSummary: summary } = validateImportData(\r\n      fileData.rows,\r\n      columnMappings,\r\n      config\r\n    );\r\n\r\n    setPreviewRows(rows);\r\n    setValidationSummary(summary);\r\n  };\r\n\r\n  const handleMappingChange = (fileColumn: string, target: MappingTarget) => {\r\n    // If target is a trade field (not 'ignore' or 'create_tag'), validate compatibility\r\n    if (target !== 'ignore' && target !== 'create_tag' && fileData) {\r\n      // Get sample values for this column\r\n      const sampleValues = fileData.rows.slice(0, 100).map(row => row[fileColumn]);\r\n      const compatibility = isColumnCompatibleWithField(sampleValues, target);\r\n\r\n      if (!compatibility.isCompatible) {\r\n        // Show error and don't allow the mapping\r\n        setSnackbarMessage(\r\n          ` Cannot map \"${fileColumn}\" to \"${target}\": ${compatibility.reason}\\n\\n` +\r\n          `This column will remain set to \"Ignore\". Clean your data or choose a different field.`\r\n        );\r\n        setSnackbarSeverity('error');\r\n        setSnackbarOpen(true);\r\n        return; // Don't apply the invalid mapping\r\n      }\r\n    }\r\n\r\n    setColumnMappings(prev =>\r\n      prev.map(m =>\r\n        m.fileColumn === fileColumn\r\n          ? { ...m, target, autoDetected: false }\r\n          : m\r\n      )\r\n    );\r\n  };\r\n\r\n  const handleNext = () => {\r\n    if (currentStep === 1) {\r\n      // Validate required fields are mapped\r\n      const validation = validateRequiredFieldsMapped(columnMappings);\r\n      if (!validation.isValid) {\r\n        setError(`Required fields not mapped: ${validation.missingFields.join(', ')}`);\r\n        return;\r\n      }\r\n\r\n      // Check if any pair-related tags are mapped\r\n      // Look for columns mapped to tags, or unmapped columns that will become tags\r\n      const hasPairColumn = fileData?.columns.some(col =>\r\n        col.toLowerCase().includes('pair') ||\r\n        col.toLowerCase().includes('symbol') ||\r\n        col.toLowerCase().includes('instrument')\r\n      );\r\n\r\n      if (hasPairColumn) {\r\n        const pairColumnMapping = columnMappings.find(m => {\r\n          const colName = m.fileColumn.toLowerCase();\r\n          return (colName.includes('pair') || colName.includes('symbol') || colName.includes('instrument'));\r\n        });\r\n\r\n        // If pair column exists but is mapped to 'ignore', warn user\r\n        if (pairColumnMapping?.target === 'ignore') {\r\n          setSnackbarMessage(' Warning: Pair/Symbol column is set to \"Ignore\". Trades will not have economic events attached. Consider mapping it to \"Tags\" or \"Create Tag\".');\r\n          setSnackbarSeverity('error');\r\n          setSnackbarOpen(true);\r\n          // Don't return - allow them to proceed with warning\r\n        }\r\n      }\r\n\r\n      validateData();\r\n    }\r\n\r\n    setError(null);\r\n    setCurrentStep(prev => prev + 1);\r\n  };\r\n\r\n  const handleBack = () => {\r\n    setError(null);\r\n    setCurrentStep(prev => prev - 1);\r\n  };\r\n\r\n  const handleImport = () => {\r\n    if (!validationSummary) return;\r\n\r\n    // Get valid trades\r\n    const validTrades = previewRows\r\n      .filter(row => row.isValid || !config.skipErrorRows)\r\n      .map(row => row.mappedData);\r\n\r\n    onImport(validTrades);\r\n    onClose();\r\n  };\r\n\r\n  const handleSaveTemplate = () => {\r\n    if (!fileData || !saveTemplateName.trim()) return;\r\n\r\n    try {\r\n      saveMappingTemplate(\r\n        saveTemplateName.trim(),\r\n        columnMappings,\r\n        fileData.columns,\r\n        `Template for ${fileData.fileName}`\r\n      );\r\n      setShowSaveTemplate(false);\r\n      setSaveTemplateName('');\r\n      setSnackbarMessage('Template saved successfully!');\r\n      setSnackbarSeverity('success');\r\n      setSnackbarOpen(true);\r\n    } catch (err) {\r\n      setSnackbarMessage('Failed to save template');\r\n      setSnackbarSeverity('error');\r\n      setSnackbarOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleApplyTemplate = (template: ImportMappingTemplate) => {\r\n    if (!fileData) return;\r\n\r\n    // Create a map of template mappings for quick lookup\r\n    const templateMap = new Map(\r\n      template.columnMappings.map(m => [m.fileColumn, m])\r\n    );\r\n\r\n    // Merge template with current auto-detected mappings\r\n    // For columns in template: use template mapping\r\n    // For new columns (not in template): keep auto-detected mapping\r\n    const mergedMappings = columnMappings.map(currentMapping => {\r\n      const templateMapping = templateMap.get(currentMapping.fileColumn);\r\n      if (templateMapping) {\r\n        // Use template mapping for existing columns\r\n        return templateMapping;\r\n      }\r\n      // Keep auto-detected mapping for new columns\r\n      return currentMapping;\r\n    });\r\n\r\n    setColumnMappings(mergedMappings);\r\n    updateTemplateLastUsed(template.id);\r\n    setShowTemplateManager(false);\r\n  };\r\n\r\n  const getMappedFields = () => {\r\n    return columnMappings\r\n      .filter(m => m.target !== 'ignore' && m.target !== 'create_tag')\r\n      .map(m => m.target);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Dialog\r\n        open={open}\r\n        onClose={onClose}\r\n        maxWidth=\"lg\"\r\n        fullWidth\r\n        PaperProps={{\r\n          sx: {\r\n            height: '90vh',\r\n            '& .MuiDialogContent-root': {\r\n              // Custom scrollbar styling to match app\r\n              '&::-webkit-scrollbar': {\r\n                width: '8px'\r\n              },\r\n              '&::-webkit-scrollbar-track': {\r\n                bgcolor: alpha('#000', 0.05),\r\n                borderRadius: 1\r\n              },\r\n              '&::-webkit-scrollbar-thumb': {\r\n                bgcolor: alpha('#000', 0.2),\r\n                borderRadius: 1,\r\n                '&:hover': {\r\n                  bgcolor: alpha('#000', 0.3)\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }}\r\n      >\r\n        <DialogTitle>\r\n          <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n            <Typography variant=\"h6\">\r\n              Import Trades\r\n            </Typography>\r\n            <IconButton onClick={onClose} size=\"small\">\r\n              <Close />\r\n            </IconButton>\r\n          </Box>\r\n        </DialogTitle>\r\n\r\n        <DialogContent dividers>\r\n          <Stepper activeStep={currentStep} sx={{ mb: 3 }}>\r\n            {STEPS.map((label) => (\r\n              <Step key={label}>\r\n                <StepLabel>{label}</StepLabel>\r\n              </Step>\r\n            ))}\r\n          </Stepper>\r\n\r\n          {error && (\r\n            <Alert severity=\"error\" sx={{ mb: 2 }} onClose={() => setError(null)}>\r\n              {error}\r\n            </Alert>\r\n          )}\r\n\r\n          {isProcessing && (\r\n            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', py: 8 }}>\r\n              <CircularProgress />\r\n              <Typography variant=\"body2\" sx={{ ml: 2 }}>\r\n                Processing file...\r\n              </Typography>\r\n            </Box>\r\n          )}\r\n\r\n          {!isProcessing && fileData && (\r\n            <>\r\n              {currentStep === 0 && (\r\n                <Box sx={{ py: 4, textAlign: 'center' }}>\r\n                  <Typography variant=\"h6\" gutterBottom>\r\n                    File Loaded Successfully\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    {fileData.fileName} - {fileData.rowCount} rows, {fileData.columns.length} columns\r\n                  </Typography>\r\n                </Box>\r\n              )}\r\n\r\n              {currentStep === 1 && (\r\n                <Box>\r\n                  <Box sx={{ mb: 2, display: 'flex', gap: 1 }}>\r\n                    <Button\r\n                      size=\"small\"\r\n                      variant=\"outlined\"\r\n                      startIcon={<Folder />}\r\n                      onClick={() => setShowTemplateManager(true)}\r\n                    >\r\n                      Load Template\r\n                    </Button>\r\n                    <Button\r\n                      size=\"small\"\r\n                      variant=\"outlined\"\r\n                      startIcon={<Save />}\r\n                      onClick={() => setShowSaveTemplate(!showSaveTemplate)}\r\n                    >\r\n                      Save as Template\r\n                    </Button>\r\n                  </Box>\r\n\r\n                  {showSaveTemplate && (\r\n                    <Box sx={{ mb: 2, p: 2, border: '1px solid', borderColor: 'divider', borderRadius: 1 }}>\r\n                      <Typography variant=\"subtitle2\" gutterBottom>\r\n                        Save Mapping Template\r\n                      </Typography>\r\n                      <Box sx={{ display: 'flex', gap: 1 }}>\r\n                        <input\r\n                          type=\"text\"\r\n                          placeholder=\"Template name\"\r\n                          value={saveTemplateName}\r\n                          onChange={(e) => setSaveTemplateName(e.target.value)}\r\n                          style={{\r\n                            flex: 1,\r\n                            padding: '8px',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid #ccc'\r\n                          }}\r\n                        />\r\n                        <Button\r\n                          variant=\"contained\"\r\n                          size=\"small\"\r\n                          onClick={handleSaveTemplate}\r\n                          disabled={!saveTemplateName.trim()}\r\n                        >\r\n                          Save\r\n                        </Button>\r\n                      </Box>\r\n                    </Box>\r\n                  )}\r\n\r\n                  <ColumnMapper\r\n                    fileColumns={fileData.columns}\r\n                    columnMappings={columnMappings}\r\n                    sampleData={fileData.rows.slice(0, 5)}\r\n                    onMappingChange={handleMappingChange}\r\n                  />\r\n                </Box>\r\n              )}\r\n\r\n              {currentStep === 2 && validationSummary && (\r\n                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\r\n                  {/* Warning about deleting existing trades */}\r\n                  <Alert severity=\"warning\" sx={{ mb: 1 }}>\r\n                    <Typography variant=\"body2\" fontWeight={600} gutterBottom>\r\n                       Important: Importing will replace all existing trades\r\n                    </Typography>\r\n                    <Typography variant=\"body2\">\r\n                      All current trades in this calendar will be permanently deleted before importing the new trades.\r\n                      This action cannot be undone. Make sure you have a backup if needed.\r\n                    </Typography>\r\n                  </Alert>\r\n\r\n                  <ValidationSummary summary={validationSummary} />\r\n\r\n                  {validationSummary.conversions.length > 0 && (\r\n                    <TypeConverterPanel conversions={validationSummary.conversions} />\r\n                  )}\r\n\r\n                  {/* Check if trades will have pair tags for economic events */}\r\n                  {(() => {\r\n                    const hasPairTags = previewRows.some(row => {\r\n                      const tags = row.mappedData.tags || [];\r\n                      return tags.some((tag: string) => tag.toLowerCase().startsWith('pair:'));\r\n                    });\r\n\r\n                    const hasSession = previewRows.some(row => row.mappedData.session);\r\n\r\n                    if (!hasPairTags) {\r\n                      return (\r\n                        <Alert severity=\"warning\" sx={{ mb: 1 }}>\r\n                          <Typography variant=\"body2\" fontWeight={600} gutterBottom>\r\n                            Economic Events Not Available\r\n                          </Typography>\r\n                          <Typography variant=\"caption\">\r\n                            No pair tags detected in your import. Trades will be imported without economic events.\r\n                            To include economic events, ensure you have a \"Pair\" column (e.g., EURUSD, GBPJPY) mapped to \"Tags\" or \"Create Tag\".\r\n                          </Typography>\r\n                        </Alert>\r\n                      );\r\n                    } else if (!hasSession) {\r\n                      return (\r\n                        <Alert severity=\"info\" sx={{ mb: 1 }}>\r\n                          <Typography variant=\"body2\" fontWeight={600} gutterBottom>\r\n                            Partial Economic Events\r\n                          </Typography>\r\n                          <Typography variant=\"caption\">\r\n                            Pair tags detected, but no session information. Economic events will only be fetched for trades with a trading session (London, New York, Asian).\r\n                          </Typography>\r\n                        </Alert>\r\n                      );\r\n                    } else {\r\n                      return (\r\n                        <Alert severity=\"success\" sx={{ mb: 1 }}>\r\n                          <Typography variant=\"body2\" fontWeight={600} gutterBottom>\r\n                            Economic Events Will Be Fetched \r\n                          </Typography>\r\n                          <Typography variant=\"caption\">\r\n                            Trades have pair tags and session information. Relevant economic events will be automatically attached during import.\r\n                          </Typography>\r\n                        </Alert>\r\n                      );\r\n                    }\r\n                  })()}\r\n\r\n                  <ImportPreview\r\n                    previewRows={previewRows}\r\n                    mappedFields={getMappedFields() as any}\r\n                    maxRows={10}\r\n                  />\r\n                </Box>\r\n              )}\r\n            </>\r\n          )}\r\n        </DialogContent>\r\n\r\n        <DialogActions>\r\n          <Button onClick={onClose}>\r\n            Cancel\r\n          </Button>\r\n          {currentStep > 0 && (\r\n            <Button onClick={handleBack}>\r\n              Back\r\n            </Button>\r\n          )}\r\n          {currentStep < STEPS.length - 1 && (\r\n            <Button\r\n              onClick={handleNext}\r\n              variant=\"contained\"\r\n              disabled={isProcessing || !fileData}\r\n            >\r\n              Next\r\n            </Button>\r\n          )}\r\n          {currentStep === STEPS.length - 1 && (\r\n            <Button\r\n              onClick={handleImport}\r\n              variant=\"contained\"\r\n              disabled={!validationSummary || validationSummary.validRows === 0}\r\n            >\r\n              Import {validationSummary?.willImport || 0} Trades\r\n            </Button>\r\n          )}\r\n        </DialogActions>\r\n      </Dialog>\r\n\r\n      <MappingTemplateManager\r\n        open={showTemplateManager}\r\n        onClose={() => setShowTemplateManager(false)}\r\n        onApplyTemplate={handleApplyTemplate}\r\n      />\r\n\r\n      <Snackbar\r\n        open={snackbarOpen}\r\n        autoHideDuration={3000}\r\n        onClose={() => setSnackbarOpen(false)}\r\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n      >\r\n        <Alert\r\n          onClose={() => setSnackbarOpen(false)}\r\n          severity={snackbarSeverity}\r\n          variant=\"filled\"\r\n          sx={{ width: '100%' }}\r\n        >\r\n          {snackbarMessage}\r\n        </Alert>\r\n      </Snackbar>\r\n    </>\r\n  );\r\n};\r\n","import { Trade } from '../types/dualWrite';\r\nimport { TradingPattern, ScoreSettings } from '../types/score';\r\nimport {\r\n  calculateWinRate,\r\n  calculateProfitFactor\r\n} from './statsUtils';\r\nimport {\r\n  getDay,\r\n  subDays\r\n} from 'date-fns';\r\nimport {\r\n  DynamicRiskSettings,\r\n  normalizeTradeAmount\r\n} from './dynamicRiskUtils';\r\n\r\n/**\r\n * Default scoring settings\r\n */\r\nexport const DEFAULT_SCORE_SETTINGS: ScoreSettings = {\r\n  weights: {\r\n    consistency: 40,\r\n    riskManagement: 25,\r\n    performance: 20,\r\n    discipline: 15\r\n  },\r\n  thresholds: {\r\n    minTradesForScore: 3,\r\n    lookbackPeriod: 30,\r\n    consistencyTolerance: 15\r\n  },\r\n  targets: {\r\n    win_rate: 60,\r\n    profit_factor: 1.5,\r\n    max_drawdown: 5,\r\n    avgRiskReward: 2.0\r\n  },\r\n  selectedTags: [],\r\n  excludedTagsFromPatterns: []\r\n};\r\n\r\n/**\r\n * Calculate recommended score based on user's targets and settings\r\n * This provides a target score that represents good trading performance\r\n */\r\nexport const calculateRecommendedScore = (settings: ScoreSettings): number => {\r\n  // Base score calculation based on targets\r\n  // These are reasonable benchmarks for each component\r\n\r\n  // Consistency: 75% is a good target for following patterns\r\n  const consistencyTarget = 75;\r\n\r\n  // Risk Management: Based on targets, calculate expected score\r\n  const riskMgmtTarget = Math.min(85,\r\n    // Win rate factor (60% target = 75 points, 70% = 85 points)\r\n    (settings.targets.win_rate / 60) * 75 +\r\n    // Risk/reward factor (2.0 target = 10 points)\r\n    Math.min(10, (settings.targets.avgRiskReward / 2.0) * 10)\r\n  );\r\n\r\n  // Performance: Based on profit factor and win rate targets\r\n  const performanceTarget = Math.min(80,\r\n    // Profit factor contribution (1.5 target = 60 points, 2.0 = 80 points)\r\n    Math.min(60, (settings.targets.profit_factor / 1.5) * 60) +\r\n    // Win rate contribution (60% = 20 points)\r\n    Math.min(20, (settings.targets.win_rate / 60) * 20)\r\n  );\r\n\r\n  // Discipline: 70% is a reasonable target for discipline metrics\r\n  const disciplineTarget = 70;\r\n\r\n  // Calculate weighted recommended score\r\n  const recommendedScore = (\r\n    (consistencyTarget * settings.weights.consistency) +\r\n    (riskMgmtTarget * settings.weights.riskManagement) +\r\n    (performanceTarget * settings.weights.performance) +\r\n    (disciplineTarget * settings.weights.discipline)\r\n  ) / 100;\r\n\r\n  // Ensure the score is between 50-90 (reasonable range)\r\n  return Math.max(50, Math.min(90, recommendedScore));\r\n};\r\n\r\n\r\n\r\n/**\r\n * Calculate trading pattern from historical trades\r\n */\r\nexport const calculateTradingPattern = (\r\n  targetDate: Date,\r\n  trades: Trade[],\r\n  lookbackDays: number = 30,\r\n  selectedTags?: string[],\r\n  dynamicRiskSettings?: DynamicRiskSettings\r\n): TradingPattern => {\r\n  if (trades.length === 0) {\r\n    return {\r\n      preferredSessions: [],\r\n      commonTags: [],\r\n      avgTradesPerDay: 0,\r\n      avgTradesPerWeek: 0,\r\n      avgPositionSize: 0,\r\n      avgRiskReward: 0,\r\n      win_rate: 0,\r\n      profit_factor: 0,\r\n      max_drawdown: 0,\r\n      tradingDays: []\r\n    };\r\n  }\r\n\r\n  const cutoffDate = subDays(targetDate, lookbackDays);\r\n  const recentTrades = trades.filter(trade => new Date(trade.trade_date) >= cutoffDate);\r\n\r\n  // Calculate session preferences\r\n  const sessionCounts = recentTrades.reduce((acc, trade) => {\r\n    if (trade.session) {\r\n      acc[trade.session] = (acc[trade.session] || 0) + 1;\r\n    }\r\n    return acc;\r\n  }, {} as Record<string, number>); \r\n\r\n  const preferredSessions = Object.entries(sessionCounts)\r\n    .sort(([,a], [,b]) => b - a)\r\n    .slice(0, 2)\r\n    .map(([session]) => session);\r\n\r\n  // Calculate common tags (only from selected tags if provided)\r\n  const tagCounts = recentTrades.reduce((acc, trade) => {\r\n    if (trade.tags) {\r\n      trade.tags.forEach(tag => {\r\n        // Only count tags that are in selectedTags (if provided), otherwise count all tags\r\n        if (!selectedTags || selectedTags.length === 0 || selectedTags.includes(tag)) {\r\n          acc[tag] = (acc[tag] || 0) + 1;\r\n        }\r\n      });\r\n    }\r\n    return acc;\r\n  }, {} as Record<string, number>);\r\n\r\n  const commonTags = Object.entries(tagCounts)\r\n    .sort(([,a], [,b]) => b - a)\r\n    .slice(0, 5)\r\n    .map(([tag]) => tag);\r\n\r\n  // Calculate trading frequency\r\n  const tradingDays = lookbackDays;\r\n  const avgTradesPerDay = recentTrades.length / tradingDays;\r\n  const avgTradesPerWeek = avgTradesPerDay * 7;\r\n\r\n  // Calculate average position size (normalized for dynamic risk if settings provided)\r\n  const avgPositionSize = recentTrades.length > 0\r\n    ? dynamicRiskSettings\r\n      ? recentTrades.reduce((sum, trade) => sum + normalizeTradeAmount(trade, trades, dynamicRiskSettings), 0) / recentTrades.length\r\n      : Math.abs(recentTrades.reduce((sum, trade) => sum + trade.amount, 0)) / recentTrades.length\r\n    : 0;\r\n\r\n  // Calculate average risk/reward\r\n  const riskRewardTrades = recentTrades.filter(trade => trade.risk_to_reward && trade.risk_to_reward > 0);\r\n  const avgRiskReward = riskRewardTrades.length > 0\r\n    ? riskRewardTrades.reduce((sum, trade) => sum + (trade.risk_to_reward || 0), 0) / riskRewardTrades.length\r\n    : 0;\r\n\r\n  // Calculate performance metrics\r\n  const winRate = calculateWinRate(recentTrades);\r\n\r\n  // Calculate profit factor with dynamic risk normalization if available\r\n  const profitFactor = dynamicRiskSettings\r\n    ? (() => {\r\n        const normalizedTrades = recentTrades.map(trade => ({\r\n          ...trade,\r\n          amount: normalizeTradeAmount(trade, trades, dynamicRiskSettings)\r\n        }));\r\n        return calculateProfitFactor(normalizedTrades);\r\n      })()\r\n    : calculateProfitFactor(recentTrades);\r\n\r\n  // Calculate max drawdown (normalized for dynamic risk if settings provided)\r\n  let maxDrawdown = 0;\r\n  let peak = 0;\r\n  let runningPnL = 0;\r\n\r\n  recentTrades.forEach(trade => {\r\n    const tradeAmount = dynamicRiskSettings\r\n      ? normalizeTradeAmount(trade, trades, dynamicRiskSettings)\r\n      : trade.amount;\r\n    runningPnL += tradeAmount;\r\n    if (runningPnL > peak) {\r\n      peak = runningPnL;\r\n    }\r\n    const drawdown = ((peak - runningPnL) / Math.max(peak, 1)) * 100;\r\n    if (drawdown > maxDrawdown) {\r\n      maxDrawdown = drawdown;\r\n    }\r\n  });\r\n\r\n  // Calculate preferred trading days\r\n  const dayOfWeekCounts = recentTrades.reduce((acc, trade) => {\r\n    const dayOfWeek = getDay(new Date(trade.trade_date));\r\n    acc[dayOfWeek] = (acc[dayOfWeek] || 0) + 1;\r\n    return acc;\r\n  }, {} as Record<number, number>);\r\n\r\n  const tradingDaysArray = Object.entries(dayOfWeekCounts)\r\n    .filter(([, count]) => count >= avgTradesPerDay * 0.5) // Days with significant trading activity\r\n    .map(([day]) => parseInt(day))\r\n    .sort((a, b) => a - b);\r\n\r\n  return {\r\n    preferredSessions,\r\n    commonTags,\r\n    avgTradesPerDay,\r\n    avgTradesPerWeek,\r\n    avgPositionSize,\r\n    avgRiskReward,\r\n    win_rate: winRate,\r\n    profit_factor: profitFactor,\r\n    max_drawdown: maxDrawdown,\r\n    tradingDays: tradingDaysArray\r\n  };\r\n};\r\n\r\n/**\r\n * Calculate consistency score based on adherence to trading pattern\r\n */\r\nexport const calculateConsistencyScore = (\r\n  trades: Trade[],\r\n  pattern: TradingPattern,\r\n  settings: ScoreSettings,\r\n  allTrades?: Trade[],\r\n  dynamicRiskSettings?: DynamicRiskSettings\r\n): { score: number; factors: any } => {\r\n  if (trades.length < settings.thresholds.minTradesForScore) {\r\n    return {\r\n      score: 0,\r\n      factors: {\r\n        sessionConsistency: 0,\r\n        tagConsistency: 0,\r\n        timingConsistency: 0,\r\n        sizeConsistency: 0\r\n      }\r\n    };\r\n  }\r\n\r\n  // Session consistency\r\n  const sessionTrades = trades.filter(trade => trade.session);\r\n  const sessionConsistency = sessionTrades.length > 0 && pattern.preferredSessions.length > 0\r\n    ? (sessionTrades.filter(trade => pattern.preferredSessions.includes(trade.session!)).length / sessionTrades.length) * 100\r\n    : 50;\r\n\r\n  // Tag consistency\r\n  const tagTrades = trades.filter(trade => trade.tags && trade.tags.length > 0);\r\n  const tagConsistency = tagTrades.length > 0 && pattern.commonTags.length > 0\r\n    ? (tagTrades.filter(trade =>\r\n        trade.tags!.some(tag => pattern.commonTags.includes(tag))\r\n      ).length / tagTrades.length) * 100\r\n    : 50;\r\n\r\n  // Timing consistency (trading on preferred days)\r\n  const timingConsistency = trades.length > 0 && pattern.tradingDays.length > 0\r\n    ? (trades.filter(trade =>\r\n        pattern.tradingDays.includes(getDay(new Date(trade.trade_date)))\r\n      ).length / trades.length) * 100\r\n    : 50;\r\n\r\n  // Size consistency (position sizing relative to pattern, normalized for dynamic risk)\r\n  const avgTradeSize = trades.length > 0\r\n    ? (dynamicRiskSettings && allTrades\r\n      ? trades.reduce((sum, trade) => sum + normalizeTradeAmount(trade, allTrades, dynamicRiskSettings), 0) / trades.length\r\n      : Math.abs(trades.reduce((sum, trade) => sum + trade.amount, 0)) / trades.length)\r\n    : 0;\r\n  const sizeDeviation = pattern.avgPositionSize > 0\r\n    ? Math.abs(avgTradeSize - pattern.avgPositionSize) / pattern.avgPositionSize\r\n    : 0;\r\n    \r\n  const sizeConsistency = Math.max(0, 100 - (sizeDeviation * 100));\r\n\r\n  const factors = {\r\n    sessionConsistency: isNaN(sessionConsistency) ? 50 : sessionConsistency,\r\n    tagConsistency: isNaN(tagConsistency) ? 50 : tagConsistency,\r\n    timingConsistency: isNaN(timingConsistency) ? 50 : timingConsistency,\r\n    sizeConsistency: isNaN(sizeConsistency) ? 50 : sizeConsistency\r\n  };\r\n\r\n  const score = (factors.sessionConsistency + factors.tagConsistency + factors.timingConsistency + factors.sizeConsistency) / 4;\r\n\r\n  return { score: isNaN(score) ? 0 : score, factors };\r\n};\r\n\r\n/**\r\n * Calculate risk management score\r\n */\r\nexport const calculateRiskManagementScore = (\r\n  trades: Trade[],\r\n  pattern: TradingPattern,\r\n  settings: ScoreSettings,\r\n  allTrades?: Trade[],\r\n  dynamicRiskSettings?: DynamicRiskSettings\r\n): { score: number; factors: any } => {\r\n  if (trades.length < settings.thresholds.minTradesForScore) {\r\n    return {\r\n      score: 0,\r\n      factors: {\r\n        riskRewardRatio: 0,\r\n        positionSizing: 0,\r\n        maxDrawdownAdherence: 0,\r\n        stopLossUsage: 0\r\n      }\r\n    };\r\n  }\r\n\r\n  // Risk/Reward ratio adherence\r\n  const rrTrades = trades.filter(trade => trade.risk_to_reward && trade.risk_to_reward > 0);\r\n  const avgRR = rrTrades.length > 0\r\n    ? rrTrades.reduce((sum, trade) => sum + (trade.risk_to_reward || 0), 0) / rrTrades.length\r\n    : 0;\r\n  const rrDeviation = settings.targets.avgRiskReward > 0\r\n    ? Math.abs(avgRR - settings.targets.avgRiskReward) / settings.targets.avgRiskReward\r\n    : 0;\r\n  const riskRewardRatio = avgRR > 0 ? Math.max(0, 100 - (rrDeviation * 100)) : 50;\r\n\r\n  // Position sizing consistency (normalized for dynamic risk)\r\n  const tradeSizes = dynamicRiskSettings && allTrades\r\n    ? trades.map(trade => normalizeTradeAmount(trade, allTrades, dynamicRiskSettings))\r\n    : trades.map(trade => Math.abs(trade.amount));\r\n  const avgSize = tradeSizes.length > 0\r\n    ? tradeSizes.reduce((sum, size) => sum + size, 0) / tradeSizes.length\r\n    : 0;\r\n  const sizeVariance = tradeSizes.length > 0\r\n    ? tradeSizes.reduce((sum, size) => sum + Math.pow(size - avgSize, 2), 0) / tradeSizes.length\r\n    : 0;\r\n  const sizeStdDev = Math.sqrt(sizeVariance);\r\n  const positionSizing = avgSize > 0\r\n    ? Math.max(0, 100 - ((sizeStdDev / avgSize) * 100))\r\n    : 50;\r\n\r\n  // Max drawdown adherence (normalized for dynamic risk)\r\n  let maxDrawdown = 0;\r\n  let peak = 0;\r\n  let runningPnL = 0;\r\n\r\n  trades.forEach(trade => {\r\n    const tradeAmount = dynamicRiskSettings && allTrades\r\n      ? normalizeTradeAmount(trade, allTrades, dynamicRiskSettings)\r\n      : trade.amount;\r\n    runningPnL += tradeAmount;\r\n    if (runningPnL > peak) {\r\n      peak = runningPnL;\r\n    }\r\n    const drawdown = peak > 0 ? ((peak - runningPnL) / peak) * 100 : 0;\r\n    if (drawdown > maxDrawdown) {\r\n      maxDrawdown = drawdown;\r\n    }\r\n  });\r\n\r\n  const maxDrawdownAdherence = maxDrawdown <= settings.targets.max_drawdown\r\n    ? 100\r\n    : Math.max(0, 100 - ((maxDrawdown - settings.targets.max_drawdown) * 10));\r\n\r\n  // Stop loss usage (approximated by loss trades having reasonable sizes, normalized for dynamic risk)\r\n  const lossTrades = trades.filter(trade => trade.trade_type === 'loss');\r\n  const avgLoss = lossTrades.length > 0\r\n    ? (dynamicRiskSettings && allTrades\r\n      ? Math.abs(lossTrades.reduce((sum, trade) => sum + normalizeTradeAmount(trade, allTrades, dynamicRiskSettings), 0)) / lossTrades.length\r\n      : Math.abs(lossTrades.reduce((sum, trade) => sum + trade.amount, 0)) / lossTrades.length)\r\n    : 0;\r\n  const winTrades = trades.filter(trade => trade.trade_type === 'win');\r\n  const avgWin = winTrades.length > 0\r\n    ? (dynamicRiskSettings && allTrades\r\n      ? winTrades.reduce((sum, trade) => sum + normalizeTradeAmount(trade, allTrades, dynamicRiskSettings), 0) / winTrades.length\r\n      : winTrades.reduce((sum, trade) => sum + trade.amount, 0) / winTrades.length)\r\n    : 0;\r\n\r\n  const stopLossUsage = avgWin > 0 && avgLoss > 0\r\n    ? Math.min(100, (avgWin / avgLoss) * 50) // Reasonable win/loss ratio indicates stop loss usage\r\n    : 50;\r\n\r\n  const factors = {\r\n    riskRewardRatio: isNaN(riskRewardRatio) ? 50 : riskRewardRatio,\r\n    positionSizing: isNaN(positionSizing) ? 50 : positionSizing,\r\n    maxDrawdownAdherence: isNaN(maxDrawdownAdherence) ? 50 : maxDrawdownAdherence,\r\n    stopLossUsage: isNaN(stopLossUsage) ? 50 : stopLossUsage\r\n  };\r\n\r\n  const score = (factors.riskRewardRatio + factors.positionSizing + factors.maxDrawdownAdherence + factors.stopLossUsage) / 4;\r\n\r\n  return { score: isNaN(score) ? 0 : score, factors };\r\n};\r\n\r\n/**\r\n * Calculate performance score based on consistency with historical performance\r\n */\r\nexport const calculatePerformanceScore = (\r\n  trades: Trade[],\r\n  pattern: TradingPattern,\r\n  settings: ScoreSettings,\r\n  allTrades?: Trade[],\r\n  dynamicRiskSettings?: DynamicRiskSettings\r\n): { score: number; factors: any } => {\r\n  if (trades.length < settings.thresholds.minTradesForScore) {\r\n    return {\r\n      score: 0,\r\n      factors: {\r\n        winRateConsistency: 0,\r\n        profitFactorStability: 0,\r\n        returnsConsistency: 0,\r\n        volatilityControl: 0\r\n      }\r\n    };\r\n  }\r\n\r\n  const currentWinRate = calculateWinRate(trades);\r\n\r\n  // Calculate profit factor with dynamic risk normalization if available\r\n  const currentProfitFactor = dynamicRiskSettings && allTrades\r\n    ? (() => {\r\n        const normalizedTrades = trades.map(trade => ({\r\n          ...trade,\r\n          amount: normalizeTradeAmount(trade, allTrades, dynamicRiskSettings)\r\n        }));\r\n        return calculateProfitFactor(normalizedTrades);\r\n      })()\r\n    : calculateProfitFactor(trades);\r\n\r\n  // Win rate consistency\r\n  const winRateDeviation = pattern.win_rate > 0\r\n    ? Math.abs(currentWinRate - pattern.win_rate) / pattern.win_rate\r\n    : 0;\r\n  const winRateConsistency = pattern.win_rate > 0\r\n    ? Math.max(0, 100 - (winRateDeviation * 100))\r\n    : 50;\r\n\r\n  // Profit factor stability\r\n  const pfDeviation = pattern.profit_factor > 0\r\n    ? Math.abs(currentProfitFactor - pattern.profit_factor) / pattern.profit_factor\r\n    : 0;\r\n  const profitFactorStability = pattern.profit_factor > 0\r\n    ? Math.max(0, 100 - (pfDeviation * 100))\r\n    : 50;\r\n\r\n  // Returns consistency (daily returns variance, normalized for dynamic risk)\r\n  const dailyReturns = dynamicRiskSettings && allTrades\r\n    ? trades.map(trade => normalizeTradeAmount(trade, allTrades, dynamicRiskSettings))\r\n    : trades.map(trade => trade.amount);\r\n  const avgReturn = dailyReturns.length > 0\r\n    ? dailyReturns.reduce((sum, ret) => sum + ret, 0) / dailyReturns.length\r\n    : 0;\r\n  const returnVariance = dailyReturns.length > 0\r\n    ? dailyReturns.reduce((sum, ret) => sum + Math.pow(ret - avgReturn, 2), 0) / dailyReturns.length\r\n    : 0;\r\n  const returnStdDev = Math.sqrt(returnVariance);\r\n  const returnsConsistency = Math.abs(avgReturn) > 0\r\n    ? Math.max(0, 100 - ((returnStdDev / Math.abs(avgReturn)) * 50))\r\n    : 50;\r\n\r\n  // Volatility control (based on drawdown patterns, normalized for dynamic risk)\r\n  let maxDrawdown = 0;\r\n  let peak = 0;\r\n  let runningPnL = 0;\r\n\r\n  trades.forEach(trade => {\r\n    const tradeAmount = dynamicRiskSettings && allTrades\r\n      ? normalizeTradeAmount(trade, allTrades, dynamicRiskSettings)\r\n      : trade.amount;\r\n    runningPnL += tradeAmount;\r\n    if (runningPnL > peak) {\r\n      peak = runningPnL;\r\n    }\r\n    const drawdown = peak > 0 ? ((peak - runningPnL) / peak) * 100 : 0;\r\n    if (drawdown > maxDrawdown) {\r\n      maxDrawdown = drawdown;\r\n    }\r\n  });\r\n\r\n  const volatilityControl = pattern.max_drawdown > 0 && maxDrawdown <= pattern.max_drawdown * 1.2\r\n    ? 100\r\n    : pattern.max_drawdown > 0\r\n      ? Math.max(0, 100 - ((maxDrawdown - pattern.max_drawdown) * 5))\r\n      : 50;\r\n\r\n  const factors = {\r\n    winRateConsistency: isNaN(winRateConsistency) ? 50 : winRateConsistency,\r\n    profitFactorStability: isNaN(profitFactorStability) ? 50 : profitFactorStability,\r\n    returnsConsistency: isNaN(returnsConsistency) ? 50 : returnsConsistency,\r\n    volatilityControl: isNaN(volatilityControl) ? 50 : volatilityControl\r\n  };\r\n\r\n  const score = (factors.winRateConsistency + factors.profitFactorStability + factors.returnsConsistency + factors.volatilityControl) / 4;\r\n\r\n  return { score: isNaN(score) ? 0 : score, factors };\r\n};\r\n\r\n/**\r\n * Calculate discipline score based on trading behavior\r\n */\r\nexport const calculateDisciplineScore = (\r\n  trades: Trade[],\r\n  pattern: TradingPattern,\r\n  settings: ScoreSettings,\r\n  allTrades?: Trade[],\r\n  dynamicRiskSettings?: DynamicRiskSettings\r\n): { score: number; factors: any } => {\r\n  if (trades.length < settings.thresholds.minTradesForScore) {\r\n    return {\r\n      score: 0,\r\n      factors: {\r\n        tradingPlanAdherence: 0,\r\n        emotionalControl: 0,\r\n        overtrading: 0,\r\n        ruleFollowing: 0\r\n      }\r\n    };\r\n  }\r\n\r\n  // Trading plan adherence (based on session and tag consistency)\r\n  const sessionTrades = trades.filter(trade => trade.session);\r\n  const sessionAdherence = sessionTrades.length > 0 && pattern.preferredSessions.length > 0\r\n    ? (trades.filter(trade =>\r\n        trade.session && pattern.preferredSessions.includes(trade.session)\r\n      ).length / sessionTrades.length) * 100\r\n    : 50;\r\n\r\n  const tagTrades = trades.filter(trade => trade.tags && trade.tags.length > 0);\r\n  const tagAdherence = tagTrades.length > 0 && pattern.commonTags.length > 0\r\n    ? (trades.filter(trade =>\r\n        trade.tags && trade.tags.some(tag => pattern.commonTags.includes(tag))\r\n      ).length / tagTrades.length) * 100\r\n    : 50;\r\n\r\n  const tradingPlanAdherence = (sessionAdherence + tagAdherence) / 2;\r\n\r\n  // Emotional control (based on trade size consistency and revenge trading patterns, normalized for dynamic risk)\r\n  const tradeSizes = dynamicRiskSettings && allTrades\r\n    ? trades.map(trade => normalizeTradeAmount(trade, allTrades, dynamicRiskSettings))\r\n    : trades.map(trade => Math.abs(trade.amount));\r\n  const avgSize = tradeSizes.length > 0\r\n    ? tradeSizes.reduce((sum, size) => sum + size, 0) / tradeSizes.length\r\n    : 0;\r\n  const sizeVariance = tradeSizes.length > 0\r\n    ? tradeSizes.reduce((sum, size) => sum + Math.pow(size - avgSize, 2), 0) / tradeSizes.length\r\n    : 0;\r\n  const sizeCoeffVar = avgSize > 0 ? Math.sqrt(sizeVariance) / avgSize : 0;\r\n  const emotionalControl = Math.max(0, 100 - (sizeCoeffVar * 200));\r\n\r\n  // Overtrading detection\r\n  const currentFrequency = trades.length / 30; // trades per day over last 30 days\r\n  const expectedFrequency = pattern.avgTradesPerDay;\r\n  const frequencyRatio = expectedFrequency > 0\r\n    ? currentFrequency / expectedFrequency\r\n    : currentFrequency / 0.1;\r\n  const overtrading = frequencyRatio <= 1.5\r\n    ? 100\r\n    : Math.max(0, 100 - ((frequencyRatio - 1.5) * 50));\r\n\r\n  // Rule following (based on having required fields filled)\r\n  const rulesFollowed = trades.length > 0\r\n    ? (trades.filter(trade =>\r\n        trade.session &&\r\n        trade.tags &&\r\n        trade.tags.length > 0 &&\r\n        (trade.risk_to_reward || trade.trade_type === 'breakeven')\r\n      ).length / trades.length) * 100\r\n    : 0;\r\n\r\n  const factors = {\r\n    tradingPlanAdherence: isNaN(tradingPlanAdherence) ? 50 : tradingPlanAdherence,\r\n    emotionalControl: isNaN(emotionalControl) ? 50 : emotionalControl,\r\n    overtrading: isNaN(overtrading) ? 50 : overtrading,\r\n    ruleFollowing: isNaN(rulesFollowed) ? 50 : rulesFollowed\r\n  };\r\n\r\n  const score = (factors.tradingPlanAdherence + factors.emotionalControl + factors.overtrading + factors.ruleFollowing) / 4;\r\n\r\n  return { score: isNaN(score) ? 0 : score, factors };\r\n};\r\n\r\n/**\r\n * Generate recommendations based on score analysis\r\n */\r\nexport const generateRecommendations = (\r\n  breakdown: any,\r\n  pattern: TradingPattern,\r\n  tagPatternAnalysis?: any\r\n): { recommendations: string[]; strengths: string[]; weaknesses: string[] } => {\r\n  const recommendations: string[] = [];\r\n  const strengths: string[] = [];\r\n  const weaknesses: string[] = [];\r\n\r\n  // Analyze consistency\r\n  if (breakdown.consistency.score < 70) {\r\n    if (breakdown.consistency.factors.sessionConsistency < 70) {\r\n      recommendations.push(\"Focus on trading during your most profitable sessions\");\r\n      weaknesses.push(\"Inconsistent session timing\");\r\n    }\r\n    if (breakdown.consistency.factors.tagConsistency < 70) {\r\n      recommendations.push(\"Stick to your proven trading strategies and setups\");\r\n      weaknesses.push(\"Deviating from successful patterns\");\r\n    }\r\n  } else {\r\n    strengths.push(\"Consistent trading approach\");\r\n  }\r\n\r\n  // Analyze risk management\r\n  if (breakdown.riskManagement.score < 70) {\r\n    if (breakdown.riskManagement.factors.maxDrawdownAdherence < 70) {\r\n      recommendations.push(\"Reduce position sizes to control drawdown\");\r\n      weaknesses.push(\"Excessive drawdown risk\");\r\n    }\r\n    if (breakdown.riskManagement.factors.riskRewardRatio < 70) {\r\n      recommendations.push(\"Improve risk/reward ratios on your trades\");\r\n      weaknesses.push(\"Poor risk/reward management\");\r\n    }\r\n  } else {\r\n    strengths.push(\"Strong risk management\");\r\n  }\r\n\r\n  // Analyze performance\r\n  if (breakdown.performance.score < 70) {\r\n    if (breakdown.performance.factors.winRateConsistency < 70) {\r\n      recommendations.push(\"Focus on quality setups to maintain win rate\");\r\n      weaknesses.push(\"Declining win rate\");\r\n    }\r\n  } else {\r\n    strengths.push(\"Consistent performance\");\r\n  }\r\n\r\n  // Analyze discipline\r\n  if (breakdown.discipline.score < 70) {\r\n    if (breakdown.discipline.factors.overtrading < 70) {\r\n      recommendations.push(\"Reduce trading frequency and focus on quality\");\r\n      weaknesses.push(\"Overtrading detected\");\r\n    }\r\n    if (breakdown.discipline.factors.emotionalControl < 70) {\r\n      recommendations.push(\"Work on emotional control and position sizing\");\r\n      weaknesses.push(\"Emotional trading patterns\");\r\n    }\r\n  } else {\r\n    strengths.push(\"Good trading discipline\");\r\n  }\r\n\r\n  // Add tag pattern insights to recommendations\r\n  if (tagPatternAnalysis && tagPatternAnalysis.insights) {\r\n    tagPatternAnalysis.insights.slice(0, 2).forEach((insight: any) => {\r\n      if (insight.trade_type === 'high_performance') {\r\n        recommendations.push(`Focus on \"${insight.tagCombination.join(' + ')}\" pattern (${insight.win_rate.toFixed(1)}% win rate)`);\r\n        strengths.push(`Strong performance with ${insight.tagCombination.join(' + ')} combination`);\r\n      } else if (insight.trade_type === 'declining_pattern') {\r\n        recommendations.push(`Review \"${insight.tagCombination.join(' + ')}\" strategy - performance declining`);\r\n        weaknesses.push(`Declining performance in ${insight.tagCombination.join(' + ')} trades`);\r\n      }\r\n    });\r\n  }\r\n\r\n  return { recommendations, strengths, weaknesses };\r\n};\r\n","/**\r\n * Worker Manager Utility\r\n *\r\n * Provides a type-safe abstraction for Web Worker communication with:\r\n * - Promise-based request/response pattern\r\n * - Automatic cleanup and error handling\r\n * - Request timeout support\r\n */\r\n\r\nimport type { WorkerRequest, WorkerResponse } from '../types/workerMessages';\r\nimport { logger } from '../../utils/logger';\r\n\r\ninterface PendingRequest {\r\n  resolve: (value: unknown) => void;\r\n  reject: (error: Error) => void;\r\n  timeout?: NodeJS.Timeout;\r\n}\r\n\r\nexport class WorkerManager {\r\n  private worker: Worker | null = null;\r\n  private pendingRequests = new Map<string, PendingRequest>();\r\n  private messageIdCounter = 0;\r\n\r\n  constructor(private workerFactory: () => Worker) {}\r\n\r\n  /**\r\n   * Initialize the worker if not already initialized\r\n   */\r\n  private ensureWorker(): Worker {\r\n    if (!this.worker) {\r\n      this.worker = this.workerFactory();\r\n      this.worker.addEventListener('message', this.handleMessage);\r\n      this.worker.addEventListener('error', this.handleError);\r\n    }\r\n    return this.worker;\r\n  }\r\n\r\n  /**\r\n   * Handle messages from the worker\r\n   */\r\n  private handleMessage = (event: MessageEvent) => {\r\n    const response = event.data as WorkerResponse;\r\n\r\n    const pending = this.pendingRequests.get(response.id);\r\n    if (!pending) {\r\n      logger.warn('Received response for unknown request ID:', response.id);\r\n      return;\r\n    }\r\n\r\n    // Clear timeout\r\n    if (pending.timeout) {\r\n      clearTimeout(pending.timeout);\r\n    }\r\n\r\n    // Remove from pending\r\n    this.pendingRequests.delete(response.id);\r\n\r\n    // Resolve or reject based on response\r\n    if (response.error) {\r\n      const error = new Error(response.error.message);\r\n      error.stack = response.error.stack;\r\n      pending.reject(error);\r\n    } else {\r\n      pending.resolve(response.payload);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Handle worker errors\r\n   */\r\n  private handleError = (event: ErrorEvent) => {\r\n    logger.error('Worker error:', event.error);\r\n\r\n    // Reject all pending requests\r\n    this.pendingRequests.forEach(pending => {\r\n      if (pending.timeout) {\r\n        clearTimeout(pending.timeout);\r\n      }\r\n      pending.reject(new Error(`Worker error: ${event.message}`));\r\n    });\r\n\r\n    this.pendingRequests.clear();\r\n\r\n    // Terminate and null the worker so it can be recreated\r\n    this.terminate();\r\n  };\r\n\r\n  /**\r\n   * Send a request to the worker and return a Promise\r\n   */\r\n  async request<TRequest, TResponse>(\r\n    type: string,\r\n    payload: TRequest,\r\n    timeoutMs: number = 30000\r\n  ): Promise<TResponse> {\r\n    const worker = this.ensureWorker();\r\n    const id = `${type}-${++this.messageIdCounter}`;\r\n\r\n    return new Promise<TResponse>((resolve, reject) => {\r\n      // Set up timeout\r\n      const timeout = setTimeout(() => {\r\n        this.pendingRequests.delete(id);\r\n        reject(new Error(`Worker request timeout after ${timeoutMs}ms`));\r\n      }, timeoutMs);\r\n\r\n      // Store pending request\r\n      this.pendingRequests.set(id, {\r\n        resolve: resolve as (value: unknown) => void,\r\n        reject,\r\n        timeout\r\n      });\r\n\r\n      // Send message to worker\r\n      const request: WorkerRequest<TRequest> = { id, type, payload };\r\n      worker.postMessage(request);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Terminate the worker and clean up\r\n   */\r\n  terminate(): void {\r\n    if (this.worker) {\r\n      this.worker.removeEventListener('message', this.handleMessage);\r\n      this.worker.removeEventListener('error', this.handleError);\r\n      this.worker.terminate();\r\n      this.worker = null;\r\n    }\r\n\r\n    // Clear all pending requests\r\n    this.pendingRequests.forEach(pending => {\r\n      if (pending.timeout) {\r\n        clearTimeout(pending.timeout);\r\n      }\r\n      pending.reject(new Error('Worker terminated'));\r\n    });\r\n    this.pendingRequests.clear();\r\n  }\r\n\r\n  /**\r\n   * Check if worker is active\r\n   */\r\n  isActive(): boolean {\r\n    return this.worker !== null;\r\n  }\r\n}\r\n\r\n/**\r\n * Create a Worker from inline code using Blob URL\r\n * This avoids needing separate worker files and build configuration\r\n */\r\nexport function createInlineWorker(workerCode: string): Worker {\r\n  const blob = new Blob([workerCode], { type: 'application/javascript' });\r\n  const url = URL.createObjectURL(blob);\r\n  const worker = new Worker(url);\r\n\r\n  // Clean up blob URL after worker is created\r\n  // The worker keeps a reference, so this is safe\r\n  URL.revokeObjectURL(url);\r\n\r\n  return worker;\r\n}\r\n","/**\r\n * Tag Pattern Worker\r\n *\r\n * Web Worker for generating tag combinations off the main thread.\r\n * This is an O(n) operation that can block the UI with large datasets.\r\n */\r\n\r\nimport { createInlineWorker, WorkerManager } from './utils/workerManager';\r\nimport type { Trade } from '../types/dualWrite';\r\n\r\nexport interface GenerateTagCombinationsRequest {\r\n  trades: Trade[];\r\n  excludedTags?: string[];\r\n  minTrades?: number; // Minimum trades to include triple combinations\r\n}\r\n\r\nexport interface GenerateTagCombinationsResponse {\r\n  combinations: string[][];\r\n}\r\n\r\n/**\r\n * Worker code for tag pattern generation\r\n * IMPORTANT: No external dependencies, all logic inlined\r\n */\r\nconst TAG_PATTERN_WORKER_CODE = `\r\n// ============================================================================\r\n// Tag Pattern Generation\r\n// ============================================================================\r\n\r\nfunction generateTagCombinations(trades, excludedTags, minTrades) {\r\n  const allTags = new Set();\r\n  const tagPairs = new Set();\r\n  const tagTriples = new Set();\r\n\r\n  // Collect all tags and their combinations\r\n  trades.forEach(trade => {\r\n    if (trade.tags && trade.tags.length > 0) {\r\n      // Filter out system tags like Partials and excluded tags\r\n      const filteredTags = trade.tags.filter(tag =>\r\n        !tag.startsWith('Partials:') &&\r\n        (!excludedTags || !excludedTags.includes(tag))\r\n      );\r\n\r\n      // Single tags\r\n      filteredTags.forEach(tag => allTags.add(tag));\r\n\r\n      // Tag pairs\r\n      if (filteredTags.length >= 2) {\r\n        for (let i = 0; i < filteredTags.length; i++) {\r\n          for (let j = i + 1; j < filteredTags.length; j++) {\r\n            const pair = [filteredTags[i], filteredTags[j]].sort().join('|');\r\n            tagPairs.add(pair);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Tag triples (for high-volume traders)\r\n      if (filteredTags.length >= 3) {\r\n        for (let i = 0; i < filteredTags.length; i++) {\r\n          for (let j = i + 1; j < filteredTags.length; j++) {\r\n            for (let k = j + 1; k < filteredTags.length; k++) {\r\n              const triple = [filteredTags[i], filteredTags[j], filteredTags[k]].sort().join('|');\r\n              tagTriples.add(triple);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  // Convert to arrays\r\n  const combinations = [];\r\n\r\n  // Add single tags\r\n  allTags.forEach(tag => combinations.push([tag]));\r\n\r\n  // Add pairs\r\n  tagPairs.forEach(pair => combinations.push(pair.split('|')));\r\n\r\n  // Add triples (only if we have enough trades)\r\n  if (trades.length > (minTrades || 50)) {\r\n    tagTriples.forEach(triple => combinations.push(triple.split('|')));\r\n  }\r\n\r\n  return combinations;\r\n}\r\n\r\n// ============================================================================\r\n// Message Handler\r\n// ============================================================================\r\n\r\nself.addEventListener('message', (event) => {\r\n  const request = event.data;\r\n\r\n  try {\r\n    if (request.type === 'GENERATE_TAG_COMBINATIONS') {\r\n      const { trades, excludedTags, minTrades } = request.payload;\r\n\r\n      const combinations = generateTagCombinations(trades, excludedTags, minTrades);\r\n\r\n      const response = {\r\n        id: request.id,\r\n        type: request.type,\r\n        payload: { combinations }\r\n      };\r\n\r\n      self.postMessage(response);\r\n    } else {\r\n      throw new Error('Unknown request type: ' + request.type);\r\n    }\r\n  } catch (error) {\r\n    const response = {\r\n      id: request.id,\r\n      type: request.type,\r\n      error: {\r\n        message: error.message,\r\n        stack: error.stack\r\n      }\r\n    };\r\n\r\n    self.postMessage(response);\r\n  }\r\n});\r\n`;\r\n\r\n// ============================================================================\r\n// Worker Manager Instance\r\n// ============================================================================\r\n\r\nlet tagPatternWorkerManager: WorkerManager | null = null;\r\n\r\n/**\r\n * Get or create the tag pattern worker manager instance (singleton)\r\n */\r\nfunction getTagPatternWorkerManager(): WorkerManager {\r\n  if (!tagPatternWorkerManager) {\r\n    tagPatternWorkerManager = new WorkerManager(() => createInlineWorker(TAG_PATTERN_WORKER_CODE));\r\n  }\r\n  return tagPatternWorkerManager;\r\n}\r\n\r\n/**\r\n * Generate tag combinations using Web Worker\r\n */\r\nexport async function generateTagCombinationsInWorker(\r\n  trades: Trade[],\r\n  excludedTags?: string[],\r\n  minTrades?: number\r\n): Promise<string[][]> {\r\n  const manager = getTagPatternWorkerManager();\r\n\r\n  const request: GenerateTagCombinationsRequest = {\r\n    trades,\r\n    excludedTags,\r\n    minTrades\r\n  };\r\n\r\n  const response = await manager.request<\r\n    GenerateTagCombinationsRequest,\r\n    GenerateTagCombinationsResponse\r\n  >('GENERATE_TAG_COMBINATIONS', request);\r\n\r\n  return response.combinations;\r\n}\r\n\r\n/**\r\n * Terminate the tag pattern worker (cleanup)\r\n */\r\nexport function terminateTagPatternWorker(): void {\r\n  if (tagPatternWorkerManager) {\r\n    tagPatternWorkerManager.terminate();\r\n    tagPatternWorkerManager = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if tag pattern worker is active\r\n */\r\nexport function isTagPatternWorkerActive(): boolean {\r\n  return tagPatternWorkerManager?.isActive() ?? false;\r\n}\r\n","import { Trade } from '../types/dualWrite';\r\nimport { TagCombination, TagPatternInsight, TagPatternAnalysis, ScoreSettings } from '../types/score';\r\nimport { subDays, isAfter } from 'date-fns';\r\nimport { generateTagCombinationsInWorker } from '../workers/tagPatternWorker';\r\nimport { logger } from '../utils/logger';\r\n\r\n/**\r\n * Service for analyzing tag patterns and winrate trends\r\n */\r\nclass TagPatternService {\r\n  private minTradesForAnalysis = 5;\r\n  private minTradesForCombination = 3;\r\n  private recentPeriodDays = 30;\r\n  private historicalPeriodDays = 90;\r\n\r\n  /**\r\n   * Analyze tag patterns and generate insights\r\n   * Now async to support Web Worker integration\r\n   */\r\n  async analyzeTagPatterns(trades: Trade[], targetDate: Date = new Date(), settings?: ScoreSettings): Promise<TagPatternAnalysis> {\r\n    const recentCutoff = subDays(targetDate, this.recentPeriodDays);\r\n    const historicalCutoff = subDays(targetDate, this.historicalPeriodDays);\r\n\r\n    // Filter trades into recent and historical periods\r\n    const recentTrades = trades.filter(trade => isAfter(new Date(trade.trade_date), recentCutoff));\r\n    const historicalTrades = trades.filter(trade =>\r\n      isAfter(new Date(trade.trade_date), historicalCutoff) &&\r\n      !isAfter(new Date(trade.trade_date), recentCutoff)\r\n    );\r\n\r\n    // Get all tag combinations using Web Worker (excluding specified tags)\r\n    let combinations: string[][];\r\n    try {\r\n      combinations = await generateTagCombinationsInWorker(trades, settings?.excludedTagsFromPatterns);\r\n    } catch (error) {\r\n      logger.error('Tag pattern worker failed, using fallback:', error);\r\n      combinations = this.generateTagCombinations(trades, settings?.excludedTagsFromPatterns);\r\n    }\r\n\r\n    // Analyze each combination\r\n    const analyzedCombinations = combinations.map(combo =>\r\n      this.analyzeTagCombination(combo, recentTrades, historicalTrades, trades)\r\n    ).filter(combo => combo.total_trades >= this.minTradesForCombination);\r\n\r\n    // Sort by win rate and total trades\r\n    const topCombinations = [...analyzedCombinations]\r\n      .sort((a, b) => {\r\n        // Primary sort by win rate, secondary by total trades\r\n        const winRateDiff = b.win_rate - a.win_rate;\r\n        if (Math.abs(winRateDiff) < 5) { // If win rates are close, prioritize volume\r\n          return b.total_trades - a.total_trades;\r\n        }\r\n        return winRateDiff;\r\n      })\r\n      .slice(0, 10);\r\n\r\n    // Find declining combinations\r\n    const decliningCombinations = analyzedCombinations\r\n      .filter(combo => combo.trend === 'declining' && combo.total_trades >= this.minTradesForAnalysis)\r\n      .sort((a, b) => (a.recentWinRate - a.historicalWinRate) - (b.recentWinRate - b.historicalWinRate))\r\n      .slice(0, 5);\r\n\r\n    // Generate insights\r\n    const insights = this.generateInsights(topCombinations, decliningCombinations, trades);\r\n\r\n    // Generate market condition alerts\r\n    const marketConditionAlerts = this.generateMarketConditionAlerts(analyzedCombinations, trades);\r\n\r\n    return {\r\n      insights: [...insights, ...marketConditionAlerts],\r\n      topCombinations,\r\n      decliningCombinations,\r\n      marketConditionAlerts\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate all meaningful tag combinations from trades\r\n   */\r\n  private generateTagCombinations(trades: Trade[], excludedTags?: string[]): string[][] {\r\n    const allTags = new Set<string>();\r\n    const tagPairs = new Set<string>();\r\n    const tagTriples = new Set<string>();\r\n\r\n    // Collect all tags and their combinations\r\n    trades.forEach(trade => {\r\n      if (trade.tags && trade.tags.length > 0) {\r\n        // Filter out system tags like Partials and excluded tags\r\n        const filteredTags = trade.tags.filter(tag =>\r\n          !tag.startsWith('Partials:') &&\r\n          (!excludedTags || !excludedTags.includes(tag))\r\n        );\r\n        \r\n        // Single tags\r\n        filteredTags.forEach(tag => allTags.add(tag));\r\n\r\n        // Tag pairs\r\n        if (filteredTags.length >= 2) {\r\n          for (let i = 0; i < filteredTags.length; i++) {\r\n            for (let j = i + 1; j < filteredTags.length; j++) {\r\n              const pair = [filteredTags[i], filteredTags[j]].sort().join('|');\r\n              tagPairs.add(pair);\r\n            }\r\n          }\r\n        }\r\n\r\n        // Tag triples (for high-volume traders)\r\n        if (filteredTags.length >= 3) {\r\n          for (let i = 0; i < filteredTags.length; i++) {\r\n            for (let j = i + 1; j < filteredTags.length; j++) {\r\n              for (let k = j + 1; k < filteredTags.length; k++) {\r\n                const triple = [filteredTags[i], filteredTags[j], filteredTags[k]].sort().join('|');\r\n                tagTriples.add(triple);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    // Convert to arrays\r\n    const combinations: string[][] = [];\r\n    \r\n    // Add single tags\r\n    allTags.forEach(tag => combinations.push([tag]));\r\n    \r\n    // Add pairs\r\n    tagPairs.forEach(pair => combinations.push(pair.split('|')));\r\n    \r\n    // Add triples (only if we have enough trades)\r\n    if (trades.length > 50) {\r\n      tagTriples.forEach(triple => combinations.push(triple.split('|')));\r\n    }\r\n\r\n    return combinations;\r\n  }\r\n\r\n  /**\r\n   * Analyze a specific tag combination\r\n   */\r\n  private analyzeTagCombination(\r\n    tags: string[], \r\n    recentTrades: Trade[], \r\n    historicalTrades: Trade[], \r\n    allTrades: Trade[]\r\n  ): TagCombination {\r\n    // Filter trades that have all tags in the combination\r\n    const matchingTrades = allTrades.filter(trade =>\r\n      trade.tags && tags.every(tag => trade.tags!.includes(tag))\r\n    );\r\n\r\n    const recentMatchingTrades = recentTrades.filter(trade =>\r\n      trade.tags && tags.every(tag => trade.tags!.includes(tag))\r\n    );\r\n\r\n    const historicalMatchingTrades = historicalTrades.filter(trade =>\r\n      trade.tags && tags.every(tag => trade.tags!.includes(tag))\r\n    );\r\n\r\n    // Calculate overall stats\r\n    const wins = matchingTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const losses = matchingTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const totalTrades = wins + losses; // Exclude breakevens from win rate calculation\r\n    const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;\r\n    const totalPnL = matchingTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n    const avgPnL = matchingTrades.length > 0 ? totalPnL / matchingTrades.length : 0;\r\n\r\n    // Calculate recent and historical win rates\r\n    const recentWins = recentMatchingTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const recentLosses = recentMatchingTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const recentTotal = recentWins + recentLosses;\r\n    const recentWinRate = recentTotal > 0 ? (recentWins / recentTotal) * 100 : 0;\r\n\r\n    const historicalWins = historicalMatchingTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const historicalLosses = historicalMatchingTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const historicalTotal = historicalWins + historicalLosses;\r\n    const historicalWinRate = historicalTotal > 0 ? (historicalWins / historicalTotal) * 100 : 0;\r\n\r\n    // Determine trend\r\n    let trend: 'improving' | 'declining' | 'stable' = 'stable';\r\n    if (recentTotal >= 3 && historicalTotal >= 3) {\r\n      const winRateDiff = recentWinRate - historicalWinRate;\r\n      if (winRateDiff > 10) trend = 'improving';\r\n      else if (winRateDiff < -10) trend = 'declining';\r\n    }\r\n\r\n    return {\r\n      tags,\r\n      win_rate: winRate,\r\n      total_trades: matchingTrades.length,\r\n      wins,\r\n      losses,\r\n      total_pnl: totalPnL,\r\n      avgPnL,\r\n      trend,\r\n      recentWinRate,\r\n      historicalWinRate\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate insights from analyzed combinations\r\n   */\r\n  private generateInsights(\r\n    topCombinations: TagCombination[], \r\n    decliningCombinations: TagCombination[],\r\n    allTrades: Trade[]\r\n  ): TagPatternInsight[] {\r\n    const insights: TagPatternInsight[] = [];\r\n\r\n    // High performance insights\r\n    topCombinations.slice(0, 3).forEach((combo, index) => {\r\n      if (combo.win_rate > 70 && combo.total_trades >= this.minTradesForAnalysis) {\r\n        insights.push({\r\n          type: 'high_performance',\r\n          title: `High-Performance Pattern #${index + 1}`,\r\n          description: `The combination \"${combo.tags.join(' + ')}\" shows exceptional performance with ${combo.win_rate.toFixed(1)}% win rate across ${combo.total_trades} trades.`,\r\n          tagCombination: combo.tags,\r\n          win_rate: combo.win_rate,\r\n          confidence: Math.min(95, 50 + (combo.total_trades * 2)),\r\n          recommendation: `Consider focusing more on trades that match this pattern. Your success rate with \"${combo.tags.join(' + ')}\" is significantly above average.`,\r\n          severity: combo.win_rate > 80 ? 'high' : 'medium'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Declining pattern insights\r\n    decliningCombinations.forEach((combo, index) => {\r\n      const winRateDecline = combo.historicalWinRate - combo.recentWinRate;\r\n      if (winRateDecline > 15) {\r\n        insights.push({\r\n          type: 'declining_pattern',\r\n          title: `Declining Pattern Alert`,\r\n          description: `The combination \"${combo.tags.join(' + ')}\" has declined from ${combo.historicalWinRate.toFixed(1)}% to ${combo.recentWinRate.toFixed(1)}% win rate recently.`,\r\n          tagCombination: combo.tags,\r\n          win_rate: combo.recentWinRate,\r\n          confidence: Math.min(90, 40 + (combo.total_trades * 3)),\r\n          recommendation: `Review your approach with \"${combo.tags.join(' + ')}\" trades. Market conditions may have changed, requiring strategy adjustment.`,\r\n          severity: winRateDecline > 25 ? 'high' : 'medium'\r\n        });\r\n      }\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  /**\r\n   * Generate market condition alerts based on tag patterns\r\n   */\r\n  private generateMarketConditionAlerts(\r\n    combinations: TagCombination[], \r\n    allTrades: Trade[]\r\n  ): TagPatternInsight[] {\r\n    const alerts: TagPatternInsight[] = [];\r\n\r\n    // Look for session-based patterns\r\n    const sessionCombos = combinations.filter(combo => \r\n      combo.tags.some(tag => ['Asia', 'London', 'NY AM', 'NY PM'].includes(tag))\r\n    );\r\n\r\n    sessionCombos.forEach(combo => {\r\n      if (combo.trend === 'declining' && combo.total_trades >= 5) {\r\n        const sessionTag = combo.tags.find(tag => ['Asia', 'London', 'NY AM', 'NY PM'].includes(tag));\r\n        if (sessionTag) {\r\n          alerts.push({\r\n            type: 'market_condition',\r\n            title: `${sessionTag} Session Performance Decline`,\r\n            description: `Your performance during ${sessionTag} session with \"${combo.tags.filter(t => t !== sessionTag).join(' + ')}\" has declined recently.`,\r\n            tagCombination: combo.tags,\r\n            win_rate: combo.recentWinRate,\r\n            confidence: 75,\r\n            recommendation: `Consider adjusting your strategy for ${sessionTag} session or reducing position sizes during this time until performance improves.`,\r\n            severity: 'medium'\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    return alerts.slice(0, 2); // Limit to 2 alerts to avoid overwhelming\r\n  }\r\n\r\n  /**\r\n   * Get tag combination statistics for a specific combination\r\n   */\r\n  getTagCombinationStats(trades: Trade[], tags: string[]): TagCombination | null {\r\n    const recentCutoff = subDays(new Date(), this.recentPeriodDays);\r\n    const historicalCutoff = subDays(new Date(), this.historicalPeriodDays);\r\n\r\n    const recentTrades = trades.filter(trade => isAfter(new Date(trade.trade_date), recentCutoff));\r\n    const historicalTrades = trades.filter(trade => \r\n      isAfter(new Date(trade.trade_date), historicalCutoff) && \r\n      !isAfter(new Date(trade.trade_date), recentCutoff)\r\n    );\r\n\r\n    return this.analyzeTagCombination(tags, recentTrades, historicalTrades, trades);\r\n  }\r\n}\r\n\r\nexport const tagPatternService = new TagPatternService();\r\n","import { Trade } from '../types/dualWrite';\r\nimport {\r\n  ScoreMetrics,\r\n  ScoreBreakdown,\r\n  ScoreHistory,\r\n  ScoreSettings,\r\n  ScoreAnalysis\r\n} from '../types/score';\r\nimport {\r\n  DEFAULT_SCORE_SETTINGS,\r\n  calculateTradingPattern,\r\n  calculateConsistencyScore,\r\n  calculateRiskManagementScore,\r\n  calculatePerformanceScore,\r\n  calculateDisciplineScore,\r\n  generateRecommendations\r\n} from '../utils/scoreUtils';\r\nimport { DynamicRiskSettings } from '../utils/dynamicRiskUtils';\r\nimport { tagPatternService } from './tagPatternService';\r\nimport * as dateFns from 'date-fns';\r\nimport { logger } from '../utils/logger';\r\n\r\n/**\r\n * Main score calculation service\r\n */\r\nexport class ScoreService {\r\n  private settings: ScoreSettings;\r\n  private dynamicRiskSettings?: DynamicRiskSettings;\r\n\r\n  constructor(settings: ScoreSettings = DEFAULT_SCORE_SETTINGS) {\r\n    this.settings = settings;\r\n  }\r\n\r\n  /**\r\n   * Update dynamic risk settings for score calculations\r\n   */\r\n  updateDynamicRiskSettings(dynamicRiskSettings?: DynamicRiskSettings): void {\r\n    this.dynamicRiskSettings = dynamicRiskSettings;\r\n  }\r\n\r\n  /**\r\n   * Calculate comprehensive score analysis for a given period\r\n   */\r\n  async calculateScore(\r\n    allTrades: Trade[],\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly' = 'weekly',\r\n    targetDate: Date = new Date(),\r\n    scoreSettings: ScoreSettings = DEFAULT_SCORE_SETTINGS\r\n  ): Promise<ScoreAnalysis> {\r\n    // Filter trades for the target period\r\n    const periodTrades = this.getTradesForPeriod(allTrades, period, targetDate);\r\n\r\n    // Yield control to prevent UI blocking\r\n    await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n    // Calculate historical pattern from longer lookback period\r\n    const historicalTrades = this.getHistoricalTrades(allTrades, targetDate);\r\n    const pattern = calculateTradingPattern(targetDate, historicalTrades, this.settings.thresholds.lookbackPeriod, this.settings.selectedTags, this.dynamicRiskSettings);\r\n\r\n    // Yield control again\r\n    await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n    // Calculate individual score components\r\n    const consistency = calculateConsistencyScore(periodTrades, pattern, this.settings, allTrades, this.dynamicRiskSettings);\r\n    const riskManagement = calculateRiskManagementScore(periodTrades, pattern, this.settings, allTrades, this.dynamicRiskSettings);\r\n    const performance = calculatePerformanceScore(periodTrades, pattern, this.settings, allTrades, this.dynamicRiskSettings);\r\n    const discipline = calculateDisciplineScore(periodTrades, pattern, this.settings, allTrades, this.dynamicRiskSettings);\r\n\r\n    // Calculate overall score using weights\r\n    const overall = (\r\n      (consistency.score * this.settings.weights.consistency) +\r\n      (riskManagement.score * this.settings.weights.riskManagement) +\r\n      (performance.score * this.settings.weights.performance) +\r\n      (discipline.score * this.settings.weights.discipline)\r\n    ) / 100;\r\n\r\n    // Ensure overall score is not NaN\r\n    const finalOverall = isNaN(overall) ? 0 : overall;\r\n\r\n    const currentScore: ScoreMetrics = {\r\n      consistency: isNaN(consistency.score) ? 0 : consistency.score,\r\n      riskManagement: isNaN(riskManagement.score) ? 0 : riskManagement.score,\r\n      performance: isNaN(performance.score) ? 0 : performance.score,\r\n      discipline: isNaN(discipline.score) ? 0 : discipline.score,\r\n      overall: finalOverall\r\n    };\r\n\r\n    const breakdown: ScoreBreakdown = {\r\n      consistency,\r\n      riskManagement,\r\n      performance,\r\n      discipline\r\n    };\r\n\r\n    // Determine trend\r\n    const trend = this.calculateTrend(allTrades, period, targetDate);\r\n\r\n    // Calculate tag pattern analysis using Web Worker (only for sufficient data)\r\n    const tagPatternAnalysis = allTrades.length >= 10\r\n      ? await tagPatternService.analyzeTagPatterns(allTrades, targetDate, scoreSettings)\r\n      : undefined;\r\n\r\n    // Generate recommendations (including tag pattern insights)\r\n    const { recommendations, strengths, weaknesses } = generateRecommendations(breakdown, pattern, tagPatternAnalysis);\r\n\r\n    return {\r\n      currentScore,\r\n      breakdown,\r\n      pattern,\r\n      recommendations,\r\n      strengths,\r\n      weaknesses,\r\n      trend,\r\n      tagPatternAnalysis\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get score history for a range of periods\r\n   */\r\n  async getScoreHistory(\r\n    allTrades: Trade[],\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly',\r\n    periodsBack: number = 12,\r\n    scoreSettings: ScoreSettings = DEFAULT_SCORE_SETTINGS,\r\n    referenceDate: Date = new Date()\r\n  ): Promise<ScoreHistory[]> {\r\n    const history: ScoreHistory[] = [];\r\n    const today = referenceDate;\r\n\r\n    // Use dynamic threshold based on period type\r\n    // Longer periods need fewer trades per period to show meaningful data\r\n    const minTrades = period === 'monthly' || period === 'yearly'\r\n      ? 1\r\n      : this.settings.thresholds.minTradesForScore;\r\n\r\n    for (let i = 0; i < periodsBack; i++) {\r\n      let targetDate: Date;\r\n\r\n      switch (period) {\r\n        case 'daily':\r\n          targetDate = dateFns.subDays(today, i);\r\n          break;\r\n        case 'weekly':\r\n          targetDate = dateFns.subWeeks(today, i);\r\n          break;\r\n        case 'monthly':\r\n          targetDate = dateFns.subMonths(today, i);\r\n          break;\r\n        case 'yearly':\r\n          targetDate = dateFns.subYears(today, i);\r\n          break;\r\n      }\r\n\r\n      const periodTrades = this.getTradesForPeriod(allTrades, period, targetDate);\r\n\r\n      if (periodTrades.length >= minTrades) {\r\n        const analysis = await this.calculateScore(allTrades, period, targetDate, scoreSettings);\r\n\r\n        history.push({\r\n          date: targetDate,\r\n          period,\r\n          metrics: analysis.currentScore,\r\n          breakdown: analysis.breakdown,\r\n          tradeCount: periodTrades.length\r\n        });\r\n      }\r\n\r\n      // Yield control periodically to prevent UI blocking\r\n      if (i % 3 === 0) {\r\n        await new Promise(resolve => setTimeout(resolve, 0));\r\n      }\r\n    }\r\n\r\n    return history.reverse(); // Return chronological order\r\n  }\r\n\r\n  /**\r\n   * Get trades for a specific period\r\n   */\r\n  getTradesForPeriod(\r\n    trades: Trade[],\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly',\r\n    targetDate: Date\r\n  ): Trade[] {\r\n    return trades.filter(trade => {\r\n      const tradeDate = new Date(trade.trade_date);\r\n\r\n      switch (period) {\r\n        case 'daily':\r\n          return dateFns.isSameDay(tradeDate, targetDate);\r\n        case 'weekly':\r\n          return dateFns.isSameWeek(tradeDate, targetDate, { weekStartsOn: 0 });\r\n        case 'monthly':\r\n          return dateFns.isSameMonth(tradeDate, targetDate);\r\n        case 'yearly':\r\n          return dateFns.isSameYear(tradeDate, targetDate);\r\n        default:\r\n          return false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get historical trades for pattern calculation\r\n   */\r\n  private getHistoricalTrades(trades: Trade[], targetDate: Date): Trade[] {\r\n    const cutoffDate = dateFns.subDays(targetDate, this.settings.thresholds.lookbackPeriod);\r\n    return trades.filter(trade => {\r\n      const tradeDate = new Date(trade.trade_date);\r\n      return tradeDate >= cutoffDate && tradeDate <= targetDate;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Calculate trend based on recent score history\r\n   */\r\n  private calculateTrend(\r\n    allTrades: Trade[],\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly',\r\n    targetDate: Date\r\n  ): 'improving' | 'declining' | 'stable' {\r\n    try {\r\n      // Check if the target period is current or past\r\n      const now = new Date();\r\n      const isCurrentPeriod = this.isCurrentPeriod(targetDate, period, now);\r\n\r\n      // For past periods, always return 'stable' since they can't change\r\n      if (!isCurrentPeriod) {\r\n        return 'stable';\r\n      }\r\n\r\n      // Get current period trades\r\n      const currentTrades = this.getTradesForPeriod(allTrades, period, targetDate);\r\n\r\n      // Get previous period date\r\n      const previousDate = new Date(targetDate);\r\n      switch (period) {\r\n        case 'daily':\r\n          previousDate.setDate(previousDate.getDate() - 1);\r\n          break;\r\n        case 'weekly':\r\n          previousDate.setDate(previousDate.getDate() - 7);\r\n          break;\r\n        case 'monthly':\r\n          previousDate.setMonth(previousDate.getMonth() - 1);\r\n          break;\r\n        case 'yearly':\r\n          previousDate.setFullYear(previousDate.getFullYear() - 1);\r\n          break;\r\n      }\r\n\r\n      // Get previous period trades\r\n      const previousTrades = this.getTradesForPeriod(allTrades, period, previousDate);\r\n\r\n      // Need at least some trades in both periods to calculate trend\r\n      if (currentTrades.length < 2 || previousTrades.length < 2) {\r\n        return 'stable';\r\n      }\r\n\r\n      // Calculate scores for both periods (without recursion by using a simple calculation)\r\n      const currentScore = this.calculateSimpleScore(currentTrades);\r\n      const previousScore = this.calculateSimpleScore(previousTrades);\r\n\r\n      // Compare scores to determine trend\r\n      const scoreDifference = currentScore - previousScore;\r\n      const threshold = 5; // 5% threshold for trend detection\r\n\r\n      if (scoreDifference > threshold) {\r\n        return 'improving';\r\n      } else if (scoreDifference < -threshold) {\r\n        return 'declining';\r\n      } else {\r\n        return 'stable';\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error calculating trend:', error);\r\n      return 'stable';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a target date represents the current period\r\n   */\r\n  private isCurrentPeriod(\r\n    targetDate: Date,\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly',\r\n    now: Date = new Date()\r\n  ): boolean {\r\n    switch (period) {\r\n      case 'daily':\r\n        return dateFns.isSameDay(targetDate, now);\r\n      case 'weekly':\r\n        return dateFns.isSameWeek(targetDate, now, { weekStartsOn: 0 });\r\n      case 'monthly':\r\n        return dateFns.isSameMonth(targetDate, now);\r\n      case 'yearly':\r\n        return dateFns.isSameYear(targetDate, now);\r\n      default:\r\n        return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Calculate a simple overall score without trend calculation (to avoid recursion)\r\n   */\r\n  private calculateSimpleScore(trades: Trade[]): number {\r\n    if (trades.length === 0) return 0;\r\n\r\n    // Simple calculation based on win rate and average return\r\n    const wins = trades.filter(t => t.trade_type === 'win').length;\r\n    const winRate = (wins / trades.length) * 100;\r\n\r\n    const totalPnL = trades.reduce((sum, t) => sum + t.amount, 0);\r\n    const avgReturn = totalPnL / trades.length;\r\n\r\n    // Combine win rate and average return for a simple score\r\n    const returnScore = avgReturn > 0 ? Math.min(100, avgReturn * 10) : Math.max(0, 50 + avgReturn * 10);\r\n\r\n    return (winRate + returnScore) / 2;\r\n  }\r\n\r\n  /**\r\n   * Update score settings\r\n   */\r\n  updateSettings(newSettings: Partial<ScoreSettings>): void {\r\n    this.settings = { ...this.settings, ...newSettings };\r\n  }\r\n\r\n  /**\r\n   * Get current settings\r\n   */\r\n  getSettings(): ScoreSettings {\r\n    return { ...this.settings };\r\n  }\r\n\r\n  /**\r\n   * Calculate score for multiple periods at once\r\n   */\r\n  async calculateMultiPeriodScore(allTrades: Trade[], targetDate: Date = new Date(), scoreSettings: ScoreSettings = DEFAULT_SCORE_SETTINGS): Promise<{\r\n    daily: ScoreAnalysis;\r\n    weekly: ScoreAnalysis;\r\n    monthly: ScoreAnalysis;\r\n    yearly: ScoreAnalysis;\r\n  }> {\r\n    console.log('ScoreService: calculateMultiPeriodScore called', {\r\n      tradesCount: allTrades.length,\r\n      targetDate: targetDate.toISOString(),\r\n      sampleTrade: allTrades[0]\r\n    });\r\n\r\n    const [daily, weekly, monthly, yearly] = await Promise.all([\r\n      this.calculateScore(allTrades, 'daily', targetDate, scoreSettings),\r\n      this.calculateScore(allTrades, 'weekly', targetDate, scoreSettings),\r\n      this.calculateScore(allTrades, 'monthly', targetDate, scoreSettings),\r\n      this.calculateScore(allTrades, 'yearly', targetDate, scoreSettings)\r\n    ]);\r\n\r\n    console.log('ScoreService: Multi-period scores calculated', {\r\n      daily: { overall: daily.currentScore.overall, tradesCount: this.getTradesForPeriod(allTrades, 'daily', targetDate).length },\r\n      weekly: { overall: weekly.currentScore.overall, tradesCount: this.getTradesForPeriod(allTrades, 'weekly', targetDate).length },\r\n      monthly: { overall: monthly.currentScore.overall, tradesCount: this.getTradesForPeriod(allTrades, 'monthly', targetDate).length },\r\n      yearly: { overall: yearly.currentScore.overall, tradesCount: this.getTradesForPeriod(allTrades, 'yearly', targetDate).length }\r\n    });\r\n\r\n    return {\r\n      daily,\r\n      weekly,\r\n      monthly,\r\n      yearly\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get score summary for dashboard\r\n   */\r\n  async getScoreSummary(allTrades: Trade[], scoreSettings: ScoreSettings = DEFAULT_SCORE_SETTINGS): Promise<{\r\n    currentWeekly: ScoreMetrics;\r\n    trend: 'improving' | 'declining' | 'stable';\r\n    keyMetric: string;\r\n    recommendation: string;\r\n  }> {\r\n    const weeklyAnalysis = await this.calculateScore(allTrades, 'weekly', new Date(), scoreSettings);\r\n\r\n    // Find the lowest scoring component\r\n    const scores = [\r\n      { name: 'Consistency', value: weeklyAnalysis.currentScore.consistency },\r\n      { name: 'Risk Management', value: weeklyAnalysis.currentScore.riskManagement },\r\n      { name: 'Performance', value: weeklyAnalysis.currentScore.performance },\r\n      { name: 'Discipline', value: weeklyAnalysis.currentScore.discipline }\r\n    ];\r\n\r\n    const lowestScore = scores.reduce((min, score) =>\r\n      score.value < min.value ? score : min\r\n    );\r\n\r\n    const keyMetric = `${lowestScore.name}: ${lowestScore.value.toFixed(0)}%`;\r\n    const recommendation = weeklyAnalysis.recommendations[0] || \"Keep following your trading plan\";\r\n\r\n    return {\r\n      currentWeekly: weeklyAnalysis.currentScore,\r\n      trend: weeklyAnalysis.trend,\r\n      keyMetric,\r\n      recommendation\r\n    };\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const scoreService = new ScoreService();\r\n","import React from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  LinearProgress,\r\n  Chip,\r\n  Stack,\r\n  useTheme,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  TrendingUp,\r\n  TrendingDown,\r\n  TrendingFlat,\r\n  Psychology,\r\n  Shield,\r\n  Timeline,\r\n  Rule,\r\n  HelpOutline\r\n} from '@mui/icons-material';\r\nimport { ScoreMetrics } from '../../types/score';\r\n\r\ninterface ScoreCardProps {\r\n  score: ScoreMetrics;\r\n  trend: 'improving' | 'declining' | 'stable';\r\n  period: 'daily' | 'weekly' | 'monthly' | 'yearly';\r\n  compact?: boolean;\r\n}\r\n\r\nconst ScoreCard: React.FC<ScoreCardProps> = ({\r\n  score,\r\n  trend,\r\n  period,\r\n  compact = false\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  const getScoreColor = (value: number) => {\r\n    if (value >= 50) return theme.palette.success.main;\r\n    if (value >= 30) return theme.palette.warning.main;\r\n    return theme.palette.error.main;\r\n  };\r\n\r\n  const getTrendIcon = () => {\r\n    switch (trend) {\r\n      case 'improving':\r\n        return <TrendingUp sx={{ color: theme.palette.success.main }} />;\r\n      case 'declining':\r\n        return <TrendingDown sx={{ color: theme.palette.error.main }} />;\r\n      default:\r\n        return <TrendingFlat sx={{ color: theme.palette.text.secondary }} />;\r\n    }\r\n  };\r\n\r\n  const getTrendColor = () => {\r\n    switch (trend) {\r\n      case 'improving':\r\n        return theme.palette.success.main;\r\n      case 'declining':\r\n        return theme.palette.error.main;\r\n      default:\r\n        return theme.palette.text.secondary;\r\n    }\r\n  };\r\n\r\n\r\n\r\n  const ProgressBar: React.FC<{\r\n    value: number;\r\n    height: number;\r\n  }> = ({ value, height }) => (\r\n    <LinearProgress\r\n      variant=\"determinate\"\r\n      value={isNaN(value) ? 0 : value}\r\n      sx={{\r\n        height,\r\n        borderRadius: height / 2,\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.common.white, 0.1)\r\n          : theme.palette.grey[200],\r\n        '& .MuiLinearProgress-bar': {\r\n          backgroundColor: getScoreColor(value),\r\n          borderRadius: height / 2\r\n        }\r\n      }}\r\n    />\r\n  );\r\n\r\n  const getDetailedTooltip = (componentName: string): string => {\r\n    switch (componentName.toLowerCase()) {\r\n      case 'consistency':\r\n        return `Consistency Score measures how well you stick to your established trading patterns:\r\n\r\n Pattern Adherence (40%): How closely your trades match your historical successful patterns\r\n Session Consistency (30%): Trading during your most profitable time periods\r\n Strategy Consistency (30%): Using your most successful trading strategies\r\n\r\nHigher scores indicate better discipline in following proven patterns.`;\r\n\r\n      case 'risk mgmt':\r\n      case 'risk management':\r\n        return `Risk Management Score evaluates your discipline in managing risk and position sizing:\r\n\r\n Position Sizing (35%): Consistency in risk per trade vs your target\r\n Stop Loss Usage (25%): Proper use of stop losses on trades\r\n Risk/Reward Ratio (25%): Achieving your target risk/reward ratios\r\n Drawdown Control (15%): Keeping drawdowns within acceptable limits\r\n\r\nHigher scores indicate better risk control and capital preservation.`;\r\n\r\n      case 'performance':\r\n        return `Performance Score measures the consistency of your trading results vs historical patterns:\r\n\r\n Win Rate Consistency (40%): How close your win rate is to your historical average\r\n Profit Factor Stability (35%): Maintaining consistent profit factors over time\r\n Return Consistency (25%): Steady returns without extreme volatility\r\n\r\nHigher scores indicate more predictable and stable trading performance.`;\r\n\r\n      case 'discipline':\r\n        return `Discipline Score evaluates your emotional control and trading discipline:\r\n\r\n Trade Frequency (30%): Avoiding overtrading or undertrading\r\n Plan Adherence (25%): Following your predetermined trading plan\r\n Emotional Control (25%): Avoiding revenge trading and FOMO\r\n Exit Discipline (20%): Taking profits and losses according to plan\r\n\r\nHigher scores indicate better emotional control and systematic trading.`;\r\n\r\n      default:\r\n        return 'This score component measures specific aspects of your trading performance and discipline.';\r\n    }\r\n  };\r\n\r\n  const scoreComponents = [\r\n    {\r\n      name: 'Consistency',\r\n      value: score.consistency,\r\n      icon: <Rule />,\r\n      description: 'How well you stick to your trading patterns'\r\n    },\r\n    {\r\n      name: 'Risk Mgmt',\r\n      value: score.riskManagement,\r\n      icon: <Shield />,\r\n      description: 'Risk management and position sizing discipline'\r\n    },\r\n    {\r\n      name: 'Performance',\r\n      value: score.performance,\r\n      icon: <Timeline />,\r\n      description: 'Performance consistency vs historical patterns'\r\n    },\r\n    {\r\n      name: 'Discipline',\r\n      value: score.discipline,\r\n      icon: <Psychology />,\r\n      description: 'Trading discipline and emotional control'\r\n    }\r\n  ];\r\n\r\n  if (compact) {\r\n    return (\r\n      <Card\r\n        sx={{\r\n          minWidth: 200,\r\n          backgroundColor: theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.background.paper, 0.8)\r\n            : theme.palette.background.paper,\r\n          borderRadius: 2,\r\n          boxShadow: theme.shadows[2],\r\n          border: `1px solid ${theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.common.white, 0.1)\r\n            : alpha(theme.palette.common.black, 0.1)}`,\r\n          transition: 'all 0.2s ease-in-out',\r\n          '&:hover': {\r\n            transform: 'translateY(-2px)',\r\n            boxShadow: theme.shadows[4],\r\n          }\r\n        }}\r\n      >\r\n        <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>\r\n          <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={1}>\r\n            <Typography\r\n              variant=\"subtitle2\"\r\n              sx={{\r\n                color: theme.palette.text.secondary,\r\n                fontWeight: 500\r\n              }}\r\n            >\r\n              {period.charAt(0).toUpperCase() + period.slice(1)} Score\r\n            </Typography>\r\n            {getTrendIcon()}\r\n          </Stack>\r\n\r\n          <Typography\r\n            variant=\"h4\"\r\n            sx={{\r\n              color: getScoreColor(score.overall),\r\n              fontWeight: 'bold',\r\n              mb: 0.5\r\n            }}\r\n          >\r\n            {isNaN(score.overall) ? '0' : score.overall.toFixed(0)}%\r\n          </Typography>\r\n\r\n          <Typography\r\n            variant=\"caption\"\r\n            sx={{\r\n              color: getTrendColor(),\r\n              fontWeight: 500,\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 0.5,\r\n              mb: 1\r\n            }}\r\n          >\r\n            {trend.charAt(0).toUpperCase() + trend.slice(1)}\r\n          </Typography>\r\n\r\n          <ProgressBar\r\n            value={score.overall}\r\n            height={6}\r\n          />\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.background.paper, 0.8)\r\n          : theme.palette.background.paper,\r\n        borderRadius: 2,\r\n        boxShadow: theme.shadows[2],\r\n        border: `1px solid ${theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.common.white, 0.1)\r\n          : alpha(theme.palette.common.black, 0.1)}`,\r\n        transition: 'all 0.2s ease-in-out',\r\n        '&:hover': {\r\n          transform: 'translateY(-2px)',\r\n          boxShadow: theme.shadows[4],\r\n        }\r\n      }}\r\n    >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={2}>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              color: theme.palette.text.primary,\r\n              fontWeight: 600\r\n            }}\r\n          >\r\n             {period.charAt(0).toUpperCase() + period.slice(1)} Trading Score\r\n          </Typography>\r\n          <Chip\r\n            icon={getTrendIcon()}\r\n            label={trend.charAt(0).toUpperCase() + trend.slice(1)}\r\n            size=\"small\"\r\n            sx={{\r\n              backgroundColor: alpha(getTrendColor(), 0.1),\r\n              color: getTrendColor(),\r\n              fontWeight: 500,\r\n              border: `1px solid ${alpha(getTrendColor(), 0.3)}`,\r\n              '& .MuiChip-icon': {\r\n                color: getTrendColor()\r\n              }\r\n            }}\r\n          />\r\n        </Stack>\r\n\r\n        {/* Overall Score */}\r\n        <Box sx={{ textAlign: 'center', mb: 3 }}>\r\n          <Typography\r\n            variant=\"h2\"\r\n            sx={{\r\n              color: getScoreColor(score.overall),\r\n              fontWeight: 'bold',\r\n              mb: 1\r\n            }}\r\n          >\r\n            {isNaN(score.overall) ? '0' : score.overall.toFixed(0)}%\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 2 }}>\r\n            Overall Trading Score\r\n          </Typography>\r\n\r\n          <ProgressBar\r\n            value={score.overall}\r\n            height={8}\r\n          />\r\n        </Box>\r\n\r\n        {/* Component Scores */}\r\n        <Stack spacing={2}>\r\n          {scoreComponents.map((component) => (\r\n            <Box key={component.name}>\r\n              <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={0.5}>\r\n                <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\r\n                  <Box sx={{ color: theme.palette.text.secondary }}>\r\n                    {component.icon}\r\n                  </Box>\r\n                  <Typography variant=\"body2\" fontWeight=\"medium\">\r\n                    {component.name}\r\n                  </Typography>\r\n                  {(['Risk Management', 'Performance', 'Discipline'].includes(component.name)) && (\r\n                    <Tooltip\r\n                      title={\r\n                        <Box sx={{ p: 1, maxWidth: 400 }}>\r\n                          <Typography variant=\"body2\" sx={{ whiteSpace: 'pre-line' }}>\r\n                            {getDetailedTooltip(component.name)}\r\n                          </Typography>\r\n                        </Box>\r\n                      }\r\n                      placement=\"top\"\r\n                      arrow\r\n                    >\r\n                      <HelpOutline\r\n                        sx={{\r\n                          fontSize: 16,\r\n                          color: theme.palette.text.secondary,\r\n                          cursor: 'help',\r\n                          '&:hover': {\r\n                            color: theme.palette.primary.main\r\n                          }\r\n                        }}\r\n                      />\r\n                    </Tooltip>\r\n                  )}\r\n                </Stack>\r\n                <Typography\r\n                  variant=\"body2\"\r\n                  fontWeight=\"bold\"\r\n                  sx={{ color: getScoreColor(component.value) }}\r\n                >\r\n                  {isNaN(component.value) ? '0' : component.value.toFixed(0)}%\r\n                </Typography>\r\n              </Stack>\r\n              <ProgressBar\r\n                value={component.value}\r\n                height={4}\r\n              />\r\n            </Box>\r\n          ))}\r\n        </Stack>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ScoreCard;\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  Accordion,\r\n  AccordionSummary,\r\n  AccordionDetails,\r\n  LinearProgress,\r\n  Stack,\r\n  Chip,\r\n  useTheme,\r\n  Alert,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  ExpandMore,\r\n  CheckCircle,\r\n  Warning,\r\n  Error,\r\n  TrendingUp,\r\n  Psychology,\r\n  Shield,\r\n  Timeline,\r\n  Rule,\r\n  HelpOutline\r\n} from '@mui/icons-material';\r\nimport { ScoreBreakdown as ScoreBreakdownType, TradingPattern } from '../../types/score';\r\nimport { getTagChipStyles } from '../../utils/tagColors';\r\n\r\ninterface ScoreBreakdownProps {\r\n  breakdown: ScoreBreakdownType;\r\n  pattern: TradingPattern;\r\n  recommendations: string[];\r\n  strengths: string[];\r\n  weaknesses: string[];\r\n}\r\n\r\nconst ScoreBreakdown: React.FC<ScoreBreakdownProps> = ({\r\n  breakdown,\r\n  pattern,\r\n  recommendations,\r\n  strengths,\r\n  weaknesses\r\n}) => {\r\n  const theme = useTheme();\r\n  const [expanded, setExpanded] = useState<string | false>('');\r\n\r\n  const handleChange = (panel: string) => (_: React.SyntheticEvent, isExpanded: boolean) => {\r\n    setExpanded(isExpanded ? panel : false);\r\n  };\r\n\r\n  const getScoreColor = (value: number) => {\r\n    if (value >= 50) return theme.palette.success.main;\r\n    if (value >= 30) return theme.palette.warning.main;\r\n    return theme.palette.error.main;\r\n  };\r\n\r\n  const getScoreIcon = (value: number) => {\r\n    if (value >= 50) return <CheckCircle sx={{ color: theme.palette.success.main }} />;\r\n    if (value >= 30) return <Warning sx={{ color: theme.palette.warning.main }} />;\r\n    return <Error sx={{ color: theme.palette.error.main }} />;\r\n  };\r\n\r\n  const scoreCategories = [\r\n    {\r\n      id: 'consistency',\r\n      name: 'Consistency',\r\n      icon: <Rule />,\r\n      score: breakdown.consistency.score,\r\n      factors: breakdown.consistency.factors,\r\n      description: 'How well you stick to your established trading patterns'\r\n    },\r\n    {\r\n      id: 'riskManagement',\r\n      name: 'Risk Management',\r\n      icon: <Shield />,\r\n      score: breakdown.riskManagement.score,\r\n      factors: breakdown.riskManagement.factors,\r\n      description: 'Your discipline in managing risk and position sizing'\r\n    },\r\n    {\r\n      id: 'performance',\r\n      name: 'Performance',\r\n      icon: <Timeline />,\r\n      score: breakdown.performance.score,\r\n      factors: breakdown.performance.factors,\r\n      description: 'Consistency of performance vs your historical patterns'\r\n    },\r\n    {\r\n      id: 'discipline',\r\n      name: 'Discipline',\r\n      icon: <Psychology />,\r\n      score: breakdown.discipline.score,\r\n      factors: breakdown.discipline.factors,\r\n      description: 'Trading discipline and emotional control'\r\n    }\r\n  ];\r\n\r\n  const formatFactorName = (factorKey: string): string => {\r\n    return factorKey\r\n      .replace(/([A-Z])/g, ' $1')\r\n      .replace(/^./, str => str.toUpperCase())\r\n      .trim();\r\n  };\r\n\r\n  const getScoreTooltip = (categoryName: string): string => {\r\n    switch (categoryName.toLowerCase()) {\r\n      case 'consistency':\r\n        return `Consistency Score measures how well you stick to your established trading patterns:\r\n\r\n Session Consistency (25%): % of trades in your top 2 preferred sessions\r\n Tag Consistency (25%): % of trades using your top 5 common strategies\r\n Timing Consistency (25%): % of trades on your preferred trading days\r\n Size Consistency (25%): Deviation from historical average position size\r\n\r\nCalculation: Average of all four factors. Uses 30-day lookback for historical patterns.\r\nHigher scores indicate better discipline in following proven patterns.`;\r\n\r\n      case 'risk management':\r\n        return `Risk Management Score evaluates your discipline in managing risk and position sizing:\r\n\r\n Risk/Reward Ratio (25%): Deviation from target R:R settings\r\n Position Sizing (25%): Variance in trade sizes (coefficient of variation)\r\n Max Drawdown Adherence (25%): Staying within drawdown limits\r\n Stop Loss Usage (25%): Win/loss ratio indicating stop discipline\r\n\r\nCalculation: Average of all four factors. Uses normalized amounts for dynamic risk.\r\nHigher scores indicate better risk control and capital preservation.`;\r\n\r\n      case 'performance':\r\n        return `Performance Score measures the consistency of your trading results vs historical patterns:\r\n\r\n Win Rate Consistency (25%): Deviation from historical win rate\r\n Profit Factor Stability (25%): Deviation from historical profit factor\r\n Returns Consistency (25%): Variance in trade returns (coefficient of variation)\r\n Volatility Control (25%): Current vs historical maximum drawdown\r\n\r\nCalculation: Average of all four factors. Uses normalized amounts for dynamic risk.\r\nHigher scores indicate more predictable and stable trading performance.`;\r\n\r\n      case 'discipline':\r\n        return `Discipline Score evaluates your emotional control and trading discipline:\r\n\r\n Trading Plan Adherence (25%): Average of session and tag adherence\r\n Emotional Control (25%): Position size variance (coefficient of variation)\r\n Overtrading (25%): Current vs historical trading frequency\r\n Rule Following (25%): % of trades with complete data entry\r\n\r\nCalculation: Average of all four factors. Uses normalized amounts for emotional control.\r\nHigher scores indicate better emotional control and systematic trading.`;\r\n\r\n      default:\r\n        return 'This score component measures specific aspects of your trading performance and discipline.';\r\n    }\r\n  };\r\n\r\n  const getFactorTooltip = (categoryName: string, factorKey: string): string => {\r\n    if (categoryName.toLowerCase() === 'discipline') {\r\n      switch (factorKey.toLowerCase()) {\r\n        case 'overtrading':\r\n          return 'Measures if you are taking too many trades relative to your historical average.\\n\\nCalculation: Compares your current trading frequency (trades per day) to your historical pattern. Score = 100 if frequency ratio  1.5x, then decreases as ratio increases.\\n\\nHigher scores = appropriate frequency (better). Lower scores = overtrading detected (worse).';\r\n        case 'emotionalcontrol':\r\n          return 'Evaluates your ability to stick to your trading plan without letting emotions drive decisions.\\n\\nCalculation: Measures variance in your position sizes (normalized for dynamic risk). Uses coefficient of variation: StdDev/Average. Score = 100 - (coefficient  200).\\n\\nHigher scores = good emotional control (better). Lower scores = emotional trading patterns (worse).';\r\n        case 'tradingplanadhrence':\r\n        case 'tradingplanadherence':\r\n        case 'planadhrence':\r\n        case 'plan_adherence':\r\n          return 'Measures how well you follow your predetermined trading rules and strategies.\\n\\nCalculation: Average of session adherence (% of trades in your preferred sessions) and tag adherence (% of trades using your common strategies).\\n\\nHigher scores = better plan execution (better). Lower scores = poor discipline (worse).';\r\n        case 'rulefollowing':\r\n        case 'rule_following':\r\n          return 'Evaluates how consistently you fill out required trade information.\\n\\nCalculation: Percentage of trades that have session, tags, and risk/reward data filled out (breakeven trades exempt from risk/reward requirement).\\n\\nHigher scores = complete data entry (better). Lower scores = incomplete records (worse).';\r\n        case 'exitdiscipline':\r\n        case 'exit_discipline':\r\n          return 'Evaluates your ability to take profits and cut losses according to your plan.\\n\\nCalculation: Analyzes exit timing patterns and adherence to predetermined exit rules.\\n\\nHigher scores = good exit discipline (better). Lower scores = poor exit timing (worse).';\r\n        default:\r\n          return 'This factor measures a specific aspect of your trading discipline and emotional control.';\r\n      }\r\n    }\r\n\r\n    if (categoryName.toLowerCase() === 'consistency') {\r\n      switch (factorKey.toLowerCase()) {\r\n        case 'sessionconsistency':\r\n        case 'session_consistency':\r\n          return 'Measures how consistently you trade during your most profitable sessions.\\n\\nCalculation: (Trades in preferred sessions / Total trades with session data)  100. Preferred sessions are your top 2 most-traded sessions from historical data.\\n\\nHigher scores = better session discipline (better). Lower scores = inconsistent timing (worse).';\r\n        case 'tagconsistency':\r\n        case 'tag_consistency':\r\n          return 'Evaluates how consistently you use your most successful trading strategies and setups.\\n\\nCalculation: (Trades using common tags / Total trades with tags)  100. Common tags are your top 5 most-used strategy tags from historical data.\\n\\nHigher scores = sticking to proven patterns (better). Lower scores = random experimentation (worse).';\r\n        case 'timingconsistency':\r\n        case 'timing_consistency':\r\n          return 'Measures how consistently you trade on your preferred days of the week.\\n\\nCalculation: (Trades on preferred days / Total trades)  100. Preferred days are determined from your historical trading pattern (days with significant activity).\\n\\nHigher scores = following established schedule (better). Lower scores = impulsive trading (worse).';\r\n        case 'sizeconsistency':\r\n        case 'size_consistency':\r\n          return 'Evaluates the consistency of your position sizes relative to your historical average.\\n\\nCalculation: Compares current average trade size to historical pattern. Score = 100 - (deviation percentage  100). Uses normalized amounts for dynamic risk.\\n\\nHigher scores = disciplined sizing (better). Lower scores = emotional deviations (worse).';\r\n        default:\r\n          return 'This factor measures a specific aspect of your trading consistency and pattern adherence.';\r\n      }\r\n    }\r\n\r\n    if (categoryName.toLowerCase() === 'risk management') {\r\n      switch (factorKey.toLowerCase()) {\r\n        case 'riskrewardratio':\r\n        case 'risk_reward_ratio':\r\n          return 'Measures how well your actual risk/reward ratios match your target settings.\\n\\nCalculation: Compares average R:R of trades with R:R data to your target R:R setting. Score = 100 - (deviation percentage  100).\\n\\nHigher scores = better adherence to targets (better). Lower scores = deviation from targets (worse).';\r\n        case 'positionsizing':\r\n        case 'position_sizing':\r\n          return 'Measures how consistent your trade sizes are relative to each other.\\n\\nCalculation: Uses coefficient of variation (StdDev/Average) of trade sizes. Score = 100 - (coefficient  100). Uses normalized amounts for dynamic risk.\\n\\nHigher scores = consistent position sizing (better risk control). Lower scores = highly variable trade sizes (poor risk management).';\r\n        case 'maxdrawdownadherence':\r\n        case 'max_drawdown_adherence':\r\n          return 'Measures how well you stay within your maximum drawdown limits.\\n\\nCalculation: Tracks running P&L to find maximum drawdown percentage. Score = 100 if  target, then decreases by 10 points per 1% over target. Uses normalized amounts for dynamic risk.\\n\\nHigher scores = better capital preservation (better). Lower scores = excessive drawdown risk (worse).';\r\n        case 'stoplossusage':\r\n        case 'stop_loss_usage':\r\n          return 'Approximates your use of stop losses by analyzing the ratio between average wins and losses.\\n\\nCalculation: (Average win / Average loss)  50, capped at 100. Uses normalized amounts for dynamic risk. Assumes good stop loss discipline creates reasonable win/loss ratios.\\n\\nHigher scores = better stop loss discipline (better). Lower scores = poor risk control (worse).';\r\n        default:\r\n          return 'This factor measures a specific aspect of your risk management and capital preservation.';\r\n      }\r\n    }\r\n\r\n    if (categoryName.toLowerCase() === 'performance') {\r\n      switch (factorKey.toLowerCase()) {\r\n        case 'winrateconsistency':\r\n        case 'win_rate_consistency':\r\n          return 'Measures how consistent your current win rate is compared to your historical average.\\n\\nCalculation: Compares current win rate (wins/total trades) to historical pattern. Score = 100 - (deviation percentage  100).\\n\\nHigher scores = maintaining consistent win rate (better). Lower scores = declining or volatile win rate (worse).';\r\n        case 'profitfactorstability':\r\n        case 'profit_factor_stability':\r\n          return 'Evaluates how stable your profit factor is compared to your historical pattern.\\n\\nCalculation: Profit factor = Total profits / Total losses. Compares current to historical pattern. Score = 100 - (deviation percentage  100). Uses normalized amounts for dynamic risk.\\n\\nHigher scores = stable profitability (better). Lower scores = declining profit factor (worse).';\r\n        case 'returnsconsistency':\r\n        case 'returns_consistency':\r\n          return 'Measures the consistency of your trade returns by analyzing the variance in your trade amounts.\\n\\nCalculation: Uses coefficient of variation (StdDev/Average) of trade returns. Score = 100 - (coefficient  50). Uses normalized amounts for dynamic risk.\\n\\nHigher scores = consistent returns (better). Lower scores = erratic performance (worse).';\r\n        case 'volatilitycontrol':\r\n        case 'volatility_control':\r\n          return 'Evaluates your ability to control drawdowns and maintain stable equity curves compared to your historical patterns.\\n\\nCalculation: Compares current maximum drawdown to historical pattern. Score = 100 if within 120% of historical, then decreases by 5 points per 1% excess. Uses normalized amounts for dynamic risk.\\n\\nHigher scores = good volatility control (better). Lower scores = excessive volatility (worse).';\r\n        default:\r\n          return 'This factor measures a specific aspect of your trading performance consistency.';\r\n      }\r\n    }\r\n\r\n    return 'This factor contributes to your overall score in this category.';\r\n  };\r\n\r\n  return (\r\n    <Card\r\n        sx={{\r\n          backgroundColor: theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.background.paper, 0.8)\r\n            : theme.palette.background.paper,\r\n          borderRadius: 2,\r\n          boxShadow: theme.shadows[2],\r\n          border: `1px solid ${theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.common.white, 0.1)\r\n            : alpha(theme.palette.common.black, 0.1)}`\r\n        }}\r\n      >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Typography\r\n          variant=\"h6\"\r\n          gutterBottom\r\n          sx={{\r\n            color: theme.palette.text.primary,\r\n            fontWeight: 600,\r\n            mb: 3\r\n          }}\r\n        >\r\n           Score Breakdown & Analysis\r\n        </Typography>\r\n\r\n        {/* Recommendations and Insights */}\r\n        <Stack spacing={2} mb={3}>\r\n          {recommendations.length > 0 && (\r\n            <Alert severity=\"info\" icon={<TrendingUp />}>\r\n              <Typography variant=\"subtitle2\" gutterBottom>\r\n                Key Recommendations\r\n              </Typography>\r\n              <List dense>\r\n                {recommendations.slice(0, 3).map((rec, index) => (\r\n                  <ListItem key={index} sx={{ py: 0 }}>\r\n                    <ListItemText primary={rec} />\r\n                  </ListItem>\r\n                ))}\r\n              </List>\r\n            </Alert>\r\n          )}\r\n\r\n          {strengths.length > 0 && (\r\n            <Alert severity=\"success\" icon={<CheckCircle />}>\r\n              <Typography variant=\"subtitle2\" gutterBottom>\r\n                Your Strengths\r\n              </Typography>\r\n              <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n                {strengths.map((strength, index) => (\r\n                  <Chip\r\n                    key={index}\r\n                    label={strength}\r\n                    size=\"small\"\r\n                    color=\"success\"\r\n                    variant=\"outlined\"\r\n                  />\r\n                ))}\r\n              </Box>\r\n            </Alert>\r\n          )}\r\n\r\n          {weaknesses.length > 0 && (\r\n            <Alert severity=\"warning\" icon={<Warning />}>\r\n              <Typography variant=\"subtitle2\" gutterBottom>\r\n                Areas for Improvement\r\n              </Typography>\r\n              <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n                {weaknesses.map((weakness, index) => (\r\n                  <Chip\r\n                    key={index}\r\n                    label={weakness}\r\n                    size=\"small\"\r\n                    color=\"warning\"\r\n                    variant=\"outlined\"\r\n                  />\r\n                ))}\r\n              </Box>\r\n            </Alert>\r\n          )}\r\n        </Stack>\r\n\r\n        {/* Detailed Score Breakdown */}\r\n        <Typography variant=\"subtitle1\" gutterBottom sx={{ mt: 2 }}>\r\n          Detailed Analysis\r\n        </Typography>\r\n\r\n        {scoreCategories.map((category) => (\r\n          <Box\r\n            key={category.id}\r\n            sx={{\r\n              backgroundColor: theme.palette.mode === 'dark'\r\n                ? alpha(theme.palette.background.paper, 0.6)\r\n                : alpha(theme.palette.background.paper, 0.8),\r\n              borderRadius: 3,\r\n              border: `1px solid ${theme.palette.mode === 'dark'\r\n                ? alpha(theme.palette.common.white, 0.1)\r\n                : alpha(theme.palette.common.black, 0.1)}`,\r\n              overflow: 'hidden',\r\n              transition: 'all 0.2s ease-in-out',\r\n              mb: 2,\r\n              '&:hover': {\r\n                transform: 'translateY(-1px)',\r\n                boxShadow: theme.shadows[3],\r\n              }\r\n            }}\r\n          >\r\n            <Accordion\r\n              expanded={expanded === category.id}\r\n              onChange={handleChange(category.id)}\r\n              sx={{\r\n                backgroundColor: 'transparent',\r\n                boxShadow: 'none',\r\n                '&:before': { display: 'none' },\r\n                '& .MuiAccordionSummary-root': {\r\n                  borderRadius: 3,\r\n                }\r\n              }}\r\n            >\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Stack direction=\"row\" alignItems=\"center\" spacing={2} sx={{ width: '100%' }}>\r\n                <Box sx={{ color: theme.palette.text.secondary }}>\r\n                  {category.icon}\r\n                </Box>\r\n                <Box sx={{ flexGrow: 1 }}>\r\n                  <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\r\n                    <Typography variant=\"subtitle2\" fontWeight=\"medium\">\r\n                      {category.name}\r\n                    </Typography>\r\n                    {(['Risk Management', 'Performance', 'Discipline'].includes(category.name)) && (\r\n                      <Tooltip\r\n                        title={\r\n                          <Box sx={{ p: 1, maxWidth: 400 }}>\r\n                            <Typography variant=\"body2\" sx={{ whiteSpace: 'pre-line' }}>\r\n                              {getScoreTooltip(category.name)}\r\n                            </Typography>\r\n                          </Box>\r\n                        }\r\n                        placement=\"top\"\r\n                        arrow\r\n                      >\r\n                        <HelpOutline\r\n                          sx={{\r\n                            fontSize: 16,\r\n                            color: theme.palette.text.secondary,\r\n                            cursor: 'help',\r\n                            '&:hover': {\r\n                              color: theme.palette.primary.main\r\n                            }\r\n                          }}\r\n                        />\r\n                      </Tooltip>\r\n                    )}\r\n                  </Stack>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    {category.description}\r\n                  </Typography>\r\n                </Box>\r\n                <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\r\n                  {getScoreIcon(category.score)}\r\n                  <Typography\r\n                    variant=\"h6\"\r\n                    sx={{ color: getScoreColor(category.score), fontWeight: 'bold' }}\r\n                  >\r\n                    {isNaN(category.score) ? '0' : category.score.toFixed(0)}%\r\n                  </Typography>\r\n                </Stack>\r\n              </Stack>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Stack spacing={2}>\r\n                <LinearProgress\r\n                  variant=\"determinate\"\r\n                  value={isNaN(category.score) ? 0 : category.score}\r\n                  sx={{\r\n                    height: 8,\r\n                    borderRadius: 4,\r\n                    backgroundColor: theme.palette.mode === 'dark'\r\n                      ? alpha(theme.palette.common.white, 0.1)\r\n                      : theme.palette.grey[200],\r\n                    '& .MuiLinearProgress-bar': {\r\n                      backgroundColor: getScoreColor(category.score),\r\n                      borderRadius: 4\r\n                    }\r\n                  }}\r\n                />\r\n                \r\n                <Typography variant=\"body2\" color=\"text.secondary\" gutterBottom>\r\n                  Factor Breakdown:\r\n                </Typography>\r\n                \r\n                <Stack spacing={1}>\r\n                  {Object.entries(category.factors).map(([factorKey, factorValue]) => (\r\n                    <Box key={factorKey}>\r\n                      <Stack direction=\"row\" justifyContent=\"space-between\" alignItems=\"center\" mb={0.5}>\r\n                        <Stack direction=\"row\" alignItems=\"center\" spacing={1}>\r\n                          <Typography variant=\"body2\">\r\n                            {formatFactorName(factorKey)}\r\n                          </Typography>\r\n                          {(['discipline', 'risk management', 'consistency', 'performance'].includes(category.name.toLowerCase())) && (\r\n                            <Tooltip\r\n                              title={\r\n                                <Box sx={{ p: 1, maxWidth: 300 }}>\r\n                                  <Typography variant=\"body2\">\r\n                                    {getFactorTooltip(category.name, factorKey)}\r\n                                  </Typography>\r\n                                </Box>\r\n                              }\r\n                              placement=\"top\"\r\n                              arrow\r\n                            >\r\n                              <HelpOutline\r\n                                sx={{\r\n                                  fontSize: 14,\r\n                                  color: theme.palette.text.secondary,\r\n                                  cursor: 'help',\r\n                                  '&:hover': {\r\n                                    color: theme.palette.primary.main\r\n                                  }\r\n                                }}\r\n                              />\r\n                            </Tooltip>\r\n                          )}\r\n                        </Stack>\r\n                        <Typography\r\n                          variant=\"body2\"\r\n                          fontWeight=\"medium\"\r\n                          sx={{ color: getScoreColor(factorValue as number) }}\r\n                        >\r\n                          {isNaN(factorValue as number) ? '0' : (factorValue as number).toFixed(0)}%\r\n                        </Typography>\r\n                      </Stack>\r\n                      <LinearProgress\r\n                        variant=\"determinate\"\r\n                        value={isNaN(factorValue as number) ? 0 : (factorValue as number)}\r\n                        sx={{\r\n                          height: 4,\r\n                          borderRadius: 2,\r\n                          backgroundColor: theme.palette.mode === 'dark'\r\n                            ? alpha(theme.palette.common.white, 0.1)\r\n                            : theme.palette.grey[200],\r\n                          '& .MuiLinearProgress-bar': {\r\n                            backgroundColor: getScoreColor(factorValue as number),\r\n                            borderRadius: 2\r\n                          }\r\n                        }}\r\n                      />\r\n                    </Box>\r\n                  ))}\r\n                </Stack>\r\n              </Stack>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n          </Box>\r\n        ))}\r\n\r\n        {/* Trading Pattern Summary */}\r\n        <Box\r\n          sx={{\r\n            mt: 3,\r\n            p: 2,\r\n            backgroundColor: theme.palette.mode === 'dark'\r\n              ? alpha(theme.palette.background.paper, 0.4)\r\n              : theme.palette.grey[50],\r\n            borderRadius: 2,\r\n            border: `1px solid ${theme.palette.mode === 'dark'\r\n              ? alpha(theme.palette.common.white, 0.1)\r\n              : alpha(theme.palette.common.black, 0.1)}`\r\n          }}\r\n        >\r\n          <Stack direction=\"row\" alignItems=\"center\" spacing={1} sx={{ mb: 1 }}>\r\n            <Typography\r\n              variant=\"subtitle2\"\r\n              sx={{\r\n                color: theme.palette.text.primary,\r\n                fontWeight: 600\r\n              }}\r\n            >\r\n               Your Trading Pattern\r\n            </Typography>\r\n            <Tooltip\r\n              title={\r\n                <Box sx={{ p: 1, maxWidth: 380 }}>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1, fontWeight: 600 }}>\r\n                    How Your Trading Pattern is Established:\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                     <strong>Preferred Sessions:</strong> Your top 2 most frequently traded sessions based on historical data\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                     <strong>Common Strategies:</strong> Your top 5 most-used tags/strategies from past trades\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                     <strong>Trading Frequency:</strong> Average trades per week calculated from your trading history\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                     <strong>Win Rate & Profit Factor:</strong> Historical averages used as benchmarks for consistency scoring\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 1, color: 'warning.main' }}>\r\n                     <strong>Lookback Period:</strong> Pattern is based on trades from the last 30 days to reflect your current trading style\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ fontStyle: 'italic', mt: 1 }}>\r\n                    Patterns are automatically updated as you add more trades. Requires minimum 3 trades for reliable pattern detection.\r\n                  </Typography>\r\n                </Box>\r\n              }\r\n              placement=\"top\"\r\n              arrow\r\n            >\r\n              <HelpOutline\r\n                sx={{\r\n                  fontSize: 18,\r\n                  color: theme.palette.text.secondary,\r\n                  cursor: 'help',\r\n                  '&:hover': {\r\n                    color: theme.palette.primary.main\r\n                  }\r\n                }}\r\n              />\r\n            </Tooltip>\r\n          </Stack>\r\n          <Stack spacing={1}>\r\n            <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary }}>\r\n              <strong style={{ color: theme.palette.text.primary }}>Preferred Sessions:</strong> {pattern.preferredSessions.join(', ') || 'Not established'}\r\n            </Typography>\r\n            <Box>\r\n              <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary, mb: 1 }}>\r\n                <strong style={{ color: theme.palette.text.primary }}>Common Strategies:</strong>\r\n              </Typography>\r\n              {pattern.commonTags.length > 0 ? (\r\n                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n                  {pattern.commonTags.slice(0, 5).map((tag, index) => (\r\n                    <Chip\r\n                      key={index}\r\n                      label={tag}\r\n                      size=\"small\"\r\n                      sx={getTagChipStyles(tag, theme)}\r\n                    />\r\n                  ))}\r\n                </Box>\r\n              ) : (\r\n                <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary, fontStyle: 'italic' }}>\r\n                  Not established\r\n                </Typography>\r\n              )}\r\n            </Box>\r\n            <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary }}>\r\n              <strong style={{ color: theme.palette.text.primary }}>Trading Frequency:</strong> {isNaN(pattern.avgTradesPerWeek) ? '0.0' : pattern.avgTradesPerWeek.toFixed(1)} trades/week\r\n            </Typography>\r\n            <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary }}>\r\n              <strong style={{ color: theme.palette.text.primary }}>Win Rate:</strong> {isNaN(pattern.win_rate) ? '0.0' : pattern.win_rate.toFixed(1)}%\r\n            </Typography>\r\n            <Typography variant=\"body2\" sx={{ color: theme.palette.text.secondary }}>\r\n              <strong style={{ color: theme.palette.text.primary }}>Profit Factor:</strong> {isNaN(pattern.profit_factor) ? '0.00' : pattern.profit_factor.toFixed(2)}\r\n            </Typography>\r\n          </Stack>\r\n        </Box>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ScoreBreakdown;\r\n","import React, { useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  useTheme,\r\n  Stack,\r\n  LinearProgress\r\n} from '@mui/material';\r\nimport { useMediaQuery } from '@mui/material';\r\n\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  LineChart,\r\n  Line,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  Legend,\r\n  Area,\r\n  AreaChart\r\n} from 'recharts';\r\nimport { format } from 'date-fns';\r\nimport { ScoreHistory as ScoreHistoryType } from '../../types/score';\r\nimport RoundedTabs from '../common/RoundedTabs';\r\n\r\ninterface ScoreHistoryProps {\r\n  history: ScoreHistoryType[];\r\n  period: 'daily' | 'weekly' | 'monthly' | 'yearly';\r\n  onPeriodChange: (period: 'daily' | 'weekly' | 'monthly' | 'yearly') => void;\r\n  availablePeriods?: ('daily' | 'weekly' | 'monthly' | 'yearly')[]; // Available periods based on parent time filter\r\n  isLoading?: boolean; // Loading state for showing progress indicator\r\n}\r\n\r\nconst ScoreHistoryComponent: React.FC<ScoreHistoryProps> = ({\r\n  history,\r\n  period,\r\n  onPeriodChange,\r\n  availablePeriods = ['daily', 'weekly', 'monthly', 'yearly'], // Default to all periods\r\n  isLoading = false\r\n}) => {\r\n  const theme = useTheme();\r\n  const isXs = useMediaQuery(theme.breakpoints.down('sm'));\r\n\r\n  // Define all possible period tabs\r\n  const allPeriodTabs = [\r\n    { label: 'Daily', value: 'daily' },\r\n    { label: 'Weekly', value: 'weekly' },\r\n    { label: 'Monthly', value: 'monthly' },\r\n    { label: 'Yearly', value: 'yearly' }\r\n  ];\r\n\r\n  // Filter tabs based on available periods\r\n  const periodTabs = useMemo(() => {\r\n    return allPeriodTabs.filter(tab => availablePeriods.includes(tab.value as any));\r\n  }, [availablePeriods]);\r\n\r\n  // Convert string value to tab index for RoundedTabs\r\n  const getPeriodTabIndex = (currentPeriod: string): number => {\r\n    return periodTabs.findIndex(tab => tab.value === currentPeriod);\r\n  };\r\n\r\n  // Handle tab change for period\r\n  const handlePeriodTabChange = (_: React.SyntheticEvent, newIndex: number) => {\r\n    const newPeriod = periodTabs[newIndex]?.value as 'daily' | 'weekly' | 'monthly' | 'yearly';\r\n    if (newPeriod) {\r\n      onPeriodChange(newPeriod);\r\n    }\r\n  };\r\n\r\n  const chartData = useMemo(() => {\r\n    return history.map(entry => ({\r\n      date: entry.date,\r\n      dateLabel: format(entry.date,\r\n        period === 'daily' ? 'MMM dd' :\r\n        period === 'weekly' ? 'MMM dd' :\r\n        period === 'monthly' ? 'MMM yyyy' :\r\n        'yyyy'\r\n      ),\r\n      overall: entry.metrics.overall,\r\n      consistency: entry.metrics.consistency,\r\n      riskManagement: entry.metrics.riskManagement,\r\n      performance: entry.metrics.performance,\r\n      discipline: entry.metrics.discipline,\r\n      tradeCount: entry.tradeCount\r\n    }));\r\n  }, [history, period]);\r\n\r\n  const getScoreColor = (value: number) => {\r\n    if (value >= 50) return theme.palette.success.main;\r\n    if (value >= 30) return theme.palette.warning.main;\r\n    return theme.palette.error.main;\r\n  };\r\n\r\n  const CustomTooltip = ({ active, payload, label }: any) => {\r\n    if (active && payload && payload.length) {\r\n      const data = payload[0].payload;\r\n      return (\r\n        <Box\r\n          sx={{\r\n            backgroundColor: theme.palette.mode === 'dark'\r\n              ? alpha(theme.palette.background.paper, 0.95)\r\n              : theme.palette.background.paper,\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            borderRadius: 2,\r\n            p: 2,\r\n            boxShadow: theme.shadows[8],\r\n            backdropFilter: 'blur(10px)'\r\n          }}\r\n        >\r\n          <Typography variant=\"subtitle2\" gutterBottom>\r\n            {label}\r\n          </Typography>\r\n          <Stack spacing={0.5}>\r\n            <Typography variant=\"body2\">\r\n              <strong>Overall Score:</strong> {data.overall.toFixed(0)}%\r\n            </Typography>\r\n            <Typography variant=\"body2\">\r\n              <strong>Trades:</strong> {data.tradeCount}\r\n            </Typography>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Consistency: {data.consistency.toFixed(0)}%\r\n            </Typography>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Risk Mgmt: {data.riskManagement.toFixed(0)}%\r\n            </Typography>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Performance: {data.performance.toFixed(0)}%\r\n            </Typography>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Discipline: {data.discipline.toFixed(0)}%\r\n            </Typography>\r\n          </Stack>\r\n        </Box>\r\n      );\r\n    }\r\n    return null;\r\n  };\r\n\r\n  const averageScore = useMemo(() => {\r\n    if (chartData.length === 0) return 0;\r\n    return chartData.reduce((sum, entry) => sum + entry.overall, 0) / chartData.length;\r\n  }, [chartData]);\r\n\r\n  const latestScore = chartData.length > 0 ? chartData[chartData.length - 1].overall : 0;\r\n  const scoreChange = chartData.length > 1\r\n    ? latestScore - chartData[chartData.length - 2].overall\r\n    : 0;\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.background.paper, 0.8)\r\n          : theme.palette.background.paper,\r\n        borderRadius: 2,\r\n        boxShadow: theme.shadows[2],\r\n        border: `1px solid ${theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.common.white, 0.1)\r\n          : alpha(theme.palette.common.black, 0.1)}`\r\n      }}\r\n    >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={3}>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              color: theme.palette.text.primary,\r\n              fontWeight: 600\r\n            }}\r\n          >\r\n             Score History\r\n          </Typography>\r\n\r\n          <RoundedTabs\r\n            tabs={periodTabs}\r\n            activeTab={getPeriodTabIndex(period)}\r\n            onTabChange={handlePeriodTabChange}\r\n            size=\"small\"\r\n          />\r\n        </Stack>\r\n\r\n        {isLoading && (\r\n          <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', mb: 2 }}>\r\n            <LinearProgress\r\n              sx={{\r\n                width: { xs: '100%', sm: 'auto' },\r\n                minWidth: { sm: 200 },\r\n                borderRadius: 1,\r\n                mb: 0.5\r\n              }}\r\n            />\r\n            <Typography\r\n              variant=\"caption\"\r\n              sx={{\r\n                color: 'text.secondary',\r\n                fontSize: '0.7rem'\r\n              }}\r\n            >\r\n              Loading...\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n\r\n        {chartData.length === 0 ? (\r\n          <Box sx={{ textAlign: 'center', py: 4 }}>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Not enough data for {period} score history.\r\n              <br />\r\n              Complete more trades to see your score trends.\r\n            </Typography>\r\n          </Box>\r\n        ) : (\r\n          <>\r\n            {/* Summary Stats */}\r\n            <Stack direction={{ xs: 'column', sm: 'row' }} spacing={3} mb={3}>\r\n              <Box>\r\n                <Typography variant=\"h4\" sx={{ color: getScoreColor(latestScore), fontWeight: 'bold' }}>\r\n                  {latestScore.toFixed(0)}%\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  Latest Score\r\n                </Typography>\r\n              </Box>\r\n              <Box>\r\n                <Typography\r\n                  variant=\"h4\"\r\n                  sx={{\r\n                    color: scoreChange >= 0 ? theme.palette.success.main : theme.palette.error.main,\r\n                    fontWeight: 'bold'\r\n                  }}\r\n                >\r\n                  {scoreChange >= 0 ? '+' : ''}{scoreChange.toFixed(0)}%\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  Change\r\n                </Typography>\r\n              </Box>\r\n              <Box>\r\n                <Typography variant=\"h4\" sx={{ color: theme.palette.text.primary, fontWeight: 'bold' }}>\r\n                  {averageScore.toFixed(0)}%\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  Average\r\n                </Typography>\r\n              </Box>\r\n            </Stack>\r\n\r\n            {/* Main Chart */}\r\n            <Box sx={{ height: { xs: 220, sm: 300 }, mb: 2 }}>\r\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                <AreaChart data={chartData}>\r\n                  <defs>\r\n                    <linearGradient id=\"overallGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                      <stop offset=\"5%\" stopColor={theme.palette.primary.main} stopOpacity={theme.palette.mode === 'dark' ? 0.4 : 0.3}/>\r\n                      <stop offset=\"95%\" stopColor={theme.palette.primary.main} stopOpacity={0}/>\r\n                    </linearGradient>\r\n                  </defs>\r\n                  <CartesianGrid\r\n                    strokeDasharray=\"3 3\"\r\n                    stroke={theme.palette.mode === 'dark'\r\n                      ? alpha(theme.palette.common.white, 0.1)\r\n                      : theme.palette.divider\r\n                    }\r\n                  />\r\n                  <XAxis\r\n                    dataKey=\"dateLabel\"\r\n                    stroke={theme.palette.text.secondary}\r\n                    fontSize={12}\r\n                    tick={{ fill: theme.palette.text.secondary }}\r\n                  />\r\n                  <YAxis\r\n                    domain={[0, 100]}\r\n                    stroke={theme.palette.text.secondary}\r\n                    fontSize={12}\r\n                    tick={{ fill: theme.palette.text.secondary }}\r\n                  />\r\n                  <Tooltip content={<CustomTooltip />} />\r\n                  <Area\r\n                    type=\"monotone\"\r\n                    dataKey=\"overall\"\r\n                    stroke={theme.palette.primary.main}\r\n                    strokeWidth={3}\r\n                    fill=\"url(#overallGradient)\"\r\n                    name=\"Overall Score\"\r\n                  />\r\n                </AreaChart>\r\n              </ResponsiveContainer>\r\n            </Box>\r\n\r\n            {/* Component Breakdown Chart */}\r\n            <Typography variant=\"subtitle2\" gutterBottom sx={{ mt: 2 }}>\r\n              Score Components\r\n            </Typography>\r\n            <Box sx={{ height: { xs: 160, sm: 200 } }}>\r\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                <LineChart data={chartData}>\r\n                  <CartesianGrid\r\n                    strokeDasharray=\"3 3\"\r\n                    stroke={theme.palette.mode === 'dark'\r\n                      ? alpha(theme.palette.common.white, 0.1)\r\n                      : theme.palette.divider\r\n                    }\r\n                  />\r\n                  <XAxis\r\n                    dataKey=\"dateLabel\"\r\n                    stroke={theme.palette.text.secondary}\r\n                    fontSize={12}\r\n                    tick={{ fill: theme.palette.text.secondary }}\r\n                  />\r\n                  <YAxis\r\n                    domain={[0, 100]}\r\n                    stroke={theme.palette.text.secondary}\r\n                    fontSize={12}\r\n                    tick={{ fill: theme.palette.text.secondary }}\r\n                  />\r\n                  <Tooltip content={<CustomTooltip />} />\r\n                  <Legend />\r\n                  <Line\r\n                    type=\"monotone\"\r\n                    dataKey=\"consistency\"\r\n                    stroke={theme.palette.info.main}\r\n                    strokeWidth={2}\r\n                    dot={false}\r\n                    name=\"Consistency\"\r\n                  />\r\n                  <Line\r\n                    type=\"monotone\"\r\n                    dataKey=\"riskManagement\"\r\n                    stroke={theme.palette.success.main}\r\n                    strokeWidth={2}\r\n                    dot={false}\r\n                    name=\"Risk Mgmt\"\r\n                  />\r\n                  <Line\r\n                    type=\"monotone\"\r\n                    dataKey=\"performance\"\r\n                    stroke={theme.palette.warning.main}\r\n                    strokeWidth={2}\r\n                    dot={false}\r\n                    name=\"Performance\"\r\n                  />\r\n                  <Line\r\n                    type=\"monotone\"\r\n                    dataKey=\"discipline\"\r\n                    stroke={theme.palette.error.main}\r\n                    strokeWidth={2}\r\n                    dot={false}\r\n                    name=\"Discipline\"\r\n                  />\r\n                </LineChart>\r\n              </ResponsiveContainer>\r\n            </Box>\r\n          </>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ScoreHistoryComponent;\r\n","import React, { useState, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Chip,\r\n  Stack,\r\n  TextField,\r\n  Autocomplete,\r\n  Card,\r\n  CardContent,\r\n  IconButton,\r\n  Tooltip,\r\n  Alert,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  Button,\r\n  Divider,\r\n  InputAdornment\r\n} from '@mui/material';\r\nimport { useTheme, alpha } from '@mui/material/styles';\r\nimport { HelpOutline, Close, Search as SearchIcon } from '@mui/icons-material';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups,\r\n  filterTagsByGroup\r\n} from '../../utils/tagColors';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\n\r\ninterface ExcludedTagsSelectorProps {\r\n  trades: Trade[];\r\n  excludedTags: string[];\r\n  onExcludedTagsChange: (tags: string[]) => void;\r\n  allTags?: string[]; // Add allTags prop to receive calendar.tags\r\n}\r\n\r\nconst ExcludedTagsSelector: React.FC<ExcludedTagsSelectorProps> = ({\r\n  trades,\r\n  excludedTags,\r\n  onExcludedTagsChange,\r\n  allTags: propAllTags\r\n}) => {\r\n  const theme = useTheme();\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n\r\n  // Use calendar.tags from props, fallback to extracting from trades if not available\r\n  const allTags = useMemo(() => {\r\n    if (propAllTags && propAllTags.length > 0) {\r\n      // Filter out system tags like Partials from calendar.tags\r\n      return propAllTags.filter(tag => !tag.startsWith('Partials:')).sort();\r\n    }\r\n\r\n    // Fallback: extract from trades (for backwards compatibility)\r\n    const tagSet = new Set<string>();\r\n    trades.forEach(trade => {\r\n      if (trade.tags) {\r\n        trade.tags.forEach(tag => {\r\n          // Filter out system tags like Partials\r\n          if (!tag.startsWith('Partials:')) {\r\n            tagSet.add(tag);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return Array.from(tagSet).sort();\r\n  }, [propAllTags, trades]);\r\n\r\n  // Filter tags based on search term\r\n  const filteredTags = useMemo(() => {\r\n    if (!searchTerm) return allTags;\r\n\r\n    const term = searchTerm.toLowerCase();\r\n    return allTags.filter(tag =>\r\n      tag.toLowerCase().includes(term) ||\r\n      formatTagForDisplay(tag).toLowerCase().includes(term)\r\n    );\r\n  }, [allTags, searchTerm]);\r\n\r\n  // Available tags (not already excluded) from filtered tags\r\n  const availableTags = useMemo(() => {\r\n    return filteredTags.filter(tag => !excludedTags.includes(tag));\r\n  }, [filteredTags, excludedTags]);\r\n\r\n  // Group available tags by their group\r\n  const groupedAvailableTags = useMemo(() => {\r\n    const groups: Record<string, string[]> = {};\r\n\r\n    availableTags.forEach(tag => {\r\n      if (isGroupedTag(tag)) {\r\n        const group = getTagGroup(tag);\r\n        if (!groups[group]) {\r\n          groups[group] = [];\r\n        }\r\n        groups[group].push(tag);\r\n      } else {\r\n        if (!groups['Ungrouped']) {\r\n          groups['Ungrouped'] = [];\r\n        }\r\n        groups['Ungrouped'].push(tag);\r\n      }\r\n    });\r\n\r\n    return groups;\r\n  }, [availableTags]);\r\n\r\n  const handleAddTag = (tag: string) => {\r\n    if (tag && !excludedTags.includes(tag)) {\r\n      onExcludedTagsChange([...excludedTags, tag]);\r\n    }\r\n  };\r\n\r\n  const handleAddAllInCategory = (category: string) => {\r\n    const categoryTags = groupedAvailableTags[category] || [];\r\n    const newExcludedTags = [...excludedTags, ...categoryTags];\r\n    onExcludedTagsChange(newExcludedTags);\r\n  };\r\n\r\n  const handleRemoveTag = (tagToRemove: string) => {\r\n    onExcludedTagsChange(excludedTags.filter(tag => tag !== tagToRemove));\r\n  };\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? 'rgba(255, 255, 255, 0.02)'\r\n          : 'rgba(0, 0, 0, 0.02)',\r\n        border: `1px solid ${theme.palette.divider}`,\r\n        borderRadius: 2\r\n      }}\r\n    >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" spacing={1} mb={2}>\r\n          <Typography variant=\"h6\" sx={{ fontWeight: 600 }}>\r\n             Excluded Tags from Pattern Analysis\r\n          </Typography>\r\n          <Tooltip title=\"Tags excluded from pattern analysis won't be considered when identifying high-performing or declining tag combinations. This is useful for filtering out temporary or irrelevant tags.\">\r\n            <IconButton size=\"small\">\r\n              <HelpOutline fontSize=\"small\" />\r\n            </IconButton>\r\n          </Tooltip>\r\n        </Stack>\r\n\r\n        <Alert severity=\"info\" sx={{ mb: 3 }}>\r\n          <Typography variant=\"body2\">\r\n            Excluded tags will not be included in pattern analysis calculations. This helps focus the analysis on meaningful trading patterns by filtering out temporary, experimental, or irrelevant tags.\r\n          </Typography>\r\n        </Alert>\r\n\r\n        {/* Add new excluded tag */}\r\n        <Box mb={3}>\r\n          <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n            Add Tag to Exclude\r\n          </Typography>\r\n          <TextField\r\n            placeholder=\"Search for tags to exclude...\"\r\n            variant=\"outlined\"\r\n            size=\"small\"\r\n            value={searchTerm}\r\n            onChange={(e) => setSearchTerm(e.target.value)}\r\n            slotProps={{\r\n              input: {\r\n                startAdornment: (\r\n                  <InputAdornment position=\"start\">\r\n                    <SearchIcon />\r\n                  </InputAdornment>\r\n                ),\r\n              }\r\n            }}\r\n            sx={{\r\n              width: '100%',\r\n              '& .MuiOutlinedInput-root': {\r\n                backgroundColor: theme.palette.mode === 'dark'\r\n                  ? 'rgba(255, 255, 255, 0.05)'\r\n                  : 'rgba(0, 0, 0, 0.02)',\r\n              }\r\n            }}\r\n          />\r\n        </Box>\r\n\r\n        {/* Available Tags by Category */}\r\n        {Object.keys(groupedAvailableTags).length > 0 && (\r\n          <Box sx={{\r\n            maxHeight: '250px',\r\n            overflow: 'auto',\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            borderRadius: 1,\r\n            mb: 3,\r\n            ...scrollbarStyles(theme)\r\n          }}>\r\n            {Object.entries(groupedAvailableTags).map(([group, tags]) => (\r\n              <Box key={group}>\r\n                <Box sx={{\r\n                  p: 1.5,\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'space-between'\r\n                }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                    <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                      {group}\r\n                    </Typography>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\">\r\n                      {tags.length} tag{tags.length !== 1 ? 's' : ''}\r\n                    </Typography>\r\n                  </Box>\r\n                  <Button\r\n                    size=\"small\"\r\n                    variant=\"outlined\"\r\n                    onClick={() => handleAddAllInCategory(group)}\r\n                    sx={{ minWidth: 'auto', px: 1 }}\r\n                  >\r\n                    Add All\r\n                  </Button>\r\n                </Box>\r\n                <Divider />\r\n                <List disablePadding>\r\n                  {tags.map((tag) => (\r\n                    <ListItem\r\n                      key={tag}\r\n                      secondaryAction={\r\n                        <Button\r\n                          size=\"small\"\r\n                          variant=\"text\"\r\n                          onClick={() => handleAddTag(tag)}\r\n                          sx={{ minWidth: 'auto', p: 0.5 }}\r\n                        >\r\n                          Add\r\n                        </Button>\r\n                      }\r\n                      sx={{\r\n                        '&:hover': {\r\n                          bgcolor: alpha(theme.palette.primary.main, 0.05)\r\n                        }\r\n                      }}\r\n                    >\r\n                      <ListItemText\r\n                        primary={\r\n                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                            <Chip\r\n                              label={formatTagForDisplay(tag, true)}\r\n                              size=\"small\"\r\n                              sx={getTagChipStyles(tag, theme)}\r\n                            />\r\n                          </Box>\r\n                        }\r\n                      />\r\n                    </ListItem>\r\n                  ))}\r\n                </List>\r\n              </Box>\r\n            ))}\r\n          </Box>\r\n        )}\r\n\r\n        {Object.keys(groupedAvailableTags).length === 0 && (\r\n          <Box sx={{\r\n            p: 2,\r\n            textAlign: 'center',\r\n            color: 'text.secondary',\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            borderRadius: 1,\r\n            mb: 3\r\n          }}>\r\n            <Typography variant=\"body2\">\r\n              {searchTerm ? 'No matching tags found' : 'No tags available to exclude'}\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n\r\n        {/* Currently excluded tags */}\r\n        <Box>\r\n          <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n            Currently Excluded Tags ({excludedTags.length})\r\n          </Typography>\r\n          \r\n          {excludedTags.length === 0 ? (\r\n            <Typography variant=\"body2\" color=\"text.secondary\" sx={{ fontStyle: 'italic' }}>\r\n              No tags are currently excluded from pattern analysis.\r\n            </Typography>\r\n          ) : (\r\n            <Stack direction=\"row\" spacing={1} flexWrap=\"wrap\" useFlexGap>\r\n              {excludedTags.map(tag => (\r\n                <Chip\r\n                  key={tag}\r\n                  label={formatTagForDisplay(tag)}\r\n                  onDelete={() => handleRemoveTag(tag)}\r\n                  deleteIcon={\r\n                    <Close \r\n                      sx={{ \r\n                        color: theme.palette.mode === 'dark' ? 'white' : 'inherit',\r\n                        '&:hover': {\r\n                          color: theme.palette.error.main\r\n                        }\r\n                      }} \r\n                    />\r\n                  }\r\n                  sx={{\r\n                    ...getTagChipStyles(tag, theme),\r\n                    '& .MuiChip-deleteIcon': {\r\n                      color: theme.palette.mode === 'dark' ? 'white' : 'inherit',\r\n                      '&:hover': {\r\n                        color: theme.palette.error.main\r\n                      }\r\n                    }\r\n                  }}\r\n                />\r\n              ))}\r\n            </Stack>\r\n          )}\r\n        </Box>\r\n\r\n        {/* Summary information */}\r\n        {allTags.length > 0 && (\r\n          <Box mt={3} p={2} sx={{\r\n            backgroundColor: theme.palette.mode === 'dark'\r\n              ? 'rgba(255, 255, 255, 0.02)'\r\n              : 'rgba(0, 0, 0, 0.02)',\r\n            borderRadius: 1,\r\n            border: `1px solid ${theme.palette.divider}`\r\n          }}>\r\n            <Typography variant=\"caption\" color=\"text.secondary\">\r\n              <strong>Pattern Analysis Coverage:</strong> {availableTags.length} of {allTags.length} tags will be included in pattern analysis\r\n              {excludedTags.length > 0 && (\r\n                <span> ({excludedTags.length} excluded)</span>\r\n              )}\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ExcludedTagsSelector;\r\n","import React, { useState, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  TextField,\r\n  FormControlLabel,\r\n  Checkbox,\r\n  Chip,\r\n  useTheme,\r\n  Autocomplete,\r\n  Stack,\r\n  List,\r\n  ListItem,\r\n  ListItemText,\r\n  Button,\r\n  Divider,\r\n  InputAdornment\r\n} from '@mui/material';\r\nimport { Search as SearchIcon } from '@mui/icons-material';\r\n\r\nimport { alpha } from '@mui/material/styles';\r\nimport { Trade, Calendar } from '../../types/dualWrite'; \r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups,\r\n  filterTagsByGroup\r\n} from '../../utils/tagColors';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\n\r\ninterface TagSelectorProps {\r\n  trades: Trade[];\r\n  selectedTags: string[];\r\n  onTagsChange: (tags: string[]) => void;\r\n  allTags?: string[]; // Add allTags prop to receive calendar.tags\r\n}\r\n\r\nconst TagSelector: React.FC<TagSelectorProps> = ({\r\n  trades,\r\n  selectedTags,\r\n  onTagsChange,\r\n  allTags: propAllTags\r\n}) => {\r\n  const theme = useTheme();\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n\r\n  // Use calendar.tags from props, fallback to extracting from trades if not available\r\n  const allTags = useMemo(() => {\r\n    if (propAllTags && propAllTags.length > 0) {\r\n      // Filter out Partials tags from calendar.tags\r\n      return propAllTags.filter(tag => !tag.startsWith('Partials:')).sort();\r\n    }\r\n\r\n    // Fallback: extract from trades (for backwards compatibility)\r\n    const tagSet = new Set<string>();\r\n    trades.forEach(trade => {\r\n      if (trade.tags) {\r\n        trade.tags.forEach(tag => {\r\n          // Filter out Partials tags\r\n          if (!tag.startsWith('Partials:')) {\r\n            tagSet.add(tag);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return Array.from(tagSet).sort();\r\n  }, [propAllTags, trades]);\r\n\r\n  // Calculate tag usage statistics\r\n  const tagStats = useMemo(() => {\r\n    const stats: Record<string, { count: number; percentage: number }> = {};\r\n    allTags.forEach(tag => {\r\n      const count = trades.filter(trade =>\r\n        trade.tags && trade.tags.includes(tag)\r\n      ).length;\r\n      const percentage = trades.length > 0 ? Math.round((count / trades.length) * 100) : 0;\r\n      stats[tag] = { count, percentage };\r\n    });\r\n    return stats;\r\n  }, [allTags, trades]);\r\n\r\n  // Filter tags based on search term\r\n  const filteredTags = useMemo(() => {\r\n    if (!searchTerm) return allTags;\r\n\r\n    const term = searchTerm.toLowerCase();\r\n    return allTags.filter(tag =>\r\n      tag.toLowerCase().includes(term) ||\r\n      formatTagForDisplay(tag).toLowerCase().includes(term)\r\n    );\r\n  }, [allTags, searchTerm]);\r\n\r\n  // Available tags (not already selected) from filtered tags\r\n  const availableTags = useMemo(() => {\r\n    return filteredTags.filter(tag => !selectedTags.includes(tag));\r\n  }, [filteredTags, selectedTags]);\r\n\r\n  // Group available tags by their group\r\n  const groupedAvailableTags = useMemo(() => {\r\n    const groups: Record<string, string[]> = {};\r\n\r\n    availableTags.forEach(tag => {\r\n      if (isGroupedTag(tag)) {\r\n        const group = getTagGroup(tag);\r\n        if (!groups[group]) {\r\n          groups[group] = [];\r\n        }\r\n        groups[group].push(tag);\r\n      } else {\r\n        if (!groups['Ungrouped']) {\r\n          groups['Ungrouped'] = [];\r\n        }\r\n        groups['Ungrouped'].push(tag);\r\n      }\r\n    });\r\n\r\n    return groups;\r\n  }, [availableTags]);\r\n\r\n  const handleAddTag = (tag: string) => {\r\n    if (tag && !selectedTags.includes(tag)) {\r\n      onTagsChange([...selectedTags, tag]);\r\n    }\r\n  };\r\n\r\n  const handleRemoveTag = (tag: string) => {\r\n    onTagsChange(selectedTags.filter(t => t !== tag));\r\n  };\r\n\r\n  const handleAddAllInCategory = (category: string) => {\r\n    const categoryTags = groupedAvailableTags[category] || [];\r\n    const newSelectedTags = [...selectedTags, ...categoryTags];\r\n    onTagsChange(newSelectedTags);\r\n  };\r\n\r\n  const handleClearAll = () => {\r\n    onTagsChange([]);\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 3 }}>\r\n        Select specific tags to track their usage frequency across your trades. This will show how often you use each selected strategy in the Analysis tab.\r\n      </Typography>\r\n\r\n      {/* Search Field */}\r\n      <Box mb={2}>\r\n        <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n          Add Tags to Track\r\n        </Typography>\r\n        <TextField\r\n          placeholder=\"Search for tags to track...\"\r\n          variant=\"outlined\"\r\n          size=\"small\"\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          slotProps={{\r\n            input: {\r\n              startAdornment: (\r\n                <InputAdornment position=\"start\">\r\n                  <SearchIcon />\r\n                </InputAdornment>\r\n              ),\r\n            }\r\n          }}\r\n          sx={{\r\n            width: '100%',\r\n            '& .MuiOutlinedInput-root': {\r\n              backgroundColor: theme.palette.mode === 'dark'\r\n                ? 'rgba(255, 255, 255, 0.05)'\r\n                : 'rgba(0, 0, 0, 0.02)',\r\n            }\r\n          }}\r\n        />\r\n      </Box>\r\n\r\n      {/* Available Tags by Category */}\r\n      {Object.keys(groupedAvailableTags).length > 0 && (\r\n        <Box sx={{\r\n          maxHeight: '300px',\r\n          overflow: 'auto',\r\n          border: `1px solid ${theme.palette.divider}`,\r\n          borderRadius: 1,\r\n          mb: 2,\r\n          ...scrollbarStyles(theme)\r\n        }}>\r\n          {Object.entries(groupedAvailableTags).map(([group, tags]) => (\r\n            <Box key={group}>\r\n              <Box sx={{\r\n                p: 1.5,\r\n                bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                justifyContent: 'space-between'\r\n              }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                  <Typography variant=\"subtitle2\" fontWeight={600}>\r\n                    {group}\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    {tags.length} tag{tags.length !== 1 ? 's' : ''}\r\n                  </Typography>\r\n                </Box>\r\n                <Button\r\n                  size=\"small\"\r\n                  variant=\"outlined\"\r\n                  onClick={() => handleAddAllInCategory(group)}\r\n                  sx={{ minWidth: 'auto', px: 1 }}\r\n                >\r\n                  Add All\r\n                </Button>\r\n              </Box>\r\n              <Divider />\r\n              <List disablePadding>\r\n                {tags.map((tag) => {\r\n                  const stats = tagStats[tag] || { count: 0, percentage: 0 };\r\n                  return (\r\n                    <ListItem\r\n                      key={tag}\r\n                      secondaryAction={\r\n                        <Button\r\n                          size=\"small\"\r\n                          variant=\"text\"\r\n                          onClick={() => handleAddTag(tag)}\r\n                          sx={{ minWidth: 'auto', p: 0.5 }}\r\n                        >\r\n                          Add\r\n                        </Button>\r\n                      }\r\n                      sx={{\r\n                        '&:hover': {\r\n                          bgcolor: alpha(theme.palette.primary.main, 0.05)\r\n                        }\r\n                      }}\r\n                    >\r\n                      <ListItemText\r\n                        primary={\r\n                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                            <Chip\r\n                              label={formatTagForDisplay(tag, true)}\r\n                              size=\"small\"\r\n                              sx={getTagChipStyles(tag, theme)}\r\n                            />\r\n                            <Typography variant=\"caption\" color=\"text.secondary\">\r\n                              {stats.count} trades ({stats.percentage}%)\r\n                            </Typography>\r\n                          </Box>\r\n                        }\r\n                      />\r\n                    </ListItem>\r\n                  );\r\n                })}\r\n              </List>\r\n            </Box>\r\n          ))}\r\n        </Box>\r\n      )}\r\n\r\n      {Object.keys(groupedAvailableTags).length === 0 && (\r\n        <Box sx={{\r\n          p: 2,\r\n          textAlign: 'center',\r\n          color: 'text.secondary',\r\n          border: `1px solid ${theme.palette.divider}`,\r\n          borderRadius: 1,\r\n          mb: 2\r\n        }}>\r\n          <Typography variant=\"body2\">\r\n            {searchTerm ? 'No matching tags found' : 'All tags are already selected'}\r\n          </Typography>\r\n        </Box>\r\n      )}\r\n\r\n     \r\n\r\n      {/* Selected Tags Summary */}\r\n      {selectedTags.length > 0 && (\r\n        <Box sx={{ mt: 2, p: 2, bgcolor: 'background.default', borderRadius: 1 }}>\r\n          <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={1}>\r\n            <Typography variant=\"subtitle2\">\r\n              Selected Tags ({selectedTags.length}):\r\n            </Typography>\r\n            <Chip\r\n              label=\"Clear All\"\r\n              size=\"small\"\r\n              onClick={handleClearAll}\r\n              sx={{ cursor: 'pointer' }}\r\n            />\r\n          </Stack>\r\n          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n            {selectedTags.map(tag => {\r\n              const stats = tagStats[tag] || { count: 0, percentage: 0 };\r\n              return (\r\n                <Chip\r\n                  key={tag}\r\n                  label={`${tag} (${stats.percentage}%)`}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    ...getTagChipStyles(tag, theme),\r\n                    '& .MuiChip-deleteIcon': {\r\n                      color: 'inherit',\r\n                      '&:hover': {\r\n                        color: 'inherit',\r\n                        opacity: 0.7\r\n                      }\r\n                    }\r\n                  }}\r\n                  onDelete={() => handleRemoveTag(tag)}\r\n                />\r\n              );\r\n            })}\r\n          </Box>\r\n        </Box>\r\n      )}\r\n\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default TagSelector;\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  Slider,\r\n  Stack,\r\n  TextField,\r\n  Button,\r\n  Alert,\r\n  Accordion,\r\n  AccordionSummary,\r\n  AccordionDetails,\r\n  FormLabel,\r\n  useTheme\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  ExpandMore,\r\n  RestoreRounded,\r\n  SaveRounded,\r\n  InfoOutlined\r\n} from '@mui/icons-material';\r\nimport { ScoreSettings } from '../../types/score';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { DEFAULT_SCORE_SETTINGS } from '../../utils/scoreUtils';\r\nimport ExcludedTagsSelector from './ExcludedTagsSelector';\r\nimport TagSelector from './TagSelector';\r\n\r\ninterface ScoreSettingsProps {\r\n  settings: ScoreSettings;\r\n  onSettingsChange: (settings: ScoreSettings) => void;\r\n  onSave?: () => void;\r\n  isSaving?: boolean;\r\n  trades: Trade[];\r\n  selectedTags: string[];\r\n  onTagsChange: (tags: string[]) => void;\r\n  allTags?: string[]; // Add allTags prop to receive calendar.tags\r\n}\r\n\r\nconst ScoreSettingsComponent: React.FC<ScoreSettingsProps> = ({\r\n  settings,\r\n  onSettingsChange,\r\n  onSave,\r\n  isSaving = false,\r\n  trades,\r\n  selectedTags,\r\n  onTagsChange,\r\n  allTags\r\n}) => {\r\n  const theme = useTheme();\r\n  const [localSettings, setLocalSettings] = useState<ScoreSettings>(settings);\r\n  const [hasChanges, setHasChanges] = useState(false);\r\n\r\n  const handleWeightChange = (component: keyof ScoreSettings['weights']) => (\r\n    event: Event,\r\n    newValue: number | number[]\r\n  ) => {\r\n    const value = Array.isArray(newValue) ? newValue[0] : newValue;\r\n    const newWeights = { ...localSettings.weights, [component]: value };\r\n    \r\n    // Ensure weights sum to 100\r\n    const total = Object.values(newWeights).reduce((sum, weight) => sum + weight, 0);\r\n    if (total !== 100) {\r\n      // Adjust other weights proportionally\r\n      const otherComponents = Object.keys(newWeights).filter(key => key !== component) as Array<keyof ScoreSettings['weights']>;\r\n      const remaining = 100 - value;\r\n      const otherTotal = otherComponents.reduce((sum, key) => sum + newWeights[key], 0);\r\n      \r\n      if (otherTotal > 0) {\r\n        otherComponents.forEach(key => {\r\n          newWeights[key] = (newWeights[key] / otherTotal) * remaining;\r\n        });\r\n      }\r\n    }\r\n\r\n    const newSettings = { ...localSettings, weights: newWeights };\r\n    setLocalSettings(newSettings);\r\n    setHasChanges(true);\r\n    onSettingsChange(newSettings);\r\n  };\r\n\r\n  const handleThresholdChange = (threshold: keyof ScoreSettings['thresholds']) => (\r\n    event: React.ChangeEvent<HTMLInputElement>\r\n  ) => {\r\n    const value = parseFloat(event.target.value) || 0;\r\n    const newSettings = {\r\n      ...localSettings,\r\n      thresholds: { ...localSettings.thresholds, [threshold]: value }\r\n    };\r\n    setLocalSettings(newSettings);\r\n    setHasChanges(true);\r\n    onSettingsChange(newSettings);\r\n  };\r\n\r\n  const handleTargetChange = (target: keyof ScoreSettings['targets']) => (\r\n    event: React.ChangeEvent<HTMLInputElement>\r\n  ) => {\r\n    const value = parseFloat(event.target.value) || 0;\r\n    const newSettings = {\r\n      ...localSettings,\r\n      targets: { ...localSettings.targets, [target]: value }\r\n    };\r\n    setLocalSettings(newSettings);\r\n    setHasChanges(true);\r\n    onSettingsChange(newSettings);\r\n  };\r\n\r\n  const handleExcludedTagsChange = (excludedTags: string[]) => {\r\n    const newSettings = { ...localSettings, excludedTagsFromPatterns: excludedTags };\r\n    setLocalSettings(newSettings);\r\n    setHasChanges(true);\r\n    onSettingsChange(newSettings);\r\n  };\r\n\r\n  const handleTagsChangeWithSaveState = (tags: string[]) => {\r\n    // Enable save button when tags change within the settings interface\r\n    setHasChanges(true);\r\n    // Call the original onTagsChange callback\r\n    onTagsChange(tags);\r\n  };\r\n\r\n  const handleReset = () => {\r\n    setLocalSettings(DEFAULT_SCORE_SETTINGS);\r\n    setHasChanges(true);\r\n    onSettingsChange(DEFAULT_SCORE_SETTINGS);\r\n  };\r\n\r\n  const handleSave = () => {\r\n    if (onSave) {\r\n      onSave();\r\n    }\r\n    setHasChanges(false);\r\n  };\r\n\r\n  const weightTotal = Object.values(localSettings.weights).reduce((sum, weight) => sum + weight, 0);\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.background.paper, 0.8)\r\n          : theme.palette.background.paper,\r\n        borderRadius: 3,\r\n        boxShadow: theme.shadows[2],\r\n        border: `1px solid ${theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.common.white, 0.1)\r\n          : alpha(theme.palette.common.black, 0.1)}`,\r\n        transition: 'all 0.2s ease-in-out',\r\n        '&:hover': {\r\n          transform: 'translateY(-1px)',\r\n          boxShadow: theme.shadows[4],\r\n        }\r\n      }}\r\n    >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={3}>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              color: theme.palette.text.primary,\r\n              fontWeight: 600\r\n            }}\r\n          >\r\n             Score Settings\r\n          </Typography>\r\n          <Stack direction=\"row\" spacing={1}>\r\n            <Button\r\n              startIcon={<RestoreRounded />}\r\n              onClick={handleReset}\r\n              size=\"small\"\r\n              variant=\"outlined\"\r\n              sx={{\r\n                borderColor: theme.palette.mode === 'dark'\r\n                  ? alpha(theme.palette.common.white, 0.3)\r\n                  : theme.palette.primary.main,\r\n                color: theme.palette.mode === 'dark'\r\n                  ? theme.palette.common.white\r\n                  : theme.palette.primary.main,\r\n                '&:hover': {\r\n                  borderColor: theme.palette.primary.main,\r\n                  backgroundColor: alpha(theme.palette.primary.main, 0.05)\r\n                }\r\n              }}\r\n            >\r\n              Reset\r\n            </Button>\r\n            {onSave && (\r\n              <Button\r\n                startIcon={<SaveRounded />}\r\n                onClick={handleSave}\r\n                size=\"small\"\r\n                variant=\"contained\"\r\n                disabled={!hasChanges || isSaving}\r\n                sx={{\r\n                  backgroundColor: theme.palette.primary.main,\r\n                  '&:hover': {\r\n                    backgroundColor: theme.palette.primary.dark\r\n                  },\r\n                  '&:disabled': {\r\n                    backgroundColor: theme.palette.mode === 'dark'\r\n                      ? alpha(theme.palette.common.white, 0.1)\r\n                      : theme.palette.grey[300]\r\n                  }\r\n                }}\r\n              >\r\n                {isSaving ? 'Saving...' : 'Save'}\r\n              </Button>\r\n            )}\r\n          </Stack>\r\n        </Stack>\r\n\r\n        {hasChanges && (\r\n          <Alert severity=\"info\" sx={{ mb: 2 }}>\r\n            You have unsaved changes. Click Save to apply them permanently.\r\n          </Alert>\r\n        )}\r\n\r\n        <Stack>\r\n          {/* Score Component Weights */}\r\n          <Accordion>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" fontWeight=\"medium\">\r\n                Score Component Weights\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Alert severity=\"info\" icon={<InfoOutlined />} sx={{ mb: 2 }}>\r\n                Adjust how much each component contributes to your overall score. \r\n                Total must equal 100%.\r\n              </Alert>\r\n              \r\n              <Stack spacing={3}>\r\n                <Box>\r\n                  <FormLabel>Consistency ({localSettings.weights.consistency.toFixed(0)}%)</FormLabel>\r\n                  <Box sx={{ px: 2 }}>\r\n                    <Slider\r\n                      value={localSettings.weights.consistency}\r\n                      onChange={handleWeightChange('consistency')}\r\n                      min={0}\r\n                      max={100}\r\n                      step={5}\r\n                      marks={[\r\n                        { value: 0, label: '0%' },\r\n                        { value: 50, label: '50%' },\r\n                        { value: 100, label: '100%' }\r\n                      ]}\r\n                      sx={{\r\n                        '& .MuiSlider-markLabel': {\r\n                          fontSize: '0.75rem'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"0\"]': {\r\n                          transform: 'translateX(0%)'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"2\"]': {\r\n                          transform: 'translateX(-100%)'\r\n                        }\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    How well you stick to your trading patterns\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box>\r\n                  <FormLabel>Risk Management ({localSettings.weights.riskManagement.toFixed(0)}%)</FormLabel>\r\n                  <Box sx={{ px: 2 }}>\r\n                    <Slider\r\n                      value={localSettings.weights.riskManagement}\r\n                      onChange={handleWeightChange('riskManagement')}\r\n                      min={0}\r\n                      max={100}\r\n                      step={5}\r\n                      marks={[\r\n                        { value: 0, label: '0%' },\r\n                        { value: 50, label: '50%' },\r\n                        { value: 100, label: '100%' }\r\n                      ]}\r\n                      sx={{\r\n                        '& .MuiSlider-markLabel': {\r\n                          fontSize: '0.75rem'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"0\"]': {\r\n                          transform: 'translateX(0%)'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"2\"]': {\r\n                          transform: 'translateX(-100%)'\r\n                        }\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    Risk management and position sizing discipline\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box>\r\n                  <FormLabel>Performance ({localSettings.weights.performance.toFixed(0)}%)</FormLabel>\r\n                  <Box sx={{ px: 2 }}>\r\n                    <Slider\r\n                      value={localSettings.weights.performance}\r\n                      onChange={handleWeightChange('performance')}\r\n                      min={0}\r\n                      max={100}\r\n                      step={5}\r\n                      marks={[\r\n                        { value: 0, label: '0%' },\r\n                        { value: 50, label: '50%' },\r\n                        { value: 100, label: '100%' }\r\n                      ]}\r\n                      sx={{\r\n                        '& .MuiSlider-markLabel': {\r\n                          fontSize: '0.75rem'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"0\"]': {\r\n                          transform: 'translateX(0%)'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"2\"]': {\r\n                          transform: 'translateX(-100%)'\r\n                        }\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    Performance consistency vs historical patterns\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box>\r\n                  <FormLabel>Discipline ({localSettings.weights.discipline.toFixed(0)}%)</FormLabel>\r\n                  <Box sx={{ px: 2 }}>\r\n                    <Slider\r\n                      value={localSettings.weights.discipline}\r\n                      onChange={handleWeightChange('discipline')}\r\n                      min={0}\r\n                      max={100}\r\n                      step={5}\r\n                      marks={[\r\n                        { value: 0, label: '0%' },\r\n                        { value: 50, label: '50%' },\r\n                        { value: 100, label: '100%' }\r\n                      ]}\r\n                      sx={{\r\n                        '& .MuiSlider-markLabel': {\r\n                          fontSize: '0.75rem'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"0\"]': {\r\n                          transform: 'translateX(0%)'\r\n                        },\r\n                        '& .MuiSlider-markLabel[data-index=\"2\"]': {\r\n                          transform: 'translateX(-100%)'\r\n                        }\r\n                      }}\r\n                    />\r\n                  </Box>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    Trading discipline and emotional control\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Typography \r\n                  variant=\"body2\" \r\n                  sx={{ \r\n                    color: weightTotal === 100 ? 'success.main' : 'error.main',\r\n                    fontWeight: 'medium'\r\n                  }}\r\n                >\r\n                  Total: {weightTotal.toFixed(0)}% {weightTotal !== 100 && '(Must equal 100%)'}\r\n                </Typography>\r\n              </Stack>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n\r\n          {/* Calculation Thresholds */}\r\n          <Accordion>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" fontWeight=\"medium\">\r\n                Calculation Thresholds\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', sm: 'repeat(3, 1fr)' }, gap: 2 }}>\r\n                <TextField\r\n                  label=\"Min Trades for Score\"\r\n                  type=\"number\"\r\n                  value={localSettings.thresholds.minTradesForScore}\r\n                  onChange={handleThresholdChange('minTradesForScore')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Minimum trades needed to calculate score\"\r\n                />\r\n                <TextField\r\n                  label=\"Lookback Period (days)\"\r\n                  type=\"number\"\r\n                  value={localSettings.thresholds.lookbackPeriod}\r\n                  onChange={handleThresholdChange('lookbackPeriod')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Days to look back for pattern analysis\"\r\n                />\r\n                <TextField\r\n                  label=\"Consistency Tolerance (%)\"\r\n                  type=\"number\"\r\n                  value={localSettings.thresholds.consistencyTolerance}\r\n                  onChange={handleThresholdChange('consistencyTolerance')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Acceptable deviation from patterns\"\r\n                />\r\n              </Box>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n\r\n          {/* Performance Targets */}\r\n          <Accordion>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" fontWeight=\"medium\">\r\n                Performance Targets\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Box sx={{ display: 'grid', gridTemplateColumns: { xs: '1fr', sm: 'repeat(2, 1fr)' }, gap: 2 }}>\r\n                <TextField\r\n                  label=\"Target Win Rate (%)\"\r\n                  type=\"number\"\r\n                  value={localSettings.targets.win_rate}\r\n                  onChange={handleTargetChange('win_rate')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Your target win rate percentage\"\r\n                />\r\n                <TextField\r\n                  label=\"Target Profit Factor\"\r\n                  type=\"number\"\r\n                  inputProps={{ step: 0.1 }}\r\n                  value={localSettings.targets.profit_factor}\r\n                  onChange={handleTargetChange('profit_factor')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Your target profit factor\"\r\n                />\r\n                <TextField\r\n                  label=\"Max Drawdown (%)\"\r\n                  type=\"number\"\r\n                  value={localSettings.targets.max_drawdown}\r\n                  onChange={handleTargetChange('max_drawdown')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Maximum acceptable drawdown\"\r\n                />\r\n                <TextField\r\n                  label=\"Avg Risk/Reward Ratio\"\r\n                  type=\"number\"\r\n                  inputProps={{ step: 0.1 }}\r\n                  value={localSettings.targets.avgRiskReward}\r\n                  onChange={handleTargetChange('avgRiskReward')}\r\n                  fullWidth\r\n                  size=\"small\"\r\n                  helperText=\"Your target risk/reward ratio\"\r\n                />\r\n              </Box>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n\r\n          {/* Common Strategies Tracking */}\r\n          <Accordion>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" fontWeight=\"medium\">\r\n                Common Strategies Tracking\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <TagSelector\r\n                trades={trades}\r\n                selectedTags={selectedTags}\r\n                onTagsChange={handleTagsChangeWithSaveState}\r\n                allTags={allTags}\r\n              />\r\n            </AccordionDetails>\r\n          </Accordion>\r\n\r\n          {/* Pattern Analysis Settings */}\r\n          <Accordion>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" fontWeight=\"medium\">\r\n                Pattern Analysis Settings\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <ExcludedTagsSelector\r\n                trades={trades}\r\n                excludedTags={localSettings.excludedTagsFromPatterns || []}\r\n                onExcludedTagsChange={handleExcludedTagsChange}\r\n                allTags={allTags}\r\n              />\r\n            </AccordionDetails>\r\n          </Accordion>\r\n        </Stack>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default ScoreSettingsComponent;\r\n","import React, { useMemo, useState, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  Alert,\r\n  Chip,\r\n  Stack,\r\n  LinearProgress,\r\n  useTheme,\r\n  Accordion,\r\n  AccordionSummary,\r\n  AccordionDetails,\r\n  Tooltip,\r\n  IconButton\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  ExpandMore,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Warning,\r\n  Info,\r\n  HelpOutline\r\n} from '@mui/icons-material';\r\nimport { Trade } from '../types/dualWrite';\r\nimport { TagPatternInsight, ScoreSettings } from '../types/score';\r\nimport { tagPatternService } from '../services/tagPatternService';\r\nimport { getTagChipStyles, formatTagForDisplay } from '../utils/tagColors';\r\n\r\ninterface TagPatternAnalysisProps {\r\n  trades: Trade[];\r\n  selectedDate?: Date;\r\n  settings?: ScoreSettings;\r\n}\r\n\r\nconst TagPatternAnalysis: React.FC<TagPatternAnalysisProps> = ({\r\n  trades,\r\n  selectedDate = new Date(),\r\n  settings\r\n}) => {\r\n  const theme = useTheme();\r\n  const [analysis, setAnalysis] = useState<Awaited<ReturnType<typeof tagPatternService.analyzeTagPatterns>> | null>(null);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  // Calculate tag pattern analysis using async worker\r\n  useEffect(() => {\r\n    const calculateAnalysis = async () => {\r\n      if (trades.length < 10) {\r\n        setAnalysis(null);\r\n        return;\r\n      }\r\n\r\n      setIsLoading(true);\r\n      try {\r\n        const result = await tagPatternService.analyzeTagPatterns(trades, selectedDate, settings);\r\n        setAnalysis(result);\r\n      } catch (error) {\r\n        console.error('Error analyzing tag patterns:', error);\r\n        setAnalysis(null);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    calculateAnalysis();\r\n  }, [trades, selectedDate, settings]);\r\n\r\n  const getInsightIcon = (type: TagPatternInsight['type']) => {\r\n    switch (type) {\r\n      case 'high_performance':\r\n        return <TrendingUp sx={{ color: theme.palette.success.main }} />;\r\n      case 'declining_pattern':\r\n        return <TrendingDown sx={{ color: theme.palette.error.main }} />;\r\n      case 'market_condition':\r\n        return <Warning sx={{ color: theme.palette.warning.main }} />;\r\n      default:\r\n        return <Info sx={{ color: theme.palette.info.main }} />;\r\n    }\r\n  };\r\n\r\n  const getSeverityColor = (severity: TagPatternInsight['severity']) => {\r\n    switch (severity) {\r\n      case 'high':\r\n        return theme.palette.error.main;\r\n      case 'medium':\r\n        return theme.palette.warning.main;\r\n      case 'low':\r\n        return theme.palette.info.main;\r\n      default:\r\n        return theme.palette.text.secondary;\r\n    }\r\n  };\r\n\r\n  const getWinRateColor = (win_rate: number) => {\r\n    if (win_rate >= 70) return theme.palette.success.main;\r\n    if (win_rate >= 50) return theme.palette.warning.main;\r\n    return theme.palette.error.main;\r\n  };\r\n\r\n  const formatWinRate = (win_rate: number) => {\r\n    return `${win_rate.toFixed(1)}%`;\r\n  };\r\n\r\n  // Show loading state\r\n  if (isLoading) {\r\n    return (\r\n      <Card\r\n        sx={{\r\n          borderRadius: 3,\r\n          boxShadow: 'none',\r\n          border: `1px solid ${theme.palette.divider}`,\r\n          mb: 3\r\n        }}\r\n      >\r\n        <CardContent>\r\n          <Typography variant=\"h6\" gutterBottom sx={{ fontWeight: 600 }}>\r\n             Tag Pattern Analysis\r\n          </Typography>\r\n          <Box sx={{ mt: 2 }}>\r\n            <LinearProgress />\r\n            <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 1 }}>\r\n              Analyzing tag patterns with Web Worker...\r\n            </Typography>\r\n          </Box>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  if (!analysis || trades.length < 10) {\r\n    return (\r\n      <Card\r\n        sx={{\r\n          backgroundColor: theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.background.paper, 0.8)\r\n            : theme.palette.background.paper,\r\n          borderRadius: 2,\r\n          boxShadow: theme.shadows[2],\r\n          border: `1px solid ${theme.palette.mode === 'dark'\r\n            ? alpha(theme.palette.common.white, 0.1)\r\n            : alpha(theme.palette.common.black, 0.1)}`\r\n        }}\r\n      >\r\n        <CardContent sx={{ p: 3 }}>\r\n          <Typography variant=\"h6\" gutterBottom>\r\n             Tag Pattern Analysis\r\n          </Typography>\r\n          <Alert severity=\"info\">\r\n            Add more trades to see tag pattern analysis. We need at least 10 trades to identify meaningful patterns and trends.\r\n          </Alert>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.background.paper, 0.8)\r\n          : theme.palette.background.paper,\r\n        borderRadius: 2,\r\n        boxShadow: theme.shadows[2],\r\n        border: `1px solid ${theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.common.white, 0.1)\r\n          : alpha(theme.palette.common.black, 0.1)}`\r\n      }}\r\n    >\r\n      <CardContent sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={3}>\r\n          <Typography variant=\"h6\" sx={{ fontWeight: 600 }}>\r\n             Tag Pattern Analysis\r\n          </Typography>\r\n          <Tooltip title=\"Analysis of tag combinations to identify high-performing patterns and declining trends\">\r\n            <IconButton size=\"small\">\r\n              <HelpOutline fontSize=\"small\" />\r\n            </IconButton>\r\n          </Tooltip>\r\n        </Stack>\r\n\r\n        {/* Key Insights */}\r\n        {analysis.insights.length > 0 && (\r\n          <Box mb={3}>\r\n            <Typography variant=\"subtitle1\" gutterBottom sx={{ fontWeight: 600 }}>\r\n               Key Insights\r\n            </Typography>\r\n            <Stack spacing={2}>\r\n              {analysis.insights.slice(0, 3).map((insight, index) => (\r\n                <Alert\r\n                  key={index}\r\n                  severity={\r\n                    insight.type === 'high_performance' ? 'success' :\r\n                    insight.type === 'declining_pattern' ? 'error' : 'warning'\r\n                  }\r\n                  icon={getInsightIcon(insight.type)}\r\n                  sx={{\r\n                    backgroundColor: alpha(getSeverityColor(insight.severity), 0.1),\r\n                    border: `1px solid ${alpha(getSeverityColor(insight.severity), 0.2)}`,\r\n                    '& .MuiAlert-icon': {\r\n                      color: getSeverityColor(insight.severity)\r\n                    }\r\n                  }}\r\n                >\r\n                  <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n                    {insight.title}\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" gutterBottom>\r\n                    {insight.description}\r\n                  </Typography>\r\n                  <Box sx={{ mt: 1, mb: 1 }}>\r\n                    <Stack direction=\"row\" spacing={1} flexWrap=\"wrap\">\r\n                      {insight.tagCombination.map(tag => (\r\n                        <Chip\r\n                          key={tag}\r\n                          label={formatTagForDisplay(tag)}\r\n                          size=\"small\"\r\n                          sx={getTagChipStyles(tag, theme)}\r\n                        />\r\n                      ))}\r\n                    </Stack>\r\n                  </Box>\r\n                  <Typography variant=\"body2\" sx={{ fontStyle: 'italic' }}>\r\n                     {insight.recommendation}\r\n                  </Typography>\r\n                </Alert>\r\n              ))}\r\n            </Stack>\r\n          </Box>\r\n        )}\r\n\r\n        {/* Top Performing Combinations */}\r\n        {analysis.topCombinations.length > 0 && (\r\n          <Accordion defaultExpanded>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" sx={{ fontWeight: 600 }}>\r\n                 Top Performing Tag Combinations\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Stack spacing={2}>\r\n                {analysis.topCombinations.slice(0, 5).map((combo, index) => (\r\n                  <Box\r\n                    key={index}\r\n                    sx={{\r\n                      p: 2,\r\n                      borderRadius: 2,\r\n                      backgroundColor: theme.palette.mode === 'dark'\r\n                        ? alpha(theme.palette.background.paper, 0.4)\r\n                        : alpha(theme.palette.background.paper, 0.8),\r\n                      border: `1px solid ${alpha(theme.palette.divider, 0.2)}`\r\n                    }}\r\n                  >\r\n                    <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={1}>\r\n                      <Stack direction=\"row\" spacing={1} flexWrap=\"wrap\">\r\n                        {combo.tags.map(tag => (\r\n                          <Chip\r\n                            key={tag}\r\n                            label={formatTagForDisplay(tag)}\r\n                            size=\"small\"\r\n                            sx={getTagChipStyles(tag, theme)}\r\n                          />\r\n                        ))}\r\n                      </Stack>\r\n                      <Typography\r\n                        variant=\"h6\"\r\n                        sx={{\r\n                          color: getWinRateColor(combo.win_rate),\r\n                          fontWeight: 'bold'\r\n                        }}\r\n                      >\r\n                        {formatWinRate(combo.win_rate)}\r\n                      </Typography>\r\n                    </Stack>\r\n                    \r\n                    <LinearProgress\r\n                      variant=\"determinate\"\r\n                      value={combo.win_rate}\r\n                      sx={{\r\n                        height: 6,\r\n                        borderRadius: 3,\r\n                        backgroundColor: theme.palette.mode === 'dark'\r\n                          ? alpha(theme.palette.common.white, 0.1)\r\n                          : theme.palette.grey[200],\r\n                        '& .MuiLinearProgress-bar': {\r\n                          backgroundColor: getWinRateColor(combo.win_rate),\r\n                          borderRadius: 3\r\n                        }\r\n                      }}\r\n                    />\r\n                    \r\n                    <Stack direction=\"row\" spacing={3} mt={1}>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        <strong>Trades:</strong> {combo.total_trades}\r\n                      </Typography>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        <strong>W/L:</strong> {combo.wins}/{combo.losses}\r\n                      </Typography>\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        <strong>Avg P&L:</strong> {combo.avgPnL > 0 ? '+' : ''}{combo.avgPnL.toFixed(2)}\r\n                      </Typography>\r\n                      {combo.trend !== 'stable' && (\r\n                        <Typography\r\n                          variant=\"caption\"\r\n                          sx={{\r\n                            color: combo.trend === 'improving' \r\n                              ? theme.palette.success.main \r\n                              : theme.palette.error.main,\r\n                            fontWeight: 600\r\n                          }}\r\n                        >\r\n                          {combo.trend === 'improving' ? ' Improving' : ' Declining'}\r\n                        </Typography>\r\n                      )}\r\n                    </Stack>\r\n                  </Box>\r\n                ))}\r\n              </Stack>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n        )}\r\n\r\n        {/* Declining Patterns */}\r\n        {analysis.decliningCombinations.length > 0 && (\r\n          <Accordion sx={{ mt: 2 }}>\r\n            <AccordionSummary expandIcon={<ExpandMore />}>\r\n              <Typography variant=\"subtitle1\" sx={{ fontWeight: 600, color: theme.palette.error.main }}>\r\n                 Declining Patterns\r\n              </Typography>\r\n            </AccordionSummary>\r\n            <AccordionDetails>\r\n              <Stack spacing={2}>\r\n                {analysis.decliningCombinations.map((combo, index) => (\r\n                  <Box\r\n                    key={index}\r\n                    sx={{\r\n                      p: 2,\r\n                      borderRadius: 2,\r\n                      backgroundColor: alpha(theme.palette.error.main, 0.05),\r\n                      border: `1px solid ${alpha(theme.palette.error.main, 0.2)}`\r\n                    }}\r\n                  >\r\n                    <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" mb={1}>\r\n                      <Stack direction=\"row\" spacing={1} flexWrap=\"wrap\">\r\n                        {combo.tags.map(tag => (\r\n                          <Chip\r\n                            key={tag}\r\n                            label={formatTagForDisplay(tag)}\r\n                            size=\"small\"\r\n                            sx={getTagChipStyles(tag, theme)}\r\n                          />\r\n                        ))}\r\n                      </Stack>\r\n                      <Stack alignItems=\"flex-end\">\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          {formatWinRate(combo.historicalWinRate)}  {formatWinRate(combo.recentWinRate)}\r\n                        </Typography>\r\n                        <Typography\r\n                          variant=\"body2\"\r\n                          sx={{ color: theme.palette.error.main, fontWeight: 600 }}\r\n                        >\r\n                          -{(combo.historicalWinRate - combo.recentWinRate).toFixed(1)}%\r\n                        </Typography>\r\n                      </Stack>\r\n                    </Stack>\r\n                    \r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      This combination has declined from {formatWinRate(combo.historicalWinRate)} to {formatWinRate(combo.recentWinRate)} win rate recently.\r\n                      Consider reviewing your approach or market conditions.\r\n                    </Typography>\r\n                  </Box>\r\n                ))}\r\n              </Stack>\r\n            </AccordionDetails>\r\n          </Accordion>\r\n        )}\r\n\r\n        {/* No significant patterns found */}\r\n        {analysis.insights.length === 0 && analysis.topCombinations.length === 0 && (\r\n          <Alert severity=\"info\" sx={{ mt: 2 }}>\r\n            <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n               Building Pattern Database\r\n            </Typography>\r\n            <Typography variant=\"body2\">\r\n              Continue trading to build a larger dataset. More trades will help identify stronger patterns and trends in your tag combinations.\r\n            </Typography>\r\n          </Alert>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default TagPatternAnalysis;\r\n","import React, { useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Stack,\r\n  Alert,\r\n  useTheme,\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  IconButton,\r\n  CircularProgress,\r\n  LinearProgress\r\n} from '@mui/material';\r\nimport { useMediaQuery } from '@mui/material';\r\n\r\nimport { alpha } from '@mui/material/styles';\r\nimport { Close } from '@mui/icons-material';\r\nimport { Trade, Calendar } from '../../types/dualWrite';\r\nimport { ScoreSettings, ScoreAnalysis } from '../../types/score';\r\nimport { DynamicRiskSettings } from '../../utils/dynamicRiskUtils';\r\nimport { scoreService } from '../../services/scoreService';\r\n\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport ScoreCard from './ScoreCard';\r\nimport ScoreBreakdown from './ScoreBreakdown';\r\nimport ScoreHistory from './ScoreHistory';\r\nimport ScoreSettingsComponent from './ScoreSettings';\r\nimport TagPatternAnalysis from '../TagPatternAnalysis';\r\nimport RoundedTabs, { TabPanel } from '../common/RoundedTabs';\r\nimport { logger } from '../../utils/logger';\r\ninterface ScoreSectionProps {\r\n  trades: Trade[];\r\n  selectedDate: Date;\r\n  calendarId: string;\r\n  scoreSettings?: ScoreSettings;\r\n  onUpdateCalendarProperty?: (calendarId: string, updateCallback: (calendar: Calendar) => Calendar) => Promise<Calendar | undefined>;\r\n  // Dynamic risk settings\r\n  accountBalance?: number;\r\n  dynamicRiskSettings?: DynamicRiskSettings;\r\n  allTags?: string[]; // Add allTags prop to receive calendar.tags\r\n  timePeriod?: 'month' | 'year' | 'all'; // Parent chart time period to restrict available score periods\r\n}\r\n\r\n\r\n\r\nconst ScoreSection: React.FC<ScoreSectionProps> = ({\r\n  trades,\r\n  selectedDate,\r\n  calendarId,\r\n  scoreSettings,\r\n  onUpdateCalendarProperty,\r\n  accountBalance,\r\n  dynamicRiskSettings,\r\n  allTags,\r\n  timePeriod = 'all' // Default to 'all' if not provided\r\n}) => {\r\n  const theme = useTheme();\r\n  const isXs = useMediaQuery(theme.breakpoints.down('sm'));\r\n  const [activeTab, setActiveTab] = useState(0);\r\n  const scorePeriod = 'monthly';\r\n  const [historyPeriod, setHistoryPeriod] = useState<'daily' | 'weekly' | 'monthly' | 'yearly'>('monthly');\r\n  const [settings, setSettings] = useState<ScoreSettings>(scoreSettings || scoreService.getSettings());\r\n  const [selectedTags, setSelectedTags] = useState<string[]>(scoreSettings?.selectedTags || []);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [isCalculating, setIsCalculating] = useState(false);\r\n  const [isLoadingHistory, setIsLoadingHistory] = useState(false);\r\n  const [isLoadingMultiPeriod, setIsLoadingMultiPeriod] = useState(false);\r\n\r\n  const [scoreAnalysis, setScoreAnalysis] = useState<ScoreAnalysis | null>(null);\r\n  const [scoreHistory, setScoreHistory] = useState<any[]>([]);\r\n  const [multiPeriodScores, setMultiPeriodScores] = useState<any>(null);\r\n\r\n  // Cache for score history to avoid recalculating when switching tabs\r\n  const scoreHistoryCache = useRef<Map<string, any[]>>(new Map());\r\n\r\n  // State for breakdown modal\r\n  const [breakdownModalOpen, setBreakdownModalOpen] = useState(false);\r\n  const [selectedBreakdownData, setSelectedBreakdownData] = useState<{\r\n    analysis: ScoreAnalysis;\r\n    period: 'daily' | 'weekly' | 'monthly' | 'yearly';\r\n  } | null>(null);\r\n\r\n  // Initialize settings from calendar props when they change\r\n  useEffect(() => {\r\n    if (scoreSettings) {\r\n      setSettings(scoreSettings);\r\n      setSelectedTags(scoreSettings.selectedTags || []);\r\n    }\r\n  }, [scoreSettings]);\r\n\r\n  // Update score service settings when local settings change\r\n  useEffect(() => {\r\n    scoreService.updateSettings(settings);\r\n  }, [settings]);\r\n\r\n  // Update score service settings when selected tags change\r\n  useEffect(() => {\r\n    const updatedSettings = { ...settings, selectedTags };\r\n    scoreService.updateSettings(updatedSettings);\r\n  }, [selectedTags, settings]);\r\n\r\n  // Determine available score history periods based on parent chart time period\r\n  const availablePeriods = React.useMemo((): ('daily' | 'weekly' | 'monthly' | 'yearly')[] => {\r\n    switch (timePeriod) {\r\n      case 'month':\r\n        // For monthly view: only daily and weekly\r\n        return ['daily', 'weekly'];\r\n      case 'year':\r\n        // For yearly view: daily, weekly, and monthly\r\n        return ['daily', 'weekly', 'monthly'];\r\n      case 'all':\r\n      default:\r\n        // For all time view: all periods available\r\n        return ['daily', 'weekly', 'monthly', 'yearly'];\r\n    }\r\n  }, [timePeriod]);\r\n\r\n  // Ensure current historyPeriod is valid when parent timePeriod changes\r\n  useEffect(() => {\r\n    if (!availablePeriods.includes(historyPeriod)) {\r\n      // If current period is not available, switch to the most granular available period\r\n      setHistoryPeriod(availablePeriods[availablePeriods.length - 1]);\r\n    }\r\n  }, [availablePeriods, historyPeriod]);\r\n\r\n  // Update dynamic risk settings in score service\r\n  useEffect(() => {\r\n    if (accountBalance !== undefined) {\r\n      scoreService.updateDynamicRiskSettings({\r\n        account_balance: accountBalance,\r\n        risk_per_trade: dynamicRiskSettings?.risk_per_trade,\r\n        dynamic_risk_enabled: dynamicRiskSettings?.dynamic_risk_enabled,\r\n        increased_risk_percentage: dynamicRiskSettings?.increased_risk_percentage,\r\n        profit_threshold_percentage: dynamicRiskSettings?.profit_threshold_percentage\r\n      });\r\n    }\r\n  }, [accountBalance, dynamicRiskSettings]);\r\n\r\n  // Calculate current score analysis\r\n  useEffect(() => {\r\n    if (trades.length === 0) {\r\n      setScoreAnalysis(null);\r\n      return;\r\n    }\r\n\r\n    const calculateScoreAnalysis = async () => {\r\n      setIsCalculating(true);\r\n      try {\r\n        // Ensure score service has the latest settings before calculation\r\n        const updatedSettings = { ...settings, selectedTags };\r\n        scoreService.updateSettings(updatedSettings);\r\n        const analysis = await scoreService.calculateScore(trades, scorePeriod, selectedDate, updatedSettings);\r\n        setScoreAnalysis(analysis);\r\n      } catch (error) {\r\n        logger.error('Error calculating score:', error);\r\n        setScoreAnalysis(null);\r\n      } finally {\r\n        setIsCalculating(false);\r\n      }\r\n    };\r\n\r\n    calculateScoreAnalysis();\r\n  }, [trades, scorePeriod, selectedDate, selectedTags, settings]);\r\n\r\n  // Calculate score history\r\n  useEffect(() => {\r\n    if (trades.length === 0) {\r\n      setScoreHistory([]);\r\n      setIsLoadingHistory(false);\r\n      return;\r\n    }\r\n\r\n    const calculateScoreHistory = async () => {\r\n      // Generate cache key based on calculation parameters\r\n      const cacheKey = JSON.stringify({\r\n        tradesCount: trades.length,\r\n        historyPeriod,\r\n        selectedTags: selectedTags.sort(),\r\n        settingsKey: `${settings.thresholds.minTradesForScore}-${settings.weights.consistency}`,\r\n        selectedDate: selectedDate.toISOString().split('T')[0],\r\n        timePeriod\r\n      });\r\n\r\n      // Check cache first\r\n      const cachedHistory = scoreHistoryCache.current.get(cacheKey);\r\n      if (cachedHistory) {\r\n        // Use cached data immediately without loading\r\n        setScoreHistory(cachedHistory);\r\n        setIsLoadingHistory(false);\r\n        return;\r\n      }\r\n\r\n      setIsLoadingHistory(true);\r\n      try {\r\n        // Ensure score service has the latest settings before calculation\r\n        const updatedSettings = { ...settings, selectedTags };\r\n        scoreService.updateSettings(updatedSettings);\r\n\r\n        // Determine number of periods based on parent time period and history period\r\n        let periodsBack = 12;\r\n        if (timePeriod === 'month') {\r\n          // For monthly view, limit to current month\r\n          if (historyPeriod === 'daily') {\r\n            // Show days in the selected month (max ~31)\r\n            periodsBack = 31;\r\n          } else if (historyPeriod === 'weekly') {\r\n            // Show weeks in the selected month (max 5)\r\n            periodsBack = 5;\r\n          } else if (historyPeriod === 'monthly') {\r\n            // Show just the current month\r\n            periodsBack = 1;\r\n          }\r\n        } else if (timePeriod === 'year') {\r\n          // For yearly view, limit to current year\r\n          if (historyPeriod === 'daily') {\r\n            // Show days in the selected year (max ~365)\r\n            periodsBack = 365;\r\n          } else if (historyPeriod === 'weekly') {\r\n            // Show weeks in the selected year (max 53)\r\n            periodsBack = 53;\r\n          } else if (historyPeriod === 'monthly') {\r\n            // Show months in the selected year (12)\r\n            periodsBack = 12;\r\n          } else if (historyPeriod === 'yearly') {\r\n            // Show just the current year\r\n            periodsBack = 1;\r\n          }\r\n        } else {\r\n          // For 'all' view, show last 12 periods\r\n          periodsBack = 12;\r\n        }\r\n\r\n        let history = await scoreService.getScoreHistory(\r\n          trades,\r\n          historyPeriod,\r\n          periodsBack,\r\n          updatedSettings,\r\n          selectedDate // Pass selected date as reference\r\n        );\r\n\r\n        // Filter history to only include periods within the parent time period bounds\r\n        if (timePeriod === 'month') {\r\n          // Only show scores from the selected month\r\n          const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);\r\n          const monthEnd = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0);\r\n          history = history.filter(entry => {\r\n            const entryDate = new Date(entry.date);\r\n            return entryDate >= monthStart && entryDate <= monthEnd;\r\n          });\r\n        } else if (timePeriod === 'year') {\r\n          // Only show scores from the selected year\r\n          const yearStart = new Date(selectedDate.getFullYear(), 0, 1);\r\n          const yearEnd = new Date(selectedDate.getFullYear(), 11, 31);\r\n          history = history.filter(entry => {\r\n            const entryDate = new Date(entry.date);\r\n            return entryDate >= yearStart && entryDate <= yearEnd;\r\n          });\r\n        }\r\n\r\n        // Store in cache for future use\r\n        scoreHistoryCache.current.set(cacheKey, history);\r\n\r\n        // Clear old cache entries if cache gets too large (keep last 10)\r\n        if (scoreHistoryCache.current.size > 10) {\r\n          const firstKey = scoreHistoryCache.current.keys().next().value;\r\n          if (firstKey) {\r\n            scoreHistoryCache.current.delete(firstKey);\r\n          }\r\n        }\r\n\r\n        setScoreHistory(history);\r\n      } catch (error) {\r\n        logger.error('Error calculating score history:', error);\r\n        setScoreHistory([]);\r\n      } finally {\r\n        setIsLoadingHistory(false);\r\n      }\r\n    };\r\n\r\n    calculateScoreHistory();\r\n  }, [trades, historyPeriod, selectedTags, settings, selectedDate, timePeriod]);\r\n\r\n  // Calculate multi-period scores for overview\r\n  useEffect(() => {\r\n    if (trades.length === 0) {\r\n      logger.warn('ScoreSection: No trades available for multi-period calculation');\r\n      setMultiPeriodScores(null);\r\n      setIsLoadingMultiPeriod(false);\r\n      return;\r\n    }\r\n\r\n    const calculateMultiPeriodScores = async () => {\r\n      setIsLoadingMultiPeriod(true);\r\n      try {\r\n        logger.debug('ScoreSection: Starting multi-period score calculation', {\r\n          tradesCount: trades.length,\r\n          selectedDate: selectedDate.toISOString(),\r\n          selectedTags: selectedTags.length\r\n        });\r\n\r\n        // Ensure score service has the latest settings before calculation\r\n        const updatedSettings = { ...settings, selectedTags };\r\n        scoreService.updateSettings(updatedSettings);\r\n        const scores = await scoreService.calculateMultiPeriodScore(trades, selectedDate, updatedSettings);\r\n\r\n        logger.debug('ScoreSection: Multi-period scores calculated successfully', {\r\n          dailyScore: scores.daily.currentScore.overall,\r\n          weeklyScore: scores.weekly.currentScore.overall,\r\n          monthlyScore: scores.monthly.currentScore.overall,\r\n          yearlyScore: scores.yearly.currentScore.overall\r\n        });\r\n\r\n        setMultiPeriodScores(scores);\r\n      } catch (error) {\r\n        logger.error('ScoreSection: Error calculating multi-period scores:', error);\r\n        console.error('ScoreSection multi-period calculation error details:', {\r\n          error,\r\n          tradesCount: trades.length,\r\n          selectedDate: selectedDate.toISOString(),\r\n          sampleTrade: trades[0]\r\n        });\r\n        setMultiPeriodScores(null);\r\n      } finally {\r\n        setIsLoadingMultiPeriod(false);\r\n      }\r\n    };\r\n\r\n    calculateMultiPeriodScores();\r\n  }, [trades, selectedDate, selectedTags, settings]);\r\n\r\n\r\n\r\n\r\n  const handleTabChange = (_: React.SyntheticEvent, newValue: number) => {\r\n    setActiveTab(newValue);\r\n  };\r\n\r\n  // Define tabs for RoundedTabs component\r\n  const tabs = [\r\n    { label: 'Overview' },\r\n    { label: 'History' },\r\n    { label: 'Patterns' },\r\n    { label: 'Settings' }\r\n  ];\r\n\r\n  const handleHistoryPeriodChange = (newPeriod: 'daily' | 'weekly' | 'monthly' | 'yearly') => {\r\n    setHistoryPeriod(newPeriod);\r\n  };\r\n\r\n  // Handler for opening breakdown modal\r\n  const handleScoreCardClick = (period: 'daily' | 'weekly' | 'monthly' | 'yearly') => {\r\n    if (!multiPeriodScores) return;\r\n\r\n    const analysis = multiPeriodScores[period];\r\n    if (analysis) {\r\n      setSelectedBreakdownData({ analysis, period });\r\n      setBreakdownModalOpen(true);\r\n    }\r\n  };\r\n\r\n  // Handler for closing breakdown modal\r\n  const handleCloseBreakdownModal = () => {\r\n    setBreakdownModalOpen(false);\r\n    setSelectedBreakdownData(null);\r\n  };\r\n\r\n  const handleSettingsChange = (newSettings: ScoreSettings) => {\r\n    setSettings(newSettings);\r\n  };\r\n\r\n  const handleSettingsSave = async (tagsOverride?: string[]) => {\r\n    if (!onUpdateCalendarProperty) return;\r\n\r\n    setIsSaving(true);\r\n    try {\r\n      const updatedSettings = { ...settings, selectedTags: tagsOverride ?? selectedTags };\r\n      await onUpdateCalendarProperty(calendarId, (calendar) => ({\r\n        ...calendar,\r\n        score_settings: updatedSettings\r\n      }));\r\n    } catch (error) {\r\n      logger.error('Error saving score settings:', error);\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  const handleTagsChange = async (tags: string[]) => {\r\n    setSelectedTags(tags);\r\n\r\n    // Auto-save tags to calendar when they change\r\n    if (onUpdateCalendarProperty) {\r\n      // Pass the new tags directly to ensure they're saved\r\n      await handleSettingsSave(tags);\r\n    }\r\n  };\r\n\r\n  // Fallback to localStorage if no calendar settings are provided\r\n  useEffect(() => {\r\n    if (!scoreSettings && !onUpdateCalendarProperty) {\r\n      const savedSettings = localStorage.getItem('scoreSettings');\r\n      if (savedSettings) {\r\n        try {\r\n          const parsedSettings = JSON.parse(savedSettings);\r\n          setSettings(parsedSettings);\r\n          setSelectedTags(parsedSettings.selectedTags || []);\r\n        } catch (error) {\r\n          logger.error('Error loading saved settings from localStorage:', error);\r\n        }\r\n      }\r\n    }\r\n  }, [scoreSettings, onUpdateCalendarProperty]);\r\n\r\n  if (trades.length === 0) {\r\n    return (\r\n      <Paper sx={{ p: { xs: 2, sm: 3 } }}>\r\n        <Typography variant={isXs ? 'subtitle1' : 'h6'} gutterBottom>\r\n           Trading Score\r\n        </Typography>\r\n        <Alert severity=\"info\">\r\n          Start adding trades to see your trading score and performance analysis.\r\n          The scoring system will evaluate your consistency, risk management, performance, and discipline.\r\n        </Alert>\r\n      </Paper>\r\n    );\r\n  }\r\n\r\n  if (trades.length < settings.thresholds.minTradesForScore) {\r\n    return (\r\n      <Paper sx={{ p: { xs: 2, sm: 3 } }}>\r\n        <Typography variant={isXs ? 'subtitle1' : 'h6'} gutterBottom>\r\n           Trading Score\r\n        </Typography>\r\n        <Alert severity=\"warning\">\r\n          You need at least {settings.thresholds.minTradesForScore} trades to calculate your score.\r\n          Current trades: {trades.length}\r\n        </Alert>\r\n      </Paper>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Paper\r\n      data-testid=\"score-section\"\r\n      sx={{\r\n        p: 0,\r\n        backgroundColor: theme.palette.mode === 'dark'\r\n          ? alpha(theme.palette.background.paper, 0.8)\r\n          : theme.palette.background.paper,\r\n        borderRadius: 2,\r\n        boxShadow: theme.shadows[2],\r\n        border: `1px solid ${theme.palette.mode === 'dark'\r\n          ? 'rgba(204, 204, 204, 0.1)'\r\n          : alpha(theme.palette.common.black, 0.1)}`\r\n      }}\r\n    >\r\n      <Box sx={{ px: { xs: 2, sm: 3 }, pt: { xs: 2, sm: 3 } }}>\r\n        <Stack direction={{ xs: 'column', sm: 'row' }} alignItems={{ xs: 'flex-start', sm: 'center' }} justifyContent=\"space-between\" mb={{ xs: 2, sm: 3 }}>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              color: theme.palette.text.primary,\r\n              fontWeight: 600\r\n            }}\r\n          >\r\n             Trading Score Analysis\r\n          </Typography>\r\n\r\n          <RoundedTabs\r\n            tabs={tabs}\r\n            activeTab={activeTab}\r\n            onTabChange={handleTabChange}\r\n          />\r\n        </Stack>\r\n      </Box>\r\n\r\n      <Box sx={{ px: { xs: 2, sm: 3 }, pb: { xs: 2, sm: 3 } }}>\r\n        {/* Overview Tab */}\r\n        <TabPanel value={activeTab} index={0}>\r\n          <Box>\r\n            {isLoadingMultiPeriod && (\r\n              <LinearProgress\r\n                sx={{\r\n                  mb: 2,\r\n                  borderRadius: 1\r\n                }}\r\n              />\r\n            )}\r\n            <Stack spacing={4}>\r\n              {/* Multi-period score cards */}\r\n              {multiPeriodScores ? (\r\n              <Box>\r\n\r\n                <Typography\r\n                  variant=\"body2\"\r\n                  sx={{\r\n                    color: theme.palette.text.secondary,\r\n                    mb: 1,\r\n                    fontStyle: 'italic'\r\n                  }}\r\n                >\r\n                  Click on any score card to see detailed breakdown\r\n                </Typography>\r\n                <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2} sx={{ flexWrap: 'wrap' }}>\r\n                  <Box\r\n                    onClick={() => handleScoreCardClick('daily')}\r\n                    sx={{\r\n                      cursor: 'pointer',\r\n                      transition: 'transform 0.2s',\r\n                      '&:hover': { transform: 'translateY(-2px)' },\r\n                      flex: { xs: '1', sm: '1 1 calc(50% - 8px)', md: '1 1 calc(25% - 12px)' }\r\n                    }}\r\n                  >\r\n                    <ScoreCard\r\n                      score={multiPeriodScores.daily.currentScore}\r\n                      trend={multiPeriodScores.daily.trend}\r\n                      period=\"daily\"\r\n                      compact\r\n                    />\r\n                  </Box>\r\n                  <Box\r\n                    onClick={() => handleScoreCardClick('weekly')}\r\n                    sx={{\r\n                      cursor: 'pointer',\r\n                      transition: 'transform 0.2s',\r\n                      '&:hover': { transform: 'translateY(-2px)' },\r\n                      flex: { xs: '1', sm: '1 1 calc(50% - 8px)', md: '1 1 calc(25% - 12px)' }\r\n                    }}\r\n                  >\r\n                    <ScoreCard\r\n                      score={multiPeriodScores.weekly.currentScore}\r\n                      trend={multiPeriodScores.weekly.trend}\r\n                      period=\"weekly\"\r\n                      compact\r\n                    />\r\n                  </Box>\r\n                  <Box\r\n                    onClick={() => handleScoreCardClick('monthly')}\r\n                    sx={{\r\n                      cursor: 'pointer',\r\n                      transition: 'transform 0.2s',\r\n                      '&:hover': { transform: 'translateY(-2px)' },\r\n                      flex: { xs: '1', sm: '1 1 calc(50% - 8px)', md: '1 1 calc(25% - 12px)' }\r\n                    }}\r\n                  >\r\n                    <ScoreCard\r\n                      score={multiPeriodScores.monthly.currentScore}\r\n                      trend={multiPeriodScores.monthly.trend}\r\n                      period=\"monthly\"\r\n                      compact\r\n                    />\r\n                  </Box>\r\n                  <Box\r\n                    onClick={() => handleScoreCardClick('yearly')}\r\n                    sx={{\r\n                      cursor: 'pointer',\r\n                      transition: 'transform 0.2s',\r\n                      '&:hover': { transform: 'translateY(-2px)' },\r\n                      flex: { xs: '1', sm: '1 1 calc(50% - 8px)', md: '1 1 calc(25% - 12px)' }\r\n                    }}\r\n                  >\r\n                    <ScoreCard\r\n                      score={multiPeriodScores.yearly.currentScore}\r\n                      trend={multiPeriodScores.yearly.trend}\r\n                      period=\"yearly\"\r\n                      compact\r\n                    />\r\n                  </Box>\r\n                </Stack>\r\n              </Box>\r\n            ) : (\r\n              <Alert severity=\"warning\">\r\n                <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n                   No Score Data Available\r\n                </Typography>\r\n                <Typography variant=\"body2\">\r\n                  Unable to calculate multi-period scores. This could be because:\r\n                  <br /> No trades found for the current periods\r\n                  <br /> Insufficient trade data for analysis\r\n                  <br /> All trades are outside the selected date range\r\n                </Typography>\r\n              </Alert>\r\n            )}\r\n\r\n\r\n\r\n            {/* Quick recommendations */}\r\n            {scoreAnalysis && scoreAnalysis.recommendations.length > 0 && (\r\n              <Alert\r\n                severity=\"info\"\r\n                sx={{\r\n                  backgroundColor: theme.palette.mode === 'dark'\r\n                    ? alpha(theme.palette.info.main, 0.1)\r\n                    : alpha(theme.palette.info.main, 0.05),\r\n                  border: `1px solid ${alpha(theme.palette.info.main, 0.2)}`,\r\n                  borderRadius: 2,\r\n                  '& .MuiAlert-icon': {\r\n                    color: theme.palette.info.main\r\n                  }\r\n                }}\r\n              >\r\n                <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n                   Quick Tip\r\n                </Typography>\r\n                <Typography variant=\"body2\">\r\n                  {scoreAnalysis.recommendations[0]}\r\n                </Typography>\r\n              </Alert>\r\n            )}\r\n\r\n            {/* No content fallback */}\r\n            {!multiPeriodScores && !scoreAnalysis && (\r\n              <Alert severity=\"info\">\r\n                <Typography variant=\"subtitle2\" gutterBottom sx={{ fontWeight: 600 }}>\r\n                   Get Started with Scoring\r\n                </Typography>\r\n                <Typography variant=\"body2\">\r\n                  To see your trading score analysis:\r\n                  <br /> Add at least {settings.thresholds.minTradesForScore} trades\r\n                  <br /> Ensure trades have dates within the current periods\r\n                  <br /> Include session, tags, and risk/reward data for better analysis\r\n                </Typography>\r\n              </Alert>\r\n            )}\r\n            </Stack>\r\n          </Box>\r\n        </TabPanel>\r\n\r\n        {/* Score History Tab */}\r\n        <TabPanel value={activeTab} index={1}>\r\n          <ScoreHistory\r\n            history={scoreHistory}\r\n            period={historyPeriod}\r\n            onPeriodChange={handleHistoryPeriodChange}\r\n            availablePeriods={availablePeriods}\r\n            isLoading={isLoadingHistory}\r\n          />\r\n        </TabPanel>\r\n\r\n        {/* Pattern Analysis Tab */}\r\n        <TabPanel value={activeTab} index={2}>\r\n          <TagPatternAnalysis\r\n            trades={trades}\r\n            selectedDate={selectedDate}\r\n            settings={settings}\r\n          />\r\n        </TabPanel>\r\n\r\n        {/* Settings Tab */}\r\n        <TabPanel value={activeTab} index={3}>\r\n          <Stack spacing={3}>\r\n            <ScoreSettingsComponent\r\n              settings={settings}\r\n              onSettingsChange={handleSettingsChange}\r\n              onSave={handleSettingsSave}\r\n              isSaving={isSaving}\r\n              trades={trades}\r\n              selectedTags={selectedTags}\r\n              onTagsChange={handleTagsChange}\r\n              allTags={allTags}\r\n            />\r\n          </Stack>\r\n        </TabPanel>\r\n      </Box>\r\n\r\n      {/* Score Breakdown Modal */}\r\n      <Dialog\r\n        open={breakdownModalOpen}\r\n        onClose={handleCloseBreakdownModal}\r\n        maxWidth=\"lg\"\r\n        fullWidth\r\n        fullScreen={isXs}\r\n        sx={{\r\n          '& .MuiDialog-paper': {\r\n            backgroundColor: theme.palette.mode === 'dark'\r\n              ? alpha(theme.palette.background.paper, 0.95)\r\n              : theme.palette.background.paper,\r\n            borderRadius: 2,\r\n            maxHeight: '90vh'\r\n          },\r\n          '& .MuiDialogContent-root': {\r\n            ...scrollbarStyles(theme)\r\n          }\r\n        }}\r\n      >\r\n        <DialogTitle sx={{\r\n          display: 'flex',\r\n          justifyContent: 'space-between',\r\n          alignItems: 'center',\r\n          pb: 1,\r\n          fontWeight: 600\r\n        }}>\r\n          {selectedBreakdownData ?\r\n            ` ${selectedBreakdownData.period.charAt(0).toUpperCase() + selectedBreakdownData.period.slice(1)} Score Analysis`\r\n            : 'Score Analysis'\r\n          }\r\n          <IconButton\r\n            onClick={handleCloseBreakdownModal}\r\n            sx={{\r\n              color: theme.palette.text.secondary,\r\n              '&:hover': {\r\n                backgroundColor: alpha(theme.palette.text.secondary, 0.1)\r\n              }\r\n            }}\r\n          >\r\n            <Close />\r\n          </IconButton>\r\n        </DialogTitle>\r\n        <DialogContent sx={{ pt: 1 }}>\r\n          {selectedBreakdownData && (\r\n            <ScoreBreakdown\r\n              breakdown={selectedBreakdownData.analysis.breakdown}\r\n              pattern={selectedBreakdownData.analysis.pattern}\r\n              recommendations={selectedBreakdownData.analysis.recommendations}\r\n              strengths={selectedBreakdownData.analysis.strengths}\r\n              weaknesses={selectedBreakdownData.analysis.weaknesses}\r\n            />\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default ScoreSection;\r\n","import { format, eachDayOfInterval, startOfMonth, endOfMonth, isSameMonth, getDay, parseISO } from 'date-fns';\r\nimport { Trade } from '../types/dualWrite';\r\nimport { Theme } from '@mui/material';\r\n\r\nexport type TimePeriod = 'month' | 'year' | 'all';\r\n\r\nexport interface ChartDataPoint {\r\n  date: string;\r\n  pnl: number;\r\n  cumulativePnL: number;\r\n  isIncreasing: boolean;\r\n  isDecreasing: boolean;\r\n  dailyChange: number;\r\n  isWin: boolean;\r\n  isLoss: boolean;\r\n  isBreakEven: boolean;\r\n  trades: Trade[];\r\n  fullDate: Date;\r\n}\r\n\r\nexport interface SessionStats {\r\n  session: string;\r\n  total_trades: number;\r\n  winners: number;\r\n  losers: number;\r\n  breakevens: number;\r\n  win_rate: number;\r\n  total_pnl: number;\r\n  averagePnL: number;\r\n  pnlPercentage: number;\r\n}\r\n\r\nexport const getNormalizedDate = (selectedDate: Date) => {\r\n  // Convert selectedDate to noon UTC to avoid timezone issues\r\n        // This ensures that date_trunc('month', ...) works correctly regardless of timezone\r\n        return new Date(Date.UTC(\r\n          selectedDate.getFullYear(),\r\n          selectedDate.getMonth(),\r\n          selectedDate.getDate(),\r\n          12, 0, 0, 0\r\n        ));\r\n};\r\n\r\n// Function to filter trades based on selected time period\r\nexport const getFilteredTrades = (trades: Trade[], selectedDate: Date, period: TimePeriod): Trade[] => {\r\n  if (!trades) return [];\r\n\r\n  switch (period) {\r\n    case 'month':\r\n      return trades.filter(trade => isSameMonth(new Date(trade.trade_date), selectedDate));\r\n    case 'year':\r\n      return trades.filter(trade => new Date(trade.trade_date).getFullYear() === selectedDate.getFullYear());\r\n    case 'all':\r\n      return trades;\r\n    default:\r\n      return trades;\r\n  }\r\n};\r\nexport const getTradesStats = (trades: Trade[]) => {\r\n  // Guard against undefined trades\r\n  if (!trades || trades.length === 0) {\r\n    return {\r\n      trades: [],\r\n      wins: 0,\r\n      losses: 0,\r\n      breakevens: 0,\r\n      totalTrades: 0,\r\n      winRate: 0,\r\n      total_pnl: 0\r\n    };\r\n  }\r\n\r\n  // Create a map to store stats for each tag\r\n  const stats = { wins: 0, losses: 0, breakevens: 0, total_pnl: 0 };\r\n  trades.forEach(trade => {\r\n    if (trade.trade_type === 'win') {\r\n      stats.wins++;\r\n    } else if (trade.trade_type === 'loss') {\r\n      stats.losses++;\r\n    } else if (trade.trade_type === 'breakeven') {\r\n      stats.breakevens++;\r\n    }\r\n    stats.total_pnl += trade.amount;\r\n  });\r\n\r\n  // Calculate win rate excluding breakevens from the denominator\r\n  const totalTradesForWinRate = stats.wins + stats.losses;\r\n  const winRate = totalTradesForWinRate > 0 ? Math.round((stats.wins / totalTradesForWinRate) * 100) : 0;\r\n  const totalTrades = stats.wins + stats.losses + stats.breakevens;\r\n\r\n  return {\r\n    trades,\r\n    wins: stats.wins,\r\n    losses: stats.losses,\r\n    breakevens: stats.breakevens,\r\n    totalTrades,\r\n    winRate,\r\n    total_pnl: stats.total_pnl\r\n  };\r\n\r\n}\r\n\r\n\r\nexport const getTagDayOfWeekChartData = (\r\ntrades: Trade[],  theme: Theme, winRateMetric : boolean = true) => {\r\n  // Guard against undefined trades\r\n  if (!trades || trades.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Day of week names\r\n  const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\r\n\r\n\r\n  // Group trades by day of week\r\n  const tradesByDay = DAYS_OF_WEEK.map((day, index) => {\r\n    // Get trades for this day of week\r\n    const dayTrades = trades.filter(trade => {\r\n      const tradeDate = new Date(trade.trade_date);\r\n      return getDay(tradeDate) === index;\r\n    });\r\n\r\n    // Calculate statistics\r\n    const totalTrades = dayTrades.length;\r\n    const winTrades = dayTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const lossTrades = dayTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const winRate = totalTrades > 0 ? (winTrades / totalTrades) * 100 : 0;\r\n    const totalPnL = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n    return {\r\n      day,\r\n      dayIndex: index,\r\n      totalTrades,\r\n      winTrades,\r\n      lossTrades,\r\n      winRate,\r\n      pnl: totalPnL,\r\n      trades: dayTrades\r\n    };\r\n  });\r\n   // Define colors - memoized to prevent unnecessary re-renders\r\n    const COLORS = { \r\n      neutral: theme.palette.grey[500],\r\n      sunday: '#FF6384',\r\n      monday: '#36A2EB',\r\n      tuesday: '#FFCE56',\r\n      wednesday: '#4BC0C0',\r\n      thursday: '#9966FF',\r\n      friday: '#FF9F40',\r\n      saturday: '#C9CBCF'\r\n    };\r\n\r\n  return tradesByDay.map(dayData => ({\r\n      day: dayData.day.substring(0, 3), // Abbreviate day names\r\n      fullDay: dayData.day, \r\n      total_trades: dayData.totalTrades,\r\n      win_trades: dayData.winTrades,\r\n      loss_trades: dayData.lossTrades,\r\n      value: winRateMetric? dayData.winRate : dayData.pnl,\r\n      win_rate: dayData.winRate,\r\n      pnl: dayData.pnl,\r\n      trades: dayData.trades,\r\n      color: COLORS[dayData.day.toLowerCase() as keyof typeof COLORS] || COLORS.neutral\r\n    }));\r\n \r\n};\r\n\r\n\r\n// Calculate chart data for cumulative P&L - async to prevent UI blocking\r\nexport const calculateChartData = async (\r\n  trades: Trade[],\r\n  selectedDate: Date,\r\n  timePeriod: TimePeriod\r\n): Promise<ChartDataPoint[]> => {\r\n  const filteredTrades = getFilteredTrades(trades, selectedDate, timePeriod);\r\n\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Get the date range for the selected period\r\n  let startDate, endDate;\r\n  if (timePeriod === 'month') {\r\n    startDate = startOfMonth(selectedDate);\r\n    endDate = endOfMonth(selectedDate);\r\n  } else if (timePeriod === 'year') {\r\n    startDate = new Date(selectedDate.getFullYear(), 0, 1);\r\n    endDate = new Date(selectedDate.getFullYear(), 11, 31);\r\n  } else {\r\n    // For 'all', use the first and last trade dates\r\n    if (filteredTrades.length === 0) {\r\n      startDate = new Date();\r\n      endDate = new Date();\r\n    } else {\r\n      const sortedTrades = [...filteredTrades].sort((a, b) =>\r\n        new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime()\r\n      );\r\n      startDate = new Date(sortedTrades[0].trade_date);\r\n      endDate = new Date(sortedTrades[sortedTrades.length - 1].trade_date);\r\n    }\r\n  }\r\n\r\n  // Generate an array of all days in the period\r\n  const days = eachDayOfInterval({ start: startDate, end: endDate });\r\n\r\n  // Calculate cumulative P&L for each day\r\n  let cumulative = 0;\r\n  let prevCumulative = 0;\r\n\r\n  // Process in chunks to prevent blocking for large datasets\r\n  const chunkSize = 100;\r\n  const result: ChartDataPoint[] = [];\r\n\r\n  for (let i = 0; i < days.length; i += chunkSize) {\r\n    const chunk = days.slice(i, i + chunkSize);\r\n\r\n    // Process each day in the chunk sequentially to avoid unsafe references\r\n    const chunkResult: ChartDataPoint[] = [];\r\n    for (const day of chunk) {\r\n      // Find trades for this day\r\n      const dayTrades = filteredTrades.filter(trade =>\r\n        format(new Date(trade.trade_date), 'yyyy-MM-dd') === format(day, 'yyyy-MM-dd')\r\n      );\r\n\r\n      // Calculate daily P&L\r\n      const dailyPnL = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n      // Update cumulative P&L\r\n      prevCumulative = cumulative;\r\n      cumulative += dailyPnL;\r\n\r\n      chunkResult.push({\r\n        date: format(day, timePeriod === 'month' ? 'MM/dd' : 'MM/dd/yyyy'),\r\n        pnl: dailyPnL,\r\n        cumulativePnL: cumulative,\r\n        isIncreasing: cumulative > prevCumulative,\r\n        isDecreasing: cumulative < prevCumulative,\r\n        dailyChange: cumulative - prevCumulative,\r\n        isWin: dailyPnL > 0,\r\n        isLoss: dailyPnL < 0,\r\n        isBreakEven: dailyPnL === 0,\r\n        trades: dayTrades,\r\n        fullDate: new Date(day)\r\n      });\r\n    }\r\n\r\n    result.push(...chunkResult);\r\n\r\n    // Yield control after each chunk\r\n    if (i + chunkSize < days.length) {\r\n      await new Promise(resolve => setTimeout(resolve, 0));\r\n    }\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\n// Calculate session performance statistics\r\nexport const calculateSessionStats = (\r\n  trades: Trade[],\r\n  selectedDate: Date,\r\n  timePeriod: TimePeriod,\r\n  accountBalance: number\r\n): SessionStats[] => {\r\n  const filteredTrades = getFilteredTrades(trades, selectedDate, timePeriod).filter(trade => trade.session !== undefined);\r\n  const sessions = ['Asia', 'London', 'NY AM', 'NY PM'];\r\n\r\n  return sessions.map(sessionName => {\r\n    const sessionTrades = filteredTrades.filter(trade => trade.session === sessionName);\r\n    const totalTrades = sessionTrades.length;\r\n    const winners = sessionTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const losers = sessionTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const breakevens = sessionTrades.filter(trade => trade.trade_type === 'breakeven').length;\r\n\r\n    // Calculate win rate excluding breakevens from the denominator\r\n    const totalTradesForWinRate = winners + losers;\r\n    const winRate = totalTradesForWinRate > 0 ? (winners / totalTradesForWinRate) * 100 : 0;\r\n\r\n    const totalPnL = sessionTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n    const averagePnL = totalTrades > 0 ? totalPnL / totalTrades : 0;\r\n    const pnlPercentage = accountBalance > 0 ? (totalPnL / accountBalance) * 100 : 0;\r\n\r\n    return {\r\n      session: sessionName,\r\n      total_trades: totalTrades,\r\n      winners,\r\n      losers,\r\n      breakevens,\r\n      win_rate: winRate,\r\n      total_pnl: totalPnL,\r\n      averagePnL,\r\n      pnlPercentage\r\n    };\r\n  });\r\n};\r\n\r\n// Calculate target value for monthly target\r\nexport const calculateTargetValue = (monthlyTarget: number | undefined, accountBalance: number): number | null => {\r\n  if (monthlyTarget === undefined || accountBalance <= 0) return null;\r\n  return (monthlyTarget / 100) * accountBalance;\r\n};\r\n\r\n// Calculate drawdown violation value\r\nexport const calculateDrawdownViolationValue = (maxDailyDrawdown: number, accountBalance: number): number => {\r\n  return -(maxDailyDrawdown / 100) * accountBalance;\r\n};\r\n\r\n// Async performance calculation functions to prevent UI blocking\r\n\r\n// Calculate win/loss statistics asynchronously\r\nexport const calculateWinLossStatsAsync = async (\r\n  filteredTrades: Trade[]\r\n): Promise<{\r\n  total_trades: number;\r\n  win_rate: number;\r\n  winners: {\r\n    total: number;\r\n    avgAmount: number;\r\n    maxConsecutive: number;\r\n    avgConsecutive: number;\r\n  };\r\n  losers: {\r\n    total: number;\r\n    avgAmount: number;\r\n    maxConsecutive: number;\r\n    avgConsecutive: number;\r\n  };\r\n  breakevens: {\r\n    total: number;\r\n    avgAmount: number;\r\n  };\r\n}> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  const wins = filteredTrades.filter(trade => trade.trade_type === 'win');\r\n  const losses = filteredTrades.filter(trade => trade.trade_type === 'loss');\r\n  const breakevens = filteredTrades.filter(trade => trade.trade_type === 'breakeven');\r\n\r\n  const totalWins = wins.length;\r\n  const totalLosses = losses.length;\r\n  const totalBreakevens = breakevens.length;\r\n  const totalTrades = totalWins + totalLosses + totalBreakevens;\r\n\r\n  // Calculate win rate excluding breakevens from the denominator\r\n  const winRateDenominator = totalWins + totalLosses;\r\n  const winRate = winRateDenominator > 0 ? (totalWins / winRateDenominator) * 100 : 0;\r\n\r\n  const totalWinAmount = wins.reduce((sum, trade) => sum + trade.amount, 0);\r\n  const totalLossAmount = losses.reduce((sum, trade) => sum + trade.amount, 0);\r\n  const totalBreakevenAmount = breakevens.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n  const avgWin = totalWins > 0 ? totalWinAmount / totalWins : 0;\r\n  const avgLoss = totalLosses > 0 ? totalLossAmount / totalLosses : 0;\r\n  const avgBreakeven = totalBreakevens > 0 ? totalBreakevenAmount / totalBreakevens : 0;\r\n\r\n  // Yield control before calculating streaks\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Calculate consecutive wins and losses\r\n  let currentWinStreak = 0;\r\n  let maxWinStreak = 0;\r\n  let totalWinStreaks = 0;\r\n  let winStreakCount = 0;\r\n\r\n  let currentLossStreak = 0;\r\n  let maxLossStreak = 0;\r\n  let totalLossStreaks = 0;\r\n  let lossStreakCount = 0;\r\n\r\n  // Sort trades by date\r\n  const sortedTrades = [...filteredTrades].sort((a, b) =>\r\n    new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime()\r\n  );\r\n\r\n  sortedTrades.forEach(trade => {\r\n    if (trade.trade_type === 'win') {\r\n      currentWinStreak++;\r\n      currentLossStreak = 0;\r\n\r\n      if (currentWinStreak > maxWinStreak) {\r\n        maxWinStreak = currentWinStreak;\r\n      }\r\n    } else if (trade.trade_type === 'loss') {\r\n      if (currentWinStreak > 0) {\r\n        totalWinStreaks += currentWinStreak;\r\n        winStreakCount++;\r\n      }\r\n      currentWinStreak = 0;\r\n      currentLossStreak++;\r\n\r\n      if (currentLossStreak > maxLossStreak) {\r\n        maxLossStreak = currentLossStreak;\r\n      }\r\n    } else if (trade.trade_type === 'breakeven') {\r\n      // For breakeven trades, we don't reset the streaks\r\n      // This allows a breakeven trade to maintain an existing streak\r\n    }\r\n  });\r\n\r\n  // Handle the last streak\r\n  if (currentWinStreak > 0) {\r\n    totalWinStreaks += currentWinStreak;\r\n    winStreakCount++;\r\n  } else if (currentLossStreak > 0) {\r\n    totalLossStreaks += currentLossStreak;\r\n    lossStreakCount++;\r\n  }\r\n\r\n  const avgWinStreak = winStreakCount > 0 ? totalWinStreaks / winStreakCount : 0;\r\n  const avgLossStreak = lossStreakCount > 0 ? totalLossStreaks / lossStreakCount : 0;\r\n\r\n  return {\r\n    total_trades: totalTrades,\r\n    win_rate: winRate,\r\n    winners: {\r\n      total: totalWins,\r\n      avgAmount: avgWin,\r\n      maxConsecutive: maxWinStreak,\r\n      avgConsecutive: avgWinStreak\r\n    },\r\n    losers: {\r\n      total: totalLosses,\r\n      avgAmount: avgLoss,\r\n      maxConsecutive: maxLossStreak,\r\n      avgConsecutive: avgLossStreak\r\n    },\r\n    breakevens: {\r\n      total: totalBreakevens,\r\n      avgAmount: avgBreakeven\r\n    }\r\n  };\r\n};\r\n\r\n// Calculate tag statistics asynchronously\r\nexport const calculateTagStatsAsync = async (\r\n  filteredTrades: Trade[]\r\n): Promise<Array<{\r\n  tag: string;\r\n  wins: number;\r\n  losses: number;\r\n  breakevens: number;\r\n  total_trades: number;\r\n  win_rate: number;\r\n  total_pnl: number;\r\n}>> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Create a map to store stats for each tag\r\n  const tagMap = new Map<string, { wins: number; losses: number; breakevens: number; total_pnl: number }>();\r\n\r\n  filteredTrades.forEach(trade => {\r\n    if (trade.tags) {\r\n      trade.tags.forEach(tag => {\r\n        const stats = tagMap.get(tag) || { wins: 0, losses: 0, breakevens: 0, total_pnl: 0 };\r\n        if (trade.trade_type === 'win') {\r\n          stats.wins++;\r\n        } else if (trade.trade_type === 'loss') {\r\n          stats.losses++;\r\n        } else if (trade.trade_type === 'breakeven') {\r\n          stats.breakevens++;\r\n        }\r\n        stats.total_pnl += trade.amount;\r\n        tagMap.set(tag, stats);\r\n      });\r\n    }\r\n  });\r\n\r\n  // Yield control before processing results\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Convert map to array and calculate win rates\r\n  return Array.from(tagMap.entries()).map(([tag, stats]) => {\r\n    // Calculate win rate excluding breakevens from the denominator\r\n    const totalTradesForWinRate = stats.wins + stats.losses;\r\n    const winRate = totalTradesForWinRate > 0 ? Math.round((stats.wins / totalTradesForWinRate) * 100) : 0;\r\n    const totalTrades = stats.wins + stats.losses + stats.breakevens;\r\n\r\n    return {\r\n      tag,\r\n      wins: stats.wins,\r\n      losses: stats.losses,\r\n      breakevens: stats.breakevens,\r\n      total_trades: totalTrades,\r\n      win_rate: winRate,\r\n      total_pnl: stats.total_pnl\r\n    };\r\n  }).sort((a, b) => b.total_trades - a.total_trades); // Sort by total trades descending\r\n};\r\n\r\n// Calculate daily summary data asynchronously\r\nexport const calculateDailySummaryDataAsync = async (\r\n  filteredTrades: Trade[]\r\n): Promise<Array<{\r\n  trade_date: Date;\r\n  trades: number;\r\n  session: string;\r\n  pnl: number;\r\n}>> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Group trades by date\r\n  const tradesByDate = filteredTrades.reduce((acc, trade) => {\r\n    const dateKey = format(new Date(trade.trade_date), 'yyyy-MM-dd');\r\n    if (!acc[dateKey]) {\r\n      acc[dateKey] = [];\r\n    }\r\n    acc[dateKey].push(trade);\r\n    return acc;\r\n  }, {} as { [key: string]: Trade[] });\r\n\r\n  // Yield control before processing daily stats\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Calculate daily statistics\r\n  return Object.entries(tradesByDate)\r\n    .map(([date, dayTrades]) => {\r\n      const totalPnL = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n      // Get the most common session for the day\r\n      const sessionCounts = dayTrades.reduce((acc, trade) => {\r\n        if (trade.session) {\r\n          acc[trade.session] = (acc[trade.session] || 0) + 1;\r\n        }\r\n        return acc;\r\n      }, {} as { [key: string]: number });\r\n\r\n      // Find the session with the highest count\r\n      let mostCommonSession = '';\r\n      let highestCount = 0;\r\n\r\n      Object.entries(sessionCounts).forEach(([session, count]) => {\r\n        if (count > highestCount) {\r\n          mostCommonSession = session;\r\n          highestCount = count;\r\n        }\r\n      });\r\n\r\n      return {\r\n        trade_date: parseISO(date),\r\n        trades: dayTrades.length,\r\n        session: mostCommonSession,\r\n        pnl: totalPnL\r\n      };\r\n    })\r\n    .sort((a, b) => b.trade_date.getTime() - a.trade_date.getTime()); // Sort by date descending\r\n};\r\n\r\n// Calculate risk to reward statistics asynchronously\r\nexport const calculateRiskRewardStatsAsync = async (\r\n  filteredTrades: Trade[],\r\n  timePeriod: TimePeriod\r\n): Promise<{ average: number; max: number; data: Array<{ date: string; rr: number }> }> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  const filteredTrades_ = filteredTrades.filter(trade => trade.risk_to_reward !== undefined)\r\n    .sort((a, b) => new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime());\r\n\r\n  if (filteredTrades_.length === 0) return { average: 0, max: 0, data: [] };\r\n\r\n  const riskRewardValues = filteredTrades_.map(trade => trade.risk_to_reward!);\r\n  const average = riskRewardValues.reduce((sum, value) => sum + value, 0) / riskRewardValues.length;\r\n  const max = Math.max(...riskRewardValues);\r\n\r\n  // Yield control before creating data points\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  // Create data points for the line graph\r\n  const data = filteredTrades_.map(trade => ({\r\n    date: format(new Date(trade.trade_date), timePeriod === 'month' ? 'MM/dd' : 'MM/dd/yyyy'),\r\n    rr: trade.risk_to_reward || 0\r\n  }));\r\n\r\n  return { average, max, data };\r\n};\r\n\r\n// Calculate session statistics asynchronously\r\nexport const calculateSessionStatsAsync = async (\r\n  filteredTrades: Trade[],\r\n  accountBalance: number\r\n): Promise<SessionStats[]> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  const filteredTrades_ = filteredTrades.filter(trade => trade.session !== undefined);\r\n  const sessions = ['Asia', 'London', 'NY AM', 'NY PM'];\r\n\r\n  return sessions.map(sessionName => {\r\n    const sessionTrades = filteredTrades_.filter(trade => trade.session === sessionName);\r\n    const totalTrades = sessionTrades.length;\r\n    const winners = sessionTrades.filter(trade => trade.trade_type === 'win').length;\r\n    const losers = sessionTrades.filter(trade => trade.trade_type === 'loss').length;\r\n    const breakevens = sessionTrades.filter(trade => trade.trade_type === 'breakeven').length;\r\n\r\n    // Calculate win rate excluding breakevens from the denominator\r\n    const totalTradesForWinRate = winners + losers;\r\n    const winRate = totalTradesForWinRate > 0 ? (winners / totalTradesForWinRate) * 100 : 0;\r\n\r\n    const totalPnL = sessionTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n    const averagePnL = totalTrades > 0 ? totalPnL / totalTrades : 0;\r\n    const pnlPercentage = accountBalance > 0 ? (totalPnL / accountBalance) * 100 : 0;\r\n\r\n    return {\r\n      session: sessionName,\r\n      total_trades: totalTrades,\r\n      winners,\r\n      losers,\r\n      breakevens,\r\n      win_rate: winRate,\r\n      total_pnl: totalPnL,\r\n      averagePnL,\r\n      pnlPercentage\r\n    };\r\n  });\r\n};\r\n\r\n// Calculate comparison win/loss data asynchronously\r\nexport const calculateComparisonWinLossDataAsync = async (\r\n  filteredTrades: Trade[],\r\n  comparisonTags: string[]\r\n): Promise<Array<{ name: string; value: number }> | null> => {\r\n  if (comparisonTags.length === 0) return null;\r\n\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  const filteredTrades_ = filteredTrades\r\n    .filter(trade => {\r\n      if (!trade.tags) return false;\r\n      return comparisonTags.some(tag => trade.tags!.includes(tag));\r\n    });\r\n\r\n  const wins = filteredTrades_.filter(trade => trade.trade_type === 'win');\r\n  const losses = filteredTrades_.filter(trade => trade.trade_type === 'loss');\r\n  const breakevens = filteredTrades_.filter(trade => trade.trade_type === 'breakeven');\r\n\r\n  return [\r\n    { name: 'Wins', value: wins.length },\r\n    { name: 'Losses', value: losses.length },\r\n    { name: 'Breakeven', value: breakevens.length }\r\n  ].filter(item => item.value > 0); // Only include categories with values > 0\r\n};\r\n\r\n// Calculate all unique tags asynchronously\r\nexport const calculateAllTagsAsync = async (trades: Trade[]): Promise<string[]> => {\r\n  // Yield control to prevent UI blocking\r\n  await new Promise(resolve => setTimeout(resolve, 0));\r\n\r\n  const tags = new Set<string>();\r\n  trades.forEach(trade => {\r\n    if (trade.tags) {\r\n      trade.tags.forEach(tag => tags.add(tag));\r\n    }\r\n  });\r\n  return Array.from(tags).sort();\r\n};\r\n","import React, { useMemo } from 'react';\r\nimport { Box, Skeleton, useTheme } from '@mui/material';\r\n\r\ninterface ShimmerChartLoaderProps {\r\n  height?: number | string;\r\n  width?: number | string;\r\n}\r\n\r\nconst ShimmerChartLoader: React.FC<ShimmerChartLoaderProps> = ({\r\n  height = 300,\r\n  width = '100%'\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Generate stable heights for chart bars that don't change on re-renders\r\n  const chartBarHeights = useMemo(() =>\r\n    Array.from({ length: 7 }, () => Math.random() * 60 + 40),\r\n    []\r\n  );\r\n\r\n  return (\r\n    <Box sx={{\r\n      bgcolor: theme.palette.mode === 'dark' ? 'rgba(255, 255, 255, 0.02)' : 'rgba(0, 0, 0, 0.02)',\r\n      borderRadius: 2,\r\n      m: 2,\r\n      overflow: 'hidden',\r\n      width,\r\n      height,\r\n      p: 2\r\n    }}>\r\n      {/* Chart title */}\r\n      <Skeleton variant=\"text\" width=\"40%\" height={32} sx={{ mb: 2 }} />\r\n\r\n      {/* Chart area */}\r\n      <Box sx={{ display: 'flex', alignItems: 'end', gap: 1, height: '80%', mb: 2 }}>\r\n        {chartBarHeights.map((barHeight, index) => (\r\n          <Skeleton\r\n            key={index}\r\n            variant=\"rectangular\"\r\n            width=\"12%\"\r\n            height={`${barHeight}%`}\r\n            sx={{\r\n              borderRadius: 1,\r\n              transition: 'height 0.3s ease-in-out'\r\n            }}\r\n          />\r\n        ))}\r\n      </Box>\r\n\r\n      {/* Legend */}\r\n      <Box sx={{ display: 'flex', gap: 2 }}>\r\n        <Skeleton variant=\"text\" width={80} height={20} />\r\n        <Skeleton variant=\"text\" width={80} height={20} />\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default ShimmerChartLoader;\r\n","import React from 'react';\r\nimport {\r\n  AreaChart,\r\n  Area,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  ReferenceLine\r\n} from 'recharts';\r\nimport { Box, Paper, Typography, useTheme } from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport { format } from 'date-fns';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { formatValue } from '../../utils/formatters';\r\nimport { log } from '../../utils/logger';\r\n\r\ninterface CumulativePnLChartProps {\r\n  chartData: any[];\r\n  targetValue: number | null;\r\n  monthly_target?: number;\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n}\r\n\r\n// Custom Y-axis tick component\r\nconst CustomYAxisTick = (props: any) => {\r\n  const { x, y, payload } = props;\r\n  const value = payload.value;\r\n  const formattedValue = formatValue(value);\r\n  \r\n  return (\r\n    <g transform={`translate(${x},${y})`}>\r\n      <text x={0} y={0} dy={5} textAnchor=\"end\" fill=\"#666\" fontSize={12}>\r\n        {formattedValue}\r\n      </text>\r\n    </g>\r\n  );\r\n};\r\n\r\n// Custom tooltip component\r\nconst CustomTooltip = ({ active, payload, label, type }: any) => {\r\n  const theme = useTheme();\r\n  \r\n  if (active && payload && payload.length) {\r\n    const data = payload[0].payload;\r\n    \r\n    return (\r\n      <Paper sx={{ p: 1.5, boxShadow: theme.shadows[3] }}>\r\n        <Typography variant=\"body2\" sx={{ fontWeight: 'bold', mb: 0.5 }}>\r\n          {label}\r\n        </Typography>\r\n        <Typography\r\n          variant=\"body2\"\r\n          sx={{\r\n            color: data.dailyChange > 0 ? '#4caf50' : data.dailyChange < 0 ? '#f44336' : 'text.secondary',\r\n            fontWeight: 'bold'\r\n          }}\r\n        >\r\n          {formatValue(data.dailyChange)}\r\n        </Typography>\r\n        <Typography variant=\"body2\" color=\"text.secondary\">\r\n          Cumulative P&L: {formatValue(data.cumulativePnL)}\r\n        </Typography>\r\n        {data.trades && data.trades.length > 0 && (\r\n          <Typography variant=\"body2\" sx={{ color: theme.palette.primary.main, fontSize: '0.75rem', mt: 0.5 }}>\r\n            Click to view {data.trades.length} trade{data.trades.length > 1 ? 's' : ''}\r\n          </Typography>\r\n        )}\r\n      </Paper>\r\n    );\r\n  }\r\n  return null;\r\n};\r\n\r\nconst CumulativePnLChart: React.FC<CumulativePnLChartProps> = ({\r\n  chartData,\r\n  targetValue,\r\n  monthly_target,\r\n  setMultipleTradesDialog,\r\n  timePeriod\r\n}) => {\r\n  const theme = useTheme();\r\n  \r\n  // Define colors\r\n  const COLORS = {\r\n    win: '#4caf50',\r\n    loss: '#f44336',\r\n    zero: '#9e9e9e',\r\n    breakEven: '#ff9800'\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>\r\n        <Typography variant=\"h6\">Cumulative P&L</Typography>\r\n        {monthly_target && targetValue !== null && (\r\n          <Box\r\n            sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n              px: 1.5,\r\n              py: 0.5,\r\n              borderRadius: 1,\r\n              fontSize: '0.875rem'\r\n            }}\r\n          >\r\n            Target: {monthly_target}% (${targetValue?.toFixed(2)})\r\n          </Box>\r\n        )}\r\n      </Box>\r\n      <ResponsiveContainer width=\"100%\" height={300}>\r\n        <AreaChart data={chartData}>\r\n          <defs>\r\n            <linearGradient id=\"colorPnLWin\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n              <stop offset=\"5%\" stopColor={COLORS.win} stopOpacity={0.2} />\r\n              <stop offset=\"95%\" stopColor={COLORS.win} stopOpacity={0} />\r\n            </linearGradient>\r\n            <linearGradient id=\"colorPnLLoss\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n              <stop offset=\"5%\" stopColor={COLORS.loss} stopOpacity={0.2} />\r\n              <stop offset=\"95%\" stopColor={COLORS.loss} stopOpacity={0} />\r\n            </linearGradient>\r\n          </defs>\r\n          <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n          <XAxis\r\n            dataKey=\"date\"\r\n            axisLine={false}\r\n            tickLine={false}\r\n            tick={{\r\n              fill: theme.palette.text.secondary,\r\n              fontSize: timePeriod === 'year' ? 8 : 12\r\n            }}\r\n          />\r\n          <YAxis\r\n            axisLine={false}\r\n            tickLine={false}\r\n            tick={<CustomYAxisTick />}\r\n          />\r\n          <Tooltip content={(props) => <CustomTooltip {...props} type=\"cumulative\" />} />\r\n          {targetValue !== null && (\r\n            <>\r\n              <ReferenceLine\r\n                y={targetValue}\r\n                stroke={theme.palette.primary.main}\r\n                strokeDasharray=\"4 4\"\r\n                strokeWidth={2}\r\n              />\r\n              {/* Add a semi-transparent area above the target line */}\r\n              <Area\r\n                type=\"monotone\"\r\n                dataKey=\"cumulativePnL\"\r\n                stroke=\"none\"\r\n                fill={theme.palette.primary.main}\r\n                fillOpacity={0.05}\r\n                baseValue={targetValue}\r\n              />\r\n            </>\r\n          )}\r\n          <ReferenceLine y={0} stroke={COLORS.zero} strokeDasharray=\"3 3\" />\r\n          <Area\r\n            type=\"monotone\"\r\n            dataKey=\"cumulativePnL\"\r\n            stroke={COLORS.win}\r\n            fill=\"url(#colorPnLWin)\"\r\n            strokeWidth={2}\r\n            name=\"Cumulative P&L\"\r\n            style={{ cursor: 'pointer' }}\r\n            activeDot={(props) => {\r\n              const { cx, cy, index } = props;\r\n              return (\r\n                <circle\r\n                  cx={cx}\r\n                  cy={cy}\r\n                  r={6}\r\n                  stroke={theme.palette.background.paper}\r\n                  strokeWidth={2}\r\n                  fill={theme.palette.primary.main}\r\n                  style={{ cursor: 'pointer' }}\r\n                  onClick={() => {\r\n                    log('Dot clicked, Index:', index);\r\n                    const dataPoint = chartData[index];\r\n                    if (dataPoint && dataPoint.trades && dataPoint.trades.length > 0) {\r\n                      const formattedDate = format(dataPoint.fullDate, 'MMMM d, yyyy');\r\n                      setMultipleTradesDialog({\r\n                        open: true,\r\n                        trades: dataPoint.trades,\r\n                        title: formattedDate,\r\n                        expandedTradeId: dataPoint.trades.length === 1 ? dataPoint.trades[0].id : null\r\n                      });\r\n                    }\r\n                  }}\r\n                />\r\n              );\r\n            }}\r\n            dot={{\r\n              r: 3,\r\n              fill: COLORS.win,\r\n              stroke: theme.palette.background.paper,\r\n              strokeWidth: 1\r\n            }}\r\n          />\r\n        </AreaChart>\r\n      </ResponsiveContainer>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default CumulativePnLChart;\r\n","import React from 'react';\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  ReferenceLine,\r\n  Cell\r\n} from 'recharts';\r\nimport { Box, Paper, Typography, useTheme } from '@mui/material';\r\nimport { format } from 'date-fns'; \r\n import { formatValue } from '../../utils/formatters';\r\nimport { log } from '../../utils/logger';\r\n\r\ninterface DailyPnLChartProps {\r\n  chartData: any[];\r\n  drawdownViolationValue: number;\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n}\r\n\r\n// Custom Y-axis tick component for daily P&L\r\nconst CustomDailyPnLYAxisTick = (props: any) => {\r\n  const { x, y, payload } = props;\r\n  const value = payload.value;\r\n  const formattedValue = formatValue(value);\r\n  \r\n  return (\r\n    <g transform={`translate(${x},${y})`}>\r\n      <text x={0} y={0} dy={5} textAnchor=\"end\" fill=\"#666\" fontSize={12}>\r\n        {formattedValue}\r\n      </text>\r\n    </g>\r\n  );\r\n};\r\n\r\n// Custom tooltip component\r\nconst CustomTooltip = ({ active, payload, label, type }: any) => {\r\n  const theme = useTheme();\r\n  \r\n  if (active && payload && payload.length) {\r\n    const data = payload[0].payload;\r\n    \r\n    return (\r\n      <Paper sx={{ p: 1.5, boxShadow: theme.shadows[3] }}>\r\n        <Typography variant=\"body2\" sx={{ fontWeight: 'bold', mb: 0.5 }}>\r\n          {label}\r\n        </Typography>\r\n        <Typography\r\n          variant=\"body2\"\r\n          sx={{\r\n            color: data.isWin ? '#4caf50' : data.isLoss ? '#f44336' : 'text.secondary',\r\n            fontWeight: 'bold'\r\n          }}\r\n        >\r\n          {formatValue(data.pnl)}\r\n        </Typography>\r\n        <Typography variant=\"body2\" color=\"text.secondary\">\r\n          {data.isWin ? 'Win' : data.isLoss ? 'Loss' : 'Break Even'}\r\n        </Typography>\r\n        {data.trades && data.trades.length > 0 && (\r\n          <Typography variant=\"body2\" sx={{ color: theme.palette.primary.main, fontSize: '0.75rem', mt: 0.5 }}>\r\n            Click to view {data.trades.length} trade{data.trades.length > 1 ? 's' : ''}\r\n          </Typography>\r\n        )}\r\n      </Paper>\r\n    );\r\n  }\r\n  return null;\r\n};\r\n\r\nconst DailyPnLChart: React.FC<DailyPnLChartProps> = ({\r\n  chartData,\r\n  drawdownViolationValue,\r\n  setMultipleTradesDialog,\r\n  timePeriod\r\n}) => {\r\n  const theme = useTheme();\r\n  \r\n  // Define colors\r\n  const COLORS = {\r\n    win: '#4caf50',\r\n    loss: '#f44336',\r\n    zero: '#9e9e9e',\r\n    breakEven: '#ff9800'\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Typography variant=\"h6\" sx={{ mb: 2 }}>\r\n        Daily P&L\r\n      </Typography>\r\n      <ResponsiveContainer width=\"100%\" height={300}>\r\n        <BarChart data={chartData}>\r\n          <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n          <XAxis\r\n            dataKey=\"date\"\r\n            axisLine={false}\r\n            tickLine={false}\r\n            tick={{\r\n              fill: theme.palette.text.secondary,\r\n              fontSize: timePeriod === 'year' ? 8 : 12\r\n            }}\r\n          />\r\n          <YAxis\r\n            axisLine={false}\r\n            tickLine={false}\r\n            tick={<CustomDailyPnLYAxisTick />}\r\n          />\r\n          <Tooltip content={(props) => <CustomTooltip {...props} type=\"daily\" />} />\r\n          <ReferenceLine y={0} stroke={COLORS.zero} strokeDasharray=\"3 3\" />\r\n          <ReferenceLine\r\n            y={drawdownViolationValue}\r\n            stroke={theme.palette.error.main}\r\n            strokeDasharray=\"3 3\"\r\n            strokeWidth={2}\r\n            label={{\r\n              position: 'right',\r\n              value: `Max Drawdown: ${formatValue(drawdownViolationValue)}`,\r\n              fill: theme.palette.error.main,\r\n              fontSize: 12,\r\n              fontWeight: 'bold'\r\n            }}\r\n          />\r\n          <Bar\r\n            dataKey=\"pnl\"\r\n            name=\"Daily P&L\"\r\n            radius={[4, 4, 0, 0]}\r\n            onClick={(data: any) => {\r\n              log('Bar clicked:', data);\r\n              if (data && data.payload) {\r\n                const payload = data.payload;\r\n                if (payload.trades && payload.trades.length > 0) {\r\n                  const formattedDate = format(payload.fullDate, 'MMMM d, yyyy');\r\n                  setMultipleTradesDialog({\r\n                    open: true,\r\n                    trades: payload.trades,\r\n                    title: formattedDate,\r\n                    expandedTradeId: payload.trades.length === 1 ? payload.trades[0].id : null\r\n                  });\r\n                }\r\n              }\r\n            }}\r\n            style={{ cursor: 'pointer' }}\r\n          >\r\n            {chartData.map((entry, index) => (\r\n              <Cell\r\n                key={`cell-${index}`}\r\n                fill={entry.isWin ? COLORS.win : entry.isLoss ? COLORS.loss : COLORS.breakEven}\r\n                fillOpacity={0.8}\r\n              />\r\n            ))}\r\n          </Bar>\r\n        </BarChart>\r\n      </ResponsiveContainer>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default DailyPnLChart;\r\n","import React, { useState } from 'react';\r\nimport { Box, Paper } from '@mui/material';\r\nimport CumulativePnLChart from './CumulativePnLChart';\r\nimport DailyPnLChart from './DailyPnLChart';\r\nimport RoundedTabs, { TabPanel } from '../common/RoundedTabs';\r\n\r\ninterface PnLChartsWrapperProps {\r\n  chartData: any[];\r\n  targetValue: number | null;\r\n  monthly_target?: number;\r\n  drawdownViolationValue: number;\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n}\r\n\r\n\r\n\r\nconst PnLChartsWrapper: React.FC<PnLChartsWrapperProps> = ({\r\n  chartData,\r\n  targetValue,\r\n  monthly_target,\r\n  drawdownViolationValue,\r\n  setMultipleTradesDialog,\r\n  timePeriod\r\n}) => {\r\n  const [activeTab, setActiveTab] = useState(0);\r\n\r\n  const handleTabChange = (_: React.SyntheticEvent, newValue: number) => {\r\n    setActiveTab(newValue);\r\n  };\r\n\r\n  // Define tabs for P&L charts\r\n  const pnlTabs = [\r\n    { label: 'Cumulative P&L' },\r\n    { label: 'Daily P&L' }\r\n  ];\r\n\r\n  return (\r\n    <Paper sx={{ p: 0, mb: 3, borderRadius: 2 }}>\r\n      <Box sx={{ px: 3, pt: 3 }}>\r\n        <Box sx={{ display: 'flex', justifyContent: 'start', mb: 2 }}>\r\n          <RoundedTabs\r\n            tabs={pnlTabs}\r\n            activeTab={activeTab}\r\n            onTabChange={handleTabChange}\r\n          />\r\n        </Box>\r\n      </Box>\r\n\r\n      <Box sx={{ px: 3, pb: 3 }}>\r\n        {/* Cumulative P&L Tab */}\r\n        <TabPanel value={activeTab} index={0}>\r\n          <CumulativePnLChart\r\n            chartData={chartData}\r\n            targetValue={targetValue}\r\n            monthly_target={monthly_target}\r\n            setMultipleTradesDialog={setMultipleTradesDialog}\r\n            timePeriod={timePeriod}\r\n          />\r\n        </TabPanel>\r\n\r\n        {/* Daily P&L Tab */}\r\n        <TabPanel value={activeTab} index={1}>\r\n          <DailyPnLChart\r\n            chartData={chartData}\r\n            drawdownViolationValue={drawdownViolationValue}\r\n            setMultipleTradesDialog={setMultipleTradesDialog}\r\n            timePeriod={timePeriod}\r\n          />\r\n        </TabPanel>\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default React.memo(PnLChartsWrapper);\r\n","import React from 'react';\r\nimport {\r\n  PieChart,\r\n  Pie,\r\n  Cell,\r\n  ResponsiveContainer,\r\n  Legend,\r\n  Tooltip\r\n} from 'recharts';\r\nimport { Box, Paper, Typography, useTheme } from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\n\r\ninterface WinLossDistributionProps {\r\n  winLossData: any[];\r\n  onPieClick?: (category: string) => void;\r\n}\r\n\r\nconst WinLossDistribution: React.FC<WinLossDistributionProps> = ({\r\n  winLossData,\r\n  onPieClick\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Add a style element to remove focus outlines from SVG elements\r\n  React.useEffect(() => {\r\n    // Create a style element\r\n    const style = document.createElement('style');\r\n    // Add CSS to remove focus outlines from SVG elements\r\n    style.innerHTML = `\r\n      .recharts-sector:focus,\r\n      .recharts-sector:focus-visible,\r\n      .recharts-pie:focus,\r\n      .recharts-pie:focus-visible,\r\n      .recharts-pie-sector:focus,\r\n      .recharts-pie-sector:focus-visible,\r\n      .recharts-layer:focus,\r\n      .recharts-layer:focus-visible,\r\n      .recharts-surface:focus,\r\n      .recharts-surface:focus-visible {\r\n        outline: none !important;\r\n        stroke: none !important;\r\n        stroke-width: 0 !important;\r\n        box-shadow: none !important;\r\n      }\r\n\r\n      /* Target all SVG elements in the chart */\r\n      .recharts-wrapper svg *:focus,\r\n      .recharts-wrapper svg *:focus-visible,\r\n      .win-loss-chart-container svg *:focus,\r\n      .win-loss-chart-container svg *:focus-visible {\r\n        outline: none !important;\r\n        stroke-width: 0 !important;\r\n      }\r\n    `;\r\n    // Append the style element to the document head\r\n    document.head.appendChild(style);\r\n\r\n    // Clean up the style element when the component unmounts\r\n    return () => {\r\n      document.head.removeChild(style);\r\n    };\r\n  }, []);\r\n\r\n  // Define colors with enhanced visual appeal\r\n  const COLORS = {\r\n    win: theme.palette.mode === 'dark' ? '#66bb6a' : '#4caf50', // Slightly lighter green in dark mode\r\n    loss: theme.palette.mode === 'dark' ? '#ef5350' : '#f44336', // Slightly lighter red in dark mode\r\n    zero: theme.palette.mode === 'dark' ? '#bdbdbd' : '#9e9e9e', // Lighter gray in dark mode\r\n    breakEven: theme.palette.mode === 'dark' ? '#ffb74d' : '#ff9800' // Lighter orange in dark mode\r\n  };\r\n\r\n  // Define chart styling\r\n  const chartStyle = {\r\n    outerRadius: 100,\r\n    innerRadius: 60,\r\n    paddingAngle: 3,\r\n    cornerRadius: 4,\r\n    activeFillOpacity: 0.9,\r\n    hoverShadowColor: theme.palette.mode === 'dark' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)',\r\n    labelFontSize: '0.85rem',\r\n    labelFontWeight: 500\r\n  };\r\n\r\n\r\n\r\n  return (\r\n    <Paper\r\n      elevation={theme.palette.mode === 'dark' ? 2 : 1}\r\n      sx={{\r\n        p: 3,\r\n        borderRadius: 2,\r\n        height: '100%',\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        bgcolor: theme.palette.background.paper,\r\n      }}>\r\n      <Box sx={{\r\n        display: 'flex',\r\n        justifyContent: 'space-between',\r\n        alignItems: 'center',\r\n        mb: 3,\r\n        pb: 1.5,\r\n      }}>\r\n        <Typography variant=\"h6\" sx={{\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          gap: 1\r\n        }}>\r\n          Win/Loss Distribution\r\n        </Typography>\r\n      </Box>\r\n      <Box sx={{ flex: 1, minHeight: 300 }} className=\"win-loss-chart-container\">\r\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n            <PieChart\r\n              style={{ outline: 'none' }}\r\n              tabIndex={-1}\r\n              margin={{ top: 5, right: 5, bottom: 5, left: 5 }}\r\n            >\r\n              <Tooltip\r\n                content={({ active, payload }) => {\r\n                  if (active && payload && payload.length) {\r\n                    const data = payload[0].payload;\r\n                    return (\r\n                      <Paper sx={{ p: 1.5, boxShadow: theme.shadows[3] }}>\r\n                        <Typography variant=\"body2\" sx={{ fontWeight: 'bold', mb: 0.5 }}>\r\n                          {data.name}\r\n                        </Typography>\r\n                        <Typography\r\n                          variant=\"body2\"\r\n                          sx={{\r\n                            color: data.name === 'Wins'\r\n                              ? COLORS.win\r\n                              : data.name === 'Losses'\r\n                                ? COLORS.loss\r\n                                : data.name === 'Breakeven'\r\n                                  ? COLORS.breakEven\r\n                                  : COLORS.zero,\r\n                            fontWeight: 'bold'\r\n                          }}\r\n                        >\r\n                          {data.value} trade{data.value !== 1 ? 's' : ''}\r\n                        </Typography>\r\n                        <Typography variant=\"body2\" color=\"text.secondary\">\r\n                          {(data.value / winLossData.reduce((sum, item) => sum + item.value, 0) * 100).toFixed(1)}% of total\r\n                        </Typography>\r\n                        {onPieClick && (\r\n                          <Typography variant=\"body2\" sx={{ color: theme.palette.primary.main, fontSize: '0.75rem', mt: 0.5 }}>\r\n                            Click to view trades\r\n                          </Typography>\r\n                        )}\r\n                      </Paper>\r\n                    );\r\n                  }\r\n                  return null;\r\n                }}\r\n              />\r\n              <Pie\r\n                data={winLossData}\r\n                cx=\"50%\"\r\n                cy=\"50%\"\r\n                labelLine={false}\r\n                outerRadius={chartStyle.outerRadius}\r\n                strokeWidth={0}\r\n                innerRadius={chartStyle.innerRadius}\r\n                fill=\"#8884d8\"\r\n                dataKey=\"value\"\r\n                label={({ name, percent }) => {\r\n                  // Only show labels for segments with significant percentage\r\n                  if (percent < 0.05) return null;\r\n                  return `${name} ${(percent * 100).toFixed(0)}%`;\r\n                }}\r\n                paddingAngle={chartStyle.paddingAngle}\r\n                cornerRadius={chartStyle.cornerRadius}\r\n                onClick={(data) => {\r\n                  if (onPieClick) {\r\n                    onPieClick(data.name);\r\n                  }\r\n                }}\r\n                cursor={'pointer'}\r\n                style={{\r\n                  outline: 'none',\r\n                  filter: 'drop-shadow(0px 2px 5px rgba(0,0,0,0.1))'\r\n                }}\r\n                tabIndex={-1}\r\n              >\r\n                {winLossData.map((entry, index) => {\r\n                  // For win/loss distribution, use the predefined colors\r\n                  const fillColor = entry.name === 'Wins' ? COLORS.win :\r\n                                    entry.name === 'Losses' ? COLORS.loss :\r\n                                    entry.name === 'Breakeven' ? COLORS.breakEven :\r\n                                    COLORS.zero;\r\n\r\n                  return (\r\n                    <Cell\r\n                      key={`cell-${index}`}\r\n                      fill={fillColor}\r\n                      strokeWidth={1}\r\n                      stroke={theme.palette.background.paper}\r\n                      style={{\r\n                        outline: 'none',\r\n                        transition: 'opacity 0.3s'\r\n                      }}\r\n                    />\r\n                  );\r\n                })}\r\n              </Pie>\r\n              <Legend\r\n                verticalAlign=\"bottom\"\r\n                align=\"center\"\r\n                layout=\"horizontal\"\r\n                iconSize={12}\r\n                iconType=\"circle\"\r\n                wrapperStyle={{\r\n                  paddingTop: 15,\r\n                  fontSize: '0.85rem',\r\n                  fontWeight: 500\r\n                }}\r\n              />\r\n            </PieChart>\r\n          </ResponsiveContainer>\r\n      </Box>\r\n      <Box sx={{\r\n        display: 'flex',\r\n        justifyContent: 'center',\r\n        mt: 2,\r\n        pt: 1.5,\r\n        flexDirection: 'column',\r\n        alignItems: 'center',\r\n        marginTop: 'auto'\r\n      }}>\r\n        <Typography variant=\"body2\" color=\"text.secondary\" sx={{ fontWeight: 500 }}>\r\n          Showing win/loss distribution for all trades\r\n        </Typography>\r\n        {onPieClick && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 0.5,\r\n            mt: 0.5,\r\n            bgcolor: alpha(theme.palette.primary.main, 0.08),\r\n            px: 1.5,\r\n            py: 0.5,\r\n            borderRadius: 1\r\n          }}>\r\n            <Typography variant=\"caption\" color=\"primary\" sx={{ fontWeight: 500 }}>\r\n              Click on a segment to view trades\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default WinLossDistribution;\r\n","import React from 'react';\r\nimport { Box, Paper, Typography, Tooltip, useTheme, Stack, alpha } from '@mui/material';\r\nimport { InfoOutlined } from '@mui/icons-material';\r\nimport { formatCurrency } from '../../utils/formatters';\r\nimport { Trade } from '../../types/dualWrite';\r\n\r\ninterface WinLossStatsProps {\r\n  winLossStats: {\r\n    total_trades: number;\r\n    win_rate: number;\r\n    winners: {\r\n      total: number;\r\n      avgAmount: number;\r\n      maxConsecutive: number;\r\n      avgConsecutive: number;\r\n      bestWin?: number;\r\n      averageWin?: number;\r\n    };\r\n    losers: {\r\n      total: number;\r\n      avgAmount: number;\r\n      maxConsecutive: number;\r\n      avgConsecutive: number;\r\n      worstLoss?: number;\r\n      averageLoss?: number;\r\n    };\r\n    breakevens?: {\r\n      total: number;\r\n      avgAmount: number;\r\n    };\r\n  };\r\n  trades: Trade[];\r\n  onTradeClick?: (tradeId: string) => void;\r\n}\r\n\r\nconst WinLossStats: React.FC<WinLossStatsProps> = ({ winLossStats, trades, onTradeClick }) => {\r\n  const theme = useTheme();\r\n\r\n  // Find the best win (trade with highest amount)\r\n  const bestWin = React.useMemo(() => {\r\n    const winTrades = trades.filter(trade => trade.trade_type === 'win');\r\n    if (winTrades.length === 0) return null;\r\n    return winTrades.reduce((best, current) =>\r\n      current.amount > best.amount ? current : best, winTrades[0]);\r\n  }, [trades]);\r\n\r\n  // Find the worst loss (trade with lowest/most negative amount)\r\n  const worstLoss = React.useMemo(() => {\r\n    const lossTrades = trades.filter(trade => trade.trade_type === 'loss');\r\n    if (lossTrades.length === 0) return null;\r\n    return lossTrades.reduce((worst, current) =>\r\n      current.amount < worst.amount ? current : worst, lossTrades[0]);\r\n  }, [trades]);\r\n\r\n  return (\r\n    <Box>\r\n      {/* Winners and Losers Section */}\r\n      {(winLossStats.winners.total > 0 || winLossStats.losers.total > 0) && (\r\n        <Box sx={{ display: 'flex', gap: 2, mb: 3 }}>\r\n          {/* Winners Card */}\r\n          <Paper sx={{ \r\n            flex: 1, \r\n            p: 2, \r\n            border: `4px solid ${alpha(theme.palette.success.main, 0.1)}`,\r\n            borderRadius: 2\r\n          }}>\r\n            <Typography variant=\"subtitle1\" sx={{ color: theme.palette.success.main, mb: 2 }}>\r\n              Winners\r\n            </Typography>\r\n            <Stack spacing={1.5}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Total winners\r\n                  </Typography>\r\n                  <Tooltip title=\"Total number of winning trades in the selected period\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.winners.total}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Best win\r\n                  </Typography>\r\n                  <Tooltip title=\"Your largest winning trade as a percentage of your account\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">\r\n                  {bestWin ? formatCurrency(bestWin.amount) : '0'}\r\n                </Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Average win\r\n                  </Typography>\r\n                  <Tooltip title=\"The average size of your winning trades as a percentage of your account\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{formatCurrency(winLossStats.winners.avgAmount)}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Max consecutive wins\r\n                  </Typography>\r\n                  <Tooltip title=\"Your longest streak of consecutive winning trades\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.winners.maxConsecutive}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Avg consecutive wins\r\n                  </Typography>\r\n                  <Tooltip title=\"The average number of wins you achieve in a row before a loss\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.winners.avgConsecutive.toFixed(1)}</Typography>\r\n              </Box>\r\n            </Stack>\r\n          </Paper>\r\n\r\n          {/* Losers Card */}\r\n          <Paper sx={{ \r\n            flex: 1, \r\n            p: 2, \r\n            border: `4px solid ${alpha(theme.palette.error.main, 0.1)}`,\r\n            borderRadius: 2\r\n          }}>\r\n            <Typography variant=\"subtitle1\" sx={{ color: theme.palette.error.main, mb: 2 }}>\r\n              Losers\r\n            </Typography>\r\n            <Stack spacing={1.5}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Total losers\r\n                  </Typography>\r\n                  <Tooltip title=\"Total number of losing trades in the selected period\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.losers.total}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Worst loss\r\n                  </Typography>\r\n                  <Tooltip title=\"Your largest losing trade as a percentage of your account\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">\r\n                  {worstLoss ? formatCurrency(Math.abs(worstLoss.amount)) : '0'}\r\n                </Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Average loss\r\n                  </Typography>\r\n                  <Tooltip title=\"The average size of your losing trades as a percentage of your account\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{formatCurrency(Math.abs(winLossStats.losers.avgAmount))}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Max consecutive losses\r\n                  </Typography>\r\n                  <Tooltip title=\"Your longest streak of consecutive losing trades\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.losers.maxConsecutive}</Typography>\r\n              </Box>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Avg consecutive losses\r\n                  </Typography>\r\n                  <Tooltip title=\"The average number of losses you have in a row before a win\" arrow>\r\n                    <InfoOutlined sx={{ fontSize: 14, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n                  </Tooltip>\r\n                </Box>\r\n                <Typography variant=\"body2\">{winLossStats.losers.avgConsecutive.toFixed(1)}</Typography>\r\n              </Box>\r\n            </Stack>\r\n          </Paper>\r\n        </Box>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default WinLossStats;\r\n","import React, { useMemo, useState } from 'react';\r\nimport {\r\n  Box,\r\n  Button,\r\n  Typography,\r\n  useTheme,\r\n  TextField,\r\n  Autocomplete,\r\n  Chip\r\n} from '@mui/material';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup,\r\n  getUniqueTagGroups,\r\n  filterTagsByGroup\r\n} from '../utils/tagColors';\r\nimport { BaseDialog, SelectInput } from './common';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport { Z_INDEX } from '../styles/zIndex';\r\n\r\ninterface TagFilterDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  title?: string;\r\n  allTags: string[];\r\n  selectedTags: string[];\r\n  onTagsChange: (tags: string[]) => void;\r\n  showClearButton?: boolean;\r\n  showApplyButton?: boolean;\r\n}\r\n\r\nconst TagFilterDialog: React.FC<TagFilterDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  title = 'Filter by Tags',\r\n  allTags,\r\n  selectedTags,\r\n  onTagsChange,\r\n  showClearButton = true,\r\n  showApplyButton = true\r\n}) => {\r\n  const theme = useTheme();\r\n  const [selectedTagGroup, setSelectedTagGroup] = useState<string>('');\r\n\r\n  // Get all unique tag groups\r\n  const tagGroups = useMemo(() => {\r\n    return getUniqueTagGroups(allTags);\r\n  }, [allTags]);\r\n\r\n  // Filter tags by selected group\r\n  const filteredTags = useMemo(() => {\r\n    if (!selectedTagGroup) return allTags;\r\n    return filterTagsByGroup(allTags, selectedTagGroup);\r\n  }, [allTags, selectedTagGroup]);\r\n\r\n  const handleClearTags = () => {\r\n    onTagsChange([]);\r\n  };\r\n\r\n  const dialogTitle = (\r\n    <Typography variant=\"h6\">{title}</Typography>\r\n  );\r\n\r\n  const dialogActions = (showClearButton || showApplyButton) ? (\r\n    <Box>\r\n      {showClearButton && (\r\n        <Button onClick={handleClearTags} color=\"inherit\">\r\n          Clear All\r\n        </Button>\r\n      )}\r\n      {showApplyButton && (\r\n        <Button onClick={onClose} color=\"primary\">\r\n          Apply\r\n        </Button>\r\n      )}\r\n    </Box>\r\n  ) : undefined;\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={onClose}\r\n      title={dialogTitle}\r\n      actions={dialogActions}\r\n      maxWidth=\"sm\"\r\n      fullWidth\r\n    >\r\n      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 2 }}>\r\n        {tagGroups.length > 0 && (\r\n          <SelectInput\r\n            label=\"Filter by Tag Group\"\r\n            value={selectedTagGroup}\r\n            onChange={(e) => setSelectedTagGroup(e.target.value as string)}\r\n            options={[\r\n              { value: \"\", label: \"All Tags\" },\r\n              ...tagGroups.map(group => ({ value: group, label: group }))\r\n            ]}\r\n            size=\"small\"\r\n          />\r\n        )}\r\n\r\n        <Autocomplete\r\n          multiple\r\n          options={filteredTags}\r\n          value={selectedTags}\r\n          onChange={(_, newValue) => onTagsChange(newValue)}\r\n          slotProps={{\r\n            popper: {\r\n              sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n            },\r\n            listbox: {\r\n              sx: {\r\n                ...scrollbarStyles(theme)\r\n              }\r\n            }\r\n          }}\r\n          renderInput={(params) => (\r\n            <TextField\r\n              {...params}\r\n              variant=\"outlined\"\r\n              label=\"Select Tags\"\r\n              placeholder=\"Choose tags to filter\"\r\n              fullWidth\r\n            />\r\n          )}\r\n          renderTags={(value, getTagProps) =>\r\n            value.map((option, index) => (\r\n              <Chip\r\n                label={formatTagForDisplay(option, true)}\r\n                {...getTagProps({ index })}\r\n                sx={getTagChipStyles(option, theme)}\r\n                title={isGroupedTag(option) ? `Group: ${getTagGroup(option)}` : undefined}\r\n              />\r\n            ))\r\n          }\r\n          renderOption={(props, option) => {\r\n            const { key, ...restProps } = props;\r\n            return (\r\n              <li key={key} {...restProps}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                  {isGroupedTag(option) && (\r\n                    <Chip\r\n                      label={getTagGroup(option)}\r\n                      size=\"small\"\r\n                      sx={{\r\n                        ...getTagChipStyles(option, theme),\r\n                        height: '18px',\r\n                        fontSize: '0.7rem'\r\n                      }}\r\n                    />\r\n                  )}\r\n                  {formatTagForDisplay(option, true)}\r\n                </Box>\r\n              </li>\r\n            );\r\n          }}\r\n        />\r\n      </Box>\r\n\r\n      <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mt: 2 }}>\r\n        {selectedTags.length > 0\r\n          ? `Selected ${selectedTags.length} tag${selectedTags.length > 1 ? 's' : ''}`\r\n          : 'Select tags to filter. When no tags are selected, all items will be shown.'}\r\n      </Typography>\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default TagFilterDialog;\r\n","import { logger } from '../utils/logger';\r\nimport { Trade } from '../types/dualWrite';\r\n\r\nexport interface PerformanceCalculationResult {\r\n  winLossStats: any;\r\n  tagStats: any[];\r\n  dailySummaryData: any[];\r\n  riskRewardStats: any;\r\n  sessionStats: any[];\r\n  comparisonWinLossData: any[] | null;\r\n  allTags: string[];\r\n  winLossData: any[];\r\n}\r\n\r\nexport class PerformanceCalculationService {\r\n  private static instance: PerformanceCalculationService;\r\n\r\n  public static getInstance(): PerformanceCalculationService {\r\n    if (!PerformanceCalculationService.instance) {\r\n      PerformanceCalculationService.instance = new PerformanceCalculationService();\r\n    }\r\n    return PerformanceCalculationService.instance;\r\n  }\r\n\r\n  // Calculate tag performance from trades (client-side, no DB query)\r\n  public calculateTagPerformanceFromTrades(\r\n    trades: Trade[],\r\n    primaryTags: string[],\r\n    secondaryTags: string[] = []\r\n  ): any[] {\r\n    try {\r\n      // If no tags selected, return empty array\r\n      if (primaryTags.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      // Calculate performance for each primary tag\r\n      const tagPerformanceResults = primaryTags.map(primaryTag => {\r\n        // Filter trades that have this primary tag AND all secondary tags\r\n        const filteredTrades = trades.filter(trade => {\r\n          // Check if trade has the primary tag\r\n          if (!trade.tags?.includes(primaryTag)) return false;\r\n          // Check if trade has all secondary tags\r\n          if (secondaryTags.length > 0 && !secondaryTags.every(tag => trade.tags?.includes(tag))) return false;\r\n          return true;\r\n        });\r\n\r\n        // Skip if no trades match\r\n        if (filteredTrades.length === 0) {\r\n          return null;\r\n        }\r\n\r\n        // Calculate metrics for this tag\r\n        const wins = filteredTrades.filter(t => t.trade_type === 'win');\r\n        const losses = filteredTrades.filter(t => t.trade_type === 'loss');\r\n        const breakevens = filteredTrades.filter(t => t.trade_type === 'breakeven');\r\n        const totalTrades = filteredTrades.length;\r\n        const totalPnl = filteredTrades.reduce((sum, t) => sum + t.amount, 0);\r\n        const avgPnl = totalTrades > 0 ? totalPnl / totalTrades : 0;\r\n        const maxWin = wins.length > 0 ? Math.max(...wins.map(t => t.amount)) : 0;\r\n        const maxLoss = losses.length > 0 ? Math.min(...losses.map(t => t.amount)) : 0;\r\n        const winRate = totalTrades > 0 ? Math.round((wins.length / totalTrades) * 100 * 100) / 100 : 0;\r\n\r\n        return {\r\n          tag: primaryTag,\r\n          wins: wins.length,\r\n          losses: losses.length,\r\n          breakevens: breakevens.length,\r\n          total_trades: totalTrades,\r\n          win_rate: winRate,\r\n          total_pnl: totalPnl,\r\n          avg_pnl: avgPnl,\r\n          max_win: maxWin,\r\n          max_loss: maxLoss\r\n        };\r\n      }).filter(result => result !== null); // Remove tags with no trades\r\n\r\n      return tagPerformanceResults;\r\n    } catch (error) {\r\n      logger.error('Error in calculateTagPerformanceFromTrades:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\nexport const performanceCalculationService = PerformanceCalculationService.getInstance();\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  Legend,\r\n  ResponsiveContainer,\r\n  Cell\r\n} from 'recharts';\r\nimport { Box, Paper, Typography, useTheme, Button, alpha, Tooltip as MuiTooltip, CircularProgress } from '@mui/material';\r\nimport { InfoOutlined } from '@mui/icons-material';\r\nimport { format, isSameMonth } from 'date-fns';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { formatValue } from '../../utils/formatters';\r\nimport TagFilterDialog from '../TagFilterDialog';\r\nimport { performanceCalculationService } from '../../services/performanceCalculationService';\r\n\r\ninterface TagPerformanceAnalysisProps { \r\n  trades: Trade[];\r\n  selectedDate: Date;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n  allTags: string[];\r\n  primaryTags: string[];\r\n  secondaryTags: string[];\r\n  setPrimaryTags: (tags: string[]) => void;\r\n  setSecondaryTags: (tags: string[]) => void;\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n}\r\n\r\nconst TagPerformanceAnalysis: React.FC<TagPerformanceAnalysisProps> = ({ \r\n  trades,\r\n  selectedDate,\r\n  timePeriod,\r\n  allTags,\r\n  primaryTags,\r\n  secondaryTags,\r\n  setPrimaryTags,\r\n  setSecondaryTags,\r\n  setMultipleTradesDialog\r\n}) => {\r\n  const theme = useTheme();\r\n  const [primaryTagsDialogOpen, setPrimaryTagsDialogOpen] = useState(false);\r\n  const [secondaryTagsDialogOpen, setSecondaryTagsDialogOpen] = useState(false);\r\n  const [filteredTagStats, setFilteredTagStats] = useState<any[]>([]);\r\n  const [isCalculating, setIsCalculating] = useState(false);\r\n\r\n\r\n  // Calculate filtered tag stats client-side (no DB query needed)\r\n  useEffect(() => {\r\n    const calculateFilteredStats = () => {\r\n      if (primaryTags.length === 0) {\r\n        setFilteredTagStats([]);\r\n        return;\r\n      }\r\n\r\n      setIsCalculating(true);\r\n      try {\r\n        // Use client-side calculation from already-fetched trades\r\n        const tagPerformanceData = performanceCalculationService.calculateTagPerformanceFromTrades(\r\n          trades,\r\n          primaryTags,\r\n          secondaryTags\r\n        );\r\n\r\n        // Transform data to match component expectations\r\n        const tagStats = tagPerformanceData.map((tagData: any) => ({\r\n          tag: tagData.tag.substring(tagData.tag.indexOf(\":\") + 1, tagData.tag.length),\r\n          wins: tagData.wins,\r\n          losses: tagData.losses,\r\n          breakevens: tagData.breakevens,\r\n          total_trades: tagData.total_trades,\r\n          win_rate: tagData.win_rate,\r\n          total_pnl: tagData.total_pnl,\r\n          avg_pnl: tagData.avg_pnl,\r\n          max_win: tagData.max_win,\r\n          max_loss: tagData.max_loss,\r\n          trades: [] // Can be populated client-side if needed for clicks\r\n        }));\r\n\r\n        setFilteredTagStats(tagStats);\r\n      } catch (error) {\r\n        console.error('Error calculating filtered tag stats:', error);\r\n        setFilteredTagStats([]);\r\n      } finally {\r\n        setIsCalculating(false);\r\n      }\r\n    };\r\n\r\n    calculateFilteredStats();\r\n  }, [trades, primaryTags, secondaryTags]);\r\n\r\n\r\n\r\n  // Define colors\r\n  const COLORS = {\r\n    win: '#4caf50',\r\n    loss: '#f44336',\r\n    zero: '#9e9e9e',\r\n    breakEven: '#ff9800'\r\n  };\r\n\r\n  return (\r\n    <Box>\r\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n          <Typography variant=\"h6\">Tag Performance Analysis</Typography>\r\n          <MuiTooltip\r\n            title=\"Analyze how different tags perform. Select primary tags to filter, and optionally secondary tags to see how they perform in combination.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <InfoOutlined sx={{ fontSize: 16, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n          </MuiTooltip>\r\n        </Box>\r\n        <Box sx={{ display: 'flex', gap: 1 }}>\r\n          <MuiTooltip\r\n            title=\"Select primary tags to filter trades that have ANY of these tags. These are your main strategies or setups to analyze.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <Button\r\n              variant=\"outlined\"\r\n              size=\"small\"\r\n              onClick={() => setPrimaryTagsDialogOpen(true)}\r\n              sx={{ textTransform: 'none' }}\r\n            >\r\n              {primaryTags.length > 0 ? `Primary: ${primaryTags.length} tags` : 'Select Primary Tags'}\r\n            </Button>\r\n          </MuiTooltip>\r\n          <MuiTooltip\r\n            title=\"Select secondary tags to further filter trades that have ALL of these tags. Use this to analyze specific conditions within your primary strategies.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <Button\r\n              variant=\"outlined\"\r\n              size=\"small\"\r\n              onClick={() => setSecondaryTagsDialogOpen(true)}\r\n              color={secondaryTags.length > 0 ? \"secondary\" : \"primary\"}\r\n              sx={{\r\n                textTransform: 'none',\r\n                borderColor: secondaryTags.length > 0 ? 'secondary.main' : undefined\r\n              }}\r\n            >\r\n              {secondaryTags.length > 0 ? `Secondary: ${secondaryTags.length} tags` : 'Select Secondary Tags'}\r\n            </Button>\r\n          </MuiTooltip>\r\n          <TagFilterDialog\r\n            open={primaryTagsDialogOpen}\r\n            onClose={() => setPrimaryTagsDialogOpen(false)}\r\n            title=\"Select Primary Tags\"\r\n            allTags={allTags}\r\n            selectedTags={primaryTags}\r\n            onTagsChange={(tags) => setPrimaryTags(tags)}\r\n            showApplyButton={true}\r\n            showClearButton={true}\r\n          />\r\n          <TagFilterDialog\r\n            open={secondaryTagsDialogOpen}\r\n            onClose={() => setSecondaryTagsDialogOpen(false)}\r\n            title=\"Select Secondary Tags\"\r\n            allTags={allTags}\r\n            selectedTags={secondaryTags}\r\n            onTagsChange={(tags) => setSecondaryTags(tags)}\r\n            showApplyButton={true}\r\n            showClearButton={true}\r\n          />\r\n        </Box>\r\n      </Box>\r\n      {primaryTags.length === 0 && secondaryTags.length === 0 ? (\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          height: 200,\r\n          bgcolor: alpha(theme.palette.background.paper, 0.4),\r\n          borderRadius: 2,\r\n          p: 3\r\n        }}>\r\n          <Typography variant=\"h6\" color=\"text.secondary\" sx={{ mb: 1 }}>\r\n            No Tags Selected\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\" align=\"center\">\r\n            Please select primary or secondary tags to view performance analysis.\r\n          </Typography>\r\n        </Box>\r\n      ) : isCalculating ? (\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          height: 300,\r\n          bgcolor: alpha(theme.palette.background.paper, 0.4),\r\n          borderRadius: 2,\r\n          p: 3\r\n        }}>\r\n          <CircularProgress size={40} sx={{ mb: 2 }} />\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            Calculating tag performance...\r\n          </Typography>\r\n        </Box>\r\n      ) : (\r\n        <ResponsiveContainer width=\"100%\" height={300}>\r\n          <BarChart\r\n            data={filteredTagStats}\r\n            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\r\n            maxBarSize={50}\r\n          >\r\n            <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n            <XAxis\r\n              dataKey=\"tag\"\r\n              axisLine={false}\r\n              tickLine={false}\r\n              tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n            />\r\n            <YAxis\r\n              axisLine={false}\r\n              tickLine={false}\r\n              tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n            />\r\n            <Tooltip\r\n              content={({ active, payload, label }) => {\r\n                if (active && payload && payload.length) {\r\n                  const data = payload[0].payload;\r\n                  return (\r\n                    <Paper sx={{ p: 1.5, bgcolor: 'background.paper' }}>\r\n                      <Typography variant=\"body2\" sx={{ fontWeight: 'bold' }}>\r\n                        {label}\r\n                      </Typography>\r\n                      <Typography variant=\"body2\" sx={{ color: COLORS.win }}>\r\n                        Wins: {data.wins}\r\n                      </Typography>\r\n                      <Typography variant=\"body2\" sx={{ color: COLORS.loss }}>\r\n                        Losses: {data.losses}\r\n                      </Typography>\r\n                      <Typography variant=\"body2\" color=\"text.secondary\">\r\n                        Win Rate: {data.win_rate}%\r\n                      </Typography>\r\n                      <Typography\r\n                        variant=\"body2\"\r\n                        sx={{\r\n                          color: data.total_pnl > 0 ? COLORS.win : COLORS.loss,\r\n                          fontWeight: 'bold',\r\n                          mt: 0.5\r\n                        }}\r\n                      >\r\n                        P&L: {formatValue(data.total_pnl)}\r\n                      </Typography>\r\n                    </Paper>\r\n                  );\r\n                }\r\n                return null;\r\n              }}\r\n            />\r\n            <Legend />\r\n            <Bar\r\n              dataKey=\"wins\"\r\n              name=\"Wins\"\r\n              stackId=\"trades\"\r\n              fill={COLORS.win}\r\n              radius={[4, 4, 0, 0]}\r\n              onClick={(data) => {\r\n                if (data && data.payload) {\r\n                  const tag = data.payload.tag;\r\n                  // Filter trades client-side for click handler\r\n                  const fullTag = primaryTags.find(t => t.endsWith(`:${tag}`)) || tag;\r\n                  const filteredTrades = trades.filter(trade => {\r\n                    // Check if trade has the tag\r\n                    if (!trade.tags?.includes(fullTag)) return false;\r\n                    // Check if trade has all secondary tags\r\n                    if (secondaryTags.length > 0 && !secondaryTags.every(t => trade.tags?.includes(t))) return false;\r\n                    // Check trade type\r\n                    if (trade.trade_type !== 'win') return false;\r\n                    // Check time period\r\n                    if (timePeriod === 'month') return isSameMonth(new Date(trade.trade_date), selectedDate);\r\n                    if (timePeriod === 'year') return new Date(trade.trade_date).getFullYear() === selectedDate.getFullYear();\r\n                    return true;\r\n                  });\r\n                  if (filteredTrades.length > 0) {\r\n                    setMultipleTradesDialog({\r\n                      open: true,\r\n                      trades: filteredTrades,\r\n                      date: `Winning trades with tag: ${[fullTag, ...secondaryTags].join(\", \")}`,\r\n                      expandedTradeId: filteredTrades.length === 1 ? filteredTrades[0].id : null\r\n                    });\r\n                  }\r\n                }\r\n              }}\r\n              style={{ cursor: 'pointer' }}\r\n            />\r\n            <Bar\r\n              dataKey=\"losses\"\r\n              name=\"Losses\"\r\n              stackId=\"trades\"\r\n              fill={COLORS.loss}\r\n              radius={[4, 4, 0, 0]}\r\n              onClick={(data) => {\r\n                if (data && data.payload) {\r\n                  const tag = data.payload.tag;\r\n                  // Filter trades client-side for click handler\r\n                  const fullTag = primaryTags.find(t => t.endsWith(`:${tag}`)) || tag;\r\n                  const filteredTrades = trades.filter(trade => {\r\n                    // Check if trade has the tag\r\n                    if (!trade.tags?.includes(fullTag)) return false;\r\n                    // Check if trade has all secondary tags\r\n                    if (secondaryTags.length > 0 && !secondaryTags.every(t => trade.tags?.includes(t))) return false;\r\n                    // Check trade type\r\n                    if (trade.trade_type !== 'loss') return false;\r\n                    // Check time period\r\n                    if (timePeriod === 'month') return isSameMonth(new Date(trade.trade_date), selectedDate);\r\n                    if (timePeriod === 'year') return new Date(trade.trade_date).getFullYear() === selectedDate.getFullYear();\r\n                    return true;\r\n                  });\r\n                  if (filteredTrades.length > 0) {\r\n                    setMultipleTradesDialog({\r\n                      open: true,\r\n                      trades: filteredTrades,\r\n                      date: `Losing trades with tag: ${[fullTag, ...secondaryTags].join(\", \")}`,\r\n                      expandedTradeId: filteredTrades.length === 1 ? filteredTrades[0].id : null\r\n                    });\r\n                  }\r\n                }\r\n              }}\r\n              style={{ cursor: 'pointer' }}\r\n            />\r\n          </BarChart>\r\n        </ResponsiveContainer>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default TagPerformanceAnalysis;\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  BarChart,\r\n  Bar,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  Legend,\r\n  ResponsiveContainer,\r\n  Cell\r\n} from 'recharts';\r\nimport { Box, Paper, Typography, useTheme, Button, alpha, Tooltip as MuiTooltip, CircularProgress } from '@mui/material';\r\nimport { InfoOutlined } from '@mui/icons-material';\r\n\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { formatCurrency } from '../../utils/formatters';\r\nimport TagFilterDialog from '../TagFilterDialog';\r\nimport { getTagDayOfWeekChartData } from '../../utils/chartDataUtils';\r\n\r\ninterface TagDayOfWeekAnalysisProps { \r\n  trades: Trade[];\r\n  selectedDate: Date;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n  allTags: string[];\r\n  primaryTags: string[];\r\n  secondaryTags: string[];\r\n  setPrimaryTags: (tags: string[]) => void;\r\n  setSecondaryTags: (tags: string[]) => void;\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n}\r\n\r\n\r\n\r\nconst TagDayOfWeekAnalysis: React.FC<TagDayOfWeekAnalysisProps> = ({ \r\n  trades,\r\n  selectedDate,\r\n  timePeriod,\r\n  allTags,\r\n  primaryTags,\r\n  secondaryTags,\r\n  setPrimaryTags,\r\n  setSecondaryTags,\r\n  setMultipleTradesDialog\r\n}) => {\r\n  const theme = useTheme();\r\n  const [primaryTagsDialogOpen, setPrimaryTagsDialogOpen] = useState(false);\r\n  const [secondaryTagsDialogOpen, setSecondaryTagsDialogOpen] = useState(false);\r\n  const [selectedMetric, setSelectedMetric] = useState<'winRate' | 'pnl'>('winRate');\r\n  const [chartData, setChartData] = useState<any[]>([]);\r\n  const [isCalculating, setIsCalculating] = useState(false);\r\n\r\n  // Calculate chart data (client-side filtering for day-of-week grouping)\r\n  // Note: Day-of-week analysis requires client-side processing since RPC doesn't group by day\r\n  useEffect(() => {\r\n    const calculateData = async () => {\r\n      if (primaryTags.length === 0) {\r\n        setChartData([]);\r\n        return;\r\n      }\r\n\r\n      setIsCalculating(true);\r\n      try {\r\n        // Filter trades client-side (needed for day-of-week grouping and click handlers)\r\n        const filteredTrades = trades.filter(trade => {\r\n          // Check if trade has any primary tag\r\n          if (!trade.tags || !primaryTags.some(tag => trade.tags?.includes(tag))) return false;\r\n          // Check if trade has all secondary tags\r\n          if (secondaryTags.length > 0 && !secondaryTags.every(tag => trade.tags?.includes(tag))) return false;\r\n          return true;\r\n        });\r\n\r\n        // Calculate chart data (day of week grouping)\r\n        const chartDataResult = getTagDayOfWeekChartData(filteredTrades, theme, selectedMetric === 'winRate');\r\n        setChartData(chartDataResult);\r\n      } catch (error) {\r\n        console.error('Error calculating day of week data:', error);\r\n        setChartData([]);\r\n      } finally {\r\n        setIsCalculating(false);\r\n      }\r\n    };\r\n\r\n    calculateData();\r\n  }, [trades, primaryTags, secondaryTags, selectedMetric, theme]);\r\n\r\n  // Custom tooltip for the chart\r\n  const CustomTooltip = ({ active, payload, label }: any) => {\r\n    if (active && payload && payload.length) {\r\n      const data = payload[0].payload;\r\n      return (\r\n        <Paper sx={{ p: 1.5, bgcolor: 'background.paper' }}>\r\n          <Typography variant=\"body2\" sx={{ fontWeight: 'bold' }}>\r\n            {data.fullDay}\r\n          </Typography>\r\n          <Typography variant=\"body2\">\r\n            Total Trades: {data.total_trades}\r\n          </Typography>\r\n          <Typography variant=\"body2\" sx={{ color: theme.palette.success.main }}>\r\n            Wins: {data.winTrades}\r\n          </Typography>\r\n          <Typography variant=\"body2\" sx={{ color: theme.palette.error.main }}>\r\n            Losses: {data.lossTrades}\r\n          </Typography>\r\n          <Typography variant=\"body2\">\r\n            Win Rate: {data.win_rate.toFixed(1)}%\r\n          </Typography>\r\n          <Typography variant=\"body2\">\r\n            P&L: {formatCurrency(data.pnl)}\r\n          </Typography>\r\n        </Paper>\r\n      );\r\n    }\r\n    return null;\r\n  };\r\n\r\n\r\n\r\n  return (\r\n    <Box>\r\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n          <Typography variant=\"h6\">Tag Performance by Day of Week</Typography>\r\n          <MuiTooltip\r\n            title=\"Analyze how selected tags perform on different days of the week. This helps identify which strategies work better on specific days.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <InfoOutlined sx={{ fontSize: 16, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n          </MuiTooltip>\r\n        </Box>\r\n        <Box sx={{ display: 'flex', gap: 1 }}>\r\n          <Button\r\n            variant={selectedMetric === 'winRate' ? 'contained' : 'outlined'}\r\n            size=\"small\"\r\n            onClick={() => setSelectedMetric('winRate')}\r\n            sx={{ textTransform: 'none' }}\r\n          >\r\n            Win Rate\r\n          </Button>\r\n          <Button\r\n            variant={selectedMetric === 'pnl' ? 'contained' : 'outlined'}\r\n            size=\"small\"\r\n            onClick={() => setSelectedMetric('pnl')}\r\n            sx={{ textTransform: 'none' }}\r\n          >\r\n            P&L\r\n          </Button>\r\n          <MuiTooltip\r\n            title=\"Select primary tags to filter trades that have ANY of these tags. These are your main strategies or setups to analyze.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <Button\r\n              variant=\"outlined\"\r\n              size=\"small\"\r\n              onClick={() => setPrimaryTagsDialogOpen(true)}\r\n              sx={{ textTransform: 'none' }}\r\n            >\r\n              {primaryTags.length > 0 ? `Primary: ${primaryTags.length} tags` : 'Select Primary Tags'}\r\n            </Button>\r\n          </MuiTooltip>\r\n          <MuiTooltip\r\n            title=\"Select secondary tags to further filter trades that have ALL of these tags. Use this to analyze specific conditions within your primary strategies.\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <Button\r\n              variant=\"outlined\"\r\n              size=\"small\"\r\n              onClick={() => setSecondaryTagsDialogOpen(true)}\r\n              color={secondaryTags.length > 0 ? \"secondary\" : \"primary\"}\r\n              sx={{\r\n                textTransform: 'none',\r\n                borderColor: secondaryTags.length > 0 ? 'secondary.main' : undefined\r\n              }}\r\n            >\r\n              {secondaryTags.length > 0 ? `Secondary: ${secondaryTags.length} tags` : 'Select Secondary Tags'}\r\n            </Button>\r\n          </MuiTooltip>\r\n          <TagFilterDialog\r\n            open={primaryTagsDialogOpen}\r\n            onClose={() => setPrimaryTagsDialogOpen(false)}\r\n            title=\"Select Primary Tags\"\r\n            allTags={allTags}\r\n            selectedTags={primaryTags}\r\n            onTagsChange={(tags) => setPrimaryTags(tags)}\r\n            showApplyButton={true}\r\n            showClearButton={true}\r\n          />\r\n          <TagFilterDialog\r\n            open={secondaryTagsDialogOpen}\r\n            onClose={() => setSecondaryTagsDialogOpen(false)}\r\n            title=\"Select Secondary Tags\"\r\n            allTags={allTags}\r\n            selectedTags={secondaryTags}\r\n            onTagsChange={(tags) => setSecondaryTags(tags)}\r\n            showApplyButton={true}\r\n            showClearButton={true}\r\n          />\r\n        </Box>\r\n      </Box> \r\n      {primaryTags.length === 0 ? (\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          height: 200,\r\n          bgcolor: alpha(theme.palette.background.paper, 0.4),\r\n          borderRadius: 2,\r\n          p: 3\r\n        }}>\r\n          <Typography variant=\"h6\" color=\"text.secondary\" sx={{ mb: 1 }}>\r\n            No Tags Selected\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\" align=\"center\">\r\n            Please select primary tags to view day of week performance analysis.\r\n          </Typography>\r\n        </Box>\r\n      ) : isCalculating ? (\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          height: 300,\r\n          bgcolor: alpha(theme.palette.background.paper, 0.4),\r\n          borderRadius: 2,\r\n          p: 3\r\n        }}>\r\n          <CircularProgress size={40} sx={{ mb: 2 }} />\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            Calculating day of week performance...\r\n          </Typography>\r\n        </Box>\r\n      ) : (\r\n        <>\r\n          <Box sx={{ mb: 2 }}>\r\n            <Typography variant=\"body2\" color=\"text.secondary\" sx={{ lineHeight: 1.6 }}>\r\n              This chart shows how your selected trading strategies (tags) perform on different days of the week.\r\n              {selectedMetric === 'winRate'\r\n                ? ' Higher bars indicate better win rates on those days. '\r\n                : ' Higher bars indicate better profitability on those days. '}\r\n              Click on any bar to see the specific trades for that day.\r\n            </Typography>\r\n            {chartData.some(data => data.total_trades > 0) ? (\r\n              <Typography variant=\"body2\" color=\"primary\" sx={{ mt: 1, fontWeight: 500 }}>\r\n                {selectedMetric === 'winRate'\r\n                  ? `Best day for selected strategies: ${chartData.reduce((best, day) => day.total_trades > 0 && day.win_rate > best.win_rate ? day : best, { win_rate: 0, fullDay: 'None' }).fullDay}`\r\n                  : `Most profitable day: ${chartData.reduce((best, day) => day.total_trades > 0 && day.pnl > best.pnl ? day : best, { pnl: -Infinity, fullDay: 'None' }).fullDay}`\r\n                }\r\n              </Typography>\r\n            ) : null}\r\n          </Box>\r\n          <ResponsiveContainer width=\"100%\" height={300}>\r\n            <BarChart\r\n              data={chartData}\r\n              margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\r\n              maxBarSize={50}\r\n            >\r\n              <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n              <XAxis\r\n                dataKey=\"day\"\r\n                axisLine={false}\r\n                tickLine={false}\r\n                tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n              />\r\n              <YAxis\r\n                axisLine={false}\r\n                tickLine={false}\r\n                tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n                domain={selectedMetric === 'winRate' ? [0, 100] : ['auto', 'auto']}\r\n                tickFormatter={selectedMetric === 'winRate'\r\n                  ? (value) => `${value}%`\r\n                  : (value) => formatCurrency(value).replace('$', '')}\r\n              />\r\n              <Tooltip content={<CustomTooltip />} />\r\n              <Legend />\r\n              <Bar\r\n                dataKey=\"value\"\r\n                name={selectedMetric === 'winRate' ? 'Win Rate' : 'P&L'}\r\n                fill={theme.palette.primary.main}\r\n                radius={[4, 4, 0, 0]}\r\n                onClick={(data) => {\r\n                  if (data && data.payload && setMultipleTradesDialog) {\r\n                    const dayTrades = data.payload.trades;\r\n                    if (dayTrades.length > 0) {\r\n                      setMultipleTradesDialog({\r\n                        open: true,\r\n                        trades: dayTrades,\r\n                        showChartInfo:false,\r\n                        date: `${selectedMetric === 'winRate' ? 'Win Rate' : 'P&L'} for ${data.payload.fullDay}`,\r\n                        expandedTradeId: dayTrades.length === 1 ? dayTrades[0].id : null\r\n                      });\r\n                    }\r\n                  }\r\n                }}\r\n                style={{ cursor: 'pointer' }}\r\n              >\r\n                {chartData.map((entry, index) => (\r\n                  <Cell key={`cell-${index}`} fill={entry.color} />\r\n                ))}\r\n              </Bar>\r\n            </BarChart>\r\n          </ResponsiveContainer>\r\n        </>\r\n      )} \r\n    </Box>\r\n  );\r\n};\r\n \r\n\r\nexport default TagDayOfWeekAnalysis;\r\n","import React from 'react';\r\nimport {\r\n  Paper,\r\n  Typography,\r\n  useTheme,\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableContainer,\r\n  TableHead,\r\n  TableRow,\r\n  Box,\r\n  Tooltip,\r\n  TablePagination\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport { InfoOutlined, TrendingUp, TrendingDown, TrendingFlat } from '@mui/icons-material';\r\nimport { format, isValid } from 'date-fns';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { formatValue } from '../../utils/formatters';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\n\r\ninterface DailySummaryTableProps {\r\n  dailySummaryData: any[];\r\n  trades: Trade[];\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n}\r\n\r\nconst DailySummaryTable: React.FC<DailySummaryTableProps> = ({\r\n  dailySummaryData,\r\n  trades,\r\n  setMultipleTradesDialog\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Pagination state\r\n  const [page, setPage] = React.useState(0);\r\n  const [rowsPerPage, setRowsPerPage] = React.useState(10);\r\n\r\n  // Calculate total PnL from dailySummaryData\r\n  const totalPnL = React.useMemo(() => {\r\n    if (!dailySummaryData || dailySummaryData.length === 0) return 0;\r\n    return dailySummaryData.reduce((sum, day) => sum + day.pnl, 0);\r\n  }, [dailySummaryData]);\r\n\r\n  // Paginated data\r\n  const paginatedData = React.useMemo(() => {\r\n    const startIndex = page * rowsPerPage;\r\n    const endIndex = startIndex + rowsPerPage;\r\n    return dailySummaryData.slice(startIndex, endIndex);\r\n  }, [dailySummaryData, page, rowsPerPage]);\r\n\r\n  // Handle page change\r\n  const handleChangePage = (event: unknown, newPage: number) => {\r\n    setPage(newPage);\r\n  };\r\n\r\n  // Handle rows per page change\r\n  const handleChangeRowsPerPage = (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    setRowsPerPage(parseInt(event.target.value, 10));\r\n    setPage(0);\r\n  };\r\n\r\n  // Reset page when data changes\r\n  React.useEffect(() => {\r\n    setPage(0);\r\n  }, [dailySummaryData.length]);\r\n\r\n  return (\r\n    <Paper sx={{ p: 3, borderRadius: 2, height: '100%', display: 'flex', flexDirection: 'column' }}>\r\n      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n          <Typography variant=\"h6\">Daily Summary</Typography>\r\n          <Tooltip\r\n            title=\"Daily trading summary showing trades, session, and P&L for each day\"\r\n            arrow\r\n            placement=\"top\"\r\n          >\r\n            <InfoOutlined sx={{ fontSize: 16, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\r\n          </Tooltip>\r\n        </Box>\r\n        {dailySummaryData && dailySummaryData.length > 0 && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 1,\r\n            bgcolor: alpha(\r\n              totalPnL > 0\r\n                ? theme.palette.success.main\r\n                : totalPnL < 0\r\n                ? theme.palette.error.main\r\n                : theme.palette.grey[500],\r\n              0.1\r\n            ),\r\n            px: 1.5,\r\n            py: 0.5,\r\n            borderRadius: 2,\r\n            border: `1px solid ${alpha(\r\n              totalPnL > 0\r\n                ? theme.palette.success.main\r\n                : totalPnL < 0\r\n                ? theme.palette.error.main\r\n                : theme.palette.grey[500],\r\n              0.2\r\n            )}`,\r\n          }}>\r\n          {totalPnL > 0 ? (\r\n            <TrendingUp sx={{ color: theme.palette.success.main }} />\r\n          ) : totalPnL < 0 ? (\r\n            <TrendingDown sx={{ color: theme.palette.error.main }} />\r\n          ) : (\r\n            <TrendingFlat sx={{ color: theme.palette.grey[500] }} />\r\n          )}\r\n          <Typography\r\n            variant=\"subtitle1\"\r\n            sx={{\r\n              fontWeight: 600,\r\n              color: totalPnL > 0\r\n                ? theme.palette.success.main\r\n                : totalPnL < 0\r\n                ? theme.palette.error.main\r\n                : 'text.secondary'\r\n            }}\r\n          >\r\n            Total P&L: {formatValue(totalPnL)}\r\n          </Typography>\r\n        </Box>\r\n        )}\r\n      </Box>\r\n      <TableContainer sx={{\r\n        flex: 1,\r\n        overflow: 'auto',\r\n        ...scrollbarStyles(theme)\r\n      }}>\r\n        <Table stickyHeader size=\"small\">\r\n          <TableHead>\r\n            <TableRow>\r\n              <TableCell\r\n                sx={{\r\n                  fontWeight: 600,\r\n                  backgroundColor: theme.palette.background.paper,\r\n                  borderBottom: `2px solid ${theme.palette.divider}`,\r\n                  color: 'text.secondary'\r\n                }}\r\n              >\r\n                DATE\r\n              </TableCell>\r\n              <TableCell\r\n                align=\"right\"\r\n                sx={{\r\n                  fontWeight: 600,\r\n                  backgroundColor: theme.palette.background.paper,\r\n                  borderBottom: `2px solid ${theme.palette.divider}`,\r\n                  color: 'text.secondary'\r\n                }}\r\n              >\r\n                TRADES\r\n              </TableCell>\r\n              <TableCell\r\n                align=\"center\"\r\n                sx={{\r\n                  fontWeight: 600,\r\n                  backgroundColor: theme.palette.background.paper,\r\n                  borderBottom: `2px solid ${theme.palette.divider}`,\r\n                  color: 'text.secondary'\r\n                }}\r\n              >\r\n                SESSION\r\n              </TableCell>\r\n              <TableCell\r\n                align=\"right\"\r\n                sx={{\r\n                  fontWeight: 600,\r\n                  backgroundColor: theme.palette.background.paper,\r\n                  borderBottom: `2px solid ${theme.palette.divider}`,\r\n                  color: 'text.secondary'\r\n                }}\r\n              >\r\n                P/L\r\n              </TableCell>\r\n            </TableRow>\r\n          </TableHead>\r\n          <TableBody>\r\n            {paginatedData.map((row, index) => {\r\n              // Ensure trade_date is a valid Date object\r\n              const tradeDate = new Date(row.trade_date);\r\n\r\n              // Skip invalid dates\r\n              if (!isValid(tradeDate)) {\r\n                console.error('Invalid trade_date in dailySummaryData:', row);\r\n                return null;\r\n              }\r\n\r\n              return (\r\n                <TableRow\r\n                  key={format(tradeDate, 'yyyy-MM-dd')}\r\n                  onClick={() => {\r\n                    const dayTrades = trades.filter(trade =>\r\n                      format(new Date(trade.trade_date), 'yyyy-MM-dd') === format(tradeDate, 'yyyy-MM-dd')\r\n                    );\r\n                    if (dayTrades.length > 0) {\r\n                      setMultipleTradesDialog({\r\n                        open: true,\r\n                        trades: dayTrades,\r\n                        date: format(tradeDate, 'dd/MM/yyyy'),\r\n                        expandedTradeId: dayTrades.length === 1 ? dayTrades[0].id : null\r\n                      });\r\n                    }\r\n                  }}\r\n                  sx={{\r\n                    '&:last-child td, &:last-child th': { border: 0 },\r\n                    '&:hover': {\r\n                      backgroundColor: alpha(theme.palette.primary.main, 0.04),\r\n                      cursor: 'pointer'\r\n                    },\r\n                    bgcolor: row.pnl > 0\r\n                      ? alpha(theme.palette.success.main, 0.05)\r\n                      : row.pnl < 0\r\n                      ? alpha(theme.palette.error.main, 0.05)\r\n                      : 'transparent'\r\n                  }}\r\n                >\r\n                  <TableCell\r\n                    sx={{\r\n                      fontWeight: 500,\r\n                      color: 'text.primary'\r\n                    }}\r\n                  >\r\n                    {format(tradeDate, 'dd/MM/yyyy')}\r\n                  </TableCell>\r\n                <TableCell\r\n                  align=\"right\"\r\n                  sx={{\r\n                    fontWeight: 500,\r\n                    color: 'text.primary'\r\n                  }}\r\n                >\r\n                  {row.trades}\r\n                </TableCell>\r\n                <TableCell align=\"center\">\r\n                  {row.session ? (\r\n                    <Typography\r\n                      sx={{\r\n                        color: 'text.primary',\r\n                        fontWeight: 500\r\n                      }}\r\n                    >\r\n                      {row.session}\r\n                    </Typography>\r\n                  ) : (\r\n                    <Typography\r\n                      sx={{\r\n                        color: 'text.secondary',\r\n                        fontStyle: 'italic'\r\n                      }}\r\n                    >\r\n                      \r\n                    </Typography>\r\n                  )}\r\n                </TableCell>\r\n                <TableCell\r\n                  align=\"right\"\r\n                  sx={{\r\n                    color: row.pnl > 0\r\n                      ? theme.palette.success.main\r\n                      : row.pnl < 0\r\n                      ? theme.palette.error.main\r\n                      : 'text.secondary',\r\n                    fontWeight: 600,\r\n                    fontSize: '0.875rem'\r\n                  }}\r\n                >\r\n                  {formatValue(row.pnl)}\r\n                </TableCell>\r\n              </TableRow>\r\n              );\r\n            })}\r\n          </TableBody>\r\n        </Table>\r\n      </TableContainer>\r\n      <TablePagination\r\n        rowsPerPageOptions={[5, 10, 25, 50]}\r\n        component=\"div\"\r\n        count={dailySummaryData.length}\r\n        rowsPerPage={rowsPerPage}\r\n        page={page}\r\n        onPageChange={handleChangePage}\r\n        onRowsPerPageChange={handleChangeRowsPerPage}\r\n        sx={{\r\n          borderTop: `1px solid ${theme.palette.divider}`,\r\n          '.MuiTablePagination-toolbar': {\r\n            minHeight: 52\r\n          }\r\n        }}\r\n      />\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default DailySummaryTable;\r\n","import React from 'react';\r\nimport { Box, Paper, Typography, useTheme, Stack, alpha } from '@mui/material';\r\nimport { isSameMonth } from 'date-fns';\r\nimport { Trade } from '../../types/dualWrite';\r\nimport { formatValue } from '../../utils/formatters';\r\n\r\ninterface SessionPerformanceAnalysisProps {\r\n  sessionStats: any[];\r\n  trades: Trade[];\r\n  selectedDate: Date;\r\n  timePeriod: 'month' | 'year' | 'all';\r\n  setMultipleTradesDialog: (dialogState: any) => void;\r\n}\r\n\r\nconst SessionPerformanceAnalysis: React.FC<SessionPerformanceAnalysisProps> = ({\r\n  sessionStats,\r\n  trades,\r\n  selectedDate,\r\n  timePeriod,\r\n  setMultipleTradesDialog\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Define colors\r\n  const COLORS = {\r\n    win: '#4caf50',\r\n    loss: '#f44336',\r\n    zero: '#9e9e9e',\r\n    breakEven: '#ff9800'\r\n  };\r\n\r\n  // Define session-specific colors\r\n  const SESSION_COLORS = {\r\n    'Asia': '#2962ff',\r\n    'London': '#388e3c',\r\n    'NY AM': '#f57c00',\r\n    'NY PM': '#9c27b0'\r\n  };\r\n\r\n  return (\r\n    <Paper\r\n      elevation={theme.palette.mode === 'dark' ? 2 : 1}\r\n      sx={{\r\n        p: 3,\r\n        borderRadius: 2,\r\n        height: '100%',\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        bgcolor: theme.palette.background.paper,\r\n      }}>\r\n      <Typography variant=\"h6\" sx={{ mb: 2 }}>\r\n        Session Performance\r\n      </Typography>\r\n      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3, flex: 1 }}>\r\n        <Box sx={{\r\n          display: 'grid',\r\n          gridTemplateColumns: { xs: 'repeat(2, 1fr)', sm: 'repeat(2, 1fr)', md: 'repeat(2, 1fr)' },\r\n          gap: 2,\r\n          gridAutoRows: 'minmax(min-content, max-content)'\r\n        }}>\r\n          {sessionStats.map(session => (\r\n            <Paper\r\n              key={session.session}\r\n              sx={{\r\n                p: 2,\r\n                border: `1px solid ${alpha(\r\n                  SESSION_COLORS[session.session as keyof typeof SESSION_COLORS],\r\n                  0.3\r\n                )}`,\r\n                borderRadius: 2,\r\n                bgcolor: theme.palette.mode === 'dark' ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.02)',\r\n                opacity: session.total_trades === 0 ? 0.5 : 1,\r\n                cursor: session.total_trades > 0 ? 'pointer' : 'default',\r\n                transition: 'all 0.2s',\r\n                '&:hover': {\r\n                  boxShadow: session.total_trades > 0 ? theme.shadows[2] : 'none',\r\n                  bgcolor: session.total_trades > 0 ? alpha(theme.palette.primary.main, 0.05) : theme.palette.mode === 'dark' ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.02)'\r\n                }\r\n              }}\r\n              onClick={() => {\r\n                if (session.total_trades > 0) {\r\n                  const sessionTrades = trades.filter(trade =>\r\n                    trade.session?.toLowerCase() === session.session?.toLowerCase() &&\r\n                    (timePeriod === 'month' ? isSameMonth(new Date(trade.trade_date), selectedDate) :\r\n                     timePeriod === 'year' ? new Date(trade.trade_date).getFullYear() === selectedDate.getFullYear() :\r\n                     true)\r\n                  );\r\n                  setMultipleTradesDialog({\r\n                    open: true,\r\n                    trades: sessionTrades,\r\n                    tradeIds: sessionTrades.map(t => t.id),\r\n                    title: `${session.session} Session Trades`,\r\n                    expandedTradeId: sessionTrades.length === 1 ? sessionTrades[0].id : null\r\n                  });\r\n                }\r\n              }}\r\n            >\r\n              <Typography\r\n                variant=\"subtitle2\"\r\n                gutterBottom\r\n                sx={{ color: SESSION_COLORS[session.session as keyof typeof SESSION_COLORS] }}\r\n              >\r\n                {session.session}\r\n              </Typography>\r\n\r\n              <Stack spacing={1}>\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Total Trades\r\n                  </Typography>\r\n                  <Typography variant=\"body2\">\r\n                    {session.total_trades}\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Win Rate\r\n                  </Typography>\r\n                  <Typography\r\n                    variant=\"body2\"\r\n                    sx={{\r\n                      color: (session.win_rate ?? 0) >= 50 ? theme.palette.success.main : theme.palette.error.main\r\n                    }}\r\n                  >\r\n                    {(session.win_rate ?? 0).toFixed(1)}%\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    P&L\r\n                  </Typography>\r\n                  <Typography\r\n                    variant=\"body2\"\r\n                    sx={{\r\n                      color: session.total_pnl > 0 ? theme.palette.success.main : theme.palette.error.main,\r\n                      fontWeight: 500\r\n                    }}\r\n                  >\r\n                    {formatValue(session.total_pnl)}\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    Avg P&L per Trade\r\n                  </Typography>\r\n                  <Typography\r\n                    variant=\"body2\"\r\n                    sx={{\r\n                      ml: 1,\r\n                      color: session.averagePnL > 0 ? theme.palette.success.main : theme.palette.error.main\r\n                    }}\r\n                  >\r\n                    {formatValue(session.averagePnL)}\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    Account %\r\n                  </Typography>\r\n                  <Typography\r\n                    variant=\"body2\"\r\n                    sx={{\r\n                      color: (session.pnlPercentage ?? 0) > 0 ? theme.palette.success.main : theme.palette.error.main\r\n                    }}\r\n                  >\r\n                    {(session.pnlPercentage ?? 0).toFixed(2)}%\r\n                  </Typography>\r\n                </Box>\r\n\r\n                <Box sx={{ display: 'flex', gap: 1, mt: 1 }}>\r\n                  <Box\r\n                    sx={{\r\n                      flex: session.winners,\r\n                      height: 6,\r\n                      bgcolor: COLORS.win,\r\n                      borderRadius: 1\r\n                    }}\r\n                  />\r\n                  <Box\r\n                    sx={{\r\n                      flex: session.losers,\r\n                      height: 6,\r\n                      bgcolor: COLORS.loss,\r\n                      borderRadius: 1\r\n                    }}\r\n                  />\r\n                </Box>\r\n                <Box\r\n                  sx={{\r\n                    height: 3,\r\n                    bgcolor: alpha(SESSION_COLORS[session.session as keyof typeof SESSION_COLORS], 0.2),\r\n                    borderRadius: 1,\r\n                    mt: 1\r\n                  }}\r\n                />\r\n              </Stack>\r\n            </Paper>\r\n          ))}\r\n        </Box>\r\n\r\n        {/* Pro Tip Section */}\r\n        {sessionStats.some(session => session.total_trades > 0) && (\r\n          <Box\r\n            sx={{\r\n              p: 2,\r\n              bgcolor: theme.palette.mode === 'dark' ? 'rgba(33, 150, 243, 0.1)' : 'rgba(33, 150, 243, 0.05)',\r\n              border: `1px solid ${alpha(theme.palette.info.main, 0.2)}`,\r\n              borderRadius: 2,\r\n              mt: 1\r\n            }}\r\n          >\r\n            <Typography\r\n              variant=\"subtitle2\"\r\n              sx={{\r\n                color: theme.palette.info.main,\r\n                fontWeight: 600,\r\n                mb: 1,\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 1\r\n              }}\r\n            >\r\n               Pro Tip\r\n            </Typography>\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              {(() => {\r\n                const sessionsWithTrades = sessionStats.filter(session => session.total_trades > 0);\r\n                if (sessionsWithTrades.length === 0) return \"No trading data available for analysis.\";\r\n\r\n                // Find most profitable session by total P&L\r\n                const mostProfitable = sessionsWithTrades.reduce((prev, current) =>\r\n                  current.total_pnl > prev.total_pnl ? current : prev\r\n                );\r\n\r\n                // Find session with highest win rate\r\n                const highestWinRate = sessionsWithTrades.reduce((prev, current) =>\r\n                  current.win_rate > prev.win_rate ? current : prev\r\n                );\r\n\r\n                // Find session with best average P&L per trade\r\n                const bestAverage = sessionsWithTrades.reduce((prev, current) =>\r\n                  current.averagePnL > prev.averagePnL ? current : prev\r\n                );\r\n\r\n                if (mostProfitable.total_pnl > 0) {\r\n                  if (mostProfitable.session === highestWinRate.session && mostProfitable.session === bestAverage.session) {\r\n                    return `${mostProfitable.session} session is your strongest performer with the highest total P&L (${formatValue(mostProfitable.total_pnl)}), best win rate (${(mostProfitable.win_rate ?? 0).toFixed(1)}%), and highest average per trade (${formatValue(mostProfitable.averagePnL)}). Consider focusing more trades during this session.`;\r\n                  } else if (mostProfitable.session === highestWinRate.session) {\r\n                    return `${mostProfitable.session} session has both the highest total P&L (${formatValue(mostProfitable.total_pnl)}) and best win rate (${(mostProfitable.win_rate ?? 0).toFixed(1)}%). ${bestAverage.session} session has the best average per trade (${formatValue(bestAverage.averagePnL)}).`;\r\n                  } else {\r\n                    return `${mostProfitable.session} session is most profitable overall (${formatValue(mostProfitable.total_pnl)}), while ${highestWinRate.session} session has the highest win rate (${(highestWinRate.win_rate ?? 0).toFixed(1)}%). Consider analyzing what makes each session successful.`;\r\n                  }\r\n                } else {\r\n                  const leastLosing = sessionsWithTrades.reduce((prev, current) =>\r\n                    current.total_pnl > prev.total_pnl ? current : prev\r\n                  );\r\n                  return `All sessions are currently showing losses. ${leastLosing.session} session has the smallest loss (${formatValue(leastLosing.total_pnl)}). Consider reviewing your strategy and risk management.`;\r\n                }\r\n              })()}\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default SessionPerformanceAnalysis;\r\n","import React, { useState, useMemo, useEffect } from 'react';\r\nimport {\r\n  Typography,\r\n  Box,\r\n  Button,\r\n  Tooltip,\r\n  useTheme,\r\n  Paper\r\n} from '@mui/material';\r\nimport {\r\n  ViewCarousel as GalleryIcon\r\n} from '@mui/icons-material';\r\nimport { Trade, Calendar } from '../../types/dualWrite';\r\nimport TradeList from '../trades/TradeList';\r\nimport { BaseDialog } from '../common';\r\nimport DayHeader from '../trades/DayHeader';\r\nimport { startOfNextDay } from '../trades/TradeFormDialog';\r\nimport { calculateCumulativePnLToDateAsync } from '../../utils/dynamicRiskUtils';\r\nimport { Bar, BarChart, CartesianGrid, Cell, Legend, ResponsiveContainer, XAxis, YAxis, Tooltip as RechartsTooltip } from 'recharts';\r\nimport { logger } from '../../utils/logger';\r\nimport { formatCurrency } from '../../utils/formatters';\r\nimport { getTagDayOfWeekChartData } from '../../utils/chartDataUtils';\r\nimport { TradeOperationsProps } from '../../types/tradeOperations';\r\n\r\ninterface TradesDialogProps {\r\n  // Component-specific props\r\n  open: boolean;\r\n  trades: Trade[];\r\n  title: string;\r\n  subtitle?: string;\r\n  expandedTradeId: string | null;\r\n  showChartInfo?: boolean;\r\n  onClose: () => void;\r\n  onTradeExpand: (tradeId: string) => void;\r\n  account_balance: number;\r\n\r\n  // Trade operations - required\r\n  tradeOperations: TradeOperationsProps;\r\n}\r\n\r\nconst TradesListDialog: React.FC<TradesDialogProps> = ({\r\n  open,\r\n  trades,\r\n  title,\r\n  subtitle,\r\n  showChartInfo,\r\n  expandedTradeId,\r\n  onClose,\r\n  onTradeExpand,\r\n  account_balance,\r\n  tradeOperations\r\n}) => {\r\n  // Destructure from tradeOperations (isTradeUpdating now comes from TradeSyncContext)\r\n  const {\r\n    onZoomImage,\r\n    onUpdateTradeProperty,\r\n    onEditTrade,\r\n    onDeleteTrade,\r\n    onDeleteMultipleTrades,\r\n    onOpenGalleryMode,\r\n    calendarId,\r\n    economicFilter,\r\n    calendar\r\n  } = tradeOperations;\r\n\r\n  const theme = useTheme();\r\n\r\n  // State for cumulative P&L\r\n  const [cumulativePnL, setCumulativePnL] = useState<number>(0);\r\n  const [selectedMetric, setSelectedMetric] = useState<'winRate' | 'pnl'>('winRate');\r\n\r\n  // Fetch cumulative P&L when dialog opens or trades change\r\n  useEffect(() => {\r\n    const fetchCumulativePnL = async () => {\r\n      if (!open || !calendar || !trades || trades.length === 0) return;\r\n\r\n      try {\r\n        // Use the most recent trade's date to calculate cumulative P&L\r\n        const mostRecentTrade = trades.reduce((latest, trade) =>\r\n          new Date(trade.trade_date) > new Date(latest.trade_date) ? trade : latest\r\n        );\r\n\r\n        // Validate the trade date before proceeding\r\n        const targetDate = startOfNextDay(mostRecentTrade.trade_date);\r\n        if (isNaN(targetDate.getTime())) {\r\n          logger.warn('Invalid trade date, skipping cumulative P&L calculation');\r\n          setCumulativePnL(0);\r\n          return;\r\n        }\r\n\r\n        const pnl = await calculateCumulativePnLToDateAsync(targetDate, calendar);\r\n        setCumulativePnL(pnl);\r\n      } catch (error) {\r\n        logger.error('Error fetching cumulative P&L:', error);\r\n        setCumulativePnL(0);\r\n      }\r\n    };\r\n\r\n    fetchCumulativePnL();\r\n  }, [open, trades, calendar]);\r\n  // Format data for the chart based on selected metric\r\n  const [chartData, setChartData] = React.useState<any[] | undefined>(undefined);\r\n\r\n\r\n  const tradeStats = React.useMemo(() => {\r\n    let containWins = false;\r\n    let containLosses = false;\r\n    (trades || []).forEach((trade) => {\r\n      if (trade.trade_type === 'win') containWins = true;\r\n      else if (trade.trade_type === 'loss') containLosses = true;\r\n    });\r\n    return {\r\n      containWins,\r\n      containLosses,\r\n      containBoth: containWins && containLosses\r\n    };\r\n  }, [trades]);\r\n\r\n  React.useEffect(() => {\r\n    let isMounted = true;\r\n\r\n    const fetchChartData = async () => {\r\n      if (!trades || trades.length === 0) {\r\n        if (isMounted) setChartData(undefined);\r\n        return;\r\n      }\r\n\r\n      // If getTagDayOfWeekChartData is async, await it; otherwise, wrap in Promise.resolve\r\n      const result = await Promise.resolve(\r\n        getTagDayOfWeekChartData(trades, theme, selectedMetric === \"winRate\" && tradeStats.containBoth)\r\n      );\r\n\r\n      if (isMounted) {\r\n        // Sum all totalTrades values\r\n        const totalTradesSum = Array.isArray(result)\r\n          ? result.reduce((sum, item) => sum + (item.total_trades > 0 ? 1 : 0), 0)\r\n          : 0;\r\n        setChartData(totalTradesSum > 1 ? result : undefined);\r\n      }\r\n    };\r\n\r\n    fetchChartData();\r\n\r\n    return () => { isMounted = false; };\r\n  }, [selectedMetric, showChartInfo, trades, theme]);\r\n\r\n\r\n\r\n  // Gallery mode handler\r\n  const handleGalleryModeClick = () => {\r\n    if (onOpenGalleryMode && trades && trades.length > 0) {\r\n      onOpenGalleryMode(trades, expandedTradeId || trades[0].id,\r\n        `${title} - ${trades.length} Trade${trades.length > 1 ? 's' : ''}`);\r\n      onClose(); // Close the dialog when opening gallery mode\r\n    }\r\n  };\r\n\r\n  // Calculate total PnL from trades\r\n  const [total_pnl, setTotalPnL] = React.useState<number>(0);\r\n\r\n  React.useEffect(() => {\r\n    let isMounted = true;\r\n    const calculateTotalPnL = async () => {\r\n      // Simulate async calculation, replace with real async logic if needed\r\n      const sum = (trades || []).reduce((acc, trade) => acc + trade.amount, 0);\r\n      if (isMounted) setTotalPnL(sum);\r\n    };\r\n    calculateTotalPnL();\r\n    return () => { isMounted = false; };\r\n  }, [trades]);\r\n\r\n  const tradesLength = trades?.length || 0;\r\n  const dialogTitle = (\r\n    <>\r\n      <Typography variant=\"h6\">\r\n        {tradesLength} {tradesLength === 1 ? 'Trade' : 'Trades'}{title ? ` for ${title.toLowerCase()}` : ''}\r\n      </Typography>\r\n\r\n    </>\r\n\r\n  );\r\n\r\n  // Custom actions for the dialog\r\n  const dialogActions = onOpenGalleryMode && tradesLength > 0 ? (\r\n    <Tooltip title=\"View trades in gallery mode\">\r\n      <Button\r\n        variant=\"contained\"\r\n        size=\"large\"\r\n        startIcon={<GalleryIcon />}\r\n        onClick={handleGalleryModeClick}\r\n        sx={{\r\n          textTransform: 'none',\r\n          fontWeight: 600,\r\n          borderRadius: 1.5,\r\n          px: 3\r\n        }}\r\n      >\r\n        Gallery View\r\n      </Button>\r\n    </Tooltip>\r\n  ) : undefined;\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={onClose}\r\n      maxWidth=\"sm\"\r\n      fullWidth\r\n      title={dialogTitle}\r\n      actions={dialogActions}\r\n    >\r\n      <Box sx={{ p: 2 }}>\r\n        {/* DayHeader with navigation buttons hidden */}\r\n        <DayHeader\r\n          title={subtitle || ''}\r\n          account_balance={account_balance + cumulativePnL}\r\n          formInputVisible={true} // Set to true to hide navigation buttons\r\n          total_pnl={total_pnl}\r\n          onPrevDay={() => { }} // Empty function since we're hiding the buttons\r\n          onNextDay={() => { }} // Empty function since we're hiding the buttons\r\n        />\r\n\r\n        {chartData &&\r\n          <>\r\n            {tradeStats.containBoth &&\r\n              <Box sx={{ display: 'flex', gap: 1 }}>\r\n                <Button\r\n                  variant={selectedMetric === 'winRate' ? 'contained' : 'outlined'}\r\n                  size=\"small\"\r\n                  onClick={() => setSelectedMetric('winRate')}\r\n                  sx={{ textTransform: 'none' }}\r\n                >\r\n                  Win Rate\r\n                </Button>\r\n                <Button\r\n                  variant={selectedMetric === 'pnl' ? 'contained' : 'outlined'}\r\n                  size=\"small\"\r\n                  onClick={() => setSelectedMetric('pnl')}\r\n                  sx={{ textTransform: 'none' }}\r\n                >\r\n                  P&L\r\n                </Button>\r\n\r\n              </Box>}\r\n            {chartData.some(data => data.total_trades > 0) ? (\r\n              <Typography variant=\"body2\" color=\"primary\" sx={{ mt: 1, fontWeight: 500 }}>\r\n                {tradeStats.containBoth && selectedMetric === 'winRate'\r\n                  ? `Best day for selected strategies: ${chartData.reduce((best, day) => day.total_trades > 0 && day.win_rate > best.win_rate ? day : best, { win_rate: 0, fullDay: 'None' }).fullDay}`\r\n                  : `Most profitable/un-profitable day: ${chartData.reduce((best, day) => day.total_trades > 0 && day.pnl > best.pnl ? day : best, { pnl: -Infinity, fullDay: 'None' }).fullDay}`\r\n                }\r\n              </Typography>\r\n            ) : null}\r\n\r\n            <ResponsiveContainer width=\"100%\" height={300}>\r\n              <BarChart\r\n                data={chartData}\r\n                margin={{ top: 20, right: 30, left: 20, bottom: 5 }}\r\n                maxBarSize={50}\r\n              >\r\n                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} />\r\n                <XAxis\r\n                  dataKey=\"day\"\r\n                  axisLine={false}\r\n                  tickLine={false}\r\n                  tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n                />\r\n                <YAxis\r\n                  axisLine={false}\r\n                  tickLine={false}\r\n                  tick={{ fill: theme.palette.text.secondary, fontSize: 12 }}\r\n                  domain={tradeStats.containBoth ? [0, 100] : ['auto', 'auto']}\r\n                  tickFormatter={tradeStats.containBoth && selectedMetric === \"winRate\"\r\n                    ? (value) => `${value}%`\r\n                    : (value) => formatCurrency(value).replace('$', '')}\r\n                />\r\n\r\n                <Legend />\r\n                <RechartsTooltip content={({ active, payload, label }: any) => {\r\n                  if (active && payload && payload.length) {\r\n                    const data = payload[0].payload;\r\n                    return (\r\n                      <Paper sx={{ p: 1.5, bgcolor: 'background.paper' }}>\r\n                        <Typography variant=\"body2\" sx={{ fontWeight: 'bold' }}>\r\n                          {data.fullDay}\r\n                        </Typography>\r\n                        <Typography variant=\"body2\">\r\n                          Total Trades: {data.total_trades}\r\n                        </Typography>\r\n                        {tradeStats.containWins &&\r\n                          <Typography variant=\"body2\" sx={{ color: theme.palette.success.main }}>\r\n                            Wins: {data.winTrades}\r\n                          </Typography>\r\n                        }\r\n\r\n                        {tradeStats.containLosses &&\r\n                          <Typography variant=\"body2\" sx={{ color: theme.palette.error.main }}>\r\n                            Losses: {data.lossTrades}\r\n                          </Typography>\r\n                        }\r\n\r\n                        {tradeStats.containBoth &&\r\n                          <Typography variant=\"body2\">\r\n                            Win Rate: {data.win_rate.toFixed(1)}%\r\n                          </Typography>}\r\n\r\n                        <Typography variant=\"body2\">\r\n                          P&L: {formatCurrency(data.pnl)}\r\n                        </Typography>\r\n                      </Paper>\r\n                    );\r\n                  }\r\n                  return null;\r\n                }} />\r\n                <Bar\r\n                  dataKey=\"value\"\r\n                  name={tradeStats.containBoth && selectedMetric === \"winRate\" ? 'Win Rate' : 'P&L'}\r\n                  fill={theme.palette.primary.main}\r\n                  radius={[4, 4, 0, 0]}\r\n\r\n                  style={{ cursor: 'pointer' }}\r\n                >\r\n                  {chartData.map((entry, index) => (\r\n                    <Cell key={`cell-${index}`} fill={entry.color} />\r\n                  ))}\r\n                </Bar>\r\n              </BarChart>\r\n            </ResponsiveContainer>\r\n\r\n          </>\r\n        }\r\n\r\n        <TradeList\r\n          sx={{ mt: 0 }}\r\n          trades={trades}\r\n          expandedTradeId={expandedTradeId}\r\n          onTradeClick={onTradeExpand}\r\n          hideActions={!onEditTrade && !onDeleteTrade}\r\n          enableBulkSelection={tradesLength > 1 && !!onDeleteMultipleTrades}\r\n          tradeOperations={tradeOperations}\r\n        />\r\n      </Box>\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default TradesListDialog;\r\n","import React from 'react';\nimport {\n  AreaChart,\n  Area,\n  ResponsiveContainer\n} from 'recharts';\nimport { Box, Paper, Typography, useTheme, Tooltip } from '@mui/material';\nimport { InfoOutlined } from '@mui/icons-material';\n\ninterface RiskRewardChartProps {\n  riskRewardStats: {\n    average: number;\n    max: number;\n    data: Array<{\n      date: string;\n      rr: number;\n    }>;\n  };\n}\n\nconst RiskRewardChart: React.FC<RiskRewardChartProps> = ({ riskRewardStats }) => {\n  const theme = useTheme();\n\n  if (riskRewardStats.data.length === 0) {\n    return null;\n  }\n\n  return (\n    <Paper\n      sx={{\n        p: 2,\n        mb: 2,\n        borderRadius: 2\n      }}\n    >\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\n        <Box>\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 0.5 }}>\n            <Typography variant=\"body2\" sx={{ color: 'text.secondary' }}>\n              Average RR\n            </Typography>\n            <Tooltip\n              title=\"Average Risk to reward ratio (RR) per trade. An RR of 2 means that for every 1$ you risk you will make 2$.\"\n              arrow\n              placement=\"top\"\n            >\n              <InfoOutlined sx={{ fontSize: 16, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\n            </Tooltip>\n          </Box>\n          <Typography variant=\"h4\" sx={{ fontWeight: 500, color: 'text.primary' }}>\n            {riskRewardStats.average.toFixed(2)}\n          </Typography>\n        </Box>\n        <Box>\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 0.5 }}>\n            <Typography variant=\"body2\" sx={{ color: 'text.secondary' }}>\n              Max RR\n            </Typography>\n            <Tooltip\n              title=\"Maximum Risk to reward Ratio between all your trades. You can use the small graph at the bottom of this card to see the RR of every one of your trades.\"\n              arrow\n              placement=\"top\"\n            >\n              <InfoOutlined sx={{ fontSize: 16, color: 'text.secondary', opacity: 0.7, cursor: 'help' }} />\n            </Tooltip>\n          </Box>\n          <Typography variant=\"h4\" sx={{ fontWeight: 500, color: 'text.primary' }}>\n            {riskRewardStats.max.toFixed(2)}\n          </Typography>\n        </Box>\n      </Box>\n\n      {/* RR Trend Line Graph */}\n      <Box sx={{ height: 60, mt: 2 }}>\n        <ResponsiveContainer width=\"100%\" height=\"100%\">\n          <AreaChart data={riskRewardStats.data} margin={{ top: 0, right: 0, left: 0, bottom: 0 }}>\n            <defs>\n              <linearGradient id=\"rrGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                <stop offset=\"5%\" stopColor={theme.palette.primary.main} stopOpacity={0.3} />\n                <stop offset=\"95%\" stopColor={theme.palette.primary.main} stopOpacity={0} />\n              </linearGradient>\n            </defs>\n            <Area\n              type=\"monotone\"\n              dataKey=\"rr\"\n              stroke={theme.palette.primary.main}\n              strokeWidth={2}\n              fill=\"url(#rrGradient)\"\n              dot={false}\n            />\n          </AreaChart>\n        </ResponsiveContainer>\n      </Box>\n    </Paper>\n  );\n};\n\nexport default RiskRewardChart;\n","import React, { useState, useMemo, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  useTheme,\r\n  Card,\r\n  CardContent,\r\n  Alert,\r\n  Stack,\r\n  alpha,\r\n  LinearProgress,\r\n  FormControl,\r\n  InputLabel,\r\n  Select,\r\n  MenuItem,\r\n  SelectChangeEvent,\r\n  CircularProgress\r\n} from '@mui/material';\r\nimport {\r\n  InfoOutlined,\r\n  Analytics,\r\n  TrendingDown,\r\n  TrendingUp,\r\n  EventNote\r\n} from '@mui/icons-material';\r\nimport { Trade, TradeEconomicEvent, Calendar } from '../../types/dualWrite';\r\nimport { ImpactLevel, Currency } from '../../types/economicCalendar';\r\nimport { formatValue } from '../../utils/formatters';\r\n\r\nimport RoundedTabs from '../common/RoundedTabs';\r\nimport { getCurrenciesForPair } from '../../services/tradeEconomicEventService';\r\n\r\n// Helper function to get flag URL\r\nconst getFlagUrl = (flagCode?: string, size: string = 'w40'): string => {\r\n  if (!flagCode) return '';\r\n  return `https://flagcdn.com/${size}/${flagCode.toLowerCase()}.png`;\r\n};\r\n\r\ninterface EconomicEventCorrelationAnalysisProps {\r\n  calendarId: string; // Single calendar ID\r\n  trades: Trade[];\r\n  timePeriod: 'month' | 'year' | 'all';\r\n  selectedDate: Date;\r\n  setMultipleTradesDialog?: (dialogState: any) => void;\r\n  economicCorrelations?: any; // Pre-calculated economic correlations { high: {...}, medium: {...} }\r\n}\r\n\r\ninterface TradeEventCorrelation {\r\n  trade: Trade;\r\n  economicEvents: TradeEconomicEvent[];\r\n  hasHighImpactEvents: boolean;\r\n  hasMediumImpactEvents: boolean;\r\n  eventCount: number;\r\n}\r\n\r\ninterface EventTradeDetails {\r\n  event: string;\r\n  losingTrades: Trade[];\r\n  winningTrades: Trade[];\r\n  totalLoss: number;\r\n  totalWin: number;\r\n  avg_loss: number;\r\n  avg_win: number;\r\n  count: number;\r\n  win_rate: number;\r\n  // Economic event details\r\n  economicEventDetails?: {\r\n    country?: string;\r\n    flagCode?: string;\r\n    flagUrl?: string;\r\n  };\r\n}\r\n\r\ninterface CorrelationStats {\r\n  // Losing trades stats\r\n  totalLosingTrades: number;\r\n  losingTradesWithHighImpact: number;\r\n  losingTradesWithMediumImpact: number;\r\n  losingTradesWithAnyEvents: number;\r\n  highImpactLossCorrelationRate: number;\r\n  mediumImpactLossCorrelationRate: number;\r\n  anyEventLossCorrelationRate: number;\r\n  avgLossWithEvents: number;\r\n  avgLossWithoutEvents: number;\r\n\r\n  // Winning trades stats\r\n  totalWinningTrades: number;\r\n  winningTradesWithHighImpact: number;\r\n  winningTradesWithMediumImpact: number;\r\n  winningTradesWithAnyEvents: number;\r\n  highImpactWinCorrelationRate: number;\r\n  mediumImpactWinCorrelationRate: number;\r\n  anyEventWinCorrelationRate: number;\r\n  avgWinWithEvents: number;\r\n  avgWinWithoutEvents: number;\r\n\r\n  // Combined stats\r\n  mostCommonEventTypes: EventTradeDetails[];\r\n  impactDistribution: Record<ImpactLevel, number>;\r\n}\r\n\r\n\r\n\r\nconst EconomicEventCorrelationAnalysis: React.FC<EconomicEventCorrelationAnalysisProps> = ({\r\n  calendarId,\r\n  trades,\r\n  timePeriod,\r\n  selectedDate,\r\n  setMultipleTradesDialog,\r\n  economicCorrelations\r\n}) => {\r\n  const theme = useTheme();\r\n  const [selectedImpact, setSelectedImpact] = useState<ImpactLevel>('High');\r\n  const [selectedCurrency, setSelectedCurrency] = useState<string>('ALL');\r\n\r\n  // Async calculation states\r\n  const [losingTradeCorrelations, setLosingTradeCorrelations] = useState<any[]>([]);\r\n  const [winningTradeCorrelations, setWinningTradeCorrelations] = useState<any[]>([]);\r\n  const [correlationStats, setCorrelationStats] = useState<any>({\r\n    totalLosingTrades: 0,\r\n    totalWinningTrades: 0,\r\n    highImpactLossCorrelationRate: 0,\r\n    mediumImpactLossCorrelationRate: 0,\r\n    anyEventLossCorrelationRate: 0,\r\n    highImpactWinCorrelationRate: 0,\r\n    mediumImpactWinCorrelationRate: 0,\r\n    anyEventWinCorrelationRate: 0,\r\n    losingTradesWithHighImpact: 0,\r\n    losingTradesWithMediumImpact: 0,\r\n    losingTradesWithAnyEvents: 0,\r\n    winningTradesWithHighImpact: 0,\r\n    winningTradesWithMediumImpact: 0,\r\n    winningTradesWithAnyEvents: 0,\r\n    avgLossWithEvents: 0,\r\n    avgLossWithoutEvents: 0,\r\n    avgWinWithEvents: 0,\r\n    avgWinWithoutEvents: 0,\r\n    mostCommonEventTypes: []\r\n  });\r\n  const [isCalculating, setIsCalculating] = useState(false);\r\n\r\n  // Define tabs for impact level selection\r\n  const impactTabs = [\r\n    { label: 'High', value: 'High' },\r\n    { label: 'Medium', value: 'Medium' },\r\n  ];\r\n\r\n    \r\n// Currency options for filtering - using same currencies as calendar settings \r\nconst CURRENCIES = useMemo(() => {\r\n  const currencyTags = trades\r\n    .map(trade => trade.tags)\r\n    .flat()\r\n    .filter(tag => tag?.includes('pair:'))\r\n    .map(tag => tag?.split(':')[1])\r\n    .filter((pair): pair is string => pair !== undefined).map(pair => getCurrenciesForPair(pair)).flat();\r\n  \r\n  return Array.from(new Set(currencyTags));\r\n}, [trades]);\r\n\r\nconst CURRENCY_OPTIONS = [\r\n  { value: 'ALL', label: 'All Currencies' },\r\n  ...CURRENCIES.map(currency => ({ value: currency, label: currency }))\r\n];\r\n\r\n  // Convert string value to tab index for RoundedTabs\r\n  const getImpactTabIndex = (currentImpact: ImpactLevel): number => {\r\n    return impactTabs.findIndex(tab => tab.value === currentImpact);\r\n  };\r\n\r\n  // Handle tab change for impact level\r\n  const handleImpactTabChange = (_: React.SyntheticEvent, newIndex: number) => {\r\n    const newImpact = impactTabs[newIndex]?.value as ImpactLevel;\r\n    if (newImpact) {\r\n      setSelectedImpact(newImpact);\r\n    }\r\n  };\r\n\r\n  // Use pre-calculated economic correlations from server (instant switching between impact levels!)\r\n  useEffect(() => {\r\n    if (!economicCorrelations) {\r\n      setLosingTradeCorrelations([]);\r\n      setWinningTradeCorrelations([]);\r\n      setCorrelationStats({});\r\n      return;\r\n    }\r\n\r\n    // Select data based on impact level (High or Medium)\r\n    const impactData = selectedImpact === 'High'\r\n      ? economicCorrelations.high\r\n      : economicCorrelations.medium;\r\n\r\n    if (!impactData) {\r\n      setLosingTradeCorrelations([]);\r\n      setWinningTradeCorrelations([]);\r\n      setCorrelationStats({});\r\n      return;\r\n    }\r\n\r\n    // Filter by currency if needed (client-side filtering of pre-calculated data)\r\n    const filterByCurrency = (correlations: any[]) => {\r\n      if (selectedCurrency === 'ALL') return correlations;\r\n\r\n      return correlations\r\n        .map(correlation => ({\r\n          ...correlation,\r\n          economic_events: correlation.economic_events?.filter(\r\n            (event: any) => event.currency === selectedCurrency\r\n          ) || []\r\n        }))\r\n        .filter(correlation => correlation.economic_events.length > 0);\r\n    };\r\n\r\n    setLosingTradeCorrelations(filterByCurrency(impactData.losingTradeCorrelations || []));\r\n    setWinningTradeCorrelations(filterByCurrency(impactData.winningTradeCorrelations || []));\r\n    setCorrelationStats(impactData.correlationStats || {});\r\n  }, [economicCorrelations, selectedImpact, selectedCurrency]);\r\n\r\n  // Get losing and winning trades (kept for legacy compatibility)\r\n  const losingTrades = useMemo(() => {\r\n    return trades.filter(trade => trade.trade_type === 'loss');\r\n  }, [trades]);\r\n\r\n  const winningTrades = useMemo(() => {\r\n    return trades.filter(trade => trade.trade_type === 'win');\r\n  }, [trades]);\r\n\r\n\r\n\r\n\r\n\r\n  // Note: Heavy calculations moved to async service\r\n\r\n  // Note: Correlation statistics now calculated asynchronously in service\r\n\r\n\r\n\r\n\r\n\r\n  if (losingTrades.length === 0 && winningTrades.length === 0) {\r\n    return (\r\n      <Paper sx={{ p: 3, mb: 3 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>\r\n          <Analytics sx={{ mr: 1, color: theme.palette.primary.main }} />\r\n          <Typography variant=\"h6\">Economic Event Correlation Analysis</Typography>\r\n        </Box>\r\n        <Typography variant=\"body2\" color=\"text.secondary\">\r\n          No trades found for the selected period.\r\n        </Typography>\r\n      </Paper>\r\n    );\r\n  }\r\n\r\n  const handleCurrencyChange = (event: SelectChangeEvent<string>) => {\r\n    setSelectedCurrency(event.target.value);\r\n  };\r\n\r\n  return (\r\n    <Paper sx={{ mb: 3 }}>\r\n      <Box sx={{ p: 3 }}>\r\n        <Stack direction=\"row\" alignItems=\"center\" justifyContent=\"space-between\" sx={{ mb: 2, gap: 2 }}>\r\n          <Stack direction=\"row\" alignItems=\"center\" spacing={2} sx={{ flex: 1 }}>\r\n            <Typography\r\n              variant=\"h6\"\r\n              sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n               \r\n                gap: 1,\r\n                color: theme.palette.text.primary,\r\n                fontWeight: 600\r\n              }}\r\n            >\r\n              <Analytics sx={{ color: theme.palette.primary.main }} />\r\n              Economic Event Correlation Analysis\r\n            </Typography>\r\n\r\n          </Stack>\r\n\r\n          \r\n            <RoundedTabs\r\n              tabs={impactTabs}\r\n              activeTab={getImpactTabIndex(selectedImpact)}\r\n              onTabChange={handleImpactTabChange}\r\n              size=\"small\"\r\n            />\r\n\r\n          <FormControl size=\"small\" sx={{ minWidth: 120 }}>\r\n            <InputLabel>Currency</InputLabel>\r\n            <Select\r\n              value={selectedCurrency}\r\n              onChange={handleCurrencyChange}\r\n              label=\"Currency\"\r\n            >\r\n              {CURRENCY_OPTIONS.map((option) => (\r\n                <MenuItem key={option.value} value={option.value}>\r\n                  {option.label}\r\n                </MenuItem>\r\n              ))}\r\n            </Select>\r\n          </FormControl>\r\n        </Stack>\r\n\r\n        <Alert\r\n          severity=\"info\"\r\n          sx={{\r\n            mb: 2,\r\n            backgroundColor: alpha(theme.palette.info.main, 0.1),\r\n            '& .MuiAlert-icon': {\r\n              color: theme.palette.info.main\r\n            }\r\n          }}\r\n        >\r\n          This analysis correlates your trades with economic events that occurred during the same trading sessions to help identify patterns.\r\n          {selectedCurrency !== 'ALL' && (\r\n            <> Currently filtering events for <strong>{selectedCurrency}</strong> currency.</>\r\n          )}\r\n        </Alert>\r\n\r\n        {/* Loading State */}\r\n        {isCalculating && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            py: 4,\r\n            gap: 2\r\n          }}>\r\n            <CircularProgress size={40} />\r\n            <Typography variant=\"body2\" color=\"text.secondary\">\r\n              Calculating economic event correlations...\r\n            </Typography>\r\n          </Box>\r\n        )}\r\n\r\n        {/* Summary Statistics - Losing Trades */}\r\n        {!isCalculating && (\r\n          <>\r\n            <Typography variant=\"h6\" sx={{ mb: 2, color: 'error.main' }}>\r\n              Losing Trades - {selectedImpact} Impact Events\r\n            </Typography>\r\n      <Box sx={{\r\n        display: 'grid',\r\n        gridTemplateColumns: {\r\n          xs: '1fr',\r\n          sm: 'repeat(2, 1fr)'\r\n        },\r\n        gap: 2,\r\n        mb: 3\r\n      }}>\r\n        <Card sx={{ bgcolor: alpha(theme.palette.error.main, 0.1) }}>\r\n          <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>\r\n              <TrendingDown sx={{ color: theme.palette.error.main, mr: 1 }} />\r\n              <Typography variant=\"body2\" color=\"text.secondary\">Total Losing Trades</Typography>\r\n            </Box>\r\n            <Typography variant=\"h4\" color=\"error.main\">\r\n              {correlationStats.totalLosingTrades || 0}\r\n            </Typography>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card sx={{\r\n          bgcolor: alpha(\r\n            selectedImpact === 'High' ? theme.palette.error.main :\r\n            selectedImpact === 'Medium' ? theme.palette.warning.main :\r\n            selectedImpact === 'Low' ? theme.palette.success.main :\r\n            theme.palette.secondary.main, // Holiday\r\n            0.1\r\n          )\r\n        }}>\r\n          <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>\r\n              <EventNote sx={{\r\n                color: selectedImpact === 'High' ? theme.palette.error.main :\r\n                       selectedImpact === 'Medium' ? theme.palette.warning.main :\r\n                       selectedImpact === 'Low' ? theme.palette.success.main :\r\n                       theme.palette.secondary.main, // Holiday\r\n                mr: 1\r\n              }} />\r\n              <Typography variant=\"body2\" color=\"text.secondary\">{selectedImpact} Impact Events</Typography>\r\n            </Box>\r\n            <Typography variant=\"h4\" sx={{\r\n              color: selectedImpact === 'High' ? 'error.main' :\r\n                     selectedImpact === 'Medium' ? 'warning.main' :\r\n                     selectedImpact === 'Low' ? 'success.main' :\r\n                     'secondary.main' // Holiday\r\n            }}>\r\n              {(correlationStats.anyEventLossCorrelationRate || 0).toFixed(1)}%\r\n            </Typography>\r\n            <Typography variant=\"caption\" color=\"text.secondary\">\r\n              {correlationStats.losingTradesWithEvents || 0} trades\r\n            </Typography>\r\n          </CardContent>\r\n        </Card>\r\n      </Box>\r\n\r\n      {/* Summary Statistics - Winning Trades */}\r\n      <Typography variant=\"h6\" sx={{ mb: 2, color: 'success.main' }}>\r\n      Winning Trades - {selectedImpact} Impact Events\r\n      </Typography>\r\n      <Box sx={{\r\n        display: 'grid',\r\n        gridTemplateColumns: {\r\n          xs: '1fr',\r\n          sm: 'repeat(2, 1fr)'\r\n        },\r\n        gap: 2,\r\n        mb: 2\r\n      }}>\r\n        <Card sx={{ bgcolor: alpha(theme.palette.success.main, 0.1) }}>\r\n          <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>\r\n              <TrendingUp sx={{ color: theme.palette.success.main, mr: 1 }} />\r\n              <Typography variant=\"body2\" color=\"text.secondary\">Total Winning Trades</Typography>\r\n            </Box>\r\n            <Typography variant=\"h4\" color=\"success.main\">\r\n              {correlationStats.totalWinningTrades || 0}\r\n            </Typography>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card sx={{\r\n          bgcolor: alpha(\r\n            selectedImpact === 'High' ? theme.palette.error.main :\r\n            selectedImpact === 'Medium' ? theme.palette.warning.main :\r\n            selectedImpact === 'Low' ? theme.palette.success.main :\r\n            theme.palette.secondary.main, // Holiday\r\n            0.1\r\n          )\r\n        }}>\r\n          <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', mb: 1 }}>\r\n              <EventNote sx={{\r\n                color: selectedImpact === 'High' ? theme.palette.error.main :\r\n                       selectedImpact === 'Medium' ? theme.palette.warning.main :\r\n                       selectedImpact === 'Low' ? theme.palette.success.main :\r\n                       theme.palette.secondary.main, // Holiday\r\n                mr: 1\r\n              }} />\r\n              <Typography variant=\"body2\" color=\"text.secondary\">{selectedImpact} Impact Events</Typography>\r\n            </Box>\r\n            <Typography variant=\"h4\" sx={{\r\n              color: selectedImpact === 'High' ? 'error.main' :\r\n                     selectedImpact === 'Medium' ? 'warning.main' :\r\n                     selectedImpact === 'Low' ? 'success.main' :\r\n                     'secondary.main' // Holiday\r\n            }}>\r\n              {(correlationStats.anyEventWinCorrelationRate || 0).toFixed(1)}%\r\n            </Typography>\r\n            <Typography variant=\"caption\" color=\"text.secondary\">\r\n              {correlationStats.winningTradesWithEvents || 0} trades\r\n            </Typography>\r\n          </CardContent>\r\n        </Card>\r\n      </Box>\r\n\r\n\r\n\r\n        <Box sx={{\r\n          display: 'grid',\r\n          gridTemplateColumns: { xs: '1fr', md: 'repeat(2, 1fr)' },\r\n          gap: 2,\r\n          mb: 2\r\n        }}>\r\n          {/* Average Loss Comparison */}\r\n          <Card>\r\n            <CardContent>\r\n              <Typography variant=\"h6\" sx={{ mb: 2 }}>Average Loss Comparison</Typography>\r\n              <Stack spacing={2}>\r\n                <Box>\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\r\n                    <Typography variant=\"body2\">With Economic Events</Typography>\r\n                    <Typography variant=\"body2\" color=\"error.main\">\r\n                      {formatValue(correlationStats.avgLossWithEvents || 0)}\r\n                    </Typography>\r\n                  </Box>\r\n                  <LinearProgress\r\n                    variant=\"determinate\"\r\n                    value={(correlationStats.avgLossWithEvents || 0) > 0 ? 100 : 0}\r\n                    color=\"error\"\r\n                  />\r\n                </Box>\r\n                <Box>\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\r\n                    <Typography variant=\"body2\">Without Economic Events</Typography>\r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      {formatValue(correlationStats.avgLossWithoutEvents || 0)}\r\n                    </Typography>\r\n                  </Box>\r\n                  <LinearProgress\r\n                    variant=\"determinate\"\r\n                    value={(correlationStats.avgLossWithoutEvents || 0) > 0 ?\r\n                      ((correlationStats.avgLossWithoutEvents || 0) / Math.max((correlationStats.avgLossWithEvents || 0), (correlationStats.avgLossWithoutEvents || 0))) * 100 : 0}\r\n                    color=\"inherit\"\r\n                  />\r\n                </Box>\r\n              </Stack>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Average Win Comparison */}\r\n          <Card>\r\n            <CardContent>\r\n              <Typography variant=\"h6\" sx={{ mb: 2 }}>Average Win Comparison</Typography>\r\n              <Stack spacing={2}>\r\n                <Box>\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\r\n                    <Typography variant=\"body2\">With Economic Events</Typography>\r\n                    <Typography variant=\"body2\" color=\"success.main\">\r\n                      {formatValue(correlationStats.avgWinWithEvents || 0)}\r\n                    </Typography>\r\n                  </Box>\r\n                  <LinearProgress\r\n                    variant=\"determinate\"\r\n                    value={(correlationStats.avgWinWithEvents || 0) > 0 ? 100 : 0}\r\n                    color=\"success\"\r\n                  />\r\n                </Box>\r\n                <Box>\r\n                  <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>\r\n                    <Typography variant=\"body2\">Without Economic Events</Typography>\r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      {formatValue(correlationStats.avgWinWithoutEvents || 0)}\r\n                    </Typography>\r\n                  </Box>\r\n                  <LinearProgress\r\n                    variant=\"determinate\"\r\n                    value={(correlationStats.avgWinWithoutEvents || 0) > 0 ?\r\n                      ((correlationStats.avgWinWithoutEvents || 0) / Math.max((correlationStats.avgWinWithEvents || 0), (correlationStats.avgWinWithoutEvents || 0))) * 100 : 0}\r\n                    color=\"inherit\"\r\n                  />\r\n                </Box>\r\n              </Stack>\r\n            </CardContent>\r\n          </Card>\r\n        </Box>\r\n\r\n        {/* Most Common Event Types */}\r\n        <Card>\r\n          <CardContent>\r\n            <Typography variant=\"h6\" sx={{ mb: 2 }}>Most Common Event Types</Typography>\r\n            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 2 }}>\r\n                {(correlationStats.mostCommonEventTypes || []).map((eventType: any, index: number) => (\r\n                <Card\r\n                  key={index}\r\n                  variant=\"outlined\"\r\n                  sx={{\r\n                    flex: '1 1 300px', // Grow, shrink, with 300px minimum width\r\n                    minWidth: 300,\r\n                    maxWidth: 400\r\n                  }}\r\n                >\r\n                  <CardContent sx={{ p: 1.5, '&:last-child': { pb: 1.5 } }}>\r\n                    <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>\r\n                      <Box sx={{ flex: 1 }}>\r\n                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>\r\n                          {eventType.economicEventDetails?.flagCode && (\r\n                            <Box\r\n                              component=\"img\"\r\n                              src={getFlagUrl(eventType.economicEventDetails.flagCode)}\r\n                              alt={eventType.economicEventDetails.flagCode || 'flag'}\r\n                              sx={{\r\n                                width: 20,\r\n                                height: 15,\r\n                                borderRadius: 0.5,\r\n                                objectFit: 'cover'\r\n                              }}\r\n                              onError={(e) => {\r\n                                // Hide image if it fails to load\r\n                                (e.target as HTMLElement).style.display = 'none';\r\n                              }}\r\n                            />\r\n                          )}\r\n                          <Typography variant=\"body2\" sx={{ fontWeight: 500, lineHeight: 1.2 }}>\r\n                            {eventType.event}\r\n                          </Typography>\r\n                        </Box>\r\n\r\n                        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ fontSize: '0.75rem' }}>\r\n                          {eventType.count || 0} trades  {(eventType.win_rate || 0).toFixed(1)}% win rate\r\n                        </Typography>\r\n                      </Box>\r\n                      \r\n                    </Box>\r\n\r\n                    <Box sx={{ display: 'flex', gap: 1.5, alignItems: 'center' }}>\r\n                      {/* Clickable Losing Trades Section */}\r\n                      <Box\r\n                        sx={{\r\n                          display: 'flex',\r\n                          alignItems: 'center',\r\n                          gap: 0.5,\r\n                          cursor: setMultipleTradesDialog && (eventType.losingTrades || []).length > 0 ? 'pointer' : 'default',\r\n                          p: 0.5,\r\n                          borderRadius: 1,\r\n                          '&:hover': setMultipleTradesDialog && (eventType.losingTrades || []).length > 0 ? {\r\n                            bgcolor: alpha(theme.palette.error.main, 0.08)\r\n                          } : {}\r\n                        }}\r\n                        onClick={(e) => {\r\n                          e.stopPropagation();\r\n                          if (setMultipleTradesDialog && (eventType.losingTrades || []).length > 0) {\r\n                            setMultipleTradesDialog({\r\n                              open: true,\r\n                              trades: eventType.losingTrades || [],\r\n                              title: `Losing trades during \"${eventType.event}\" events`,\r\n                              subtitle: `${(eventType.losingTrades || []).length} losing trades  Avg loss: ${formatValue(eventType.avg_loss)}`\r\n                            });\r\n                          }\r\n                        }}\r\n                      >\r\n                        <Typography variant=\"body2\" sx={{ fontWeight: 600, color: 'error.main' }}>\r\n                          {(eventType.losingTrades || []).length}\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ fontSize: '0.7rem' }}>\r\n                          losses\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"error.main\" sx={{ fontSize: '0.7rem' }}>\r\n                          ({formatValue(eventType.avg_loss)})\r\n                        </Typography>\r\n                      </Box>\r\n\r\n                      <Box sx={{ width: '1px', height: '16px', bgcolor: 'divider' }} />\r\n\r\n                      {/* Clickable Winning Trades Section */}\r\n                      <Box\r\n                        sx={{\r\n                          display: 'flex',\r\n                          alignItems: 'center',\r\n                          gap: 0.5,\r\n                          cursor: setMultipleTradesDialog && (eventType.winningTrades || []).length > 0 ? 'pointer' : 'default',\r\n                          p: 0.5,\r\n                          borderRadius: 1,\r\n                          '&:hover': setMultipleTradesDialog && (eventType.winningTrades || []).length > 0 ? {\r\n                            bgcolor: alpha(theme.palette.success.main, 0.08)\r\n                          } : {}\r\n                        }}\r\n                        onClick={(e) => {\r\n                          e.stopPropagation();\r\n                          if (setMultipleTradesDialog && (eventType.winningTrades || []).length > 0) {\r\n                            setMultipleTradesDialog({\r\n                              open: true,\r\n                              trades: eventType.winningTrades || [],\r\n                              title: `Winning trades during \"${eventType.event}\" events`,\r\n                              subtitle: `${(eventType.winningTrades || []).length} winning trades  Avg win: ${formatValue(eventType.avg_win)}`\r\n                            });\r\n                          }\r\n                        }}\r\n                      >\r\n                        <Typography variant=\"body2\" sx={{ fontWeight: 600, color: 'success.main' }}>\r\n                          {(eventType.winningTrades || []).length}\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ fontSize: '0.7rem' }}>\r\n                          wins\r\n                        </Typography>\r\n                        <Typography variant=\"caption\" color=\"success.main\" sx={{ fontSize: '0.7rem' }}>\r\n                          ({formatValue(eventType.avg_win)})\r\n                        </Typography>\r\n                      </Box>\r\n                    </Box>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n                {(correlationStats.mostCommonEventTypes || []).length === 0 && (\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    No common event types found\r\n                  </Typography>\r\n                )}\r\n              </Box>\r\n          </CardContent>\r\n        </Card>\r\n          </>\r\n        )}\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default EconomicEventCorrelationAnalysis;\r\n","import React, { useMemo, useState, useEffect, useCallback, useRef } from 'react';\r\nimport { format } from 'date-fns';\r\nimport { Box, Typography, useTheme, useMediaQuery, Paper, Alert, Button } from '@mui/material';\r\nimport { Trade, Calendar } from '../types/dualWrite';\r\nimport ImageZoomDialog, { ImageZoomProp } from './ImageZoomDialog';\r\nimport { DynamicRiskSettings } from '../utils/dynamicRiskUtils';\r\nimport ScoreSection from './scoring/ScoreSection';\r\nimport RoundedTabs from './common/RoundedTabs';\r\nimport { logger } from '../utils/logger';\r\nimport { getFilteredTrades, getNormalizedDate } from '../utils/chartDataUtils';\r\nimport {\r\n  PerformanceCalculationResult\r\n} from '../services/performanceCalculationService';\r\nimport ShimmerChartLoader from './common/ShimmerChartLoader';\r\nimport { supabase } from '../config/supabase';\r\nimport { EconomicCalendarFilterSettings, DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS } from './economicCalendar/EconomicCalendarDrawer';\r\nimport { TradeOperationsProps } from '../types/tradeOperations';\r\nimport PnLChartsWrapper from './charts/PnLChartsWrapper';\r\nimport WinLossDistribution from './charts/WinLossDistribution';\r\nimport WinLossStats from './charts/WinLossStats';\r\nimport TagPerformanceAnalysis from './charts/TagPerformanceAnalysis';\r\nimport TagDayOfWeekAnalysis from './charts/TagDayOfWeekAnalysis';\r\nimport DailySummaryTable from './charts/DailySummaryTable';\r\nimport SessionPerformanceAnalysis from './charts/SessionPerformanceAnalysis';\r\nimport TradesListDialog from './charts/TradesListDialog';\r\nimport RiskRewardChart from './charts/RiskRewardChart';\r\nimport EconomicEventCorrelationAnalysis from './charts/EconomicEventCorrelationAnalysis';\r\nimport { useTradeSyncContextOptional } from '../contexts/TradeSyncContext';\r\nimport { normalizeTradeDates } from '../utils/tradeUtils';\r\n\r\n// Type definition needed for module-level constants\r\nexport type TimePeriod = 'month' | 'year' | 'all';\r\n\r\n// Module-level static arrays to prevent recreation on every render\r\nexport const TIME_PERIOD_TABS = [\r\n  { label: 'Month', value: 'month' as TimePeriod },\r\n  { label: 'Year', value: 'year' as TimePeriod },\r\n  { label: 'All Time', value: 'all' as TimePeriod }\r\n];\r\n\r\nconst TAG_ANALYSIS_TABS = [\r\n  { label: 'Tag Performance' },\r\n  { label: 'Day of Week' }\r\n];\r\n\r\nconst PERFORMANCE_TABS = [\r\n  { label: 'Basic', value: 'basic' as const },\r\n  { label: 'Advanced', value: 'advanced' as const }\r\n];\r\n\r\ninterface PerformanceChartsProps {\r\n  selectedDate?: Date;\r\n  monthlyTarget?: number;\r\n  accountBalance?: number;\r\n  maxDailyDrawdown?: number;\r\n  tabSize?: 'large' | 'small';\r\n  calendarId: string;\r\n  scoreSettings?: import('../types/score').ScoreSettings;\r\n  timePeriod?: TimePeriod;\r\n  onTimePeriodChange?: (period: TimePeriod) => void;\r\n  hideTimePeriodTabs?: boolean;\r\n  onPrimaryTagsChange?: (tags: string[]) => void;\r\n  onSecondaryTagsChange?: (tags: string[]) => void;\r\n  onEditTrade?: (trade: Trade) => void;\r\n  onDeleteTrade?: (tradeId: string) => void;\r\n  onUpdateTradeProperty?: (tradeId: string, updateCallback: (trade: Trade) => Trade) => Promise<Trade | undefined>;\r\n  onUpdateCalendarProperty?: (calendarId: string, updateCallback: (calendar: Calendar) => Calendar) => Promise<Calendar | undefined>;\r\n  economicFilter?: (calendarId: string) => EconomicCalendarFilterSettings;\r\n  dynamicRiskSettings?: DynamicRiskSettings;\r\n  onOpenGalleryMode?: (trades: Trade[], initialTradeId?: string, title?: string) => void;\r\n  calendar?: Calendar;\r\n  isReadOnly?: boolean;\r\n}\r\n\r\nconst PerformanceCharts: React.FC<PerformanceChartsProps> = ({\r\n  selectedDate: selectedDateProp,\r\n  monthlyTarget: monthlyTargetProp,\r\n  accountBalance: accountBalanceProp,\r\n  maxDailyDrawdown: maxDailyDrawdownProp,\r\n  calendarId,\r\n  scoreSettings: scoreSettingsProp,\r\n  tabSize,\r\n  timePeriod: timePeriodProp,\r\n  onTimePeriodChange,\r\n  hideTimePeriodTabs = false,\r\n  onPrimaryTagsChange = () => { },\r\n  onSecondaryTagsChange = () => { },\r\n  onEditTrade,\r\n  onDeleteTrade,\r\n  onUpdateTradeProperty,\r\n  onUpdateCalendarProperty,\r\n  dynamicRiskSettings: dynamicRiskSettingsProp,\r\n  onOpenGalleryMode,\r\n  economicFilter,\r\n  calendar,\r\n  isReadOnly = false\r\n}) => {\r\n  const theme = useTheme();\r\n  const isXs = useMediaQuery(theme.breakpoints.down('sm'));\r\n  const chartHeights = useMemo(() => ({\r\n    large: isXs ? 240 : 400,\r\n    medium: isXs ? 180 : 260,\r\n    pair: isXs ? 280 : 500\r\n  }), [isXs]);\r\n\r\n  // Subscribe to trade sync context for updates from other components\r\n  const tradeSync = useTradeSyncContextOptional();\r\n  const lastProcessedTimestamp = useRef<number>(0);\r\n\r\n  // Support both controlled and uncontrolled time period\r\n  const [internalTimePeriod, setInternalTimePeriod] = useState<TimePeriod>('month');\r\n  const timePeriod = timePeriodProp ?? internalTimePeriod;\r\n  const setTimePeriod = useCallback((period: TimePeriod) => {\r\n    if (timePeriodProp === undefined) {\r\n      setInternalTimePeriod(period);\r\n    }\r\n    onTimePeriodChange?.(period);\r\n  }, [timePeriodProp, onTimePeriodChange]);\r\n  const [performanceTab, setPerformanceTab] = useState<'basic' | 'advanced'>('basic');\r\n  const [advancedTabVisited, setAdvancedTabVisited] = useState(false);\r\n  const [tagAnalysisTab, setTagAnalysisTab] = useState<number>(0);\r\n  const [primaryTags, setPrimaryTags] = useState<string[]>([]);\r\n  const [secondaryTags, setSecondaryTags] = useState<string[]>([]);\r\n  const [internalTrades, setInternalTrades] = useState<Trade[]>([]);\r\n  const [isLoadingData, setIsLoadingData] = useState(false);\r\n\r\n  // Use internal trades\r\n  const trades = internalTrades;\r\n\r\n  // Create a stable selectedDate\r\n  const [defaultDate] = useState(() => new Date());\r\n  const selectedDate = useMemo(() => selectedDateProp || defaultDate, [selectedDateProp, defaultDate]);\r\n\r\n\r\n  // Use props or calendar values\r\n  const accountBalance = accountBalanceProp ?? calendar?.account_balance ?? 0;\r\n  const maxDailyDrawdown = maxDailyDrawdownProp ?? calendar?.max_daily_drawdown ?? 0;\r\n  const monthlyTarget = monthlyTargetProp ?? calendar?.monthly_target;\r\n  const scoreSettings = scoreSettingsProp ?? calendar?.score_settings;\r\n  const dynamicRiskSettings = dynamicRiskSettingsProp ?? (calendar ? {\r\n    account_balance: calendar.account_balance,\r\n    risk_per_trade: calendar.risk_per_trade,\r\n    dynamic_risk_enabled: calendar.dynamic_risk_enabled,\r\n    increased_risk_percentage: calendar.increased_risk_percentage,\r\n    profit_threshold_percentage: calendar.profit_threshold_percentage\r\n  } : undefined);\r\n\r\n  // Economic filter function\r\n  const economicFilterFn = economicFilter || (() => calendar?.economic_calendar_filters || DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS);\r\n\r\n  // Track advanced tab visits for lazy rendering\r\n  useEffect(() => {\r\n    if (performanceTab === 'advanced') {\r\n      setAdvancedTabVisited(true);\r\n    }\r\n  }, [performanceTab]);\r\n\r\n  const [tradesDialog, setTradesDialog] = useState<{\r\n    open: boolean;\r\n    trades: Trade[];\r\n    showChartInfo?: boolean,\r\n    title: string,\r\n    subtitle?: string,\r\n    expandedTradeId: string | null;\r\n  }>({\r\n    open: false,\r\n    trades: [],\r\n    showChartInfo: true,\r\n    title: '',\r\n    subtitle: '',\r\n    expandedTradeId: null\r\n  });\r\n\r\n  // Create stable trade IDs string for dependency tracking\r\n  const tradeIdsString = useMemo(() => trades.map(t => t.id).join(','), [trades.map(t => t.id).join(',')]);\r\n\r\n  // Keep multipleTradesDialog.trades in sync with the main trades array\r\n  // Only run when trades array changes (by ID), not when dialog trades change\r\n  useEffect(() => {\r\n    if (tradesDialog.open && tradesDialog.trades && tradesDialog.trades.length > 0) {\r\n      // Create a Map for O(1) lookup instead of O(n) with .find()\r\n      const tradesMap = new Map(trades.map(t => [t.id, t]));\r\n\r\n      // Filter out deleted trades and update remaining ones\r\n      const updatedDialogTrades = tradesDialog.trades\r\n        .filter(dialogTrade => tradesMap.has(dialogTrade.id))\r\n        .map(dialogTrade => tradesMap.get(dialogTrade.id)!);\r\n\r\n      // If all trades were deleted, close the dialog\r\n      if (updatedDialogTrades.length === 0) {\r\n        setTradesDialog(prev => ({\r\n          ...prev,\r\n          open: false\r\n        }));\r\n        return;\r\n      }\r\n\r\n      // Only update if the number of trades changed or IDs changed\r\n      const dialogTradeIds = tradesDialog.trades.map(t => t.id).join(',');\r\n      const updatedTradeIds = updatedDialogTrades.map(t => t.id).join(',');\r\n\r\n      if (dialogTradeIds !== updatedTradeIds) {\r\n        setTradesDialog(prev => ({\r\n          ...prev,\r\n          trades: updatedDialogTrades\r\n        }));\r\n      }\r\n    }\r\n  }, [tradeIdsString, tradesDialog.open]);\r\n\r\n\r\n\r\n  const [zoomedImages, setZoomedImages] = useState<ImageZoomProp | null>(null);\r\n  const [chartData, setChartData] = useState<any[]>([]);\r\n  const [performanceData, setPerformanceData] = useState<PerformanceCalculationResult | null>(null);\r\n  const [economicCorrelations, setEconomicCorrelations] = useState<any>(null);\r\n  const [calculationError, setCalculationError] = useState<string | null>(null);\r\n\r\n  // Consolidated data loading - fetch trades and calculate all metrics\r\n  useEffect(() => {\r\n    if (!calendarId) {\r\n      logger.warn('PerformanceCharts - No calendar ID provided');\r\n      setInternalTrades([]);\r\n      setChartData([]);\r\n      setPerformanceData(null);\r\n      setIsLoadingData(false);\r\n      return;\r\n    }\r\n\r\n    const loadAllData = async () => {\r\n      setIsLoadingData(true);\r\n      setCalculationError(null);\r\n\r\n      try {\r\n        // 1. Fetch chart data AND trades in single RPC call\r\n        const dateAtNoonUTC = getNormalizedDate(selectedDate);\r\n        const { data: rpcResult, error: chartError } = await supabase.rpc('calculate_chart_data', {\r\n          p_calendar_id: calendarId,\r\n          p_time_period: timePeriod,\r\n          p_selected_date: dateAtNoonUTC.toISOString()\r\n        });\r\n\r\n        if (chartError) {\r\n          logger.error('Error calling calculate_chart_data RPC:', chartError);\r\n          throw chartError;\r\n        }\r\n\r\n        // Extract ALL pre-calculated data from comprehensive RPC result\r\n        // Transform trades to restore Date objects (RPC returns ISO strings)\r\n        const fetchedTrades = (rpcResult?.trades || []).map((trade: any) => ({\r\n          ...trade,\r\n          trade_date: trade.trade_date ? new Date(trade.trade_date) : trade.trade_date,\r\n          created_at: trade.created_at ? new Date(trade.created_at) : trade.created_at,\r\n          updated_at: trade.updated_at ? new Date(trade.updated_at) : trade.updated_at\r\n        }));\r\n        const chartRpcData = rpcResult?.chartData || [];\r\n        const economicCorrelations = rpcResult?.economicCorrelations || { high: null, medium: null };\r\n        const performanceMetrics = rpcResult?.performanceMetrics || {\r\n          winLossStats: {},\r\n          tagStats: [],\r\n          dailySummaryData: [],\r\n          riskRewardStats: { average: 0, max: 0, data: [] },\r\n          sessionStats: [],\r\n          allTags: [],\r\n          winLossData: []\r\n        };\r\n\r\n        setInternalTrades(fetchedTrades);\r\n\r\n        // Pre-process trades by date for O(1) lookup (used for chart interactivity)\r\n        const tradesByDate = new Map<string, Trade[]>();\r\n        fetchedTrades.forEach((trade: Trade) => {\r\n          const dateKey = new Date(trade.trade_date).toDateString();\r\n          if (!tradesByDate.has(dateKey)) {\r\n            tradesByDate.set(dateKey, []);\r\n          }\r\n          tradesByDate.get(dateKey)!.push(trade);\r\n        });\r\n\r\n        // Transform chart data (lightweight client-side formatting only)\r\n        const transformedChartData = (chartRpcData || []).map((item: any, index: number, array: any[]) => {\r\n          const prevCumulativePnl = index > 0 ? array[index - 1].cumulativePnl : 0;\r\n          const dailyChange = item.cumulativePnl - prevCumulativePnl;\r\n          const itemDate = new Date(item.date);\r\n          const dateKey = itemDate.toDateString();\r\n\r\n          return {\r\n            date: format(itemDate, timePeriod === 'month' ? 'MM/dd' : 'MM/dd/yyyy'),\r\n            pnl: item.pnl,\r\n            cumulativePnL: item.cumulativePnl,\r\n            isIncreasing: item.cumulativePnl > prevCumulativePnl,\r\n            isDecreasing: item.cumulativePnl < prevCumulativePnl,\r\n            dailyChange: dailyChange,\r\n            isWin: item.pnl > 0,\r\n            isLoss: item.pnl < 0,\r\n            isBreakEven: item.pnl === 0,\r\n            trades: tradesByDate.get(dateKey) || [],\r\n            fullDate: itemDate\r\n          };\r\n        });\r\n        setChartData(transformedChartData);\r\n\r\n        // Use pre-calculated performance metrics from server (no client-side calculation!)\r\n        setPerformanceData(performanceMetrics);\r\n\r\n        // Store pre-calculated economic correlations (both High and Medium impact)\r\n        setEconomicCorrelations(economicCorrelations);\r\n\r\n      } catch (error) {\r\n        logger.error('Error loading data:', error);\r\n        setCalculationError(error instanceof Error ? error.message : 'Failed to load data');\r\n        setInternalTrades([]);\r\n        setChartData([]);\r\n        setPerformanceData(null);\r\n        setEconomicCorrelations(null);\r\n      } finally {\r\n        setIsLoadingData(false);\r\n      }\r\n    };\r\n\r\n    loadAllData();\r\n  }, [calendarId, selectedDate, timePeriod, accountBalance]);\r\n\r\n  // Handle trade sync events from other components (e.g., useCalendarTrades)\r\n  useEffect(() => {\r\n    if (!tradeSync?.lastSyncEvent) return;\r\n\r\n    const { type, trade, timestamp } = tradeSync.lastSyncEvent;\r\n\r\n    // Avoid processing the same event twice\r\n    if (timestamp <= lastProcessedTimestamp.current) return;\r\n    lastProcessedTimestamp.current = timestamp;\r\n\r\n    // Only process events for trades in our calendar\r\n    if (trade.calendar_id !== calendarId) return;\r\n\r\n    const normalizedTrade = normalizeTradeDates(trade);\r\n\r\n    // Update internalTrades\r\n    setInternalTrades(prevTrades => {\r\n      switch (type) {\r\n        case 'update': {\r\n          const tradeIndex = prevTrades.findIndex(t => t.id === trade.id);\r\n          if (tradeIndex === -1) return prevTrades;\r\n\r\n          const updatedTrades = [...prevTrades];\r\n          updatedTrades[tradeIndex] = normalizedTrade;\r\n          logger.log(` PerformanceCharts: Synced trade update for ${trade.id}`);\r\n          return updatedTrades;\r\n        }\r\n        case 'insert': {\r\n          if (prevTrades.some(t => t.id === trade.id)) return prevTrades;\r\n          logger.log(` PerformanceCharts: Synced trade insert for ${trade.id}`);\r\n          return [...prevTrades, normalizedTrade];\r\n        }\r\n        case 'delete': {\r\n          const filteredTrades = prevTrades.filter(t => t.id !== trade.id);\r\n          if (filteredTrades.length === prevTrades.length) return prevTrades;\r\n          logger.log(` PerformanceCharts: Synced trade delete for ${trade.id}`);\r\n          return filteredTrades;\r\n        }\r\n        default:\r\n          return prevTrades;\r\n      }\r\n    });\r\n\r\n    // Also update multipleTradesDialog.trades if the dialog is open\r\n    setTradesDialog(prev => {\r\n      if (!prev.open) return prev;\r\n\r\n      switch (type) {\r\n        case 'update': {\r\n          const tradeIndex = prev.trades.findIndex(t => t.id === trade.id);\r\n          if (tradeIndex === -1) return prev;\r\n\r\n          const updatedTrades = [...prev.trades];\r\n          updatedTrades[tradeIndex] = normalizedTrade;\r\n          return { ...prev, trades: updatedTrades };\r\n        }\r\n        case 'insert': {\r\n          // Don't add to dialog - it was opened with specific trades\r\n          return prev;\r\n        }\r\n        case 'delete': {\r\n          const filteredTrades = prev.trades.filter(t => t.id !== trade.id);\r\n          if (filteredTrades.length === prev.trades.length) return prev;\r\n          // Close dialog if all trades were deleted\r\n          if (filteredTrades.length === 0) {\r\n            return { ...prev, open: false, trades: [] };\r\n          }\r\n          return { ...prev, trades: filteredTrades };\r\n        }\r\n        default:\r\n          return prev;\r\n      }\r\n    });\r\n  }, [tradeSync?.lastSyncEvent, calendarId]);\r\n\r\n  const handleTimePeriodChange = (newValue: TimePeriod) => {\r\n    setTimePeriod(newValue);\r\n    onTimePeriodChange?.(newValue);\r\n  };\r\n\r\n  // Convert string value to tab index for RoundedTabs\r\n  const getTimePeriodTabIndex = (period: TimePeriod): number => {\r\n    return TIME_PERIOD_TABS.findIndex(tab => tab.value === period);\r\n  };\r\n\r\n  // Handle tab change for time period\r\n  const handleTimePeriodTabChange = (_: React.SyntheticEvent, newIndex: number) => {\r\n    const newPeriod = TIME_PERIOD_TABS[newIndex]?.value as TimePeriod;\r\n    if (newPeriod) {\r\n      handleTimePeriodChange(newPeriod);\r\n    }\r\n  };\r\n\r\n  const filteredTrades = useMemo(() => {\r\n    const filtered = getFilteredTrades(trades, selectedDate, timePeriod);\r\n    logger.debug('PerformanceCharts - Filtered trades:', {\r\n      totalTrades: trades.length,\r\n      filteredCount: filtered.length,\r\n      selectedDate: selectedDate.toISOString(),\r\n      timePeriod,\r\n      calendarId\r\n    });\r\n    return filtered;\r\n  }, [trades, selectedDate, timePeriod, calendarId]);\r\n\r\n  // Get performance data from async calculations\r\n  const riskRewardStats = performanceData?.riskRewardStats || { average: 0, max: 0, data: [] };\r\n\r\n  // Chart data is now calculated asynchronously in useEffect above\r\n\r\n  // Get win/loss statistics from async calculations\r\n  const winLossStats = performanceData?.winLossStats || {\r\n    total_trades: 0,\r\n    win_rate: 0,\r\n    winners: { total: 0, avgAmount: 0, maxConsecutive: 0, avgConsecutive: 0 },\r\n    losers: { total: 0, avgAmount: 0, maxConsecutive: 0, avgConsecutive: 0 },\r\n    breakevens: { total: 0, avgAmount: 0 }\r\n  };\r\n\r\n  // Get win/loss distribution data from async calculations\r\n  const winLossData = performanceData?.winLossData || [];\r\n\r\n  // Get daily summary data from async calculations\r\n  const dailySummaryData = performanceData?.dailySummaryData || [];\r\n\r\n  // Get tag statistics from async calculations\r\n  const tagStats = performanceData?.tagStats || [];\r\n\r\n  // Get session statistics from async calculations\r\n  const sessionStats = performanceData?.sessionStats || [];\r\n\r\n  // Get all unique tags from async calculations\r\n  const allTags = performanceData?.allTags || [];\r\n\r\n  // Calculate target value for monthly target\r\n  const targetValue = useMemo(() => {\r\n    if (monthlyTarget === undefined || accountBalance <= 0) return null;\r\n    return (monthlyTarget / 100) * accountBalance;\r\n  }, [monthlyTarget, accountBalance]);\r\n\r\n  // Calculate drawdown violation value\r\n  const drawdownViolationValue = useMemo(() => {\r\n    return -(maxDailyDrawdown / 100) * accountBalance;\r\n  }, [maxDailyDrawdown, accountBalance]);\r\n\r\n  // These handlers are now used directly in the chart overlays - wrapped in useCallback\r\n\r\n  const handleTradeExpand = useCallback((tradeId: string) => {\r\n    setTradesDialog(prev => ({\r\n      ...prev,\r\n      expandedTradeId: prev.expandedTradeId === tradeId ? null : tradeId\r\n    }));\r\n  }, []);\r\n\r\n  const handleZoomImage = useCallback((imageUrl: string, allImages?: string[], initialIndex?: number) => {\r\n    setZoomedImages({ selectetdImageIndex: initialIndex || 0, allImages: allImages || [imageUrl] });\r\n  }, []);\r\n\r\n  const handleTagAnalysisTabChange = useCallback((_: React.SyntheticEvent, newValue: number) => {\r\n    setTagAnalysisTab(newValue);\r\n  }, []);\r\n\r\n  // Construct tradeOperations object - hide edit/delete in read-only mode\r\n  const tradeOperations: TradeOperationsProps = useMemo(() => ({\r\n    onEditTrade: isReadOnly ? undefined : onEditTrade,\r\n    onDeleteTrade: isReadOnly ? undefined : onDeleteTrade,\r\n    onDeleteMultipleTrades: undefined,\r\n    onUpdateTradeProperty: isReadOnly ? undefined : onUpdateTradeProperty,\r\n    onZoomImage: handleZoomImage,\r\n    onOpenGalleryMode: onOpenGalleryMode,\r\n    economicFilter: economicFilterFn,\r\n    calendarId: calendarId,\r\n    calendar: calendar,\r\n    isTradeUpdating: undefined,\r\n    isReadOnly: isReadOnly\r\n  }), [onEditTrade, onDeleteTrade, onUpdateTradeProperty, onOpenGalleryMode, economicFilterFn, calendarId, calendar, isReadOnly]);\r\n\r\n\r\n\r\n  // Handle pie chart click to show trades - wrapped in useCallback\r\n  const handlePieClick = useCallback((category: string) => {\r\n\r\n    let categoryTrades: Trade[] = [];\r\n    let dialogTitle = '';\r\n\r\n    // Check if we're clicking on a win/loss category or a tag\r\n    if (category === 'Wins' || category === 'Losses') {\r\n      // Filter trades based on the clicked category (Wins or Losses)\r\n      categoryTrades = filteredTrades.filter(trade =>\r\n        (category === 'Wins' && trade.trade_type === 'win') ||\r\n        (category === 'Losses' && trade.trade_type === 'loss')\r\n      );\r\n\r\n      // Format the date range for the dialog title\r\n      let dateText;\r\n      if (timePeriod === 'month') {\r\n        dateText = format(selectedDate, 'MMMM yyyy');\r\n      } else if (timePeriod === 'year') {\r\n        dateText = format(selectedDate, 'yyyy');\r\n      } else {\r\n        dateText = 'All Time';\r\n      }\r\n\r\n      dialogTitle = `${category} for ${dateText}`;\r\n    } else {\r\n      // We're clicking on a tag in the tag distribution chart\r\n      // Filter trades that have this tag\r\n      categoryTrades = filteredTrades.filter(trade =>\r\n        trade.tags?.includes(category)\r\n      );\r\n\r\n      dialogTitle = `Trades with tag: ${category}`;\r\n    }\r\n\r\n    if (categoryTrades.length > 0) {\r\n      // Open the dialog with the filtered trades\r\n      setTradesDialog({\r\n        open: true,\r\n        trades: categoryTrades,\r\n        title: dialogTitle,\r\n        expandedTradeId: categoryTrades.length === 1 ? categoryTrades[0].id : null\r\n      });\r\n    }\r\n  }, [filteredTrades, timePeriod, selectedDate]);\r\n\r\n  return (\r\n    <Box sx={{ p: { xs: 1, sm: 2 }, minHeight: { xs: 'auto', sm: 500 } }}>\r\n      {/* Image Zoom Dialog */}\r\n      {zoomedImages && (\r\n        <ImageZoomDialog\r\n          open={!!zoomedImages}\r\n          onClose={() => setZoomedImages(null)}\r\n          imageProp={zoomedImages}\r\n        />\r\n      )}\r\n\r\n      {/* Trades Dialog - Only render when open */}\r\n      {tradesDialog.open && (\r\n        <TradesListDialog\r\n          open={tradesDialog.open}\r\n          trades={tradesDialog.trades}\r\n          title={tradesDialog.title}\r\n          expandedTradeId={tradesDialog.expandedTradeId}\r\n          showChartInfo={tradesDialog.showChartInfo || true}\r\n          onClose={() => setTradesDialog(prev => ({ ...prev, open: false }))}\r\n          onTradeExpand={handleTradeExpand}\r\n          account_balance={accountBalance}\r\n          tradeOperations={tradeOperations}\r\n        />\r\n      )}\r\n\r\n      {/* Header Section - Stack on mobile */}\r\n      <Box sx={{\r\n        display: 'flex',\r\n        flexDirection: { xs: 'column', sm: 'row' },\r\n        justifyContent: 'space-between',\r\n        alignItems: { xs: 'stretch', sm: 'center' },\r\n        gap: { xs: 2, sm: 0 },\r\n        mb: 2\r\n      }}>\r\n       \r\n        {!hideTimePeriodTabs && (\r\n          <RoundedTabs\r\n            tabs={TIME_PERIOD_TABS}\r\n            activeTab={getTimePeriodTabIndex(timePeriod)}\r\n            onTabChange={handleTimePeriodTabChange}\r\n            size={tabSize || 'small'}\r\n            sx={{\r\n              alignSelf: { xs: 'center', sm: 'auto' }\r\n            }}\r\n          />\r\n        )}\r\n      </Box>\r\n\r\n      {/* Basic/Advanced Tab Selection */}\r\n      <Box sx={{ mb: 2 }}>\r\n        <RoundedTabs\r\n          tabs={PERFORMANCE_TABS}\r\n          fullWidth={true}\r\n          activeTab={performanceTab === 'basic' ? 0 : 1}\r\n          onTabChange={(_, newIndex) => setPerformanceTab(newIndex === 0 ? 'basic' : 'advanced')} \r\n        />\r\n      </Box>\r\n\r\n      {/* Loading State */}\r\n      {isLoadingData && (\r\n        <ShimmerChartLoader height={chartHeights.large} />\r\n      )}\r\n\r\n      {/* Error State */}\r\n      {calculationError && !isLoadingData && (\r\n        <Alert\r\n          severity=\"error\"\r\n          sx={{ mb: 3 }}\r\n          action={\r\n            <Button\r\n              color=\"inherit\"\r\n              size=\"small\"\r\n              onClick={() => {\r\n                setCalculationError(null);\r\n                // Trigger recalculation by updating a dependency\r\n                setPerformanceData(null);\r\n              }}\r\n            >\r\n              Retry\r\n            </Button>\r\n          }\r\n        >\r\n          <Typography variant=\"body2\">\r\n            Failed to calculate performance metrics: {calculationError}\r\n          </Typography>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Main content */}\r\n      {!isLoadingData && filteredTrades.length > 0 ? (\r\n        <>\r\n          {/* Basic Tab Content */}\r\n          {performanceTab === 'basic' && (\r\n            <>\r\n              {/* Risk to Reward Statistics Card */}\r\n              <RiskRewardChart riskRewardStats={riskRewardStats} />\r\n\r\n              {/* Winners and Losers Statistics */}\r\n              <WinLossStats\r\n                winLossStats={winLossStats}\r\n                trades={filteredTrades}\r\n                onTradeClick={handleTradeExpand}\r\n              />\r\n\r\n              {/* P&L Charts with Tabs */}\r\n              <PnLChartsWrapper\r\n                chartData={chartData}\r\n                targetValue={targetValue}\r\n                monthly_target={monthlyTarget}\r\n                drawdownViolationValue={drawdownViolationValue}\r\n                setMultipleTradesDialog={setTradesDialog}\r\n                timePeriod={timePeriod}\r\n              />\r\n\r\n              {/* Win/Loss Distribution and Daily Summary - Stack on mobile */}\r\n              <Box sx={{\r\n                display: 'flex',\r\n                flexDirection: { xs: 'column', md: 'row' },\r\n                gap: { xs: 2, md: 3 },\r\n                mb: 3,\r\n                height: { xs: 'auto', md: chartHeights.pair }\r\n              }}>\r\n                <Box sx={{\r\n                  flex: 1,\r\n                  width: { xs: '100%', md: '50%' },\r\n                  height: { xs: chartHeights.large, md: '100%' }\r\n                }}>\r\n                  {/* Win/Loss Distribution */}\r\n                  <WinLossDistribution\r\n                    winLossData={winLossData}\r\n                    onPieClick={handlePieClick}\r\n                  />\r\n                </Box>\r\n                <Box sx={{\r\n                  flex: 1,\r\n                  width: { xs: '100%', md: '50%' },\r\n                  height: { xs: chartHeights.large, md: '100%' }\r\n                }}>\r\n                  {/* Daily Summary Table */}\r\n                  <DailySummaryTable\r\n                    dailySummaryData={dailySummaryData}\r\n                    trades={trades}\r\n                    setMultipleTradesDialog={setTradesDialog}\r\n                  />\r\n                </Box>\r\n              </Box>\r\n            </>\r\n          )}\r\n\r\n          {/* Advanced Tab Content */}\r\n          {(performanceTab === 'advanced' || advancedTabVisited) && (\r\n            <Box sx={{ display: performanceTab === 'advanced' ? 'block' : 'none' }}>\r\n           {/* Trading Score Section */}\r\n            <ScoreSection\r\n              trades={trades}\r\n              selectedDate={selectedDate}\r\n              calendarId={calendarId}\r\n              scoreSettings={scoreSettings}\r\n              onUpdateCalendarProperty={onUpdateCalendarProperty}\r\n              accountBalance={accountBalance}\r\n              dynamicRiskSettings={dynamicRiskSettings}\r\n              timePeriod={timePeriod}\r\n            />\r\n\r\n          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\r\n            \r\n\r\n               {/* Tag Performance Analysis with Tabs */}\r\n          <Paper sx={{ p: { xs: 2, sm: 3 }, mb: 3, borderRadius: 2 }}>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              justifyContent: { xs: 'center', sm: 'space-between' },\r\n              alignItems: 'center',\r\n              mb: 2\r\n            }}>\r\n              <RoundedTabs\r\n                tabs={TAG_ANALYSIS_TABS}\r\n                activeTab={tagAnalysisTab}\r\n                onTabChange={handleTagAnalysisTabChange}\r\n                size=\"small\"\r\n                sx={{\r\n                  maxWidth: { xs: '100%', sm: 'none' }\r\n                }}\r\n              />\r\n            </Box>\r\n\r\n            {/* Tab Panel 1: Tag Performance Analysis - Only render when active */}\r\n            {tagAnalysisTab === 0 && (\r\n              <TagPerformanceAnalysis\r\n                trades={trades}\r\n                selectedDate={selectedDate}\r\n                timePeriod={timePeriod}\r\n                allTags={allTags}\r\n                primaryTags={primaryTags}\r\n                secondaryTags={secondaryTags}\r\n                setPrimaryTags={(tags) => {\r\n                  setPrimaryTags(tags);\r\n                  onPrimaryTagsChange(tags);\r\n                }}\r\n                setSecondaryTags={(tags) => {\r\n                  setSecondaryTags(tags);\r\n                  onSecondaryTagsChange(tags);\r\n                }}\r\n                setMultipleTradesDialog={setTradesDialog}\r\n              />\r\n            )}\r\n\r\n            {/* Tab Panel 2: Tag Performance by Day of Week Analysis - Only render when active */}\r\n            {tagAnalysisTab === 1 && (\r\n              <TagDayOfWeekAnalysis\r\n                trades={trades}\r\n                selectedDate={selectedDate}\r\n                timePeriod={timePeriod}\r\n                allTags={allTags}\r\n                primaryTags={primaryTags}\r\n                secondaryTags={secondaryTags}\r\n                setPrimaryTags={(tags) => {\r\n                  setPrimaryTags(tags);\r\n                  onPrimaryTagsChange(tags);\r\n                }}\r\n                setSecondaryTags={(tags) => {\r\n                  setSecondaryTags(tags);\r\n                  onSecondaryTagsChange(tags);\r\n                }}\r\n                setMultipleTradesDialog={setTradesDialog}\r\n              />\r\n            )}\r\n          </Paper>\r\n\r\n           {/* Session Performance Analysis */}\r\n          <SessionPerformanceAnalysis\r\n            sessionStats={sessionStats}\r\n            trades={trades}\r\n            selectedDate={selectedDate}\r\n            timePeriod={timePeriod}\r\n            setMultipleTradesDialog={setTradesDialog}\r\n          />\r\n\r\n            {/* Economic Event Correlation Analysis */}\r\n            <EconomicEventCorrelationAnalysis\r\n              calendarId={calendarId}\r\n              trades={filteredTrades}\r\n              timePeriod={timePeriod}\r\n              selectedDate={selectedDate}\r\n              setMultipleTradesDialog={setTradesDialog}\r\n              economicCorrelations={economicCorrelations}\r\n            />\r\n          </Box>\r\n\r\n         \r\n            </Box>\r\n          )}\r\n        </>\r\n      ) : !isLoadingData ? (\r\n        <Box\r\n          sx={{\r\n            height: { xs: chartHeights.medium, sm: 300 },\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            bgcolor: theme.palette.mode === 'dark' ? 'rgba(0, 0, 0, 0.2)' : 'rgba(0, 0, 0, 0.02)',\r\n            borderRadius: 2,\r\n            border: `1px solid ${theme.palette.divider}`\r\n          }}\r\n        >\r\n          <Typography color=\"text.secondary\">\r\n            No trading data available for {timePeriod === 'month'\r\n              ? format(selectedDate, 'MMMM yyyy')\r\n              : timePeriod === 'year'\r\n                ? format(selectedDate, 'yyyy')\r\n                : 'All Time'\r\n            }\r\n          </Typography>\r\n        </Box>\r\n      ) : null}\r\n\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default React.memo(PerformanceCharts);\r\n","import React, { useState } from 'react';\r\nimport { format } from 'date-fns';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  IconButton,\r\n  Paper,\r\n  alpha,\r\n  Button,\r\n  Tooltip,\r\n  Snackbar,\r\n  Alert,\r\n  AlertColor,\r\n  DialogContent,\r\n  DialogActions,\r\n  DialogTitle,\r\n  Dialog,\r\n  Menu,\r\n  MenuItem,\r\n  ListItemIcon,\r\n  ListItemText,\r\n  useTheme,\r\n  useMediaQuery\r\n} from '@mui/material';\r\nimport {\r\n  TrendingUp,\r\n  FileDownload,\r\n  FileUpload,\r\n  EmojiEvents,\r\n  CalendarMonth,\r\n  Analytics,\r\n  TrendingDown,\r\n  ShowChart,\r\n  Balance,\r\n  MoreVert,\r\n  Delete,\r\n  ViewCarousel as GalleryIcon,\r\n  Close as CloseIcon\r\n} from '@mui/icons-material';\r\nimport { Trade } from '../types/dualWrite';\r\nimport { exportTrades } from '../utils/tradeExportImport';\r\nimport { formatCurrency } from '../utils/formatters';\r\nimport { calculatePercentageOfValueAtDate } from '../utils/dynamicRiskUtils';\r\nimport { calculateTargetProgress } from '../utils/statsUtils';\r\nimport { error } from '../utils/logger';\r\nimport { ImportMappingDialog } from './import/ImportMappingDialog';\r\nimport PerformanceCharts, { TimePeriod, TIME_PERIOD_TABS } from './PerformanceCharts';\r\nimport RoundedTabs from './common/RoundedTabs';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\n\r\n\r\n\r\ninterface MonthlyStatsProps {\r\n  trades: Trade[];\r\n  accountBalance: number;\r\n  onImportTrades?: (trades: Partial<Trade>[]) => Promise<void>;\r\n  onDeleteTrade?: (id: string) => void;\r\n  currentDate?: Date;\r\n  monthlyTarget?: number;\r\n  onClearMonthTrades?: (month: number, year: number) => void;\r\n  // Read-only mode for shared calendars\r\n  isReadOnly?: boolean;\r\n  // Gallery mode handler\r\n  onOpenGalleryMode?: (trades: Trade[], initialTradeId?: string, title?: string) => void;\r\n  // Performance charts props\r\n  calendarId?: string;\r\n  scoreSettings?: import('../types/score').ScoreSettings;\r\n  dynamicRiskSettings?: import('../utils/dynamicRiskUtils').DynamicRiskSettings;\r\n  onUpdateTradeProperty?: (tradeId: string, updateCallback: (trade: Trade) => Trade) => Promise<Trade | undefined>;\r\n  onUpdateCalendarProperty?: (calendarId: string, updateCallback: (calendar: import('../types/dualWrite').Calendar) => import('../types/dualWrite').Calendar) => Promise<import('../types/dualWrite').Calendar | undefined>;\r\n  onEditTrade?: (trade: Trade) => void;\r\n  economicFilter?: (calendarId: string) => import('./economicCalendar/EconomicCalendarDrawer').EconomicCalendarFilterSettings;\r\n  maxDailyDrawdown?: number;\r\n}\r\n\r\n\r\nconst MonthlyStats: React.FC<MonthlyStatsProps> = ({\r\n  trades,\r\n  accountBalance,\r\n  onImportTrades,\r\n  onDeleteTrade,\r\n  currentDate = new Date(),\r\n  monthlyTarget,\r\n  onClearMonthTrades,\r\n  isReadOnly = false,\r\n  onOpenGalleryMode,\r\n  calendarId,\r\n  scoreSettings,\r\n  dynamicRiskSettings,\r\n  onUpdateTradeProperty,\r\n  onUpdateCalendarProperty,\r\n  onEditTrade,\r\n  economicFilter,\r\n  maxDailyDrawdown\r\n}) => {\r\n  const [showClearConfirm, setShowClearConfirm] = useState(false);\r\n  const [menuAnchorEl, setMenuAnchorEl] = useState<null | HTMLElement>(null);\r\n  const menuOpen = Boolean(menuAnchorEl);\r\n  const [showImportDialog, setShowImportDialog] = useState(false);\r\n  const [isPerformanceDialogOpen, setIsPerformanceDialogOpen] = useState(false);\r\n  const [performanceTimePeriod, setPerformanceTimePeriod] = useState<TimePeriod>('month');\r\n\r\n  const theme = useTheme();\r\n  const isXs = useMediaQuery(theme.breakpoints.down('sm'));\r\n\r\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\r\n\r\n  const monthTrades = trades.filter(trade =>\r\n    new Date(trade.trade_date).getMonth() === currentDate.getMonth() &&\r\n    new Date(trade.trade_date).getFullYear() === currentDate.getFullYear()\r\n  );\r\n\r\n  // Calculate monthly values from the filtered trades\r\n  const netAmountForThisMonth = monthTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n  const winCount = monthTrades.filter(trade => trade.trade_type === 'win').length;\r\n  const lossCount = monthTrades.filter(trade => trade.trade_type === 'loss').length;\r\n  const winRate = monthTrades.length > 0 ? (winCount / monthTrades.length * 100).toFixed(1) : '0';\r\n\r\n  // Additional useful statistics\r\n  const totalWinAmount = monthTrades.filter(trade => trade.trade_type === 'win').reduce((sum, trade) => sum + trade.amount, 0);\r\n  const totalLossAmount = Math.abs(monthTrades.filter(trade => trade.trade_type === 'loss').reduce((sum, trade) => sum + trade.amount, 0));\r\n  const profitFactor = totalLossAmount > 0 ? (totalWinAmount / totalLossAmount).toFixed(2) : totalWinAmount > 0 ? '' : '0';\r\n  const averageTradeSize = monthTrades.length > 0 ? (Math.abs(netAmountForThisMonth) / monthTrades.length).toFixed(0) : '0';\r\n  const averageWin = winCount > 0 ? (totalWinAmount / winCount).toFixed(0) : '0';\r\n  const averageLoss = lossCount > 0 ? (totalLossAmount / lossCount).toFixed(0) : '0';\r\n\r\n  // Best and worst day calculations\r\n  const dailyPnL = new Map<string, number>();\r\n  monthTrades.forEach(trade => {\r\n    const dateKey = new Date(trade.trade_date).toDateString();\r\n    dailyPnL.set(dateKey, (dailyPnL.get(dateKey) || 0) + trade.amount);\r\n  });\r\n\r\n  let bestDay = 0;\r\n  let bestDayDate = '';\r\n  let worstDay = 0;\r\n  let worstDayDate = '';\r\n\r\n  if (dailyPnL.size > 0) {\r\n    const entries = Array.from(dailyPnL.entries());\r\n    const bestEntry = entries.reduce((max, current) => current[1] > max[1] ? current : max);\r\n    const worstEntry = entries.reduce((min, current) => current[1] < min[1] ? current : min);\r\n\r\n    bestDay = bestEntry[1];\r\n    bestDayDate = format(new Date(bestEntry[0]), 'EEE d');\r\n    worstDay = worstEntry[1];\r\n    worstDayDate = format(new Date(worstEntry[0]), 'EEE d');\r\n  }\r\n\r\n  // Calculate growth percentage using account value at start of month (excluding current month trades)\r\n  const startOfCurrentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);\r\n  const growthPercentage = trades\r\n    ? calculatePercentageOfValueAtDate(netAmountForThisMonth, accountBalance, trades, startOfCurrentMonth).toFixed(1)\r\n    : accountBalance > 0 ? ((netAmountForThisMonth / accountBalance) * 100).toFixed(2) : '0';\r\n\r\n  // Calculate account value at start of month for display\r\n  const tradesBeforeMonth = trades.filter(trade => new Date(trade.trade_date) < startOfCurrentMonth);\r\n  const accountValueAtStartOfMonth = accountBalance + tradesBeforeMonth.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n\r\n  // Calculate monthly target progress using centralized function\r\n  const targetProgressValue = monthlyTarget && monthlyTarget > 0\r\n    ? calculateTargetProgress(monthTrades, accountBalance, monthlyTarget, startOfCurrentMonth, trades)\r\n    : 0;\r\n  const targetProgress = targetProgressValue.toFixed(0);\r\n  const isTargetMet = monthlyTarget ? parseFloat(growthPercentage) >= monthlyTarget : false;\r\n\r\n  const handleMenuOpen = (event: React.MouseEvent<HTMLElement>) => {\r\n    setMenuAnchorEl(event.currentTarget);\r\n  };\r\n\r\n  const handleMenuClose = () => {\r\n    setMenuAnchorEl(null);\r\n  };\r\n\r\n  const handleExport = (format: 'xlsx' | 'csv') => {\r\n    if (monthTrades.length === 0) {\r\n      return;\r\n    }\r\n    exportTrades(trades, accountBalance, format);\r\n    handleMenuClose();\r\n  };\r\n\r\n  const [snackbarOpen, setSnackbarOpen] = useState(false);\r\n  const [snackbarMessage, setSnackbarMessage] = useState('');\r\n  const [snackbarSeverity, setSnackbarSeverity] = useState<AlertColor>('success');\r\n\r\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = event.target.files?.[0];\r\n    if (!file || !onImportTrades) return;\r\n\r\n    handleMenuClose();\r\n    setSelectedFile(file);\r\n    setShowImportDialog(true);\r\n\r\n    // Reset the input\r\n    event.target.value = '';\r\n  };\r\n\r\n  const handleImportComplete = async (importedTrades: Partial<Trade>[]) => {\r\n    if (!onImportTrades) return;\r\n\r\n    try {\r\n      // Wait for import to complete before closing dialog\r\n      await onImportTrades(importedTrades);\r\n\r\n      // Show success message\r\n      setSnackbarMessage(`Successfully imported ${importedTrades.length} trades`);\r\n      setSnackbarSeverity('success');\r\n      setSnackbarOpen(true);\r\n\r\n      // Close dialog only after import completes\r\n      setShowImportDialog(false);\r\n      setSelectedFile(null);\r\n    } catch (error) {\r\n      // Show error message if import fails\r\n      setSnackbarMessage('Failed to import trades. Please try again.');\r\n      setSnackbarSeverity('error');\r\n      setSnackbarOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleClearClick = () => {\r\n    handleMenuClose();\r\n    setShowClearConfirm(true);\r\n  };\r\n\r\n  const handleClearConfirm = () => {\r\n    if (onClearMonthTrades) {\r\n      onClearMonthTrades(currentDate.getMonth(), currentDate.getFullYear());\r\n    }\r\n    setShowClearConfirm(false);\r\n  };\r\n\r\n  // Handle snackbar close\r\n  const handleSnackbarClose = () => {\r\n    setSnackbarOpen(false);\r\n  };\r\n\r\n  // Handle gallery mode\r\n  const handleMonthlyGalleryMode = () => {\r\n    if (monthTrades.length > 0 && onOpenGalleryMode) {\r\n      const monthName = format(currentDate, 'MMMM yyyy');\r\n      const title = `${monthName} - Monthly Trades (${monthTrades.length} trades)`;\r\n      onOpenGalleryMode(monthTrades, monthTrades[0].id, title);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Paper\r\n        elevation={2}\r\n        sx={{\r\n          p: { xs: 1.5, sm: 2 },\r\n          borderRadius: 2,\r\n          position: 'relative',\r\n          width: '100%',\r\n          pb: { xs: 4, sm: 2.5 },\r\n          overflow: 'hidden',\r\n          height: '100%',\r\n          minHeight: { xs: '280px', sm: '320px' }\r\n        }}\r\n      >\r\n        <Box sx={{\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'space-between',\r\n        }}>\r\n          <Typography variant={isXs ? 'subtitle1' : 'h6'} sx={{ mb: { xs: 1, sm: 2 }, fontWeight: 600, pl: 0.5 }}>\r\n            Monthly Performance\r\n          </Typography>\r\n\r\n\r\n          <Box sx={{\r\n            position: 'static',\r\n            display: 'flex',\r\n            gap: 1,\r\n            justifyContent: 'flex-end',\r\n            mb: 2,\r\n            flex: 1,\r\n            alignItems: 'center'\r\n          }}>\r\n            <input\r\n              type=\"file\"\r\n              accept=\".xlsx,.csv\"\r\n              style={{ display: 'none' }}\r\n              id=\"import-file\"\r\n              onChange={handleFileSelect}\r\n            />\r\n            {/* View Details Stats Button */}\r\n            {calendarId && (\r\n              <Tooltip title=\"View detailed performance analytics\" arrow>\r\n                <IconButton\r\n                  onClick={() => setIsPerformanceDialogOpen(true)}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    color: 'primary.main',\r\n                    bgcolor: 'background.paper',\r\n                    border: '1px solid',\r\n                    borderColor: alpha(theme.palette.primary.main, 0.3),\r\n                    '&:hover': {\r\n                      bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                      color: 'primary.main',\r\n                      borderColor: 'primary.main'\r\n                    }\r\n                  }}\r\n                >\r\n                  <Analytics />\r\n                </IconButton>\r\n              </Tooltip>\r\n            )}\r\n            {/* Gallery Button - Moved from TradeCalendarPage */}\r\n            {monthTrades.length > 0 && onOpenGalleryMode && (\r\n              <Tooltip title=\"View all trades for this month in gallery mode\" arrow>\r\n                <IconButton\r\n                  onClick={handleMonthlyGalleryMode}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    color: 'primary.main',\r\n                    bgcolor: 'background.paper',\r\n                    border: '1px solid',\r\n                    borderColor: alpha(theme.palette.primary.main, 0.3),\r\n                    '&:hover': {\r\n                      bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                      color: 'primary.main',\r\n                      borderColor: 'primary.main'\r\n                    }\r\n                  }}\r\n                >\r\n                  <GalleryIcon />\r\n                </IconButton>\r\n              </Tooltip>\r\n            )}\r\n            <Tooltip title=\"More options\">\r\n              <IconButton\r\n                onClick={handleMenuOpen}\r\n                size=\"small\"\r\n                sx={{\r\n                  color: 'text.secondary',\r\n                  bgcolor: 'background.paper',\r\n                  border: '1px solid',\r\n                  borderColor: 'divider',\r\n                  '&:hover': {\r\n                    bgcolor: 'action.hover',\r\n                    color: 'text.primary',\r\n                    borderColor: 'text.primary'\r\n                  }\r\n                }}\r\n              >\r\n                <MoreVert />\r\n              </IconButton>\r\n            </Tooltip>\r\n            <Menu\r\n              anchorEl={menuAnchorEl}\r\n              open={menuOpen}\r\n              onClose={handleMenuClose}\r\n              anchorOrigin={{\r\n                vertical: 'bottom',\r\n                horizontal: 'right',\r\n              }}\r\n              transformOrigin={{\r\n                vertical: 'top',\r\n                horizontal: 'right',\r\n              }}\r\n            >\r\n              {!isReadOnly && (\r\n                <MenuItem onClick={() => document.getElementById('import-file')?.click()}>\r\n                  <ListItemIcon>\r\n                    <FileUpload fontSize=\"small\" />\r\n                  </ListItemIcon>\r\n                  <ListItemText>Import Trades</ListItemText>\r\n                </MenuItem>\r\n              )}\r\n              <MenuItem\r\n                onClick={() => handleExport('xlsx')}\r\n                disabled={monthTrades.length === 0}\r\n              >\r\n                <ListItemIcon>\r\n                  <FileDownload fontSize=\"small\" />\r\n                </ListItemIcon>\r\n                <ListItemText>Export XLSX</ListItemText>\r\n              </MenuItem>\r\n              <MenuItem\r\n                onClick={() => handleExport('csv')}\r\n                disabled={monthTrades.length === 0}\r\n              >\r\n                <ListItemIcon>\r\n                  <FileDownload fontSize=\"small\" />\r\n                </ListItemIcon>\r\n                <ListItemText>Export CSV</ListItemText>\r\n              </MenuItem>\r\n              {!isReadOnly && (\r\n                <MenuItem\r\n                  onClick={handleClearClick}\r\n                  disabled={monthTrades.length === 0}\r\n                  sx={{ color: 'error.main' }}\r\n                >\r\n                  <ListItemIcon>\r\n                    <Delete fontSize=\"small\" sx={{ color: 'error.main' }} />\r\n                  </ListItemIcon>\r\n                  <ListItemText>Clear Month</ListItemText>\r\n                </MenuItem>\r\n              )}\r\n            </Menu>\r\n          </Box>\r\n        </Box>\r\n\r\n        <Box sx={{\r\n          display: 'grid',\r\n          gridTemplateColumns: { xs: 'repeat(2, 1fr)', sm: 'repeat(2, 1fr)', md: 'repeat(3, 1fr)' },\r\n          gap: { xs: 1, sm: 1.25, md: 1.5 },\r\n        }}>\r\n          {/* Monthly P&L Card */}\r\n          <Box sx={{\r\n            p: { xs: 1.25, sm: 2 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: { xs: 0.25, sm: 0.5 }\r\n          }}>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 1,\r\n              mb: 0.5\r\n            }}>\r\n              <TrendingUp sx={{ fontSize: { xs: '1rem', sm: '1.2rem' }, color: netAmountForThisMonth > 0 ? 'success.main' : netAmountForThisMonth < 0 ? 'error.main' : 'text.secondary' }} />\r\n              <Typography variant=\"body1\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: { xs: '0.9rem', sm: '1rem' } }}>\r\n                Monthly P&L\r\n\r\n              </Typography>\r\n            </Box>\r\n            <Typography\r\n              variant={isXs ? 'h6' : 'h5'}\r\n              sx={{\r\n                fontWeight: 700,\r\n                color: netAmountForThisMonth > 0 ? 'success.main' : netAmountForThisMonth < 0 ? 'error.main' : 'text.primary',\r\n                display: 'flex',\r\n                alignItems: 'baseline',\r\n                gap: { xs: 0.25, sm: 0.5 }\r\n              }}\r\n            >\r\n              {formatCurrency(netAmountForThisMonth)}\r\n              <Tooltip\r\n                title={`Percentage calculated based on account value at start of ${format(currentDate, 'MMMM')}: ${formatCurrency(accountValueAtStartOfMonth)} (excluding this month's trades for consistent comparison)`}\r\n                placement=\"top\"\r\n              >\r\n                <Typography\r\n                  component=\"span\"\r\n                  sx={{\r\n                    fontSize: { xs: '0.875rem', sm: '1rem' },\r\n                    color: netAmountForThisMonth > 0 ? 'success.main' : netAmountForThisMonth < 0 ? 'error.main' : 'text.primary',\r\n                    fontWeight: 600,\r\n                    cursor: 'help'\r\n                  }}\r\n                >\r\n                  ({growthPercentage}%)\r\n                </Typography>\r\n              </Tooltip>\r\n            </Typography>\r\n\r\n            {monthlyTarget && (\r\n              <Box sx={{ width: '100%', mt: 1.5 }}>\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  justifyContent: 'space-between',\r\n                  mb: 0.5\r\n                }}>\r\n                  <Typography variant=\"body2\" sx={{ fontWeight: 500, color: 'text.secondary' }}>\r\n                    Target Progress\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{\r\n                    fontWeight: 600,\r\n                    color: isTargetMet ? 'success.main' : 'primary.main'\r\n                  }}>\r\n                    {targetProgress}%\r\n                  </Typography>\r\n                </Box>\r\n                <Box sx={{\r\n                  width: '100%',\r\n                  height: { xs: '6px', sm: '8px' },\r\n                  bgcolor: theme => alpha(theme.palette.divider, 0.5),\r\n                  borderRadius: '4px',\r\n                  overflow: 'hidden'\r\n                }}>\r\n                  <Box sx={{\r\n                    width: `${Math.max(Math.min(parseFloat(targetProgress), 100), 0)}%`,\r\n                    height: '100%',\r\n                    bgcolor: isTargetMet ? 'success.main' : 'primary.main',\r\n                    transition: 'width 0.3s ease'\r\n                  }} />\r\n                </Box>\r\n              </Box>\r\n            )}\r\n          </Box>\r\n\r\n          {/* Win Rate Card */}\r\n          <Box sx={{\r\n            p: { xs: 1.25, sm: 2 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: { xs: 0.25, sm: 0.5 }\r\n          }}>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 1,\r\n              mb: 0.5\r\n            }}>\r\n              <EmojiEvents sx={{ fontSize: { xs: '1rem', sm: '1.2rem' }, color: parseFloat(winRate) > 50 ? 'success.main' : 'text.secondary' }} />\r\n              <Typography variant=\"body1\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: { xs: '0.9rem', sm: '1rem' } }}>\r\n                Win Rate\r\n              </Typography>\r\n            </Box>\r\n            <Typography variant={isXs ? 'h6' : 'h5'} sx={{ fontWeight: 700, color: parseFloat(winRate) > 50 ? 'success.main' : 'text.primary' }}>\r\n              {winRate}%\r\n            </Typography>\r\n            <Typography variant=\"body1\" sx={{ fontWeight: 500, color: 'text.secondary', mt: 0.5, fontSize: { xs: '0.875rem', sm: '1rem' } }}>\r\n              {winCount} Wins / {lossCount} Losses\r\n            </Typography>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              mt: 1,\r\n              gap: 1\r\n            }}>\r\n              <Box sx={{\r\n                height: { xs: '6px', sm: '10px' },\r\n                bgcolor: 'success.main',\r\n                borderRadius: '5px',\r\n                flex: winCount || 1\r\n              }} />\r\n              <Box sx={{\r\n                height: { xs: '6px', sm: '10px' },\r\n                bgcolor: 'error.main',\r\n                borderRadius: '5px',\r\n                flex: lossCount || 1\r\n              }} />\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Total Trades Card */}\r\n          <Box sx={{\r\n            p: { xs: 1.25, sm: 2 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: { xs: 0.25, sm: 0.5 }\r\n          }}>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 1,\r\n              mb: 0.5\r\n            }}>\r\n              <CalendarMonth sx={{ fontSize: { xs: '1rem', sm: '1.2rem' }, color: 'text.secondary' }} />\r\n              <Typography variant=\"body1\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: { xs: '0.9rem', sm: '1rem' } }}>\r\n                Trading Activity\r\n              </Typography>\r\n            </Box>\r\n            <Typography variant={isXs ? 'h6' : 'h5'} sx={{ fontWeight: 700, color: 'text.primary' }}>\r\n              {monthTrades.length} Trade{monthTrades.length === 1 ? '' : 's'}\r\n            </Typography>\r\n            <Typography variant=\"body1\" sx={{ fontWeight: 500, color: 'text.secondary', mt: 0.5, fontSize: { xs: '0.875rem', sm: '1rem' } }}>\r\n              {monthTrades.length > 0 ? (monthTrades.length / 30 * 100).toFixed(0) : 0}% of Month Active\r\n            </Typography>\r\n          </Box>\r\n\r\n          {/* Starting Capital Card */}\r\n          <Box sx={{\r\n            p: { xs: 1, sm: 1.5 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: 0.25\r\n          }}>\r\n            <Typography variant=\"body2\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: '0.75rem' }}>\r\n              Started With\r\n            </Typography>\r\n            <Typography variant=\"h6\" sx={{ fontWeight: 700, color: 'text.primary', fontSize: '1rem' }}>\r\n              {formatCurrency(accountValueAtStartOfMonth)}\r\n            </Typography>\r\n          </Box>\r\n\r\n          {/* Best Day Card */}\r\n          <Box sx={{\r\n            p: { xs: 1, sm: 1.5 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: 0.25\r\n          }}>\r\n            <Typography variant=\"body2\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: '0.75rem' }}>\r\n              Best Day {bestDayDate && (\r\n                <Typography component=\"span\" sx={{ color: 'secondary.main', fontWeight: 700, fontSize: '0.65rem' }}>\r\n                  {bestDayDate}\r\n                </Typography>\r\n              )}\r\n            </Typography>\r\n            <Typography variant=\"h6\" sx={{ fontWeight: 700, color: 'success.main', fontSize: '1rem' }}>\r\n              {bestDay > 0 ? formatCurrency(bestDay) : 'No trades'}\r\n            </Typography>\r\n          </Box>\r\n\r\n          {/* Profit Factor Card */}\r\n          <Box sx={{\r\n            p: { xs: 1, sm: 1.5 },\r\n            borderRadius: 2,\r\n            bgcolor: theme => alpha(theme.palette.background.default, 0.5),\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: 0.25\r\n          }}>\r\n            <Typography variant=\"body2\" sx={{ fontWeight: 600, color: 'text.secondary', fontSize: '0.75rem' }}>\r\n              Profit Factor\r\n            </Typography>\r\n            <Typography variant=\"h6\" sx={{ fontWeight: 700, color: parseFloat(profitFactor) > 1 ? 'success.main' : 'text.primary', fontSize: '1rem' }}>\r\n              {profitFactor}\r\n            </Typography>\r\n          </Box>\r\n        </Box>\r\n\r\n      </Paper>\r\n\r\n\r\n      <Dialog\r\n        open={showClearConfirm}\r\n        onClose={() => setShowClearConfirm(false)}\r\n        maxWidth=\"xs\"\r\n        fullWidth\r\n      >\r\n        <DialogTitle>Clear Trades</DialogTitle>\r\n        <DialogContent>\r\n          <Typography>\r\n            Are you sure you want to clear all trades? This action cannot be undone.\r\n          </Typography>\r\n        </DialogContent>\r\n        <DialogActions>\r\n          <Button onClick={() => setShowClearConfirm(false)}>Cancel</Button>\r\n          <Button onClick={handleClearConfirm} color=\"error\">Clear</Button>\r\n        </DialogActions>\r\n      </Dialog>\r\n\r\n      {/* Snackbar for import notifications */}\r\n      <Snackbar\r\n        open={snackbarOpen}\r\n        autoHideDuration={snackbarSeverity === 'success' ? 3000 : 6000}\r\n        onClose={handleSnackbarClose}\r\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n      >\r\n        <Alert\r\n          onClose={handleSnackbarClose}\r\n          severity={snackbarSeverity}\r\n          variant=\"filled\"\r\n          sx={{ width: '100%' }}\r\n        >\r\n          {snackbarMessage}\r\n        </Alert>\r\n      </Snackbar>\r\n\r\n      <ImportMappingDialog\r\n        open={showImportDialog}\r\n        onClose={() => {\r\n          setShowImportDialog(false);\r\n          setSelectedFile(null);\r\n        }}\r\n        onImport={handleImportComplete}\r\n        file={selectedFile}\r\n      />\r\n\r\n      {/* Performance Details Dialog */}\r\n      {calendarId && (\r\n        <Dialog\r\n          open={isPerformanceDialogOpen}\r\n          onClose={() => setIsPerformanceDialogOpen(false)}\r\n          maxWidth=\"lg\"\r\n          fullWidth\r\n          fullScreen={isXs}\r\n          sx={{\r\n            '& .MuiDialog-paper': {\r\n              borderRadius: 2,\r\n              boxShadow: 'none',\r\n              border: `1px solid ${theme.palette.divider}`,\r\n              maxHeight: '90vh',\r\n              overflow: 'hidden'\r\n            },\r\n            '& .MuiDialogContent-root': {\r\n              ...scrollbarStyles(theme)\r\n            }\r\n          }}\r\n        >\r\n          <DialogTitle sx={{ pb: 1 }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>\r\n              <Typography variant=\"h6\">\r\n                Performance Analytics for {performanceTimePeriod === 'month'\r\n                  ? format(currentDate, 'MMMM yyyy')\r\n                  : performanceTimePeriod === 'year'\r\n                    ? format(currentDate, 'yyyy')\r\n                    : 'All Time'\r\n                }\r\n              </Typography>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                <RoundedTabs\r\n                  tabs={TIME_PERIOD_TABS}\r\n                  activeTab={TIME_PERIOD_TABS.findIndex(t => t.value === performanceTimePeriod)}\r\n                  onTabChange={(_, index) => setPerformanceTimePeriod(TIME_PERIOD_TABS[index].value)}\r\n                  size=\"small\"\r\n                />\r\n                <IconButton onClick={() => setIsPerformanceDialogOpen(false)} size=\"small\">\r\n                  <CloseIcon />\r\n                </IconButton>\r\n              </Box>\r\n            </Box>\r\n          </DialogTitle>\r\n          <DialogContent sx={{ p: 0 }}>\r\n            <PerformanceCharts\r\n              selectedDate={currentDate}\r\n              accountBalance={accountBalance}\r\n              maxDailyDrawdown={maxDailyDrawdown || 0}\r\n              monthlyTarget={monthlyTarget}\r\n              calendarId={calendarId}\r\n              scoreSettings={scoreSettings}\r\n              dynamicRiskSettings={dynamicRiskSettings}\r\n              timePeriod={performanceTimePeriod}\r\n              onTimePeriodChange={setPerformanceTimePeriod}\r\n              hideTimePeriodTabs={true}\r\n              onEditTrade={onEditTrade}\r\n              onDeleteTrade={onDeleteTrade}\r\n              onUpdateTradeProperty={onUpdateTradeProperty}\r\n              onUpdateCalendarProperty={onUpdateCalendarProperty}\r\n              onOpenGalleryMode={onOpenGalleryMode}\r\n              economicFilter={economicFilter}\r\n              isReadOnly={isReadOnly}\r\n            />\r\n          </DialogContent>\r\n        </Dialog>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default MonthlyStats;\r\n","import React, { useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Paper,\r\n  alpha,\r\n  Switch,\r\n  FormControlLabel,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport {\r\n  Security as SecurityIcon,\r\n  InfoOutlined as InfoIcon,\r\n  TrendingDown as DrawdownIcon\r\n} from '@mui/icons-material';\r\nimport { Trade } from '../types/dualWrite';\r\nimport { DynamicRiskSettings } from '../utils/dynamicRiskUtils';\r\n\r\n\r\n\r\ninterface AccountBalanceProps {\r\n  balance: number;\r\n  totalProfit: number;\r\n  trades: Trade[];\r\n  onPerformanceClick?: () => void;\r\n  risk_per_trade?: number;\r\n  dynamicRiskSettings?: DynamicRiskSettings;\r\n  onToggleDynamicRisk?: (useActualAmounts: boolean) => void;\r\n  isDynamicRiskToggled?: boolean;\r\n  // Read-only mode for shared calendars\r\n  isReadOnly?: boolean;\r\n  max_daily_drawdown?: number;\r\n}\r\n\r\n\r\nconst AccountBalance: React.FC<AccountBalanceProps> = ({\r\n  balance,\r\n  trades,\r\n  totalProfit,\r\n  onPerformanceClick,\r\n  risk_per_trade,\r\n  dynamicRiskSettings,\r\n  onToggleDynamicRisk,\r\n  isDynamicRiskToggled = true, // Default to true (using actual amounts)\r\n  isReadOnly = false,\r\n  max_daily_drawdown\r\n}) => {\r\n\r\n  // Profit percentage calculation - should be based on original account balance for threshold comparison\r\n  const profitPercentage = trades.length > 0 && balance > 0 ? (totalProfit / balance * 100).toFixed(2) : '0';\r\n\r\n  // Calculate the effective risk percentage based on dynamic risk settings\r\n  const effectiveRiskPercentage = useMemo(() => {\r\n    if (!risk_per_trade) return undefined;\r\n\r\n    if (dynamicRiskSettings?.dynamic_risk_enabled &&\r\n      dynamicRiskSettings.increased_risk_percentage &&\r\n      dynamicRiskSettings.profit_threshold_percentage &&\r\n      parseFloat(profitPercentage) >= dynamicRiskSettings.profit_threshold_percentage) {\r\n      return dynamicRiskSettings.increased_risk_percentage;\r\n    }\r\n\r\n    return risk_per_trade;\r\n  }, [risk_per_trade, dynamicRiskSettings, profitPercentage]);\r\n\r\n  // Calculate total account value\r\n  const totalAccountValue = balance + totalProfit;\r\n\r\n\r\n  return (\r\n    <Paper\r\n      elevation={2}\r\n      sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 1.5,\r\n        p: 2,\r\n        borderRadius: 2,\r\n        bgcolor: 'background.paper',\r\n        border: '1px solid',\r\n        borderColor: 'divider',\r\n        position: 'relative',\r\n        overflow: 'hidden',\r\n        height: '100%',\r\n        minHeight: '320px'\r\n      }}\r\n    >\r\n      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n          <Typography variant=\"h6\" sx={{ color: 'text.primary', fontWeight: 600, pl: 1 }}>\r\n            Account Balance\r\n          </Typography>\r\n        </Box>\r\n        <Typography\r\n          sx={{\r\n            fontSize: '1.5rem',\r\n            fontWeight: 700,\r\n            color: 'text.primary',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 0.5\r\n          }}\r\n        >\r\n          <Box component=\"span\" sx={{ fontSize: '1.1rem', color: 'text.secondary', fontWeight: 500 }}>$</Box>\r\n          {balance.toLocaleString()}\r\n        </Typography>\r\n      </Box>\r\n\r\n      <Box sx={{\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'space-between',\r\n        backgroundColor: theme => alpha(theme.palette.background.default, 0.5),\r\n        p: 1.5,\r\n        borderRadius: 1.5,\r\n        mt: 0.5\r\n      }}>\r\n        <Box>\r\n          <Typography\r\n            variant=\"body2\"\r\n            sx={{\r\n              color: 'text.secondary',\r\n              mb: 0.5,\r\n              fontWeight: 500\r\n            }}\r\n          >\r\n            Current P&L\r\n          </Typography>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              fontSize: '1.2rem',\r\n              color: totalProfit > 0 ? 'success.main' : totalProfit < 0 ? 'error.main' : 'text.secondary',\r\n              fontWeight: 700,\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 0.5\r\n            }}\r\n          >\r\n            ${trades.length > 0 ? Math.abs(totalProfit).toLocaleString() : '0'}\r\n            <Typography\r\n              component=\"span\"\r\n              sx={{\r\n                fontSize: '0.9rem',\r\n                color: totalProfit > 0 ? 'success.main' : totalProfit < 0 ? 'error.main' : 'text.secondary',\r\n                fontWeight: 600\r\n              }}\r\n            >\r\n              ({profitPercentage}%)\r\n            </Typography>\r\n          </Typography>\r\n        </Box>\r\n\r\n        <Box>\r\n          <Typography\r\n            variant=\"body2\"\r\n            sx={{\r\n              color: 'text.secondary',\r\n              mb: 0.5,\r\n              fontWeight: 500,\r\n              textAlign: 'right'\r\n            }}\r\n          >\r\n            Total Value\r\n          </Typography>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              fontSize: '1.2rem',\r\n              color: totalAccountValue > balance ? 'success.main' : totalAccountValue < balance ? 'error.main' : 'text.secondary',\r\n              fontWeight: 700\r\n            }}\r\n          >\r\n            ${totalAccountValue.toLocaleString()}\r\n          </Typography>\r\n        </Box>\r\n      </Box>\r\n\r\n      {/* Risk Per Trade Section - Always visible but disabled when not configured */}\r\n      <Box sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 1,\r\n        pointerEvents: risk_per_trade ? 'auto' : 'none',\r\n      }}>\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: { xs: 'column', sm: 'row' },\r\n          gap: 1,\r\n          width: '100%'\r\n        }}>\r\n          {/* Risk Per Trade Box */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            backgroundColor: theme => alpha(theme.palette.primary.main, risk_per_trade ? 0.08 : 0.03),\r\n            p: 1.5,\r\n            borderRadius: 1.5,\r\n            flex: 1,\r\n            pointerEvents: risk_per_trade ? 'auto' : 'none',\r\n          }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n              <SecurityIcon sx={{ fontSize: '1rem', color: risk_per_trade ? 'primary.main' : 'text.disabled' }} />\r\n              <Typography\r\n                variant=\"body2\"\r\n                sx={{\r\n                  color: risk_per_trade ? 'text.secondary' : 'text.disabled',\r\n                  fontWeight: 500,\r\n                  fontSize: { xs: '0.75rem', md: '0.8125rem' }\r\n                }}\r\n              >\r\n                Risk ({effectiveRiskPercentage || 0}%)\r\n                {risk_per_trade && dynamicRiskSettings?.dynamic_risk_enabled && effectiveRiskPercentage !== risk_per_trade && (\r\n                  <Box component=\"span\" sx={{ ml: 0.5, color: 'success.main', fontSize: '0.65rem', fontWeight: 700 }}>\r\n                    UP\r\n                  </Box>\r\n                )}\r\n                {!risk_per_trade && (\r\n                  <Box component=\"span\" sx={{ ml: 1, color: 'text.disabled', fontSize: '0.65rem', fontWeight: 600 }}>\r\n                    (N/A)\r\n                  </Box>\r\n                )}\r\n              </Typography>\r\n            </Box>\r\n            <Typography\r\n              variant=\"body1\"\r\n              sx={{\r\n                fontWeight: 600,\r\n                color: risk_per_trade ? 'primary.main' : 'text.disabled',\r\n                fontSize: { xs: '0.9rem', md: '1rem' }\r\n              }}\r\n            >\r\n              ${effectiveRiskPercentage ? ((totalAccountValue * effectiveRiskPercentage) / 100).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'}\r\n            </Typography>\r\n          </Box>\r\n\r\n          {/* Daily Drawdown Box */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            backgroundColor: theme => alpha(theme.palette.error.main, max_daily_drawdown ? 0.08 : 0.03),\r\n            p: 1.5,\r\n            borderRadius: 1.5,\r\n            flex: 1,\r\n            pointerEvents: max_daily_drawdown ? 'auto' : 'none',\r\n          }}>\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n              <DrawdownIcon sx={{ fontSize: '1rem', color: max_daily_drawdown ? 'error.main' : 'text.disabled' }} />\r\n              <Typography\r\n                variant=\"body2\"\r\n                sx={{\r\n                  color: max_daily_drawdown ? 'text.secondary' : 'text.disabled',\r\n                  fontWeight: 500,\r\n                  fontSize: { xs: '0.75rem', md: '0.8125rem' }\r\n                }}\r\n              >\r\n                Daily DD ({max_daily_drawdown || 0}%)\r\n                {!max_daily_drawdown && (\r\n                  <Box component=\"span\" sx={{ ml: 1, color: 'text.disabled', fontSize: '0.65rem', fontWeight: 600 }}>\r\n                    (N/A)\r\n                  </Box>\r\n                )}\r\n              </Typography>\r\n            </Box>\r\n            <Typography\r\n              variant=\"body1\"\r\n              sx={{\r\n                fontWeight: 600,\r\n                color: max_daily_drawdown ? 'error.main' : 'text.disabled',\r\n                fontSize: { xs: '0.9rem', md: '1rem' }\r\n              }}\r\n            >\r\n              ${max_daily_drawdown ? ((totalAccountValue * max_daily_drawdown) / 100).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00'}\r\n            </Typography>\r\n          </Box>\r\n        </Box>\r\n      </Box>\r\n\r\n\r\n      {/* Dynamic Risk Section - Always visible but disabled when not configured */}\r\n      <Box sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 1,\r\n        backgroundColor: theme => alpha(theme.palette.background.default, dynamicRiskSettings?.dynamic_risk_enabled ? 0.5 : 0.2),\r\n        p: 1,\r\n        mt: 1,\r\n        borderRadius: 1.5,\r\n        fontSize: '0.75rem',\r\n        opacity: (dynamicRiskSettings?.dynamic_risk_enabled && dynamicRiskSettings.profit_threshold_percentage && dynamicRiskSettings.increased_risk_percentage) ? 1 : 0.5,\r\n        pointerEvents: (dynamicRiskSettings?.dynamic_risk_enabled && dynamicRiskSettings.profit_threshold_percentage && dynamicRiskSettings.increased_risk_percentage) ? 'auto' : 'none',\r\n      }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n          <Typography variant=\"caption\" sx={{ color: dynamicRiskSettings?.dynamic_risk_enabled ? 'text.secondary' : 'text.disabled' }}>\r\n            Dynamic Risk: {dynamicRiskSettings?.dynamic_risk_enabled && dynamicRiskSettings.profit_threshold_percentage && parseFloat(profitPercentage) >= dynamicRiskSettings.profit_threshold_percentage ?\r\n              <Box component=\"span\" sx={{ color: 'success.main', fontWeight: 600 }}>Active</Box> :\r\n              dynamicRiskSettings?.dynamic_risk_enabled ?\r\n                <Box component=\"span\" sx={{ color: 'text.secondary', fontWeight: 600 }}>Inactive</Box> :\r\n                <Box component=\"span\" sx={{ color: 'text.disabled', fontWeight: 600 }}>Not Configured</Box>}\r\n          </Typography>\r\n          <Typography variant=\"caption\" sx={{ color: dynamicRiskSettings?.dynamic_risk_enabled ? 'text.secondary' : 'text.disabled' }}>\r\n            Threshold: {dynamicRiskSettings?.profit_threshold_percentage || 0}% profit\r\n          </Typography>\r\n        </Box>\r\n\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n          <FormControlLabel\r\n            control={\r\n              <Switch\r\n                checked={isDynamicRiskToggled}\r\n                onChange={isReadOnly ? undefined : (e) => {\r\n                  if (onToggleDynamicRisk) {\r\n                    onToggleDynamicRisk(e.target.checked);\r\n                  }\r\n                }}\r\n                disabled={isReadOnly || !dynamicRiskSettings?.dynamic_risk_enabled}\r\n                size=\"small\"\r\n                color=\"primary\"\r\n              />\r\n            }\r\n            label={\r\n              <Typography variant=\"caption\" sx={{ color: dynamicRiskSettings?.dynamic_risk_enabled ? 'text.secondary' : 'text.disabled' }}>\r\n                {isDynamicRiskToggled ? \"Using actual trade amounts\" : \"Using calculated amounts\"}\r\n              </Typography>\r\n            }\r\n            sx={{ m: 0 }}\r\n          />\r\n          <Tooltip\r\n            title={\r\n              <Box>\r\n                <Typography variant=\"body2\" sx={{ fontWeight: 'bold', mb: 1 }}>\r\n                   Why This Tool Matters\r\n                </Typography>\r\n                <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                  <strong>Discover your true potential:</strong> See how much more profitable you could be with consistent risk management\r\n                </Typography>\r\n                <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                  <strong>Identify position sizing issues:</strong> Compare your actual trades vs. what optimal risk sizing would look like\r\n                </Typography>\r\n                <Typography variant=\"body2\" sx={{ mb: 1 }}>\r\n                  <strong>Improve your discipline:</strong> Understand the impact of inconsistent position sizes on your overall performance\r\n                </Typography>\r\n                <Typography variant=\"body2\" sx={{ color: 'success.main', fontWeight: 'bold' }}>\r\n                   Many traders discover they could be 20-50% more profitable with better risk management!\r\n                </Typography>\r\n              </Box>\r\n            }\r\n            arrow\r\n            placement=\"top\"\r\n            enterDelay={300}\r\n            leaveDelay={200}\r\n          >\r\n            <InfoIcon\r\n              sx={{\r\n                fontSize: 16,\r\n                color: dynamicRiskSettings?.dynamic_risk_enabled ? 'text.secondary' : 'text.disabled',\r\n                cursor: 'help',\r\n                '&:hover': dynamicRiskSettings?.dynamic_risk_enabled ? {\r\n                  color: 'primary.main'\r\n                } : {}\r\n              }}\r\n            />\r\n          </Tooltip>\r\n        </Box>\r\n      </Box>\r\n    </Paper >\r\n  );\r\n};\r\n\r\nexport default React.memo(AccountBalance);\r\n","import React, { useMemo, useState, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Chip,\r\n  alpha,\r\n  useTheme,\r\n  Divider,\r\n  List,\r\n  ListItem,\r\n  ListItemButton,\r\n  Avatar,\r\n  IconButton,\r\n  InputAdornment,\r\n  TextField,\r\n  Stack,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport {\r\n  PushPin as PinIcon,\r\n  Event as EventIcon,\r\n  Search as SearchIcon,\r\n  Clear as ClearIcon,\r\n  StickyNote2 as NoteIcon\r\n} from '@mui/icons-material';\r\nimport { Trade, Calendar, PinnedEvent } from '../types/dualWrite';\r\nimport { EconomicEvent } from '../types/economicCalendar';\r\nimport UnifiedDrawer from './common/UnifiedDrawer';\r\nimport { eventMatchV2 } from '../utils/eventNameUtils';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport EconomicEventDetailDialog from './economicCalendar/EconomicEventDetailDialog';\r\nimport { logger } from '../utils/logger';\r\nimport TradeCard from './aiChat/TradeCard';\r\nimport RoundedTabs, { TabPanel } from './common/RoundedTabs';\r\nimport { TradeOperationsProps } from '../types/tradeOperations';\r\nimport * as calendarService from '../services/calendarService';\r\nimport TradeCardShimmer from './TradeCardShimmer';\r\n\r\ninterface PinnedTradesDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  calendarId: string | undefined;\r\n  onTradeClick?: (trade: Trade, trades: Trade[], title: string) => void;\r\n  tradeOperations: TradeOperationsProps;\r\n}\r\n\r\n// Helper function to get impact colors (matches EconomicEventListItem)\r\nconst getImpactColor = (impact: string | undefined, theme: any) => {\r\n  switch (impact) {\r\n    case 'High':\r\n      return theme.palette.error.main;\r\n    case 'Medium':\r\n      return theme.palette.warning.main;\r\n    case 'Low':\r\n      return theme.palette.success.main;\r\n    default:\r\n      return theme.palette.text.secondary;\r\n  }\r\n};\r\n\r\nconst PinnedTradesDrawer: React.FC<PinnedTradesDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  calendarId,\r\n  onTradeClick,\r\n  tradeOperations\r\n}) => {\r\n  const { calendar } = tradeOperations;\r\n  const theme = useTheme();\r\n\r\n  // Tab state\r\n  const [activeTab, setActiveTab] = useState(0);\r\n\r\n  // Search state\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n\r\n  // Economic event detail dialog state\r\n  const [selectedEvent, setSelectedEvent] = useState<EconomicEvent | null>(null);\r\n  const [eventDetailDialogOpen, setEventDetailDialogOpen] = useState(false);\r\n\r\n  // Pinned trades state\r\n  const [pinnedTrades, setPinnedTrades] = useState<Trade[]>([]);\r\n  const [isLoadingPinned, setIsLoadingPinned] = useState(false);\r\n\r\n  // Fetch pinned trades when drawer opens\r\n  // RLS policies allow public read access for shared calendars\r\n  useEffect(() => {\r\n    const loadPinnedTrades = async () => {\r\n      if (!open || !calendarId) return;\r\n\r\n      setIsLoadingPinned(true);\r\n      try {\r\n        const trades = await calendarService.getTradeRepository().fetchPinnedTrades(calendarId);\r\n        setPinnedTrades(trades);\r\n        logger.log(` Loaded ${trades.length} pinned trades from database`);\r\n      } catch (error) {\r\n        logger.error('Error loading pinned trades:', error);\r\n        setPinnedTrades([]);\r\n      } finally {\r\n        setIsLoadingPinned(false);\r\n      }\r\n    };\r\n\r\n    loadPinnedTrades();\r\n  }, [open, calendarId]);\r\n\r\n  // Get pinned events from calendar\r\n  const pinnedEvents = useMemo(() => {\r\n    return calendar?.pinned_events || [];\r\n  }, [calendar?.pinned_events]);\r\n\r\n  // Sort pinned trades by date (most recent first)\r\n  const sortedPinnedTrades = useMemo(() => {\r\n    return [...pinnedTrades].sort((a, b) => new Date(b.trade_date).getTime() - new Date(a.trade_date).getTime());\r\n  }, [pinnedTrades]);\r\n\r\n  // Filter pinned trades based on search query\r\n  const filteredPinnedTrades = useMemo(() => {\r\n    if (!searchQuery.trim()) return sortedPinnedTrades;\r\n\r\n    const query = searchQuery.toLowerCase().trim();\r\n    return sortedPinnedTrades.filter(trade => {\r\n      // Search in trade name\r\n      if (trade.name?.toLowerCase().includes(query)) return true;\r\n\r\n      // Search in tags\r\n      if (trade.tags?.some(tag => tag.toLowerCase().includes(query))) return true;\r\n\r\n      // Search in session\r\n      if (trade.session?.toLowerCase().includes(query)) return true;\r\n\r\n      // Search in economic events\r\n      if (trade.economic_events?.some(event => event.name.toLowerCase().includes(query))) return true;\r\n\r\n      // Search in notes (if available)\r\n      if (trade.notes?.toLowerCase().includes(query)) return true;\r\n\r\n      return false;\r\n    });\r\n  }, [sortedPinnedTrades, searchQuery]);\r\n\r\n  // Filter pinned events based on search query\r\n  const filteredPinnedEvents = useMemo(() => {\r\n    if (!searchQuery.trim()) return pinnedEvents;\r\n\r\n    const query = searchQuery.toLowerCase().trim();\r\n    return pinnedEvents.filter(pinnedEvent => {\r\n      // Search in event name\r\n      if (pinnedEvent.event.toLowerCase().includes(query)) return true;\r\n\r\n      // Search in notes\r\n      if (pinnedEvent.notes?.toLowerCase().includes(query)) return true;\r\n\r\n      return false;\r\n    });\r\n  }, [pinnedEvents, searchQuery]);\r\n\r\n  // Handle clicking on a pinned event - construct event from stored data\r\n  const handleEventClick = (pinnedEvent: PinnedEvent) => {\r\n    if (!calendar || !pinnedEvent.event_id) {\r\n      logger.warn('Pinned event does not have event_id. Please re-pin the event to get the latest data.');\r\n      return;\r\n    }\r\n\r\n    // Construct EconomicEvent from PinnedEvent data (no fetch needed)\r\n    const event: EconomicEvent = {\r\n      id: pinnedEvent.event_id,\r\n      event_name: pinnedEvent.event,\r\n      currency: pinnedEvent.currency || 'USD',\r\n      impact: pinnedEvent.impact || 'Medium',\r\n      flag_url: pinnedEvent.flag_url,\r\n      country: pinnedEvent.country,\r\n      // Default values for fields not needed by the detail dialog\r\n      actual_result_type: '',\r\n      event_time: '',\r\n      time_utc: '',\r\n      actual_value: '',\r\n      forecast_value: '',\r\n      previous_value: '',\r\n      event_date: ''\r\n    };\r\n\r\n    setSelectedEvent(event);\r\n    setEventDetailDialogOpen(true);\r\n  };\r\n\r\n  // Get dynamic title and icon\r\n  const getTitle = () => {\r\n    return activeTab === 0 ? \"Pinned Trades\" : \"Pinned Events\";\r\n  };\r\n\r\n  const getIcon = () => {\r\n    return activeTab === 0 ? <PinIcon /> : <EventIcon />;\r\n  };\r\n\r\n  return (\r\n    <UnifiedDrawer\r\n      open={open}\r\n      onClose={onClose}\r\n      title={getTitle()}\r\n      icon={getIcon()}\r\n      width={{ xs: '100%', sm: 400 }}\r\n      headerVariant=\"enhanced\"\r\n      contentSx={scrollbarStyles(theme)}\r\n    >\r\n      {/* Tabs */}\r\n      <Box sx={{ p: 2, borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}` }}>\r\n        <RoundedTabs\r\n          tabs={[\r\n            { label: 'Trades' },\r\n            { label: 'Events' }\r\n          ]}\r\n          activeTab={activeTab}\r\n          onTabChange={(_, newValue) => {\r\n            setActiveTab(newValue);\r\n            setSearchQuery(''); // Clear search when switching tabs\r\n          }}\r\n          fullWidth\r\n          size=\"medium\"\r\n        />\r\n      </Box>\r\n\r\n      {/* Search Input */}\r\n      {(\r\n        <Box sx={{\r\n          p: 2,\r\n          borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          backgroundColor: alpha(theme.palette.background.paper, 0.3)\r\n        }}>\r\n          <TextField\r\n            fullWidth\r\n            size=\"small\"\r\n            placeholder={activeTab === 0 ? \"Search pinned trades...\" : \"Search pinned events...\"}\r\n            value={searchQuery}\r\n            onChange={(e: React.ChangeEvent<HTMLInputElement>) => setSearchQuery(e.target.value)}\r\n            InputProps={{\r\n              startAdornment: (\r\n                <InputAdornment position=\"start\">\r\n                  <SearchIcon sx={{ fontSize: 20, color: 'text.secondary' }} />\r\n                </InputAdornment>\r\n              ),\r\n              endAdornment: searchQuery && (\r\n                <InputAdornment position=\"end\">\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={() => setSearchQuery('')}\r\n                    sx={{ color: 'text.secondary' }}\r\n                  >\r\n                    <ClearIcon sx={{ fontSize: 18 }} />\r\n                  </IconButton>\r\n                </InputAdornment>\r\n              )\r\n            }}\r\n            sx={{\r\n              '& .MuiOutlinedInput-root': {\r\n                backgroundColor: alpha(theme.palette.background.paper, 0.5),\r\n                '&:hover': {\r\n                  backgroundColor: alpha(theme.palette.background.paper, 0.8)\r\n                },\r\n                '&.Mui-focused': {\r\n                  backgroundColor: theme.palette.background.paper\r\n                }\r\n              }\r\n            }}\r\n          />\r\n        </Box>\r\n      )}\r\n\r\n      {/* Content */}\r\n      <Box sx={{ flex: 1 }}>\r\n        {/* Render content based on current state */}\r\n        {activeTab === 0 ? (\r\n          // Pinned Trades Tab\r\n          isLoadingPinned ? (\r\n            <TradeCardShimmer count={6} containerSx={{ p: 2 }} />\r\n          ) : sortedPinnedTrades.length === 0 ? (\r\n            <Box\r\n              sx={{\r\n                p: 4,\r\n                textAlign: 'center',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center'\r\n              }}\r\n            >\r\n              <PinIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\r\n              <Typography variant=\"h6\" sx={{ mb: 1, fontWeight: 600, color: 'text.secondary' }}>\r\n                No Pinned Trades\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ textAlign: 'center', maxWidth: 300 }}>\r\n                Pin important trades to keep them easily accessible. Open any trade and click the pin button to add trades here.\r\n              </Typography>\r\n            </Box>\r\n          ) : filteredPinnedTrades.length === 0 ? (\r\n            <Box\r\n              sx={{\r\n                p: 4,\r\n                textAlign: 'center',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center'\r\n              }}\r\n            >\r\n              <SearchIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\r\n              <Typography variant=\"h6\" sx={{ mb: 1, fontWeight: 600, color: 'text.secondary' }}>\r\n                No Matching Trades\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ textAlign: 'center', maxWidth: 300 }}>\r\n                No pinned trades match your search query \"{searchQuery}\". Try adjusting your search terms.\r\n              </Typography>\r\n            </Box>\r\n          ) : (\r\n            <Stack spacing={2} sx={{ p: 2 }}>\r\n              {filteredPinnedTrades.map((trade) => (\r\n                <TradeCard\r\n                  key={trade.id}\r\n                  trade={trade}\r\n                  showTags\r\n                  onClick={() => onTradeClick?.(trade, filteredPinnedTrades, \"Pinned Trades\")}\r\n                />\r\n              ))}\r\n            </Stack>\r\n          )\r\n        ) : (\r\n          // Pinned Events Tab\r\n          pinnedEvents.length === 0 ? (\r\n            <Box\r\n              sx={{\r\n                p: 4,\r\n                textAlign: 'center',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center'\r\n              }}\r\n            >\r\n              <EventIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\r\n              <Typography variant=\"h6\" sx={{ mb: 1, fontWeight: 600, color: 'text.secondary' }}>\r\n                No Pinned Events\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ textAlign: 'center', maxWidth: 300 }}>\r\n                Pin important economic events from the calendar to track trades that occurred during those events.\r\n              </Typography>\r\n            </Box>\r\n          ) : filteredPinnedEvents.length === 0 ? (\r\n            <Box\r\n              sx={{\r\n                p: 4,\r\n                textAlign: 'center',\r\n                height: '100%',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                justifyContent: 'center',\r\n                alignItems: 'center'\r\n              }}\r\n            >\r\n              <SearchIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\r\n              <Typography variant=\"h6\" sx={{ mb: 1, fontWeight: 600, color: 'text.secondary' }}>\r\n                No Matching Events\r\n              </Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ textAlign: 'center', maxWidth: 300 }}>\r\n                No pinned events match your search query \"{searchQuery}\". Try adjusting your search terms.\r\n              </Typography>\r\n            </Box>\r\n          ) : (\r\n            <List sx={{ p: 0 }}>\r\n              {filteredPinnedEvents.map((pinnedEvent, index) => {\r\n                // Note: Trade count for events will be fetched when implementing EconomicCalendarDrawer optimization\r\n                const impactColor = getImpactColor(pinnedEvent.impact, theme);\r\n\r\n                return (\r\n                  <React.Fragment key={pinnedEvent.event}>\r\n                    <ListItem disablePadding>\r\n                      <ListItemButton\r\n                        onClick={() => handleEventClick(pinnedEvent)}\r\n                        sx={{\r\n                          p: 2,\r\n                          backgroundColor: alpha(impactColor, 0.03),\r\n                          borderLeft: `3px solid ${impactColor}`,\r\n                          '&:hover': {\r\n                            backgroundColor: alpha(impactColor, 0.08)\r\n                          }\r\n                        }}\r\n                      >\r\n                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, width: '100%' }}>\r\n                          {/* Event Flag or Icon */}\r\n                          {pinnedEvent.flag_url ? (\r\n                            <img\r\n                              src={pinnedEvent.flag_url}\r\n                              alt={pinnedEvent.country || pinnedEvent.currency || ''}\r\n                              style={{\r\n                                width: 32,\r\n                                height: 24,\r\n                                borderRadius: 4,\r\n                                objectFit: 'cover'\r\n                              }}\r\n                            />\r\n                          ) : (\r\n                            <Avatar\r\n                              sx={{\r\n                                width: 32,\r\n                                height: 32,\r\n                                backgroundColor: alpha(impactColor, 0.1),\r\n                                color: impactColor\r\n                              }}\r\n                            >\r\n                              <EventIcon sx={{ fontSize: 18 }} />\r\n                            </Avatar>\r\n                          )}\r\n\r\n                          {/* Event Content */}\r\n                          <Box sx={{ flex: 1, minWidth: 0 }}>\r\n                            <Typography\r\n                              variant=\"subtitle1\"\r\n                              sx={{\r\n                                fontWeight: 600,\r\n                                color: 'text.primary',\r\n                                overflow: 'hidden',\r\n                                textOverflow: 'ellipsis',\r\n                                whiteSpace: 'nowrap',\r\n                                mb: 0.5\r\n                              }}\r\n                            >\r\n                              {pinnedEvent.event}\r\n                            </Typography>\r\n                          </Box>\r\n\r\n                          {/* Note Icon */}\r\n                          {pinnedEvent.notes && (\r\n                            <Tooltip title={pinnedEvent.notes} arrow placement=\"top\">\r\n                              <NoteIcon\r\n                                sx={{\r\n                                  fontSize: 18,\r\n                                  color: alpha(theme.palette.info.main, 0.7),\r\n                                  cursor: 'pointer'\r\n                                }}\r\n                              />\r\n                            </Tooltip>\r\n                          )}\r\n                        </Box>\r\n                      </ListItemButton>\r\n                    </ListItem>\r\n                    {index < filteredPinnedEvents.length - 1 && <Divider />}\r\n                  </React.Fragment>\r\n                );\r\n              })}\r\n            </List>\r\n          )\r\n        )}\r\n      </Box>\r\n\r\n      {/* Economic Event Detail Dialog */}\r\n      {selectedEvent && calendar && (\r\n        <EconomicEventDetailDialog\r\n          open={eventDetailDialogOpen}\r\n          onClose={() => {\r\n            setEventDetailDialogOpen(false);\r\n            setSelectedEvent(null);\r\n          }}\r\n          event={selectedEvent}\r\n          calendarId={calendar.id}\r\n          tradeOperations={tradeOperations}\r\n        />\r\n      )}\r\n    </UnifiedDrawer>\r\n  );\r\n};\r\n\r\nexport default PinnedTradesDrawer;\r\n","import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';\r\nimport {\r\n  Dialog,\r\n  Box,\r\n  IconButton,\r\n  Button,\r\n  Typography,\r\n  useTheme,\r\n  alpha,\r\n  Chip,\r\n  Tooltip,\r\n  Divider,\r\n  List,\r\n  ListItem,\r\n  ListItemButton,\r\n  Alert,\r\n  CircularProgress\r\n} from '@mui/material';\r\nimport {\r\n  Close as CloseIcon,\r\n  ArrowBackIos as ArrowBackIcon,\r\n  ArrowForwardIos as ArrowForwardIcon,\r\n  CalendarToday as CalendarIcon,\r\n  ShowChart as TradeIcon,\r\n  SmartToy as AssistantIcon,\r\n  History as HistoryIcon,\r\n  AddComment as NewChatIcon,\r\n  Delete as DeleteIcon,\r\n  ArrowBack as BackIcon,\r\n  Schedule as ScheduleIcon,\r\n  Edit as EditIcon,\r\n  EditDocument\r\n} from '@mui/icons-material';\r\nimport { AIConversation } from '../types/aiChat';\r\nimport { format } from 'date-fns';\r\nimport { Trade, Calendar } from '../types/dualWrite';\r\nimport { EconomicEvent } from '../types/economicCalendar';\r\nimport { Note } from '../types/note';\r\nimport TradeDetailExpanded from './TradeDetailExpanded';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport { TradeOperationsProps } from '../types/tradeOperations';\r\nimport RoundedTabs, { TabPanel } from './common/RoundedTabs';\r\nimport { useAIChat } from '../hooks/useAIChat';\r\nimport AIChatInterface, { QuestionTemplate } from './aiChat/AIChatInterface';\r\nimport { useAuthState } from '../contexts/AuthStateContext';\r\nimport Shimmer from './Shimmer';\r\nimport EconomicEventDetailDialog from './economicCalendar/EconomicEventDetailDialog';\r\nimport NoteEditorDialog from './notes/NoteEditorDialog';\r\nimport { logger } from '../utils/logger';\r\nimport { Z_INDEX } from '../styles/zIndex';\r\nimport { getTradeRepository } from '../services/calendarService';\r\nimport { useTradeSyncContextOptional } from '../contexts/TradeSyncContext';\r\nimport { normalizeTradeDates } from '../utils/tradeUtils';\r\n\r\ninterface TradeGalleryDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  trades: Trade[];\r\n  initialTradeId?: string;\r\n  setZoomedImage: (url: string, allImages?: string[], initialIndex?: number) => void;\r\n  title?: string;\r\n  calendarId?: string;\r\n  // Calendar data for economic events filtering\r\n  calendar?: Calendar;\r\n  // AI-only mode: starts on Assistant tab\r\n  aiOnlyMode?: boolean;\r\n  isReadOnly?: boolean;\r\n  // Fetch mode: if set, dialog will fetch trades for this year when trades array is empty\r\n  fetchYear?: number;\r\n\r\n  // Trade operations - required\r\n  tradeOperations: TradeOperationsProps;\r\n}\r\n\r\n// Page size for paginated fetching\r\nconst GALLERY_PAGE_SIZE = 20;\r\n\r\nconst TradeGalleryDialog: React.FC<TradeGalleryDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  trades,\r\n  initialTradeId,\r\n  setZoomedImage,\r\n  title = \"Trade Gallery\",\r\n  calendarId,\r\n  calendar,\r\n  aiOnlyMode = false,\r\n  isReadOnly = false,\r\n  fetchYear,\r\n  tradeOperations\r\n}) => {\r\n  // Destructure from tradeOperations directly\r\n  const {\r\n    onUpdateTradeProperty,\r\n    onOpenGalleryMode,\r\n    onEditTrade,\r\n    onDeleteTrade,\r\n    onDeleteMultipleTrades,\r\n    onUpdateCalendarProperty,\r\n    isTradeUpdating\r\n  } = tradeOperations;\r\n\r\n  // Subscribe to trade sync context for real-time updates\r\n  const tradeSync = useTradeSyncContextOptional();\r\n  const lastProcessedTimestamp = useRef(0);\r\n\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\r\n  // In aiOnlyMode, always show Assistant tab (index 1)\r\n  const [activeTab, setActiveTab] = useState(aiOnlyMode ? 1 : 0);\r\n\r\n  // Fetch mode state - used when trades array is empty and fetchYear is set\r\n  const [internalTrades, setInternalTrades] = useState<Trade[]>([]);\r\n  const [isLoadingTrades, setIsLoadingTrades] = useState(false);\r\n  const [hasMoreTrades, setHasMoreTrades] = useState(false);\r\n  const [currentPage, setCurrentPage] = useState(1);\r\n  // Derive initial total count from calendar year_stats, then update from API response\r\n  const initialTotalCount = fetchYear !== undefined\r\n    ? calendar?.year_stats?.[fetchYear.toString()]?.total_trades ?? 0\r\n    : 0;\r\n  const [totalTradeCount, setTotalTradeCount] = useState(initialTotalCount);\r\n\r\n  // Determine if we're in fetch mode (no trades provided but fetchYear is set)\r\n  const isFetchMode = trades.length === 0 && fetchYear !== undefined && calendarId !== undefined;\r\n\r\n  // Use either provided trades or internally fetched trades\r\n  const effectiveTrades = isFetchMode ? internalTrades : trades;\r\n\r\n  // Find initial index based on initialTradeId\r\n  const initialIndex = useMemo(() => {\r\n    if (!initialTradeId) return 0;\r\n    const index = effectiveTrades.findIndex(trade => trade.id === initialTradeId);\r\n    return index >= 0 ? index : 0;\r\n  }, [effectiveTrades, initialTradeId]);\r\n\r\n  const [currentIndex, setCurrentIndex] = useState(initialIndex);\r\n\r\n  // Update current index when initialTradeId changes\r\n  useEffect(() => {\r\n    setCurrentIndex(initialIndex);\r\n  }, [initialIndex]);\r\n\r\n  // Ensure currentIndex is within bounds (might be stale from previous session)\r\n  const safeCurrentIndex = useMemo(() => {\r\n    if (effectiveTrades.length === 0) return 0;\r\n    return Math.min(Math.max(0, currentIndex), effectiveTrades.length - 1);\r\n  }, [currentIndex, effectiveTrades.length]);\r\n\r\n  // Get current trade using safe index\r\n  const currentTrade = useMemo(() => {\r\n    if (effectiveTrades.length === 0) return null;\r\n    return effectiveTrades[safeCurrentIndex] || null;\r\n  }, [effectiveTrades, safeCurrentIndex]);\r\n\r\n  // Fetch initial trades when in fetch mode and dialog opens\r\n  useEffect(() => {\r\n    const fetchInitialTrades = async () => {\r\n      if (!isFetchMode || !open || !calendarId || fetchYear === undefined) return;\r\n\r\n      // Don't re-fetch if we already have trades\r\n      if (internalTrades.length > 0) return;\r\n\r\n      setIsLoadingTrades(true);\r\n      try {\r\n        const result = await getTradeRepository().getTradesForYearPaginated(\r\n          calendarId,\r\n          fetchYear,\r\n          1,\r\n          GALLERY_PAGE_SIZE\r\n        );\r\n\r\n        setInternalTrades(result.trades);\r\n        setHasMoreTrades(result.hasMore);\r\n        setCurrentPage(1);\r\n        setTotalTradeCount(result.totalCount);\r\n        setCurrentIndex(0);\r\n\r\n        logger.log(` Gallery: Initial fetch - ${result.trades.length} trades, hasMore: ${result.hasMore}, total: ${result.totalCount}`);\r\n      } catch (error) {\r\n        logger.error('Error fetching initial trades:', error);\r\n      } finally {\r\n        setIsLoadingTrades(false);\r\n      }\r\n    };\r\n\r\n    fetchInitialTrades();\r\n  }, [isFetchMode, open, calendarId, fetchYear]);\r\n\r\n  // Load more trades when approaching the end (within last 2 trades)\r\n  const loadMoreTrades = useCallback(async () => {\r\n    if (!isFetchMode || isLoadingTrades || !hasMoreTrades || !calendarId || fetchYear === undefined) {\r\n      return;\r\n    }\r\n\r\n    setIsLoadingTrades(true);\r\n    try {\r\n      const nextPage = currentPage + 1;\r\n      const result = await getTradeRepository().getTradesForYearPaginated(\r\n        calendarId,\r\n        fetchYear,\r\n        nextPage,\r\n        GALLERY_PAGE_SIZE\r\n      );\r\n\r\n      setInternalTrades(prev => [...prev, ...result.trades]);\r\n      setHasMoreTrades(result.hasMore);\r\n      setCurrentPage(nextPage);\r\n\r\n      logger.log(` Gallery: Loaded page ${nextPage} - ${result.trades.length} more trades, hasMore: ${result.hasMore}`);\r\n    } catch (error) {\r\n      logger.error('Error loading more trades:', error);\r\n    } finally {\r\n      setIsLoadingTrades(false);\r\n    }\r\n  }, [isFetchMode, isLoadingTrades, hasMoreTrades, calendarId, fetchYear, currentPage]);\r\n\r\n  // Trigger load more when user is near the end\r\n  useEffect(() => {\r\n    if (!isFetchMode || !hasMoreTrades || isLoadingTrades) return;\r\n\r\n    // Load more when within last 2 trades (use safeCurrentIndex for accurate calculation)\r\n    const tradesRemaining = effectiveTrades.length - safeCurrentIndex - 1;\r\n    if (tradesRemaining <= 1) {\r\n      loadMoreTrades();\r\n    }\r\n  }, [safeCurrentIndex, effectiveTrades.length, isFetchMode, hasMoreTrades, isLoadingTrades, loadMoreTrades]);\r\n\r\n  // Reset internal state when dialog closes, sync totalTradeCount when opening\r\n  useEffect(() => {\r\n    if (!open) {\r\n      setInternalTrades([]);\r\n      setCurrentPage(1);\r\n      setHasMoreTrades(false);\r\n      setTotalTradeCount(initialTotalCount);\r\n    } else {\r\n      // Sync total count from calendar stats when dialog opens\r\n      setTotalTradeCount(initialTotalCount);\r\n    }\r\n  }, [open, initialTotalCount]);\r\n\r\n  // Handle trade sync events from other components (e.g., useCalendarTrades)\r\n  useEffect(() => {\r\n    if (!tradeSync?.lastSyncEvent || !open) return;\r\n\r\n    const { type, trade, timestamp } = tradeSync.lastSyncEvent;\r\n\r\n    // Avoid processing the same event twice\r\n    if (timestamp <= lastProcessedTimestamp.current) return;\r\n    lastProcessedTimestamp.current = timestamp;\r\n\r\n    // Only process events for trades in our calendar\r\n    if (calendarId && trade.calendar_id !== calendarId) return;\r\n\r\n    const normalizedTrade = normalizeTradeDates(trade);\r\n\r\n    // Update internalTrades if in fetch mode\r\n    if (isFetchMode) {\r\n      setInternalTrades(prevTrades => {\r\n        switch (type) {\r\n          case 'update': {\r\n            const tradeIndex = prevTrades.findIndex(t => t.id === trade.id);\r\n            if (tradeIndex === -1) return prevTrades;\r\n\r\n            const updatedTrades = [...prevTrades];\r\n            updatedTrades[tradeIndex] = normalizedTrade;\r\n            logger.log(` Gallery: Synced trade update for ${trade.id}`);\r\n            return updatedTrades;\r\n          }\r\n          case 'delete': {\r\n            const filteredTrades = prevTrades.filter(t => t.id !== trade.id);\r\n            if (filteredTrades.length === prevTrades.length) return prevTrades;\r\n            logger.log(` Gallery: Synced trade delete for ${trade.id}`);\r\n            return filteredTrades;\r\n          }\r\n          default:\r\n            return prevTrades;\r\n        }\r\n      });\r\n    }\r\n  }, [tradeSync?.lastSyncEvent, open, calendarId, isFetchMode]);\r\n\r\n  // History sliding view state (like AIChatDrawer)\r\n  const [showHistoryView, setShowHistoryView] = useState(false);\r\n\r\n  // Economic event detail dialog state\r\n  const [selectedEvent, setSelectedEvent] = useState<EconomicEvent | null>(null);\r\n  const [eventDetailDialogOpen, setEventDetailDialogOpen] = useState(false);\r\n\r\n  // Note editor dialog state\r\n  const [selectedNote, setSelectedNote] = useState<Note | null>(null);\r\n  const [noteEditorOpen, setNoteEditorOpen] = useState(false);\r\n\r\n  // Track previous trade ID to detect trade changes\r\n  const previousTradeIdRef = useRef<string | null>(null);\r\n\r\n  // Reset tab when navigating between trades\r\n  // In normal mode: reset to Trade tab (0)\r\n  // In aiOnlyMode: keep on Assistant tab (1)\r\n  useEffect(() => {\r\n    setActiveTab(aiOnlyMode ? 1 : 0);\r\n    setShowHistoryView(false);\r\n  }, [safeCurrentIndex, aiOnlyMode]);\r\n\r\n  // Initialize AI chat with trade-scoped context\r\n  const aiChat = useAIChat({\r\n    userId: user?.uid,\r\n    calendar: calendar,\r\n    trade: currentTrade || undefined,\r\n    autoSaveConversation: true, // Enable saving for trade-specific conversations\r\n  });\r\n\r\n  // Reset conversation when trade changes (each trade has its own history)\r\n  useEffect(() => {\r\n    const currentTradeId = currentTrade?.id || null;\r\n\r\n    // If trade changed, reset the conversation\r\n    if (previousTradeIdRef.current !== null && previousTradeIdRef.current !== currentTradeId) {\r\n      aiChat.setMessages([]);\r\n      setShowHistoryView(false);\r\n    }\r\n\r\n    previousTradeIdRef.current = currentTradeId;\r\n  }, [currentTrade?.id, aiChat.setMessages]);\r\n\r\n  // Load trade-specific conversations when switching to Assistant tab\r\n  useEffect(() => {\r\n    if (activeTab === 1 && currentTrade?.id && user?.uid) {\r\n      aiChat.loadConversations();\r\n    }\r\n  }, [activeTab, currentTrade?.id, user?.uid, aiChat.loadConversations]);\r\n\r\n  // Single trade context for AI to focus on\r\n  const tradeContext = useMemo(() => {\r\n    return currentTrade ? [currentTrade] : [];\r\n  }, [currentTrade]);\r\n\r\n  // Generate trade-specific question templates\r\n  const tradeQuestionTemplates: QuestionTemplate[] = useMemo(() => {\r\n    if (!currentTrade) return [];\r\n\r\n    const tradeName = currentTrade.name || 'this trade';\r\n    const tradeType = currentTrade.trade_type;\r\n    const isWin = tradeType === 'win';\r\n    const isLoss = tradeType === 'loss';\r\n\r\n    return [\r\n      {\r\n        category: \"Trade Analysis\",\r\n        questions: [\r\n          `Why did ${tradeName} ${isWin ? 'succeed' : isLoss ? 'fail' : 'break even'}?`,\r\n          `What patterns do you see in this trade's setup?`,\r\n          `Analyze the entry and exit timing for this trade`\r\n        ]\r\n      },\r\n      {\r\n        category: \"Compare & Learn\",\r\n        questions: [\r\n          `Show me similar trades from my history`,\r\n          `How does this trade compare to my winning trades?`,\r\n          `What could I have done differently in this trade?`\r\n        ]\r\n      },\r\n      {\r\n        category: \"Risk & Management\",\r\n        questions: [\r\n          `Was my position size appropriate for this trade?`,\r\n          `Analyze the risk-reward ratio of this trade`,\r\n          `Did I follow my trading rules on this trade?`\r\n        ]\r\n      }\r\n    ];\r\n  }, [currentTrade]);\r\n\r\n  // Handle tab change\r\n  const handleTabChange = useCallback((_: React.SyntheticEvent, newValue: number) => {\r\n    setActiveTab(newValue);\r\n    setShowHistoryView(false);\r\n  }, []);\r\n\r\n  // History handlers (sliding panel approach like AIChatDrawer)\r\n  const handleNewChat = useCallback(async () => {\r\n    await aiChat.startNewChat();\r\n    setShowHistoryView(false);\r\n  }, [aiChat.startNewChat]);\r\n\r\n  const handleSelectConversation = useCallback((conversation: AIConversation) => {\r\n    aiChat.selectConversation(conversation);\r\n    setShowHistoryView(false);\r\n  }, [aiChat.selectConversation]);\r\n\r\n  const handleDeleteConversation = useCallback(async (conversationId: string, event: React.MouseEvent) => {\r\n    event.stopPropagation();\r\n    await aiChat.deleteConversation(conversationId);\r\n  }, [aiChat.deleteConversation]);\r\n\r\n  const getPreviewText = useCallback((conversation: AIConversation): string => {\r\n    const firstUserMessage = conversation.messages.find(msg => msg.role === 'user');\r\n    if (firstUserMessage && firstUserMessage.content) {\r\n      return firstUserMessage.content.substring(0, 80) +\r\n        (firstUserMessage.content.length > 80 ? '...' : '');\r\n    }\r\n    return 'No messages';\r\n  }, []);\r\n\r\n  // Navigation functions\r\n  // Check if we're at the last trade and loading more (use safeCurrentIndex for accurate checks)\r\n  const isAtEnd = safeCurrentIndex >= effectiveTrades.length - 1;\r\n  const isAtStart = safeCurrentIndex <= 0;\r\n  const isLoadingNext = isLoadingTrades && isAtEnd && hasMoreTrades;\r\n  const isLoadingPrev = isLoadingTrades && isAtStart && isFetchMode;\r\n\r\n  const navigateNext = useCallback(() => {\r\n    if (effectiveTrades.length <= 1) return;\r\n    // In fetch mode, don't wrap around - just go to next if available\r\n    if (isFetchMode) {\r\n      if (safeCurrentIndex < effectiveTrades.length - 1) {\r\n        setCurrentIndex(safeCurrentIndex + 1);\r\n      }\r\n    } else {\r\n      // Normal mode - wrap around\r\n      setCurrentIndex((safeCurrentIndex + 1) % effectiveTrades.length);\r\n    }\r\n  }, [effectiveTrades.length, isFetchMode, safeCurrentIndex]);\r\n\r\n  const navigatePrevious = useCallback(() => {\r\n    if (effectiveTrades.length <= 1) return;\r\n    // In fetch mode, don't wrap around\r\n    if (isFetchMode) {\r\n      if (safeCurrentIndex > 0) {\r\n        setCurrentIndex(safeCurrentIndex - 1);\r\n      }\r\n    } else {\r\n      // Normal mode - wrap around\r\n      setCurrentIndex((safeCurrentIndex - 1 + effectiveTrades.length) % effectiveTrades.length);\r\n    }\r\n  }, [effectiveTrades.length, isFetchMode, safeCurrentIndex]);\r\n\r\n  // Scroll functions\r\n  const scrollUp = useCallback(() => {\r\n    if (scrollContainerRef.current) {\r\n      scrollContainerRef.current.scrollBy({\r\n        top: -200,\r\n        behavior: 'smooth'\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  const scrollDown = useCallback(() => {\r\n    if (scrollContainerRef.current) {\r\n      scrollContainerRef.current.scrollBy({\r\n        top: 200,\r\n        behavior: 'smooth'\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  // Handle keyboard navigation\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (!open) return;\r\n\r\n      if (e.key === 'ArrowLeft') {\r\n        e.preventDefault();\r\n        navigatePrevious();\r\n      } else if (e.key === 'ArrowRight') {\r\n        e.preventDefault();\r\n        navigateNext();\r\n      } else if (e.key === 'ArrowUp') {\r\n        e.preventDefault();\r\n        scrollUp();\r\n      } else if (e.key === 'ArrowDown') {\r\n        e.preventDefault();\r\n        scrollDown();\r\n      } else if (e.key === 'Escape') {\r\n        e.preventDefault();\r\n        onClose();\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, [open, navigatePrevious, navigateNext, scrollUp, scrollDown, onClose]);\r\n\r\n  // Determine if we're in initial loading state (fetch mode, loading, no trades yet)\r\n  const isInitialLoading = isFetchMode && isLoadingTrades && effectiveTrades.length === 0;\r\n\r\n  // Only return null if not in fetch mode and no trade\r\n  if (!currentTrade && !isInitialLoading) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Dialog\r\n      open={open}\r\n      onClose={onClose}\r\n      maxWidth=\"md\"\r\n      fullWidth\r\n      sx={{\r\n        zIndex: Z_INDEX.DIALOG_POPUP\r\n      }}\r\n      PaperProps={{\r\n        sx: {\r\n          maxHeight: '90vh',\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          backgroundColor: theme.palette.background.default,\r\n          overflow: 'hidden'\r\n        }\r\n      }}\r\n    >\r\n      {/* Header */}\r\n      <Box sx={{\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'space-between',\r\n        p: 2,\r\n        borderBottom: `1px solid ${theme.palette.divider}`,\r\n        backgroundColor: theme.palette.background.paper\r\n      }}>\r\n\r\n        <Box sx={{ display: 'flex', flex: 1 }}>\r\n          {/* Navigation and Title */}\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, minWidth: 0 }}>\r\n            {/* Previous Button */}\r\n            <Tooltip\r\n              title={isInitialLoading ? \"Loading...\" : isAtStart && isFetchMode ? \"At first trade\" : \"Previous trade ()\"}\r\n              slotProps={{ popper: { sx: { zIndex: Z_INDEX.TOOLTIP } } }}\r\n            >\r\n              <span>\r\n                <IconButton\r\n                  onClick={navigatePrevious}\r\n                  disabled={isInitialLoading || effectiveTrades.length <= 1 || (isAtStart && isFetchMode)}\r\n                  sx={{\r\n                    color: isInitialLoading || effectiveTrades.length <= 1 || (isAtStart && isFetchMode) ? 'text.disabled' : 'text.primary',\r\n                    '&:hover': {\r\n                      backgroundColor: alpha(theme.palette.primary.main, 0.1)\r\n                    }\r\n                  }}\r\n                >\r\n                  <ArrowBackIcon />\r\n                </IconButton>\r\n              </span>\r\n            </Tooltip>\r\n\r\n            {/* Title and Counter */}\r\n            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5, minWidth: 0 }}>\r\n              <Typography variant=\"h6\" sx={{\r\n                fontWeight: 600,\r\n                wordBreak: 'break-word',\r\n                overflowWrap: 'break-word'\r\n              }}>\r\n                {title}\r\n              </Typography>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, flexWrap: 'wrap' }}>\r\n                {isInitialLoading ? (\r\n                  <Shimmer height={24} width={80} borderRadius={12} variant=\"wave\" intensity=\"medium\" />\r\n                ) : (\r\n                  <Chip\r\n                    size=\"small\"\r\n                    label={isFetchMode\r\n                      ? `${safeCurrentIndex + 1} of ${totalTradeCount}`\r\n                      : `${safeCurrentIndex + 1} of ${effectiveTrades.length}`\r\n                    }\r\n                    sx={{\r\n                      backgroundColor: alpha(theme.palette.primary.main, 0.1),\r\n                      color: 'primary.main',\r\n                      fontWeight: 600\r\n                    }}\r\n                  />\r\n                )}\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <CalendarIcon sx={{ fontSize: 16, color: 'text.secondary' }} />\r\n                  {isInitialLoading ? (\r\n                    <Shimmer height={14} width={100} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  ) : (\r\n                    <Typography variant=\"caption\" color=\"text.secondary\" sx={{\r\n                      wordBreak: 'break-word',\r\n                      overflowWrap: 'break-word'\r\n                    }}>\r\n                      {format(new Date(currentTrade!.trade_date), 'MMM d, yyyy')}\r\n                    </Typography>\r\n                  )}\r\n                </Box>\r\n              </Box>\r\n            </Box>\r\n\r\n            {/* Next Button */}\r\n            <Tooltip\r\n              title={isLoadingNext ? \"Loading more trades...\" : isAtEnd && !hasMoreTrades && isFetchMode ? \"At last trade\" : \"Next trade ()\"}\r\n              slotProps={{ popper: { sx: { zIndex: Z_INDEX.TOOLTIP } } }}\r\n            >\r\n              <span>\r\n                <IconButton\r\n                  onClick={navigateNext}\r\n                  disabled={effectiveTrades.length <= 1 || isLoadingNext || (isAtEnd && !hasMoreTrades && isFetchMode)}\r\n                  sx={{\r\n                    color: effectiveTrades.length <= 1 || (isAtEnd && !hasMoreTrades && isFetchMode) ? 'text.disabled' : 'text.primary',\r\n                    '&:hover': {\r\n                      backgroundColor: alpha(theme.palette.primary.main, 0.1)\r\n                    }\r\n                  }}\r\n                >\r\n                  {isLoadingNext ? (\r\n                    <CircularProgress size={20} color=\"primary\" />\r\n                  ) : (\r\n                    <ArrowForwardIcon />\r\n                  )}\r\n                </IconButton>\r\n              </span>\r\n            </Tooltip>\r\n          </Box>\r\n        </Box>\r\n\r\n        {/* Tabs and History Controls */}\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, ml: 2 }}>\r\n          <RoundedTabs\r\n            tabs={[\r\n              { label: 'Trade', icon: <TradeIcon sx={{ fontSize: 18 }} /> },\r\n              { label: 'Assistant', icon: <AssistantIcon sx={{ fontSize: 18 }} /> }\r\n            ]}\r\n            activeTab={activeTab}\r\n            onTabChange={handleTabChange}\r\n            size=\"small\"\r\n          />\r\n\r\n          {/* History controls - only show when on Assistant tab */}\r\n          {activeTab === 1 && (\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, ml: 1 }}>\r\n              <Tooltip\r\n                title=\"New Chat\"\r\n                slotProps={{ popper: { sx: { zIndex: Z_INDEX.TOOLTIP } } }}\r\n              >\r\n                <span>\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handleNewChat}\r\n                    disabled={aiChat.messages.length === 0}\r\n                    sx={{\r\n                      color: 'primary.main',\r\n                      '&:hover': { backgroundColor: alpha(theme.palette.primary.main, 0.1) },\r\n                      '&:disabled': { color: 'text.disabled' }\r\n                    }}\r\n                  >\r\n                    <NewChatIcon sx={{ fontSize: 18 }} />\r\n                  </IconButton>\r\n                </span>\r\n              </Tooltip>\r\n\r\n              <Tooltip\r\n                title={showHistoryView ? \"Back to Chat\" : \"Conversation History\"}\r\n                slotProps={{ popper: { sx: { zIndex: Z_INDEX.TOOLTIP } } }}\r\n              >\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={() => setShowHistoryView(!showHistoryView)}\r\n                  sx={{\r\n                    color: showHistoryView ? 'primary.main' : 'text.secondary',\r\n                    '&:hover': { backgroundColor: alpha(theme.palette.action.hover, 0.5) }\r\n                  }}\r\n                >\r\n                  {showHistoryView ? <BackIcon sx={{ fontSize: 18 }} /> : <HistoryIcon sx={{ fontSize: 18 }} />}\r\n                </IconButton>\r\n              </Tooltip>\r\n            </Box>\r\n          )}\r\n        </Box>\r\n\r\n        {/* Close Button */}\r\n        <IconButton\r\n          onClick={onClose}\r\n          sx={{\r\n            color: 'text.secondary',\r\n            '&:hover': {\r\n              backgroundColor: alpha(theme.palette.error.main, 0.1),\r\n              color: 'error.main'\r\n            }\r\n          }}\r\n        >\r\n          <CloseIcon />\r\n        </IconButton>\r\n      </Box>\r\n\r\n      {/* Tab Content */}\r\n      {/* Trade Details */}\r\n      <TabPanel value={activeTab} index={0}>\r\n        <Box\r\n          ref={scrollContainerRef}\r\n          sx={{\r\n            overflow: 'auto',\r\n            maxHeight: 'calc(90vh - 180px)',\r\n            ...scrollbarStyles(theme)\r\n          }}\r\n        >\r\n          {isInitialLoading ? (\r\n            // Shimmer loading state matching TradeDetailExpanded structure\r\n            <Box sx={{ p: 3, display: 'flex', flexDirection: 'column', gap: 3 }}>\r\n              {/* Trade name row: Icon + Name + Action buttons */}\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n                  <Shimmer height={28} width={28} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                  <Shimmer height={28} width={120} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                </Box>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                  <Shimmer height={32} width={32} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n                  <Shimmer height={32} width={32} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n                  <Shimmer height={32} width={32} borderRadius=\"50%\" variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n              </Box>\r\n\r\n              {/* Properties Section Header */}\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                <Shimmer height={16} width={16} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                <Shimmer height={16} width={80} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n              </Box>\r\n\r\n              {/* Properties 2x2 Grid */}\r\n              <Box sx={{\r\n                display: 'grid',\r\n                gridTemplateColumns: { xs: '1fr', sm: '1fr 1fr' },\r\n                gap: 2\r\n              }}>\r\n                {/* PnL Card */}\r\n                <Box sx={{\r\n                  p: 2,\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n                  border: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n                }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1 }}>\r\n                    <Shimmer height={14} width={14} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                    <Shimmer height={14} width={30} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  </Box>\r\n                  <Shimmer height={28} width={80} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                </Box>\r\n\r\n                {/* Date Card */}\r\n                <Box sx={{\r\n                  p: 2,\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n                  border: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n                }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1 }}>\r\n                    <Shimmer height={14} width={14} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                    <Shimmer height={14} width={35} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  </Box>\r\n                  <Shimmer height={20} width={130} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                </Box>\r\n\r\n                {/* Risk to Reward Card */}\r\n                <Box sx={{\r\n                  p: 2,\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n                  border: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n                }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1 }}>\r\n                    <Shimmer height={14} width={14} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                    <Shimmer height={14} width={90} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  </Box>\r\n                  <Shimmer height={24} width={40} borderRadius={4} variant=\"wave\" intensity=\"medium\" sx={{ mb: 0.5 }} />\r\n                  <Shimmer height={14} width={120} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n\r\n                {/* Session Card */}\r\n                <Box sx={{\r\n                  p: 2,\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n                  border: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n                }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5, mb: 1 }}>\r\n                    <Shimmer height={14} width={14} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                    <Shimmer height={14} width={55} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  </Box>\r\n                  <Shimmer height={20} width={60} borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                </Box>\r\n              </Box>\r\n\r\n              {/* Images Section */}\r\n              <Box>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>\r\n                  <Shimmer height={16} width={16} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  <Shimmer height={16} width={55} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n                <Box sx={{ display: 'flex', gap: 2 }}>\r\n                  <Shimmer height={100} width=\"100%\" borderRadius={2} variant=\"wave\" intensity=\"medium\" sx={{ flex: 1 }} />\r\n                  <Shimmer height={100} width=\"100%\" borderRadius={2} variant=\"wave\" intensity=\"medium\" sx={{ flex: 1 }} />\r\n                  <Shimmer height={100} width=\"100%\" borderRadius={2} variant=\"wave\" intensity=\"medium\" sx={{ flex: 1 }} />\r\n                </Box>\r\n              </Box>\r\n\r\n              {/* Tags Section */}\r\n              <Box>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                    <Shimmer height={16} width={16} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                    <Shimmer height={16} width={40} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  </Box>\r\n                  <Shimmer height={20} width={20} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n                <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>\r\n                  {[140, 180, 100, 160, 80, 100, 80, 120].map((width, i) => (\r\n                    <Shimmer key={i} height={28} width={width} borderRadius={14} variant=\"wave\" intensity=\"medium\" />\r\n                  ))}\r\n                </Box>\r\n              </Box>\r\n\r\n              {/* Economic Events Section */}\r\n              <Box>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 2 }}>\r\n                  <Shimmer height={16} width={16} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                  <Shimmer height={16} width={180} borderRadius={4} variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>\r\n                  <Shimmer height={40} width=\"100%\" borderRadius={8} variant=\"wave\" intensity=\"low\" />\r\n                  <Shimmer height={40} width=\"100%\" borderRadius={8} variant=\"wave\" intensity=\"low\" />\r\n                </Box>\r\n              </Box>\r\n            </Box>\r\n          ) : currentTrade ? (\r\n            <TradeDetailExpanded\r\n              tradeData={currentTrade}\r\n              isExpanded={true}\r\n              animate={false}\r\n              trades={trades}\r\n              tradeOperations={tradeOperations}\r\n              showAIButton={false}\r\n            />\r\n          ) : null}\r\n        </Box>\r\n      </TabPanel>\r\n\r\n      <TabPanel value={activeTab} index={1}>\r\n        {/* AI Assistant - Sliding Pager (Chat + History) */}\r\n        <Box\r\n          sx={{\r\n            height: 'calc(90vh - 180px)',\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            overflow: 'hidden',\r\n            position: 'relative'\r\n          }}\r\n        >\r\n          {/* Pager Container */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            width: '200%',\r\n            height: '100%',\r\n            transform: showHistoryView ? 'translateX(-50%)' : 'translateX(0)',\r\n            transition: 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)'\r\n          }}>\r\n            {/* Chat View */}\r\n            <Box sx={{\r\n              width: '50%',\r\n              height: '100%',\r\n              display: 'flex',\r\n              flexDirection: 'column',\r\n              overflow: 'hidden'\r\n            }}>\r\n              <AIChatInterface\r\n                {...aiChat}\r\n                userId={user?.uid}\r\n                calendar={calendar}\r\n                trades={tradeContext}\r\n                questionTemplates={tradeQuestionTemplates}\r\n                autoScroll={aiChat.messages.length > 0}\r\n                onTradeClick={(tradeId, contextTrades) => {\r\n                  // Navigate to the trade within the gallery\r\n                  const tradeIndex = effectiveTrades.findIndex(t => t.id === tradeId);\r\n                  if (tradeIndex >= 0 && effectiveTrades.length <= 5) {\r\n                    setCurrentIndex(tradeIndex);\r\n                    setActiveTab(0); // Switch to Trade tab\r\n                  } else if (onOpenGalleryMode) {\r\n                    // Trade not in current gallery, open new gallery\r\n                    onOpenGalleryMode(contextTrades, tradeId, 'AI Chat - Trade Gallery');\r\n                  } else {\r\n                    logger.log('Trade clicked but not found in gallery:', tradeId);\r\n                  }\r\n                }}\r\n                onEventClick={(event) => {\r\n                  logger.log('Economic event clicked:', event);\r\n                  setSelectedEvent(event);\r\n                  setEventDetailDialogOpen(true);\r\n                }}\r\n                onNoteClick={(noteId, note) => {\r\n                  logger.log('Note clicked:', noteId);\r\n                  if (note) {\r\n                    setSelectedNote(note);\r\n                    setNoteEditorOpen(true);\r\n                  } else {\r\n                    logger.warn('Note not found in embedded notes:', noteId);\r\n                  }\r\n                }}\r\n                isReadOnly={isReadOnly}\r\n              />\r\n            </Box>\r\n\r\n            {/* History View */}\r\n            <Box sx={{\r\n              width: '50%',\r\n              height: '100%',\r\n              display: 'flex',\r\n              flexDirection: 'column',\r\n              overflow: 'hidden'\r\n            }}>\r\n              {/* History Header */}\r\n              <Box sx={{\r\n                p: 2,\r\n                borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n                backgroundColor: alpha(theme.palette.background.paper, 0.8)\r\n              }}>\r\n                <Typography variant=\"subtitle1\" sx={{ fontWeight: 600 }}>\r\n                  Conversation History\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  {aiChat.conversations.length} conversation{aiChat.conversations.length !== 1 ? 's' : ''} for this trade\r\n                </Typography>\r\n              </Box>\r\n\r\n              {/* History Content */}\r\n              <Box sx={{\r\n                flex: 1,\r\n                overflow: 'auto',\r\n                ...scrollbarStyles(theme)\r\n              }}>\r\n                {aiChat.loadingConversations ? (\r\n                  <List sx={{ p: 0 }}>\r\n                    {Array.from({ length: 5 }).map((_, index) => (\r\n                      <React.Fragment key={index}>\r\n                        <ListItem sx={{ py: 2, px: 2 }}>\r\n                          <Box sx={{ width: '100%' }}>\r\n                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\r\n                              <Shimmer height={20} width=\"60%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n                              <Shimmer height={20} width={60} borderRadius={10} variant=\"pulse\" intensity=\"low\" />\r\n                            </Box>\r\n                            <Shimmer height={16} width=\"90%\" borderRadius={4} variant=\"default\" intensity=\"low\" sx={{ mb: 0.5 }} />\r\n                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                              <Shimmer height={14} width={120} borderRadius={4} variant=\"default\" intensity=\"low\" />\r\n                            </Box>\r\n                          </Box>\r\n                        </ListItem>\r\n                        {index < 4 && <Divider />}\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </List>\r\n                ) : aiChat.conversations.length === 0 ? (\r\n                  <Box sx={{ p: 3 }}>\r\n                    <Alert severity=\"info\">\r\n                      No conversation history yet. Start chatting with the AI to create your first conversation for this trade!\r\n                    </Alert>\r\n                  </Box>\r\n                ) : (\r\n                  <List sx={{ p: 0 }}>\r\n                    {aiChat.conversations.map((conversation, index) => (\r\n                      <React.Fragment key={conversation.id}>\r\n                        <ListItem disablePadding>\r\n                          <ListItemButton\r\n                            onClick={() => handleSelectConversation(conversation)}\r\n                            sx={{\r\n                              py: 2,\r\n                              px: 2,\r\n                              display: 'flex',\r\n                              alignItems: 'flex-start',\r\n                              gap: 1,\r\n                              '&:hover': {\r\n                                backgroundColor: alpha(theme.palette.primary.main, 0.08)\r\n                              }\r\n                            }}\r\n                          >\r\n                            <Box sx={{ flex: 1, minWidth: 0 }}>\r\n                              {/* Title and chip */}\r\n                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5 }}>\r\n                                <Typography\r\n                                  variant=\"subtitle1\"\r\n                                  sx={{\r\n                                    fontWeight: 600,\r\n                                    fontSize: '0.95rem',\r\n                                    flex: 1,\r\n                                    overflow: 'hidden',\r\n                                    textOverflow: 'ellipsis',\r\n                                    whiteSpace: 'nowrap'\r\n                                  }}\r\n                                >\r\n                                  {conversation.title}\r\n                                </Typography>\r\n                                <Chip\r\n                                  label={`${conversation.message_count} msgs`}\r\n                                  size=\"small\"\r\n                                  sx={{\r\n                                    height: 20,\r\n                                    fontSize: '0.7rem',\r\n                                    backgroundColor: alpha(theme.palette.primary.main, 0.1),\r\n                                    color: 'primary.main'\r\n                                  }}\r\n                                />\r\n                              </Box>\r\n\r\n                              {/* Preview text */}\r\n                              <Typography\r\n                                variant=\"body2\"\r\n                                color=\"text.secondary\"\r\n                                sx={{\r\n                                  fontSize: '0.85rem',\r\n                                  overflow: 'hidden',\r\n                                  textOverflow: 'ellipsis',\r\n                                  display: '-webkit-box',\r\n                                  WebkitLineClamp: 2,\r\n                                  WebkitBoxOrient: 'vertical',\r\n                                  mb: 0.5\r\n                                }}\r\n                              >\r\n                                {getPreviewText(conversation)}\r\n                              </Typography>\r\n\r\n                              {/* Date */}\r\n                              <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                                <ScheduleIcon sx={{ fontSize: 14, color: 'text.disabled' }} />\r\n                                <Typography variant=\"caption\" color=\"text.disabled\">\r\n                                  {format(conversation.updated_at, 'MMM d, yyyy  h:mm a')}\r\n                                </Typography>\r\n                              </Box>\r\n                            </Box>\r\n\r\n                            {/* Delete button */}\r\n                            <IconButton\r\n                              onClick={(e) => handleDeleteConversation(conversation.id, e)}\r\n                              size=\"small\"\r\n                              sx={{\r\n                                color: 'error.main',\r\n                                flexShrink: 0,\r\n                                mt: 0.5,\r\n                                '&:hover': {\r\n                                  backgroundColor: alpha(theme.palette.error.main, 0.1)\r\n                                }\r\n                              }}\r\n                            >\r\n                              <DeleteIcon fontSize=\"small\" />\r\n                            </IconButton>\r\n                          </ListItemButton>\r\n                        </ListItem>\r\n                        {index < aiChat.conversations.length - 1 && <Divider />}\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </List>\r\n                )}\r\n              </Box>\r\n            </Box>\r\n          </Box>\r\n        </Box>\r\n      </TabPanel>\r\n\r\n      {/* Economic Event Detail Dialog */}\r\n      {selectedEvent && calendar && (\r\n        <EconomicEventDetailDialog\r\n          open={eventDetailDialogOpen}\r\n          onClose={() => {\r\n            setEventDetailDialogOpen(false);\r\n            setSelectedEvent(null);\r\n          }}\r\n          event={selectedEvent}\r\n          calendarId={calendar.id}\r\n          tradeOperations={tradeOperations}\r\n          isReadOnly={isReadOnly}\r\n        />\r\n      )}\r\n\r\n      {/* Note Editor Dialog */}\r\n      {noteEditorOpen && selectedNote && calendarId && (\r\n        <NoteEditorDialog\r\n          open={noteEditorOpen}\r\n          onClose={() => {\r\n            setNoteEditorOpen(false);\r\n            setSelectedNote(null);\r\n          }}\r\n          note={selectedNote}\r\n          calendarId={calendarId}\r\n          onSave={(updatedNote) => {\r\n            // Update the note in embedded notes across all messages\r\n            aiChat.setMessages(prevMessages =>\r\n              prevMessages.map(msg => {\r\n                if (msg.embeddedNotes && msg.embeddedNotes[updatedNote.id]) {\r\n                  return {\r\n                    ...msg,\r\n                    embeddedNotes: {\r\n                      ...msg.embeddedNotes,\r\n                      [updatedNote.id]: updatedNote\r\n                    }\r\n                  };\r\n                }\r\n                return msg;\r\n              })\r\n            );\r\n          }}\r\n          onDelete={(noteId) => {\r\n            // Remove the note from embedded notes across all messages\r\n            aiChat.setMessages(prevMessages =>\r\n              prevMessages.map(msg => {\r\n                if (msg.embeddedNotes && msg.embeddedNotes[noteId]) {\r\n                  const { [noteId]: _, ...remainingNotes } = msg.embeddedNotes;\r\n                  return {\r\n                    ...msg,\r\n                    embeddedNotes: remainingNotes\r\n                  };\r\n                }\r\n                return msg;\r\n              })\r\n            );\r\n            setNoteEditorOpen(false);\r\n            setSelectedNote(null);\r\n          }}\r\n        />\r\n      )}\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default TradeGalleryDialog;\r\n","/**\r\n * NoteCard Component\r\n * Displays a compact note card for the stacked widget\r\n * Supports stacked and fanned animation states\r\n */\r\n\r\nimport React from 'react';\r\nimport { Box, Typography, alpha, useTheme, Theme, keyframes } from '@mui/material';\r\nimport {\r\n  pink,\r\n  purple,\r\n  deepPurple,\r\n  indigo,\r\n  lightBlue,\r\n  cyan,\r\n  teal,\r\n  lightGreen,\r\n  lime,\r\n  yellow,\r\n  amber,\r\n  deepOrange,\r\n  brown,\r\n  grey,\r\n  blueGrey,\r\n} from '@mui/material/colors';\r\nimport { Note } from '../../types/note';\r\n\r\ninterface NoteCardProps {\r\n  note: Note;\r\n  index: number;\r\n  totalCards: number;\r\n  isHovered: boolean;\r\n  hasAnimated: boolean;\r\n}\r\n\r\n// Entry animation - slide up with opacity and scale (doesn't affect positioning transform)\r\nconst slideInAnimation = keyframes`\r\n  0% {\r\n    opacity: 0;\r\n    filter: blur(4px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    filter: blur(0px);\r\n  }\r\n`;\r\n\r\n// Separate animation for the slide-up effect on the wrapper\r\nconst slideUpAnimation = keyframes`\r\n  0% {\r\n    transform: translateY(40px);\r\n  }\r\n  60% {\r\n    transform: translateY(-4px);\r\n  }\r\n  80% {\r\n    transform: translateY(2px);\r\n  }\r\n  100% {\r\n    transform: translateY(0);\r\n  }\r\n`;\r\n\r\n// Color mapping - reused from CalendarDayReminder\r\nconst getColorMap = (theme: Theme): Record<string, string> => ({\r\n  'red': theme.palette.error.main,\r\n  'pink': pink[500],\r\n  'purple': purple[500],\r\n  'deepPurple': deepPurple[500],\r\n  'indigo': indigo[500],\r\n  'blue': theme.palette.info.main,\r\n  'lightBlue': lightBlue[500],\r\n  'cyan': cyan[500],\r\n  'teal': teal[500],\r\n  'green': theme.palette.success.main,\r\n  'lightGreen': lightGreen[500],\r\n  'lime': lime[500],\r\n  'yellow': yellow[600],\r\n  'amber': amber[500],\r\n  'orange': theme.palette.warning.main,\r\n  'deepOrange': deepOrange[500],\r\n  'brown': brown[500],\r\n  'grey': grey[500],\r\n  'blueGrey': blueGrey[500],\r\n});\r\n\r\nconst NoteCard: React.FC<NoteCardProps> = ({ note, index, totalCards, isHovered, hasAnimated }) => {\r\n  const theme = useTheme();\r\n  const colorMap = getColorMap(theme);\r\n  const isDark = theme.palette.mode === 'dark';\r\n\r\n  // Use note color for full background, default to a neutral dark color\r\n  const baseColor = note.color ? colorMap[note.color] || theme.palette.grey[700] : theme.palette.grey[700];\r\n\r\n  // Calculate transform based on state\r\n  // Stacked: each card offset slightly down and right\r\n  // Fanned: cards spread out with rotation\r\n  const stackedTransform = `translateY(${index * 6}px) translateX(${index * 3}px)`;\r\n  const fannedTransform = `rotate(${(index - Math.floor(totalCards / 2)) * 12}deg) translateX(${index * 35}px) translateY(-${index * 5}px)`;\r\n\r\n  // Z-index: reversed so first card appears on top when stacked\r\n  const zIndex = totalCards - index;\r\n  // Calculate staggered animation delay - cards appear one after another\r\n  const animationDelay = `${index * 0.1}s`;\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        position: 'absolute',\r\n        // Initial state and entry slide-up animation wrapper\r\n        ...(hasAnimated && {\r\n          animation: `${slideUpAnimation} 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) ${animationDelay} both`,\r\n        }),\r\n      }}\r\n    >\r\n      <Box\r\n        sx={{\r\n          width: 72,\r\n          height: 90,\r\n          borderRadius: 1.5,\r\n          overflow: 'hidden',\r\n          backgroundColor: alpha(baseColor, isDark ? 0.85 : 0.9),\r\n          boxShadow: isDark\r\n            ? `0 4px 12px ${alpha(theme.palette.common.black, 0.4)}`\r\n            : `0 4px 12px ${alpha(theme.palette.common.black, 0.15)}`,\r\n          border: `1px solid ${alpha(theme.palette.common.white, 0.1)}`,\r\n          transform: isHovered ? fannedTransform : stackedTransform,\r\n          transition: 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)',\r\n          zIndex,\r\n          cursor: 'pointer',\r\n          // Initial state and entry fade/blur animation\r\n          opacity: hasAnimated ? 1 : 0,\r\n          filter: hasAnimated ? 'blur(0px)' : 'blur(4px)',\r\n          ...(hasAnimated && {\r\n            animation: `${slideInAnimation} 0.6s cubic-bezier(0.4, 0, 0.2, 1) ${animationDelay} both`,\r\n          }),\r\n          '&:hover': {\r\n            boxShadow: isDark\r\n              ? `0 6px 16px ${alpha(theme.palette.common.black, 0.5)}`\r\n              : `0 6px 16px ${alpha(theme.palette.common.black, 0.2)}`,\r\n          },\r\n        }}\r\n      >\r\n      {/* Card content */}\r\n      <Box sx={{ p: 1, display: 'flex', flexDirection: 'column', height: '100%' }}>\r\n        {/* Title */}\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            fontWeight: 600,\r\n            color: theme.palette.common.white,\r\n            fontSize: '0.65rem',\r\n            lineHeight: 1.3,\r\n            display: '-webkit-box',\r\n            WebkitLineClamp: 4,\r\n            WebkitBoxOrient: 'vertical',\r\n            overflow: 'hidden',\r\n            textOverflow: 'ellipsis',\r\n            flex: 1,\r\n            textShadow: '0 1px 2px rgba(0,0,0,0.3)',\r\n          }}\r\n        >\r\n          {note.title || 'Untitled'}\r\n        </Typography>\r\n\r\n        {/* Small indicator for multiple notes - only on first card */}\r\n        {totalCards > 1 && index === 0 && (\r\n          <Typography\r\n            variant=\"caption\"\r\n            sx={{\r\n              fontSize: '0.6rem',\r\n              color: alpha(theme.palette.common.white, 0.8),\r\n              mt: 'auto',\r\n              textShadow: '0 1px 2px rgba(0,0,0,0.3)',\r\n            }}\r\n          >\r\n            +{totalCards - 1} more\r\n          </Typography>\r\n        )}\r\n      </Box>\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default NoteCard;\r\n","/**\r\n * PlaceholderNoteCard Component\r\n * Empty placeholder card for visual stacking effect when only 1 note exists\r\n */\r\n\r\nimport React from 'react';\r\nimport { Box, alpha, useTheme, keyframes } from '@mui/material';\r\nimport { Add as AddIcon } from '@mui/icons-material';\r\n\r\ninterface PlaceholderNoteCardProps {\r\n  index: number;\r\n  totalCards: number;\r\n  isHovered: boolean;\r\n  hasAnimated: boolean;\r\n}\r\n\r\n// Entry animation - slide up with opacity and scale\r\nconst slideInAnimation = keyframes`\r\n  0% {\r\n    opacity: 0;\r\n    filter: blur(4px);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    filter: blur(0px);\r\n  }\r\n`;\r\n\r\n// Separate animation for the slide-up effect on the wrapper\r\nconst slideUpAnimation = keyframes`\r\n  0% {\r\n    transform: translateY(40px);\r\n  }\r\n  60% {\r\n    transform: translateY(-4px);\r\n  }\r\n  80% {\r\n    transform: translateY(2px);\r\n  }\r\n  100% {\r\n    transform: translateY(0);\r\n  }\r\n`;\r\n\r\nconst PlaceholderNoteCard: React.FC<PlaceholderNoteCardProps> = ({\r\n  index,\r\n  totalCards,\r\n  isHovered,\r\n  hasAnimated,\r\n}) => {\r\n  const theme = useTheme();\r\n  const isDark = theme.palette.mode === 'dark';\r\n\r\n  // Use a neutral grey color for placeholder cards\r\n  const baseColor = theme.palette.grey[isDark ? 700 : 400];\r\n\r\n  // Calculate transform based on state\r\n  const stackedTransform = `translateY(${index * 6}px) translateX(${index * 3}px)`;\r\n  const fannedTransform = `rotate(${(index - Math.floor(totalCards / 2)) * 12}deg) translateX(${index * 35}px) translateY(-${index * 5}px)`;\r\n\r\n  // Z-index: reversed so first card appears on top when stacked\r\n  const zIndex = totalCards - index;\r\n  // Calculate staggered animation delay - placeholders appear slightly before the main card\r\n  const animationDelay = `${index * 0.1}s`;\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        position: 'absolute',\r\n        // Initial state and entry slide-up animation wrapper\r\n        ...(hasAnimated && {\r\n          animation: `${slideUpAnimation} 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) ${animationDelay} both`,\r\n        }),\r\n      }}\r\n    >\r\n      <Box\r\n        sx={{\r\n          width: 72,\r\n          height: 90,\r\n          borderRadius: 1.5,\r\n          overflow: 'hidden',\r\n          backgroundColor: alpha(baseColor, isDark ? 0.3 : 0.2),\r\n          boxShadow: isDark\r\n            ? `0 4px 12px ${alpha(theme.palette.common.black, 0.3)}`\r\n            : `0 4px 12px ${alpha(theme.palette.common.black, 0.1)}`,\r\n          border: `2px  ${alpha(isDark ? theme.palette.common.white : theme.palette.common.black, 0.3)}`,\r\n          transform: isHovered ? fannedTransform : stackedTransform,\r\n          transition: 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)',\r\n          zIndex,\r\n          cursor: 'pointer',\r\n          // Center the plus icon\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          // Initial state and entry fade/blur animation\r\n          opacity: hasAnimated ? 1 : 0,\r\n          filter: hasAnimated ? 'blur(0px)' : 'blur(4px)',\r\n          ...(hasAnimated && {\r\n            animation: `${slideInAnimation} 0.6s cubic-bezier(0.4, 0, 0.2, 1) ${animationDelay} both`,\r\n          }),\r\n        }}\r\n      >\r\n        {/* <AddIcon\r\n          sx={{\r\n            fontSize: 24,\r\n            color: alpha(isDark ? theme.palette.common.white : theme.palette.common.black, 0.4),\r\n          }}\r\n        /> */}\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default PlaceholderNoteCard;\r\n","/**\r\n * NotesBottomSheet Component\r\n * Bottom sheet modal for viewing and navigating reminder notes\r\n * Slides up from bottom-left, follows AIChatDrawer pattern\r\n */\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  IconButton,\r\n  alpha,\r\n  useTheme,\r\n  Theme,\r\n} from '@mui/material';\r\nimport {\r\n  pink,\r\n  purple,\r\n  deepPurple,\r\n  indigo,\r\n  lightBlue,\r\n  cyan,\r\n  teal,\r\n  lightGreen,\r\n  lime,\r\n  yellow,\r\n  amber,\r\n  deepOrange,\r\n  brown,\r\n  grey,\r\n  blueGrey,\r\n} from '@mui/material/colors';\r\nimport {\r\n  Close as CloseIcon,\r\n  ChevronLeft as ChevronLeftIcon,\r\n  ChevronRight as ChevronRightIcon,\r\n  Edit as EditIcon,\r\n  EventNote as EventNoteIcon,\r\n} from '@mui/icons-material';\r\nimport { Note } from '../../types/note';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport RichTextEditor from '../common/RichTextEditor';\r\nimport NoteEditorDialog from '../notes/NoteEditorDialog';\r\n\r\ninterface NotesBottomSheetProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  notes: Note[];\r\n  initialIndex?: number;\r\n  calendarId: string;\r\n  fullDayName: string;\r\n  onNoteSaved?: (note: Note, isCreated?: boolean) => void;\r\n  onNoteDeleted?: (noteId: string) => void;\r\n}\r\n\r\n// Color mapping\r\nconst getColorMap = (theme: Theme): Record<string, string> => ({\r\n  'red': theme.palette.error.main,\r\n  'pink': pink[500],\r\n  'purple': purple[500],\r\n  'deepPurple': deepPurple[500],\r\n  'indigo': indigo[500],\r\n  'blue': theme.palette.info.main,\r\n  'lightBlue': lightBlue[500],\r\n  'cyan': cyan[500],\r\n  'teal': teal[500],\r\n  'green': theme.palette.success.main,\r\n  'lightGreen': lightGreen[500],\r\n  'lime': lime[500],\r\n  'yellow': yellow[600],\r\n  'amber': amber[500],\r\n  'orange': theme.palette.warning.main,\r\n  'deepOrange': deepOrange[500],\r\n  'brown': brown[500],\r\n  'grey': grey[500],\r\n  'blueGrey': blueGrey[500],\r\n});\r\n\r\nconst NotesBottomSheet: React.FC<NotesBottomSheetProps> = ({\r\n  open,\r\n  onClose,\r\n  notes,\r\n  initialIndex = 0,\r\n  calendarId,\r\n  fullDayName,\r\n  onNoteSaved,\r\n  onNoteDeleted,\r\n}) => {\r\n  const theme = useTheme();\r\n  const isDark = theme.palette.mode === 'dark';\r\n  const colorMap = getColorMap(theme);\r\n\r\n  const [currentIndex, setCurrentIndex] = useState(initialIndex);\r\n  const [editorOpen, setEditorOpen] = useState(false);\r\n  const contentRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Reset index when notes change or sheet opens\r\n  useEffect(() => {\r\n    if (open) {\r\n      setCurrentIndex(Math.min(initialIndex, Math.max(0, notes.length - 1)));\r\n    }\r\n  }, [open, initialIndex, notes.length]);\r\n\r\n  // Scroll to top when switching notes\r\n  useEffect(() => {\r\n    if (contentRef.current) {\r\n      contentRef.current.scrollTop = 0;\r\n    }\r\n  }, [currentIndex]);\r\n\r\n  // Handle keyboard navigation\r\n  useEffect(() => {\r\n    if (!open) return;\r\n\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') {\r\n        onClose();\r\n      } \r\n      // else if (e.key === 'ArrowLeft') {\r\n      //   handlePrevious();\r\n      // } else if (e.key === 'ArrowRight') {\r\n      //   handleNext();\r\n      // }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => window.removeEventListener('keydown', handleKeyDown);\r\n  }, [open, onClose, notes.length]);\r\n\r\n  const handlePrevious = useCallback(() => {\r\n    setCurrentIndex((prev) => (prev > 0 ? prev - 1 : notes.length - 1));\r\n  }, [notes.length]);\r\n\r\n  const handleNext = useCallback(() => {\r\n    setCurrentIndex((prev) => (prev < notes.length - 1 ? prev + 1 : 0));\r\n  }, [notes.length]);\r\n\r\n  const handleEditNote = useCallback(() => {\r\n    setEditorOpen(true);\r\n  }, []);\r\n\r\n  const handleEditorClose = useCallback(() => {\r\n    setEditorOpen(false);\r\n  }, []);\r\n\r\n  const handleNoteSaved = useCallback((savedNote: Note, isCreated?: boolean) => {\r\n    onNoteSaved?.(savedNote, isCreated);\r\n  }, [onNoteSaved]);\r\n\r\n  const handleNoteDeleted = useCallback(() => {\r\n    onNoteDeleted?.(currentNote?.id || '');\r\n    // Close bottom sheet if no more notes\r\n    if (notes.length <= 1) {\r\n      onClose();\r\n    }\r\n  }, [onNoteDeleted, notes.length, onClose]);\r\n\r\n  // Safe access to current note\r\n  const currentNote = notes[currentIndex];\r\n  const hasMultipleNotes = notes.length > 1;\r\n\r\n  if (!currentNote) {\r\n    return null;\r\n  }\r\n\r\n  const baseColor = currentNote.color\r\n    ? colorMap[currentNote.color] || theme.palette.info.main\r\n    : theme.palette.info.main;\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <Box\r\n        onClick={onClose}\r\n        sx={{\r\n          position: 'fixed',\r\n          top: 0,\r\n          left: 0,\r\n          right: 0,\r\n          bottom: 0,\r\n          backgroundColor: alpha(theme.palette.common.black, 0.5),\r\n          backdropFilter: 'blur(4px)',\r\n          zIndex: Z_INDEX.AI_DRAWER_BACKDROP,\r\n          opacity: open ? 1 : 0,\r\n          pointerEvents: open ? 'auto' : 'none',\r\n          transition: 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n          cursor: 'pointer',\r\n        }}\r\n      />\r\n\r\n      {/* Bottom Sheet */}\r\n      <Box\r\n        sx={{\r\n          position: 'fixed',\r\n          bottom: 0,\r\n          left: { xs: 0, sm: 20 },\r\n          right: { xs: 0, sm: 'auto' },\r\n          zIndex: Z_INDEX.AI_DRAWER,\r\n          height: open ? 500 : 0,\r\n          maxHeight: '70vh',\r\n          width: '100%',\r\n          maxWidth: { xs: '100%', sm: '420px' },\r\n          borderTopLeftRadius: 20,\r\n          borderTopRightRadius: 20,\r\n          background: isDark\r\n            ? 'linear-gradient(135deg, rgba(18, 18, 18, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%)'\r\n            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%)',\r\n          backdropFilter: 'blur(20px)',\r\n          boxShadow: isDark\r\n            ? '0 -8px 32px rgba(0, 0, 0, 0.6)'\r\n            : '0 -8px 32px rgba(0, 0, 0, 0.15)',\r\n          border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          borderBottom: 'none',\r\n          transition: 'height 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n          transform: open ? 'translateY(0)' : 'translateY(100%)',\r\n          overflow: 'hidden',\r\n          pointerEvents: open ? 'auto' : 'none',\r\n        }}\r\n      >\r\n        <Box\r\n          sx={{\r\n            height: '100%',\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            overflow: 'hidden',\r\n          }}\r\n        >\r\n          {/* Header */}\r\n          <Box\r\n            sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n              p: 2,\r\n              pb: 1.5,\r\n              borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n              background: alpha(baseColor, isDark ? 0.1 : 0.15),\r\n              borderLeft: `4px solid ${baseColor}`,\r\n            }}\r\n          >\r\n            {/* Left side - Icon and Title */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5 }}>\r\n              <EventNoteIcon sx={{ fontSize: '1.25rem', color: baseColor }} />\r\n              <Box>\r\n                <Typography\r\n                  variant=\"subtitle2\"\r\n                  sx={{\r\n                    fontSize: '0.875rem',\r\n                    color: baseColor,\r\n                    fontWeight: 600,\r\n                    textTransform: 'uppercase',\r\n                    letterSpacing: '0.5px',\r\n                  }}\r\n                >\r\n                  {fullDayName} Reminder\r\n                </Typography>\r\n                {hasMultipleNotes && (\r\n                  <Typography\r\n                    variant=\"caption\"\r\n                    sx={{\r\n                      color: 'text.secondary',\r\n                      fontSize: '0.75rem',\r\n                    }}\r\n                  >\r\n                    {currentIndex + 1} of {notes.length}\r\n                  </Typography>\r\n                )}\r\n              </Box>\r\n            </Box>\r\n\r\n            {/* Right side - Actions */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n              {/* Navigation buttons */}\r\n              {hasMultipleNotes && (\r\n                <>\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handlePrevious}\r\n                    sx={{ color: baseColor }}\r\n                    title=\"Previous ()\"\r\n                  >\r\n                    <ChevronLeftIcon />\r\n                  </IconButton>\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handleNext}\r\n                    sx={{ color: baseColor }}\r\n                    title=\"Next ()\"\r\n                  >\r\n                    <ChevronRightIcon />\r\n                  </IconButton>\r\n                </>\r\n              )}\r\n\r\n              {/* Edit button */}\r\n              <IconButton\r\n                size=\"small\"\r\n                onClick={handleEditNote}\r\n                sx={{ color: 'text.secondary' }}\r\n                title=\"Edit note\"\r\n              >\r\n                <EditIcon fontSize=\"small\" />\r\n              </IconButton>\r\n\r\n              {/* Close button */}\r\n              <IconButton\r\n                size=\"small\"\r\n                onClick={onClose}\r\n                sx={{ color: 'text.secondary' }}\r\n                title=\"Close (Esc)\"\r\n              >\r\n                <CloseIcon fontSize=\"small\" />\r\n              </IconButton>\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Content */}\r\n          <Box\r\n            ref={contentRef}\r\n            sx={{\r\n              flex: 1,\r\n              overflow: 'auto',\r\n              ...scrollbarStyles(theme),\r\n            }}\r\n          >\r\n            {/* Cover Image */}\r\n            {currentNote.cover_image && (\r\n              <Box\r\n                sx={{\r\n                  width: '100%',\r\n                  height: 160,\r\n                  backgroundImage: `url(${currentNote.cover_image})`,\r\n                  backgroundSize: 'cover',\r\n                  backgroundPosition: 'center',\r\n                  backgroundRepeat: 'no-repeat',\r\n                }}\r\n              />\r\n            )}\r\n\r\n            {/* Text Content */}\r\n            <Box sx={{ p: 2 }}>\r\n              {/* Note Title */}\r\n              {currentNote.title && currentNote.title.trim() !== '' && (\r\n                <Typography\r\n                  variant=\"h6\"\r\n                  sx={{\r\n                    fontWeight: 600,\r\n                    color: 'text.primary',\r\n                    mb: 2,\r\n                  }}\r\n                >\r\n                  {currentNote.title}\r\n                </Typography>\r\n              )}\r\n\r\n              {/* Note Content */}\r\n              <Box\r\n                sx={{\r\n                  '& .DraftEditor-root': {\r\n                    fontSize: '0.95rem',\r\n                    lineHeight: 1.6,\r\n                  },\r\n                }}\r\n              >\r\n                <RichTextEditor\r\n                  value={currentNote.content}\r\n                  disabled\r\n                  hideCharacterCount\r\n                  minHeight={200}\r\n                />\r\n              </Box>\r\n            </Box>\r\n          </Box>\r\n        </Box>\r\n      </Box>\r\n\r\n      {/* Note Editor Dialog */}\r\n      <NoteEditorDialog\r\n        open={editorOpen}\r\n        onClose={handleEditorClose}\r\n        note={currentNote}\r\n        calendarId={calendarId}\r\n        onSave={handleNoteSaved}\r\n        onDelete={handleNoteDeleted}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default NotesBottomSheet;\r\n","/**\r\n * StackedNotesWidget Component\r\n * Displays reminder notes as stacked cards in the bottom-left corner\r\n * Hover to fan out cards, click to open bottom sheet\r\n */\r\n\r\nimport React, { useState, useCallback, useEffect } from 'react';\r\nimport { Box } from '@mui/material';\r\nimport { useReminderNotes } from './useReminderNotes';\r\nimport NoteCard from './NoteCard';\r\nimport PlaceholderNoteCard from './PlaceholderNoteCard';\r\nimport NotesBottomSheet from './NotesBottomSheet';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\nimport { Note } from '../../types/note';\r\n\r\ninterface StackedNotesWidgetProps {\r\n  calendarId: string;\r\n}\r\n\r\nconst MAX_VISIBLE_CARDS = 3;\r\n\r\nconst StackedNotesWidget: React.FC<StackedNotesWidgetProps> = ({ calendarId }) => {\r\n  const { notes, isLoading, fullDayName, updateNote, removeNote } = useReminderNotes(calendarId);\r\n  const [isHovered, setIsHovered] = useState(false);\r\n  const [bottomSheetOpen, setBottomSheetOpen] = useState(false);\r\n  const [initialNoteIndex, setInitialNoteIndex] = useState(0);\r\n  const [hasAnimated, setHasAnimated] = useState(false);\r\n\r\n  // Trigger animation on first appearance\r\n  useEffect(() => {\r\n    if (!isLoading && notes.length > 0 && !hasAnimated) {\r\n      setHasAnimated(true);\r\n    }\r\n  }, [isLoading, notes.length, hasAnimated]);\r\n\r\n  // Get visible cards (max 3)\r\n  const visibleNotes = notes.slice(0, MAX_VISIBLE_CARDS);\r\n\r\n  const handleWidgetClick = useCallback(() => {\r\n    setInitialNoteIndex(0);\r\n    setBottomSheetOpen(true);\r\n  }, []);\r\n\r\n  const handleBottomSheetClose = useCallback(() => {\r\n    setBottomSheetOpen(false);\r\n  }, []);\r\n\r\n  // Optimistically update the note in local state\r\n  const handleNoteSaved = useCallback((savedNote: Note) => {\r\n    updateNote(savedNote);\r\n  }, [updateNote]);\r\n\r\n  // Optimistically remove the note from local state\r\n  const handleNoteDeleted = useCallback((noteId: string) => {\r\n    removeNote(noteId);\r\n  }, [removeNote]);\r\n\r\n  // Don't render if loading or no notes\r\n  if (isLoading || notes.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Stacked Cards Widget */}\r\n      <Box\r\n        onClick={handleWidgetClick}\r\n        onMouseEnter={() => setIsHovered(true)}\r\n        onMouseLeave={() => setIsHovered(false)}\r\n        sx={{\r\n          position: 'fixed',\r\n          bottom: { xs: 16, sm: 24 },\r\n          left: { xs: 16, sm: 24 },\r\n          zIndex: Z_INDEX.FLOAT_NAVIGATION,\r\n          cursor: 'pointer',\r\n          // Container size to accommodate fanned cards\r\n          width: isHovered ? 180 : 90,\r\n          height: 110,\r\n          transition: 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n        }}\r\n      >\r\n        {/* Render placeholder cards when there's only 1 note for animation effect */}\r\n        {visibleNotes.length === 1 && (\r\n          <>\r\n            \r\n            <PlaceholderNoteCard\r\n              index={1}\r\n              totalCards={2}\r\n              isHovered={isHovered}\r\n              hasAnimated={hasAnimated}\r\n            />\r\n          </>\r\n        )}\r\n\r\n        {/* Render cards in reverse order so first card is on top */}\r\n        {[...visibleNotes].reverse().map((note, reversedIndex) => {\r\n          const originalIndex = visibleNotes.length - 1 - reversedIndex;\r\n          // When we have only 1 note, render it at index 0 with totalCards=3 for proper stacking\r\n          const displayIndex = visibleNotes.length === 1 ? 0 : originalIndex;\r\n          const displayTotal = visibleNotes.length === 1 ? 3 : visibleNotes.length;\r\n          return (\r\n            <NoteCard\r\n              key={note.id}\r\n              note={note}\r\n              index={displayIndex}\r\n              totalCards={displayTotal}\r\n              isHovered={isHovered}\r\n              hasAnimated={hasAnimated}\r\n            />\r\n          );\r\n        })}\r\n      </Box>\r\n\r\n      {/* Bottom Sheet */}\r\n      <NotesBottomSheet\r\n        open={bottomSheetOpen}\r\n        onClose={handleBottomSheetClose}\r\n        notes={notes}\r\n        initialIndex={initialNoteIndex}\r\n        calendarId={calendarId}\r\n        fullDayName={fullDayName}\r\n        onNoteSaved={handleNoteSaved}\r\n        onNoteDeleted={handleNoteDeleted}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default StackedNotesWidget;\r\n","/**\r\n * useReminderNotes Hook\r\n * Manages reminder notes data fetching and real-time updates\r\n * Extracted from CalendarDayReminder component\r\n */\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { format } from 'date-fns';\r\nimport { Note, DayAbbreviation } from '../../types/note';\r\nimport { getReminderNotesForDay } from '../../services/notesService';\r\nimport { logger } from '../../utils/logger';\r\nimport { useRealtimeSubscription } from '../../hooks/useRealtimeSubscription';\r\n\r\ninterface UseReminderNotesResult {\r\n  notes: Note[];\r\n  isLoading: boolean;\r\n  currentDayAbbr: DayAbbreviation;\r\n  fullDayName: string;\r\n  reloadNotes: () => Promise<void>;\r\n  updateNote: (updatedNote: Note) => void;\r\n  removeNote: (noteId: string) => void;\r\n}\r\n\r\nexport function useReminderNotes(calendarId: string): UseReminderNotesResult {\r\n  const [notes, setNotes] = useState<Note[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  // Get current day abbreviation\r\n  const currentDayAbbr = format(new Date(), 'EEE') as DayAbbreviation;\r\n  const fullDayName = format(new Date(), 'EEEE');\r\n\r\n  // Load reminder notes for current day\r\n  const loadReminderNotes = useCallback(async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      const fetchedNotes = await getReminderNotesForDay(calendarId, currentDayAbbr);\r\n      setNotes(fetchedNotes);\r\n    } catch (error) {\r\n      logger.error('Error loading reminder notes:', error);\r\n      setNotes([]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [calendarId, currentDayAbbr]);\r\n\r\n  // Initial load\r\n  useEffect(() => {\r\n    loadReminderNotes();\r\n  }, [loadReminderNotes]);\r\n\r\n  // Helper to check if a note is a reminder for the current day\r\n  const isReminderForToday = useCallback((note: Note | null): boolean => {\r\n    if (!note || !note.is_reminder_active || note.is_archived) return false;\r\n    if (note.reminder_type === 'weekly' && note.reminder_days?.includes(currentDayAbbr)) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }, [currentDayAbbr]);\r\n\r\n  // Set up real-time subscription for reminder notes changes\r\n  useRealtimeSubscription({\r\n    channelName: `calendar-reminders-${calendarId}`,\r\n    enabled: true,\r\n    onChannelCreated: (channel) => {\r\n      logger.log(` Setting up reminder notes broadcast subscription for calendar-${calendarId}`);\r\n\r\n      // Listen for INSERT events\r\n      channel.on(\r\n        'broadcast',\r\n        { event: 'INSERT' },\r\n        (payload: any) => {\r\n          if (payload.payload?.record) {\r\n            const newNote = payload.payload.record as Note;\r\n            logger.log(` Note added via broadcast: ${newNote.id}`);\r\n\r\n            if (isReminderForToday(newNote)) {\r\n              setNotes((prev) => {\r\n                const exists = prev.some((n) => n.id === newNote.id);\r\n                if (exists) return prev;\r\n                return [newNote, ...prev];\r\n              });\r\n            }\r\n          }\r\n        },\r\n      );\r\n\r\n      // Listen for UPDATE events\r\n      channel.on(\r\n        'broadcast',\r\n        { event: 'UPDATE' },\r\n        (payload: any) => {\r\n          if (payload.payload?.record) {\r\n            const newNote = payload.payload.record as Note;\r\n            const oldNote = payload.payload.old_record as Note | null;\r\n            logger.log(` Note updated via broadcast: ${newNote.id}`);\r\n\r\n            const isCurrentlyRelevant = isReminderForToday(newNote);\r\n            const wasRelevant = oldNote ? isReminderForToday(oldNote) : false;\r\n\r\n            if (isCurrentlyRelevant) {\r\n              setNotes((prev) => {\r\n                const index = prev.findIndex((n) => n.id === newNote.id);\r\n                if (index >= 0) {\r\n                  const updated = [...prev];\r\n                  updated[index] = newNote;\r\n                  return updated;\r\n                } else {\r\n                  return [newNote, ...prev];\r\n                }\r\n              });\r\n            } else if (wasRelevant && !isCurrentlyRelevant) {\r\n              setNotes((prev) => prev.filter((n) => n.id !== newNote.id));\r\n            }\r\n          }\r\n        },\r\n      );\r\n\r\n      // Listen for DELETE events\r\n      channel.on(\r\n        'broadcast',\r\n        { event: 'DELETE' },\r\n        (payload: any) => {\r\n          if (payload.payload?.old_record) {\r\n            const oldNote = payload.payload.old_record as Note;\r\n            logger.log(` Note deleted via broadcast: ${oldNote.id}`);\r\n            setNotes((prev) => prev.filter((n) => n.id !== oldNote.id));\r\n          }\r\n        },\r\n      );\r\n    },\r\n    onSubscribed: () => {\r\n      logger.log(` Reminder notes broadcast subscription ACTIVE for calendar-${calendarId}`);\r\n    },\r\n    onError: (error) => {\r\n      logger.error(` Reminder notes broadcast subscription ERROR for calendar-${calendarId}:`, error);\r\n    },\r\n  });\r\n\r\n  // Update a note in the local state (optimistic update)\r\n  const updateNote = useCallback((updatedNote: Note) => {\r\n    setNotes((prev) => {\r\n      const index = prev.findIndex((n) => n.id === updatedNote.id);\r\n      if (index >= 0) {\r\n        const updated = [...prev];\r\n        updated[index] = updatedNote;\r\n        return updated;\r\n      }\r\n      return prev;\r\n    });\r\n  }, []);\r\n\r\n  // Remove a note from the local state (optimistic update)\r\n  const removeNote = useCallback((noteId: string) => {\r\n    setNotes((prev) => prev.filter((n) => n.id !== noteId));\r\n  }, []);\r\n\r\n  return {\r\n    notes,\r\n    isLoading,\r\n    currentDayAbbr,\r\n    fullDayName,\r\n    reloadNotes: loadReminderNotes,\r\n    updateNote,\r\n    removeNote,\r\n  };\r\n}\r\n","import React, { useState, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  IconButton,\r\n  Typography,\r\n  useTheme,\r\n  alpha,\r\n  Chip,\r\n  Fade,\r\n  Slide,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport {\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  CalendarMonth,\r\n  Today,\r\n  KeyboardArrowDown\r\n} from '@mui/icons-material';\r\nimport { format, isToday } from 'date-fns';\r\n\r\ninterface FloatingMonthNavigationProps {\r\n  currentDate: Date;\r\n  isVisible: boolean;\r\n  onPrevMonth: () => void;\r\n  onNextMonth: () => void;\r\n  onMonthClick: () => void;\r\n  onTodayClick?: () => void;\r\n}\r\n\r\nconst FloatingMonthNavigation: React.FC<FloatingMonthNavigationProps> = ({\r\n  currentDate,\r\n  isVisible,\r\n  onPrevMonth,\r\n  onNextMonth,\r\n  onMonthClick,\r\n}) => {\r\n  const theme = useTheme();\r\n  const isCurrentMonth = isToday(currentDate);\r\n\r\n  // Hide nav when the page is within the top 20% scroll\r\n  const [hideByTopScroll, setHideByTopScroll] = useState(false);\r\n  useEffect(() => {\r\n    const update = () => {\r\n      const doc = document.documentElement;\r\n      const scrollable = Math.max(0, doc.scrollHeight - window.innerHeight);\r\n      if (scrollable <= 0) {\r\n        // No scrollable area: treat as top to keep nav hidden per requirement\r\n        setHideByTopScroll(true);\r\n        return;\r\n      }\r\n      const progress = Math.max(0, Math.min(1, window.scrollY / scrollable));\r\n      setHideByTopScroll(progress <= 0.2);\r\n    };\r\n    update();\r\n    window.addEventListener('scroll', update, { passive: true } as any);\r\n    window.addEventListener('resize', update);\r\n    return () => {\r\n      window.removeEventListener('scroll', update as any);\r\n      window.removeEventListener('resize', update);\r\n    };\r\n  }, []);\r\n\r\n  const finalVisible = isVisible && !hideByTopScroll;\r\n\r\n  return (\r\n    <Slide direction=\"left\" in={finalVisible} mountOnEnter unmountOnExit>\r\n      <Box\r\n        sx={{\r\n          position: 'fixed',\r\n          top: { xs: 80, sm: 88 },\r\n          right: { xs: 16, sm: 24 },\r\n          zIndex: 1300,\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'flex-end',\r\n          gap: 1\r\n        }}\r\n      >\r\n        {/* Main Navigation Pill */}\r\n        <Box\r\n          sx={{\r\n            backgroundColor: alpha(theme.palette.background.paper, 0.95),\r\n            backdropFilter: 'blur(20px)',\r\n            borderRadius: '24px',\r\n            boxShadow: `0 8px 32px ${alpha(theme.palette.common.black, 0.12)}`,\r\n            border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n            p: 0.5,\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 0.5,\r\n            transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n            transform: finalVisible ? 'translateY(0)' : 'translateY(-10px)',\r\n            opacity: finalVisible ? 1 : 0,\r\n            '&:hover': {\r\n              boxShadow: `0 12px 40px ${alpha(theme.palette.common.black, 0.15)}`,\r\n              transform: 'translateY(-2px)'\r\n            }\r\n          }}\r\n        >\r\n          {/* Previous Month Button */}\r\n          <Tooltip title=\"Previous month\" placement=\"bottom\">\r\n            <IconButton\r\n              onClick={onPrevMonth}\r\n              size=\"small\"\r\n              sx={{\r\n                width: 36,\r\n                height: 36,\r\n                color: 'text.secondary',\r\n                transition: 'all 0.2s ease',\r\n                '&:hover': {\r\n                  color: 'primary.main',\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  transform: 'scale(1.05)'\r\n                }\r\n              }}\r\n            >\r\n              <ChevronLeft fontSize=\"small\" />\r\n            </IconButton>\r\n          </Tooltip>\r\n\r\n          {/* Month Display */}\r\n          <Box\r\n            onClick={onMonthClick}\r\n            sx={{\r\n              cursor: 'pointer',\r\n              px: 2,\r\n              py: 1,\r\n              borderRadius: '16px',\r\n              textAlign: 'center',\r\n              transition: 'all 0.2s ease',\r\n              position: 'relative',\r\n              '&:hover': {\r\n                bgcolor: alpha(theme.palette.primary.main, 0.08),\r\n                transform: 'scale(1.02)'\r\n              }\r\n            }}\r\n          >\r\n            <Typography\r\n              variant=\"body2\"\r\n              sx={{\r\n                fontWeight: 700,\r\n                fontSize: '0.9rem',\r\n                color: 'text.primary',\r\n                letterSpacing: '0.5px',\r\n                lineHeight: 1.2\r\n              }}\r\n            >\r\n              {format(currentDate, 'MMM')}\r\n\r\n\r\n            </Typography>\r\n            <Typography\r\n              variant=\"caption\"\r\n              sx={{\r\n                fontSize: '0.75rem',\r\n                color: 'text.secondary',\r\n                fontWeight: 500,\r\n                display: 'block',\r\n                lineHeight: 1\r\n              }}\r\n            >\r\n              {format(currentDate, 'yyyy')}\r\n            </Typography>\r\n\r\n\r\n          </Box>\r\n\r\n          {/* Next Month Button */}\r\n          <Tooltip title=\"Next month\" placement=\"bottom\">\r\n            <IconButton\r\n              onClick={onNextMonth}\r\n              size=\"small\"\r\n              sx={{\r\n                width: 36,\r\n                height: 36,\r\n                color: 'text.secondary',\r\n                transition: 'all 0.2s ease',\r\n                '&:hover': {\r\n                  color: 'primary.main',\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  transform: 'scale(1.05)'\r\n                }\r\n              }}\r\n            >\r\n              <ChevronRight fontSize=\"small\" />\r\n            </IconButton>\r\n          </Tooltip>\r\n\r\n\r\n        </Box>\r\n\r\n\r\n      </Box>\r\n    </Slide>\r\n  );\r\n};\r\n\r\nexport default FloatingMonthNavigation;\r\n","// @ts-nocheck\r\n/**\r\n * Smart Economic Event Watcher Service\r\n * Monitors upcoming events and triggers updates when they occur\r\n *\r\n * NOTE: This service is being migrated to Supabase Edge Functions.\r\n * Temporarily disabled to fix TypeScript errors during migration.\r\n */\r\n\r\nimport { EconomicEvent, Currency, ImpactLevel } from '../types/economicCalendar';\r\nimport { economicCalendarService } from './economicCalendarService';\r\nimport { endOfDay, format, startOfDay } from 'date-fns';\r\nimport { error, log, logger } from '../utils/logger';\r\nimport { supabase } from '../config/supabase';\r\n\r\n/* eslint-disable */\r\n\r\n// Default filter settings to use when no calendar filters are available\r\nconst DEFAULT_FILTER_SETTINGS = {\r\n  currencies: ['USD', 'EUR', 'GBP'] as Currency[],\r\n  impacts: ['High', 'Medium', 'Low'] as ImpactLevel[],\r\n  viewType: 'day' as const\r\n};\r\n\r\n// Configuration for the event watcher\r\nconst WATCHER_CONFIG = {\r\n  refreshOnStart: true, // Whether to refresh calendar data when starting the watcher\r\n  maxRefreshAge: 5 * 60 * 1000 // Don't refresh if data was updated less than 5 minutes ago\r\n};\r\n\r\ninterface WatchedEventGroup {\r\n  events: EconomicEvent[];\r\n  timeoutId: NodeJS.Timeout;\r\n  calendarId: string;\r\n  releaseTime: string; // ISO string for grouping\r\n}\r\n\r\ninterface EventWatcherCallbacks {\r\n  onEventsUpdated: (events: EconomicEvent[], allEvents: EconomicEvent[], calendarId: string) => void;\r\n  onError: (error: Error, calendarId: string) => void;\r\n}\r\n\r\ninterface CalendarEventQueue {\r\n  events: EconomicEvent[]; \r\n  lastFetched: number;\r\n  currencies: Currency[];\r\n  impacts: ImpactLevel[];\r\n}\r\n\r\ninterface EventTimeGroup {\r\n  releaseTime: string;\r\n  events: EconomicEvent[];\r\n}\r\n\r\nclass EconomicEventWatcher {\r\n  private watchedEventGroups: Map<string, WatchedEventGroup> = new Map();\r\n  private callbacks: EventWatcherCallbacks | null = null;\r\n  private isActive = false;\r\n  private eventQueues: Map<string, CalendarEventQueue> = new Map(); // Memory cache per calendar\r\n\r\n  /**\r\n   * Get the localStorage key for tracking last refresh time per calendar\r\n   */\r\n  private getRefreshKey(calendarId: string): string {\r\n    return `economicEventWatcher_lastRefresh_${calendarId}`;\r\n  }\r\n\r\n  /**\r\n   * Check if we need to refresh data based on last refresh time\r\n   */\r\n  private shouldRefreshData(calendarId: string): boolean {\r\n    try {\r\n      if (!WATCHER_CONFIG.refreshOnStart) {\r\n        return false;\r\n      }\r\n      const lastRefreshStr = localStorage.getItem(this.getRefreshKey(calendarId));\r\n      if (!lastRefreshStr) {\r\n        return true; // No previous refresh recorded\r\n      }\r\n\r\n      const lastRefresh = parseInt(lastRefreshStr, 10);\r\n      const now = Date.now();\r\n      const timeSinceRefresh = now - lastRefresh;\r\n\r\n      const shouldRefresh = timeSinceRefresh > WATCHER_CONFIG.maxRefreshAge;\r\n      logger.log(` Last refresh for calendar ${calendarId}: ${Math.round(timeSinceRefresh / 1000 / 60)} minutes ago. Should refresh: ${shouldRefresh}`);\r\n\r\n      return shouldRefresh;\r\n    } catch (error) {\r\n      logger.warn(' Error checking refresh time from localStorage:', error);\r\n      return true; // Default to refresh on error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Save the current time as last refresh time for a calendar\r\n   */\r\n  private saveRefreshTime(calendarId: string): void {\r\n    try {\r\n      localStorage.setItem(this.getRefreshKey(calendarId), Date.now().toString());\r\n    } catch (error) {\r\n      logger.warn(' Error saving refresh time to localStorage:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the watcher with callbacks\r\n   */\r\n  initialize(callbacks: EventWatcherCallbacks) {\r\n    this.callbacks = callbacks;\r\n    logger.log(' Economic Event Watcher initialized');\r\n  }\r\n\r\n  /**\r\n   * Start watching events for a specific calendar\r\n   */\r\n  async startWatching(calendarId: string, economicCalendarFilters?: any) {\r\n    if (!this.callbacks) {\r\n      logger.warn(' Event watcher not initialized');\r\n      return;\r\n    }\r\n\r\n    this.isActive = true;\r\n    logger.log(` Starting event watching for calendar: ${calendarId}`);\r\n\r\n    // Get currencies from calendar filters or use defaults\r\n    const currencies = economicCalendarFilters?.currencies || DEFAULT_FILTER_SETTINGS.currencies;\r\n    const impacts = economicCalendarFilters?.impacts || DEFAULT_FILTER_SETTINGS.impacts;\r\n\r\n    try {\r\n      // First, refresh economic calendar data to ensure we have the latest information\r\n      if (this.shouldRefreshData(calendarId)) {\r\n        this.refreshCalendarData(currencies, calendarId);\r\n      } else {\r\n        log(` Skipping refresh for calendar ${calendarId} - data is still fresh`);\r\n      }\r\n\r\n      // Initialize or refresh the event queue for this calendar\r\n      await this.initializeEventQueue(calendarId, currencies, impacts);\r\n\r\n      // Start watching the next event from the queue\r\n      this.watchNextEventFromQueue(calendarId);\r\n\r\n    } catch (err) {\r\n      error(' Error starting event watcher:', err);\r\n      this.callbacks.onError(err as Error, calendarId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresh economic calendar data by calling the Supabase edge function\r\n   */\r\n  private async refreshCalendarData(currencies: Currency[], calendarId: string) {\r\n    try {\r\n      log(` Refreshing economic calendar data for calendar ${calendarId}, currencies: ${currencies.join(', ')}`);\r\n\r\n      const today = new Date();\r\n      const targetDate = format(today, 'yyyy-MM-dd');\r\n\r\n      // Call Supabase edge function to refresh today's economic calendar data\r\n      const { data, error: callError } = await supabase.functions.invoke('refresh-economic-calendar', {\r\n        body: {\r\n          targetDate,\r\n          currencies\r\n          // No specific events - refresh all events for today\r\n        }\r\n      });\r\n\r\n      if (callError) {\r\n        logger.error(' Error calling refresh-economic-calendar function:', callError);\r\n        return;\r\n      }\r\n\r\n      const responseData = data as any;\r\n      const updatedCount = responseData?.updatedCount || 0;\r\n      const foundEventsCount = responseData?.foundEvents?.length || 0;\r\n\r\n      logger.log(` Economic calendar refreshed for calendar ${calendarId}: ${updatedCount} total events updated`);\r\n      if (foundEventsCount > 0) {\r\n        logger.log(` Found ${foundEventsCount} events with current data`);\r\n      }\r\n\r\n      // Save the refresh time to localStorage\r\n      this.saveRefreshTime(calendarId);\r\n\r\n    } catch (error) {\r\n      logger.error(' Error refreshing economic calendar data:', error);\r\n      // Don't throw - this is not critical for watcher initialization\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize or refresh the event queue for a calendar\r\n   */\r\n  private async initializeEventQueue(calendarId: string, currencies: Currency[], impacts: ImpactLevel[]) {\r\n    const now = Date.now();\r\n    const existingQueue = this.eventQueues.get(calendarId);\r\n\r\n    // Check if we need to fetch new data (if filters changed)\r\n    const shouldRefresh = !existingQueue ||\r\n      !this.arraysEqual(existingQueue.currencies, currencies) ||\r\n      !this.arraysEqual(existingQueue.impacts, impacts);\r\n\r\n    if (shouldRefresh) {\r\n      logger.log(` Fetching fresh events for calendar: ${calendarId}`);\r\n\r\n      // Get today's events for the specified currencies\r\n      const today = new Date();\r\n      const dayStart = startOfDay(today);\r\n      const dayEnd = endOfDay(today);\r\n      const dateRange = {\r\n        start: format(dayStart, 'yyyy-MM-dd'),\r\n        end: format(dayEnd, 'yyyy-MM-dd')\r\n      };\r\n\r\n      const todaysEvents = await economicCalendarService.fetchEventsPaginated(\r\n        dateRange,\r\n        { pageSize: 50 },\r\n        { currencies, impacts, onlyUpcoming: true },\r\n      );\r\n\r\n      // Sort upcoming events (already filtered by database via onlyUpcoming)\r\n      const upcomingEvents = todaysEvents.events\r\n        .sort((a, b) => new Date(a.time_utc).getTime() - new Date(b.time_utc).getTime());\r\n\r\n      // Store in memory queue\r\n      this.eventQueues.set(calendarId, {\r\n        events: upcomingEvents,\r\n        lastFetched: now,\r\n        currencies,\r\n        impacts\r\n      });\r\n\r\n      logger.log(` Cached ${upcomingEvents.length} upcoming events for calendar: ${calendarId} ${todaysEvents.events.length}`);\r\n    } else {\r\n      logger.log(` Using cached events for calendar: ${calendarId}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Watch the next event group from the calendar's queue\r\n   */\r\n  private watchNextEventFromQueue(calendarId: string) {\r\n    const queue = this.eventQueues.get(calendarId);\r\n    if (!queue || queue.events.length === 0) {\r\n      logger.log(` No more events to watch for calendar: ${calendarId}`);\r\n      this.isActive = false;\r\n      return;\r\n    }\r\n\r\n    // Group events by release time starting from current index\r\n    const eventGroup = this.getNextEventGroup(queue);\r\n    if (eventGroup.events.length === 0) {\r\n      logger.log(` No more event groups to watch for calendar: ${calendarId}`);\r\n      this.isActive = false;\r\n      return;\r\n    }\r\n\r\n    this.watchEventGroup(eventGroup, calendarId);\r\n    logger.log(` Watching ${eventGroup.events.length} event(s) releasing at ${eventGroup.releaseTime} for calendar: ${calendarId}`);\r\n    eventGroup.events.forEach((event, index) => {\r\n      logger.log(`   ${index + 1}. ${event.event_name}`);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the next group of events that have the same release time\r\n   */\r\n  private getNextEventGroup(queue: CalendarEventQueue): EventTimeGroup {\r\n    if (queue.events.length === 0) {\r\n      return { releaseTime: '', events: [] };\r\n    }\r\n\r\n    const firstEvent = queue.events[0]\r\n    const releaseTime = firstEvent.time_utc;\r\n\r\n    return {\r\n      releaseTime, // Collect all events with the same release time\r\n      events: queue.events.filter((e) => e.time_utc === releaseTime)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Helper method to compare arrays\r\n   */\r\n  private arraysEqual<T>(a: T[], b: T[]): boolean {\r\n    return a.length === b.length && a.every((val, i) => val === b[i]);\r\n  }\r\n\r\n  /**\r\n   * Stop watching events for a specific calendar\r\n   */\r\n  stopWatching(calendarId: string) {\r\n    const watchKey = `${calendarId}`;\r\n    const watched = this.watchedEventGroups.get(watchKey);\r\n\r\n    if (watched) {\r\n      clearTimeout(watched.timeoutId);\r\n      this.watchedEventGroups.delete(watchKey);\r\n    }\r\n\r\n    // Clear the event queue for this calendar\r\n    this.eventQueues.delete(calendarId);\r\n\r\n    // If no more events being watched, deactivate\r\n    if (this.watchedEventGroups.size === 0) {\r\n      this.isActive = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop all watching\r\n   */\r\n  stopAllWatching() {\r\n    this.watchedEventGroups.forEach((watched) => {\r\n      clearTimeout(watched.timeoutId);\r\n    });\r\n    this.watchedEventGroups.clear();\r\n    this.eventQueues.clear(); // Clear all event queues\r\n    this.isActive = false;\r\n    logger.log(' Stopped all event watching');\r\n  }\r\n\r\n  /**\r\n   * Clear refresh cache for a specific calendar (forces refresh on next start)\r\n   */\r\n  clearRefreshCache(calendarId: string) {\r\n    try {\r\n      localStorage.removeItem(this.getRefreshKey(calendarId));\r\n      logger.log(` Cleared refresh cache for calendar: ${calendarId}`);\r\n    } catch (error) {\r\n      logger.warn(' Error clearing refresh cache:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all refresh caches (forces refresh for all calendars)\r\n   */\r\n  clearAllRefreshCaches() {\r\n    try {\r\n      // Find all keys that match our pattern\r\n      const keysToRemove: string[] = [];\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith('economicEventWatcher_lastRefresh_')) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n\r\n      // Remove all matching keys\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n      logger.log(` Cleared ${keysToRemove.length} refresh cache entries`);\r\n    } catch (error) {\r\n      logger.warn(' Error clearing all refresh caches:', error);\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Watch a group of events that have the same release time\r\n   */\r\n  private watchEventGroup(eventGroup: EventTimeGroup, calendarId: string) {\r\n    const releaseTime = new Date(eventGroup.releaseTime);\r\n    const now = new Date();\r\n    const timeUntilRelease = releaseTime.getTime() - now.getTime();\r\n\r\n    if (timeUntilRelease <= 0) {\r\n      // Events have already been released, trigger update immediately\r\n      this.triggerEventGroupUpdate(eventGroup.events, calendarId);\r\n      return;\r\n    }\r\n\r\n    const watchKey = `${calendarId}`;\r\n\r\n    // Clear any existing timeout for this calendar\r\n    const existing = this.watchedEventGroups.get(watchKey);\r\n    if (existing) {\r\n      clearTimeout(existing.timeoutId);\r\n    }\r\n\r\n    // Set new timeout for the entire group\r\n    const timeoutId = setTimeout(() => {\r\n      this.triggerEventGroupUpdate(eventGroup.events, calendarId);\r\n    }, timeUntilRelease);\r\n\r\n    this.watchedEventGroups.set(watchKey, {\r\n      events: eventGroup.events,\r\n      timeoutId,\r\n      calendarId,\r\n      releaseTime: eventGroup.releaseTime\r\n    });\r\n\r\n    logger.log(` Event group (${eventGroup.events.length} events) will be updated in ${Math.round(timeUntilRelease / 1000 / 60)} minutes`);\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trigger an update for a group of events with the same release time\r\n   * Uses fetch-mql5-event batch mode for efficient fetching\r\n   */\r\n  private async triggerEventGroupUpdate(events: EconomicEvent[], calendarId: string) {\r\n    if (!this.callbacks || events.length === 0) return;\r\n\r\n    try {\r\n      logger.log(` Triggering batch update for ${events.length} event(s) releasing at the same time`);\r\n\r\n      // Build the batch request payload\r\n      const batchEvents = events.map((event) => {\r\n        const country = event.country || this.currencyToCountry(event.currency);\r\n        return {\r\n          event_name: event.event_name,\r\n          country: country || 'Unknown',\r\n          originalEvent: event, // Keep reference for later\r\n        };\r\n      }).filter((e) => e.country !== 'Unknown');\r\n\r\n      // Warn about events without country mapping\r\n      const unmappedCount = events.length - batchEvents.length;\r\n      if (unmappedCount > 0) {\r\n        logger.warn(` Could not determine country for ${unmappedCount} event(s)`);\r\n      }\r\n\r\n      const updatedEvents: EconomicEvent[] = [];\r\n\r\n      if (batchEvents.length > 0) {\r\n        // Call fetch-mql5-event with batch payload\r\n        const { data, error: callError } = await supabase.functions.invoke('fetch-mql5-event', {\r\n          body: {\r\n            events: batchEvents.map(({ event_name, country }) => ({ event_name, country }))\r\n          }\r\n        });\r\n\r\n        if (callError) {\r\n          logger.error(' Error fetching batch events:', callError);\r\n          // Fall back to original events\r\n          updatedEvents.push(...events);\r\n        } else {\r\n          // Process batch results\r\n          const responseData = data as any;\r\n          const results = responseData?.results || [];\r\n\r\n          logger.log(` Batch fetch complete: ${responseData?.succeeded || 0} succeeded, ${responseData?.failed || 0} failed`);\r\n\r\n          // Map results back to original events\r\n          for (const batchEvent of batchEvents) {\r\n            const result = results.find(\r\n              (r: any) => r.event_name === batchEvent.event_name && r.country === batchEvent.country\r\n            );\r\n\r\n            if (result?.success && result.data) {\r\n              const fetchedData = result.data;\r\n\r\n              // Update the event with fresh data\r\n              const eventToNotify: EconomicEvent = {\r\n                ...batchEvent.originalEvent,\r\n                actual_value: fetchedData.actual_value || batchEvent.originalEvent.actual_value,\r\n                forecast_value: fetchedData.forecast_value || batchEvent.originalEvent.forecast_value,\r\n                previous_value: fetchedData.previous_value || batchEvent.originalEvent.previous_value,\r\n                impact: fetchedData.impact || batchEvent.originalEvent.impact,\r\n              };\r\n\r\n              updatedEvents.push(eventToNotify);\r\n\r\n              // Log the update\r\n              const cached = fetchedData.cached ? ' (cached)' : ' (fresh from MQL5)';\r\n              logger.log(` Event \"${batchEvent.event_name}\"${cached}:`);\r\n              logger.log(`   Actual: ${batchEvent.originalEvent.actual_value}  ${fetchedData.actual_value}`);\r\n            } else {\r\n              // Use original event if fetch failed\r\n              logger.warn(` Failed to fetch \"${batchEvent.event_name}\": ${result?.error || 'Unknown error'}`);\r\n              updatedEvents.push(batchEvent.originalEvent);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Add unmapped events as-is\r\n      const unmappedEvents = events.filter(\r\n        (e) => !e.country && !this.currencyToCountry(e.currency)\r\n      );\r\n      updatedEvents.push(...unmappedEvents);\r\n\r\n      // Remove the events from the queue\r\n      const queue = this.eventQueues.get(calendarId);\r\n      if (queue) {\r\n        const eventIds = events.map((e) => e.id);\r\n        queue.events = queue.events.filter((e) => !eventIds.includes(e.id)) || [];\r\n      }\r\n\r\n      // Notify with updated events\r\n      this.callbacks.onEventsUpdated(updatedEvents, updatedEvents, calendarId);\r\n\r\n      // Remove this event group from watching\r\n      this.watchedEventGroups.delete(calendarId);\r\n\r\n      // Continue watching if still active\r\n      if (this.isActive) {\r\n        // Wait a bit before watching next event group\r\n        setTimeout(() => {\r\n          this.continueWatching(calendarId);\r\n        }, 5000);\r\n      }\r\n\r\n    } catch (err) {\r\n      error(' Error updating event group:', err);\r\n      this.callbacks.onError(err as Error, calendarId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Map currency code to country name for MQL5 lookups\r\n   */\r\n  private currencyToCountry(currency: string): string | null {\r\n    const currencyCountryMap: Record<string, string> = {\r\n      'USD': 'United States',\r\n      'EUR': 'Euro Area',\r\n      'GBP': 'United Kingdom',\r\n      'JPY': 'Japan',\r\n      'CHF': 'Switzerland',\r\n      'CAD': 'Canada',\r\n      'AUD': 'Australia',\r\n      'NZD': 'New Zealand',\r\n      'CNY': 'China',\r\n      'CNH': 'China',\r\n      'HKD': 'Hong Kong',\r\n      'SGD': 'Singapore',\r\n      'INR': 'India',\r\n      'KRW': 'South Korea',\r\n      'MXN': 'Mexico',\r\n      'BRL': 'Brazil',\r\n      'ZAR': 'South Africa',\r\n      'TRY': 'Turkey',\r\n      'RUB': 'Russia',\r\n      'SEK': 'Sweden',\r\n      'NOK': 'Norway',\r\n      'DKK': 'Denmark',\r\n      'PLN': 'Poland',\r\n    };\r\n    return currencyCountryMap[currency] || null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Continue watching the next upcoming event from the queue\r\n   */\r\n  private async continueWatching(calendarId: string) {\r\n    if (!this.callbacks) return;\r\n\r\n    log(` Continuing to watch next event for calendar: ${calendarId}`);\r\n\r\n    try {\r\n      const queue = this.eventQueues.get(calendarId);\r\n      if (!queue) {\r\n        logger.log(` No event queue found for calendar: ${calendarId}`);\r\n        return;\r\n      }\r\n\r\n      // Note: Don't increment currentIndex here - getNextEventGroup already advanced it\r\n      // to skip all events in the processed group\r\n\r\n      // Check if we have more events in the queue\r\n      if (queue.events.length > 0) {\r\n        // Watch the next event from the existing queue\r\n        this.watchNextEventFromQueue(calendarId);\r\n      } else {\r\n        // Queue exhausted, try to refresh and get more events\r\n        logger.log(` Event queue exhausted for calendar: ${calendarId}, refreshing...`);\r\n        await this.initializeEventQueue(calendarId, queue.currencies, queue.impacts);\r\n\r\n        // Reset index and try again\r\n        const refreshedQueue = this.eventQueues.get(calendarId);\r\n        if (refreshedQueue && refreshedQueue.events.length > 0) {\r\n         \r\n          this.watchNextEventFromQueue(calendarId);\r\n        } else {\r\n          logger.log(' No more upcoming events found for today');\r\n          this.isActive = false;\r\n        }\r\n      }\r\n\r\n    } catch (err) {\r\n      error(' Error continuing event watching:', err);\r\n      this.callbacks.onError(err as Error, calendarId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current watching status\r\n   */\r\n  getWatchingStatus() {\r\n    const queueStatus = Array.from(this.eventQueues.entries()).map(([calendarId, queue]) => {\r\n      // Get refresh information for this calendar\r\n      const lastRefreshStr = localStorage.getItem(this.getRefreshKey(calendarId));\r\n      const lastRefresh = lastRefreshStr ? parseInt(lastRefreshStr, 10) : null;\r\n      const timeSinceRefresh = lastRefresh ? Date.now() - lastRefresh : null;\r\n\r\n      return {\r\n        calendarId,\r\n        totalEvents: queue.events.length, \r\n        lastFetched: new Date(queue.lastFetched).toISOString(),\r\n        lastRefresh: lastRefresh ? new Date(lastRefresh).toISOString() : null,\r\n        minutesSinceRefresh: timeSinceRefresh ? Math.round(timeSinceRefresh / 1000 / 60) : null,\r\n        needsRefresh: lastRefresh ? (timeSinceRefresh! > WATCHER_CONFIG.maxRefreshAge) : true\r\n      };\r\n    });\r\n\r\n    return {\r\n      isActive: this.isActive,\r\n      watchedEventsCount: this.watchedEventGroups.size,\r\n      watchedEventGroups: Array.from(this.watchedEventGroups.values()).map(w => ({\r\n        eventCount: w.events.length,\r\n        events: w.events.map(e => e.event_name),\r\n        releaseTime: w.releaseTime,\r\n        calendarId: w.calendarId\r\n      })),\r\n      eventQueues: queueStatus,\r\n      config: WATCHER_CONFIG\r\n    };\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const economicEventWatcher = new EconomicEventWatcher();\r\n","/**\r\n * Economic Event Notification Slider\r\n * Shows a sliding notification when economic events are updated\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n  Slide,\r\n  Paper,\r\n  Typography,\r\n  Box,\r\n  Chip,\r\n  IconButton,\r\n  useTheme\r\n} from '@mui/material';\r\nimport {\r\n  Close as CloseIcon,\r\n  TrendingUp as TrendingUpIcon,\r\n  TrendingDown as TrendingDownIcon,\r\n  Remove as NeutralIcon\r\n} from '@mui/icons-material';\r\nimport { EconomicEvent, ImpactLevel, Currency } from '../../types/economicCalendar';\r\nimport { alpha } from '@mui/material/styles';\r\nimport { format, parseISO } from 'date-fns';\r\n\r\ninterface EconomicEventNotificationProps {\r\n  event: EconomicEvent | null;\r\n  onClose: () => void;\r\n  autoHideDuration?: number; // Duration in milliseconds\r\n  isRemoving?: boolean; // Whether this notification is being removed\r\n}\r\n\r\nconst EconomicEventNotification: React.FC<EconomicEventNotificationProps> = ({\r\n  event,\r\n  onClose,\r\n  autoHideDuration = 5000, // 5 seconds default\r\n  isRemoving = false\r\n}) => {\r\n  const theme = useTheme();\r\n  const [open, setOpen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (event && !isRemoving) {\r\n      setOpen(true);\r\n      \r\n      // Auto-hide after specified duration\r\n      const timer = setTimeout(() => {\r\n        handleClose();\r\n      }, autoHideDuration);\r\n\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [event, autoHideDuration, isRemoving]);\r\n\r\n  const handleClose = () => {\r\n    if (isRemoving) return; // Prevent double-closing\r\n    \r\n    setOpen(false);\r\n    // Wait for slide animation to complete before calling onClose\r\n    setTimeout(() => {\r\n      onClose();\r\n    }, 300);\r\n  };\r\n\r\n  // Handle removal animation\r\n  useEffect(() => {\r\n    if (isRemoving) {\r\n      setOpen(false);\r\n    }\r\n  }, [isRemoving]);\r\n\r\n  if (!event) return null;\r\n\r\n  // Determine impact color\r\n  const getImpactColor = (impact: string) => {\r\n    switch (impact.toLowerCase()) {\r\n      case 'high': return theme.palette.error.main;\r\n      case 'medium': return theme.palette.warning.main;\r\n      case 'low': return theme.palette.info.main;\r\n      default: return theme.palette.grey[500];\r\n    }\r\n  };\r\n\r\n  // Helper function to get actual result background color and border\r\n  const getActualResultStyle = (actualResultType: string) => {\r\n    switch (actualResultType) {\r\n      case 'good':\r\n        return {\r\n          backgroundColor: alpha(theme.palette.success.main, 0.15),\r\n          border: `1px solid ${alpha(theme.palette.success.main, 0.3)}`,\r\n          color: theme.palette.success.dark\r\n        };\r\n      case 'bad':\r\n        return {\r\n          backgroundColor: alpha(theme.palette.error.main, 0.15),\r\n          border: `1px solid ${alpha(theme.palette.error.main, 0.3)}`,\r\n          color: theme.palette.error.dark\r\n        };\r\n      case 'neutral':\r\n        return {\r\n          backgroundColor: alpha(theme.palette.info.main, 0.1),\r\n          border: `1px solid ${alpha(theme.palette.info.main, 0.2)}`,\r\n          color: theme.palette.info.dark\r\n        };\r\n      default:\r\n        return {\r\n          backgroundColor: alpha(theme.palette.success.main, 0.1),\r\n          border: `1px solid ${alpha(theme.palette.success.main, 0.2)}`,\r\n          color: 'text.primary'\r\n        };\r\n    }\r\n  };\r\n\r\n  // Determine trend icon and color based on actualResultType\r\n  const getTrendInfo = () => {\r\n    if (!event.actual_value) {\r\n      return { icon: <NeutralIcon />, color: theme.palette.grey[500], text: 'Updated' };\r\n    }\r\n\r\n    // Use actualResultType if available, otherwise fall back to comparison logic\r\n    if (event.actual_result_type) {\r\n      switch (event.actual_result_type) {\r\n        case 'good':\r\n          return { icon: <TrendingUpIcon />, color: theme.palette.success.main, text: 'Good Result' };\r\n        case 'bad':\r\n          return { icon: <TrendingDownIcon />, color: theme.palette.error.main, text: 'Bad Result' };\r\n        case 'neutral':\r\n          return { icon: <NeutralIcon />, color: theme.palette.info.main, text: 'As Expected' };\r\n        default:\r\n          return { icon: <NeutralIcon />, color: theme.palette.grey[500], text: 'Updated' };\r\n      }\r\n    }\r\n\r\n    // Fallback to old comparison logic if actualResultType is not available\r\n    if (!event.forecast_value) {\r\n      return { icon: <NeutralIcon />, color: theme.palette.grey[500], text: 'Updated' };\r\n    }\r\n\r\n    const actual = parseFloat(event.actual_value.replace(/[^\\d.-]/g, ''));\r\n    const forecast = parseFloat(event.forecast_value.replace(/[^\\d.-]/g, ''));\r\n\r\n    if (isNaN(actual) || isNaN(forecast)) {\r\n      return { icon: <NeutralIcon />, color: theme.palette.grey[500], text: 'Updated' };\r\n    }\r\n\r\n    if (actual > forecast) {\r\n      return { icon: <TrendingUpIcon />, color: theme.palette.success.main, text: 'Above Forecast' };\r\n    } else if (actual < forecast) {\r\n      return { icon: <TrendingDownIcon />, color: theme.palette.error.main, text: 'Below Forecast' };\r\n    } else {\r\n      return { icon: <NeutralIcon />, color: theme.palette.info.main, text: 'As Expected' };\r\n    }\r\n  };\r\n\r\n  const trendInfo = getTrendInfo();\r\n\r\n  return (\r\n    <Box sx={{ pointerEvents: 'auto' }}>\r\n      <Slide direction=\"right\" in={open} mountOnEnter unmountOnExit>\r\n          <Paper\r\n            elevation={8}\r\n        sx={{\r\n          width: 320,\r\n          maxWidth: 'calc(100vw - 24px)',\r\n          borderRadius: 1,\r\n          overflow: 'hidden',\r\n          background: theme.palette.mode === 'dark'\r\n            ? theme.palette.background.default\r\n            : `linear-gradient(135deg, ${theme.palette.background.paper} 0%, ${theme.palette.background.default} 100%)`,\r\n          border: `1px solid ${alpha(theme.palette.divider, theme.palette.mode === 'dark' ? 0.3 : 0.15)}`,\r\n          boxShadow: theme.shadows[8],\r\n          borderLeft: `4px solid ${getImpactColor(event.impact)}`,\r\n          pointerEvents: 'auto' // Enable clicks (container has pointerEvents: none)\r\n        }}\r\n      >\r\n        {/* Compact Header with Close Button */}\r\n        <Box\r\n          sx={{\r\n            background: `linear-gradient(90deg, ${getImpactColor(event.impact)} 0%, ${alpha(getImpactColor(event.impact), 0.8)} 100%)`,\r\n            color: theme.palette.getContrastText(getImpactColor(event.impact)),\r\n            p: 1,\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            minHeight: 32\r\n          }}\r\n        >\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.75 }}>\r\n            {trendInfo.icon}\r\n            <Typography variant=\"caption\" fontWeight=\"bold\" sx={{ fontSize: '0.8rem' }}>\r\n              Economic Event Updated\r\n            </Typography>\r\n          </Box>\r\n          <IconButton\r\n            size=\"small\"\r\n            onClick={handleClose}\r\n            sx={{ color: 'white', '&:hover': { backgroundColor: 'rgba(255,255,255,0.1)' }, p: 0.25 }}\r\n          >\r\n            <CloseIcon sx={{ fontSize: '1rem' }} />\r\n          </IconButton>\r\n        </Box>\r\n\r\n        {/* Compact Content */}\r\n        <Box sx={{ p: 1.5 }}>\r\n          <Box sx={{ display: 'flex', alignItems: 'flex-start', gap: 1.5, width: '100%' }}>\r\n            {/* Flag and Currency */}\r\n            <Box sx={{ minWidth: 32, mt: 0.25, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 0.5 }}>\r\n              <img\r\n                src={event.flag_url}\r\n                alt={event.country}\r\n                style={{\r\n                  width: 20,\r\n                  height: 15,\r\n                  borderRadius: 2,\r\n                  objectFit: 'cover',\r\n                  border: `1px solid ${alpha(theme.palette.divider, 0.2)}`\r\n                }}\r\n              />\r\n              <Typography variant=\"caption\" sx={{\r\n                fontWeight: 700,\r\n                textAlign: 'center',\r\n                fontSize: '0.7rem',\r\n                color: 'text.primary',\r\n                minWidth: 32\r\n              }}>\r\n                {event.currency}\r\n              </Typography>\r\n            </Box>\r\n\r\n            {/* Content Container */}\r\n            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5, width: '100%', flex: 1 }}>\r\n              {/* First Row: Time | Status | Impact Badge */}\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>\r\n                {/* Time */}\r\n                <Typography variant=\"caption\" sx={{\r\n                  fontWeight: 600,\r\n                  color: 'text.primary',\r\n                  fontSize: '0.75rem',\r\n                  minWidth: 80\r\n                }}>\r\n                  {format(parseISO(event.time_utc), 'h:mm a')}\r\n                </Typography>\r\n\r\n                {/* Status Icon */}\r\n                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minWidth: 24 }}>\r\n                  <Typography variant=\"caption\" sx={{\r\n                    color: trendInfo.color,\r\n                    fontWeight: 700,\r\n                    fontSize: '0.65rem'\r\n                  }}>\r\n                    {trendInfo.text}\r\n                  </Typography>\r\n                </Box>\r\n\r\n                {/* Spacer */}\r\n                <Box sx={{ flex: 1 }} />\r\n\r\n                {/* Impact Badge */}\r\n                <Chip\r\n                  label={event.impact.toUpperCase()}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    height: 20,\r\n                    fontSize: '0.6rem',\r\n                    fontWeight: 700,\r\n                    backgroundColor: getImpactColor(event.impact),\r\n                    color: 'white',\r\n                    minWidth: 40,\r\n                    borderRadius: 1,\r\n                    '& .MuiChip-label': {\r\n                      px: 0.75,\r\n                      py: 0.25\r\n                    }\r\n                  }}\r\n                />\r\n              </Box>\r\n\r\n              {/* Second Row: Event Name */}\r\n              <Typography variant=\"body2\" sx={{\r\n                fontWeight: 600,\r\n                fontSize: '0.9rem',\r\n                color: 'text.primary',\r\n                lineHeight: 1.3,\r\n                mb: 0.5\r\n              }}>\r\n                {event.event_name}\r\n              </Typography>\r\n\r\n              {/* Third Row: Values (if available) */}\r\n              {(event.actual_value || event.forecast_value || event.previous_value) && (\r\n                <Box sx={{ display: 'flex', gap: 1.5, alignItems: 'center', flexWrap: 'wrap' }}>\r\n                  {event.actual_value && (\r\n                    <Typography variant=\"caption\" sx={{\r\n                      fontWeight: 700,\r\n                      fontSize: '0.7rem',\r\n                      px: 1,\r\n                      py: 0.25,\r\n                      borderRadius: 1,\r\n                      ...getActualResultStyle(event.actual_result_type)\r\n                    }}>\r\n                      A: {event.actual_value}\r\n                    </Typography>\r\n                  )}\r\n                  {event.forecast_value && (\r\n                    <Typography variant=\"caption\" sx={{\r\n                      color: 'text.secondary',\r\n                      fontSize: '0.7rem',\r\n                      fontWeight: 600,\r\n                      backgroundColor: alpha(theme.palette.info.main, 0.1),\r\n                      px: 1,\r\n                      py: 0.25,\r\n                      borderRadius: 1,\r\n                      border: `1px solid ${alpha(theme.palette.info.main, 0.2)}`\r\n                    }}>\r\n                      F: {event.forecast_value}\r\n                    </Typography>\r\n                  )}\r\n                  {event.previous_value && (\r\n                    <Typography variant=\"caption\" sx={{\r\n                      color: 'text.disabled',\r\n                      fontSize: '0.7rem',\r\n                      fontWeight: 600,\r\n                      backgroundColor: alpha(theme.palette.grey[500], 0.1),\r\n                      px: 1,\r\n                      py: 0.25,\r\n                      borderRadius: 1,\r\n                      border: `1px solid ${alpha(theme.palette.grey[500], 0.2)}`\r\n                    }}>\r\n                      P: {event.previous_value}\r\n                    </Typography>\r\n                  )}\r\n                </Box>\r\n              )}\r\n            </Box>\r\n          </Box>\r\n        </Box>\r\n      </Paper>\r\n      </Slide>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default EconomicEventNotification;\r\n","/**\r\n * Custom hook for fetching and caching high-impact economic events\r\n * Optimized to prevent excessive database queries\r\n */\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { format, startOfMonth, endOfMonth } from 'date-fns';\r\nimport { economicCalendarService } from '../services/economicCalendarService';\r\nimport { Currency, ImpactLevel } from '../types/economicCalendar';\r\nimport { DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS } from '../components/economicCalendar/EconomicCalendarDrawer';\r\nimport { error as logError, log, warn } from '../utils/logger';\r\n\r\ninterface UseHighImpactEventsProps {\r\n  currentDate: Date;\r\n  calendarId?: string;\r\n  currencies?: Currency[];\r\n  enabled?: boolean;\r\n}\r\n\r\ninterface UseHighImpactEventsReturn {\r\n  highImpactEventDates: Map<string, boolean>;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n  lastUpdated: number | null;\r\n}\r\n\r\n// Cache configuration\r\nconst CACHE_PREFIX = 'highImpactEvents';\r\n\r\n// Smart cache duration based on month type\r\nconst getCacheDuration = (targetDate: Date): number => {\r\n  const now = new Date();\r\n  const currentMonth = now.getMonth();\r\n  const currentYear = now.getFullYear();\r\n  const targetMonth = targetDate.getMonth();\r\n  const targetYear = targetDate.getFullYear();\r\n\r\n  // Previous months: Cache indefinitely (events don't change)\r\n  if (targetYear < currentYear || (targetYear === currentYear && targetMonth < currentMonth)) {\r\n    return Number.MAX_SAFE_INTEGER; // Effectively permanent\r\n  }\r\n\r\n  // Current month: Refresh weekly starting on Sunday\r\n  if (targetYear === currentYear && targetMonth === currentMonth) {\r\n    return 7 * 24 * 60 * 60 * 1000; // 7 days\r\n  }\r\n\r\n  // Future months: Refresh daily (events might be updated/added)\r\n  return 24 * 60 * 60 * 1000; // 1 day\r\n};\r\n\r\n// Get next Sunday for current month cache expiry\r\nconst getNextSundayExpiry = (): number => {\r\n  const now = new Date();\r\n  const daysUntilSunday = (7 - now.getDay()) % 7;\r\n  const nextSunday = new Date(now);\r\n  nextSunday.setDate(now.getDate() + (daysUntilSunday === 0 ? 7 : daysUntilSunday));\r\n  nextSunday.setHours(0, 0, 0, 0); // Start of Sunday\r\n  return nextSunday.getTime();\r\n};\r\n\r\nexport const useHighImpactEvents = ({\r\n  currentDate,\r\n  calendarId,\r\n  currencies = DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS.currencies,\r\n  enabled = true\r\n}: UseHighImpactEventsProps): UseHighImpactEventsReturn => {\r\n  const [highImpactEventDates, setHighImpactEventDates] = useState<Map<string, boolean>>(new Map());\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [lastUpdated, setLastUpdated] = useState<number | null>(null);\r\n\r\n  // Memoize currencies array to prevent unnecessary re-renders\r\n  const currenciesKey = currencies.join(',');\r\n\r\n  useEffect(() => {\r\n    if (!enabled || !calendarId) return;\r\n\r\n    // Clean up old cache entries periodically (once per session)\r\n    const cleanupKey = 'highImpactEvents_lastCleanup';\r\n    const lastCleanup = localStorage.getItem(cleanupKey);\r\n    const now = Date.now();\r\n    const CLEANUP_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours\r\n\r\n    if (!lastCleanup || now - parseInt(lastCleanup) > CLEANUP_INTERVAL) {\r\n      cleanupExpiredCache();\r\n      localStorage.setItem(cleanupKey, now.toString());\r\n    }\r\n\r\n    // Clean up old currency cache when currencies change\r\n    if (calendarId) {\r\n      clearOldCurrencyCache(calendarId, currencies);\r\n    }\r\n\r\n    const fetchHighImpactEvents = async () => {\r\n      const monthKey = format(currentDate, 'yyyy-MM');\r\n      const currenciesHash = currencies.sort().join('-'); // Sort to ensure consistent hash\r\n      const cacheKey = `${CACHE_PREFIX}_${monthKey}_${calendarId}_${currenciesHash}`;\r\n      const cacheExpiryKey = `${cacheKey}_expiry`;\r\n      const cacheMetaKey = `${cacheKey}_meta`;\r\n      \r\n      // Check cache first with smart expiry logic\r\n      const cachedData = localStorage.getItem(cacheKey);\r\n      const cacheExpiry = localStorage.getItem(cacheExpiryKey);\r\n      const cacheMeta = localStorage.getItem(cacheMetaKey);\r\n      const now = Date.now();\r\n\r\n      // Determine cache strategy based on month type\r\n      const cacheDuration = getCacheDuration(currentDate);\r\n      const isPreviousMonth = currentDate < new Date(new Date().getFullYear(), new Date().getMonth(), 1);\r\n\r\n      if (cachedData && cacheExpiry && now < parseInt(cacheExpiry)) {\r\n        const cacheAge = now - (cacheMeta ? JSON.parse(cacheMeta).lastUpdated || 0 : 0);\r\n        const cacheAgeHours = Math.round(cacheAge / (1000 * 60 * 60));\r\n        const currenciesInfo = currencies.join(', ');\r\n\r\n        log(` Using cached high-impact events for ${monthKey} [${currenciesInfo}] (${cacheAgeHours}h old, ${isPreviousMonth ? 'permanent' : 'expires ' + new Date(parseInt(cacheExpiry)).toLocaleString()})`);\r\n\r\n        try {\r\n          const eventDatesMap = new Map<string, boolean>(JSON.parse(cachedData));\r\n          const meta = cacheMeta ? JSON.parse(cacheMeta) : {};\r\n\r\n          setHighImpactEventDates(eventDatesMap);\r\n          setLastUpdated(meta.lastUpdated || now);\r\n          setError(null);\r\n          return;\r\n        } catch (parseError) {\r\n          warn('Failed to parse cached data, fetching fresh data');\r\n        }\r\n      }\r\n\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      try {\r\n        const monthStart = startOfMonth(currentDate);\r\n        const monthEnd = endOfMonth(currentDate);\r\n        const dateRange = {\r\n          start: format(monthStart, 'yyyy-MM-dd'),\r\n          end: format(monthEnd, 'yyyy-MM-dd')\r\n        };\r\n\r\n        log(` Fetching fresh high-impact events for ${monthKey} [${currencies.join(', ')}]`);\r\n        \r\n        // Fetch only high-impact events for the month\r\n        const events = await economicCalendarService.fetchEvents(dateRange, {\r\n          currencies,\r\n          impacts: ['High'] as ImpactLevel[], // Only high-impact events for red dots\r\n          onlyUpcoming: false, // Include all events for the month, not just upcoming\r\n          limit: 500  // Reasonable limit for a full month of high-impact events\r\n        });\r\n\r\n        // Create a map of dates that have high-impact events\r\n        const eventDatesMap = new Map<string, boolean>();\r\n        events.forEach(event => {\r\n          eventDatesMap.set(event.event_date, true);\r\n        });\r\n\r\n        setHighImpactEventDates(eventDatesMap);\r\n        setLastUpdated(now);\r\n\r\n        // Cache the results with smart expiry\r\n        const cacheData = JSON.stringify(Array.from(eventDatesMap.entries()));\r\n        const metaData = JSON.stringify({\r\n          lastUpdated: now,\r\n          eventCount: events.length,\r\n          currencies: currencies.join(','),\r\n          monthType: isPreviousMonth ? 'previous' : (currentDate.getMonth() === new Date().getMonth() ? 'current' : 'future')\r\n        });\r\n\r\n        // Calculate expiry time based on month type\r\n        let expiryTime: number;\r\n        if (isPreviousMonth) {\r\n          // Previous months: Cache for 1 year (effectively permanent)\r\n          expiryTime = now + (365 * 24 * 60 * 60 * 1000);\r\n        } else if (currentDate.getMonth() === new Date().getMonth() && currentDate.getFullYear() === new Date().getFullYear()) {\r\n          // Current month: Cache until next Sunday\r\n          expiryTime = getNextSundayExpiry();\r\n        } else {\r\n          // Future months: Cache for 1 day\r\n          expiryTime = now + (24 * 60 * 60 * 1000);\r\n        }\r\n\r\n        localStorage.setItem(cacheKey, cacheData);\r\n        localStorage.setItem(cacheExpiryKey, expiryTime.toString());\r\n        localStorage.setItem(cacheMetaKey, metaData);\r\n\r\n        const cacheTypeMsg = isPreviousMonth ? 'permanently' :\r\n          (currentDate.getMonth() === new Date().getMonth() ? 'until next Sunday' : 'for 1 day');\r\n        log(` Found ${events.length} high-impact events for ${monthKey} [${currencies.join(', ')}] (cached ${cacheTypeMsg})`);\r\n        \r\n      } catch (fetchError) {\r\n        logError(' Error fetching high-impact events:', fetchError);\r\n        setError(fetchError instanceof Error ? fetchError.message : 'Failed to fetch events');\r\n\r\n        // If fetch fails, try to use expired cache as fallback\r\n        if (cachedData) {\r\n          log(` Using expired cache as fallback for ${monthKey}`);\r\n          try {\r\n            const eventDatesMap = new Map<string, boolean>(JSON.parse(cachedData));\r\n            setHighImpactEventDates(eventDatesMap);\r\n            setError('Using cached data (may be outdated)');\r\n          } catch (parseError) {\r\n            logError('Failed to parse fallback cache data');\r\n          }\r\n        }\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchHighImpactEvents();\r\n  }, [currentDate, calendarId, currenciesKey, enabled]);\r\n\r\n  return {\r\n    highImpactEventDates,\r\n    isLoading,\r\n    error,\r\n    lastUpdated\r\n  };\r\n};\r\n\r\n/**\r\n * Utility function to clear cache for specific calendar or all calendars\r\n * Can also clear cache for specific currencies\r\n */\r\nexport const clearHighImpactEventsCache = (calendarId?: string, currencies?: string[]) => {\r\n  const keys = Object.keys(localStorage);\r\n  const keysToRemove = keys.filter(key => {\r\n    if (!key.startsWith(CACHE_PREFIX)) return false;\r\n\r\n    if (calendarId) {\r\n      if (!key.includes(`_${calendarId}_`)) return false;\r\n    }\r\n\r\n    if (currencies) {\r\n      const currenciesHash = currencies.sort().join('-');\r\n      if (!key.includes(`_${currenciesHash}`)) return false;\r\n    }\r\n\r\n    return true;\r\n  });\r\n\r\n  keysToRemove.forEach(key => localStorage.removeItem(key));\r\n  log(` Cleared ${keysToRemove.length} cached high-impact event entries`);\r\n};\r\n\r\n/**\r\n * Clear cache entries for old currency combinations when currencies change\r\n */\r\nexport const clearOldCurrencyCache = (calendarId: string, newCurrencies: string[]) => {\r\n  const keys = Object.keys(localStorage);\r\n  const newCurrenciesHash = newCurrencies.sort().join('-');\r\n\r\n  const keysToRemove = keys.filter(key => {\r\n    if (!key.startsWith(CACHE_PREFIX)) return false;\r\n    if (!key.includes(`_${calendarId}_`)) return false;\r\n    if (key.includes(`_${newCurrenciesHash}`)) return false; // Keep current currency cache\r\n\r\n    return true; // Remove old currency combinations\r\n  });\r\n\r\n  keysToRemove.forEach(key => localStorage.removeItem(key));\r\n  if (keysToRemove.length > 0) {\r\n    log(` Cleared ${keysToRemove.length} old currency cache entries for calendar ${calendarId}`);\r\n  }\r\n};\r\n\r\n/**\r\n * Utility function to get cache info for debugging\r\n */\r\nexport const getHighImpactEventsCacheInfo = (calendarId?: string) => {\r\n  const keys = Object.keys(localStorage);\r\n  const cacheKeys = keys.filter(key => {\r\n    if (!key.startsWith(CACHE_PREFIX)) return false;\r\n    if (calendarId) {\r\n      return key.includes(`_${calendarId}_`);\r\n    }\r\n    return true;\r\n  });\r\n\r\n  const now = Date.now();\r\n\r\n  return cacheKeys.map(key => {\r\n    const data = localStorage.getItem(key);\r\n    let cacheInfo: any = {\r\n      key,\r\n      size: data ? data.length : 0\r\n    };\r\n\r\n    if (key.includes('_expiry')) {\r\n      const expiryTime = parseInt(data || '0');\r\n      const isExpired = now > expiryTime;\r\n      const isPermanent = expiryTime > now + (300 * 24 * 60 * 60 * 1000); // > 300 days\r\n\r\n      cacheInfo.isExpired = isExpired;\r\n      cacheInfo.isPermanent = isPermanent;\r\n      cacheInfo.expiresAt = isPermanent ? 'Never' : new Date(expiryTime).toLocaleString();\r\n    } else if (key.includes('_meta')) {\r\n      try {\r\n        const meta = JSON.parse(data || '{}');\r\n        cacheInfo.eventCount = meta.eventCount;\r\n        cacheInfo.monthType = meta.monthType;\r\n        cacheInfo.lastUpdated = new Date(meta.lastUpdated).toLocaleString();\r\n      } catch (e) {\r\n        // Ignore parse errors\r\n      }\r\n    }\r\n\r\n    return cacheInfo;\r\n  });\r\n};\r\n\r\n/**\r\n * Get cache strategy explanation for a given date\r\n */\r\nexport const getCacheStrategyInfo = (targetDate: Date) => {\r\n  const now = new Date();\r\n  const currentMonth = now.getMonth();\r\n  const currentYear = now.getFullYear();\r\n  const targetMonth = targetDate.getMonth();\r\n  const targetYear = targetDate.getFullYear();\r\n\r\n  if (targetYear < currentYear || (targetYear === currentYear && targetMonth < currentMonth)) {\r\n    return {\r\n      type: 'previous',\r\n      description: 'Previous month - cached permanently (events never change)',\r\n      refreshStrategy: 'Never refreshes automatically'\r\n    };\r\n  }\r\n\r\n  if (targetYear === currentYear && targetMonth === currentMonth) {\r\n    return {\r\n      type: 'current',\r\n      description: 'Current month - refreshes weekly on Sunday',\r\n      refreshStrategy: 'Refreshes every Sunday to catch new events'\r\n    };\r\n  }\r\n\r\n  return {\r\n    type: 'future',\r\n    description: 'Future month - refreshes daily',\r\n    refreshStrategy: 'Refreshes daily as events may be added/updated'\r\n  };\r\n};\r\n\r\n/**\r\n * Internal function to clean up expired cache entries\r\n * Respects permanent cache for previous months\r\n */\r\nconst cleanupExpiredCache = () => {\r\n  const keys = Object.keys(localStorage);\r\n  const now = Date.now();\r\n  let cleanedCount = 0;\r\n  let skippedPermanent = 0;\r\n\r\n  keys.forEach(key => {\r\n    if (!key.startsWith(CACHE_PREFIX)) return;\r\n\r\n    // Check if it's an expiry key\r\n    if (key.includes('_expiry')) {\r\n      const expiryTime = localStorage.getItem(key);\r\n      if (expiryTime) {\r\n        const expiry = parseInt(expiryTime);\r\n\r\n        // Skip cleanup for very long expiry times (previous months)\r\n        const oneYearFromNow = now + (365 * 24 * 60 * 60 * 1000);\r\n        if (expiry > oneYearFromNow) {\r\n          skippedPermanent++;\r\n          return;\r\n        }\r\n\r\n        // Clean up truly expired entries\r\n        if (now > expiry) {\r\n          const baseKey = key.replace('_expiry', '');\r\n          localStorage.removeItem(key);\r\n          localStorage.removeItem(baseKey);\r\n          localStorage.removeItem(`${baseKey}_meta`);\r\n          cleanedCount++;\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  if (cleanedCount > 0 || skippedPermanent > 0) {\r\n    log(` Cleaned up ${cleanedCount} expired cache entries, preserved ${skippedPermanent} permanent entries`);\r\n  }\r\n};\r\n","/**\r\n * Simple notification sound utility\r\n * Plays a notification sound when called\r\n */\r\n\r\nimport { logger } from './logger';\r\n\r\n// Fallback sound generation using Web Audio API\r\nconst generateFallbackSound = (): Promise<void> => {\r\n  return new Promise((resolve) => {\r\n    try {\r\n      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n      const oscillator = audioContext.createOscillator();\r\n      const gainNode = audioContext.createGain();\r\n\r\n      oscillator.connect(gainNode);\r\n      gainNode.connect(audioContext.destination);\r\n\r\n      // Create a pleasant notification sound\r\n      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);\r\n      oscillator.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);\r\n      oscillator.type = 'sine';\r\n\r\n      gainNode.gain.setValueAtTime(0, audioContext.currentTime);\r\n      gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);\r\n      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);\r\n\r\n      oscillator.start(audioContext.currentTime);\r\n      oscillator.stop(audioContext.currentTime + 0.2);\r\n\r\n      setTimeout(() => {\r\n        audioContext.close();\r\n        resolve();\r\n      }, 250);\r\n\r\n    } catch (error) {\r\n      resolve(); // Always resolve to avoid blocking\r\n    }\r\n  });\r\n};\r\n\r\n// Simple function to play notification sound\r\nexport const playNotificationSound = async (): Promise<void> => {\r\n  try {\r\n    // Try to play the downloaded MP3 file first\r\n    const audio = new Audio('/notification.mp3');\r\n    audio.volume = 0.6; // Set volume to 60%\r\n\r\n    const playPromise = audio.play();\r\n\r\n    if (playPromise !== undefined) {\r\n      await playPromise;\r\n    }\r\n  } catch (error) {\r\n    try {\r\n      // Fallback to generated sound if MP3 fails to load or play\r\n      await generateFallbackSound();\r\n    } catch (fallbackError) {\r\n      // Silently fail if sound can't be played\r\n      logger.debug('Could not play notification sound:', error);\r\n    }\r\n  }\r\n};\r\n","/**\r\n * useCalendarTrades Hook\r\n *\r\n * Hook for fetching and managing trades for a specific calendar with real-time subscriptions.\r\n * Handles trade additions, updates, and deletions with optimistic updates.\r\n */\r\n\r\nimport {\r\n  useCallback,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n  useTransition,\r\n} from \"react\";\r\nimport { Calendar, Trade } from \"../types/dualWrite\";\r\nimport * as calendarService from \"../services/calendarService\";\r\nimport { useRealtimeSubscription } from \"./useRealtimeSubscription\";\r\nimport { logger } from \"../utils/logger\";\r\nimport {\r\n  calculateEffectiveRiskPercentageAsync,\r\n  calculateRiskAmount,\r\n  DynamicRiskSettings,\r\n} from \"../utils/dynamicRiskUtils\";\r\nimport { supabase } from \"../config/supabase\";\r\nimport { useTradeSyncContextOptional } from \"../contexts/TradeSyncContext\";\r\nexport interface UseCalendarTradesOptions {\r\n  /**\r\n   * Calendar ID to fetch trades for\r\n   */\r\n  calendarId: string | undefined;\r\n  selectedCalendar?: Calendar | null;\r\n  setLoading: (\r\n    loading: boolean,\r\n    loadingAction: \"loading\" | \"importing\" | \"exporting\",\r\n  ) => void;\r\n\r\n  /**\r\n   * Whether to enable real-time subscriptions\r\n   * @default true\r\n   */\r\n  enableRealtime?: boolean;\r\n\r\n}\r\n\r\n/**\r\n * Custom hook to fetch and manage trades for a calendar with real-time updates\r\n */\r\nexport function useCalendarTrades(options: UseCalendarTradesOptions) {\r\n  const { calendarId, selectedCalendar, enableRealtime = true, setLoading } =\r\n    options;\r\n\r\n  // Get trade sync context for broadcasting updates to other components\r\n  const tradeSync = useTradeSyncContextOptional();\r\n\r\n  // Use Map for O(1) lookups instead of array\r\n  const [tradesMap, setTradesMap] = useState<Map<string, Trade>>(new Map());\r\n  const [calendar, setCalendar] = useState<Calendar | null>(null);\r\n  const [isLoading, setIsLoading] = useState<boolean>(false);\r\n  const [error, setError] = useState<Error | null>(null);\r\n  const [notification, setNotification] = useState<\r\n    { message: string; type: \"success\" | \"error\" } | null\r\n  >(null);\r\n  const [updatingTradeIds, setUpdatingTradeIds] = useState<Set<string>>(\r\n    new Set(),\r\n  );\r\n\r\n  // Cache for loaded trades to avoid redundant database queries\r\n  // Key format: \"month:YYYY-MM\" or \"range:START_ISO-END_ISO\"\r\n  const [tradesCache] = useState<Map<string, Map<string, Trade>>>(new Map());\r\n  const cacheAccessOrderRef = useRef<string[]>([]); // Track LRU order\r\n  const MAX_CACHE_SIZE = 12; // Store up to 12 different month/range loads\r\n\r\n  // Pagination state for server-side pagination\r\n  // Removed pagination state - we now load complete date ranges instead of pages\r\n\r\n  // Debounce refs for batching rapid broadcast updates\r\n  const calendarUpdateTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const pendingCalendarUpdateRef = useRef<Calendar | null>(null);\r\n\r\n  // useTransition for non-blocking state updates on heavy computations\r\n  const [, startTransition] = useTransition();\r\n\r\n  // Derive trades array from Map for backward compatibility\r\n  // useMemo ensures we only create new array when Map changes\r\n  const trades = useMemo(() => Array.from(tradesMap.values()), [tradesMap]);\r\n\r\n  // Helper to update tradesMap with O(1) operations\r\n  const updateTradesMap = useCallback((\r\n    updater: (prev: Map<string, Trade>) => Map<string, Trade>,\r\n  ) => {\r\n    setTradesMap((prev) => updater(prev));\r\n  }, []);\r\n\r\n  const clearNotification = useCallback(() => setNotification(null), []);\r\n\r\n  const isTradeUpdating = useCallback(\r\n    (tradeId: string) => updatingTradeIds.has(tradeId),\r\n    [updatingTradeIds],\r\n  );\r\n\r\n  // Helper for bulk updates (used in heavy computations)\r\n  const setTradesFromArray = useCallback((tradesArray: Trade[]) => {\r\n    const newMap = new Map<string, Trade>();\r\n    for (const trade of tradesArray) {\r\n      newMap.set(trade.id, trade);\r\n    }\r\n    setTradesMap(newMap);\r\n  }, []);\r\n\r\n  // Cache helper functions\r\n  const generateMonthCacheKey = useCallback((year: number, month: number) => {\r\n    return `month:${year}-${String(month + 1).padStart(2, '0')}`;\r\n  }, []);\r\n\r\n  const generateRangeCacheKey = useCallback((startDate: Date, endDate: Date) => {\r\n    return `range:${startDate.toISOString()}-${endDate.toISOString()}`;\r\n  }, []);\r\n\r\n  const getCachedTrades = useCallback((cacheKey: string): Map<string, Trade> | null => {\r\n    const cached = tradesCache.get(cacheKey);\r\n    if (cached) {\r\n      // Update LRU order - move this key to end (most recently used)\r\n      const orderArray = cacheAccessOrderRef.current;\r\n      const index = orderArray.indexOf(cacheKey);\r\n      if (index > -1) {\r\n        orderArray.splice(index, 1);\r\n      }\r\n      orderArray.push(cacheKey);\r\n      logger.log(` Cache HIT for ${cacheKey} (${cached.size} trades)`);\r\n      return cached;\r\n    }\r\n    logger.log(` Cache MISS for ${cacheKey}`);\r\n    return null;\r\n  }, [tradesCache]);\r\n\r\n  const setCachedTrades = useCallback((cacheKey: string, trades: Map<string, Trade>) => {\r\n    // Add to cache\r\n    tradesCache.set(cacheKey, new Map(trades)); // Store a copy\r\n\r\n    // Update LRU order\r\n    const orderArray = cacheAccessOrderRef.current;\r\n    const index = orderArray.indexOf(cacheKey);\r\n    if (index > -1) {\r\n      orderArray.splice(index, 1);\r\n    }\r\n    orderArray.push(cacheKey);\r\n\r\n    // Evict oldest entries if cache exceeds limit\r\n    while (orderArray.length > MAX_CACHE_SIZE) {\r\n      const oldestKey = orderArray.shift();\r\n      if (oldestKey) {\r\n        tradesCache.delete(oldestKey);\r\n        logger.log(` Cache EVICTED ${oldestKey} (exceeded ${MAX_CACHE_SIZE} limit)`);\r\n      }\r\n    }\r\n\r\n    logger.log(` Cache SET ${cacheKey} (${trades.size} trades, total cached: ${tradesCache.size})`);\r\n  }, [tradesCache, MAX_CACHE_SIZE]);\r\n\r\n  const clearTradesCache = useCallback(() => {\r\n    tradesCache.clear();\r\n    cacheAccessOrderRef.current = [];\r\n    logger.log(' Cache CLEARED');\r\n  }, [tradesCache]);\r\n\r\n  /**\r\n   * Update a specific trade in all relevant cache entries\r\n   * More efficient than invalidating the entire cache\r\n   * Handles date changes by removing from old caches and adding to new ones\r\n   */\r\n  const updateTradeInCache = useCallback((trade: Trade) => {\r\n    const tradeDate = new Date(trade.trade_date);\r\n    let removedCount = 0;\r\n    let addedCount = 0;\r\n\r\n    // First pass: Remove from all caches and track where it should be\r\n    tradesCache.forEach((cachedTradesMap, cacheKey) => {\r\n      const hadTrade = cachedTradesMap.has(trade.id);\r\n      let shouldHaveTrade = false;\r\n\r\n      if (cacheKey.startsWith('month:')) {\r\n        // Extract year and month from key \"month:YYYY-MM\"\r\n        const [, yearMonth] = cacheKey.split(':');\r\n        const [year, month] = yearMonth.split('-').map(Number);\r\n\r\n        // Check if trade belongs to this month based on NEW date\r\n        shouldHaveTrade = tradeDate.getFullYear() === year && tradeDate.getMonth() === month - 1;\r\n      } else if (cacheKey.startsWith('range:')) {\r\n        // Extract date range from key \"range:START_ISO-END_ISO\"\r\n        const [, dateRange] = cacheKey.split('range:');\r\n        const [startISO, endISO] = dateRange.split('-');\r\n        const startDate = new Date(startISO);\r\n        const endDate = new Date(endISO);\r\n\r\n        // Check if trade belongs to this range based on NEW date\r\n        shouldHaveTrade = tradeDate >= startDate && tradeDate <= endDate;\r\n      }\r\n\r\n      // Update cache based on whether trade should be in this cache\r\n      if (shouldHaveTrade && !hadTrade) {\r\n        cachedTradesMap.set(trade.id, trade);\r\n        addedCount++;\r\n      } else if (shouldHaveTrade && hadTrade) {\r\n        cachedTradesMap.set(trade.id, trade); // Update existing\r\n        addedCount++;\r\n      } else if (!shouldHaveTrade && hadTrade) {\r\n        cachedTradesMap.delete(trade.id); // Remove from wrong cache\r\n        removedCount++;\r\n      }\r\n    });\r\n\r\n    if (addedCount > 0 || removedCount > 0) {\r\n      logger.log(` Cache UPDATED trade ${trade.id}: added to ${addedCount}, removed from ${removedCount} cached entries`);\r\n    }\r\n  }, [tradesCache]);\r\n\r\n  /**\r\n   * Remove a specific trade from all cache entries\r\n   */\r\n  const removeTradeFromCache = useCallback((tradeId: string, tradeDate?: Date) => {\r\n    let removedCount = 0;\r\n\r\n    tradesCache.forEach((cachedTradesMap, cacheKey) => {\r\n      if (cachedTradesMap.has(tradeId)) {\r\n        cachedTradesMap.delete(tradeId);\r\n        removedCount++;\r\n      }\r\n    });\r\n\r\n    if (removedCount > 0) {\r\n      logger.log(` Cache REMOVED trade ${tradeId} from ${removedCount} cached entries`);\r\n    }\r\n  }, [tradesCache]);\r\n\r\n  /**\r\n   * Fetch all trades for the calendar\r\n   * Used internally for dynamic risk calculations (not for initial page load)\r\n   */\r\n  const fetchAllTrades = useCallback(async () => {\r\n    setCalendar(selectedCalendar || null);\r\n    if (!calendarId) {\r\n      setTradesMap(new Map());\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const [calendar, allTrades] = await Promise.all([calendarService.getCalendar(calendarId),calendarService.getAllTrades(calendarId)])\r\n      setCalendar(calendar);\r\n      setTradesFromArray(allTrades);\r\n      logger.log(  ` Loaded all ${allTrades.length} trades for calendar ${calendarId}`,);\r\n    } catch (err) {\r\n      const error = err instanceof Error\r\n        ? err\r\n        : new Error(\"Failed to fetch trades\");\r\n      logger.error(\"Error fetching trades:\", error);\r\n      setError(error);\r\n      setTradesMap(new Map());\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [calendarId, setTradesFromArray, selectedCalendar]);\r\n\r\n\r\n  useEffect(() => {\r\n    setLoading(isLoading, \"loading\");\r\n  }, [isLoading]);\r\n\r\n  // Initialize calendar from selectedCalendar prop\r\n  // This is needed because loadVisibleRangeTrades doesn't set calendar state\r\n  useEffect(() => {\r\n    if (selectedCalendar) {\r\n      setCalendar(selectedCalendar);\r\n    }\r\n  }, [selectedCalendar]);\r\n\r\n  /**\r\n   * Cleanup on unmount or calendar change\r\n   * Note: Initial trades loading is handled by TradeCalendarPage via loadVisibleRangeTrades()\r\n   */\r\n  useEffect(() => {\r\n    // Cleanup on unmount or when calendar changes\r\n    return () => {\r\n      // Cleanup debounce timeout on unmount\r\n      if (calendarUpdateTimeoutRef.current) {\r\n        clearTimeout(calendarUpdateTimeoutRef.current);\r\n      }\r\n      // Clear trades cache when calendar changes or component unmounts\r\n      clearTradesCache();\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [calendarId]);\r\n\r\n  /**\r\n   * Add a trade with optimistic update\r\n   */\r\n  const addTrade = useCallback(\r\n    async (trade: Trade) => {\r\n      if (!calendarId) {\r\n        throw new Error(\"Calendar ID is required\");\r\n      }\r\n\r\n      setUpdatingTradeIds((prev) => {\r\n        const next = new Set(prev);\r\n        next.add(trade.id);\r\n        return next;\r\n      });\r\n      // Broadcast updating state to context (for TradeList progress indicators)\r\n      tradeSync?.setTradeUpdating(trade.id, true);\r\n\r\n      // Optimistic update - O(1) Map set\r\n      updateTradesMap((prev) => {\r\n        const next = new Map(prev);\r\n        next.set(trade.id, trade);\r\n        return next;\r\n      });\r\n\r\n      try {\r\n        await calendarService.addTrade(calendarId, trade);\r\n        logger.log(` Trade added: ${trade.id}`);\r\n\r\n        // Update cache with the new trade\r\n        updateTradeInCache(trade);\r\n\r\n        // Broadcast insert to other components (e.g., PerformanceCharts)\r\n        tradeSync?.broadcastTradeInsert(trade);\r\n\r\n        setNotification({\r\n          message: \"Trade added successfully\",\r\n          type: \"success\",\r\n        });\r\n        // Real-time subscription will handle the update\r\n      } catch (err) {\r\n        // Revert optimistic update on error - O(1) Map delete\r\n        updateTradesMap((prev) => {\r\n          const next = new Map(prev);\r\n          next.delete(trade.id);\r\n          return next;\r\n        });\r\n        logger.error(\"Error adding trade:\", err);\r\n        setNotification({\r\n          message: err instanceof Error ? err.message : \"Failed to add trade\",\r\n          type: \"error\",\r\n        });\r\n        throw err;\r\n      } finally {\r\n        setUpdatingTradeIds((prev) => {\r\n          const next = new Set(prev);\r\n          next.delete(trade.id);\r\n          return next;\r\n        });\r\n        // Broadcast updating state to context\r\n        tradeSync?.setTradeUpdating(trade.id, false);\r\n      }\r\n    },\r\n    [calendarId, updateTradesMap, updateTradeInCache, tradeSync],\r\n  );\r\n\r\n  const handleUpdateTradeProperty = async (\r\n    tradeId: string,\r\n    updateCallback: (trade: Trade) => Trade,\r\n    createIfNotExists?: (tradeId: string) => Trade,\r\n  ): Promise<Trade | undefined> => {\r\n    // Find the calendar from state\r\n    if (!calendar) {\r\n      throw new Error(`Calendar with ID ${calendarId} not found`);\r\n    }\r\n\r\n    setUpdatingTradeIds((prev) => {\r\n      const next = new Set(prev);\r\n      next.add(tradeId);\r\n      return next;\r\n    });\r\n    // Broadcast updating state to context (for TradeList progress indicators)\r\n    tradeSync?.setTradeUpdating(tradeId, true);\r\n\r\n    try {\r\n      // Check if trade exists in cached trades first\r\n      let existingTrade = tradesMap.get(tradeId) || await calendarService.getTrade(calendar.id, tradeId);\r\n      // If trade doesn't exist and we have a create function, create it\r\n      if (!existingTrade && createIfNotExists) {\r\n        // Create in database with all updates already applied\r\n        const finalTrade = await calendarService.addTrade(\r\n          calendar.id,\r\n          updateCallback(createIfNotExists(tradeId)),\r\n        );\r\n\r\n        // O(1) Map set\r\n        updateTradesMap((prev) => {\r\n          const next = new Map(prev);\r\n          next.set(finalTrade.id, finalTrade);\r\n          return next;\r\n        });\r\n\r\n        // Update cache with the new trade\r\n        updateTradeInCache(finalTrade);\r\n\r\n        // Broadcast insert to other components (e.g., PerformanceCharts)\r\n        tradeSync?.broadcastTradeInsert(finalTrade);\r\n\r\n        setNotification({\r\n          message: \"Trade created successfully\",\r\n          type: \"success\",\r\n        });\r\n        return finalTrade;\r\n      }\r\n      if (!existingTrade) {\r\n        throw new Error(`Trade with ID ${tradeId} not found`);\r\n      }\r\n      // Normal update flow for existing trades\r\n      const result = await calendarService.updateTrade(\r\n        existingTrade,\r\n        updateCallback,\r\n      );\r\n      if (!result) {\r\n        return undefined;\r\n      }\r\n      // O(1) Map set instead of O(n) map\r\n      updateTradesMap((prev) => {\r\n        const next = new Map(prev);\r\n        next.set(tradeId, result);\r\n        return next;\r\n      });\r\n\r\n      // Update cache with the updated trade\r\n      updateTradeInCache(result);\r\n\r\n      // Broadcast update to other components (e.g., PerformanceCharts)\r\n      tradeSync?.broadcastTradeUpdate(result);\r\n\r\n      setNotification({\r\n        message: \"Trade updated successfully\",\r\n        type: \"success\",\r\n      });\r\n      return result;\r\n    } catch (error) {\r\n      logger.error(\"Error updating trade:\", error);\r\n      setNotification({\r\n        message: error instanceof Error\r\n          ? error.message\r\n          : \"Failed to update trade\",\r\n        type: \"error\",\r\n      });\r\n      throw error;\r\n    } finally {\r\n      setUpdatingTradeIds((prev) => {\r\n        const next = new Set(prev);\r\n        next.delete(tradeId);\r\n        return next;\r\n      });\r\n      // Broadcast updating state to context\r\n      tradeSync?.setTradeUpdating(tradeId, false);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Delete trades with optimistic update\r\n   */\r\n  const deleteTrades = useCallback(\r\n    async (tradeIds: string[]) => {\r\n      if (!calendarId) {\r\n        throw new Error(\"Calendar ID is required\");\r\n      }\r\n\r\n      setUpdatingTradeIds((prev) => {\r\n        const next = new Set(prev);\r\n        tradeIds.forEach((id) => next.add(id));\r\n        return next;\r\n      });\r\n      // Broadcast updating state to context (for TradeList progress indicators)\r\n      tradeIds.forEach((id) => tradeSync?.setTradeUpdating(id, true));\r\n\r\n      // Store previous map for rollback and collect trades for broadcast\r\n      let previousMap: Map<string, Trade> = new Map();\r\n      const deletedTrades: Trade[] = [];\r\n\r\n      // Optimistic update - O(k) where k is number of trades to delete\r\n      updateTradesMap((prev) => {\r\n        previousMap = prev;\r\n        const next = new Map(prev);\r\n        for (const id of tradeIds) {\r\n          const trade = prev.get(id);\r\n          if (trade) {\r\n            deletedTrades.push(trade);\r\n          }\r\n          next.delete(id);\r\n        }\r\n        return next;\r\n      });\r\n\r\n      try {\r\n        // Delete trades one by one\r\n        await Promise.all(\r\n          tradeIds.map((tradeId) => calendarService.deleteTrade(tradeId)),\r\n        );\r\n        logger.log(` Deleted ${tradeIds.length} trade(s)`);\r\n\r\n        // Remove deleted trades from cache\r\n        tradeIds.forEach((tradeId) => removeTradeFromCache(tradeId));\r\n\r\n        // Broadcast delete to other components (e.g., PerformanceCharts)\r\n        deletedTrades.forEach((trade) => tradeSync?.broadcastTradeDelete(trade));\r\n\r\n        setNotification({\r\n          message: `Deleted ${tradeIds.length} trade(s)`,\r\n          type: \"success\",\r\n        });\r\n        // Real-time subscription will handle the update\r\n      } catch (err) {\r\n        // Revert optimistic update on error\r\n        setTradesMap(previousMap);\r\n        logger.error(\"Error deleting trades:\", err);\r\n        setNotification({\r\n          message: err instanceof Error\r\n            ? err.message\r\n            : \"Failed to delete trades\",\r\n          type: \"error\",\r\n        });\r\n        throw err;\r\n      } finally {\r\n        setUpdatingTradeIds((prev) => {\r\n          const next = new Set(prev);\r\n          tradeIds.forEach((id) => next.delete(id));\r\n          return next;\r\n        });\r\n        // Broadcast updating state to context\r\n        tradeIds.forEach((id) => tradeSync?.setTradeUpdating(id, false));\r\n      }\r\n    },\r\n    [calendarId, updateTradesMap, removeTradeFromCache, tradeSync],\r\n  );\r\n\r\n  // Function to handle dynamic risk toggle\r\n  const handleToggleDynamicRisk = useCallback(async (\r\n    useActualAmounts: boolean,\r\n  ) => {\r\n    // Use calendar from hook state\r\n    if (!calendar) return;\r\n\r\n    // If using actual amounts, reload the original trades from the database\r\n    if (useActualAmounts) {\r\n      logger.log(\"Resetting to actual trade amounts...\");\r\n      // Reload all trades for the calendar to get the original values\r\n      fetchAllTrades(); // Load all trades for dynamic risk calculation\r\n      return;\r\n    }\r\n\r\n    // Load all trades before recalculation since we use pagination\r\n    logger.log(\"Loading all trades for dynamic risk recalculation...\");\r\n    setIsLoading(true);\r\n    const allTrades = await calendarService.getAllTrades(calendar.id);\r\n    setTradesFromArray(allTrades);\r\n    setIsLoading(false);\r\n\r\n    // Recalculate ALL trade amounts based on risk to reward to show potential with consistent risk management\r\n    // Optimized with batch processing to prevent UI freeze with 500+ trades\r\n    const recalculateTrades = async () => {\r\n      if (!calendar.risk_per_trade || !allTrades.length) {\r\n        return;\r\n      }\r\n\r\n      logger.log(\r\n        \"Recalculating ALL trades based on risk to reward to show potential...\",\r\n      );\r\n\r\n      // Sort trades by date to calculate cumulative P&L correctly\r\n      const sortedTrades = [...allTrades].sort((a, b) =>\r\n        new Date(a.trade_date).getTime() - new Date(b.trade_date).getTime()\r\n      );\r\n\r\n      // Define dynamic risk settings once outside the loop\r\n      const dynamicRiskSettings: DynamicRiskSettings = {\r\n        account_balance: calendar.account_balance,\r\n        risk_per_trade: calendar.risk_per_trade,\r\n        dynamic_risk_enabled: calendar.dynamic_risk_enabled,\r\n        increased_risk_percentage: calendar.increased_risk_percentage,\r\n        profit_threshold_percentage: calendar.profit_threshold_percentage,\r\n      };\r\n\r\n      // Build array of recalculated trades as we go\r\n      const updatedTrades: Trade[] = [];\r\n      let cumulativePnL = 0;\r\n\r\n      // Process trades in batches to prevent UI freeze\r\n      const BATCH_SIZE = 50; // Process 50 trades at a time\r\n      const totalBatches = Math.ceil(sortedTrades.length / BATCH_SIZE);\r\n\r\n      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {\r\n        const start = batchIndex * BATCH_SIZE;\r\n        const end = Math.min(start + BATCH_SIZE, sortedTrades.length);\r\n        const batch = sortedTrades.slice(start, end);\r\n\r\n        // Process current batch\r\n        for (let i = 0; i < batch.length; i++) {\r\n          const trade = batch[i];\r\n\r\n          // Skip trades without risk to reward ratio\r\n          if (!trade.risk_to_reward || trade.trade_type === \"breakeven\") {\r\n            cumulativePnL += trade.amount;\r\n            updatedTrades.push(trade);\r\n            continue;\r\n          }\r\n\r\n          // Use the already-recalculated trades for effective risk calculation\r\n          const effectiveRisk = await calculateEffectiveRiskPercentageAsync(\r\n            new Date(trade.trade_date),\r\n            calendar,\r\n            dynamicRiskSettings,\r\n            updatedTrades, //  Use recalculated trades, not original\r\n          );\r\n\r\n          const riskAmount = calculateRiskAmount(\r\n            effectiveRisk,\r\n            calendar.account_balance,\r\n            cumulativePnL,\r\n          );\r\n\r\n          // Calculate new amount based on trade type and risk to reward\r\n          let newAmount = 0;\r\n          if (trade.trade_type === \"win\") {\r\n            newAmount = Math.round(riskAmount * trade.risk_to_reward);\r\n          } else if (trade.trade_type === \"loss\") {\r\n            newAmount = -Math.round(riskAmount);\r\n          }\r\n\r\n          // Update cumulative P&L with the new amount\r\n          cumulativePnL += newAmount;\r\n\r\n          // Add the recalculated trade to the array\r\n          updatedTrades.push({\r\n            ...trade,\r\n            amount: newAmount,\r\n          });\r\n        }\r\n\r\n        // Yield to browser every batch to keep UI responsive\r\n        // This allows the browser to update the UI, handle events, etc.\r\n        if (batchIndex < totalBatches - 1) {\r\n          await new Promise((resolve) => setTimeout(resolve, 0));\r\n          logger.log(\r\n            `Processed batch ${batchIndex + 1}/${totalBatches} (${updatedTrades.length}/${sortedTrades.length} trades)`,\r\n          );\r\n        }\r\n      }\r\n\r\n      logger.log(` Completed recalculation of ${updatedTrades.length} trades`);\r\n\r\n      // Calculate stats with hypothetical trades (does NOT update database)\r\n      const stats = await calendarService.calculateCalendarStats(\r\n        calendar.id,\r\n        updatedTrades,\r\n      );\r\n\r\n      // Update the calendar state with recalculated trades and the hypothetical stats\r\n      // Use startTransition for this heavy update to keep UI responsive\r\n      startTransition(() => {\r\n        setTradesFromArray(updatedTrades);\r\n        setCalendar({\r\n          ...calendar,\r\n          ...stats,\r\n        });\r\n      });\r\n    };\r\n\r\n    // Execute the recalculation and get the results\r\n    setIsLoading(true);\r\n    await recalculateTrades();\r\n    setIsLoading(false);\r\n  }, [calendar, trades, fetchAllTrades, startTransition, setTradesFromArray]);\r\n\r\n  const handleImportTrades = useCallback(async (\r\n    importedTrades: Partial<Trade>[],\r\n  ) => {\r\n    if (!calendar) {\r\n      throw new Error(`Calendar with ID ${calendarId} not found`);\r\n    }\r\n\r\n    try {\r\n      // All trades are already loaded with date-range loading\r\n\r\n      // Show loading indicator\r\n      setIsLoading(true);\r\n      const result = await calendarService.importTrades(\r\n        calendar.id,\r\n        trades,\r\n        importedTrades,\r\n      );\r\n      setTradesFromArray(result);\r\n\r\n      // Clear cache since multiple trades were imported across different dates\r\n      clearTradesCache();\r\n    } catch (error) {\r\n      logger.error(\"Error importing trades:\", error);\r\n      throw error;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [calendar, calendarId, trades, setTradesFromArray, clearTradesCache]);\r\n\r\n  /**\r\n   * Subscribe to calendar changes with real-time updates using Broadcast\r\n   */\r\n  useRealtimeSubscription({\r\n    channelName: `calendar-${calendarId}`,\r\n    enabled: enableRealtime && !!calendarId,\r\n    onChannelCreated: (channel) => {\r\n      logger.log(\r\n        ` Setting up calendar broadcast subscription for calendar-${calendarId}`,\r\n      );\r\n\r\n      // Listen for ALL broadcast events with debouncing to prevent multiple re-renders\r\n      channel.on(\r\n        \"broadcast\",\r\n        {\r\n          event: \"*\", // Listen to all events\r\n        },\r\n        (payload: any) => {\r\n          logger.log(\r\n            ` Broadcast event received on calendar-${calendarId}:`,\r\n            payload,\r\n          );\r\n          // The payload structure from realtime.broadcast_changes is:\r\n          // { event: \"UPDATE\", type: \"broadcast\", payload: { record: {...}, old_record: {...}, ... } }\r\n          if (payload.event === \"UPDATE\" && payload.payload?.record) {\r\n            const updatedCalendarData = payload.payload.record as Calendar;\r\n\r\n            // Store the latest update\r\n            pendingCalendarUpdateRef.current = updatedCalendarData;\r\n\r\n            // Clear any existing timeout\r\n            if (calendarUpdateTimeoutRef.current) {\r\n              clearTimeout(calendarUpdateTimeoutRef.current);\r\n            }\r\n\r\n            // Debounce: wait 150ms for more updates before applying\r\n            calendarUpdateTimeoutRef.current = setTimeout(() => {\r\n              if (pendingCalendarUpdateRef.current) {\r\n                logger.log(` Applying debounced calendar update`);\r\n                setCalendar(pendingCalendarUpdateRef.current);\r\n                pendingCalendarUpdateRef.current = null;\r\n              }\r\n            }, 150);\r\n          }\r\n        },\r\n      );\r\n    },\r\n    onSubscribed: () => {\r\n      logger.log(\r\n        ` Calendar broadcast subscription ACTIVE for calendar-${calendarId}`,\r\n      );\r\n    },\r\n    onError: (error) => {\r\n      logger.error(\r\n        ` Calendar broadcast subscription ERROR for calendar-${calendarId}:`,\r\n        error,\r\n      );\r\n    },\r\n  });\r\n\r\n  /**\r\n   * Subscribe to trade changes with real-time updates using Broadcast\r\n   */\r\n  useRealtimeSubscription({\r\n    channelName: `trades-${calendarId}`,\r\n    enabled: enableRealtime && !!calendarId,\r\n    onChannelCreated: (channel) => {\r\n      // Listen for INSERT events\r\n      channel.on(\r\n        \"broadcast\",\r\n        {\r\n          event: \"INSERT\",\r\n        },\r\n        (payload: any) => {\r\n          if (payload.payload?.record) {\r\n            const newTrade = payload.payload.record as Trade;\r\n            // O(1) Map operations instead of O(n) array operations\r\n            setTradesMap((prev) => {\r\n              if (prev.has(newTrade.id)) return prev;\r\n              const next = new Map(prev);\r\n              next.set(newTrade.id, newTrade);\r\n              return next;\r\n            });\r\n\r\n            // Update cache with the new trade\r\n            updateTradeInCache(newTrade);\r\n\r\n            logger.log(` Trade added via broadcast: ${newTrade.id}`);\r\n          }\r\n        },\r\n      );\r\n\r\n      // Listen for UPDATE events\r\n      channel.on(\r\n        \"broadcast\",\r\n        {\r\n          event: \"UPDATE\",\r\n        },\r\n        (payload: any) => {\r\n          if (payload.payload?.record) {\r\n            const updatedTrade = payload.payload.record as Trade;\r\n            // O(1) Map set instead of O(n) map\r\n            setTradesMap((prev) => {\r\n              const next = new Map(prev);\r\n              next.set(updatedTrade.id, updatedTrade);\r\n              return next;\r\n            });\r\n\r\n            // Update cache with the updated trade (handles date changes)\r\n            updateTradeInCache(updatedTrade);\r\n\r\n            logger.log(` Trade updated via broadcast: ${updatedTrade.id}`);\r\n          }\r\n        },\r\n      );\r\n\r\n      // Listen for DELETE events\r\n      channel.on(\r\n        \"broadcast\",\r\n        {\r\n          event: \"DELETE\",\r\n        },\r\n        (payload: any) => {\r\n          if (payload.payload?.old_record) {\r\n            const deletedTrade = payload.payload.old_record as Trade;\r\n            // O(1) Map delete instead of O(n) filter\r\n            setTradesMap((prev) => {\r\n              const next = new Map(prev);\r\n              next.delete(deletedTrade.id);\r\n              return next;\r\n            });\r\n\r\n            // Remove deleted trade from cache\r\n            removeTradeFromCache(deletedTrade.id);\r\n\r\n            logger.log(` Trade deleted via broadcast: ${deletedTrade.id}`);\r\n          }\r\n        },\r\n      );\r\n    },\r\n    onSubscribed: () => {\r\n      logger.log(\r\n        ` Trade broadcast subscription ACTIVE for calendar-${calendarId}`,\r\n      );\r\n    },\r\n    onError: (error) => {\r\n      logger.error(\r\n        ` Trade broadcast subscription ERROR for calendar-${calendarId}:`,\r\n        error,\r\n      );\r\n    },\r\n  });\r\n\r\n  // Handler for account balance changes\r\n  const handleAccountBalanceChange = useCallback(async (newBalance: number) => {\r\n    if (!calendar) {\r\n      throw new Error(`Calendar with ID ${calendarId} not found`);\r\n    }\r\n\r\n    try {\r\n      await calendarService.updateCalendar(calendar.id, {\r\n        account_balance: newBalance,\r\n      });\r\n      // Update local calendar state\r\n      setCalendar((prev) =>\r\n        prev ? { ...prev, account_balance: newBalance } : prev\r\n      );\r\n    } catch (error) {\r\n      logger.error(\"Error updating account balance:\", error);\r\n      throw error;\r\n    }\r\n  }, [calendar, calendarId]);\r\n\r\n  // Handler for clearing month trades\r\n  const handleClearMonthTrades = useCallback(\r\n    async (month: number, year: number) => {\r\n      if (!calendar) {\r\n        throw new Error(`Calendar with ID ${calendarId} not found`);\r\n      }\r\n      try {\r\n        const tradesToDelete: Trade[] = [];\r\n\r\n        // O(n) single pass to identify trades to delete\r\n        setTradesMap((prev) => {\r\n          const next = new Map<string, Trade>();\r\n          prev.forEach((trade, id) => {\r\n            const tradeDate = new Date(trade.trade_date);\r\n            if (\r\n              tradeDate.getFullYear() === year && tradeDate.getMonth() === month\r\n            ) {\r\n              tradesToDelete.push(trade);\r\n            } else {\r\n              next.set(id, trade);\r\n            }\r\n          });\r\n          return next;\r\n        });\r\n\r\n        await calendarService.getTradeRepository().bulkDelete(tradesToDelete);\r\n\r\n        // Remove deleted trades from cache\r\n        tradesToDelete.forEach((trade) => removeTradeFromCache(trade.id));\r\n\r\n        // Stats are automatically recalculated by Supabase triggers after clearMonthTrades\r\n        // No need to manually calculate or update stats\r\n      } catch (error) {\r\n        logger.error(\"Error clearing month trades:\", error);\r\n      }\r\n    },\r\n    [calendar, calendarId, removeTradeFromCache],\r\n  );\r\n\r\n  /**\r\n   * Handler for updating calendar properties\r\n   */\r\n  const handleUpdateCalendarProperty = useCallback(async (\r\n    updateCallback: (calendar: Calendar) => Calendar,\r\n  ): Promise<Calendar | undefined> => {\r\n    if (!calendar) {\r\n      throw new Error(`Calendar with ID ${calendarId} not found`);\r\n    }\r\n\r\n    try {\r\n      const updatedCalendar = await calendarService.updateCalendar(\r\n        calendar.id,\r\n        updateCallback(calendar),\r\n      );\r\n\r\n      if (updatedCalendar) {\r\n        // Update local calendar state\r\n        setCalendar(updatedCalendar);\r\n        return updatedCalendar;\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error updating calendar:\", error);\r\n      throw error;\r\n    }\r\n    return undefined;\r\n  }, [calendar, calendarId]);\r\n\r\n  /**\r\n   * Handle tag updates using Supabase Edge Function\r\n   * This is the single source of truth for tag updates\r\n   */\r\n  const onTagUpdated = useCallback(async (\r\n    oldTag: string,\r\n    newTag: string,\r\n  ): Promise<{ success: boolean; tradesUpdated: number }> => {\r\n    if (!calendarId) {\r\n      logger.error(\"Cannot update tag: calendarId is undefined\");\r\n      return { success: false, tradesUpdated: 0 };\r\n    }\r\n\r\n    try {\r\n      // Optimistically update the UI\r\n\r\n      logger.log(\r\n        ` Updating tag via edge function: \"${oldTag}\"  \"${newTag}\"`,\r\n      );\r\n\r\n      // Call Supabase Edge Function to update tag\r\n      const { data, error: invokeError } = await supabase.functions.invoke(\r\n        \"update-tag\",\r\n        {\r\n          body: {\r\n            calendar_id: calendarId,\r\n            old_tag: oldTag,\r\n            new_tag: newTag,\r\n          },\r\n        },\r\n      );\r\n\r\n      if (invokeError) {\r\n        logger.error(\"Edge function error:\", invokeError);\r\n        throw invokeError;\r\n      }\r\n\r\n      if (data && data.success) {\r\n        logger.log(\r\n          ` Tag updated successfully: ${data.tradesUpdated} trades affected`,\r\n        );\r\n        // Real-time subscription will handle the UI update via broadcast\r\n        return { success: true, tradesUpdated: data.tradesUpdated || 0 };\r\n      } else {\r\n        logger.error(\"Tag update failed:\", data?.message || \"Unknown error\");\r\n        logger.error(\"Full response data:\", data);\r\n        return { success: false, tradesUpdated: 0 };\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error updating tag:\", error);\r\n      return { success: false, tradesUpdated: 0 };\r\n    }\r\n  }, [calendarId]);\r\n\r\n  /**\r\n   * Load trades for a specific month\r\n   * Used for on-demand loading when user selects a month in SelectDateDialog\r\n   * @param year - Year (e.g., 2024)\r\n   * @param month - Month index (0-11, where 0 = January)\r\n   */\r\n  const loadMonthTrades = useCallback(async (year: number, month: number) => {\r\n    if (!calendarId) {\r\n      logger.error(\"Cannot load month trades: calendarId is undefined\");\r\n      return;\r\n    }\r\n\r\n    // Check cache first\r\n    const cacheKey = generateMonthCacheKey(year, month);\r\n    const cachedTrades = getCachedTrades(cacheKey);\r\n\r\n    if (cachedTrades) {\r\n      // Use cached trades\r\n      setTradesMap(cachedTrades);\r\n      logger.log(` Using cached trades for ${year}-${month + 1} (${cachedTrades.size} trades)`);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      logger.log(` Loading trades for ${year}-${month + 1} from database`);\r\n\r\n      // Fetch trades for the specific month using TradeRepository\r\n      const monthTrades = await calendarService\r\n        .getTradeRepository()\r\n        .getTradesByMonth(calendarId, year, month);\r\n\r\n      // Convert to Map for caching\r\n      const tradesMap = new Map<string, Trade>();\r\n      for (const trade of monthTrades) {\r\n        tradesMap.set(trade.id, trade);\r\n      }\r\n\r\n      // Cache the trades\r\n      setCachedTrades(cacheKey, tradesMap);\r\n\r\n      // Replace current trades with month trades\r\n      setTradesFromArray(monthTrades);\r\n\r\n      logger.log(` Loaded ${monthTrades.length} trades for ${year}-${month + 1}`);\r\n    } catch (err) {\r\n      const error = err instanceof Error\r\n        ? err\r\n        : new Error(\"Failed to load month trades\");\r\n      logger.error(\"Error loading month trades:\", error);\r\n      setError(error);\r\n      setTradesMap(new Map());\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [calendarId, setTradesFromArray, generateMonthCacheKey, getCachedTrades, setCachedTrades]);\r\n\r\n  /**\r\n   * Load trades for the visible calendar date range\r\n   * Includes overflow days from adjacent months to show complete calendar grid\r\n   * @param startDate - First day visible in calendar grid\r\n   * @param endDate - Last day visible in calendar grid\r\n   */\r\n  const loadVisibleRangeTrades = useCallback(async (startDate: Date, endDate: Date) => {\r\n    if (!calendarId) {\r\n      logger.error(\"Cannot load visible range trades: calendarId is undefined\");\r\n      return;\r\n    }\r\n\r\n    // Check cache first\r\n    const cacheKey = generateRangeCacheKey(startDate, endDate);\r\n    const cachedTrades = getCachedTrades(cacheKey);\r\n\r\n    if (cachedTrades) {\r\n      // Use cached trades\r\n      setTradesMap(cachedTrades);\r\n      logger.log(` Using cached trades for visible range (${cachedTrades.size} trades)`);\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      logger.log(` Loading visible calendar range from database`);\r\n\r\n      // Fetch trades for the visible date range using TradeRepository\r\n      const rangeTrades = await calendarService\r\n        .getTradeRepository()\r\n        .getTradesByDateRange(calendarId, startDate, endDate);\r\n\r\n      // Convert to Map for caching\r\n      const tradesMap = new Map<string, Trade>();\r\n      for (const trade of rangeTrades) {\r\n        tradesMap.set(trade.id, trade);\r\n      }\r\n\r\n      // Cache the trades\r\n      setCachedTrades(cacheKey, tradesMap);\r\n\r\n      // Replace current trades with range trades\r\n      setTradesFromArray(rangeTrades);\r\n\r\n      logger.log(` Loaded ${rangeTrades.length} trades for visible range`);\r\n    } catch (err) {\r\n      const error = err instanceof Error\r\n        ? err\r\n        : new Error(\"Failed to load visible range trades\");\r\n      logger.error(\"Error loading visible range trades:\", error);\r\n      setError(error);\r\n      setTradesMap(new Map());\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [calendarId, setTradesFromArray, generateRangeCacheKey, getCachedTrades, setCachedTrades]);\r\n\r\n  function tagUpdateUIState(oldTag: string, newTag: string) {\r\n    // Use calendar from hook state\r\n    if (!calendar) {\r\n      throw new Error(`Calendar with ID ${calendarId} not found`);\r\n    }\r\n    logger.log(`Updating trades for tag change: ${oldTag} -> ${newTag}`);\r\n    // Helper function to update tags in an array, handling group name changes\r\n    const updateTagsWithGroupNameChange = (tags: string[]) => {\r\n      // Check if this is a group name change\r\n      const oldGroup = oldTag.includes(\":\") ? oldTag.split(\":\")[0] : null;\r\n      const newGroup = newTag && newTag.includes(\":\")\r\n        ? newTag.split(\":\")[0]\r\n        : null;\r\n      const isGroupNameChange = oldGroup && newGroup && oldGroup !== newGroup;\r\n\r\n      if (isGroupNameChange) {\r\n        // Group name changed - update all tags in the old group\r\n        return tags.map((tag: string) => {\r\n          if (tag === oldTag) {\r\n            // Direct match - replace with new tag\r\n            return newTag;\r\n          } else if (tag.includes(\":\") && tag.split(\":\")[0] === oldGroup) {\r\n            // Same group - update group name but keep tag name\r\n            const tagName = tag.split(\":\")[1];\r\n            return `${newGroup}:${tagName}`;\r\n          } else {\r\n            // Different group or ungrouped - keep as is\r\n            return tag;\r\n          }\r\n        }).filter((tag) => tag !== \"\"); // Remove empty tags\r\n      } else {\r\n        // Not a group name change - just replace the specific tag\r\n        return tags.map((tag) => tag === oldTag ? newTag : tag).filter((\r\n          tag: string,\r\n        ) => tag !== \"\");\r\n      }\r\n    };\r\n\r\n    // Helper function to update required tag groups\r\n    const updateRequiredTagGroups = (requiredGroups: string[]) => {\r\n      const oldGroup = oldTag.includes(\":\") ? oldTag.split(\":\")[0] : null;\r\n      const newGroup = newTag && newTag.includes(\":\")\r\n        ? newTag.split(\":\")[0]\r\n        : null;\r\n      logger.log(`Updated required tag groups ${requiredGroups}`);\r\n      if (oldGroup && newGroup && oldGroup !== newGroup) {\r\n        // Group name changed, update it in requiredTagGroups\r\n        return requiredGroups.map((group) =>\r\n          group === oldGroup ? newGroup : group\r\n        );\r\n      } else {\r\n        // No group change needed\r\n        return requiredGroups;\r\n      }\r\n    };\r\n\r\n    // Helper function to update tags in a trade, handling group name changes\r\n    const updateTradeTagsWithGroupNameChange = (trade: Trade) => {\r\n      if (!trade.tags || !Array.isArray(trade.tags)) {\r\n        return trade;\r\n      }\r\n\r\n      // Check if this is a group name change\r\n      const oldGroup = oldTag.includes(\":\") ? oldTag.split(\":\")[0] : null;\r\n      const newGroup = newTag && newTag.includes(\":\")\r\n        ? newTag.split(\":\")[0]\r\n        : null;\r\n      const isGroupNameChange = oldGroup && newGroup && oldGroup !== newGroup;\r\n\r\n      let updated = false;\r\n      const updatedTags = [...trade.tags];\r\n\r\n      if (isGroupNameChange) {\r\n        // Group name change - update all tags in the old group\r\n        for (let j = 0; j < updatedTags.length; j++) {\r\n          const tag = updatedTags[j];\r\n          if (tag === oldTag) {\r\n            // Direct match - replace with new tag\r\n            if (newTag.trim() === \"\") {\r\n              updatedTags.splice(j, 1);\r\n              j--; // Adjust index after removal\r\n            } else {\r\n              updatedTags[j] = newTag.trim();\r\n            }\r\n            updated = true;\r\n          } else if (tag.includes(\":\") && tag.split(\":\")[0] === oldGroup) {\r\n            // Same group - update group name but keep tag name\r\n            const tagName = tag.split(\":\")[1];\r\n            updatedTags[j] = `${newGroup}:${tagName}`;\r\n            updated = true;\r\n          }\r\n        }\r\n      } else {\r\n        // Not a group name change - just replace the specific tag\r\n        if (trade.tags.includes(oldTag)) {\r\n          const tagIndex = updatedTags.indexOf(oldTag);\r\n          if (newTag.trim() === \"\") {\r\n            updatedTags.splice(tagIndex, 1);\r\n          } else {\r\n            updatedTags[tagIndex] = newTag.trim();\r\n          }\r\n          updated = true;\r\n        }\r\n      }\r\n\r\n      return updated ? { ...trade, tags: updatedTags } : trade;\r\n    };\r\n\r\n    // Update cached trades locally for immediate UI feedback\r\n    // Use startTransition for this potentially heavy update\r\n    startTransition(() => {\r\n      // Update trades using Map for O(1) individual updates\r\n      const updatedTrades: Trade[] = [];\r\n      setTradesMap((prev) => {\r\n        const next = new Map<string, Trade>();\r\n        prev.forEach((trade, id) => {\r\n          const updatedTrade = updateTradeTagsWithGroupNameChange(trade);\r\n          next.set(id, updatedTrade);\r\n          updatedTrades.push(updatedTrade);\r\n        });\r\n        return next;\r\n      });\r\n\r\n      // Update cache for all affected trades\r\n      updatedTrades.forEach((trade) => updateTradeInCache(trade));\r\n\r\n      // Update local state immediately\r\n      setCalendar({\r\n        ...calendar,\r\n        tags: updateTagsWithGroupNameChange(calendar.tags || []),\r\n        required_tag_groups: updateRequiredTagGroups(\r\n          calendar.required_tag_groups || [],\r\n        ),\r\n      });\r\n    });\r\n  }\r\n  return {\r\n    trades,\r\n    calendar,\r\n    isLoading,\r\n    error,\r\n    addTrade,\r\n    deleteTrades,\r\n    loadMonthTrades,\r\n    loadVisibleRangeTrades,\r\n    handleUpdateTradeProperty,\r\n    onTagUpdated,\r\n    handleToggleDynamicRisk,\r\n    handleImportTrades,\r\n    handleAccountBalanceChange,\r\n    handleClearMonthTrades,\r\n    handleUpdateCalendarProperty,\r\n    notification,\r\n    clearNotification,\r\n    isTradeUpdating,\r\n  };\r\n}\r\n","import React, { useState, useMemo, useCallback, useEffect } from 'react';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport type { FC } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  IconButton,\r\n  Button,\r\n\r\n  Stack,\r\n  useTheme,\r\n  useMediaQuery,\r\n  alpha,\r\n  Tooltip,\r\n  SxProps,\r\n  Theme,\r\n  Toolbar,\r\n  Snackbar,\r\n  Alert,\r\n  Fab,\r\n  Fade,\r\n  LinearProgress\r\n} from '@mui/material';\r\nimport {\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  TrendingUp,\r\n  Today,\r\n\r\n  FilterAlt,\r\n  Clear,\r\n  PushPin as PinIcon,\r\n  Info as InfoIcon,\r\n  LocalOffer as TagIcon,\r\n  Search as SearchIcon,\r\n  Event as EventIcon,\r\n  SmartToy as AIIcon,\r\n  Home as HomeIcon,\r\n  CalendarToday as CalendarIcon,\r\n  Notes as NotesIcon,\r\n  Edit as EditIcon,\r\n  Flag as TargetIcon\r\n} from '@mui/icons-material';\r\nimport {\r\n  format,\r\n  addMonths,\r\n  subMonths,\r\n  startOfMonth,\r\n  endOfMonth,\r\n  eachDayOfInterval,\r\n  eachWeekOfInterval,\r\n  isSameMonth,\r\n  isSameDay,\r\n  startOfWeek,\r\n  endOfWeek,\r\n  isSameWeek,\r\n  isToday\r\n} from 'date-fns';\r\nimport { formatCurrency } from '../utils/formatters';\r\nimport { Trade } from '../types/trade';\r\nimport DayDialog from '../components/trades/DayDialog';\r\nimport SelectDateDialog from '../components/SelectDateDialog';\r\n\r\nimport TagFilterDialog from '../components/TagFilterDialog';\r\nimport TagManagementDialog from '../components/TagManagementDialog';\r\nimport TagManagementDrawer from '../components/TagManagementDrawer';\r\nimport SearchDrawer from '../components/SearchDrawer';\r\nimport TargetBadge from '../components/TargetBadge';\r\nimport { CalendarCell, WeekdayHeader } from '../components/CalendarGrid';\r\n\r\nimport {\r\n  StyledCalendarDay,\r\n  DayStatus,\r\n  AnimatedPulse,\r\n  DayNumber,\r\n  TradeAmount,\r\n  TradeCount,\r\n\r\n} from '../components/StyledComponents';\r\nimport { useNavigate, useParams } from 'react-router-dom';\r\n\r\nimport ImageZoomDialog, { ImageZoomProp } from '../components/ImageZoomDialog';\r\n\r\nimport Breadcrumbs, { BreadcrumbItem, BreadcrumbButton, DropdownItem } from '../components/common/Breadcrumbs';\r\nimport { NewTradeForm, TradeImage } from '../components/trades/TradeForm';\r\nimport { Calendar } from '../types/calendar';\r\nimport { CalendarRepository } from '../services/repository/repositories/CalendarRepository';\r\nimport MonthlyStats from '../components/MonthlyStats';\r\nimport AccountStats from '../components/AccountStats';\r\nimport TradeFormDialog, { createEditTradeData } from '../components/trades/TradeFormDialog';\r\nimport CalendarFormDialog, { CalendarFormData } from '../components/CalendarFormDialog';\r\nimport ConfirmationDialog from '../components/common/ConfirmationDialog';\r\nimport PinnedTradesDrawer from '../components/PinnedTradesDrawer';\r\nimport TradeGalleryDialog from '../components/TradeGalleryDialog';\r\nimport ShareButton from '../components/sharing/ShareButton';\r\n\r\nimport AIChatDrawer from '../components/aiChat/AIChatDrawer';\r\nimport NotesDrawer from '../components/notes/NotesDrawer';\r\nimport { StackedNotesWidget } from '../components/reminderNotes';\r\n\r\nimport { calculatePercentageOfValueAtDate, DynamicRiskSettings } from '../utils/dynamicRiskUtils';\r\nimport AnimatedBackground from '../components/common/AnimatedBackground';\r\nimport { Z_INDEX } from '../styles/zIndex';\r\n\r\nimport FloatingMonthNavigation from '../components/FloatingMonthNavigation';\r\nimport { calculateDayStats, calculateTargetProgress } from '../utils/statsUtils';\r\nimport { calculateSessionStats } from '../utils/chartDataUtils';\r\nimport EconomicCalendarDrawer, { DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS } from '../components/economicCalendar/EconomicCalendarDrawer';\r\nimport { useEconomicEventWatcher, useEconomicEventsUpdates } from '../hooks/useEconomicEventWatcher';\r\nimport { TradeOperationsProps } from '../types/tradeOperations';\r\nimport EconomicEventNotification from '../components/notifications/EconomicEventNotification';\r\nimport { EconomicEvent } from '../types/economicCalendar';\r\nimport { useHighImpactEvents } from '../hooks/useHighImpactEvents';\r\nimport { log, logger } from '../utils/logger';\r\nimport { playNotificationSound } from '../utils/notificationSound';\r\nimport { useCalendarTrades } from '../hooks/useCalendarTrades';\r\nimport { SessionPerformanceAnalysis, TradesListDialog } from '../components/charts';\r\n\r\ninterface TradeCalendarProps {\r\n  // Trade CRUD operations now handled internally via useCalendarTrades hook\r\n  // All calendar data is now passed via the calendar object\r\n  // All handlers are now internal - no external callbacks needed\r\n\r\n  calendar: Calendar;\r\n  setLoading: (loading: boolean, loadingAction?: \"loading\" | \"importing\" | \"exporting\") => void\r\n  onToggleTheme: () => void;\r\n  mode: 'light' | 'dark';\r\n  // Read-only mode for shared calendars\r\n  isReadOnly?: boolean;\r\n}\r\n\r\n\r\n\r\ninterface WeeklyPnLProps {\r\n  trade_date: Date;\r\n  weekIndex: number;\r\n  weeklyTarget?: number;\r\n  sx?: SxProps<Theme>;\r\n  // Pre-calculated stats\r\n  weekStats: {\r\n    weekTrades: Trade[];\r\n    netAmount: number;\r\n    percentage: string;\r\n    targetProgressValue: number;\r\n  };\r\n  accountBalance: number;\r\n}\r\n\r\n\r\n\r\n\r\n\r\nconst WeeklyPnL: React.FC<WeeklyPnLProps> = React.memo(({ trade_date, weekIndex, weeklyTarget, sx, weekStats, accountBalance }) => {\r\n  const theme = useTheme();\r\n\r\n  // Use pre-calculated stats\r\n  const { weekTrades, netAmount, percentage, targetProgressValue } = weekStats;\r\n\r\n  const targetProgress = targetProgressValue.toFixed(0);\r\n  const isTargetMet = weeklyTarget ? parseFloat(percentage) >= weeklyTarget : false;\r\n  const isCurrentWeek = isSameWeek(trade_date, new Date(), { weekStartsOn: 0 });\r\n\r\n  const weeklyTargetAmount = weeklyTarget ? (accountBalance * weeklyTarget) / 100 : 0;\r\n  const remainingAmount = Math.max(0, weeklyTargetAmount - netAmount);\r\n  const cappedProgress = Math.min(Math.max(targetProgressValue, 0), 100);\r\n\r\n  const tooltipContent = isCurrentWeek && weeklyTarget ? (\r\n    <Box sx={{ p: 1, minWidth: 220 }}>\r\n      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 1 }}>\r\n        <Typography variant=\"subtitle2\" sx={{ fontWeight: 600, color: 'info.light' }}>\r\n          Weekly Target\r\n        </Typography>\r\n        <Typography variant=\"caption\" sx={{ fontWeight: 700, color: 'white' }}>\r\n          {weeklyTarget}% (${weeklyTargetAmount.toLocaleString(undefined, { maximumFractionDigits: 0 })})\r\n        </Typography>\r\n      </Box>\r\n\r\n      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 1 }}>\r\n        <Box sx={{ flex: 1 }}>\r\n          <LinearProgress\r\n            variant=\"determinate\"\r\n            value={cappedProgress}\r\n            sx={{\r\n              height: 6,\r\n              borderRadius: 3,\r\n              bgcolor: alpha(theme.palette.common.white, 0.1),\r\n              '& .MuiLinearProgress-bar': {\r\n                borderRadius: 3,\r\n                bgcolor: isTargetMet ? 'success.light' : 'info.main'\r\n              }\r\n            }}\r\n          />\r\n        </Box>\r\n        <Typography variant=\"caption\" sx={{ fontWeight: 700, color: isTargetMet ? 'success.light' : 'info.light' }}>\r\n          {targetProgress}%\r\n        </Typography>\r\n      </Box>\r\n\r\n      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n        <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\r\n          Remaining:\r\n        </Typography>\r\n        <Typography variant=\"caption\" sx={{ fontWeight: 600, color: 'white' }}>\r\n          ${remainingAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\r\n        </Typography>\r\n      </Box>\r\n    </Box>\r\n  ) : '';\r\n\r\n  const content = (\r\n    <CalendarCell sx={{\r\n      bgcolor: 'background.paper',\r\n      borderRadius: 1,\r\n      border: `2px solid ${netAmount > 0\r\n        ? alpha(theme.palette.success.main, 0.3)\r\n        : netAmount < 0\r\n          ? alpha(theme.palette.error.main, 0.3)\r\n          : alpha(theme.palette.divider, 0.2)\r\n        }`,\r\n      justifyContent: 'center',\r\n      alignItems: 'center',\r\n      position: 'relative',\r\n      ...sx\r\n    }}>\r\n      <Stack spacing={0.5} sx={{ alignItems: 'center', p: 1 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n\r\n          <Typography\r\n            variant=\"caption\"\r\n            sx={{\r\n              fontSize: '0.8rem',\r\n              fontWeight: 600,\r\n              color: 'text.primary'\r\n            }}\r\n          >\r\n            Week {weekIndex + 1}\r\n          </Typography>\r\n        </Box>\r\n\r\n        <Typography\r\n          variant=\"h6\"\r\n          sx={{\r\n            fontWeight: 700,\r\n            color: netAmount > 0 ? 'success.main' : netAmount < 0 ? 'error.main' : 'text.primary',\r\n            fontSize: { xs: '0.9rem', md: '1rem' },\r\n            textAlign: 'center'\r\n          }}\r\n        >\r\n          {formatCurrency(netAmount)}\r\n        </Typography>\r\n\r\n        <Stack direction=\"row\" spacing={0.5} alignItems=\"center\" justifyContent=\"center\">\r\n          <Typography\r\n            variant=\"body2\"\r\n            sx={{\r\n              color: netAmount > 0 ? 'success.main' : netAmount < 0 ? 'error.main' : 'text.secondary',\r\n              fontSize: '0.8rem',\r\n              fontWeight: 600,\r\n              textAlign: 'center'\r\n            }}\r\n          >\r\n            {percentage}%\r\n          </Typography>\r\n\r\n          {weeklyTarget && (\r\n            <TargetBadge\r\n              progress={parseFloat(targetProgress)}\r\n              isMet={isTargetMet}\r\n              tooltipText={isCurrentWeek ? '' : `${isTargetMet ? 'Weekly target achieved' : 'Progress towards weekly target'}: ${targetProgress}%`}\r\n            />\r\n          )}\r\n        </Stack>\r\n\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            fontSize: '0.75rem',\r\n            textAlign: 'center',\r\n            color: 'text.secondary',\r\n            fontWeight: 500\r\n          }}\r\n        >\r\n          {weekTrades.length} trade{weekTrades.length !== 1 ? 's' : ''}\r\n        </Typography>\r\n      </Stack>\r\n    </CalendarCell>\r\n  );\r\n\r\n  if (isCurrentWeek && weeklyTarget) {\r\n    return (\r\n      <Tooltip title={tooltipContent} arrow placement=\"left\">\r\n        {content}\r\n      </Tooltip>\r\n    );\r\n  }\r\n\r\n  return content;\r\n});\r\n\r\n\r\n\r\nexport const createNewTradeData = (): NewTradeForm => ({\r\n  id: uuidv4()!!,\r\n  name: '',\r\n  amount: 0,\r\n  trade_type: 'win',\r\n  entry_price: 0,\r\n  trade_date: null,\r\n  exit_price: 0,\r\n  stop_loss: 0,\r\n  take_profit: 0,\r\n  tags: [],\r\n  risk_to_reward: 0,\r\n  partials_taken: false,\r\n  session: '',\r\n  notes: '',\r\n  pending_images: [],\r\n  uploaded_images: [],\r\n  economic_events: [],\r\n});\r\n\r\n\r\n\r\n\r\n// TagFilter component for filtering trades by tags\r\ninterface TagFilterProps {\r\n  allTags: string[];\r\n  selectedTags: string[];\r\n  onTagsChange: (tags: string[]) => void;\r\n  onOpenDrawer: () => void;\r\n}\r\n\r\nconst TagFilter = React.memo<TagFilterProps>(({ allTags, selectedTags, onTagsChange, onOpenDrawer }) => {\r\n  const theme = useTheme();\r\n\r\n  const handleClearTags = () => {\r\n    onTagsChange([]);\r\n  };\r\n\r\n  return (\r\n    <Box sx={{ display: 'flex', alignItems: 'center', gap: { xs: 0.5, sm: 1 }, flex: { xs: 1, sm: 'none' } }}>\r\n      <Tooltip title=\"Filter by tags\" arrow>\r\n        <Button\r\n          variant={selectedTags.length > 0 ? \"contained\" : \"outlined\"}\r\n          size=\"small\"\r\n          startIcon={<FilterAlt sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />}\r\n          onClick={onOpenDrawer}\r\n          sx={{\r\n            flex: 1,\r\n            minWidth: { xs: 'auto', sm: '120px' },\r\n            borderRadius: 2,\r\n            fontWeight: 600,\r\n            textTransform: 'none',\r\n            fontSize: { xs: '0.8125rem', sm: '0.875rem' },\r\n            py: { xs: 0.75, sm: 1 },\r\n            px: { xs: 1.5, sm: 2 },\r\n            ...(selectedTags.length > 0 ? {\r\n              bgcolor: alpha(theme.palette.info.main, 0.9),\r\n              color: 'white',\r\n              boxShadow: `0 4px 12px ${alpha(theme.palette.info.main, 0.3)}`,\r\n              '&:hover': {\r\n                bgcolor: theme.palette.info.main,\r\n                boxShadow: `0 6px 16px ${alpha(theme.palette.info.main, 0.4)}`\r\n              }\r\n            } : {\r\n              borderColor: alpha(theme.palette.text.secondary, 0.3),\r\n              color: 'text.secondary',\r\n              '&:hover': {\r\n                borderColor: 'info.main',\r\n                bgcolor: alpha(theme.palette.info.main, 0.1),\r\n                color: 'info.main'\r\n              }\r\n            }),\r\n            transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n          }}\r\n        >\r\n          {selectedTags.length > 0 ? `${selectedTags.length} tag${selectedTags.length > 1 ? 's' : ''}` : 'Search & Filter'}\r\n        </Button>\r\n      </Tooltip>\r\n\r\n      {selectedTags.length > 0 && (\r\n        <Tooltip title=\"Clear all filters\" arrow>\r\n          <IconButton\r\n            size=\"small\"\r\n            onClick={handleClearTags}\r\n            sx={{\r\n              bgcolor: alpha(theme.palette.error.main, 0.1),\r\n              color: 'error.main',\r\n              borderRadius: 2,\r\n              p: { xs: 0.5, sm: 0.75 },\r\n              '&:hover': {\r\n                bgcolor: alpha(theme.palette.error.main, 0.2)\r\n              },\r\n              transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n            }}\r\n          >\r\n            <Clear sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />\r\n          </IconButton>\r\n        </Tooltip>\r\n      )}\r\n    </Box>\r\n  );\r\n});\r\n\r\ninterface CalendarDayCellProps {\r\n  day: Date;\r\n  dayTrades: Trade[];\r\n  currentDate: Date;\r\n  monthlyHighImpactEvents: Map<string, boolean>;\r\n  onDayClick: (day: Date) => void;\r\n  isMdDown: boolean;\r\n  // Pre-calculated stats\r\n  dayStats: ReturnType<typeof calculateDayStats>;\r\n}\r\n\r\nconst CalendarDayCell = React.memo(({\r\n  day,\r\n  dayTrades,\r\n  currentDate,\r\n  monthlyHighImpactEvents,\r\n  onDayClick,\r\n  isMdDown,\r\n  dayStats\r\n}: CalendarDayCellProps) => {\r\n  const theme = useTheme();\r\n\r\n  const isCurrentMonth = isSameMonth(day, currentDate);\r\n  const isCurrentDay = isToday(day);\r\n  const dayDateString = format(day, 'yyyy-MM-dd');\r\n  const hasHighImpactEvents = monthlyHighImpactEvents.get(dayDateString) || false;\r\n\r\n  return (\r\n    <CalendarCell>\r\n      <StyledCalendarDay\r\n        onClick={() => onDayClick(day)}\r\n        $isCurrentMonth={isCurrentMonth}\r\n        $isCurrentDay={isCurrentDay}\r\n        $dayStatus={dayStats.status}\r\n      >\r\n        <DayNumber $isCurrentMonth={isCurrentMonth}>\r\n          {format(day, 'd')}\r\n        </DayNumber>\r\n\r\n        {hasHighImpactEvents && (\r\n          <Box\r\n            sx={{\r\n              position: 'absolute',\r\n              top: 4,\r\n              right: 4,\r\n              width: 8,\r\n              height: 8,\r\n              m: 1,\r\n              borderRadius: '50%',\r\n              bgcolor: 'error.main',\r\n              border: `2px solid ${alpha(theme.palette.background.paper, 0.8)}`,\r\n              boxShadow: `0 0 0 1px ${alpha(theme.palette.error.main, 0.3)}`\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {dayTrades.length > 0 && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            alignItems: 'center',\r\n            gap: 0.5\r\n          }}>\r\n            {!isMdDown && (\r\n              <TradeAmount $dayStatus={dayStats.status}>\r\n                {formatCurrency(Math.abs(dayStats.netAmount))}\r\n              </TradeAmount>\r\n            )}\r\n            <TradeCount>\r\n              {dayTrades.length} trade{dayTrades.length !== 1 ? 's' : ''}\r\n            </TradeCount>\r\n            <Typography\r\n              variant=\"caption\"\r\n              sx={{\r\n                color: dayStats.status === 'win' ? 'success.main' :\r\n                  dayStats.status === 'loss' ? 'error.main' : 'text.secondary',\r\n                fontSize: '0.75rem',\r\n                fontWeight: 500\r\n              }}\r\n            >\r\n              {dayStats.percentage}%\r\n            </Typography>\r\n            {dayStats.isDrawdownViolation && (\r\n              <Typography\r\n                variant=\"caption\"\r\n                sx={{\r\n                  color: 'error.main',\r\n                  fontSize: '0.75rem',\r\n                  fontWeight: 700,\r\n                  textTransform: 'uppercase'\r\n                }}\r\n              >\r\n                VIOLATED\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n        )}\r\n      </StyledCalendarDay>\r\n    </CalendarCell>\r\n  );\r\n});\r\n\r\nexport const TradeCalendar: FC<TradeCalendarProps> = (props): React.ReactElement => {\r\n  const {\r\n    calendar: selectedCalendar,\r\n    setLoading,\r\n    onToggleTheme,\r\n    mode,\r\n    isReadOnly = false\r\n  } = props;\r\n\r\n\r\n\r\n  const { calendarId: calendarIdFromParams } = useParams();\r\n  // Use calendarId from URL params, or fall back to calendar prop ID (for shared calendars)\r\n  const calendarId = calendarIdFromParams || selectedCalendar?.id;\r\n\r\n  // Fetch trades using custom hook - this now handles all trade CRUD operations\r\n  const {\r\n    trades,\r\n    calendar: hookCalendar,\r\n    isLoading: isLoadingTrades,\r\n    addTrade: handleAddTrade,\r\n    deleteTrades: handleDeleteTrades,\r\n    handleUpdateTradeProperty,\r\n    onTagUpdated: handleTagUpdated,\r\n    handleToggleDynamicRisk,\r\n    handleImportTrades: hookHandleImportTrades,\r\n    handleAccountBalanceChange,\r\n    handleClearMonthTrades,\r\n    handleUpdateCalendarProperty,\r\n    notification,\r\n    clearNotification,\r\n    isTradeUpdating,\r\n    loadMonthTrades,\r\n    loadVisibleRangeTrades,\r\n  } = useCalendarTrades({\r\n    calendarId,\r\n    selectedCalendar,\r\n    setLoading,\r\n    enableRealtime: !isReadOnly // Disable real-time for read-only mode\r\n  });\r\n\r\n  // Show notifications from useCalendarTrades hook\r\n  useEffect(() => {\r\n    if (notification) {\r\n      showSnackbar(notification.message, notification.type === 'success' ? 'success' : 'error');\r\n      clearNotification();\r\n    }\r\n  }, [notification, clearNotification]);\r\n\r\n  // Use hook calendar if available, otherwise fall back to selectedCalendar\r\n  const calendar = hookCalendar || selectedCalendar;\r\n\r\n  // Extract calendar fields for easier access\r\n\r\n  const accountBalance = calendar.account_balance;\r\n  const maxDailyDrawdown = calendar.max_daily_drawdown;\r\n  const weeklyTarget = calendar.weekly_target;\r\n  const monthly_target = calendar.monthly_target;\r\n  const yearlyTarget = calendar.yearly_target;\r\n  const requiredTagGroups = calendar.required_tag_groups;\r\n  const calendarName = calendar.name;\r\n  const heroImageUrl = calendar.hero_image_url;\r\n  const heroImageAttribution = calendar.hero_image_attribution;\r\n  const scoreSettings = calendar.score_settings;\r\n  const totalPnL = calendar.total_pnl;\r\n\r\n  const dynamicRiskSettings: DynamicRiskSettings = useMemo(() => ({\r\n    account_balance: calendar.account_balance,\r\n    risk_per_trade: calendar.risk_per_trade,\r\n    dynamic_risk_enabled: calendar.dynamic_risk_enabled,\r\n    increased_risk_percentage: calendar.increased_risk_percentage,\r\n    profit_threshold_percentage: calendar.profit_threshold_percentage\r\n  }), [\r\n    calendar.account_balance,\r\n    calendar.risk_per_trade,\r\n    calendar.dynamic_risk_enabled,\r\n    calendar.increased_risk_percentage,\r\n    calendar.profit_threshold_percentage\r\n  ]);\r\n\r\n\r\n\r\n\r\n  // Wrapper for import trades handler to pass setLoading\r\n  const handleImportTrades = useCallback(async (importedTrades: Partial<Trade>[]) => {\r\n    try {\r\n      await hookHandleImportTrades(importedTrades);\r\n    } catch (error) {\r\n      console.error('Error importing trades:', error);\r\n      throw error;\r\n    }\r\n  }, [hookHandleImportTrades]);\r\n\r\n  // Wrapper for update calendar property to match the expected signature\r\n  // The hook version doesn't need calendarId since it uses the calendar from hook state\r\n  const onUpdateCalendarProperty = useCallback(async (\r\n    _calendarId: string,\r\n    updateCallback: (calendar: Calendar) => Calendar\r\n  ): Promise<Calendar | undefined> => {\r\n    return await handleUpdateCalendarProperty(updateCallback);\r\n  }, [handleUpdateCalendarProperty]);\r\n\r\n  const [currentDate, setCurrentDate] = useState(new Date());\r\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\r\n  const [isMonthSelectorOpen, setIsMonthSelectorOpen] = useState(false);\r\n  const [selectedTags, setSelectedTags] = useState<string[]>([]);\r\n  const [newTrade, setNewTrade] = useState<NewTradeForm | null>(null);\r\n  const [showAddForm, setShowAddForm] = useState<{ open: boolean, trade_date: Date, editTrade?: Trade | null, createTempTrade?: boolean, showDayDialogWhenDone: boolean } | null>(null);\r\n  const [zoomedImages, setZoomedImagesState] = useState<ImageZoomProp | null>(null);\r\n  const [tradesToDelete, setTradesToDelete] = useState<string[]>([]);\r\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\r\n  const [deletingTradeIds, setDeletingTradeIds] = useState<string[]>([]);\r\n  const [deleteError, setDeleteError] = useState<string | null>(null);\r\n\r\n  // Session statistics dialog state - stores trade IDs, trades computed via useMemo\r\n  const [sessionTradesDialog, setSessionTradesDialog] = useState<{\r\n    open: boolean;\r\n    tradeIds: string[];\r\n    title: string;\r\n    expandedTradeId: string | null;\r\n  }>({\r\n    open: false,\r\n    tradeIds: [],\r\n    title: '',\r\n    expandedTradeId: null\r\n  });\r\n\r\n  // Custom function to handle setting zoomed image and related state\r\n  const setZoomedImage = useCallback((url: string, allImages?: string[], initialIndex?: number) => {\r\n    setZoomedImagesState({ selectetdImageIndex: initialIndex || 0, allImages: allImages || [url] });\r\n\r\n  }, []);\r\n\r\n  const [isTagManagementDialogOpen, setIsTagManagementDialogOpen] = useState(false);\r\n  const [isTagManagementDrawerOpen, setIsTagManagementDrawerOpen] = useState(false);\r\n  const [isSearchDrawerOpen, setIsSearchDrawerOpen] = useState(false);\r\n  const [isDynamicRiskToggled, setIsDynamicRiskToggled] = useState(true); // Default to true (using actual amounts)\r\n  const [snackbarOpen, setSnackbarOpen] = useState(false);\r\n  const [snackbarMessage, setSnackbarMessage] = useState('');\r\n  const [snackbarSeverity, setSnackbarSeverity] = useState<'success' | 'warning' | 'error'>('warning');\r\n  const [showFloatingMonthNav, setShowFloatingMonthNav] = useState(false);\r\n  const [pinnedTradesDrawerOpen, setPinnedTradesDrawerOpen] = useState(false);\r\n  const [galleryMode, setGalleryMode] = useState<{\r\n    open: boolean;\r\n    trades: Trade[];\r\n    initialTradeId?: string;\r\n    title?: string;\r\n    aiOnlyMode?: boolean;\r\n    fetchYear?: number;\r\n  }>({\r\n    open: false,\r\n    trades: [],\r\n    initialTradeId: undefined,\r\n    title: undefined,\r\n    aiOnlyMode: false,\r\n    fetchYear: undefined\r\n  });\r\n\r\n  // Calendar edit dialog state\r\n  const [isCalendarEditOpen, setIsCalendarEditOpen] = useState(false);\r\n  const [isCalendarEditSubmitting, setIsCalendarEditSubmitting] = useState(false);\r\n\r\n  // Economic calendar drawer state\r\n  const [isEconomicCalendarOpen, setIsEconomicCalendarOpen] = useState(false);\r\n\r\n  // AI Chat drawer state\r\n  const [isAIChatOpen, setIsAIChatOpen] = useState(false);\r\n\r\n  // Notes drawer state\r\n  const [isNotesDrawerOpen, setIsNotesDrawerOpen] = useState(false);\r\n\r\n  // Economic event notification state\r\n  // Notification stack state (moved from App.tsx)\r\n  const [notifications, setNotifications] = useState<EconomicEvent[]>([]);\r\n  const [removingNotifications, setRemovingNotifications] = useState<Set<string>>(new Set());\r\n  const [economicCalendarUpdatedEvent, setEconomicCalendarUpdatedEvent] = useState<{ updatedEvents: EconomicEvent[], allEvents: EconomicEvent[] } | null>(null);\r\n\r\n  // User calendars for breadcrumb dropdown\r\n  const [userCalendars, setUserCalendars] = useState<Calendar[]>([]);\r\n\r\n  // Fetch user's calendars for breadcrumb dropdown\r\n  useEffect(() => {\r\n    const loadUserCalendars = async () => {\r\n      if (!calendar?.user_id) return;\r\n\r\n      try {\r\n        const calendarRepo = new CalendarRepository();\r\n        const calendars = await calendarRepo.findByUserId(calendar.user_id);\r\n        setUserCalendars(calendars);\r\n      } catch (error) {\r\n        logger.error('Error loading user calendars for dropdown:', error);\r\n      }\r\n    };\r\n\r\n    loadUserCalendars();\r\n  }, [calendar?.user_id]);\r\n\r\n  const breadcrumbButtons = useMemo<BreadcrumbButton[]>(() => [\r\n    ...((!isReadOnly) ? [{\r\n      key: 'edit',\r\n      icon: <EditIcon fontSize=\"small\" />,\r\n      onClick: () => setIsCalendarEditOpen(true),\r\n      tooltip: 'Edit calendar settings'\r\n    }] : [])\r\n  ], [isReadOnly]);\r\n\r\n  const breadcrumbRightContent = (!isReadOnly && calendar && onUpdateCalendarProperty) ? (\r\n    <ShareButton type=\"calendar\" item={calendar} onUpdateItemProperty={onUpdateCalendarProperty} size=\"small\" />\r\n  ) : null;\r\n\r\n\r\n  const theme = useTheme();\r\n  const isMdDown = useMediaQuery(theme.breakpoints.down('md'));\r\n\r\n  // Breadcrumb items\r\n  const breadcrumbItems = useMemo<BreadcrumbItem[]>(() => {\r\n    // Create dropdown items from user calendars\r\n    const dropdownItems: DropdownItem[] = userCalendars.map(cal => ({\r\n      label: cal.name,\r\n      path: `/calendar/${cal.id}`,\r\n      active: cal.id === calendarId,\r\n      totalTrades: cal.total_trades,\r\n      pnl: cal.total_pnl\r\n    }));\r\n\r\n    return [\r\n      { label: 'Home', path: '/', icon: <HomeIcon sx={{ fontSize: 18 }} /> },\r\n      { label: 'Calendars', path: '/dashboard', icon: <CalendarIcon sx={{ fontSize: 18 }} /> },\r\n      {\r\n        label: calendarName || 'Calendar',\r\n        path: `/calendar/${calendarId}`,\r\n        dropdown: dropdownItems.length > 0 ? dropdownItems : undefined\r\n      }\r\n    ];\r\n  }, [calendarName, calendarId, userCalendars]);\r\n\r\n  // Use optimized hook for high-impact economic events\r\n  const { highImpactEventDates: monthlyHighImpactEvents } = useHighImpactEvents({\r\n    currentDate,\r\n    calendarId,\r\n    currencies: calendar?.economic_calendar_filters?.currencies,\r\n    enabled: !!calendar?.economic_calendar_filters\r\n  });\r\n\r\n  // Economic event watcher for real-time updates\r\n  const { watchingStatus } = useEconomicEventWatcher({\r\n    calendarId,\r\n    economic_calendar_filters: calendar?.economic_calendar_filters,\r\n    isActive: true // Always active when TradeCalendar is mounted\r\n  });\r\n\r\n  // Load trades for visible calendar range when month changes\r\n  // This ensures overflow days from adjacent months show their trades\r\n  useEffect(() => {\r\n    if (!calendarId) return;\r\n\r\n    // Calculate the visible date range in the calendar grid\r\n    // Includes overflow days from previous/next months\r\n    const monthStart = startOfMonth(currentDate);\r\n    const monthEnd = endOfMonth(currentDate);\r\n    const visibleStart = startOfWeek(monthStart, { weekStartsOn: 0 }); // Sunday\r\n    const visibleEnd = endOfWeek(monthEnd, { weekStartsOn: 0 }); // Saturday\r\n\r\n    loadVisibleRangeTrades(visibleStart, visibleEnd);\r\n  }, [currentDate, calendarId, loadVisibleRangeTrades]);\r\n\r\n  // Listen for multiple economic event updates (same release time)\r\n  useEconomicEventsUpdates((updatedEvents, allEvents, updatedCalendarId) => {\r\n    if (updatedCalendarId === calendarId) {\r\n      log(` ${updatedEvents.length} economic events were updated simultaneously for this calendar`);\r\n\r\n      // Check if notifications are enabled before showing them\r\n      const notificationsEnabled = calendar?.economic_calendar_filters?.notificationsEnabled ?? true;\r\n\r\n      // 1. Show notification sliders for each event (leveraging stacking behavior) - only if enabled\r\n      if (notificationsEnabled) {\r\n        log(` Notifications enabled - showing ${updatedEvents.length} event notification(s)`);\r\n        updatedEvents.forEach(event => {\r\n          addNotification(event);\r\n        });\r\n      } else {\r\n        log(` Notifications disabled - skipping ${updatedEvents.length} event notification(s)`);\r\n      }\r\n\r\n      // 2. Pass events to Economic Calendar Drawer if it's open (always update drawer regardless of notification setting)\r\n      if (isEconomicCalendarOpen) {\r\n        // For multiple events, we'll pass the first event but include all events in the events array\r\n        setEconomicCalendarUpdatedEvent({\r\n          updatedEvents, // Primary events for display\r\n          allEvents // All updated events\r\n        });\r\n        // Clear the updated event after a short delay to prevent re-triggering\r\n        setTimeout(() => {\r\n          setEconomicCalendarUpdatedEvent(null);\r\n        }, 1000);\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  // Add a notification (call this when you want to show a new notification)\r\n  const addNotification = (event: EconomicEvent) => {\r\n    // Play notification sound\r\n    playNotificationSound().catch(error => {\r\n      logger.warn('Failed to play notification sound:', error);\r\n    });\r\n\r\n    setNotifications((prev) => {\r\n      // If we already have 3 notifications, mark the oldest one for removal\r\n      if (prev.length >= 3) {\r\n        const oldestNotification = prev[0];\r\n        setRemovingNotifications(prevRemoving => {\r\n          const newSet = new Set(prevRemoving);\r\n          newSet.add(oldestNotification.id);\r\n          return newSet;\r\n        });\r\n        // Remove the oldest notification after animation delay\r\n        setTimeout(() => {\r\n          setNotifications(current => current.filter(n => n.id !== oldestNotification.id));\r\n          setRemovingNotifications(current => {\r\n            const newSet = new Set(current);\r\n            newSet.delete(oldestNotification.id);\r\n            return newSet;\r\n          });\r\n        }, 300);\r\n      }\r\n      return [...prev, event];\r\n    });\r\n  };\r\n\r\n  // Close notification handler\r\n  const handleCloseNotification = (id: string) => {\r\n    setRemovingNotifications(prev => {\r\n      const newSet = new Set(prev);\r\n      newSet.add(id);\r\n      return newSet;\r\n    });\r\n    setTimeout(() => {\r\n      setNotifications((prev) => prev.filter(n => n.id !== id));\r\n      setRemovingNotifications(current => {\r\n        const newSet = new Set(current);\r\n        newSet.delete(id);\r\n        return newSet;\r\n      });\r\n    }, 300);\r\n  };\r\n\r\n\r\n\r\n  // Calendar edit handler\r\n  const handleCalendarEditSubmit = async (formData: CalendarFormData) => {\r\n    if (!onUpdateCalendarProperty || !calendarId) return;\r\n\r\n    setIsCalendarEditSubmitting(true);\r\n    try {\r\n      await onUpdateCalendarProperty(calendarId, (cal) => ({\r\n        ...cal,\r\n        name: formData.name,\r\n        account_balance: formData.account_balance,\r\n        max_daily_drawdown: formData.max_daily_drawdown,\r\n        weekly_target: formData.weekly_target,\r\n        monthly_target: formData.monthly_target,\r\n        yearly_target: formData.yearly_target,\r\n        risk_per_trade: formData.risk_per_trade,\r\n        dynamic_risk_enabled: formData.dynamic_risk_enabled,\r\n        increased_risk_percentage: formData.increased_risk_percentage,\r\n        profit_threshold_percentage: formData.profit_threshold_percentage,\r\n        hero_image_url: formData.hero_image_url,\r\n        hero_image_attribution: formData.hero_image_attribution,\r\n      }));\r\n      // Update userCalendars state to reflect name change in breadcrumb dropdown\r\n      setUserCalendars(prev => prev.map(cal =>\r\n        cal.id === calendarId ? { ...cal, name: formData.name } : cal\r\n      ));\r\n      setIsCalendarEditOpen(false);\r\n      showSnackbar('Calendar updated successfully', 'success');\r\n    } catch (error) {\r\n      logger.error('Error updating calendar:', error);\r\n      showSnackbar('Failed to update calendar', 'error');\r\n    } finally {\r\n      setIsCalendarEditSubmitting(false);\r\n    }\r\n  };\r\n\r\n  // Economic calendar toggle handler\r\n  const handleToggleEconomicCalendar = useCallback(() => {\r\n    setIsEconomicCalendarOpen(true);\r\n  }, []);\r\n\r\n  // AI Chat toggle handler\r\n  const handleToggleAIChat = useCallback(() => {\r\n    setIsAIChatOpen(true);\r\n  }, []);\r\n\r\n  // Scroll detection for floating month navigation with throttling\r\n  useEffect(() => {\r\n    let ticking = false;\r\n\r\n    const handleScroll = () => {\r\n      if (!ticking) {\r\n        requestAnimationFrame(() => {\r\n          // Find the score section element\r\n          const section = document.querySelector('[data-testid=\"month-nav-section\"]');\r\n          if (section) {\r\n            const rect = section.getBoundingClientRect();\r\n            // Show floating nav when section is NOT visible\r\n            setShowFloatingMonthNav(!(rect.top <= window.innerHeight && rect.bottom >= 0));\r\n          }\r\n          ticking = false;\r\n        });\r\n        ticking = true;\r\n      }\r\n    };\r\n\r\n    window.addEventListener('scroll', handleScroll, { passive: true });\r\n    handleScroll(); // Check initial state\r\n\r\n    return () => window.removeEventListener('scroll', handleScroll);\r\n  }, []);\r\n\r\n\r\n\r\n  // Use calendar.tags,\r\n  const allTags = useMemo(() => {\r\n    return calendar.tags || [];\r\n  }, [calendar.tags, trades]);\r\n\r\n  // Filter trades based on selected tags\r\n  const filteredTrades = useMemo(() => {\r\n    if (selectedTags.length === 0) {\r\n      return trades; // No filtering if no tags selected\r\n    }\r\n\r\n    return trades.filter(trade =>\r\n      trade.tags?.some(tag => selectedTags.includes(tag))\r\n    );\r\n  }, [trades, selectedTags]);\r\n\r\n\r\n  // Optimize trade lookup by pre-grouping trades by date\r\n  // This changes the complexity from O(Days * Trades) to O(Trades) + O(Days)\r\n  const tradesByDay = useMemo(() => {\r\n    const map = new Map<string, Trade[]>();\r\n    filteredTrades.forEach(trade => {\r\n      const dateKey = format(new Date(trade.trade_date), 'yyyy-MM-dd');\r\n      if (!map.has(dateKey)) {\r\n        map.set(dateKey, []);\r\n      }\r\n      map.get(dateKey)?.push(trade);\r\n    });\r\n    return map;\r\n  }, [filteredTrades]);\r\n\r\n  const tradesForSelectedDay = useMemo(() => {\r\n    if (!selectedDate) {\r\n      return [];\r\n    }\r\n    const dateKey = format(selectedDate, 'yyyy-MM-dd');\r\n    return tradesByDay.get(dateKey) || [];\r\n  }, [selectedDate, tradesByDay]);\r\n\r\n  // Compute session dialog trades from IDs - ensures trades update when underlying data changes\r\n  const sessionDialogTrades = useMemo(() => {\r\n    if (!sessionTradesDialog.tradeIds.length) return [];\r\n    return sessionTradesDialog.tradeIds\r\n      .map(id => filteredTrades.find(t => t.id === id))\r\n      .filter((t): t is Trade => t !== undefined);\r\n  }, [sessionTradesDialog.tradeIds, filteredTrades]);\r\n\r\n  // Calculate total profit based on filtered trades or use pre-calculated value\r\n  const totalProfit = useMemo(() => {\r\n    // If no tag filtering is applied and pre-calculated totalPnL is available, use it\r\n    if (selectedTags.length === 0 && totalPnL !== undefined) {\r\n      return totalPnL;\r\n    }\r\n    // Otherwise calculate from filtered trades\r\n    return filteredTrades.length > 0 ? filteredTrades.reduce((sum, trade) => sum + trade.amount, 0) : 0;\r\n  }, [filteredTrades, selectedTags, totalPnL]);\r\n\r\n\r\n  // Pre-calculate day statistics for all visible days in the calendar grid\r\n  // Includes overflow days from adjacent months to show complete statistics\r\n  const dayStatsMap = useMemo(() => {\r\n    const map = new Map<string, ReturnType<typeof calculateDayStats>>();\r\n\r\n    const monthStart = startOfMonth(currentDate);\r\n    const monthEnd = endOfMonth(currentDate);\r\n    const visibleStart = startOfWeek(monthStart, { weekStartsOn: 0 }); // Sunday\r\n    const visibleEnd = endOfWeek(monthEnd, { weekStartsOn: 0 }); // Saturday\r\n    const days = eachDayOfInterval({ start: visibleStart, end: visibleEnd });\r\n\r\n    days.forEach(day => {\r\n      const dayKey = format(day, 'yyyy-MM-dd');\r\n      const dayTrades = tradesByDay.get(dayKey) || [];\r\n\r\n      const dayStats = calculateDayStats(\r\n        dayTrades,\r\n        accountBalance,\r\n        maxDailyDrawdown || 0,\r\n        dynamicRiskSettings,\r\n        filteredTrades,\r\n        day\r\n      );\r\n\r\n      map.set(dayKey, dayStats);\r\n    });\r\n\r\n    return map;\r\n  }, [currentDate, tradesByDay, accountBalance, maxDailyDrawdown, dynamicRiskSettings, filteredTrades]);\r\n\r\n  // Pre-calculate weekly statistics for all visible weeks in the calendar grid\r\n  // Includes weeks with overflow days from adjacent months\r\n  const weeklyStatsMap = useMemo(() => {\r\n    const map = new Map<string, {\r\n      weekTrades: Trade[];\r\n      netAmount: number;\r\n      percentage: string;\r\n      targetProgressValue: number;\r\n    }>();\r\n\r\n    const monthStart = startOfMonth(currentDate);\r\n    const monthEnd = endOfMonth(currentDate);\r\n    const visibleStart = startOfWeek(monthStart, { weekStartsOn: 0 }); // Sunday\r\n    const visibleEnd = endOfWeek(monthEnd, { weekStartsOn: 0 }); // Saturday\r\n    const weeks = eachWeekOfInterval({ start: visibleStart, end: visibleEnd }, { weekStartsOn: 0 });\r\n\r\n    weeks.forEach(weekStart => {\r\n      const weekKey = format(weekStart, 'yyyy-MM-dd');\r\n\r\n      // Filter trades for this week (include all trades, not just current month)\r\n      const weekTrades = filteredTrades.filter(trade =>\r\n        isSameWeek(new Date(trade.trade_date), weekStart, { weekStartsOn: 0 })\r\n      );\r\n\r\n      // Calculate net amount for the week\r\n      const netAmount = weekTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n      // Calculate percentage - use the centralized function\r\n      const percentage = filteredTrades\r\n        ? calculatePercentageOfValueAtDate(netAmount, accountBalance, filteredTrades, weekStart).toFixed(1)\r\n        : accountBalance > 0 ? ((netAmount / accountBalance) * 100).toFixed(1) : '0';\r\n\r\n      // Calculate target progress\r\n      const targetProgressValue = weeklyTarget && weeklyTarget > 0\r\n        ? calculateTargetProgress(weekTrades, accountBalance, weeklyTarget, weekStart, filteredTrades)\r\n        : 0;\r\n\r\n      map.set(weekKey, {\r\n        weekTrades,\r\n        netAmount,\r\n        percentage,\r\n        targetProgressValue\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }, [currentDate, filteredTrades, accountBalance, weeklyTarget]);\r\n\r\n  // Calculate session statistics for the monthly statistics section\r\n  const sessionStats = useMemo(() => {\r\n    return calculateSessionStats(filteredTrades, currentDate, 'month', accountBalance);\r\n  }, [filteredTrades, currentDate, accountBalance]);\r\n\r\n  const handlePrevMonth = () => {\r\n    setCurrentDate(prev => subMonths(prev, 1));\r\n  };\r\n\r\n  const handleNextMonth = () => {\r\n    setCurrentDate(prev => addMonths(prev, 1));\r\n  };\r\n\r\n  const handleTodayClick = () => {\r\n    setCurrentDate(new Date());\r\n  };\r\n\r\n\r\n  // Handle single trade deletion\r\n  const handleDeleteClick = (tradeId: string) => {\r\n    setTradesToDelete([tradeId]);\r\n    setIsDeleteDialogOpen(true);\r\n    setDeleteError(null);\r\n  };\r\n\r\n  // Handle multiple trade deletion\r\n  const handleDeleteMultipleTrades = (tradeIds: string[]) => {\r\n    setTradesToDelete(tradeIds);\r\n    setIsDeleteDialogOpen(true);\r\n    setDeleteError(null);\r\n  };\r\n\r\n  const handleConfirmDelete = async () => {\r\n    if (tradesToDelete.length === 0) return;\r\n\r\n    setIsDeleteDialogOpen(false);\r\n    setDeleteError(null);\r\n\r\n    // Add all trades to deleting list immediately for UI feedback\r\n    setDeletingTradeIds(prev => [...prev, ...tradesToDelete]);\r\n\r\n    try {\r\n      // Delete trades using the hook handler\r\n      await handleDeleteTrades(tradesToDelete);\r\n\r\n      // Show success message\r\n      const successMessage = tradesToDelete.length === 1\r\n        ? 'Trade deleted successfully.'\r\n        : `Successfully deleted ${tradesToDelete.length} trades.`;\r\n\r\n      showSnackbar(successMessage, 'success');\r\n    } catch (error) {\r\n      logger.error('Error deleting trades:', error);\r\n      const errorMessage = tradesToDelete.length === 1\r\n        ? 'Failed to delete trade. Please try again.'\r\n        : `Failed to delete some trades. Please try again.`;\r\n\r\n      setDeleteError(errorMessage);\r\n      showSnackbar(errorMessage, 'error');\r\n    } finally {\r\n      // Remove all trades from deleting list\r\n      setDeletingTradeIds(prev => prev.filter(id => !tradesToDelete.includes(id)));\r\n      setTradesToDelete([]);\r\n    }\r\n  };\r\n\r\n  const handleCancelDelete = () => {\r\n    setIsDeleteDialogOpen(false);\r\n    setTradesToDelete([]);\r\n    setDeleteError(null);\r\n  };\r\n\r\n\r\n  const handleDayClick = useCallback((trade_date: Date) => {\r\n    // In read-only mode, only allow viewing existing trades\r\n    if (isReadOnly) {\r\n      const dateKey = format(trade_date, 'yyyy-MM-dd');\r\n      const trades = tradesByDay.get(dateKey) || [];\r\n      if (trades.length > 0) {\r\n        setSelectedDate(trade_date);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Prevent adding new trades when app is loading all trades\r\n    if (isLoadingTrades) {\r\n      log('Cannot add trade while trades are loading');\r\n      showSnackbar('Cannot add trade while trades are loading. Please wait...', 'warning');\r\n      return;\r\n    }\r\n    if (trade_date > new Date()) {\r\n      log('Cannot add trade in the future');\r\n      showSnackbar('Cannot add trade in the future. Please select a valid date.', 'warning');\r\n      return;\r\n    }\r\n\r\n    if (!isDynamicRiskToggled) {\r\n      // Reset to use actual amounts set to false before adding any trade\r\n      setIsDynamicRiskToggled(true);\r\n      handleToggleDynamicRisk(true);\r\n      return;\r\n    }\r\n\r\n    const dateKey = format(trade_date, 'yyyy-MM-dd');\r\n    const trades = tradesByDay.get(dateKey) || [];\r\n\r\n    // When weekly target is set, always show DayDialog first (shows progress section)\r\n    // When no weekly target, go directly to add trade form for empty days\r\n    if (trades.length === 0 && !weeklyTarget) {\r\n      setNewTrade(createNewTradeData);\r\n      setShowAddForm({ open: true, trade_date: trade_date, showDayDialogWhenDone: true });\r\n    }\r\n    else {\r\n      setSelectedDate(trade_date);\r\n    }\r\n  }, [isReadOnly, tradesByDay, isLoadingTrades, isDynamicRiskToggled, handleToggleDynamicRisk, weeklyTarget]);\r\n  const handleDayChange = (trade_date: Date) => {\r\n    setSelectedDate(trade_date);\r\n  };\r\n\r\n\r\n\r\n\r\n\r\n  const handleMonthClick = () => {\r\n    // Open month selector - year_stats are already synced via realtime\r\n    setIsMonthSelectorOpen(true);\r\n  };\r\n\r\n  const handleMonthSelect = (trade_date: Date) => {\r\n    // Setting currentDate will trigger useEffect to load visible calendar range\r\n    // This includes overflow days from adjacent months\r\n    setCurrentDate(trade_date);\r\n    // Note: Dialog closes itself after this completes\r\n  };\r\n\r\n  const handleTagsChange = (tags: string[]) => {\r\n    setSelectedTags(tags);\r\n  };\r\n\r\n\r\n  const handleSnackbarClose = () => {\r\n    setSnackbarOpen(false);\r\n  };\r\n\r\n  // Utility function to show snackbar messages\r\n  const showSnackbar = (message: string, severity: 'success' | 'warning' | 'error' = 'warning') => {\r\n    setSnackbarMessage(message);\r\n    setSnackbarSeverity(severity);\r\n    setSnackbarOpen(true);\r\n  };\r\n\r\n  // Retry failed deletion\r\n  const retryDeletion = async () => {\r\n    if (deleteError && tradesToDelete.length > 0) {\r\n      setDeleteError(null);\r\n      await handleConfirmDelete();\r\n    }\r\n  };\r\n\r\n  // Gallery mode handlers\r\n  const openGalleryMode = (trades: Trade[], initialTradeId?: string, title?: string, fetchYear?: number) => {\r\n    setGalleryMode({\r\n      open: true,\r\n      trades,\r\n      initialTradeId,\r\n      title,\r\n      aiOnlyMode: false,\r\n      fetchYear\r\n    });\r\n  };\r\n\r\n  // Open gallery in AI-only mode (hides Trade tab, shows only Assistant)\r\n  const openGalleryModeAI = (trades: Trade[], tradeId: string, title?: string) => {\r\n    setGalleryMode({\r\n      open: true,\r\n      trades,\r\n      initialTradeId: tradeId,\r\n      title,\r\n      aiOnlyMode: true\r\n    });\r\n  };\r\n\r\n  const closeGalleryMode = () => {\r\n    setGalleryMode({\r\n      open: false,\r\n      trades: [],\r\n      initialTradeId: undefined,\r\n      title: undefined,\r\n      aiOnlyMode: false,\r\n      fetchYear: undefined\r\n    });\r\n  };\r\n\r\n  // Handler for editing a trade - used across multiple components\r\n  const handleEditTrade = useCallback((trade: Trade) => {\r\n    setNewTrade(() => (createEditTradeData(trade)));\r\n    setShowAddForm({\r\n      open: true,\r\n      trade_date: new Date(trade.trade_date),\r\n      editTrade: trade,\r\n      createTempTrade: false,\r\n      showDayDialogWhenDone: false\r\n    });\r\n  }, []);\r\n\r\n  // Create a unified tradeOperations object for all trade-related operations\r\n  const tradeOperations: TradeOperationsProps = useMemo(() => ({\r\n    onUpdateTradeProperty: isReadOnly ? undefined : handleUpdateTradeProperty,\r\n    onEditTrade: isReadOnly ? undefined : handleEditTrade,\r\n    onDeleteTrade: isReadOnly ? undefined : handleDeleteClick,\r\n    onDeleteMultipleTrades: isReadOnly ? undefined : handleDeleteMultipleTrades,\r\n    onZoomImage: setZoomedImage,\r\n    onOpenGalleryMode: openGalleryMode,\r\n    onOpenAIChat: isReadOnly ? undefined : (trade) => openGalleryModeAI(trades, trade.id, trade.name),\r\n    onUpdateCalendarProperty: isReadOnly ? undefined : onUpdateCalendarProperty,\r\n    isTradeUpdating,\r\n    deletingTradeIds,\r\n    calendarId: calendarId || undefined,\r\n    calendar,\r\n    isReadOnly,\r\n    economicFilter: (_calendarId) => calendar?.economic_calendar_filters || DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS\r\n  }), [\r\n    isReadOnly,\r\n    handleUpdateTradeProperty,\r\n    handleEditTrade,\r\n    handleDeleteClick,\r\n    handleDeleteMultipleTrades,\r\n    setZoomedImage,\r\n    openGalleryMode,\r\n    openGalleryModeAI,\r\n    trades,\r\n    onUpdateCalendarProperty,\r\n    isTradeUpdating,\r\n    deletingTradeIds,\r\n    calendarId,\r\n    calendar\r\n  ]);\r\n\r\n  return (\r\n    <Box sx={{\r\n      minHeight: '100vh',\r\n      bgcolor: 'custom.pageBackground',\r\n      position: 'relative',\r\n      overflow: 'hidden'\r\n    }}>\r\n      <AnimatedBackground />\r\n      {/* Floating Month Navigation */}\r\n      <FloatingMonthNavigation\r\n        currentDate={currentDate}\r\n        isVisible={showFloatingMonthNav}\r\n        onPrevMonth={handlePrevMonth}\r\n        onNextMonth={handleNextMonth}\r\n        onMonthClick={handleMonthClick}\r\n        onTodayClick={handleTodayClick}\r\n      />\r\n\r\n      {/* Hero Image Banner */}\r\n      {heroImageUrl && (\r\n        <Box\r\n          sx={{\r\n            position: 'relative',\r\n            height: { xs: 140, sm: 180, md: 220 },\r\n            overflow: 'hidden',\r\n            borderRadius: 0,\r\n          }}\r\n        >\r\n          {/* Hero image layer */}\r\n          <Box\r\n            sx={{\r\n              position: 'absolute',\r\n              inset: 0,\r\n              backgroundImage: `url(${heroImageUrl})`,\r\n              backgroundSize: 'cover',\r\n              backgroundPosition: 'center',\r\n              backgroundRepeat: 'no-repeat',\r\n              zIndex: 0,\r\n            }}\r\n          />\r\n\r\n          {/* Gradient overlay */}\r\n          <Box\r\n            sx={{\r\n              position: 'absolute',\r\n              inset: 0,\r\n              background: (theme: Theme) =>\r\n                `linear-gradient(180deg, ${alpha(theme.palette.common.black, 0.25)} 0%, ${alpha(theme.palette.common.black, 0.8)} 100%)`,\r\n              zIndex: 2,\r\n            }}\r\n          />\r\n\r\n          {/* Attribution */}\r\n          <Fade in={!!heroImageAttribution} timeout={300}>\r\n            <Box\r\n              sx={{\r\n                position: 'absolute',\r\n                bottom: { xs: 6, sm: 8 },\r\n                right: { xs: 8, sm: 12 },\r\n                zIndex: 3,\r\n                px: 1,\r\n                py: 0.5,\r\n                borderRadius: 0.75,\r\n                bgcolor: (theme: Theme) => alpha(theme.palette.common.black, 0.7),\r\n                color: 'common.white',\r\n              }}\r\n            >\r\n              <Typography variant=\"caption\" sx={{ fontSize: '0.7rem' }}>\r\n                Photo by {heroImageAttribution?.photographer} on Unsplash\r\n              </Typography>\r\n            </Box>\r\n          </Fade>\r\n        </Box>\r\n      )}\r\n\r\n      {/* Breadcrumbs */}\r\n      <Breadcrumbs items={breadcrumbItems} buttons={breadcrumbButtons} rightContent={breadcrumbRightContent} />\r\n\r\n\r\n\r\n\r\n      {/* Stacked Notes Widget - hidden in read-only mode */}\r\n      {calendarId && !isReadOnly && <StackedNotesWidget calendarId={calendarId} />}\r\n\r\n      {/* Main Content Container */}\r\n      <Box sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: { xs: 2, sm: 2.5, md: 3 },\r\n        p: { xs: 1.5, sm: 2, md: 3 },\r\n        mt: { xs: 0.5, sm: 1 }\r\n      }}>\r\n\r\n        {/* Content Wrapper with Modern Card Design */}\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          gap: { xs: 2, md: 3 },\r\n          maxWidth: '1400px',\r\n          margin: '0 auto',\r\n          width: '100%',\r\n          position: 'relative'\r\n        }}>\r\n\r\n          {/* Stats Cards Section with Enhanced Layout */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            gap: { xs: 2, md: 3 },\r\n            flexDirection: { xs: 'column', lg: 'row' },\r\n            justifyContent: 'center',\r\n            alignItems: 'stretch',\r\n            width: '100%'\r\n          }}>\r\n\r\n            <Box sx={{ flex: 1, height: '100%' }}>\r\n              <AccountStats\r\n                balance={accountBalance}\r\n                totalProfit={totalProfit}\r\n                trades={filteredTrades}\r\n                risk_per_trade={dynamicRiskSettings?.risk_per_trade}\r\n                dynamicRiskSettings={dynamicRiskSettings}\r\n                onToggleDynamicRisk={(useActualAmounts) => {\r\n                  setIsDynamicRiskToggled(useActualAmounts);\r\n                  handleToggleDynamicRisk(useActualAmounts);\r\n                }}\r\n                isDynamicRiskToggled={isDynamicRiskToggled}\r\n                isReadOnly={isReadOnly}\r\n                max_daily_drawdown={maxDailyDrawdown}\r\n              />\r\n            </Box>\r\n\r\n            <Box sx={{ flex: 1, height: '100%' }}>\r\n\r\n              <MonthlyStats\r\n                trades={filteredTrades}\r\n                accountBalance={accountBalance}\r\n                onImportTrades={handleImportTrades}\r\n                onDeleteTrade={handleDeleteClick}\r\n                currentDate={currentDate}\r\n                monthlyTarget={monthly_target}\r\n                onClearMonthTrades={handleClearMonthTrades}\r\n                isReadOnly={isReadOnly}\r\n                onOpenGalleryMode={openGalleryMode}\r\n                calendarId={calendarId!!}\r\n                scoreSettings={scoreSettings}\r\n                dynamicRiskSettings={dynamicRiskSettings}\r\n                onUpdateTradeProperty={handleUpdateTradeProperty}\r\n                onUpdateCalendarProperty={onUpdateCalendarProperty}\r\n                onEditTrade={handleEditTrade}\r\n                economicFilter={(_calendarId) => calendar?.economic_calendar_filters || DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS}\r\n                maxDailyDrawdown={maxDailyDrawdown}\r\n              />\r\n\r\n            </Box>\r\n\r\n\r\n          </Box>\r\n\r\n\r\n          {/* Calendar Navigation Header */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'space-between',\r\n            mb: { xs: 1.5, sm: 2, md: 3 },\r\n            flexDirection: { xs: 'column', lg: 'row' },\r\n            gap: { xs: 1.5, sm: 2, lg: 1 }\r\n          }}>\r\n            {/* Month Navigation with Enhanced Styling */}\r\n            <Box\r\n              data-testid=\"month-nav-section\"\r\n              sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: { xs: 1, sm: 1.5, md: 2 },\r\n                order: { xs: 1, lg: 0 }\r\n              }}\r\n            >\r\n              <IconButton\r\n                onClick={handlePrevMonth}\r\n                size=\"small\"\r\n                sx={{\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  color: 'primary.main',\r\n                  p: { xs: 0.75, sm: 1 },\r\n                  '&:hover': {\r\n                    bgcolor: alpha(theme.palette.primary.main, 0.2),\r\n                    transform: 'scale(1.05)'\r\n                  },\r\n                  transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                }}\r\n              >\r\n                <ChevronLeft sx={{ fontSize: { xs: '1.25rem', sm: '1.5rem' } }} />\r\n              </IconButton>\r\n\r\n              <Typography\r\n                variant=\"h4\"\r\n                sx={{\r\n                  fontWeight: 700,\r\n                  cursor: 'pointer',\r\n                  minWidth: { xs: '180px', sm: '220px', md: '250px' },\r\n                  textAlign: 'center',\r\n                  fontSize: { xs: '1.25rem', sm: '1.5rem', md: '1.8rem', lg: '2rem' },\r\n                  letterSpacing: '-0.5px',\r\n                  color: 'text.primary',\r\n                  background: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,\r\n                  backgroundClip: 'text',\r\n                  WebkitBackgroundClip: 'text',\r\n                  WebkitTextFillColor: 'transparent',\r\n                  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                  '&:hover': {\r\n                    transform: 'scale(1.02)',\r\n                    filter: 'brightness(1.1)'\r\n                  }\r\n                }}\r\n                onClick={handleMonthClick}\r\n              >\r\n                {format(currentDate, 'MMMM yyyy')}\r\n              </Typography>\r\n\r\n              <IconButton\r\n                onClick={handleNextMonth}\r\n                size=\"small\"\r\n                sx={{\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  color: 'primary.main',\r\n                  p: { xs: 0.75, sm: 1 },\r\n                  '&:hover': {\r\n                    bgcolor: alpha(theme.palette.primary.main, 0.2),\r\n                    transform: 'scale(1.05)'\r\n                  },\r\n                  transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                }}\r\n              >\r\n                <ChevronRight sx={{ fontSize: { xs: '1.25rem', sm: '1.5rem' } }} />\r\n              </IconButton>\r\n            </Box>\r\n            {/* Enhanced Action Buttons */}\r\n            <Box sx={{\r\n              display: 'flex',\r\n              flexDirection: { xs: 'column', sm: 'row' },\r\n              gap: { xs: 1, sm: 1.5, md: 2 },\r\n              flexWrap: 'wrap',\r\n              order: { xs: 0, lg: 1 },\r\n              width: { xs: '100%', lg: 'auto' }\r\n            }}>\r\n              {/* Primary Actions Group */}\r\n              <Box sx={{\r\n                display: 'flex',\r\n                gap: { xs: 0.75, sm: 1 },\r\n                flexWrap: 'wrap',\r\n                width: { xs: '100%', sm: 'auto' }\r\n              }}>\r\n                {/* Only show Today button when not viewing current month */}\r\n                {!isSameMonth(currentDate, new Date()) && (\r\n                  <Button\r\n                    startIcon={<Today sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />}\r\n                    onClick={handleTodayClick}\r\n                    variant=\"contained\"\r\n                    size=\"small\"\r\n                    sx={{\r\n                      flex: { xs: 1, sm: 'none' },\r\n                      minWidth: { xs: 'auto', sm: '100px' },\r\n                      borderRadius: 2,\r\n                      fontWeight: 600,\r\n                      textTransform: 'none',\r\n                      fontSize: { xs: '0.8125rem', sm: '0.875rem' },\r\n                      py: { xs: 0.75, sm: 1 },\r\n                      px: { xs: 1.5, sm: 2 },\r\n                      boxShadow: `0 4px 12px ${alpha(theme.palette.primary.main, 0.3)}`,\r\n                      '&:hover': {\r\n                        transform: 'translateY(-1px)',\r\n                        boxShadow: `0 6px 16px ${alpha(theme.palette.primary.main, 0.4)}`\r\n                      },\r\n                      transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                    }}\r\n                  >\r\n                    Today\r\n                  </Button>\r\n                )}\r\n\r\n                {/* Notes Button - Moved from FAB */}\r\n                <Tooltip title=\"Notes for this calendar\" arrow>\r\n                  <Button\r\n                    startIcon={<NotesIcon sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />}\r\n                    onClick={() => setIsNotesDrawerOpen(true)}\r\n                    variant=\"outlined\"\r\n                    size=\"small\"\r\n                    sx={{\r\n                      flex: { xs: 1, sm: 'none' },\r\n                      minWidth: { xs: 'auto', sm: '100px' },\r\n                      borderRadius: 2,\r\n                      fontWeight: 600,\r\n                      textTransform: 'none',\r\n                      fontSize: { xs: '0.8125rem', sm: '0.875rem' },\r\n                      py: { xs: 0.75, sm: 1 },\r\n                      px: { xs: 1.5, sm: 2 },\r\n                      borderColor: alpha(theme.palette.text.secondary, 0.3),\r\n                      color: 'text.secondary',\r\n                      '&:hover': {\r\n                        borderColor: 'info.main',\r\n                        bgcolor: alpha(theme.palette.info.main, 0.1),\r\n                        color: 'info.main',\r\n                        transform: 'translateY(-1px)'\r\n                      },\r\n                      transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                    }}\r\n                  >\r\n                    Notes\r\n                  </Button>\r\n                </Tooltip>\r\n\r\n\r\n              </Box>\r\n\r\n              {/* Secondary Actions Group */}\r\n              <Box sx={{\r\n                display: 'flex',\r\n                gap: { xs: 0.75, sm: 1 },\r\n                flexWrap: 'wrap',\r\n                width: { xs: '100%', sm: 'auto' }\r\n              }}>\r\n                <Button\r\n                  startIcon={<PinIcon sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />}\r\n                  onClick={() => setPinnedTradesDrawerOpen(true)}\r\n                  variant={\"outlined\"}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    flex: { xs: 1, sm: 'none' },\r\n                    minWidth: { xs: 'auto', sm: '100px' },\r\n                    borderRadius: 2,\r\n                    fontWeight: 600,\r\n                    textTransform: 'none',\r\n                    fontSize: { xs: '0.8125rem', sm: '0.875rem' },\r\n                    py: { xs: 0.75, sm: 1 },\r\n                    px: { xs: 1.5, sm: 2 },\r\n                    ...({\r\n                      borderColor: alpha(theme.palette.text.secondary, 0.3),\r\n                      color: 'text.secondary',\r\n                      '&:hover': {\r\n                        borderColor: 'info.main',\r\n                        bgcolor: alpha(theme.palette.info.main, 0.1),\r\n                        color: 'info.main',\r\n                        transform: 'translateY(-1px)'\r\n                      }\r\n                    }),\r\n                    transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                  }}\r\n                >\r\n                  Pinned\r\n                </Button>\r\n\r\n                <TagFilter\r\n                  allTags={allTags}\r\n                  selectedTags={selectedTags}\r\n                  onTagsChange={handleTagsChange}\r\n                  onOpenDrawer={() => setIsSearchDrawerOpen(true)}\r\n                />\r\n\r\n                <Tooltip title={isReadOnly ? \"View tags and definitions\" : \"Manage tags and required tag groups\"} arrow>\r\n                  <Button\r\n                    variant=\"outlined\"\r\n                    size=\"small\"\r\n                    startIcon={<TagIcon sx={{ fontSize: { xs: '1rem', sm: '1.25rem' } }} />}\r\n                    onClick={() => setIsTagManagementDrawerOpen(true)}\r\n                    sx={{\r\n                      flex: { xs: 1, sm: 'none' },\r\n                      minWidth: { xs: 'auto', sm: '120px' },\r\n                      borderRadius: 2,\r\n                      fontWeight: 600,\r\n                      textTransform: 'none',\r\n                      fontSize: { xs: '0.8125rem', sm: '0.875rem' },\r\n                      py: { xs: 0.75, sm: 1 },\r\n                      px: { xs: 1.5, sm: 2 },\r\n                      borderColor: alpha(theme.palette.text.secondary, 0.3),\r\n                      color: 'text.secondary',\r\n                      '&:hover': {\r\n                        borderColor: 'info.main',\r\n                        bgcolor: alpha(theme.palette.info.main, 0.1),\r\n                        color: 'info.main',\r\n                        transform: 'translateY(-1px)'\r\n                      },\r\n                      transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)'\r\n                    }}\r\n                  >\r\n                    Tags\r\n                  </Button>\r\n                </Tooltip>\r\n              </Box>\r\n            </Box>\r\n          </Box>\r\n\r\n\r\n\r\n          {/* Calendar Grid Container */}\r\n          <Box sx={{\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            gap: { xs: 1, md: 2 }\r\n          }}>\r\n            {/* Enhanced Weekday Headers */}\r\n            <Box sx={{\r\n              display: 'grid',\r\n              gridTemplateColumns: { xs: 'repeat(7, 1fr)', sm: 'repeat(8, 1fr)' },\r\n              gap: { xs: 1, md: 1.5 },\r\n              mb: { xs: 1, md: 2 }\r\n            }}>\r\n              {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Week'].map((day, index) => (\r\n                <WeekdayHeader\r\n                  key={day}\r\n                  sx={{\r\n                    display: index === 7 ? { xs: 'none', sm: 'flex' } : 'flex',\r\n                    cursor: 'default',\r\n                    position: 'relative',\r\n                    justifyContent: 'center',\r\n                    alignItems: 'center',\r\n                    p: { xs: 1, md: 1.5 },\r\n                    fontWeight: 600,\r\n                    fontSize: { xs: '0.875rem', md: '1rem' },\r\n                    color: 'text.secondary',\r\n                    transition: 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)',\r\n                  }}\r\n                >\r\n                  {day}\r\n                </WeekdayHeader>\r\n              ))}\r\n            </Box>\r\n            {/* Enhanced Calendar Grid */}\r\n            <Box sx={{\r\n              display: 'grid',\r\n              gridTemplateColumns: { xs: 'repeat(7, 1fr)', sm: 'repeat(8, 1fr)' },\r\n              gap: { xs: 1, md: 1.5 },\r\n              minHeight: { xs: 'auto', md: '400px' }\r\n            }}>\r\n              {eachWeekOfInterval(\r\n                {\r\n                  start: startOfMonth(currentDate),\r\n                  end: endOfMonth(currentDate)\r\n                },\r\n                { weekStartsOn: 0 }\r\n              ).map((weekStart, index) => {\r\n                const weekDays = eachDayOfInterval({\r\n                  start: weekStart,\r\n                  end: endOfWeek(weekStart, { weekStartsOn: 0 })\r\n                });\r\n\r\n                return (\r\n                  <React.Fragment key={weekStart.toISOString()}>\r\n                    {weekDays.map((day) => {\r\n                      const dateKey = format(day, 'yyyy-MM-dd');\r\n                      const dayTrades = tradesByDay.get(dateKey) || [];\r\n\r\n                      const dayStats = dayStatsMap.get(dateKey) ?? {\r\n                        netAmount: 0,\r\n                        percentage: '0',\r\n                        status: 'none' as DayStatus,\r\n                        isDrawdownViolation: false\r\n                      };\r\n\r\n                      return (\r\n                        <CalendarDayCell\r\n                          key={day.toISOString()}\r\n                          day={day}\r\n                          dayTrades={dayTrades}\r\n                          currentDate={currentDate}\r\n                          monthlyHighImpactEvents={monthlyHighImpactEvents}\r\n                          onDayClick={handleDayClick}\r\n                          isMdDown={isMdDown}\r\n                          dayStats={dayStats}\r\n                        />\r\n                      );\r\n                    })}\r\n\r\n                    <WeeklyPnL\r\n                      trade_date={weekStart}\r\n                      weekIndex={index}\r\n                      weeklyTarget={weeklyTarget}\r\n                      sx={{ display: { xs: 'none', sm: 'flex' } }}\r\n                      weekStats={weeklyStatsMap.get(format(weekStart, 'yyyy-MM-dd')) ?? {\r\n                        weekTrades: [],\r\n                        netAmount: 0,\r\n                        percentage: '0',\r\n                        targetProgressValue: 0\r\n                      }}\r\n                      accountBalance={accountBalance + totalProfit}\r\n                    />\r\n\r\n                  </React.Fragment>\r\n                );\r\n              })}\r\n            </Box>\r\n\r\n            {/* Weekly stats for mobile - HIDDEN to save space */}\r\n            {/* Mobile users can view weekly stats in the monthly statistics section below */}\r\n          </Box>\r\n\r\n\r\n          {/*Current Monthly Statistics Section */}\r\n          {/* Session Performance - Only shown on desktop */}\r\n          {!isMdDown && (\r\n            <SessionPerformanceAnalysis\r\n              sessionStats={sessionStats}\r\n              trades={filteredTrades}\r\n              selectedDate={currentDate}\r\n              timePeriod=\"month\"\r\n              setMultipleTradesDialog={setSessionTradesDialog}\r\n            />\r\n          )}\r\n\r\n          {/* Session Trades List Dialog - conditionally rendered to prevent unnecessary effects */}\r\n          {sessionTradesDialog.open && (\r\n            <TradesListDialog\r\n              open={sessionTradesDialog.open}\r\n              onClose={() => setSessionTradesDialog(prev => ({ ...prev, open: false }))}\r\n              trades={sessionDialogTrades}\r\n              title={sessionTradesDialog.title}\r\n              expandedTradeId={sessionTradesDialog.expandedTradeId}\r\n              onTradeExpand={(tradeId) =>\r\n                setSessionTradesDialog(prev => ({\r\n                  ...prev,\r\n                  expandedTradeId: prev.expandedTradeId === tradeId ? null : tradeId\r\n                }))\r\n              }\r\n              account_balance={accountBalance}\r\n              tradeOperations={tradeOperations}\r\n            />\r\n          )}\r\n\r\n\r\n        </Box>\r\n\r\n        <DayDialog\r\n          open={!!selectedDate && !showAddForm?.open}\r\n          onClose={() => {\r\n            setSelectedDate(null);\r\n          }}\r\n          showAddForm={isReadOnly ? () => { } : (trade) => {\r\n            if (trade !== null) {\r\n              setNewTrade(() => (createEditTradeData(trade!!)));\r\n            }\r\n            setShowAddForm({ open: true, trade_date: selectedDate!!, editTrade: trade, createTempTrade: trade === null, showDayDialogWhenDone: true });\r\n          }}\r\n          date={selectedDate || new Date()}\r\n          trades={selectedDate ? tradesForSelectedDay : []}\r\n          onDateChange={handleDayChange}\r\n          account_balance={accountBalance}\r\n          tradeOperations={tradeOperations}\r\n          onOpenAIChatMode={isReadOnly ? undefined : openGalleryModeAI}\r\n          weekTrades={selectedDate\r\n            ? weeklyStatsMap.get(format(startOfWeek(selectedDate, { weekStartsOn: 0 }), 'yyyy-MM-dd'))?.weekTrades\r\n            : undefined\r\n          }\r\n        />\r\n\r\n\r\n        {!isReadOnly && (\r\n          <TradeFormDialog\r\n            open={(!!showAddForm?.trade_date && showAddForm?.open) || false}\r\n            onClose={() => {\r\n              setSelectedDate(null);\r\n              setShowAddForm(null);\r\n              if (newTrade != null && newTrade.pending_images) {\r\n                // Release object URLs to avoid memory leaks\r\n                newTrade.pending_images.forEach(image => {\r\n                  URL.revokeObjectURL(image.preview);\r\n                });\r\n                setNewTrade(null);\r\n              }\r\n            }}\r\n            onCancel={() => {\r\n              if (showAddForm?.showDayDialogWhenDone) {\r\n                setSelectedDate(null);\r\n                setSelectedDate(showAddForm?.trade_date!!); // show the day dialog\r\n              }\r\n              setShowAddForm(null);\r\n            }}\r\n            showForm={{ open: showAddForm?.open || false, editTrade: showAddForm?.editTrade || null, createTempTrade: showAddForm?.createTempTrade || false }}\r\n            trade_date={showAddForm?.trade_date || new Date()}\r\n            onAddTrade={handleAddTrade}\r\n            newMainTrade={newTrade}\r\n            setNewMainTrade={prev => setNewTrade(prev(newTrade!!))}\r\n            onTagUpdated={handleTagUpdated}\r\n            onUpdateTradeProperty={handleUpdateTradeProperty}\r\n            onDeleteTrades={handleDeleteTrades}\r\n            setZoomedImage={setZoomedImage}\r\n            account_balance={accountBalance}\r\n            onAccountBalanceChange={handleAccountBalanceChange}\r\n            calendar={calendar}\r\n            tags={allTags}\r\n            dynamicRiskSettings={dynamicRiskSettings}\r\n            requiredTagGroups={requiredTagGroups}\r\n            onOpenGalleryMode={openGalleryMode}\r\n          />\r\n        )}\r\n\r\n\r\n        {/* Image Zoom Dialog */}\r\n        {zoomedImages && <ImageZoomDialog\r\n          open={!!zoomedImages}\r\n          onClose={() => setZoomedImagesState(null)}\r\n          imageProp={zoomedImages}\r\n        />}\r\n\r\n        <SelectDateDialog\r\n          open={isMonthSelectorOpen}\r\n          onClose={() => setIsMonthSelectorOpen(false)}\r\n          onDateSelect={handleMonthSelect}\r\n          initialDate={selectedDate || undefined}\r\n          accountBalance={accountBalance}\r\n          monthlyTarget={monthly_target}\r\n          yearlyTarget={yearlyTarget}\r\n          yearStats={calendar?.year_stats || {}}\r\n          onOpenGalleryMode={openGalleryMode}\r\n        />\r\n\r\n\r\n\r\n\r\n        {/* Drawers */}\r\n\r\n        <TagManagementDrawer\r\n          open={isTagManagementDrawerOpen}\r\n          onClose={() => setIsTagManagementDrawerOpen(false)}\r\n          allTags={allTags}\r\n          calendarId={calendarId!!}\r\n          onTagUpdated={handleTagUpdated}\r\n          requiredTagGroups={requiredTagGroups}\r\n          onUpdateCalendarProperty={onUpdateCalendarProperty}\r\n          isReadOnly={isReadOnly}\r\n          calendarOwnerId={calendar?.user_id}\r\n        />\r\n\r\n        {/* Snackbar for notifications */}\r\n        <TagManagementDialog\r\n          open={isTagManagementDialogOpen}\r\n          onClose={() => setIsTagManagementDialogOpen(false)}\r\n          allTags={allTags}\r\n          calendarId={calendarId!!}\r\n          onTagUpdated={handleTagUpdated}\r\n          requiredTagGroups={requiredTagGroups}\r\n          onUpdateCalendarProperty={onUpdateCalendarProperty}\r\n        />\r\n\r\n        {/* Confirmation Delete Dialog */}\r\n        <ConfirmationDialog\r\n          open={isDeleteDialogOpen}\r\n          title={tradesToDelete.length === 1 ? \"Delete Trade\" : `Delete ${tradesToDelete.length} Trades`}\r\n          message={\r\n            tradesToDelete.length === 1\r\n              ? \"Are you sure you want to delete this trade? This action cannot be undone.\"\r\n              : `Are you sure you want to delete ${tradesToDelete.length} trades? This action cannot be undone.`\r\n          }\r\n          confirmText=\"Delete\"\r\n          cancelText=\"Cancel\"\r\n          onConfirm={handleConfirmDelete}\r\n          onCancel={handleCancelDelete}\r\n          confirmColor=\"error\"\r\n          isSubmitting={deletingTradeIds.some(id => tradesToDelete.includes(id))}\r\n        />\r\n\r\n        <Snackbar\r\n          open={snackbarOpen}\r\n          autoHideDuration={snackbarSeverity === 'success' ? 3000 : deleteError ? 6000 : 4000}\r\n          onClose={handleSnackbarClose}\r\n          anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n          sx={{ zIndex: Z_INDEX.SNACKBAR }}\r\n        >\r\n          <Alert\r\n            onClose={handleSnackbarClose}\r\n            severity={snackbarSeverity}\r\n            variant=\"filled\"\r\n            sx={{ width: '100%' }}\r\n            action={\r\n              deleteError && tradesToDelete.length > 0 ? (\r\n                <Button\r\n                  color=\"inherit\"\r\n                  size=\"small\"\r\n                  onClick={() => {\r\n                    handleSnackbarClose();\r\n                    retryDeletion();\r\n                  }}\r\n                  sx={{ color: 'inherit' }}\r\n                >\r\n                  Retry\r\n                </Button>\r\n              ) : undefined\r\n            }\r\n          >\r\n            {snackbarMessage}\r\n          </Alert>\r\n        </Snackbar>\r\n\r\n\r\n        {/* AI Chat FAB - Hidden in read-only mode */}\r\n        {!isReadOnly && (\r\n          <Tooltip title=\"AI Trading Assistant\" placement=\"left\">\r\n            <Fab\r\n              color=\"secondary\"\r\n              aria-label=\"open ai chat\"\r\n              onClick={handleToggleAIChat}\r\n              size=\"medium\"\r\n              sx={{\r\n                position: 'fixed',\r\n                bottom: { xs: 80, sm: 96 },\r\n                right: { xs: 16, sm: 24 },\r\n                zIndex: 1200,\r\n                width: { xs: 48, sm: 56 },\r\n                height: { xs: 48, sm: 56 }\r\n              }}\r\n            >\r\n              <AIIcon sx={{ fontSize: { xs: '1.25rem', sm: '1.5rem' } }} />\r\n            </Fab>\r\n          </Tooltip>\r\n        )}\r\n\r\n        {/* Economic Calendar FAB - Hidden in read-only mode */}\r\n        {!isReadOnly && (\r\n          <Tooltip title=\"Economic Calendar\" placement=\"left\">\r\n            <Fab\r\n              color=\"primary\"\r\n              aria-label=\"open economic calendar\"\r\n              onClick={handleToggleEconomicCalendar}\r\n              size=\"medium\"\r\n              sx={{\r\n                position: 'fixed',\r\n                bottom: { xs: 16, sm: 24 },\r\n                right: { xs: 16, sm: 24 },\r\n                zIndex: 1200,\r\n                width: { xs: 48, sm: 56 },\r\n                height: { xs: 48, sm: 56 }\r\n              }}\r\n            >\r\n              <EventIcon sx={{ fontSize: { xs: '1.25rem', sm: '1.5rem' } }} />\r\n            </Fab>\r\n          </Tooltip>\r\n        )}\r\n\r\n\r\n        {/* Search & Filter Drawer */}\r\n        {calendar && calendarId && (\r\n          <SearchDrawer\r\n            open={isSearchDrawerOpen}\r\n            onClose={() => setIsSearchDrawerOpen(false)}\r\n            calendarId={calendarId}\r\n            allTags={allTags}\r\n            selectedTags={selectedTags}\r\n            onTagsChange={handleTagsChange}\r\n            onTradeClick={(trade) => {\r\n              // Close search drawer and open the trade in gallery mode\r\n              setIsSearchDrawerOpen(false);\r\n              openGalleryMode(trades, trade.id, \"Search Results\");\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Pinned Trades Drawer */}\r\n        <PinnedTradesDrawer\r\n          open={pinnedTradesDrawerOpen}\r\n          onClose={() => setPinnedTradesDrawerOpen(false)}\r\n          calendarId={calendarId}\r\n          onTradeClick={(trade, allTrades, title) => {\r\n            // Close drawer and open the trade in gallery mode\r\n            setPinnedTradesDrawerOpen(false);\r\n            openGalleryMode(allTrades, trade.id, title);\r\n          }}\r\n          tradeOperations={tradeOperations}\r\n        />\r\n\r\n        {/* Trade Gallery Dialog */}\r\n        <TradeGalleryDialog\r\n          open={galleryMode.open}\r\n          onClose={closeGalleryMode}\r\n          trades={galleryMode.trades}\r\n          initialTradeId={galleryMode.initialTradeId}\r\n          setZoomedImage={setZoomedImage}\r\n          title={galleryMode.title}\r\n          calendarId={calendarId}\r\n          calendar={calendar}\r\n          aiOnlyMode={galleryMode.aiOnlyMode}\r\n          isReadOnly={isReadOnly}\r\n          fetchYear={galleryMode.fetchYear}\r\n          tradeOperations={tradeOperations}\r\n        />\r\n\r\n\r\n\r\n        {/* Calendar Edit Dialog */}\r\n        <CalendarFormDialog\r\n          open={isCalendarEditOpen}\r\n          onClose={() => setIsCalendarEditOpen(false)}\r\n          onSubmit={handleCalendarEditSubmit}\r\n          initialData={calendar}\r\n          isSubmitting={isCalendarEditSubmitting}\r\n          mode=\"edit\"\r\n          title=\"Edit Calendar\"\r\n          submitButtonText=\"Save\"\r\n        />\r\n\r\n      </Box>\r\n\r\n      {/* Economic Calendar Drawer */}\r\n      <EconomicCalendarDrawer\r\n        open={isEconomicCalendarOpen}\r\n        onClose={() => setIsEconomicCalendarOpen(false)}\r\n        calendar={calendar!}\r\n        payload={economicCalendarUpdatedEvent}\r\n        isReadOnly={isReadOnly}\r\n        tradeOperations={tradeOperations}\r\n      />\r\n\r\n      {/* AI Chat Drawer */}\r\n      <AIChatDrawer\r\n        open={isAIChatOpen}\r\n        onClose={() => setIsAIChatOpen(false)}\r\n        trades={trades}\r\n        calendar={calendar!}\r\n        isReadOnly={isReadOnly}\r\n        tradeOperations={tradeOperations}\r\n      />\r\n\r\n      {/* Notes Drawer */}\r\n      <NotesDrawer\r\n        open={isNotesDrawerOpen}\r\n        onClose={() => setIsNotesDrawerOpen(false)}\r\n        calendarId={calendarId}\r\n        isReadOnly={isReadOnly}\r\n      />\r\n\r\n\r\n      {/* Notification stack container (bottom left, global) */}\r\n      <Box\r\n        sx={{\r\n          position: 'fixed',\r\n          bottom: { xs: 16, sm: 24 },\r\n          left: { xs: 8, sm: 12 },\r\n          right: { xs: 8, sm: 'auto' },\r\n          zIndex: 1400,\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          gap: { xs: 1.5, sm: 2 },\r\n          pointerEvents: 'none',\r\n          maxWidth: { xs: 'calc(100% - 16px)', sm: '400px' }\r\n        }}\r\n      >\r\n        {notifications.map(event => (\r\n          <EconomicEventNotification\r\n            key={event.id}\r\n            event={event}\r\n            onClose={() => handleCloseNotification(event.id)}\r\n            autoHideDuration={30000}\r\n            isRemoving={removingNotifications.has(event.id)}\r\n          />\r\n        ))}\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default TradeCalendar;\r\n","/**\r\n * Hook for managing economic event watching in TradeCalendar\r\n */\r\n\r\nimport { useEffect, useCallback, useRef, useMemo } from 'react';\r\nimport { economicEventWatcher } from '../services/economicEventWatcher';\r\nimport { EconomicEvent } from '../types/economicCalendar';\r\nimport { error, log } from '../utils/logger';\r\n\r\ninterface UseEconomicEventWatcherProps {\r\n  calendarId?: string;\r\n  economic_calendar_filters?: {\r\n    currencies: string[];\r\n    impacts: string[];\r\n    viewType: 'day' | 'week' | 'month';\r\n  };\r\n  isActive?: boolean; // Whether the calendar is currently active/visible\r\n}\r\n\r\ninterface UseEconomicEventWatcherReturn {\r\n  startWatching: () => void;\r\n  stopWatching: () => void;\r\n  watchingStatus: {\r\n    isActive: boolean;\r\n    watchedEventsCount: number;\r\n  };\r\n}\r\n\r\nexport const useEconomicEventWatcher = ({\r\n  calendarId,\r\n  economic_calendar_filters,\r\n  isActive = true\r\n}: UseEconomicEventWatcherProps): UseEconomicEventWatcherReturn => {\r\n  const isInitialized = useRef(false);\r\n\r\n  // Memoize filters to prevent unnecessary re-renders when only stats change\r\n  // Only recreate when actual filter values change, not object reference\r\n  const stableFilters = useMemo(() => {\r\n    if (!economic_calendar_filters) return undefined;\r\n    return {\r\n      currencies: economic_calendar_filters.currencies,\r\n      impacts: economic_calendar_filters.impacts,\r\n      viewType: economic_calendar_filters.viewType\r\n    };\r\n  }, [\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    economic_calendar_filters?.currencies?.join(','),\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    economic_calendar_filters?.impacts?.join(','),\r\n    economic_calendar_filters?.viewType\r\n  ]);\r\n\r\n  // Initialize the watcher once\r\n  useEffect(() => {\r\n    if (!isInitialized.current) {\r\n      economicEventWatcher.initialize({\r\n        onEventsUpdated: (events: EconomicEvent[], allEvents: EconomicEvent[], calendarId: string) => {\r\n          log(` ${events.length} events updated simultaneously for calendar ${calendarId}`);\r\n\r\n          // Dispatch multiple events update\r\n          window.dispatchEvent(new CustomEvent('economicEventsUpdated', {\r\n            detail: { events, allEvents, calendarId }\r\n          }));\r\n        },\r\n        onError: (err: Error, calendarId: string) => {\r\n          error(` Economic event watcher error for calendar ${calendarId}:`, err);\r\n\r\n          // You could show a toast notification or handle the error as needed\r\n          window.dispatchEvent(new CustomEvent('economicEventWatcherError', {\r\n            detail: { error: err.message, calendarId }\r\n          }));\r\n        }\r\n      });\r\n      isInitialized.current = true;\r\n    }\r\n  }, []);\r\n\r\n  const startWatching = useCallback(() => {\r\n    if (calendarId && isActive) {\r\n      economicEventWatcher.startWatching(calendarId, stableFilters);\r\n    }\r\n  }, [calendarId, stableFilters, isActive]);\r\n\r\n  const stopWatching = useCallback(() => {\r\n    if (calendarId) { \r\n      economicEventWatcher.stopWatching(calendarId);\r\n    }\r\n  }, [calendarId]);\r\n\r\n  // Auto-start watching when calendar becomes active\r\n  useEffect(() => {\r\n    if (isActive && calendarId) {\r\n      startWatching();\r\n    } else {\r\n      stopWatching();\r\n    }\r\n\r\n    // Cleanup on unmount\r\n    return () => {\r\n      stopWatching();\r\n    };\r\n  }, [isActive, calendarId, startWatching, stopWatching]);\r\n\r\n  // Get current watching status\r\n  const watchingStatus = economicEventWatcher.getWatchingStatus();\r\n\r\n  return {\r\n    startWatching,\r\n    stopWatching,\r\n    watchingStatus: {\r\n      isActive: watchingStatus.isActive,\r\n      watchedEventsCount: watchingStatus.watchedEventsCount\r\n    }\r\n  };\r\n};\r\n \r\n// Custom hook for listening to multiple economic event updates (same release time)\r\nexport const useEconomicEventsUpdates = (callback: (events: EconomicEvent[], allEvents: EconomicEvent[], calendarId: string) => void) => {\r\n  useEffect(() => {\r\n    const handleEventsUpdate = (e: CustomEvent) => {\r\n      callback(e.detail.events, e.detail.allEvents, e.detail.calendarId);\r\n    };\r\n\r\n    window.addEventListener('economicEventsUpdated', handleEventsUpdate as EventListener);\r\n\r\n    return () => {\r\n      window.removeEventListener('economicEventsUpdated', handleEventsUpdate as EventListener);\r\n    };\r\n  }, [callback]);\r\n};\r\n\r\n// Custom hook for listening to watcher errors\r\nexport const useEconomicEventWatcherErrors = (callback: (error: string, calendarId: string) => void) => {\r\n  useEffect(() => {\r\n    const handleError = (e: CustomEvent) => {\r\n      callback(e.detail.error, e.detail.calendarId);\r\n    };\r\n\r\n    window.addEventListener('economicEventWatcherError', handleError as EventListener);\r\n    \r\n    return () => {\r\n      window.removeEventListener('economicEventWatcherError', handleError as EventListener);\r\n    };\r\n  }, [callback]);\r\n};\r\n","/**\r\n * Format a numeric value as currency\r\n * @param amount The amount to format\r\n * @returns Formatted currency string\r\n */\r\nexport const formatValue = (amount: number | undefined | null): string => {\r\n  // Handle undefined, null, or NaN values\r\n  if (amount === undefined || amount === null || isNaN(amount)) {\r\n    return '$0.00';\r\n  }\r\n\r\n  const absAmount = Math.abs(amount);\r\n  if (absAmount >= 1000) {\r\n    return `$${(amount / 1000).toFixed(1)}k`;\r\n  }\r\n  return `$${amount.toFixed(2)}`;\r\n};\r\n\r\n/**\r\n * Format a numeric value as currency with full precision\r\n * @param amount The amount to format\r\n * @returns Formatted currency string\r\n */\r\nexport const formatCurrency = (amount: number | undefined | null): string => {\r\n  // Handle undefined, null, or NaN values\r\n  if (amount === undefined || amount === null || isNaN(amount)) {\r\n    return '$0.00';\r\n  }\r\n\r\n  return `$${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n};\r\n\r\n/**\r\n * Format a percentage value\r\n * @param value The percentage value to format\r\n * @param decimals Number of decimal places\r\n * @returns Formatted percentage string\r\n */\r\nexport const formatPercentage = (value: number | undefined | null, decimals: number = 1): string => {\r\n  // Handle undefined, null, or NaN values\r\n  if (value === undefined || value === null || isNaN(value)) {\r\n    return '0.0%';\r\n  }\r\n\r\n  return `${value.toFixed(decimals)}%`;\r\n};\r\n\r\n/**\r\n * Format a date in a consistent way\r\n * @param date The date to format\r\n * @param format The format to use (short, medium, long)\r\n * @returns Formatted date string\r\n */\r\nexport const formatDate = (date: Date, format: 'short' | 'medium' | 'long' = 'medium'): string => {\r\n  switch (format) {\r\n    case 'short':\r\n      return date.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' });\r\n    case 'medium':\r\n      return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });\r\n    case 'long':\r\n      return date.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });\r\n    default:\r\n      return date.toLocaleDateString();\r\n  }\r\n};\r\n","/**\r\n * Conversation Repository\r\n * Handles all AI conversation-related database operations with Supabase\r\n */\r\n\r\nimport {\r\n  AbstractBaseRepository,\r\n  RepositoryConfig,\r\n  RepositoryResult\r\n} from './BaseRepository';\r\nimport {\r\n  AIConversation,\r\n  SerializableAIConversation,\r\n  ChatMessage,\r\n  SerializableChatMessage\r\n} from '../../../types/aiChat';\r\nimport { logger } from '../../../utils/logger';\r\nimport { supabase } from '../../../config/supabase';\r\n\r\n/**\r\n * Pagination options for conversation queries\r\n */\r\nexport interface ConversationPaginationOptions {\r\n  limit?: number;\r\n  offset?: number;\r\n}\r\n\r\n/**\r\n * Paginated result with metadata\r\n */\r\nexport interface PaginatedConversations {\r\n  conversations: AIConversation[];\r\n  totalCount: number;\r\n  hasMore: boolean;\r\n}\r\n\r\n/**\r\n * Safely parse a date value, returning a valid Date or fallback\r\n */\r\nconst parseDate = (dateValue: any, fallback: Date = new Date()): Date => {\r\n  if (!dateValue) return fallback;\r\n  const parsed = new Date(dateValue);\r\n  return isNaN(parsed.getTime()) ? fallback : parsed;\r\n};\r\n\r\n/**\r\n * Transform Supabase conversation data to AIConversation type\r\n * Converts string dates to Date objects and serializable messages to ChatMessage\r\n */\r\nconst transformSupabaseConversation = (data: any): AIConversation => {\r\n  return {\r\n    ...data,\r\n    created_at: parseDate(data.created_at),\r\n    updated_at: parseDate(data.updated_at),\r\n    messages: data.messages ? data.messages.map((msg: SerializableChatMessage) => ({\r\n      ...msg,\r\n      timestamp: parseDate(msg.timestamp)\r\n    })) : []\r\n  } as AIConversation;\r\n};\r\n\r\n/**\r\n * Transform ChatMessage array to SerializableChatMessage array for database storage\r\n */\r\nconst serializeMessages = (messages: ChatMessage[]): SerializableChatMessage[] => {\r\n  return messages.map(msg => ({\r\n    ...msg,\r\n    timestamp: msg.timestamp.toISOString()\r\n  }));\r\n};\r\n\r\n/**\r\n * Generate conversation title from first user message\r\n */\r\nconst generateConversationTitle = (messages: ChatMessage[]): string => {\r\n  const firstUserMessage = messages.find(msg => msg.role === 'user');\r\n  if (firstUserMessage && firstUserMessage.content) {\r\n    // Take first 50 characters and add ellipsis if truncated\r\n    const title = firstUserMessage.content.substring(0, 50);\r\n    return title.length < firstUserMessage.content.length ? `${title}...` : title;\r\n  }\r\n  // Fallback to timestamp\r\n  return `Conversation on ${new Date().toLocaleDateString()}`;\r\n};\r\n\r\nexport class ConversationRepository extends AbstractBaseRepository<AIConversation> {\r\n  constructor(config?: Partial<RepositoryConfig>) {\r\n    super(config);\r\n  }\r\n\r\n  // =====================================================\r\n  // READ OPERATIONS\r\n  // =====================================================\r\n\r\n  /**\r\n   * Find conversation by ID\r\n   */\r\n  async findById(id: string): Promise<AIConversation | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*')\r\n        .eq('id', id)\r\n        .single();\r\n\r\n      if (error) {\r\n        logger.error('Error finding conversation by ID:', error);\r\n        return null;\r\n      }\r\n\r\n      return data ? transformSupabaseConversation(data) : null;\r\n    } catch (error) {\r\n      logger.error('Error finding conversation by ID:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find all conversations for a specific calendar (calendar-level only, excludes trade-specific)\r\n   * Ordered by most recently updated first\r\n   * @param calendarId - The calendar ID to filter by\r\n   * @param options - Optional pagination options (limit, offset)\r\n   */\r\n  async findByCalendarId(\r\n    calendarId: string,\r\n    options?: ConversationPaginationOptions\r\n  ): Promise<PaginatedConversations> {\r\n    const DEFAULT_LIMIT = 15;\r\n    const limit = options?.limit ?? DEFAULT_LIMIT;\r\n    const offset = options?.offset ?? 0;\r\n\r\n    try {\r\n      // Get total count first\r\n      const { count, error: countError } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('calendar_id', calendarId)\r\n        .is('trade_id', null);\r\n\r\n      if (countError) {\r\n        logger.error('Error counting conversations by calendar ID:', countError);\r\n        return { conversations: [], totalCount: 0, hasMore: false };\r\n      }\r\n\r\n      const totalCount = count ?? 0;\r\n\r\n      // Get paginated data\r\n      const { data, error } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*')\r\n        .eq('calendar_id', calendarId)\r\n        .is('trade_id', null)\r\n        .order('updated_at', { ascending: false })\r\n        .range(offset, offset + limit - 1);\r\n\r\n      if (error) {\r\n        logger.error('Error finding conversations by calendar ID:', error);\r\n        return { conversations: [], totalCount: 0, hasMore: false };\r\n      }\r\n\r\n      const conversations = data ? data.map(item => transformSupabaseConversation(item)) : [];\r\n      const hasMore = offset + conversations.length < totalCount;\r\n\r\n      return { conversations, totalCount, hasMore };\r\n    } catch (error) {\r\n      logger.error('Error finding conversations by calendar ID:', error);\r\n      return { conversations: [], totalCount: 0, hasMore: false };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find all conversations for a specific trade\r\n   * Ordered by most recently updated first\r\n   * @param tradeId - The trade ID to filter by\r\n   * @param options - Optional pagination options (limit, offset)\r\n   */\r\n  async findByTradeId(\r\n    tradeId: string,\r\n    options?: ConversationPaginationOptions\r\n  ): Promise<PaginatedConversations> {\r\n    const DEFAULT_LIMIT = 15;\r\n    const limit = options?.limit ?? DEFAULT_LIMIT;\r\n    const offset = options?.offset ?? 0;\r\n\r\n    try {\r\n      // Get total count first\r\n      const { count, error: countError } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('trade_id', tradeId);\r\n\r\n      if (countError) {\r\n        logger.error('Error counting conversations by trade ID:', countError);\r\n        return { conversations: [], totalCount: 0, hasMore: false };\r\n      }\r\n\r\n      const totalCount = count ?? 0;\r\n\r\n      // Get paginated data\r\n      const { data, error } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*')\r\n        .eq('trade_id', tradeId)\r\n        .order('updated_at', { ascending: false })\r\n        .range(offset, offset + limit - 1);\r\n\r\n      if (error) {\r\n        logger.error('Error finding conversations by trade ID:', error);\r\n        return { conversations: [], totalCount: 0, hasMore: false };\r\n      }\r\n\r\n      const conversations = data ? data.map(item => transformSupabaseConversation(item)) : [];\r\n      const hasMore = offset + conversations.length < totalCount;\r\n\r\n      return { conversations, totalCount, hasMore };\r\n    } catch (error) {\r\n      logger.error('Error finding conversations by trade ID:', error);\r\n      return { conversations: [], totalCount: 0, hasMore: false };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find all conversations for a specific user\r\n   */\r\n  async findByUserId(userId: string): Promise<AIConversation[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .order('updated_at', { ascending: false });\r\n\r\n      if (error) {\r\n        logger.error('Error finding conversations by user ID:', error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map(item => transformSupabaseConversation(item)) : [];\r\n    } catch (error) {\r\n      logger.error('Error finding conversations by user ID:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find all conversations (admin use only - respects RLS)\r\n   */\r\n  async findAll(): Promise<AIConversation[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('ai_conversations')\r\n        .select('*')\r\n        .order('updated_at', { ascending: false });\r\n\r\n      if (error) {\r\n        logger.error('Error finding all conversations:', error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map(item => transformSupabaseConversation(item)) : [];\r\n    } catch (error) {\r\n      logger.error('Error finding all conversations:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // =====================================================\r\n  // SUPABASE OPERATIONS\r\n  // =====================================================\r\n\r\n  /**\r\n   * Create a new conversation in Supabase\r\n   */\r\n  protected async createInSupabase(entity: Omit<AIConversation, 'id' | 'created_at' | 'updated_at'>): Promise<AIConversation> {\r\n    const now = new Date();\r\n\r\n    // Generate title if not provided\r\n    const title = entity.title || generateConversationTitle(entity.messages);\r\n\r\n    const conversationData: Record<string, any> = {\r\n      calendar_id: entity.calendar_id,\r\n      user_id: entity.user_id,\r\n      title: title.substring(0, 100), // Enforce max length\r\n      messages: serializeMessages(entity.messages),\r\n      message_count: entity.message_count,\r\n      created_at: now,\r\n      updated_at: now\r\n    };\r\n\r\n    // Only include trade_id if it's set (not null/undefined)\r\n    if (entity.trade_id) {\r\n      conversationData.trade_id = entity.trade_id;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('ai_conversations')\r\n      .insert(conversationData)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return transformSupabaseConversation(data);\r\n  }\r\n\r\n  /**\r\n   * Update an existing conversation in Supabase\r\n   */\r\n  protected async updateInSupabase(id: string, updates: Partial<AIConversation>): Promise<AIConversation> {\r\n    const updateData: any = {\r\n      updated_at: new Date()\r\n    };\r\n\r\n    // Only include fields that are being updated\r\n    if (updates.title !== undefined) {\r\n      updateData.title = updates.title.substring(0, 100);\r\n    }\r\n    if (updates.messages !== undefined) {\r\n      updateData.messages = serializeMessages(updates.messages);\r\n      updateData.message_count = updates.messages.length;\r\n    }\r\n    if (updates.message_count !== undefined) {\r\n      updateData.message_count = updates.message_count;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('ai_conversations')\r\n      .update(updateData)\r\n      .eq('id', id)\r\n      .select();\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    // Check if any rows were returned\r\n    if (!data || data.length === 0) {\r\n      throw new Error(`Conversation not found: ${id}`);\r\n    }\r\n\r\n    // Return the first (and should be only) row\r\n    return transformSupabaseConversation(data[0]);\r\n\r\n    return transformSupabaseConversation(data);\r\n  }\r\n\r\n  /**\r\n   * Delete a conversation from Supabase\r\n   */\r\n  protected async deleteInSupabase(id: string): Promise<boolean> {\r\n    const { error } = await supabase\r\n      .from('ai_conversations')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  // =====================================================\r\n  // CUSTOM OPERATIONS\r\n  // =====================================================\r\n\r\n  /**\r\n   * Save or update a conversation\r\n   * If conversation has an ID, update it; otherwise create new\r\n   * If update fails (conversation not found), create a new one\r\n   * @param tradeId - Optional: If provided, creates a trade-specific conversation\r\n   */\r\n  async saveConversation(\r\n    conversationId: string | null,\r\n    calendarId: string,\r\n    userId: string,\r\n    messages: ChatMessage[],\r\n    title?: string,\r\n    tradeId?: string | null\r\n  ): Promise<RepositoryResult<AIConversation>> {\r\n    try {\r\n      const conversationTitle = title || generateConversationTitle(messages);\r\n\r\n      if (conversationId) {\r\n        // Try to update existing conversation\r\n        const updateResult = await this.update(conversationId, {\r\n          messages,\r\n          message_count: messages.length,\r\n          title: conversationTitle\r\n        } as Partial<AIConversation>);\r\n\r\n        // If update failed because conversation doesn't exist, create new one\r\n        if (!updateResult.success && updateResult.error?.message?.includes('not found')) {\r\n          logger.warn(`Conversation ${conversationId} not found, creating new conversation`);\r\n          return await this.create({\r\n            calendar_id: calendarId,\r\n            user_id: userId,\r\n            trade_id: tradeId || null,\r\n            title: conversationTitle,\r\n            messages,\r\n            message_count: messages.length\r\n          } as Omit<AIConversation, 'id' | 'created_at' | 'updated_at'>);\r\n        }\r\n\r\n        return updateResult;\r\n      } else {\r\n        // Create new conversation\r\n        return await this.create({\r\n          calendar_id: calendarId,\r\n          user_id: userId,\r\n          trade_id: tradeId || null,\r\n          title: conversationTitle,\r\n          messages,\r\n          message_count: messages.length\r\n        } as Omit<AIConversation, 'id' | 'created_at' | 'updated_at'>);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error saving conversation:', error);\r\n      const { parseSupabaseError } = await import('../../../utils/supabaseErrorHandler');\r\n      return {\r\n        success: false,\r\n        error: parseSupabaseError(error, 'Saving conversation'),\r\n        timestamp: new Date(),\r\n        operation: conversationId ? 'update' : 'create'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete all conversations for a calendar\r\n   * Note: This is handled automatically by CASCADE DELETE in the database\r\n   * This method is provided for explicit deletion if needed\r\n   */\r\n  async deleteByCalendarId(calendarId: string): Promise<RepositoryResult<boolean>> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('ai_conversations')\r\n        .delete()\r\n        .eq('calendar_id', calendarId);\r\n\r\n      if (error) {\r\n        throw error;\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        data: true,\r\n        timestamp: new Date(),\r\n        operation: 'deleteByCalendarId'\r\n      };\r\n    } catch (error) {\r\n      logger.error('Error deleting conversations by calendar ID:', error);\r\n      const { parseSupabaseError } = await import('../../../utils/supabaseErrorHandler');\r\n      return {\r\n        success: false,\r\n        error: parseSupabaseError(error, 'Deleting conversations by calendar ID'),\r\n        timestamp: new Date(),\r\n        operation: 'deleteByCalendarId'\r\n      };\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * useAIChat Hook\r\n * Reusable hook for AI chat functionality\r\n * Extracts core AI chat logic for use across different UI components\r\n */\r\n\r\nimport { useState, useRef, useCallback, useEffect } from 'react';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport {\r\n  ChatMessage as ChatMessageType,\r\n  ChatError,\r\n  AIConversation,\r\n  AttachedImage\r\n} from '../types/aiChat';\r\nimport { Calendar } from '../types/calendar';\r\nimport { Trade } from '../types/trade';\r\nimport { supabaseAIChatService } from '../services/supabaseAIChatService';\r\nimport {\r\n  ConversationRepository,\r\n  ConversationPaginationOptions\r\n} from '../services/repository/repositories/ConversationRepository';\r\nimport { logger } from '../utils/logger';\r\nimport { hasApiKey } from '../services/apiKeyStorage';\r\n\r\nconst CONVERSATIONS_PAGE_SIZE = 15;\r\n\r\nexport interface UseAIChatOptions {\r\n  userId: string | undefined;\r\n  calendar?: Calendar;\r\n  trade?: Trade;\r\n  messageLimit?: number;\r\n  autoSaveConversation?: boolean;\r\n}\r\n\r\nexport interface UseAIChatReturn {\r\n  // State\r\n  messages: ChatMessageType[];\r\n  isLoading: boolean;\r\n  isTyping: boolean;\r\n  toolExecutionStatus: string;\r\n  currentConversationId: string | null;\r\n  conversations: AIConversation[];\r\n  loadingConversations: boolean;\r\n  loadingMoreConversations: boolean;\r\n  hasMoreConversations: boolean;\r\n  totalConversationsCount: number;\r\n  isAtMessageLimit: boolean;\r\n  editingMessageId: string | null;\r\n\r\n  // Actions\r\n  sendMessage: (messageText: string, images?: AttachedImage[]) => Promise<void>;\r\n  cancelRequest: () => void;\r\n  editMessage: (messageId: string) => string | null;\r\n  setInputForEdit: (messageId: string) => { content: string; images?: AttachedImage[] } | null;\r\n  clearEditingState: () => void;\r\n\r\n  // Conversation management\r\n  loadConversations: () => Promise<void>;\r\n  loadMoreConversations: () => Promise<void>;\r\n  selectConversation: (conversation: AIConversation) => void;\r\n  deleteConversation: (conversationId: string) => Promise<boolean>;\r\n  startNewChat: () => Promise<void>;\r\n\r\n  // Message management\r\n  setMessages: React.Dispatch<React.SetStateAction<ChatMessageType[]>>;\r\n\r\n  // Utilities\r\n  getWelcomeMessage: () => ChatMessageType;\r\n  parseQuotaError: (errorMessage: string) => { isQuotaError: boolean; userMessage: string; retryDelay?: string };\r\n}\r\n\r\nconst MESSAGE_LIMIT_DEFAULT = 50;\r\n\r\nexport function useAIChat({\r\n  userId,\r\n  calendar,\r\n  trade,\r\n  messageLimit = MESSAGE_LIMIT_DEFAULT,\r\n  autoSaveConversation = true\r\n}: UseAIChatOptions): UseAIChatReturn {\r\n  // State\r\n  const [messages, setMessages] = useState<ChatMessageType[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const [toolExecutionStatus, setToolExecutionStatus] = useState<string>('');\r\n  const [currentConversationId, setCurrentConversationId] = useState<string | null>(null);\r\n  const [conversations, setConversations] = useState<AIConversation[]>([]);\r\n  const [loadingConversations, setLoadingConversations] = useState(false);\r\n  const [loadingMoreConversations, setLoadingMoreConversations] = useState(false);\r\n  const [hasMoreConversations, setHasMoreConversations] = useState(false);\r\n  const [totalConversationsCount, setTotalConversationsCount] = useState(0);\r\n  const [isAtMessageLimit, setIsAtMessageLimit] = useState(false);\r\n  const [editingMessageId, setEditingMessageId] = useState<string | null>(null);\r\n\r\n  // Refs\r\n  const conversationRepo = useRef(new ConversationRepository()).current;\r\n  const abortControllerRef = useRef<AbortController | null>(null);\r\n  const cancelRequestedRef = useRef(false);\r\n  const activeRequestRef = useRef<{ userId: string; aiId: string } | null>(null);\r\n  const messageUpdateTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const pendingTextRef = useRef<string>('');\r\n\r\n  // Check message limit whenever messages change\r\n  useEffect(() => {\r\n    setIsAtMessageLimit(messages.length >= messageLimit);\r\n  }, [messages.length, messageLimit]);\r\n\r\n  /**\r\n   * Parse quota/API key errors from Gemini API and return user-friendly message\r\n   */\r\n  const parseQuotaError = useCallback((errorMessage: string): { isQuotaError: boolean; userMessage: string; retryDelay?: string } => {\r\n    let errorCode = '';\r\n    let errorReason = '';\r\n\r\n    try {\r\n      const jsonMatch = errorMessage.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        const errorJson = JSON.parse(jsonMatch[0]);\r\n        if (errorJson.error) {\r\n          errorCode = String(errorJson.error.code || '');\r\n          errorReason = errorJson.error.details?.[0]?.reason || '';\r\n        }\r\n      }\r\n    } catch {\r\n      // If JSON parsing fails, use the original message\r\n    }\r\n\r\n    const isApiKeyError = errorMessage.toLowerCase().includes('api key expired') ||\r\n                          errorMessage.toLowerCase().includes('api key invalid') ||\r\n                          errorMessage.toLowerCase().includes('api_key_invalid') ||\r\n                          errorReason === 'API_KEY_INVALID' ||\r\n                          errorCode === '400';\r\n\r\n    const isQuotaError = errorMessage.toLowerCase().includes('quota') ||\r\n                         errorMessage.includes('429') ||\r\n                         errorMessage.toUpperCase().includes('RESOURCE_EXHAUSTED') ||\r\n                         errorMessage.toLowerCase().includes('rate limit');\r\n\r\n    if (!isQuotaError && !isApiKeyError) {\r\n      return { isQuotaError: false, userMessage: errorMessage };\r\n    }\r\n\r\n    const retryMatch = errorMessage.match(/retry in (\\d+\\.?\\d*)\\s*s/i) ||\r\n                       errorMessage.match(/retryDelay[\"\\s:]+(\\d+)s/i);\r\n    const retryDelay = retryMatch ? retryMatch[1] : undefined;\r\n\r\n    const userHasApiKey = hasApiKey();\r\n\r\n    let userMessage = '';\r\n\r\n    if (isApiKeyError) {\r\n      userMessage = ' **API Key Error**\\n\\n';\r\n\r\n      if (userHasApiKey) {\r\n        userMessage += 'Your Gemini API key has expired or is invalid.\\n\\n';\r\n        userMessage += '**What you can do:**\\n';\r\n        userMessage += ' Go to [Google AI Studio](https://aistudio.google.com/app/apikey)\\n';\r\n        userMessage += ' Generate a new API key\\n';\r\n        userMessage += ' Click the  Settings button above to update your key\\n';\r\n      } else {\r\n        userMessage += 'The shared API key has expired.\\n\\n';\r\n        userMessage += '**Solution: Use Your Own API Key**\\n';\r\n        userMessage += ' Click the  Settings button above\\n';\r\n        userMessage += ' Add your free Gemini API key from [Google AI Studio](https://aistudio.google.com/app/apikey)\\n';\r\n        userMessage += ' Get unlimited usage with your own quota\\n';\r\n      }\r\n    } else {\r\n      userMessage = ' **API Quota Exceeded**\\n\\n';\r\n\r\n      if (userHasApiKey) {\r\n        userMessage += 'Your Gemini API key has reached its quota limit.\\n\\n';\r\n        userMessage += '**What you can do:**\\n';\r\n        userMessage += ' Wait for your quota to reset (usually 24 hours)\\n';\r\n        userMessage += ' Check your usage at [Google AI Studio](https://aistudio.google.com/app/apikey)\\n';\r\n        userMessage += ' Upgrade to a paid plan for higher limits\\n';\r\n        if (retryDelay) {\r\n          const seconds = Math.ceil(parseFloat(retryDelay));\r\n          userMessage += `\\n*You can retry in ${seconds} seconds*`;\r\n        }\r\n      } else {\r\n        userMessage += 'The shared API key has reached its quota limit.\\n\\n';\r\n        userMessage += '**Solution: Use Your Own API Key**\\n';\r\n        userMessage += ' Click the  Settings button above\\n';\r\n        userMessage += ' Add your free Gemini API key from [Google AI Studio](https://aistudio.google.com/app/apikey)\\n';\r\n        userMessage += ' Get unlimited usage with your own quota\\n';\r\n        if (retryDelay) {\r\n          const seconds = Math.ceil(parseFloat(retryDelay));\r\n          userMessage += `\\n*Or wait ${seconds} seconds to retry with the shared key*`;\r\n        }\r\n      }\r\n    }\r\n\r\n    return { isQuotaError: true, userMessage, retryDelay };\r\n  }, []);\r\n\r\n  /**\r\n   * Load conversations - either trade-specific or calendar-level\r\n   * If trade is provided: loads trade-specific conversations\r\n   * If only calendar: loads calendar-level conversations (without trade_id)\r\n   * Resets pagination and loads first page\r\n   */\r\n  const loadConversations = useCallback(async () => {\r\n    // Trade-specific: load conversations for this trade\r\n    if (trade?.id) {\r\n      setLoadingConversations(true);\r\n      try {\r\n        const result = await conversationRepo.findByTradeId(trade.id, {\r\n          limit: CONVERSATIONS_PAGE_SIZE,\r\n          offset: 0\r\n        });\r\n        setConversations(result.conversations);\r\n        setHasMoreConversations(result.hasMore);\r\n        setTotalConversationsCount(result.totalCount);\r\n      } catch (error) {\r\n        logger.error('Error loading trade conversations:', error);\r\n      } finally {\r\n        setLoadingConversations(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Calendar-level: load conversations without trade_id\r\n    if (!calendar?.id) return;\r\n\r\n    setLoadingConversations(true);\r\n    try {\r\n      const result = await conversationRepo.findByCalendarId(calendar.id, {\r\n        limit: CONVERSATIONS_PAGE_SIZE,\r\n        offset: 0\r\n      });\r\n      setConversations(result.conversations);\r\n      setHasMoreConversations(result.hasMore);\r\n      setTotalConversationsCount(result.totalCount);\r\n    } catch (error) {\r\n      logger.error('Error loading conversations:', error);\r\n    } finally {\r\n      setLoadingConversations(false);\r\n    }\r\n  }, [calendar?.id, trade?.id, conversationRepo]);\r\n\r\n  /**\r\n   * Load more conversations (pagination)\r\n   * Appends to existing conversations list\r\n   */\r\n  const loadMoreConversations = useCallback(async () => {\r\n    if (loadingMoreConversations || !hasMoreConversations) return;\r\n\r\n    const currentOffset = conversations.length;\r\n\r\n    // Trade-specific\r\n    if (trade?.id) {\r\n      setLoadingMoreConversations(true);\r\n      try {\r\n        const result = await conversationRepo.findByTradeId(trade.id, {\r\n          limit: CONVERSATIONS_PAGE_SIZE,\r\n          offset: currentOffset\r\n        });\r\n        setConversations(prev => [...prev, ...result.conversations]);\r\n        setHasMoreConversations(result.hasMore);\r\n      } catch (error) {\r\n        logger.error('Error loading more trade conversations:', error);\r\n      } finally {\r\n        setLoadingMoreConversations(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Calendar-level\r\n    if (!calendar?.id) return;\r\n\r\n    setLoadingMoreConversations(true);\r\n    try {\r\n      const result = await conversationRepo.findByCalendarId(calendar.id, {\r\n        limit: CONVERSATIONS_PAGE_SIZE,\r\n        offset: currentOffset\r\n      });\r\n      setConversations(prev => [...prev, ...result.conversations]);\r\n      setHasMoreConversations(result.hasMore);\r\n    } catch (error) {\r\n      logger.error('Error loading more conversations:', error);\r\n    } finally {\r\n      setLoadingMoreConversations(false);\r\n    }\r\n  }, [\r\n    calendar?.id,\r\n    trade?.id,\r\n    conversations.length,\r\n    loadingMoreConversations,\r\n    hasMoreConversations,\r\n    conversationRepo\r\n  ]);\r\n\r\n  /**\r\n   * Save current conversation\r\n   * If trade is provided, saves as trade-specific conversation\r\n   * Otherwise saves as calendar-level conversation\r\n   */\r\n  const saveCurrentConversation = useCallback(async (updatedMessages: ChatMessageType[]) => {\r\n    if (!userId || !calendar?.id || updatedMessages.length === 0 || !autoSaveConversation) return;\r\n\r\n    try {\r\n      const result = await conversationRepo.saveConversation(\r\n        currentConversationId,\r\n        calendar.id,\r\n        userId,\r\n        updatedMessages,\r\n        undefined, // title - auto-generated\r\n        trade?.id || null // tradeId - null for calendar-level, set for trade-specific\r\n      );\r\n\r\n      if (result.success && result.data) {\r\n        setCurrentConversationId(result.data.id);\r\n        logger.log('Conversation saved successfully:', result.data.id, trade?.id ? '(trade-specific)' : '(calendar-level)');\r\n        await loadConversations();\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error saving conversation:', error);\r\n    }\r\n  }, [userId, calendar?.id, trade?.id, currentConversationId, autoSaveConversation, conversationRepo, loadConversations]);\r\n\r\n  /**\r\n   * Start a new chat\r\n   */\r\n  const startNewChat = useCallback(async () => {\r\n    if (messages.length > 0) {\r\n      await saveCurrentConversation(messages);\r\n    }\r\n\r\n    setMessages([]);\r\n    setCurrentConversationId(null);\r\n    setIsAtMessageLimit(false);\r\n    setEditingMessageId(null);\r\n    logger.log('Started new conversation');\r\n  }, [messages, saveCurrentConversation]);\r\n\r\n  /**\r\n   * Select a conversation from history\r\n   */\r\n  const selectConversation = useCallback((conversation: AIConversation) => {\r\n    setMessages(conversation.messages as ChatMessageType[]);\r\n    setCurrentConversationId(conversation.id);\r\n    setIsAtMessageLimit(conversation.message_count >= messageLimit);\r\n    setEditingMessageId(null);\r\n    logger.log('Loaded conversation:', conversation.id);\r\n  }, [messageLimit]);\r\n\r\n  /**\r\n   * Delete a conversation\r\n   */\r\n  const deleteConversation = useCallback(async (conversationId: string): Promise<boolean> => {\r\n    try {\r\n      const result = await conversationRepo.delete(conversationId);\r\n      if (result.success) {\r\n        logger.log('Conversation deleted:', conversationId);\r\n        if (conversationId === currentConversationId) {\r\n          await startNewChat();\r\n        }\r\n        setConversations(prev => prev.filter(c => c.id !== conversationId));\r\n        return true;\r\n      }\r\n      return false;\r\n    } catch (error) {\r\n      logger.error('Error deleting conversation:', error);\r\n      return false;\r\n    }\r\n  }, [conversationRepo, currentConversationId, startNewChat]);\r\n\r\n  /**\r\n   * Cancel the current request\r\n   */\r\n  const cancelRequest = useCallback(() => {\r\n    const active = activeRequestRef.current;\r\n\r\n    if (!abortControllerRef.current && !active) {\r\n      return;\r\n    }\r\n\r\n    cancelRequestedRef.current = true;\r\n\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort();\r\n      abortControllerRef.current = null;\r\n    }\r\n\r\n    if (active) {\r\n      setMessages(prev =>\r\n        prev.filter(msg => msg.id !== active.userId && msg.id !== active.aiId)\r\n      );\r\n      activeRequestRef.current = null;\r\n    }\r\n\r\n    setIsLoading(false);\r\n    setIsTyping(false);\r\n    setToolExecutionStatus('');\r\n  }, []);\r\n\r\n  /**\r\n   * Send a message to the AI\r\n   */\r\n  const sendMessage = useCallback(async (messageText: string, images?: AttachedImage[]) => {\r\n    const trimmedMessage = messageText.trim();\r\n    if ((!trimmedMessage && (!images || images.length === 0)) || isLoading || !userId) return;\r\n\r\n    cancelRequestedRef.current = false;\r\n\r\n    let baseHistory: ChatMessageType[];\r\n    let userMessage: ChatMessageType;\r\n\r\n    // Handle edit mode\r\n    if (editingMessageId) {\r\n      const messageIndex = messages.findIndex(\r\n        msg => msg.id === editingMessageId && msg.role === 'user'\r\n      );\r\n\r\n      if (messageIndex === -1) {\r\n        baseHistory = messages;\r\n        userMessage = {\r\n          id: uuidv4(),\r\n          role: 'user',\r\n          content: trimmedMessage,\r\n          images: images,\r\n          timestamp: new Date(),\r\n          status: 'sent'\r\n        };\r\n        setMessages(prev => [...prev, userMessage]);\r\n      } else {\r\n        baseHistory = messages.slice(0, messageIndex);\r\n        const originalMessage = messages[messageIndex];\r\n        userMessage = {\r\n          ...originalMessage,\r\n          content: trimmedMessage,\r\n          images: images,\r\n          timestamp: new Date(),\r\n          status: 'sent'\r\n        };\r\n        const updatedMessages = [...baseHistory, userMessage];\r\n        setMessages(updatedMessages);\r\n      }\r\n      setEditingMessageId(null);\r\n    } else {\r\n      baseHistory = messages;\r\n      userMessage = {\r\n        id: uuidv4(),\r\n        role: 'user',\r\n        content: trimmedMessage,\r\n        images: images,\r\n        timestamp: new Date(),\r\n        status: 'sent'\r\n      };\r\n      setMessages(prev => [...prev, userMessage]);\r\n    }\r\n\r\n    setIsLoading(true);\r\n    setIsTyping(true);\r\n    setToolExecutionStatus('');\r\n\r\n    const aiMessageId = uuidv4();\r\n    let aiMessageAdded = false;\r\n\r\n    activeRequestRef.current = { userId: userMessage.id, aiId: aiMessageId };\r\n\r\n    try {\r\n      if (abortControllerRef.current) {\r\n        abortControllerRef.current.abort();\r\n      }\r\n\r\n      const abortController = new AbortController();\r\n      abortControllerRef.current = abortController;\r\n\r\n      let accumulatedText = '';\r\n      let messageHtml = '';\r\n      let citations: any[] | undefined;\r\n      let embeddedTrades: any | undefined;\r\n      let embeddedEvents: any | undefined;\r\n      let embeddedNotes: any | undefined;\r\n      let toolCallsInProgress: string[] = [];\r\n\r\n      for await (const event of supabaseAIChatService.sendMessageStreaming(\r\n        trimmedMessage,\r\n        userId,\r\n        calendar,\r\n        baseHistory,\r\n        abortController.signal,\r\n        trade?.id,\r\n        images\r\n      )) {\r\n        switch (event.type) {\r\n          case 'text_chunk':\r\n            accumulatedText += event.data.text;\r\n            pendingTextRef.current = accumulatedText;\r\n\r\n            // Clear existing timeout\r\n            if (messageUpdateTimeoutRef.current) {\r\n              clearTimeout(messageUpdateTimeoutRef.current);\r\n            }\r\n\r\n            // Debounce: batch updates every 100ms\r\n            messageUpdateTimeoutRef.current = setTimeout(() => {\r\n              if (!aiMessageAdded) {\r\n                const newMessage: ChatMessageType = {\r\n                  id: aiMessageId,\r\n                  role: 'assistant',\r\n                  content: pendingTextRef.current,\r\n                  timestamp: new Date(),\r\n                  status: 'receiving'\r\n                };\r\n                setMessages(prev => [...prev, newMessage]);\r\n                aiMessageAdded = true;\r\n              } else {\r\n                setMessages(prev => prev.map(msg =>\r\n                  msg.id === aiMessageId\r\n                    ? { ...msg, content: pendingTextRef.current, status: 'receiving' as const }\r\n                    : msg\r\n                ));\r\n              }\r\n            }, 100);\r\n            break;\r\n\r\n          case 'tool_call':\r\n            logger.log(`Tool called: ${event.data.name}`);\r\n            toolCallsInProgress.push(event.data.name);\r\n            setToolExecutionStatus(toolCallsInProgress.join(', '));\r\n            break;\r\n\r\n          case 'tool_result':\r\n            logger.log(`Tool result: ${event.data.name}`);\r\n            toolCallsInProgress = toolCallsInProgress.filter(t => t !== event.data.name);\r\n            if (toolCallsInProgress.length > 0) {\r\n              setToolExecutionStatus(toolCallsInProgress.join(', '));\r\n            } else {\r\n              setToolExecutionStatus('');\r\n            }\r\n            break;\r\n\r\n          case 'citation':\r\n            citations = event.data.citations;\r\n            break;\r\n\r\n          case 'embedded_data':\r\n            embeddedTrades = event.data.embeddedTrades;\r\n            embeddedEvents = event.data.embeddedEvents;\r\n            embeddedNotes = event.data.embeddedNotes;\r\n            break;\r\n\r\n          case 'done':\r\n            messageHtml = event.data.messageHtml || '';\r\n            logger.log('AI response streaming complete');\r\n            break;\r\n\r\n          case 'error':\r\n            throw new Error(event.data.error || 'Streaming error');\r\n        }\r\n      }\r\n\r\n      // Clear any pending debounced update\r\n      if (messageUpdateTimeoutRef.current) {\r\n        clearTimeout(messageUpdateTimeoutRef.current);\r\n        messageUpdateTimeoutRef.current = null;\r\n      }\r\n\r\n      if (cancelRequestedRef.current || (!aiMessageAdded && !accumulatedText)) {\r\n        return;\r\n      }\r\n\r\n      const finalMessage: ChatMessageType = {\r\n        id: aiMessageId,\r\n        role: 'assistant',\r\n        content: accumulatedText,\r\n        messageHtml: messageHtml,\r\n        citations,\r\n        embeddedTrades,\r\n        embeddedEvents,\r\n        embeddedNotes,\r\n        timestamp: new Date(),\r\n        status: 'received'\r\n      };\r\n\r\n      if (aiMessageAdded) {\r\n        setMessages(prev => prev.map(msg =>\r\n          msg.id === aiMessageId ? finalMessage : msg\r\n        ));\r\n      } else {\r\n        setMessages(prev => [...prev, finalMessage]);\r\n      }\r\n\r\n      const conversationMessages = [...baseHistory, userMessage, finalMessage];\r\n      await saveCurrentConversation(conversationMessages);\r\n\r\n    } catch (error) {\r\n      const isAbortError =\r\n        typeof error === 'object' &&\r\n        error !== null &&\r\n        'name' in error &&\r\n        (error as any).name === 'AbortError';\r\n\r\n      if (isAbortError || cancelRequestedRef.current) {\r\n        logger.log('AI chat request cancelled by user');\r\n        return;\r\n      }\r\n\r\n      logger.error('Error sending message to Supabase AI agent:', error);\r\n\r\n      const errorDetails = error instanceof Error ? error.message : 'Unknown error';\r\n      const quotaErrorInfo = parseQuotaError(errorDetails);\r\n\r\n      const chatError: ChatError = {\r\n        type: quotaErrorInfo.isQuotaError ? 'rate_limit' : 'network_error',\r\n        message: quotaErrorInfo.isQuotaError ? 'API Quota Exceeded' : 'Failed to send message',\r\n        details: errorDetails,\r\n        retryable: true\r\n      };\r\n\r\n      const errorMessage: ChatMessageType = {\r\n        id: aiMessageId,\r\n        role: 'assistant',\r\n        content: quotaErrorInfo.isQuotaError\r\n          ? quotaErrorInfo.userMessage\r\n          : 'Sorry, I encountered an error processing your message. Please try again.',\r\n        timestamp: new Date(),\r\n        status: 'error',\r\n        error: chatError.message\r\n      };\r\n\r\n      if (aiMessageAdded) {\r\n        setMessages(prev => prev.map(msg =>\r\n          msg.id === aiMessageId ? errorMessage : msg\r\n        ));\r\n      } else {\r\n        setMessages(prev => [...prev, errorMessage]);\r\n      }\r\n    } finally {\r\n      // Clear any pending debounced update\r\n      if (messageUpdateTimeoutRef.current) {\r\n        clearTimeout(messageUpdateTimeoutRef.current);\r\n        messageUpdateTimeoutRef.current = null;\r\n      }\r\n      abortControllerRef.current = null;\r\n      activeRequestRef.current = null;\r\n      cancelRequestedRef.current = false;\r\n      setIsLoading(false);\r\n      setIsTyping(false);\r\n      setToolExecutionStatus('');\r\n    }\r\n  }, [userId, calendar, trade, messages, editingMessageId, isLoading, parseQuotaError, saveCurrentConversation]);\r\n\r\n  /**\r\n   * Set up message for editing and return its content and images\r\n   */\r\n  const setInputForEdit = useCallback((messageId: string): { content: string; images?: AttachedImage[] } | null => {\r\n    const messageToEdit = messages.find(msg => msg.id === messageId);\r\n    if (!messageToEdit || messageToEdit.role !== 'user') return null;\r\n\r\n    setEditingMessageId(messageId);\r\n    return {\r\n      content: messageToEdit.content,\r\n      images: messageToEdit.images\r\n    };\r\n  }, [messages]);\r\n\r\n  /**\r\n   * Legacy edit message function (returns content for input field)\r\n   */\r\n  const editMessage = useCallback((messageId: string): string | null => {\r\n    const result = setInputForEdit(messageId);\r\n    return result ? result.content : null;\r\n  }, [setInputForEdit]);\r\n\r\n  /**\r\n   * Clear editing state\r\n   */\r\n  const clearEditingState = useCallback(() => {\r\n    setEditingMessageId(null);\r\n  }, []);\r\n\r\n  /**\r\n   * Get welcome message\r\n   */\r\n  const getWelcomeMessage = useCallback((): ChatMessageType => {\r\n    // Trade-specific welcome message\r\n    if (trade) {\r\n      const tradeName = trade.name || 'this trade';\r\n      const tradeType = trade.trade_type;\r\n      const isWin = tradeType === 'win';\r\n      const isLoss = tradeType === 'loss';\r\n\r\n      const resultEmoji = isWin ? '' : isLoss ? '' : '';\r\n      const resultText = isWin ? 'winning' : isLoss ? 'losing' : '';\r\n\r\n      return {\r\n        id: 'welcome',\r\n        role: 'assistant',\r\n        content: `${resultEmoji} I'm ready to analyze your ${resultText} trade on **${tradeName}**.\r\n\r\nI can help you understand what worked${isLoss ? \" or didn't work\" : ''}, identify patterns, and provide insights to improve your trading.\r\n\r\nWhat would you like to know about this trade?`,\r\n        timestamp: new Date(),\r\n        status: 'received'\r\n      };\r\n    }\r\n\r\n    // Calendar-specific welcome message\r\n    const calendarInfo = calendar\r\n      ? `You're working with the \"${calendar.name}\" calendar. `\r\n      : 'You can ask me about your trading performance across all your calendars. ';\r\n\r\n    const historyNote = !calendar\r\n      ? '\\n\\n Note: Conversation history is only available when working with a specific calendar.'\r\n      : '';\r\n\r\n    return {\r\n      id: 'welcome',\r\n      role: 'assistant',\r\n      content: ` Hello! I'm your AI trading analyst. ${calendarInfo}I can help you analyze your trading performance, identify patterns, and provide insights to improve your trading.\r\n\r\n I'll analyze your trading data to give you focused and accurate insights!${historyNote}\r\n\r\nWhat would you like to know about your trading?`,\r\n      timestamp: new Date(),\r\n      status: 'received'\r\n    };\r\n  }, [calendar, trade]);\r\n\r\n  return {\r\n    // State\r\n    messages,\r\n    isLoading,\r\n    isTyping,\r\n    toolExecutionStatus,\r\n    currentConversationId,\r\n    conversations,\r\n    loadingConversations,\r\n    loadingMoreConversations,\r\n    hasMoreConversations,\r\n    totalConversationsCount,\r\n    isAtMessageLimit,\r\n    editingMessageId,\r\n\r\n    // Actions\r\n    sendMessage,\r\n    cancelRequest,\r\n    editMessage,\r\n    setInputForEdit,\r\n    clearEditingState,\r\n\r\n    // Conversation management\r\n    loadConversations,\r\n    loadMoreConversations,\r\n    selectConversation,\r\n    deleteConversation,\r\n    startNewChat,\r\n\r\n    // Message management\r\n    setMessages,\r\n\r\n    // Utilities\r\n    getWelcomeMessage,\r\n    parseQuotaError\r\n  };\r\n}\r\n\r\nexport default useAIChat;\r\n","/**\r\n * NoteListItem Component\r\n * Displays a note as a list item optimized for drawer views\r\n */\r\n\r\nimport React, { useState } from 'react';\r\nimport {\r\n  ListItemButton,\r\n  ListItemText,\r\n  Typography,\r\n  Box,\r\n  useTheme,\r\n  alpha,\r\n  IconButton,\r\n  Chip,\r\n  Stack,\r\n} from '@mui/material';\r\nimport {\r\n  PushPin as PinIcon,\r\n  Archive as ArchiveIcon,\r\n  Unarchive as UnarchiveIcon,\r\n  PushPinOutlined as PinOutlinedIcon,\r\n  NotificationsActive as ReminderIcon,\r\n  SmartToy as AIIcon,\r\n  LocalOffer as TagIcon,\r\n} from '@mui/icons-material';\r\nimport { convertFromRaw } from 'draft-js';\r\nimport { Note } from '../../types/note';\r\nimport { Calendar } from '../../types/calendar';\r\nimport { getTagDisplayLabel } from './NoteEditorDialog';\r\n\r\ninterface NoteListItemProps {\r\n  note: Note;\r\n  onClick: (note: Note) => void;\r\n  onPin?: (note: Note) => void;\r\n  onArchive?: (note: Note) => void;\r\n  onUnarchive?: (note: Note) => void;\r\n  calendar?: Calendar; // For showing calendar name in multi-calendar view\r\n  showCalendarBadge?: boolean;\r\n}\r\n\r\n/**\r\n * Extract plain text from Draft.js JSON content\r\n */\r\nconst extractPlainText = (content: string): string => {\r\n  if (!content) return '';\r\n\r\n  try {\r\n    // Try to parse as Draft.js JSON\r\n    const contentState = convertFromRaw(JSON.parse(content));\r\n    return contentState.getPlainText();\r\n  } catch (error) {\r\n    // Fallback to plain text if not valid JSON\r\n    return content;\r\n  }\r\n};\r\n\r\nexport const NoteListItem: React.FC<NoteListItemProps> = ({\r\n  note,\r\n  onClick,\r\n  onPin,\r\n  onArchive,\r\n  onUnarchive,\r\n  calendar,\r\n  showCalendarBadge = false,\r\n}) => {\r\n  const theme = useTheme();\r\n  const [isHovered, setIsHovered] = useState(false);\r\n\r\n  // Extract plain text from rich text content\r\n  const plainText = extractPlainText(note.content);\r\n\r\n  // Truncate content for preview\r\n  const MAX_CONTENT_LENGTH = 80;\r\n  const contentPreview = plainText.length > MAX_CONTENT_LENGTH\r\n    ? plainText.substring(0, MAX_CONTENT_LENGTH) + '...'\r\n    : plainText;\r\n\r\n  const handlePinClick = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (onPin) onPin(note);\r\n  };\r\n\r\n  const handleArchiveClick = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    if (note.is_archived && onUnarchive) {\r\n      onUnarchive(note);\r\n    } else if (!note.is_archived && onArchive) {\r\n      onArchive(note);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <ListItemButton\r\n      onClick={() => onClick(note)}\r\n      onMouseEnter={() => setIsHovered(true)}\r\n      onMouseLeave={() => setIsHovered(false)}\r\n      sx={{\r\n        borderRadius: 1,\r\n        mb: 0.5, \r\n        p: 1.5,\r\n        border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n        bgcolor: note.is_pinned\r\n          ? alpha(theme.palette.primary.main, 0.03)\r\n          : 'transparent',\r\n        '&:hover': {\r\n          bgcolor: note.is_pinned\r\n            ? alpha(theme.palette.primary.main, 0.08)\r\n            : alpha(theme.palette.action.hover, 0.05),\r\n          boxShadow: 1,\r\n        },\r\n        transition: 'all 0.2s ease',\r\n      }}\r\n    >\r\n      <Box sx={{ flex: 1, minWidth: 0, mr: 1 }}>\r\n        {/* Title row with pin indicator, reminder badge, AI badge, and calendar badge */}\r\n        <Stack direction=\"row\" alignItems=\"center\" spacing={0.5} sx={{ mb: 0.5 }}>\r\n          {note.is_pinned && (\r\n            <PinIcon\r\n              fontSize=\"small\"\r\n              sx={{ color: 'primary.main', fontSize: '0.9rem' }}\r\n            />\r\n          )}\r\n          {note.is_reminder_active && note.reminder_type && note.reminder_type !== 'none' && (\r\n            <ReminderIcon\r\n              fontSize=\"small\"\r\n              sx={{ color: 'info.main', fontSize: '0.9rem' }}\r\n              titleAccess={`${note.reminder_type === 'weekly' ? 'Weekly' : 'One-time'} reminder`}\r\n            />\r\n          )}\r\n          {note.by_assistant && (\r\n            <AIIcon\r\n              fontSize=\"small\"\r\n              sx={{ color: 'primary.main', fontSize: '0.9rem' }}\r\n              titleAccess=\"AI-generated note\"\r\n            />\r\n          )}\r\n          <Typography\r\n            variant=\"subtitle2\"\r\n            sx={{\r\n              fontWeight: 600,\r\n              fontSize: '0.9rem',\r\n              overflow: 'hidden',\r\n              textOverflow: 'ellipsis',\r\n              whiteSpace: 'nowrap',\r\n              flex: 1,\r\n            }}\r\n          >\r\n            {note.title}\r\n          </Typography>\r\n        </Stack>\r\n         {/* Calendar badge */}\r\n        {showCalendarBadge && calendar && (\r\n          <Chip\r\n            label={calendar.name}\r\n            size=\"small\"\r\n            sx={{\r\n              height: 18,\r\n              fontSize: '0.7rem',\r\n              bgcolor: alpha(theme.palette.secondary.main, 0.1),\r\n              color: 'secondary.main',\r\n              fontWeight: 600,\r\n              alignSelf: 'flex-start',\r\n              mb: 0.5,\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Content preview */}\r\n        {contentPreview && (\r\n          <Typography\r\n            variant=\"body2\"\r\n            color=\"text.secondary\"\r\n            sx={{\r\n              overflow: 'hidden',\r\n              display: '-webkit-box',\r\n              WebkitLineClamp: 2,\r\n              WebkitBoxOrient: 'vertical',\r\n              lineHeight: 1.4,\r\n              fontSize: '0.8rem',\r\n              mb: 0.5,\r\n            }}\r\n          >\r\n            {contentPreview}\r\n          </Typography>\r\n        )}\r\n\r\n        {/* Tags preview */}\r\n        {note.tags && note.tags.length > 0 && (\r\n          <Stack direction=\"row\" spacing={0.5} sx={{ mb: 0.5, flexWrap: 'wrap', gap: 0.25 }}>\r\n            <TagIcon sx={{ fontSize: '0.75rem', color: 'text.disabled', mt: 0.25 }} />\r\n            {note.tags.slice(0, 3).map((tag) => (\r\n              <Chip\r\n                key={tag}\r\n                label={getTagDisplayLabel(tag)}\r\n                size=\"small\"\r\n                sx={{\r\n                  height: 16,\r\n                  fontSize: '0.65rem',\r\n                  bgcolor: alpha(theme.palette.secondary.main, 0.1),\r\n                  color: 'text.secondary',\r\n                  '& .MuiChip-label': {\r\n                    px: 0.75,\r\n                  },\r\n                }}\r\n              />\r\n            ))}\r\n            {note.tags.length > 3 && (\r\n              <Typography variant=\"caption\" color=\"text.disabled\" sx={{ fontSize: '0.65rem' }}>\r\n                +{note.tags.length - 3}\r\n              </Typography>\r\n            )}\r\n            \r\n          </Stack>\r\n        )}\r\n\r\n       \r\n\r\n        {/* Last updated */}\r\n        <Typography variant=\"caption\" color=\"text.disabled\" sx={{ fontSize: '0.7rem' }}>\r\n          Last updated: {new Date(note.updated_at).toLocaleDateString('en-US', {\r\n            month: 'short',\r\n            day: 'numeric',\r\n            year: 'numeric',\r\n          })}\r\n        </Typography>\r\n      </Box>\r\n\r\n      {/* Action buttons (always rendered, visibility controlled by opacity to prevent layout shift) */}\r\n      <Stack\r\n        direction=\"row\"\r\n        spacing={0.5}\r\n        sx={{\r\n          opacity: isHovered || note.is_pinned ? 1 : 0,\r\n          transition: 'opacity 0.15s ease',\r\n        }}\r\n      >\r\n        {onPin && (\r\n          <IconButton\r\n            size=\"small\"\r\n            onClick={handlePinClick}\r\n            sx={{\r\n              p: 0.5,\r\n              color: note.is_pinned ? 'primary.main' : 'text.secondary',\r\n              '&:hover': {\r\n                bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                color: 'primary.main',\r\n              },\r\n            }}\r\n          >\r\n            {note.is_pinned ? (\r\n              <PinIcon sx={{ fontSize: '1.1rem' }} />\r\n            ) : (\r\n              <PinOutlinedIcon sx={{ fontSize: '1.1rem' }} />\r\n            )}\r\n          </IconButton>\r\n        )}\r\n\r\n        {(onArchive || onUnarchive) && (\r\n          <IconButton\r\n            size=\"small\"\r\n            onClick={handleArchiveClick}\r\n            sx={{\r\n              p: 0.5,\r\n              color: 'text.secondary',\r\n              '&:hover': {\r\n                bgcolor: alpha(theme.palette.warning.main, 0.1),\r\n                color: 'warning.main',\r\n              },\r\n            }}\r\n          >\r\n            {note.is_archived ? (\r\n              <UnarchiveIcon sx={{ fontSize: '1.1rem' }} />\r\n            ) : (\r\n              <ArchiveIcon sx={{ fontSize: '1.1rem' }} />\r\n            )}\r\n          </IconButton>\r\n        )}\r\n      </Stack>\r\n\r\n      {/* Cover image thumbnail (if exists) */}\r\n      {note.cover_image && (\r\n        <Box\r\n          sx={{\r\n            width: 80,\r\n            height: 80,\r\n            borderRadius: 1,\r\n            backgroundImage: `url(${note.cover_image})`,\r\n            backgroundSize: 'cover',\r\n            backgroundPosition: 'center',\r\n            ml: 1.5,\r\n            flexShrink: 0,\r\n            border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          }}\r\n        />\r\n      )}\r\n    </ListItemButton>\r\n  );\r\n};\r\n\r\nexport default NoteListItem;\r\n","import React, { useState, useRef, useEffect, useCallback } from 'react';\r\nimport {\r\n  Dialog,\r\n  Box,\r\n  IconButton,\r\n  useTheme\r\n} from '@mui/material';\r\nimport {\r\n  Close as CloseIcon,\r\n  ZoomIn as ZoomInIcon,\r\n  RestartAlt as RestartAltIcon,\r\n  ArrowBackIos as ArrowBackIcon,\r\n  ArrowForwardIos as ArrowForwardIcon\r\n} from '@mui/icons-material';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport { Z_INDEX } from '../styles/zIndex';\r\n\r\ninterface ImageZoomDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  imageProp: ImageZoomProp;\r\n}\r\n\r\nexport interface ImageZoomProp{\r\n  selectetdImageIndex: number;\r\n  allImages: string[];\r\n  useSolidBackground?: boolean; // Optional: use solid background for AI charts\r\n}\r\n\r\nconst ImageZoomDialog: React.FC<ImageZoomDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  imageProp, \r\n}) => {\r\n  // For backward compatibility, if imageUrl is provided but not images\r\n  const images = imageProp?.allImages || [];\r\n  const imageUrl = imageProp?.allImages[imageProp?.selectetdImageIndex || 0];\r\n   \r\n  const imageArray = images.length > 0 ? images : (imageUrl ? [imageUrl] : []);\r\n  const [imageData, setImageData] = useState<ImageZoomProp>(imageProp);\r\n if(imageData==null && imageProp){\r\n  setImageData(imageProp);\r\n }\r\n  const theme = useTheme();\r\n\r\n  // Determine if we should use solid background\r\n  // Auto-detect if the current image is from QuickChart (AI-generated chart)\r\n  const currentImageUrl = imageArray[imageData?.selectetdImageIndex || 0];\r\n  const isAIChart = currentImageUrl?.includes('quickchart.io');\r\n  const useSolidBackground = imageProp?.useSolidBackground ?? isAIChart;\r\n  const [scale, setScale] = useState(1);\r\n  const [position, setPosition] = useState({ x: 0, y: 0 });\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });\r\n  const imageRef = useRef<HTMLImageElement>(null);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n  const handleWheel = (e: React.WheelEvent) => {\r\n    e.preventDefault();\r\n    const delta = e.deltaY;\r\n    const newScale = delta > 0\r\n      ? Math.max(1, scale - 0.1)\r\n      : Math.min(3, scale + 0.1);\r\n\r\n    setScale(newScale);\r\n  };\r\n\r\n  const handleMouseDown = (e: React.MouseEvent) => {\r\n    if (scale > 1) {\r\n      e.preventDefault();\r\n      setIsDragging(true);\r\n      setDragStart({\r\n        x: e.clientX - position.x,\r\n        y: e.clientY - position.y\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleMouseMove = (e: React.MouseEvent) => {\r\n    if (!isDragging || scale <= 1) return;\r\n\r\n    e.preventDefault();\r\n    const newX = e.clientX - dragStart.x;\r\n    const newY = e.clientY - dragStart.y;\r\n\r\n    if (imageRef.current && containerRef.current) {\r\n      // We only need the image rect for calculating bounds\r\n      const imageRect = imageRef.current.getBoundingClientRect();\r\n\r\n      const maxX = (imageRect.width * (scale - 1)) / 2;\r\n      const maxY = (imageRect.height * (scale - 1)) / 2;\r\n\r\n      const boundedX = Math.min(Math.max(-maxX, newX), maxX);\r\n      const boundedY = Math.min(Math.max(-maxY, newY), maxY);\r\n\r\n      setPosition({\r\n        x: boundedX,\r\n        y: boundedY\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleMouseUp = (e: React.MouseEvent) => {\r\n    e.preventDefault();\r\n    setIsDragging(false);\r\n  };\r\n\r\n  const handleMouseLeave = (e: React.MouseEvent) => {\r\n    e.preventDefault();\r\n    setIsDragging(false);\r\n  };\r\n\r\n  const resetZoom = () => {\r\n    setScale(1);\r\n    setPosition({ x: 0, y: 0 });\r\n  };\r\n\r\n  // Navigation functions\r\n  const navigateNext = useCallback(() => {\r\n    if (imageArray.length <= 1) return;\r\n    setImageData((prev) => {\r\n      if (prev) {\r\n        return {\r\n          ...prev,\r\n          selectetdImageIndex: (prev.selectetdImageIndex + 1) % imageArray.length\r\n        };\r\n      }\r\n      return prev;\r\n    });\r\n  }, [imageArray.length]);\r\n\r\n  const navigatePrevious = useCallback(() => {\r\n    if (imageArray.length <= 1) return;\r\n    setImageData((prev) => {\r\n      if (prev) {\r\n        return {\r\n          ...prev,\r\n          selectetdImageIndex: (prev.selectetdImageIndex - 1 + imageArray.length) % imageArray.length\r\n        };\r\n      }\r\n      return prev;\r\n    });\r\n  }, [imageArray.length]);\r\n\r\n  // Reset zoom when image changes\r\n  useEffect(() => {\r\n    if (open) {\r\n      resetZoom();\r\n    }\r\n  }, [open, imageData]);\r\n\r\n  // Handle keyboard navigation\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (!open) return;\r\n\r\n      if (e.key === 'ArrowLeft') {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        navigatePrevious();\r\n      } else if (e.key === 'ArrowRight') {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        navigateNext();\r\n      } else if (e.key === 'Escape') {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        onClose();\r\n      }\r\n    };\r\n\r\n    // Use capture phase to handle events before they reach other components\r\n    window.addEventListener('keydown', handleKeyDown, true);\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown, true);\r\n    };\r\n  }, [open, imageData, imageArray.length, navigatePrevious, navigateNext, onClose]);\r\n\r\n  // Add event listeners for mouse up on document level\r\n  useEffect(() => {\r\n    const handleGlobalMouseUp = () => {\r\n      setIsDragging(false);\r\n    };\r\n\r\n    document.addEventListener('mouseup', handleGlobalMouseUp);\r\n    return () => {\r\n      document.removeEventListener('mouseup', handleGlobalMouseUp);\r\n    };\r\n  }, []);\r\n  return (\r\n    <Dialog\r\n      open={open}\r\n      onClose={onClose}\r\n      maxWidth=\"md\"\r\n      fullWidth\r\n      sx={{\r\n        zIndex: Z_INDEX.DIALOG_POPUP\r\n      }}\r\n      PaperProps={{\r\n        sx: {\r\n          boxShadow: 'none',\r\n          backgroundColor: useSolidBackground\r\n            ? theme.palette.background.paper\r\n            : 'transparent',\r\n          overflow: 'hidden',\r\n          maxWidth: '80%',\r\n          borderRadius: useSolidBackground ? 2 : 0,\r\n          '& .MuiDialogContent-root': {\r\n            ...scrollbarStyles(theme)\r\n          }\r\n        }\r\n      }}\r\n    >\r\n      {imageArray.length > 0 && (\r\n        <>\r\n          {/* Navigation buttons */}\r\n          {imageArray.length > 1 && (\r\n            <>\r\n              <Box\r\n                sx={{\r\n                  position: 'absolute',\r\n                  left: 16,\r\n                  top: '50%',\r\n                  transform: 'translateY(-50%)',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  zIndex: 1200\r\n                }}\r\n              >\r\n                <IconButton\r\n                  onClick={navigatePrevious}\r\n                  sx={{\r\n                    color: 'white',\r\n                    backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n                    '&:hover': {\r\n                      backgroundColor: 'rgba(0, 0, 0, 0.7)'\r\n                    }\r\n                  }}\r\n                >\r\n                  <ArrowBackIcon />\r\n                </IconButton>\r\n              </Box>\r\n              <Box\r\n                sx={{\r\n                  position: 'absolute',\r\n                  right: 16,\r\n                  top: '50%',\r\n                  transform: 'translateY(-50%)',\r\n                  display: 'flex',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  zIndex: 1200\r\n                }}\r\n              >\r\n                <IconButton\r\n                  onClick={navigateNext}\r\n                  sx={{\r\n                    color: 'white',\r\n                    backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n                    '&:hover': {\r\n                      backgroundColor: 'rgba(0, 0, 0, 0.7)'\r\n                    }\r\n                  }}\r\n                >\r\n                  <ArrowForwardIcon />\r\n                </IconButton>\r\n              </Box>\r\n            </>\r\n          )}\r\n\r\n          {/* Image counter */}\r\n          {imageArray.length > 1 && (\r\n            <Box\r\n              sx={{\r\n                position: 'absolute',\r\n                bottom: 16,\r\n                left: '50%',\r\n                transform: 'translateX(-50%)',\r\n                backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n                color: 'white',\r\n                borderRadius: 1,\r\n                px: 1.5,\r\n                py: 0.5,\r\n                fontSize: '0.875rem',\r\n                fontWeight: 500,\r\n                zIndex: 1200\r\n              }}\r\n            >\r\n              {imageData?.selectetdImageIndex!! + 1} / {imageArray.length}\r\n            </Box>\r\n          )}\r\n          <Box\r\n          ref={containerRef}\r\n          sx={{\r\n            position: 'relative',\r\n            width: '100%',\r\n            height: '80vh',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            overflow: 'hidden',\r\n            cursor: scale > 1 ? 'grab' : 'default',\r\n            backgroundColor: useSolidBackground\r\n              ? theme.palette.background.default\r\n              : 'transparent',\r\n            padding: useSolidBackground ? 2 : 0,\r\n            '&:active': {\r\n              cursor: scale > 1 ? 'grabbing' : 'default'\r\n            }\r\n          }}\r\n          onWheel={handleWheel}\r\n          onMouseDown={handleMouseDown}\r\n          onMouseMove={handleMouseMove}\r\n          onMouseUp={handleMouseUp}\r\n          onMouseLeave={handleMouseLeave}\r\n        >\r\n          <Box\r\n            sx={{\r\n              position: 'relative',\r\n              transform: `scale(${scale}) translate(${position.x}px, ${position.y}px)`,\r\n              transition: isDragging ? 'none' : 'transform 0.1s ease-out'\r\n            }}\r\n          >\r\n            <img\r\n              ref={imageRef}\r\n              src={imageArray[imageData?.selectetdImageIndex || 0]}\r\n              alt={`Trade ${imageData?.selectetdImageIndex!! + 1} of ${imageArray.length}`}\r\n              style={{\r\n                maxWidth: '100%',\r\n                maxHeight: '100%',\r\n                objectFit: 'contain',\r\n                userSelect: 'none',\r\n                pointerEvents: 'none'\r\n              }}\r\n            />\r\n          </Box>\r\n\r\n\r\n          {/* Controls */}\r\n          <Box\r\n            sx={{\r\n              position: 'absolute',\r\n              top: 16,\r\n              right: 16,\r\n              display: 'flex',\r\n              gap: 1,\r\n              backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n              borderRadius: 1,\r\n              p: 0.5\r\n            }}\r\n          >\r\n            <IconButton\r\n              onClick={() => setScale(Math.max(1, scale - 0.1))}\r\n              disabled={scale <= 1}\r\n              sx={{\r\n                color: 'white',\r\n                '&:hover': {\r\n                  backgroundColor: 'rgba(255, 255, 255, 0.1)'\r\n                }\r\n              }}\r\n            >\r\n              <ZoomInIcon sx={{ transform: 'rotate(45deg)' }} />\r\n            </IconButton>\r\n            <IconButton\r\n              onClick={() => setScale(Math.min(3, scale + 0.1))}\r\n              disabled={scale >= 3}\r\n              sx={{\r\n                color: 'white',\r\n                '&:hover': {\r\n                  backgroundColor: 'rgba(255, 255, 255, 0.1)'\r\n                }\r\n              }}\r\n            >\r\n              <ZoomInIcon />\r\n            </IconButton>\r\n            <IconButton\r\n              onClick={resetZoom}\r\n              disabled={scale === 1}\r\n              sx={{\r\n                color: 'white',\r\n                '&:hover': {\r\n                  backgroundColor: 'rgba(255, 255, 255, 0.1)'\r\n                }\r\n              }}\r\n            >\r\n              <RestartAltIcon />\r\n            </IconButton>\r\n            <IconButton\r\n              onClick={onClose}\r\n              sx={{\r\n                color: 'white',\r\n                '&:hover': {\r\n                  backgroundColor: 'rgba(255, 255, 255, 0.1)'\r\n                }\r\n              }}\r\n            >\r\n              <CloseIcon />\r\n            </IconButton>\r\n          </Box>\r\n        </Box>\r\n        </>\r\n      )}\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default ImageZoomDialog;\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  Box,\r\n  IconButton,\r\n  Typography,\r\n  TextField,\r\n  Button,\r\n  CircularProgress,\r\n  Card,\r\n  CardMedia,\r\n  CardActionArea,\r\n  useTheme,\r\n  Link,\r\n  Chip,\r\n  DialogTitle\r\n} from '@mui/material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport {\r\n  Close as CloseIcon,\r\n  Search as SearchIcon,\r\n  Cached as CachedIcon\r\n} from '@mui/icons-material';\r\nimport Shimmer from '../Shimmer';\r\nimport { unsplashCache, UnsplashImage } from '../../services/unsplashCache';\r\nimport { logger } from '../../utils/logger';\r\nimport { getDialogProps } from '../../utils/dialogUtils';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\n\r\n\r\n\r\nexport interface ImageAttribution {\r\n  id: string;\r\n  photographer: string;\r\n  photographerUsername: string;\r\n  photographerUrl: string;\r\n  unsplashUrl: string;\r\n  altDescription: string;\r\n}\r\n\r\ninterface ImagePickerDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onImageSelect: (imageUrl: string, attribution?: ImageAttribution) => void;\r\n  title?: string;\r\n}\r\n\r\nconst ImagePickerDialog: React.FC<ImagePickerDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  onImageSelect,\r\n  title = \"Choose a cover image\"\r\n}) => {\r\n  const theme = useTheme();\r\n  const [searchQuery, setSearchQuery] = useState('');\r\n  const [images, setImages] = useState<UnsplashImage[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [isFromCache, setIsFromCache] = useState(false);\r\n  const dialogBaseProps = getDialogProps(theme);\r\n\r\n  const UNSPLASH_ACCESS_KEY = process.env.REACT_APP_UNSPLASH_ACCESS_KEY;\r\n\r\n  const popularSearches = [\r\n    'trading charts',\r\n    'financial markets',\r\n    'business success',\r\n    'growth analytics',\r\n    'stock market',\r\n    'cryptocurrency',\r\n    'investment',\r\n    'profit growth'\r\n  ];\r\n\r\n  // Get recently searched queries from cache\r\n  const getEnhancedPopularSearches = () => {\r\n    const recentQueries = unsplashCache.getPopularQueries(3);\r\n    const defaultSearches = popularSearches;\r\n\r\n    // Combine recent queries with default ones, avoiding duplicates\r\n    const combined = [...recentQueries];\r\n    defaultSearches.forEach(search => {\r\n      if (!combined.some(query => query.toLowerCase() === search.toLowerCase())) {\r\n        combined.push(search);\r\n      }\r\n    });\r\n\r\n    return combined.slice(0, 8); // Limit to 8 total suggestions\r\n  };\r\n\r\n  const generatePlaceholderImages = (query: string): UnsplashImage[] => {\r\n    const categories = ['trading', 'finance', 'business', 'charts', 'success', 'growth'];\r\n    const selectedCategory = categories.find(cat => query.toLowerCase().includes(cat)) || 'business';\r\n\r\n    return Array.from({ length: 24 }, (_, i) => ({\r\n      id: `placeholder-${i}`,\r\n      urls: {\r\n        small: `https://picsum.photos/400/200?random=${i}&blur=1`,\r\n        regular: `https://picsum.photos/800/400?random=${i}`,\r\n        full: `https://picsum.photos/1200/600?random=${i}`\r\n      },\r\n      links: {\r\n        download_location: '',\r\n        html: ''\r\n      },\r\n      alt_description: `${selectedCategory} image ${i + 1}`,\r\n      user: {\r\n        name: 'Demo User',\r\n        username: 'demo_user',\r\n        links: {\r\n          html: ''\r\n        }\r\n      }\r\n    }));\r\n  };\r\n\r\n  const handleSearchImages = async (query: string = searchQuery) => {\r\n    if (!query.trim()) return;\r\n\r\n    setLoading(true);\r\n    setIsFromCache(false);\r\n\r\n    try {\r\n      // Check cache first\r\n      const cachedImages = unsplashCache.getCachedImages(query);\r\n      if (cachedImages) {\r\n        logger.log(`Loading ${cachedImages.length} images from cache for query: \"${query}\"`);\r\n        setImages(cachedImages);\r\n        setIsFromCache(true);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      if (!UNSPLASH_ACCESS_KEY) {\r\n        logger.warn('Unsplash API key not configured, using placeholder images');\r\n        const placeholderImages = generatePlaceholderImages(query);\r\n        setImages(placeholderImages);\r\n        // Cache placeholder images too\r\n        unsplashCache.cacheImages(query, placeholderImages);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      logger.log(`Fetching images from Unsplash API for query: \"${query}\"`);\r\n      const response = await fetch(\r\n        `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=24&orientation=landscape`,\r\n        {\r\n          headers: {\r\n            Authorization: `Client-ID ${UNSPLASH_ACCESS_KEY}`,\r\n          },\r\n        }\r\n      );\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setImages(data.results);\r\n        // Cache the results\r\n        unsplashCache.cacheImages(query, data.results);\r\n        logger.log(`Cached ${data.results.length} images for query: \"${query}\"`);\r\n      } else {\r\n        logger.error('Failed to fetch images from Unsplash');\r\n        const placeholderImages = generatePlaceholderImages(query);\r\n        setImages(placeholderImages);\r\n        // Cache placeholder images as fallback\r\n        unsplashCache.cacheImages(query, placeholderImages);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error fetching images:', error);\r\n      const placeholderImages = generatePlaceholderImages(query);\r\n      setImages(placeholderImages);\r\n      // Cache placeholder images as fallback\r\n      unsplashCache.cacheImages(query, placeholderImages);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleImageClick = async (image: UnsplashImage) => {\r\n    // Trigger download endpoint as required by Unsplash guidelines\r\n    if (image.links.download_location && UNSPLASH_ACCESS_KEY) {\r\n      try {\r\n        await fetch(image.links.download_location, {\r\n          headers: {\r\n            Authorization: `Client-ID ${UNSPLASH_ACCESS_KEY}`,\r\n          },\r\n        });\r\n      } catch (error) {\r\n        logger.error('Error triggering download endpoint:', error);\r\n      }\r\n    }\r\n\r\n    // Pass the image data including attribution info - use full size with quality parameters for better quality\r\n    const highQualityUrl = `${image.urls.full}&q=85&fm=jpg&fit=crop&w=1200&h=600`;\r\n    onImageSelect(highQualityUrl, {\r\n      id: image.id,\r\n      photographer: image.user.name,\r\n      photographerUsername: image.user.username,\r\n      photographerUrl: `${image.user.links.html}?utm_source=trade-tracker&utm_medium=referral`,\r\n      unsplashUrl: `${image.links.html}?utm_source=trade-tracker&utm_medium=referral`,\r\n      altDescription: image.alt_description\r\n    });\r\n    onClose();\r\n  };\r\n\r\n  const handlePopularSearchClick = (search: string) => {\r\n    setSearchQuery(search);\r\n    handleSearchImages(search);\r\n  };\r\n\r\n  // Load default images when dialog opens and clean up expired cache\r\n  React.useEffect(() => {\r\n    if (open) {\r\n      // Clean up expired cache entries\r\n      const removedCount = unsplashCache.removeExpiredEntries();\r\n      if (removedCount > 0) {\r\n        logger.log(`Removed ${removedCount} expired cache entries`);\r\n      }\r\n\r\n      // Load default images if none are loaded\r\n      if (images.length === 0) {\r\n        setSearchQuery('trading charts');\r\n        handleSearchImages('trading charts');\r\n      }\r\n    }\r\n  }, [open]);\r\n\r\n  return (\r\n    <Dialog\r\n      open={open}\r\n      onClose={onClose}\r\n      maxWidth=\"lg\"\r\n      fullWidth\r\n      {...dialogBaseProps}\r\n      sx={{\r\n        ...(dialogBaseProps.sx || {}),\r\n        zIndex: (theme) => theme.zIndex.modal + 200, // Ensure it's above the AIChatDrawer\r\n      }}\r\n    >\r\n      <DialogTitle\r\n        sx={{\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'space-between',\r\n          py: 2,\r\n          px: 2.5,\r\n          borderBottom: '1px solid',\r\n          borderColor: 'divider',\r\n        }}\r\n      >\r\n        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>\r\n          <Typography variant=\"h6\" sx={{ fontWeight: 600 }}>\r\n            {title}\r\n          </Typography>\r\n          <Typography variant=\"body2\" sx={{ color: 'text.secondary' }}>\r\n            Choose a clean cover image from curated Unsplash photos\r\n          </Typography>\r\n        </Box>\r\n        <IconButton\r\n          onClick={onClose}\r\n          size=\"small\"\r\n          sx={{\r\n            color: 'text.secondary',\r\n            '&:hover': {\r\n              bgcolor: alpha(theme.palette.error.main, 0.08),\r\n              color: 'error.main',\r\n            },\r\n          }}\r\n        >\r\n          <CloseIcon />\r\n        </IconButton>\r\n      </DialogTitle>\r\n\r\n      <DialogContent sx={{ pt: 2, px: 2.5 }}>\r\n        {/* Search */}\r\n        <Box\r\n          sx={{\r\n            display: 'flex',\r\n            gap: 1.5,\r\n            mt: 1,\r\n            mb: 2,\r\n            alignItems: 'center',\r\n            flexDirection: { xs: 'column', sm: 'row' }\r\n          }}\r\n        >\r\n          <TextField\r\n            fullWidth\r\n            size=\"small\"\r\n            placeholder=\"Search for trading charts, financial markets, business...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            onKeyDown={(e) => e.key === 'Enter' && handleSearchImages()}\r\n            slotProps={{\r\n              input: {\r\n                startAdornment: <SearchIcon sx={{ mr: 1.5, color: 'primary.main' }} />,\r\n                sx: {\r\n                  borderRadius: 1\r\n                }\r\n              }\r\n            }}\r\n            sx={{\r\n              '& .MuiOutlinedInput-root': {\r\n                borderRadius: 1\r\n              },\r\n              bgcolor: 'background.paper',\r\n              borderRadius: 1,\r\n              border: '1px solid',\r\n              borderColor: 'divider'\r\n            }}\r\n          />\r\n          <Button\r\n            variant=\"contained\"\r\n            onClick={() => handleSearchImages()}\r\n            disabled={loading}\r\n            sx={{\r\n              minWidth: 120,\r\n              borderRadius: 1,\r\n              background: (theme) => `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.primary.light} 100%)`,\r\n              '&:hover': {\r\n                background: (theme) => `linear-gradient(135deg, ${theme.palette.primary.dark} 0%, ${theme.palette.primary.main} 100%)`,\r\n                transform: 'translateY(-1px)',\r\n                boxShadow: (theme) => `0 4px 12px ${alpha(theme.palette.primary.main, 0.3)}`\r\n              }\r\n            }}\r\n          >\r\n            {loading ? <CircularProgress size={20} color=\"inherit\" /> : 'Search'}\r\n          </Button>\r\n        </Box>\r\n\r\n        {/* Cache status indicator */}\r\n        {isFromCache && (\r\n          <Box sx={{ mb: 2 }}>\r\n            <Chip\r\n              icon={<CachedIcon />}\r\n              label=\"Loaded from cache\"\r\n              size=\"small\"\r\n              color=\"success\"\r\n              variant=\"outlined\"\r\n              sx={{\r\n                fontSize: '0.75rem',\r\n                height: 24,\r\n                '& .MuiChip-icon': {\r\n                  fontSize: '0.9rem'\r\n                }\r\n              }}\r\n            />\r\n          </Box>\r\n        )}\r\n\r\n        {/* Popular searches */}\r\n        <Box sx={{ mb: 3 }}>\r\n          <Typography variant=\"subtitle2\" sx={{\r\n            color: 'text.primary',\r\n            mb: 1.5,\r\n            display: 'block',\r\n            fontWeight: 600\r\n          }}>\r\n             Popular searches\r\n          </Typography>\r\n          <Box sx={{\r\n            display: 'flex',\r\n            flexWrap: 'wrap',\r\n            gap: 1\r\n          }}>\r\n            {getEnhancedPopularSearches().map((search, index) => {\r\n              const isRecentQuery = unsplashCache.isCached(search);\r\n              return (\r\n                <Button\r\n                  key={`${search}-${index}`}\r\n                  size=\"small\"\r\n                  variant=\"outlined\"\r\n                  onClick={() => handlePopularSearchClick(search)}\r\n                  startIcon={isRecentQuery ? <CachedIcon sx={{ fontSize: '0.8rem' }} /> : undefined}\r\n                  sx={{\r\n                    fontSize: '0.8rem',\r\n                    textTransform: 'none',\r\n                    borderRadius: 1,\r\n                    minWidth: 'auto',\r\n                    px: 2,\r\n                    py: 0.5,\r\n                    borderColor: isRecentQuery ? 'success.main' : 'divider',\r\n                    color: isRecentQuery ? 'success.main' : 'text.primary',\r\n                    background: (theme) => isRecentQuery\r\n                      ? `linear-gradient(135deg, ${alpha(theme.palette.success.main, 0.05)} 0%, ${alpha(theme.palette.success.light, 0.05)} 100%)`\r\n                      : theme.palette.mode === 'dark'\r\n                        ? `linear-gradient(135deg, ${alpha(theme.palette.background.paper, 0.8)} 0%, ${alpha(theme.palette.background.default, 0.9)} 100%)`\r\n                        : 'linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.9) 100%)',\r\n                    '&:hover': {\r\n                      borderColor: isRecentQuery ? 'success.main' : 'primary.main',\r\n                      color: isRecentQuery ? 'success.main' : 'primary.main',\r\n                      background: (theme) => isRecentQuery\r\n                        ? `linear-gradient(135deg, ${alpha(theme.palette.success.main, 0.1)} 0%, ${alpha(theme.palette.success.light, 0.1)} 100%)`\r\n                        : `linear-gradient(135deg, ${alpha(theme.palette.primary.main, theme.palette.mode === 'dark' ? 0.15 : 0.05)} 0%, ${alpha(theme.palette.primary.light, theme.palette.mode === 'dark' ? 0.15 : 0.05)} 100%)`,\r\n                      transform: 'translateY(-1px)',\r\n                      boxShadow: (theme) => `0 2px 8px ${alpha(isRecentQuery ? theme.palette.success.main : theme.palette.primary.main, 0.25)}`\r\n                    }\r\n                  }}\r\n                >\r\n                  {search}\r\n                </Button>\r\n              );\r\n            })}\r\n          </Box>\r\n        </Box>\r\n\r\n        {/* Cache Management */}\r\n        <Box sx={{ mb: 3, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n          <Typography variant=\"caption\" sx={{ color: 'text.secondary' }}>\r\n            {(() => {\r\n              const stats = unsplashCache.getCacheStats();\r\n              return `${stats.totalEntries} cached searches  ${(stats.totalSize / 1024).toFixed(1)}KB`;\r\n            })()}\r\n          </Typography>\r\n          <Button\r\n            size=\"small\"\r\n            variant=\"text\"\r\n            onClick={() => {\r\n              unsplashCache.clearCache();\r\n              setImages([]);\r\n              setIsFromCache(false);\r\n            }}\r\n            sx={{\r\n              fontSize: '0.75rem',\r\n              textTransform: 'none',\r\n              color: 'text.secondary',\r\n              '&:hover': {\r\n                color: 'error.main'\r\n              }\r\n            }}\r\n          >\r\n            Clear cache\r\n          </Button>\r\n        </Box>\r\n\r\n        {/* Images Grid */}\r\n        <Box\r\n          sx={{\r\n            maxHeight: 380,\r\n            overflowY: 'auto',\r\n            overflowX: 'hidden',\r\n            borderRadius: 1,\r\n            border: `1px solid ${theme.palette.divider}`,\r\n            bgcolor:\r\n              theme.palette.mode === 'dark'\r\n                ? alpha(theme.palette.background.paper, 0.9)\r\n                : alpha(theme.palette.background.default, 0.9),\r\n            p: 1.5,\r\n            ...scrollbarStyles(theme)\r\n          }}\r\n        >\r\n          {loading ? (\r\n            <Box\r\n              sx={{\r\n                display: 'grid',\r\n                gridTemplateColumns: {\r\n                  xs: 'repeat(2, 1fr)',\r\n                  sm: 'repeat(3, 1fr)',\r\n                  md: 'repeat(4, 1fr)',\r\n                  lg: 'repeat(5, 1fr)'\r\n                },\r\n                gap: 1.5\r\n              }}\r\n            >\r\n              {Array.from({ length: 20 }).map((_, index) => (\r\n                <Shimmer\r\n                  key={index}\r\n                  height={140}\r\n                  borderRadius={1}\r\n                  variant=\"wave\"\r\n                  intensity=\"medium\"\r\n                />\r\n              ))}\r\n            </Box>\r\n          ) : (\r\n            <Box\r\n              sx={{\r\n                display: 'grid',\r\n                gridTemplateColumns: {\r\n                  xs: 'repeat(2, 1fr)',\r\n                  sm: 'repeat(3, 1fr)',\r\n                  md: 'repeat(4, 1fr)',\r\n                  lg: 'repeat(5, 1fr)'\r\n                },\r\n                gap: 1.5\r\n              }}\r\n            >\r\n              {images.map((image) => (\r\n                <Card\r\n                  key={image.id}\r\n                  sx={{\r\n                    borderRadius: 1,\r\n                    transition: 'transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease',\r\n                    cursor: 'pointer',\r\n                    position: 'relative',\r\n                    overflow: 'hidden',\r\n                    border: '1px solid',\r\n                    borderColor: alpha(theme.palette.divider, 0.7),\r\n                    '&:hover': {\r\n                      transform: 'translateY(-2px)',\r\n                      boxShadow: '0 4px 12px rgba(0,0,0,0.18)',\r\n                      borderColor: theme.palette.primary.main,\r\n                      '& .image-overlay': {\r\n                        opacity: 1\r\n                      }\r\n                    }\r\n                  }}\r\n                >\r\n                  <CardActionArea\r\n                    onClick={() => handleImageClick(image)}\r\n                    sx={{\r\n                      position: 'relative',\r\n                      '&:hover .MuiCardActionArea-focusHighlight': {\r\n                        opacity: 0\r\n                      }\r\n                    }}\r\n                  >\r\n                    <CardMedia\r\n                      component=\"img\"\r\n                      height=\"120\"\r\n                      image={image.urls.small}\r\n                      alt={image.alt_description || 'Cover image'}\r\n                      sx={{\r\n                        objectFit: 'cover'\r\n                      }}\r\n                    />\r\n\r\n                    {/* Hover overlay */}\r\n                    <Box\r\n                      className=\"image-overlay\"\r\n                      sx={{\r\n                        position: 'absolute',\r\n                        inset: 0,\r\n                        backgroundColor: alpha(theme.palette.common.black, 0.4),\r\n                        opacity: 0,\r\n                        transition: 'opacity 0.2s ease',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        color: 'common.white'\r\n                      }}\r\n                    >\r\n                      <Typography variant=\"body2\" sx={{ fontWeight: 600 }}>\r\n                        Select Image\r\n                      </Typography>\r\n                    </Box>\r\n\r\n                    {/* Attribution overlay - only show for real Unsplash images */}\r\n                    {image.user.username !== 'demo_user' && (\r\n                      <Box\r\n                        sx={{\r\n                          position: 'absolute',\r\n                          bottom: 0,\r\n                          left: 0,\r\n                          right: 0,\r\n                          background: 'linear-gradient(transparent, rgba(0,0,0,0.8))',\r\n                          color: 'white',\r\n                          p: 1,\r\n                          fontSize: '0.7rem'\r\n                        }}\r\n                      >\r\n                        <Typography variant=\"caption\" sx={{\r\n                          fontSize: '0.7rem',\r\n                          fontWeight: 500,\r\n                          textShadow: '0 1px 2px rgba(0,0,0,0.8)'\r\n                        }}>\r\n                           {image.user.name}\r\n                        </Typography>\r\n                      </Box>\r\n                    )}\r\n                  </CardActionArea>\r\n                </Card>\r\n              ))}\r\n            </Box>\r\n          )}\r\n        </Box>\r\n\r\n        {/* Unsplash Attribution Footer */}\r\n        <Box sx={{\r\n          mt: 3,\r\n          pt: 3,\r\n          borderTop: '1px solid',\r\n          borderColor: 'divider',\r\n          textAlign: 'center',\r\n          background: (theme) => `linear-gradient(135deg, ${alpha(theme.palette.primary.main, 0.02)} 0%, ${alpha(theme.palette.primary.light, 0.02)} 100%)`,\r\n          borderRadius: 1,\r\n          mx: -1,\r\n          px: 2\r\n        }}>\r\n          <Typography variant=\"body2\" sx={{\r\n            color: 'text.secondary',\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            gap: 1\r\n          }}>\r\n            <Box component=\"span\" sx={{ fontSize: '1.2rem' }}></Box>\r\n            <Link\r\n              href=\"https://unsplash.com/?utm_source=trade-tracker&utm_medium=referral\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              sx={{\r\n                color: 'primary.main',\r\n                textDecoration: 'none',\r\n                fontWeight: 600,\r\n                borderBottom: '1px solid transparent',\r\n                transition: 'border-color 0.2s ease',\r\n                '&:hover': {\r\n                  borderBottomColor: 'primary.main'\r\n                }\r\n              }}\r\n            >\r\n              Photo by Unsplash\r\n            </Link>\r\n          </Typography>\r\n        </Box>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default ImagePickerDialog;\r\n","import { Theme } from '@mui/material';\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\nimport { dialogProps } from '../styles/dialogStyles';\n\n/**\n * Creates consistent dialog props with styling\n * @param theme Current theme\n * @returns Dialog props with consistent styling\n */\nexport const getDialogProps = (theme: Theme) => ({\n  ...dialogProps,\n  PaperProps: {\n    sx: {\n      borderRadius: 2,\n      boxShadow: 'none',\n      border: `1px solid ${theme.palette.divider}`,\n      maxHeight: '90vh',\n      overflow: 'hidden',\n      '& .MuiDialogContent-root': {\n        ...scrollbarStyles(theme)\n      }\n    }\n  }\n});\n\n/**\n * Creates consistent dialog content props with scrollbar styling\n * @param theme Current theme\n * @returns Dialog content props with consistent styling\n */\nexport const getDialogContentProps = (theme: Theme) => ({\n  sx: {\n    ...scrollbarStyles(theme)\n  }\n});\n","/**\r\n * Note Repository\r\n * Handles Supabase operations for simple notes\r\n */\r\n\r\nimport { AbstractBaseRepository, RepositoryConfig } from \"./BaseRepository\";\r\nimport { Note } from \"../../../types/note\";\r\nimport { logger } from \"../../../utils/logger\";\r\nimport { supabase } from \"../../../config/supabase\";\r\n\r\n/**\r\n * Query options for filtering and pagination\r\n */\r\nexport interface NoteQueryOptions {\r\n  isPinned?: boolean;\r\n  isArchived?: boolean;\r\n  byAssistant?: boolean;\r\n  searchQuery?: string;\r\n  limit?: number;\r\n  offset?: number;\r\n}\r\n\r\n/**\r\n * Query result with pagination info\r\n */\r\nexport interface NoteQueryResult {\r\n  notes: Note[];\r\n  total: number;\r\n  hasMore: boolean;\r\n}\r\n\r\n/**\r\n * Safely parse a date value\r\n */\r\nconst parseDate = (dateValue: any, fallback: Date = new Date()): Date => {\r\n  if (!dateValue) return fallback;\r\n  const parsed = new Date(dateValue);\r\n  return isNaN(parsed.getTime()) ? fallback : parsed;\r\n};\r\n\r\n/**\r\n * Transform Supabase note data to Note type\r\n */\r\nconst transformSupabaseNote = (data: any): Note => {\r\n  return {\r\n    ...data,\r\n    created_at: parseDate(data.created_at),\r\n    updated_at: parseDate(data.updated_at),\r\n    archived_at: data.archived_at ? parseDate(data.archived_at) : null,\r\n  } as Note;\r\n};\r\n\r\nexport class NoteRepository extends AbstractBaseRepository<Note> {\r\n  constructor(config?: Partial<RepositoryConfig>) {\r\n    super(config);\r\n  }\r\n\r\n  // READ OPERATIONS\r\n\r\n  async findById(id: string): Promise<Note | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .eq(\"id\", id)\r\n        .single();\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding note by ID:\", error);\r\n        return null;\r\n      }\r\n\r\n      return data ? transformSupabaseNote(data) : null;\r\n    } catch (error) {\r\n      logger.error(\"Error finding note by ID:\", error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async findByUserId(userId: string): Promise<Note[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .order(\"updated_at\", { ascending: false });\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding notes by user ID:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Exception finding notes by user ID:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async findByTag(userId: string, tag: string): Promise<Note[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", userId)\r\n        .contains(\"tags\", [tag]);\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding notes by tag:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Error finding notes by tag:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query notes by user ID with filtering, search, and pagination\r\n   */\r\n  async queryByUserId(\r\n    userId: string,\r\n    options: NoteQueryOptions = {},\r\n  ): Promise<NoteQueryResult> {\r\n    try {\r\n      const {\r\n        isPinned,\r\n        isArchived,\r\n        byAssistant,\r\n        searchQuery,\r\n        limit = 20,\r\n        offset = 0,\r\n      } = options;\r\n\r\n      // Build the query\r\n      let query = supabase\r\n        .from(\"notes\")\r\n        .select(\"*\", { count: \"exact\" })\r\n        .eq(\"user_id\", userId);\r\n\r\n      // Apply filters\r\n      if (isPinned !== undefined) {\r\n        query = query.eq(\"is_pinned\", isPinned);\r\n      }\r\n      if (isArchived !== undefined) {\r\n        query = query.eq(\"is_archived\", isArchived);\r\n      }\r\n      if (byAssistant !== undefined) {\r\n        query = query.eq(\"by_assistant\", byAssistant);\r\n      }\r\n\r\n      // Apply search (search in title and content)\r\n      if (searchQuery && searchQuery.trim() !== \"\") {\r\n        query = query.or(\r\n          `title.ilike.%${searchQuery}%,content.ilike.%${searchQuery}%`,\r\n        );\r\n      }\r\n\r\n      // Apply ordering, pagination\r\n      query = query\r\n        .order(\"updated_at\", { ascending: false })\r\n        .range(offset, offset + limit - 1);\r\n\r\n      const { data, error, count } = await query;\r\n\r\n      if (error) {\r\n        logger.error(\"Error querying notes by user ID:\", error);\r\n        return { notes: [], total: 0, hasMore: false };\r\n      }\r\n\r\n      const notes = data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n      const total = count || 0;\r\n      const hasMore = offset + limit < total;\r\n\r\n      return { notes, total, hasMore };\r\n    } catch (error) {\r\n      logger.error(\"Exception querying notes by user ID:\", error);\r\n      return { notes: [], total: 0, hasMore: false };\r\n    }\r\n  }\r\n\r\n  async findByCalendarId(calendarId: string): Promise<Note[]> {\r\n    try {\r\n      // Include both calendar-specific notes AND global notes (calendar_id = null)\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .or(`calendar_id.eq.${calendarId},calendar_id.is.null`)\r\n        .order(\"updated_at\", { ascending: false });\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding notes by calendar ID:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Exception finding notes by calendar ID:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query notes by calendar ID with filtering, search, and pagination\r\n   */\r\n  async queryByCalendarId(\r\n    calendarId: string,\r\n    options: NoteQueryOptions = {},\r\n  ): Promise<NoteQueryResult> {\r\n    try {\r\n      const {\r\n        isPinned,\r\n        isArchived,\r\n        byAssistant,\r\n        searchQuery,\r\n        limit = 20,\r\n        offset = 0,\r\n      } = options;\r\n\r\n      // Build the query - include both calendar-specific notes AND global notes (calendar_id = null)\r\n      let query = supabase\r\n        .from(\"notes\")\r\n        .select(\"*\", { count: \"exact\" })\r\n        .or(`calendar_id.eq.${calendarId},calendar_id.is.null`);\r\n\r\n      // Apply filters\r\n      if (isPinned !== undefined) {\r\n        query = query.eq(\"is_pinned\", isPinned);\r\n      }\r\n      if (isArchived !== undefined) {\r\n        query = query.eq(\"is_archived\", isArchived);\r\n      }\r\n      if (byAssistant !== undefined) {\r\n        query = query.eq(\"by_assistant\", byAssistant);\r\n      }\r\n\r\n      // Apply search (search in title and content)\r\n      if (searchQuery && searchQuery.trim() !== \"\") {\r\n        query = query.or(\r\n          `title.ilike.%${searchQuery}%,content.ilike.%${searchQuery}%`,\r\n        );\r\n      }\r\n\r\n      // Apply ordering, pagination\r\n      query = query\r\n        .order(\"updated_at\", { ascending: false })\r\n        .range(offset, offset + limit - 1);\r\n\r\n      const { data, error, count } = await query;\r\n\r\n      if (error) {\r\n        logger.error(\"Error querying notes by calendar ID:\", error);\r\n        return { notes: [], total: 0, hasMore: false };\r\n      }\r\n\r\n      const notes = data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n      const total = count || 0;\r\n      const hasMore = offset + limit < total;\r\n\r\n      return { notes, total, hasMore };\r\n    } catch (error) {\r\n      logger.error(\"Exception querying notes by calendar ID:\", error);\r\n      return { notes: [], total: 0, hasMore: false };\r\n    }\r\n  }\r\n\r\n  async findAll(): Promise<Note[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .order(\"updated_at\", { ascending: false });\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding all notes:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Error finding all notes:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // ARCHIVE OPERATIONS\r\n\r\n  /**\r\n   * Archive a note (soft delete)\r\n   */\r\n  async archiveNote(noteId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"notes\")\r\n        .update({\r\n          is_archived: true,\r\n          updated_at: new Date(),\r\n        })\r\n        .eq(\"id\", noteId);\r\n\r\n      if (error) {\r\n        logger.error(\"Error archiving note:\", error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      logger.error(\"Exception archiving note:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unarchive a note\r\n   */\r\n  async unarchiveNote(noteId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"notes\")\r\n        .update({\r\n          is_archived: false,\r\n          updated_at: new Date(),\r\n        })\r\n        .eq(\"id\", noteId);\r\n\r\n      if (error) {\r\n        logger.error(\"Error unarchiving note:\", error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      logger.error(\"Exception unarchiving note:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // MOVE OPERATIONS\r\n\r\n  /**\r\n   * Move a note to a different calendar\r\n   */\r\n  async moveNoteToCalendar(\r\n    noteId: string,\r\n    calendarId: string,\r\n  ): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"notes\")\r\n        .update({\r\n          calendar_id: calendarId,\r\n          updated_at: new Date(),\r\n        })\r\n        .eq(\"id\", noteId);\r\n\r\n      if (error) {\r\n        logger.error(\"Error moving note to calendar:\", error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      logger.error(\"Exception moving note to calendar:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // PIN OPERATIONS\r\n\r\n  /**\r\n   * Pin a note\r\n   */\r\n  async pinNote(noteId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"notes\")\r\n        .update({\r\n          is_pinned: true,\r\n          updated_at: new Date(),\r\n        })\r\n        .eq(\"id\", noteId);\r\n\r\n      if (error) {\r\n        logger.error(\"Error pinning note:\", error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      logger.error(\"Exception pinning note:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unpin a note\r\n   */\r\n  async unpinNote(noteId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from(\"notes\")\r\n        .update({\r\n          is_pinned: false,\r\n          updated_at: new Date(),\r\n        })\r\n        .eq(\"id\", noteId);\r\n\r\n      if (error) {\r\n        logger.error(\"Error unpinning note:\", error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      logger.error(\"Exception unpinning note:\", error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // REMINDER OPERATIONS\r\n\r\n  /**\r\n   * Find reminder notes for a specific day of the week\r\n   * Returns active weekly reminders that match the given day\r\n   */\r\n  async findRemindersByDay(\r\n    calendarId: string,\r\n    dayAbbreviation: string,\r\n  ): Promise<Note[]> {\r\n    try {\r\n      // Include both calendar-specific notes AND global notes (calendar_id = null)\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .or(`calendar_id.eq.${calendarId},calendar_id.is.null`)\r\n        .eq(\"reminder_type\", \"weekly\")\r\n        .eq(\"is_reminder_active\", true)\r\n        .eq(\"is_archived\", false)\r\n        .contains(\"reminder_days\", [dayAbbreviation])\r\n        .order(\"created_at\", { ascending: false }); // Most recent first\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding reminders by day:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Exception finding reminders by day:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find reminder notes for a specific date (one-time reminders)\r\n   * Returns active one-time reminders that match the given date\r\n   */\r\n  async findRemindersByDate(calendarId: string, date: Date): Promise<Note[]> {\r\n    try {\r\n      const dateStr = date.toISOString().split(\"T\")[0]; // Format: YYYY-MM-DD\r\n\r\n      // Include both calendar-specific notes AND global notes (calendar_id = null)\r\n      const { data, error } = await supabase\r\n        .from(\"notes\")\r\n        .select(\"*\")\r\n        .or(`calendar_id.eq.${calendarId},calendar_id.is.null`)\r\n        .eq(\"reminder_type\", \"once\")\r\n        .eq(\"is_reminder_active\", true)\r\n        .eq(\"is_archived\", false)\r\n        .eq(\"reminder_date\", dateStr)\r\n        .order(\"created_at\", { ascending: false }); // Most recent first\r\n\r\n      if (error) {\r\n        logger.error(\"Error finding reminders by date:\", error);\r\n        return [];\r\n      }\r\n\r\n      return data ? data.map((item) => transformSupabaseNote(item)) : [];\r\n    } catch (error) {\r\n      logger.error(\"Exception finding reminders by date:\", error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // SUPABASE OPERATIONS\r\n\r\n  protected async createInSupabase(\r\n    entity: Omit<Note, \"id\" | \"created_at\" | \"updated_at\">,\r\n  ): Promise<Note> {\r\n    const now = new Date();\r\n    const noteWithTimestamps = {\r\n      ...entity,\r\n      title: entity.title || \"Untitled\",\r\n      content: entity.content || \"\",\r\n      is_archived: false,\r\n      is_pinned: false,\r\n      archived_at: null,\r\n      created_at: now,\r\n      updated_at: now,\r\n    } as Note;\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"notes\")\r\n      .insert(noteWithTimestamps)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return transformSupabaseNote(data);\r\n  }\r\n\r\n  protected async updateInSupabase(\r\n    id: string,\r\n    updates: Partial<Note>,\r\n  ): Promise<Note> {\r\n    const updatesWithTimestamp = {\r\n      ...updates,\r\n      updated_at: new Date(),\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"notes\")\r\n      .update(updatesWithTimestamp)\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return transformSupabaseNote(data);\r\n  }\r\n\r\n  protected async deleteInSupabase(id: string): Promise<boolean> {\r\n    const { error } = await supabase\r\n      .from(\"notes\")\r\n      .delete()\r\n      .eq(\"id\", id);\r\n\r\n    if (error) {\r\n      throw error;\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","/**\r\n * Notes Service\r\n * Simple service for Notion-style notes\r\n */\r\n\r\nimport { CreateNoteInput, Note, UpdateNoteInput } from \"../types/note\";\r\nimport { logger } from \"../utils/logger\";\r\nimport {\r\n  NoteQueryOptions,\r\n  NoteQueryResult,\r\n  NoteRepository,\r\n} from \"./repository/repositories/NoteRepository\";\r\n\r\nconst noteRepository = new NoteRepository();\r\n\r\n// Re-export types for convenience\r\nexport type { NoteQueryOptions, NoteQueryResult };\r\n\r\n/**\r\n * Get all notes for a user\r\n */\r\nexport const getUserNotes = async (userId: string): Promise<Note[]> => {\r\n  try {\r\n    return await noteRepository.findByUserId(userId);\r\n  } catch (error) {\r\n    logger.error(\"Error getting user notes:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Query notes for a user with filtering, search, and pagination\r\n */\r\nexport const queryUserNotes = async (\r\n  userId: string,\r\n  options: NoteQueryOptions = {},\r\n): Promise<NoteQueryResult> => {\r\n  try {\r\n    return await noteRepository.queryByUserId(userId, options);\r\n  } catch (error) {\r\n    logger.error(\"Error querying user notes:\", error);\r\n    return { notes: [], total: 0, hasMore: false };\r\n  }\r\n};\r\n\r\n/**\r\n * Get notes by tag for a user\r\n */\r\nexport const getNotesByTag = async (\r\n  userId: string,\r\n  tag: string,\r\n): Promise<Note[]> => {\r\n  try {\r\n    return await noteRepository.findByTag(userId, tag);\r\n  } catch (error) {\r\n    logger.error(\"Error getting notes by tag:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Get all notes for a calendar\r\n */\r\nexport const getCalendarNotes = async (calendarId: string): Promise<Note[]> => {\r\n  try {\r\n    return await noteRepository.findByCalendarId(calendarId);\r\n  } catch (error) {\r\n    logger.error(\"Error getting calendar notes:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Query notes for a calendar with filtering, search, and pagination\r\n */\r\nexport const queryCalendarNotes = async (\r\n  calendarId: string,\r\n  options: NoteQueryOptions = {},\r\n): Promise<NoteQueryResult> => {\r\n  try {\r\n    return await noteRepository.queryByCalendarId(calendarId, options);\r\n  } catch (error) {\r\n    logger.error(\"Error querying calendar notes:\", error);\r\n    return { notes: [], total: 0, hasMore: false };\r\n  }\r\n};\r\n\r\n/**\r\n * Get a single note by ID\r\n */\r\nexport const getNote = async (noteId: string): Promise<Note | null> => {\r\n  try {\r\n    return await noteRepository.findById(noteId);\r\n  } catch (error) {\r\n    logger.error(\"Error getting note:\", error);\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * Create a new note\r\n */\r\nexport const createNote = async (noteInput: CreateNoteInput): Promise<Note> => {\r\n  try {\r\n    const noteData = {\r\n      ...noteInput,\r\n      title: noteInput.title || \"Untitled\",\r\n      content: noteInput.content || \"\",\r\n      cover_image: noteInput.cover_image ?? null,\r\n      is_archived: false,\r\n      is_pinned: false,\r\n      archived_at: null,\r\n      by_assistant: noteInput.by_assistant ?? false,\r\n    };\r\n    const result = await noteRepository.create(noteData);\r\n    if (!result.success || !result.data) {\r\n      throw new Error(result.error?.message || \"Failed to create note\");\r\n    }\r\n    return result.data as Note;\r\n  } catch (error) {\r\n    logger.error(\"Error creating note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Update an existing note\r\n */\r\nexport const updateNote = async (\r\n  noteId: string,\r\n  updates: UpdateNoteInput,\r\n): Promise<void> => {\r\n  try {\r\n    const result = await noteRepository.update(noteId, updates);\r\n    if (!result.success) {\r\n      throw new Error(result.error?.message || \"Failed to update note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error updating note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Delete a note (hard delete)\r\n */\r\nexport const deleteNote = async (noteId: string): Promise<void> => {\r\n  try {\r\n    const result = await noteRepository.delete(noteId);\r\n    if (!result.success) {\r\n      throw new Error(result.error?.message || \"Failed to delete note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error deleting note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Archive a note (soft delete)\r\n */\r\nexport const archiveNote = async (noteId: string): Promise<void> => {\r\n  try {\r\n    const success = await noteRepository.archiveNote(noteId);\r\n    if (!success) {\r\n      throw new Error(\"Failed to archive note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error archiving note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Unarchive a note\r\n */\r\nexport const unarchiveNote = async (noteId: string): Promise<void> => {\r\n  try {\r\n    const success = await noteRepository.unarchiveNote(noteId);\r\n    if (!success) {\r\n      throw new Error(\"Failed to unarchive note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error unarchiving note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Pin a note\r\n */\r\nexport const pinNote = async (noteId: string): Promise<void> => {\r\n  try {\r\n    const success = await noteRepository.pinNote(noteId);\r\n    if (!success) {\r\n      throw new Error(\"Failed to pin note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error pinning note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Unpin a note\r\n */\r\nexport const unpinNote = async (noteId: string): Promise<void> => {\r\n  try {\r\n    const success = await noteRepository.unpinNote(noteId);\r\n    if (!success) {\r\n      throw new Error(\"Failed to unpin note\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error unpinning note:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Move a note to a different calendar\r\n */\r\nexport const moveNoteToCalendar = async (\r\n  noteId: string,\r\n  calendarId: string,\r\n): Promise<void> => {\r\n  try {\r\n    const success = await noteRepository.moveNoteToCalendar(noteId, calendarId);\r\n    if (!success) {\r\n      throw new Error(\"Failed to move note to calendar\");\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Error moving note to calendar:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Get reminder notes for a specific day of the week\r\n * Returns notes that should be shown as reminders for the given day\r\n */\r\nexport const getReminderNotesForDay = async (\r\n  calendarId: string,\r\n  dayAbbreviation: string,\r\n): Promise<Note[]> => {\r\n  try {\r\n    return await noteRepository.findRemindersByDay(calendarId, dayAbbreviation);\r\n  } catch (error) {\r\n    logger.error(\"Error getting reminder notes for day:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Get reminder notes for a specific date (one-time reminders)\r\n */\r\nexport const getReminderNotesForDate = async (\r\n  calendarId: string,\r\n  date: Date,\r\n): Promise<Note[]> => {\r\n  try {\r\n    return await noteRepository.findRemindersByDate(calendarId, date);\r\n  } catch (error) {\r\n    logger.error(\"Error getting reminder notes for date:\", error);\r\n    return [];\r\n  }\r\n};\r\n\r\n/**\r\n * Set a reminder on a note\r\n */\r\nexport const setNoteReminder = async (\r\n  noteId: string,\r\n  reminderType: string,\r\n  reminderDate?: Date | null,\r\n  reminderDays?: string[],\r\n): Promise<void> => {\r\n  try {\r\n    await noteRepository.update(noteId, {\r\n      reminder_type: reminderType as any,\r\n      reminder_date: reminderDate,\r\n      reminder_days: reminderDays as any,\r\n      is_reminder_active: reminderType !== \"none\",\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error setting note reminder:\", error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n/**\r\n * Clear a note's reminder\r\n */\r\nexport const clearNoteReminder = async (noteId: string): Promise<void> => {\r\n  try {\r\n    await noteRepository.update(noteId, {\r\n      reminder_type: \"none\" as any,\r\n      reminder_date: null,\r\n      reminder_days: [] as any,\r\n      is_reminder_active: false,\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error clearing note reminder:\", error);\r\n    throw error;\r\n  }\r\n};\r\n","import { Trade, Calendar } from '../types/dualWrite';\r\nimport { TradeRepository } from '../services/repository/repositories/TradeRepository';\r\n\r\n/**\r\n * Dynamic risk settings interface\r\n */\r\nexport interface DynamicRiskSettings {\r\n  account_balance: number;\r\n  risk_per_trade?: number;\r\n  dynamic_risk_enabled?: boolean;\r\n  increased_risk_percentage?: number;\r\n  profit_threshold_percentage?: number;\r\n}\r\n\r\n/**\r\n * Calculate cumulative P&L up to (but not including) a specific date using year_stats.\r\n * Synchronous version - use when you already have the month's trades loaded.\r\n *\r\n * @param targetDate - The date to calculate cumulative P&L up to (exclusive)\r\n * @param calendar - Calendar object with year_stats containing account_value_at_start\r\n * @param monthTrades - Trades from the target month (can include trades after targetDate)\r\n * @returns Cumulative P&L before targetDate\r\n */\r\nexport const calculateCumulativePnLToDateSync = (\r\n  targetDate: Date,\r\n  calendar: Calendar,\r\n  monthTrades: Trade[]\r\n): number => {\r\n  const year = targetDate.getFullYear();\r\n  const month = targetDate.getMonth(); // 0-11\r\n\r\n  // Get account_value_at_start from year_stats (includes all P&L before this month)\r\n  const yearStats = calendar.year_stats?.[year.toString()];\r\n  const monthStats = yearStats?.monthly_stats?.[month];\r\n\r\n  let accountValueAtMonthStart: number;\r\n\r\n  if (monthStats?.account_value_at_start !== undefined) {\r\n    // Use the stored value for this month\r\n    accountValueAtMonthStart = Number(monthStats.account_value_at_start);\r\n  } else if (yearStats) {\r\n    // Year exists but month doesn't have value yet - use account_balance as fallback\r\n    accountValueAtMonthStart = Number(calendar.account_balance);\r\n  } else {\r\n    // No year_stats for this year - calculate from previous years\r\n    // Sum up all yearly P&L from previous years\r\n    let totalPreviousYearsPnL = 0;\r\n    if (calendar.year_stats) {\r\n      for (const [statsYear, stats] of Object.entries(calendar.year_stats)) {\r\n        const statsYearNum = parseInt(statsYear, 10);\r\n        if (statsYearNum < year && stats.yearly_pnl !== undefined) {\r\n          totalPreviousYearsPnL += Number(stats.yearly_pnl);\r\n        }\r\n      }\r\n    }\r\n    accountValueAtMonthStart = Number(calendar.account_balance) + totalPreviousYearsPnL;\r\n  }\r\n\r\n  // account_value_at_start = account_balance + all historical P&L up to month start\r\n  // So cumulative P&L at month start = account_value_at_start - account_balance\r\n  const cumulativePnLAtMonthStart = accountValueAtMonthStart - Number(calendar.account_balance);\r\n\r\n  // Filter trades: before targetDate (exclusive) - use full timestamp comparison\r\n  const targetTime = targetDate.getTime();\r\n\r\n  const monthPnLBeforeTarget = monthTrades\r\n    .filter(trade => {\r\n      const tradeTime = new Date(trade.trade_date).getTime();\r\n      return tradeTime < targetTime;\r\n    })\r\n    .reduce((sum, trade) => sum + Number(trade.amount), 0);\r\n\r\n  // Total cumulative P&L = historical + this month's trades before target\r\n  return cumulativePnLAtMonthStart + monthPnLBeforeTarget;\r\n};\r\n\r\n/**\r\n * Calculate cumulative P&L up to (but not including) a specific date using year_stats.\r\n * Async version - fetches month trades internally when not available.\r\n *\r\n * @param targetDate - The date to calculate cumulative P&L up to (exclusive)\r\n * @param calendar - Calendar object with year_stats containing account_value_at_start\r\n * @param providedTrades - Optional trades array to use instead of fetching from database\r\n * @returns Promise<number> Cumulative P&L before targetDate\r\n */\r\nexport const calculateCumulativePnLToDateAsync = async (\r\n  targetDate: Date,\r\n  calendar: Calendar,\r\n  providedTrades?: Trade[]\r\n): Promise<number> => {\r\n  const year = targetDate.getFullYear();\r\n  const month = targetDate.getMonth(); // 0-11\r\n\r\n  // Get account_value_at_start from year_stats\r\n  const yearStats = calendar.year_stats?.[year.toString()];\r\n  const monthStats = yearStats?.monthly_stats?.[month];\r\n\r\n  let accountValueAtMonthStart: number;\r\n\r\n  if (monthStats?.account_value_at_start !== undefined) {\r\n    // Use the stored value for this month\r\n    accountValueAtMonthStart = Number(monthStats.account_value_at_start);\r\n  } else if (yearStats) {\r\n    // Year exists but month doesn't have value yet - use account_balance as fallback\r\n    accountValueAtMonthStart = Number(calendar.account_balance);\r\n  } else {\r\n    // No year_stats for this year - calculate from previous years\r\n    // Sum up all yearly P&L from previous years\r\n    let totalPreviousYearsPnL = 0;\r\n    if (calendar.year_stats) {\r\n      for (const [statsYear, stats] of Object.entries(calendar.year_stats)) {\r\n        const statsYearNum = parseInt(statsYear, 10);\r\n        if (statsYearNum < year && stats.yearly_pnl !== undefined) {\r\n          totalPreviousYearsPnL += Number(stats.yearly_pnl);\r\n        }\r\n      }\r\n    }\r\n    accountValueAtMonthStart = Number(calendar.account_balance) + totalPreviousYearsPnL;\r\n  }\r\n\r\n  const cumulativePnLAtMonthStart = accountValueAtMonthStart - Number(calendar.account_balance);\r\n\r\n  // Use provided trades or fetch from database\r\n  let monthTrades: Pick<Trade, 'trade_date' | 'amount'>[];\r\n\r\n  if (providedTrades) {\r\n    // Filter provided trades to get only this month's trades\r\n    monthTrades = providedTrades\r\n      .filter(trade => {\r\n        const tradeDate = new Date(trade.trade_date);\r\n        return tradeDate.getFullYear() === year && tradeDate.getMonth() === month;\r\n      })\r\n      .map(trade => ({ trade_date: trade.trade_date, amount: trade.amount }));\r\n  } else {\r\n    // Fetch only trade_date and amount for this month (optimized query)\r\n    const tradeRepo = new TradeRepository();\r\n    monthTrades = await tradeRepo.getTradesByMonth(calendar.id!, year, month, ['trade_date', 'amount']);\r\n  }\r\n\r\n  // Filter trades before targetDate and sum their amounts - use full timestamp comparison\r\n  const targetTime = targetDate.getTime();\r\n\r\n  const monthPnLBeforeTarget = monthTrades\r\n    .filter(trade => {\r\n      const tradeTime = new Date(trade.trade_date).getTime();\r\n      return tradeTime < targetTime;\r\n    })\r\n    .reduce((sum, trade) => sum + Number(trade.amount), 0);\r\n\r\n  return cumulativePnLAtMonthStart + monthPnLBeforeTarget;\r\n};\r\n\r\n/**\r\n * Calculate the effective risk percentage for a specific date/trade using year_stats.\r\n * Async version - fetches month trades internally when not available.\r\n *\r\n * @param targetDate - The date to calculate effective risk for\r\n * @param calendar - Calendar object with year_stats\r\n * @param dynamicRiskSettings - Dynamic risk settings\r\n * @param providedTrades - Optional trades array to use instead of fetching from database\r\n */\r\nexport const calculateEffectiveRiskPercentageAsync = async (\r\n  targetDate: Date,\r\n  calendar: Calendar,\r\n  dynamicRiskSettings: DynamicRiskSettings,\r\n  providedTrades?: Trade[]\r\n): Promise<number> => {\r\n  if (!dynamicRiskSettings.risk_per_trade) return 0;\r\n\r\n  // If dynamic risk is not enabled, return base risk percentage\r\n  if (!dynamicRiskSettings.dynamic_risk_enabled ||\r\n      !dynamicRiskSettings.increased_risk_percentage ||\r\n      !dynamicRiskSettings.profit_threshold_percentage ||\r\n      dynamicRiskSettings.account_balance <= 0) {\r\n    return dynamicRiskSettings.risk_per_trade;\r\n  }\r\n\r\n  // Calculate cumulative P&L up to the target date using year_stats\r\n  const cumulativePnL = await calculateCumulativePnLToDateAsync(targetDate, calendar, providedTrades);\r\n\r\n  // Check if profit threshold is met\r\n  const profitPercentage = (cumulativePnL / dynamicRiskSettings.account_balance) * 100;\r\n  if (profitPercentage >= dynamicRiskSettings.profit_threshold_percentage) {\r\n    return dynamicRiskSettings.increased_risk_percentage;\r\n  }\r\n\r\n  return dynamicRiskSettings.risk_per_trade;\r\n};\r\n\r\n/**\r\n * Calculate the effective risk percentage for the current state (latest trade date)\r\n */\r\nexport const calculateCurrentEffectiveRiskPercentage = (\r\n  allTrades: Trade[],\r\n  dynamicRiskSettings: DynamicRiskSettings\r\n): number => {\r\n  if (!dynamicRiskSettings.risk_per_trade) return 0;\r\n\r\n  if (allTrades.length === 0) {\r\n    return dynamicRiskSettings.risk_per_trade || 0;\r\n  }\r\n\r\n  // If dynamic risk is not enabled, return base risk percentage\r\n  if (!dynamicRiskSettings.dynamic_risk_enabled ||\r\n      !dynamicRiskSettings.increased_risk_percentage ||\r\n      !dynamicRiskSettings.profit_threshold_percentage ||\r\n      dynamicRiskSettings.account_balance <= 0) {\r\n    return dynamicRiskSettings.risk_per_trade;\r\n  }\r\n\r\n  // Calculate cumulative P&L (all trades)\r\n  const cumulativePnL = allTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n  // Check if profit threshold is met\r\n  const profitPercentage = (cumulativePnL / dynamicRiskSettings.account_balance) * 100;\r\n  if (profitPercentage >= dynamicRiskSettings.profit_threshold_percentage) {\r\n    return dynamicRiskSettings.increased_risk_percentage;\r\n  }\r\n\r\n  return dynamicRiskSettings.risk_per_trade;\r\n};\r\n\r\n/**\r\n * Calculate current total account value (account balance + cumulative profit)\r\n */\r\nexport const calculateCurrentTotalValue = (\r\n  accountBalance: number,\r\n  allTrades: Trade[]\r\n): number => {\r\n  const totalPnL = allTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n  return accountBalance + totalPnL;\r\n};\r\n\r\n/**\r\n * Calculate percentage based on current total value instead of just account balance\r\n */\r\nexport const calculatePercentageOfCurrentValue = (\r\n  amount: number,\r\n  accountBalance: number,\r\n  allTrades: Trade[]\r\n): number => {\r\n  const currentTotalValue = calculateCurrentTotalValue(Number(accountBalance), allTrades);\r\n  return currentTotalValue > 0 ? (Number(amount) / currentTotalValue) * 100 : 0;\r\n};\r\n\r\n/**\r\n * Calculate percentage based on account value at a specific point in time\r\n * Excludes trades after the specified date to provide consistent baseline calculations\r\n */\r\nexport const calculatePercentageOfValueAtDate = (\r\n  amount: number,\r\n  accountBalance: number,\r\n  allTrades: Trade[],\r\n  excludeAfterDate: Date\r\n): number => {\r\n  const targetTime = excludeAfterDate.getTime();\r\n  const relevantTrades = allTrades.filter(trade => new Date(trade.trade_date).getTime() < targetTime);\r\n  const baselineValue = calculateCurrentTotalValue(Number(accountBalance), relevantTrades);\r\n  return baselineValue > 0 ? (Number(amount) / baselineValue) * 100 : 0;\r\n};\r\n\r\n/**\r\n * Calculate risk amount based on effective risk percentage and account value\r\n */\r\nexport const calculateRiskAmount = (\r\n  effectiveRiskPercentage: number,\r\n  accountBalance: number,\r\n  cumulativePnL: number = 0\r\n): number => {\r\n  const totalAccountValue = Number(accountBalance) + Number(cumulativePnL);\r\n  return (totalAccountValue * Number(effectiveRiskPercentage)) / 100;\r\n};\r\n\r\n/**\r\n * Calculate trade amount based on risk-to-reward ratio and dynamic risk settings.\r\n * Async version - uses year_stats and fetches month trades internally when not available.\r\n *\r\n * @param tradeType - Type of trade (win/loss/breakeven)\r\n * @param riskToReward - Risk to reward ratio\r\n * @param targetDate - Date of the trade\r\n * @param calendar - Calendar object with year_stats\r\n * @param dynamicRiskSettings - Dynamic risk settings\r\n * @param providedTrades - Optional trades array to use instead of fetching from database\r\n */\r\nexport const calculateTradeAmountAsync = async (\r\n  tradeType: 'win' | 'loss' | 'breakeven',\r\n  riskToReward: number,\r\n  targetDate: Date,\r\n  calendar: Calendar,\r\n  dynamicRiskSettings: DynamicRiskSettings,\r\n  providedTrades?: Trade[]\r\n): Promise<number> => {\r\n  if (tradeType === 'breakeven') return 0;\r\n  const effectiveRisk = await calculateEffectiveRiskPercentageAsync(\r\n    targetDate, calendar, dynamicRiskSettings, providedTrades\r\n  );\r\n  const cumulativePnL = await calculateCumulativePnLToDateAsync(targetDate, calendar, providedTrades);\r\n  const riskAmount = calculateRiskAmount(effectiveRisk, dynamicRiskSettings.account_balance, cumulativePnL);\r\n\r\n  if (tradeType === 'win') {\r\n    return Math.round(riskAmount * riskToReward);\r\n  } else {\r\n    return -Math.round(riskAmount);\r\n  }\r\n};\r\n\r\n/**\r\n * Normalize trade amount to a common risk basis for fair comparison\r\n */\r\nexport const normalizeTradeAmount = (\r\n  trade: Trade,\r\n  allTrades: Trade[],\r\n  dynamicRiskSettings: DynamicRiskSettings\r\n): number => {\r\n  // Skip normalization for trades without risk/reward or partials taken\r\n  if (!trade.risk_to_reward || trade.partials_taken || trade.trade_type === 'breakeven') {\r\n    return Math.abs(trade.amount);\r\n  }\r\n\r\n  // Calculate effective risk inline\r\n  if (!dynamicRiskSettings.risk_per_trade) {\r\n    return Math.abs(trade.amount);\r\n  }\r\n\r\n  let effectiveRisk = dynamicRiskSettings.risk_per_trade;\r\n\r\n  // If dynamic risk is enabled, check if threshold is met\r\n  if (dynamicRiskSettings.dynamic_risk_enabled &&\r\n      dynamicRiskSettings.increased_risk_percentage &&\r\n      dynamicRiskSettings.profit_threshold_percentage &&\r\n      dynamicRiskSettings.account_balance > 0) {\r\n\r\n    // Calculate cumulative P&L up to (but not including) this trade - use full timestamp comparison\r\n    const targetTime = new Date(trade.trade_date).getTime();\r\n\r\n    const cumulativePnL = allTrades\r\n      .filter(t => {\r\n        const tradeTime = new Date(t.trade_date).getTime();\r\n        return tradeTime < targetTime;\r\n      })\r\n      .reduce((sum, t) => sum + Number(t.amount), 0);\r\n\r\n    const profitPercentage = (cumulativePnL / dynamicRiskSettings.account_balance) * 100;\r\n    if (profitPercentage >= dynamicRiskSettings.profit_threshold_percentage) {\r\n      effectiveRisk = dynamicRiskSettings.increased_risk_percentage;\r\n    }\r\n  }\r\n\r\n  if (effectiveRisk === 0) {\r\n    return Math.abs(trade.amount);\r\n  }\r\n\r\n  const baseRiskPercentage = dynamicRiskSettings.risk_per_trade || 1;\r\n  // Calculate what the trade size would be with the base risk percentage\r\n  const normalizedAmount = (Math.abs(trade.amount) * baseRiskPercentage) / effectiveRisk;\r\n\r\n  return normalizedAmount;\r\n};\r\n\r\n/**\r\n * Check if dynamic risk is currently active\r\n */\r\nexport const isDynamicRiskActive = (\r\n  allTrades: Trade[],\r\n  dynamicRiskSettings: DynamicRiskSettings\r\n): boolean => {\r\n  if (!dynamicRiskSettings.dynamic_risk_enabled ||\r\n      !dynamicRiskSettings.increased_risk_percentage ||\r\n      !dynamicRiskSettings.profit_threshold_percentage ||\r\n      dynamicRiskSettings.account_balance <= 0) {\r\n    return false;\r\n  }\r\n\r\n  const currentEffectiveRisk = calculateCurrentEffectiveRiskPercentage(allTrades, dynamicRiskSettings);\r\n  return currentEffectiveRisk === dynamicRiskSettings.increased_risk_percentage;\r\n};\r\n\r\n/**\r\n * Calculate effective max daily drawdown based on dynamic risk settings\r\n */\r\nexport const calculateEffectiveMaxDailyDrawdown = (\r\n  maxDailyDrawdown: number,\r\n  allTrades: Trade[],\r\n  dynamicRiskSettings: DynamicRiskSettings\r\n): number => {\r\n  if (!isDynamicRiskActive(allTrades, dynamicRiskSettings)) {\r\n    return maxDailyDrawdown;\r\n  }\r\n\r\n  // Adjust drawdown limit proportionally to the risk increase\r\n  const riskRatio = dynamicRiskSettings.increased_risk_percentage! / (dynamicRiskSettings.risk_per_trade || 1);\r\n  return maxDailyDrawdown * riskRatio;\r\n};\r\n\r\n/**\r\n * Get dynamic risk status information for display\r\n */\r\nexport const getDynamicRiskStatus = (\r\n  allTrades: Trade[],\r\n  dynamicRiskSettings: DynamicRiskSettings\r\n): {\r\n  isActive: boolean;\r\n  currentRiskPercentage: number;\r\n  baseRiskPercentage: number;\r\n  profitPercentage: number;\r\n  thresholdMet: boolean;\r\n} => {\r\n  const currentRiskPercentage = calculateCurrentEffectiveRiskPercentage(allTrades, dynamicRiskSettings);\r\n  const baseRiskPercentage = dynamicRiskSettings.risk_per_trade || 0;\r\n  const isActive = isDynamicRiskActive(allTrades, dynamicRiskSettings);\r\n  \r\n  const totalPnL = allTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n  const profitPercentage = dynamicRiskSettings.account_balance > 0 \r\n    ? (totalPnL / dynamicRiskSettings.account_balance) * 100 \r\n    : 0;\r\n  \r\n  const thresholdMet = profitPercentage >= (dynamicRiskSettings.profit_threshold_percentage || 0);\r\n\r\n  return {\r\n    isActive,\r\n    currentRiskPercentage,\r\n    baseRiskPercentage,\r\n    profitPercentage,\r\n    thresholdMet\r\n  };\r\n};\r\n\r\n","import React from 'react';\r\nimport { Box, alpha, useTheme } from '@mui/material';\r\n\r\ninterface AnimatedBackgroundProps {\r\n  children?: React.ReactNode;\r\n}\r\n\r\n/**\r\n * Animated background mesh component with radial gradients and SVG pattern overlay.\r\n * Used across app pages for consistent visual styling.\r\n */\r\nconst AnimatedBackground: React.FC<AnimatedBackgroundProps> = ({ children }) => {\r\n  const theme = useTheme();\r\n  const isDark = theme.palette.mode === 'dark';\r\n\r\n  return (\r\n    <>\r\n      {/* Animated Background Mesh */}\r\n      <Box\r\n        sx={{\r\n          position: 'fixed',\r\n          top: 0,\r\n          left: 0,\r\n          right: 0,\r\n          bottom: 0,\r\n          zIndex: 0,\r\n          bgcolor: isDark ? 'background.default' : '#f8fafc',\r\n          background: isDark\r\n            ? `radial-gradient(circle at 20% 20%, ${alpha(theme.palette.primary.main, 0.12)} 0%, transparent 40%),\r\n               radial-gradient(circle at 80% 80%, ${alpha(theme.palette.secondary.main, 0.12)} 0%, transparent 40%),\r\n               radial-gradient(circle at 50% 50%, ${alpha(theme.palette.primary.dark, 0.05)} 0%, transparent 60%)`\r\n            : `linear-gradient(180deg, #f0f4f8 0%, #ffffff 50%, #f8fafc 100%),\r\n               radial-gradient(ellipse at 20% 0%, ${alpha(theme.palette.primary.main, 0.08)} 0%, transparent 50%),\r\n               radial-gradient(ellipse at 80% 100%, ${alpha(theme.palette.secondary.main, 0.06)} 0%, transparent 50%)`,\r\n          '&::before': {\r\n            content: '\"\"',\r\n            position: 'absolute',\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundImage: isDark\r\n              ? `url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")`\r\n              : `url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232d3748' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2v-4h4v-2H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")`,\r\n          },\r\n          pointerEvents: 'none',\r\n        }}\r\n      />\r\n      {children}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default AnimatedBackground;\r\n","import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';\r\nimport {\r\n  Box,\r\n  FormControl,\r\n  InputLabel,\r\n  Select,\r\n  MenuItem,\r\n  Snackbar,\r\n  Alert\r\n} from '@mui/material';\r\nimport { endOfDay, format, isSameDay } from 'date-fns';\r\nimport { Trade, Calendar } from '../../types/dualWrite';\r\nimport { BaseDialog } from '../common';\r\nimport * as calendarService from '../../services/calendarService';\r\nimport { DayHeader, TradeForm, NewTradeForm } from './';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { DEFAULT_PAIRS_TAG_GROUP, PendingImage, TradeImage } from './TradeForm';\r\nimport { GridImage, GridPendingImage } from './ImageGrid';\r\nimport { createNewTradeData } from '../../pages/TradeCalendarPage';\r\nimport {\r\n  calculateCumulativePnLToDateAsync,\r\n  calculateEffectiveRiskPercentageAsync,\r\n  calculateRiskAmount,\r\n  DynamicRiskSettings\r\n} from '../../utils/dynamicRiskUtils';\r\nimport { error, log, logger } from '../../utils/logger';\r\nimport { validateFiles, FILE_SIZE_LIMITS } from '../../utils/fileValidation';\r\nimport { formatTagsWithCapitalizedGroups } from '../../utils/tagColors';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\nimport { TradeRepository } from '../../services/repository/repositories/TradeRepository';\r\n\r\ninterface FormDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  newMainTrade?: NewTradeForm | null\r\n  trade_date: Date;\r\n  showForm: FormProps;\r\n  account_balance: number;\r\n\r\n  onAddTrade?: (trade: Trade & { id?: string }) => Promise<void>;\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n  onUpdateTradeProperty?: (tradeId: string, updateCallback: (trade: Trade) => Trade, createIfNotExists?: (tradeId: string) => Trade) => Promise<Trade | undefined>;\r\n  onDeleteTrades?: (tradeIds: string[]) => Promise<void>;\r\n  onAccountBalanceChange?: (balance: number) => void;\r\n  setZoomedImage: (url: string, allImages?: string[], initialIndex?: number) => void;\r\n  setNewMainTrade: (prev: (trade: NewTradeForm) => NewTradeForm | null) => void\r\n  onCancel: () => void;\r\n  dynamicRiskSettings: DynamicRiskSettings;\r\n  /** Calendar object with year_stats for cumulative P&L calculation */\r\n  calendar: Calendar;\r\n  tags: string[];\r\n  requiredTagGroups?: string[];\r\n  // Optional props for trade link navigation in notes\r\n  onOpenGalleryMode?: (trades: any[], initialTradeId?: string, title?: string) => void;\r\n  // Optional props for calendar selection (used when opened from Home.tsx)\r\n  calendars?: Calendar[];\r\n  onCalendarChange?: (calendarId: string) => void;\r\n}\r\n\r\ninterface FormProps {\r\n  open: boolean;\r\n  editTrade?: Trade | null;\r\n  createTempTrade: boolean;\r\n}\r\n\r\n\r\n\r\n\r\n// Helper function to process tags\r\nconst processTagsForSubmission = (tags: string[]): string[] => {\r\n  // Get any pending tag from the tags input field specifically (not the trade name input)\r\n  const tagInput = document.getElementById('trade-tags-input') as HTMLInputElement;\r\n  let pendingTag = '';\r\n  if (tagInput && tagInput.value.trim()) {\r\n    pendingTag = tagInput.value.trim();\r\n  }\r\n\r\n  if (pendingTag) {\r\n    return [...tags, pendingTag];\r\n  }\r\n  return tags;\r\n};\r\n\r\nexport const startOfNextDay = (trade_date: Date | string): Date => {\r\n  const nextDay = new Date(trade_date);\r\n  nextDay.setDate(nextDay.getDate() + 1);\r\n  return nextDay;\r\n}\r\n\r\nexport const createEditTradeData = (trade: Trade): NewTradeForm => {\r\n  return {\r\n    id: trade.id,\r\n    name: trade.name ? trade.name.replace(/^ /, '') : '',\r\n    amount: Math.abs(trade.amount),\r\n    trade_type: trade.trade_type,\r\n    entry_price: trade.entry_price || 0,\r\n    trade_date: trade.trade_date,\r\n    exit_price: trade.exit_price || 0,\r\n    stop_loss: trade.stop_loss || 0,\r\n    take_profit: trade.take_profit || 0,\r\n    tags: trade.tags || [],\r\n    risk_to_reward: trade.risk_to_reward || 0,\r\n    partials_taken: trade.partials_taken || false,\r\n    session: trade.session as '' | 'Asia' | 'London' | 'NY AM' | 'NY PM' || '',\r\n    notes: trade.notes || '',\r\n    pending_images: [],\r\n    is_temporary: trade.is_temporary,\r\n    economic_events: trade.economic_events || [],\r\n    uploaded_images: Array.isArray(trade.images) ? trade.images.filter(img => img).map((img, index) => ({\r\n      ...img,\r\n      // Ensure ID is present - generate one if missing to prevent delete issues\r\n      id: img.id || calendarService.generateImageId(),\r\n      // Ensure layout properties are explicitly preserved\r\n      row: img.row !== undefined ? img.row : index, // Each image gets its own row by default\r\n      column: img.column !== undefined ? img.column : 0, // Always in first column by default\r\n      column_width: img.column_width !== undefined ? img.column_width : 100 // Default to 100% for vertical layout\r\n    })) : [],\r\n\r\n  }\r\n}\r\n\r\nconst TradeFormDialog: React.FC<FormDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  newMainTrade,\r\n  setNewMainTrade,\r\n  trade_date,\r\n  account_balance,\r\n  showForm,\r\n  onCancel,\r\n  onAddTrade,\r\n  onTagUpdated,\r\n  onUpdateTradeProperty,\r\n  onDeleteTrades,\r\n  dynamicRiskSettings,\r\n  calendar,\r\n  tags = [],\r\n  requiredTagGroups = [],\r\n  onOpenGalleryMode,\r\n  calendars,\r\n  onCalendarChange\r\n}) => {\r\n\r\n  // State\r\n\r\n  const [editingTrade, setEditingTrade] = useState<Trade | null>(null);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [isCreatingEmptyTrade, setIsCreatingEmptyTrade] = useState(false);\r\n  const [newTrade, setNewTrade] = useState<NewTradeForm | null>(null);\r\n  const [errorMessage, setErrorMessage] = useState<string>('');\r\n  const [showError, setShowError] = useState(false);\r\n\r\n  // Pre-calculated cumulative P&L and effective risk (fetched async when dialog opens)\r\n  const [precalculatedPnL, setPrecalculatedPnL] = useState<number>(0);\r\n  const [precalculatedRiskPercentage, setPrecalculatedRiskPercentage] = useState<number>(0);\r\n  const [isLoadingPrecalculatedValues, setIsLoadingPrecalculatedValues] = useState(false);\r\n  const [dayTotalPnL, setDayTotalPnL] = useState<number>(0);\r\n\r\n  // Original risk amount derived from editing trade (preserves historical calculation context)\r\n  // For wins: riskAmount = amount / R:R, For losses: riskAmount = |amount|\r\n  const [originalRiskAmount, setOriginalRiskAmount] = useState<number | null>(null);\r\n\r\n  // Track if component is mounted for safe state updates after async operations\r\n  const isMountedRef = useRef(true);\r\n  useEffect(() => {\r\n    isMountedRef.current = true;\r\n    return () => {\r\n      isMountedRef.current = false;\r\n    };\r\n  }, []);\r\n\r\n  // Ref to guard against double invocation of createEmptyTrade (React StrictMode, etc.)\r\n  const isCreatingEmptyTradeRef = useRef(false);\r\n\r\n\r\n\r\n  // Check if calendar selection is required (when calendars prop is provided)\r\n  const isCalendarSelectionMode = !!calendars;\r\n  const isCalendarSelected = isCalendarSelectionMode ? !!(calendar?.id) : true;\r\n\r\n  // Use primitive values for stable dependencies\r\n  const tradeDateTimestamp = trade_date instanceof Date ? trade_date.getTime() : new Date(trade_date).getTime();\r\n  const newTradeDateTimestamp = newTrade?.trade_date instanceof Date\r\n    ? newTrade.trade_date.getTime()\r\n    : newTrade?.trade_date ? new Date(newTrade.trade_date).getTime() : null;\r\n  const calendarId = calendar?.id;\r\n\r\n  // Pre-fetch cumulative P&L when dialog opens or trade_date changes\r\n  useEffect(() => {\r\n    const fetchPrecalculatedValues = async () => {\r\n      if (!open || !calendar || !calendarId) return;\r\n\r\n      setIsLoadingPrecalculatedValues(true);\r\n      try {\r\n        let targetDateForPnL = newTrade?.trade_date || trade_date;\r\n\r\n        // If adding a new trade and the time is 00:00:00 (default from calendar click),\r\n        // we want to include all trades already recorded for that day for the risk calculation.\r\n        // This makes the risk basis consistent with the \"Current Total\" the user sees.\r\n        if (!showForm.editTrade &&\r\n          targetDateForPnL.getHours() === 0 &&\r\n          targetDateForPnL.getMinutes() === 0 &&\r\n          targetDateForPnL.getSeconds() === 0) {\r\n\r\n          const now = new Date();\r\n          if (isSameDay(targetDateForPnL, now)) {\r\n            // If it's today, use current time\r\n            targetDateForPnL = now;\r\n          } else {\r\n            // For past days, use the end of the day to include everything\r\n            targetDateForPnL = endOfDay(targetDateForPnL);\r\n          }\r\n        }\r\n\r\n        const [pnl, riskPct] = await Promise.all([\r\n          calculateCumulativePnLToDateAsync(targetDateForPnL, calendar),\r\n          calculateEffectiveRiskPercentageAsync(targetDateForPnL, calendar, dynamicRiskSettings)\r\n        ]);\r\n\r\n        if (isMountedRef.current) {\r\n          setPrecalculatedPnL(pnl);\r\n          setPrecalculatedRiskPercentage(riskPct);\r\n        }\r\n      } catch (err) {\r\n        logger.error('Error fetching precalculated values:', err);\r\n      } finally {\r\n        if (isMountedRef.current) {\r\n          setIsLoadingPrecalculatedValues(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    fetchPrecalculatedValues();\r\n  }, [open, calendarId, tradeDateTimestamp, newTradeDateTimestamp, showForm.editTrade]);\r\n\r\n  // Fetch day's total P&L when dialog opens or trade_date changes\r\n  useEffect(() => {\r\n    const fetchDayTotalPnL = async () => {\r\n      if (!open || !calendar || !calendarId) return;\r\n\r\n      try {\r\n        const tradeRepo = new TradeRepository();\r\n        const dayTrades = await tradeRepo.getTradesByDay(calendarId, trade_date, ['amount']);\r\n        const total = dayTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n        if (isMountedRef.current) {\r\n          setDayTotalPnL(total);\r\n        }\r\n      } catch (error) {\r\n        logger.error('Error fetching day total P&L:', error);\r\n        if (isMountedRef.current) {\r\n          setDayTotalPnL(0);\r\n        }\r\n      }\r\n    };\r\n\r\n    fetchDayTotalPnL();\r\n  }, [open, tradeDateTimestamp, calendarId]);\r\n\r\n  // Track previous showForm state to avoid unnecessary handleAddClick calls\r\n  const prevShowFormRef = useRef<FormProps | null>(null);\r\n\r\n  // Function to create empty trade - defined before useEffect that uses it\r\n  const createEmptyTrade = useCallback(async () => {\r\n    // Guard against double invocation (React StrictMode, rapid state changes)\r\n    if (isCreatingEmptyTradeRef.current) {\r\n      logger.warn('createEmptyTrade already in progress, skipping');\r\n      return;\r\n    }\r\n    isCreatingEmptyTradeRef.current = true;\r\n\r\n    setEditingTrade(null);\r\n    setOriginalRiskAmount(null); // Clear original risk amount for new trades\r\n    // Set creating empty trade state to true to disable cancel/close buttons\r\n    setIsCreatingEmptyTrade(true);\r\n    // Create a temporary trade object to display in the UI\r\n\r\n    // Create an empty trade state WITHOUT saving to DB yet\r\n    try {\r\n      // Initialize form with a generated ID so we have one ready if the user adds images\r\n      // but DO NOT call onAddTrade yet. The trade stays client-side until saved or an image is added.\r\n      const data = createNewTradeData();\r\n      const generatedId = uuidv4();\r\n\r\n      setNewTrade(() => ({\r\n        ...data,\r\n        id: generatedId,\r\n        is_temporary: false, // Start as false so handleSubmit treats it as a new permanent trade unless images make it temp in DB\r\n        name: 'New Trade',\r\n        trade_date: trade_date // Initialize with the selected date from DayDialog\r\n      }));\r\n\r\n    } catch (error) {\r\n      logger.error('Error initializing empty trade:', error);\r\n      // We are no longer showing local snackbar for this, as the parent component handles global notifications\r\n      // or we accept that this error is logged but not flashed to the user in the dialog context immediately.\r\n\r\n      // Still show the form, but without the temporary trade\r\n      setNewTrade(prev => ({\r\n        ...prev!,\r\n        is_temporary: false\r\n      }));\r\n    } finally {\r\n      // Re-enable cancel/close buttons regardless of success or failure\r\n      setIsCreatingEmptyTrade(false);\r\n      isCreatingEmptyTradeRef.current = false;\r\n    }\r\n  }, [trade_date]);\r\n\r\n  useEffect(() => {\r\n    // Only call handleAddClick when showForm changes from not meeting conditions to meeting them\r\n    const shouldCreateTempTrade = showForm.open && showForm.createTempTrade;\r\n    const prevShouldCreateTempTrade = prevShowFormRef.current?.open && prevShowFormRef.current?.createTempTrade;\r\n\r\n    if (shouldCreateTempTrade && (!prevShowFormRef.current || !prevShouldCreateTempTrade)) {\r\n      createEmptyTrade();\r\n    }\r\n    else if (showForm.editTrade) {\r\n      const prevEditTradeId = prevShowFormRef.current?.editTrade?.id;\r\n      const currentEditTradeId = showForm.editTrade.id;\r\n      const wasDialogClosed = !prevShowFormRef.current?.open;\r\n      const isDialogOpening = wasDialogClosed && showForm.open;\r\n      const isSwitchingTrade = prevEditTradeId !== currentEditTradeId;\r\n\r\n      // Initialize form data when:\r\n      // 1. Dialog is opening (from closed state) - need fresh data\r\n      // 2. Switching to a different trade (by ID)\r\n      //\r\n      // Do NOT reinitialize when parent updates showForm.editTrade with fresh\r\n      // database data during an active edit session - this would lose pending images\r\n      if (isDialogOpening || isSwitchingTrade) {\r\n        const trade = showForm.editTrade;\r\n        setEditingTrade(trade);\r\n        setNewTrade(createEditTradeData(trade));\r\n\r\n        // Derive and store the original risk amount from the trade\r\n        // This preserves the historical calculation context even if year_stats changed\r\n        if (trade.risk_to_reward && trade.risk_to_reward > 0) {\r\n          // For wins: riskAmount = amount / R:R\r\n          // For losses: riskAmount = |amount|\r\n          const derivedRiskAmount = trade.trade_type === 'win'\r\n            ? Math.abs(trade.amount) / trade.risk_to_reward\r\n            : Math.abs(trade.amount);\r\n          setOriginalRiskAmount(derivedRiskAmount);\r\n        } else {\r\n          setOriginalRiskAmount(null);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update previous showForm ref\r\n    prevShowFormRef.current = showForm;\r\n  }, [showForm, createEmptyTrade]);\r\n\r\n  useEffect(() => {\r\n    if (newMainTrade) {\r\n      setNewTrade(newMainTrade!);\r\n    }\r\n  }, [newMainTrade]);\r\n\r\n\r\n  // Derived state \r\n  const allTags = useMemo(() => {\r\n    return tags.filter((tag) => !tag.startsWith('Partials:'))\r\n  }, [tags]);\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n  const showErrorSnackbar = (message: string) => {\r\n    setErrorMessage(message);\r\n    setShowError(true);\r\n  };\r\n\r\n  const handleCloseError = () => {\r\n    setShowError(false);\r\n  };\r\n\r\n  const resetForm = () => {\r\n    // Release object URLs to avoid memory leaks\r\n    if (newTrade) {\r\n      newTrade.pending_images.forEach(image => {\r\n        URL.revokeObjectURL(image.preview);\r\n      });\r\n    }\r\n\r\n    setEditingTrade(null);\r\n    setOriginalRiskAmount(null); // Clear original risk amount\r\n    setNewMainTrade(() => null);\r\n  };\r\n\r\n\r\n\r\n  // Function to update a specific property of a trade\r\n  const handleUpdateTradeProperty = async (tradeId: string, updateCallback: (trade: Trade) => Trade, createIfNotExists?: (tradeId: string) => Trade) => {\r\n    if (!onUpdateTradeProperty) return;\r\n    try {\r\n      return onUpdateTradeProperty(tradeId, updateCallback, createIfNotExists);\r\n    } catch (error) {\r\n      logger.error('Error updating trade property:', error);\r\n      // Removed local snackbar call, rely on global handling or specific error UI if needed\r\n    }\r\n  };\r\n\r\n  // Form handlers\r\n  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setNewTrade(prev => ({ ...prev!, name: e.target.value }));\r\n  };\r\n\r\n  const handleAmountChange = (amount: number) => {\r\n    setNewTrade(prev => ({ ...prev!, amount: amount }));\r\n  };\r\n\r\n  const handleTypeChange = (e: any) => {\r\n    setNewTrade(prev => ({ ...prev!, trade_type: e.target.value as 'win' | 'loss' | 'breakeven' }));\r\n  };\r\n\r\n  const handleEntryChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setNewTrade(prev => ({ ...prev!, entry_price: parseFloat(e.target.value) || 0 }));\r\n  };\r\n\r\n  const handleExitChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setNewTrade(prev => ({ ...prev!, exit_price: parseFloat(e.target.value) || 0 }));\r\n  };\r\n\r\n  const handleStopLossChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setNewTrade(prev => ({ ...prev!, stop_loss: parseFloat(e.target.value) || 0 }));\r\n  };\r\n\r\n  const handleTakeProfitChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setNewTrade(prev => ({ ...prev!, take_profit: parseFloat(e.target.value) || 0 }));\r\n  };\r\n\r\n  const handleDateChange = (newDate: Date | null) => {\r\n    if (newDate) {\r\n      setNewTrade(prev => ({ ...prev!, trade_date: newDate }));\r\n    }\r\n  };\r\n\r\n  const handleRiskToRewardChange = (risk_to_reward: number) => {\r\n    setNewTrade(prev => ({ ...prev!, risk_to_reward: risk_to_reward }));\r\n  };\r\n\r\n\r\n  const calculateFinalAmount = (trade: NewTradeForm): number => {\r\n    // Only use risk-based calculation if risk per trade is enabled AND risk_to_reward is set AND not taking partials\r\n    const isRiskPerTradeEnabled = dynamicRiskSettings.risk_per_trade && dynamicRiskSettings.risk_per_trade > 0;\r\n\r\n    if (isRiskPerTradeEnabled && trade.risk_to_reward && trade.risk_to_reward > 0 && !trade.partials_taken) {\r\n      const rr = trade.risk_to_reward;\r\n      if (!isNaN(rr)) {\r\n        // Use precalculated values from useEffect (no need to pass cumulativePnL)\r\n        const calculatedAmount = calculateAmountFromRiskToReward(rr);\r\n\r\n        // Apply sign based on trade type\r\n        return trade.trade_type === 'loss' ? -Math.abs(calculatedAmount) : Math.abs(calculatedAmount);\r\n      }\r\n    }\r\n\r\n    // Otherwise use the amount from the form\r\n    const amount = trade.amount || 0;\r\n    return trade.trade_type === 'loss' ? -Math.abs(amount) : Math.abs(amount);\r\n  };\r\n\r\n  const createFinalTradeData = (newTrade: NewTradeForm, trade_date: Date): Trade => {\r\n    let finalAmount = calculateFinalAmount(newTrade);\r\n    logger.log(`trade final amount ${finalAmount}`)\r\n\r\n    // Process tags to ensure proper formatting\r\n    let finalTags = processTagsForSubmission([...newTrade.tags]);\r\n\r\n    // Add Partials tag if partialsTaken is true\r\n    if (newTrade.partials_taken) {\r\n      // Remove any existing Partials tags\r\n      finalTags = finalTags.filter((tag: string) => !tag.startsWith('Partials:'));\r\n      finalTags.push('Partials:Yes');\r\n    }\r\n\r\n    const currentDate = new Date();\r\n\r\n    // Use the trade's date if it exists (when editing), otherwise use the provided date\r\n    const tradeDate = newTrade.trade_date || trade_date;\r\n\r\n    // Note: Economic events are now automatically fetched by the TradeRepository layer\r\n    // during trade creation/update based on session, date, and tags\r\n\r\n    return {\r\n      id: newTrade.id || uuidv4(),\r\n      is_temporary: newTrade.is_temporary,\r\n      trade_date: new Date(tradeDate.getFullYear(), tradeDate.getMonth(), tradeDate.getDate(),\r\n        currentDate.getHours(), currentDate.getMinutes(), currentDate.getSeconds()),\r\n      trade_type: newTrade.trade_type,\r\n      amount: finalAmount,\r\n      ...(newTrade.name && { name: newTrade.name }),\r\n      ...(newTrade.entry_price && { entry_price: newTrade.entry_price }),\r\n      ...(newTrade.exit_price && { exit_price: newTrade.exit_price }),\r\n      ...(newTrade.stop_loss && { stop_loss: newTrade.stop_loss }),\r\n      ...(newTrade.take_profit && { take_profit: newTrade.take_profit }),\r\n      ...(finalTags.length > 0 && { tags: finalTags }),\r\n      ...(newTrade.risk_to_reward && { risk_to_reward: newTrade.risk_to_reward }),\r\n      partials_taken: newTrade.partials_taken,\r\n      session: newTrade.session || '', // Always include session\r\n      ...(newTrade.notes && { notes: newTrade.notes }),\r\n      images: newTrade.uploaded_images || [],\r\n      // Economic events will be fetched automatically by TradeRepository\r\n      ...(newTrade.economic_events && newTrade.economic_events.length > 0 && { economic_events: newTrade.economic_events }),\r\n      calendar_id: calendar.id!,\r\n      user_id: '', // Will be set by the service layer\r\n      created_at: new Date(),\r\n      updated_at: new Date()\r\n    }\r\n  }\r\n\r\n  // Calculate amount based on risk per trade (as percentage of account balance) and risk-to-reward ratio\r\n  // When editing: uses the original risk amount derived from the trade to preserve historical context\r\n  // When creating: uses precalculated values from current cumulative P&L\r\n  const calculateAmountFromRiskToReward = (risk_to_reward: number, alternatePnL?: number): number => {\r\n    if (!newTrade || !risk_to_reward || !account_balance || newTrade.trade_type === 'breakeven') return 0;\r\n\r\n    // Use original risk amount when editing (preserves the historical calculation context)\r\n    // For new trades, calculate from current cumulative P&L\r\n    let riskAmount: number;\r\n    if (originalRiskAmount !== null) {\r\n      // Editing: use the derived original risk amount\r\n      riskAmount = originalRiskAmount;\r\n    } else {\r\n      // New trade: calculate from current state\r\n      const effectiveRiskPercentage = precalculatedRiskPercentage || dynamicRiskSettings.risk_per_trade || 0;\r\n      const currentPnL = alternatePnL !== undefined ? alternatePnL : precalculatedPnL;\r\n      riskAmount = calculateRiskAmount(effectiveRiskPercentage, account_balance, currentPnL);\r\n    }\r\n\r\n    // For win trades: risk amount * R:R\r\n    // For loss trades: risk amount\r\n    const riskToRewardValue = Number(risk_to_reward);\r\n    const amount = newTrade.trade_type === 'win'\r\n      ? Math.round(riskAmount * riskToRewardValue)\r\n      : Math.round(riskAmount);\r\n\r\n    return amount;\r\n  };\r\n\r\n\r\n\r\n\r\n  const handlePartialsTakenChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const partials_taken = e.target.checked;\r\n    setNewTrade(prev => ({ ...prev!, partials_taken }));\r\n  };\r\n\r\n  const handleSessionChange = (e: any) => {\r\n    setNewTrade(prev => ({ ...prev!, session: e.target.value }));\r\n  };\r\n\r\n  const handleNotesChange = (value: string) => {\r\n    setNewTrade(prev => ({ ...prev!, notes: value }));\r\n  };\r\n\r\n  const handleTagsChange = (_event: React.SyntheticEvent, newValue: string[]) => {\r\n    // Capitalize tag groups before saving\r\n    const formattedTags = formatTagsWithCapitalizedGroups(newValue);\r\n    setNewTrade(prev => ({ ...prev!, tags: formattedTags }));\r\n  };\r\n\r\n\r\n\r\n\r\n  const handleImageUpload = async (files: FileList) => {\r\n    // Validate files using utility function\r\n    const { validFiles, oversizedFiles, invalidTypeFiles } = validateFiles(files, FILE_SIZE_LIMITS.IMAGE_1MB);\r\n\r\n    // Show error messages for rejected files\r\n    const errorMessages: string[] = [];\r\n\r\n    if (oversizedFiles.length > 0) {\r\n      errorMessages.push(`The following files exceed the 1MB size limit: ${oversizedFiles.join(', ')}`);\r\n    }\r\n\r\n    if (invalidTypeFiles.length > 0) {\r\n      errorMessages.push(`The following files are not supported image types: ${invalidTypeFiles.join(', ')}`);\r\n    }\r\n\r\n    if (errorMessages.length > 0) {\r\n      // Log errors instead of showing snackbar\r\n      logger.error('File validation errors:', errorMessages.join(' '));\r\n    }\r\n\r\n    // If no valid files, return early\r\n    if (validFiles.length === 0) {\r\n      return;\r\n    }\r\n\r\n    const getDimensions = (url: string): Promise<{ width: number; height: number }> => {\r\n      return new Promise((resolve) => {\r\n        const img = new Image();\r\n        img.onload = () => {\r\n          resolve({\r\n            width: img.width,\r\n            height: img.height,\r\n          });\r\n        };\r\n        img.src = url;\r\n      });\r\n    };\r\n\r\n    const newPendingImages = await Promise.all(\r\n      validFiles.map(async (file) => {\r\n        const preview = URL.createObjectURL(file);\r\n        const dimensions = await getDimensions(preview);\r\n\r\n        return {\r\n          id: calendarService.generateImageId(file),\r\n          file,\r\n          preview,\r\n          caption: '',\r\n          width: dimensions.width,\r\n          height: dimensions.height\r\n        };\r\n      })\r\n    );\r\n\r\n    // Add the new images to the state with grid layout information\r\n    let pending_images: PendingImage[] = []\r\n    setNewTrade((prev) => {\r\n      const existingPendingImages = prev!.pending_images;\r\n      const existingUploadedImages = prev!.uploaded_images;\r\n\r\n      // Find the highest row value to place new images below existing ones\r\n      let maxRow = -1;\r\n\r\n      [...existingPendingImages, ...existingUploadedImages].forEach(img => {\r\n        if (img.row !== undefined && img.row > maxRow) maxRow = img.row;\r\n      });\r\n\r\n      // Assign row and column to new images - each in its own row\r\n      const newImagesWithLayout = newPendingImages.map((img, index) => {\r\n        // Place each new image in its own row below all existing images\r\n        const newRow = maxRow + 1 + index;\r\n\r\n        return {\r\n          ...img,\r\n          row: newRow,\r\n          column: 0, // Always place in first column\r\n          column_width: 100 // Full width for the row\r\n        };\r\n      });\r\n      pending_images = [...existingPendingImages, ...newImagesWithLayout]\r\n      return {\r\n        ...prev!,\r\n        pending_images: pending_images,\r\n      };\r\n    });\r\n\r\n    // Start uploading the images if we have a temporary trade ID\r\n    try {\r\n\r\n      // First, ensure the trade exists in the database and is in the cached trades\r\n      const trade = await handleUpdateTradeProperty(newTrade!.id!!, (trade) => {\r\n        // Calculate row and column for new images\r\n        const existingImages = trade.images || [];\r\n        // Find the highest row value to place new images below existing ones\r\n        let maxRow = -1;\r\n\r\n        existingImages.forEach(img => {\r\n          if (img.row !== undefined && img.row > maxRow) maxRow = img.row;\r\n        });\r\n\r\n        // Assign row and column to new images - each in its own row\r\n        const newImages = newPendingImages.map((img, index) => {\r\n          // Place each new image in its own row below all existing images\r\n          const newRow = maxRow + 1 + index;\r\n\r\n          return {\r\n            url: img.preview,\r\n            pending: true,\r\n            calendar_id: calendar.id!,\r\n            id: img.id,\r\n            width: img.width,\r\n            height: img.height,\r\n            caption: img.caption,\r\n            row: newRow,\r\n            column: 0, // Always place in first column\r\n            column_width: 100 // Full width for the row\r\n          };\r\n        });\r\n\r\n        return {\r\n          ...trade,\r\n          images: [...existingImages, ...newImages]\r\n        };\r\n      },\r\n        (tradeid: string) => {\r\n          // setIsCreatingEmptyTrade(true);\r\n          // Create a temporary trade object if it doesnt exist\r\n          // Note: Economic events will be added later via async update \r\n          const currentDate = new Date();\r\n          const tradeDate = newTrade!.trade_date || trade_date;\r\n          const finalAmount = calculateFinalAmount(newTrade!);\r\n          let finalTags = processTagsForSubmission([...newTrade!.tags]);\r\n\r\n          if (newTrade!.partials_taken) {\r\n            finalTags = finalTags.filter((tag: string) => !tag.startsWith('Partials:'));\r\n            finalTags.push('Partials:Yes');\r\n          }\r\n\r\n          return {\r\n            id: tradeid,\r\n            is_temporary: true,\r\n            trade_date: new Date(tradeDate.getFullYear(), tradeDate.getMonth(), tradeDate.getDate(),\r\n              currentDate.getHours(), currentDate.getMinutes(), currentDate.getSeconds()),\r\n            trade_type: newTrade!.trade_type,\r\n            amount: finalAmount,\r\n            name: newTrade!.name || 'New Trade',\r\n            ...(newTrade!.entry_price && { entry_price: newTrade!.entry_price }),\r\n            ...(newTrade!.exit_price && { exit_price: newTrade!.exit_price }),\r\n            ...(newTrade!.stop_loss && { stop_loss: newTrade!.stop_loss }),\r\n            ...(newTrade!.take_profit && { take_profit: newTrade!.take_profit }),\r\n            ...(finalTags.length > 0 && { tags: finalTags }),\r\n            ...(newTrade!.risk_to_reward && { risk_to_reward: newTrade!.risk_to_reward }),\r\n            partials_taken: newTrade!.partials_taken,\r\n            session: newTrade!.session || '', // Always include session\r\n            ...(newTrade!.notes && { notes: newTrade!.notes }),\r\n            images: newTrade!.uploaded_images || [],\r\n            calendar_id: calendar.id!,\r\n            user_id: '', // Will be set by the service layer\r\n            created_at: new Date(),\r\n            updated_at: new Date()\r\n          };\r\n        });\r\n\r\n      if (trade && trade.is_temporary) {\r\n        setNewTrade(prev => {\r\n          return {\r\n            ...prev!,\r\n            is_temporary: true\r\n          };\r\n        })\r\n      }\r\n\r\n      // Upload all images in parallel\r\n      const uploadPromises = newPendingImages.map(image =>\r\n        uploadImageAndTrackProgress(image, newTrade!.id!!, pending_images)\r\n      );\r\n\r\n      // Wait for all uploads to complete (success or fail)\r\n      const uploadedResults = await Promise.all(uploadPromises);\r\n\r\n      // Filter out successful uploads (non-null)\r\n      const successfulUploads = uploadedResults.filter((img): img is TradeImage => img !== null);\r\n\r\n      // If we have successful uploads, perform ONE batch update to the database\r\n      if (successfulUploads.length > 0 && calendar?.id && newTrade!.id!!) {\r\n        try {\r\n          await handleUpdateTradeProperty(newTrade!.id!!, (trade) => {\r\n            const existingImages = trade.images || [];\r\n\r\n            // Create a map of updated images for O(1) lookup\r\n            const updatedImagesMap = new Map(successfulUploads.map(img => [img.id, img]));\r\n\r\n            // Create a set of existing image IDs for quick lookup\r\n            const existingImageIds = new Set(existingImages.map(img => img.id));\r\n\r\n            // Map over existing images: if it's one of the successfully uploaded ones, update it\r\n            const mergedImages = existingImages.map(existingImg => {\r\n              if (updatedImagesMap.has(existingImg.id)) {\r\n                const updatedImg = updatedImagesMap.get(existingImg.id)!;\r\n                return {\r\n                  ...updatedImg,\r\n                  // Preserve layout info (should already be in updatedImg but safety check)\r\n                  row: existingImg.row !== undefined ? existingImg.row : updatedImg.row,\r\n                  column: existingImg.column !== undefined ? existingImg.column : updatedImg.column,\r\n                  column_width: existingImg.column_width !== undefined ? existingImg.column_width : updatedImg.column_width\r\n                };\r\n              }\r\n              return existingImg;\r\n            });\r\n\r\n            // IMPORTANT: Add any uploaded images that aren't already in the database\r\n            // This handles race conditions where the first update (adding pending images)\r\n            // hasn't propagated to the database yet\r\n            const newImagesToAdd = successfulUploads.filter(img => !existingImageIds.has(img.id));\r\n            if (newImagesToAdd.length > 0) {\r\n              logger.log(`Adding ${newImagesToAdd.length} images that weren't in database yet (race condition protection)`);\r\n            }\r\n\r\n            return {\r\n              ...trade,\r\n              images: [...mergedImages, ...newImagesToAdd]\r\n            };\r\n          });\r\n          logger.log(`Updated trade with ${successfulUploads.length} uploaded images`);\r\n        } catch (updateError) {\r\n          logger.error('Error batch updating trade with new images:', updateError);\r\n          // Removed local snackbar call\r\n        }\r\n      }\r\n\r\n    } catch (error) {\r\n      logger.error('Error processing image uploads:', error);\r\n    }\r\n  };\r\n\r\n  // Function to upload a single image, update local state, AND return the uploaded image object\r\n  // Does NOT update the database directly\r\n  const uploadImageAndTrackProgress = async (image: PendingImage, tradeId: string, pending_images: PendingImage[]): Promise<TradeImage | null> => {\r\n    try {\r\n      // Upload the image\r\n      const uploadedImage: TradeImage = await calendarService.uploadTradeImage(\r\n        calendar.id!,\r\n        image.id!!,\r\n        image.file,\r\n        image.width,\r\n        image.height,\r\n        image.caption\r\n      );\r\n\r\n      // Once upload is complete, move from pending_images to uploadedImages\r\n      // Find the original pending image to get its layout information\r\n      const originalPendingImage = pending_images.find(img => img.id === image.id);\r\n      // Preserve layout information\r\n      const updatedImage = {\r\n        ...uploadedImage,\r\n        caption: image.caption,\r\n        row: originalPendingImage?.row || 0,\r\n        column: originalPendingImage?.column || 0,\r\n        column_width: originalPendingImage?.column_width || 100\r\n      };\r\n\r\n      // Update local state - but only if image wasn't deleted during upload\r\n      let wasDeleted = false;\r\n      setNewTrade(prev => {\r\n        const newPendingImages = [...prev!.pending_images];\r\n        // Check if the image still exists in pending_images\r\n        const imageIndex = newPendingImages.findIndex(img => img.id === image.id);\r\n\r\n        if (imageIndex === -1) {\r\n          // Image was deleted during upload - don't add to uploaded_images\r\n          wasDeleted = true;\r\n          logger.log(`Image ${image.id} was deleted during upload, skipping`);\r\n          return prev;\r\n        }\r\n\r\n        // Remove from pending_images\r\n        newPendingImages.splice(imageIndex, 1);\r\n\r\n        // Find the image where pending is true in the uploadedImages list\r\n        // Setting pending to the image is useful for show shimmer in tradeDetail\r\n        const newUploadedImages = [...prev!.uploaded_images];\r\n        const uploadedIndex = newUploadedImages.findIndex(img => img.id === image.id);\r\n        if (uploadedIndex !== -1 && newUploadedImages[uploadedIndex].pending) {\r\n          newUploadedImages.splice(uploadedIndex, 1);\r\n        }\r\n\r\n        return {\r\n          ...prev!,\r\n          pending_images: newPendingImages,\r\n          uploaded_images: [...newUploadedImages, updatedImage]\r\n        };\r\n      });\r\n\r\n      // Return null if image was deleted so database update skips it\r\n      return wasDeleted ? null : updatedImage;\r\n\r\n    } catch (error) {\r\n      logger.error(`Error uploading image ${image.id}:`, error);\r\n\r\n      // Remove failed image from pending (local state)\r\n      setNewTrade(prev => ({\r\n        ...prev!,\r\n        pending_images: prev!.pending_images.filter((img) => img.id !== image.id)\r\n      }));\r\n\r\n      // Also remove failed image from database\r\n      if (newTrade?.id) {\r\n        handleUpdateTradeProperty(newTrade.id, (trade) => ({\r\n          ...trade,\r\n          images: (trade.images || []).filter(img => img && img.id !== image.id)\r\n        })).then(() => {\r\n          logger.log(`Removed failed upload ${image.id} from database`);\r\n        }).catch(err => {\r\n          logger.error(`Failed to remove failed upload ${image.id} from database:`, err);\r\n        });\r\n      }\r\n\r\n      return null;\r\n    }\r\n  };\r\n\r\n\r\n  const handleImageCaptionChange = async (index: number, caption: string, isPending: boolean) => {\r\n    try {\r\n      if (isPending) {\r\n        // Update caption for pending image\r\n        setNewTrade(prev => ({\r\n          ...prev!,\r\n          pending_images: prev!.pending_images.map((img, i) =>\r\n            i === index ? { ...img, caption } : img\r\n          )\r\n        }));\r\n      } else {\r\n        // Update caption for uploaded image\r\n        setNewTrade(prev => ({\r\n          ...prev!,\r\n          uploaded_images: prev!.uploaded_images.map((img, i) =>\r\n            i === index ? { ...img, caption } : img\r\n          )\r\n        }));\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error in handleImageCaptionChange:', error);\r\n      // Don't show error to user for caption changes as it's not critical\r\n    }\r\n  };\r\n\r\n\r\n  const handleImageRemove = async (index: number, isPending: boolean) => {\r\n    try {\r\n      // Guard against invalid index (can happen if image ID matching fails)\r\n      if (index < 0) {\r\n        logger.error('handleImageRemove called with invalid index:', index, 'isPending:', isPending);\r\n        return;\r\n      }\r\n\r\n      if (isPending) {\r\n        const image = newTrade!.pending_images[index];\r\n        if (!image) {\r\n          logger.error('Pending image not found at index:', index);\r\n          return;\r\n        }\r\n\r\n        const imageId = image.id;\r\n\r\n        // Release object URL to avoid memory leaks\r\n        URL.revokeObjectURL(image.preview);\r\n\r\n        // Update local state - remove from pending_images\r\n        // When upload completes, it will see the image is gone and skip adding it\r\n        setNewTrade(prev => ({\r\n          ...prev!,\r\n          pending_images: prev!.pending_images.filter((_, i) => i !== index)\r\n        }));\r\n\r\n        // Also remove from database - the image may have been added with pending:true\r\n        if (imageId && newTrade?.id) {\r\n          handleUpdateTradeProperty(newTrade.id, (trade) => ({\r\n            ...trade,\r\n            images: (trade.images || []).filter(img => img && img.id !== imageId)\r\n          })).then(() => {\r\n            logger.log(`Removed pending image ${imageId} from database`);\r\n          }).catch(err => {\r\n            logger.error(`Failed to remove pending image ${imageId} from database:`, err);\r\n          });\r\n        }\r\n      } else {\r\n        const image = newTrade!.uploaded_images[index];\r\n        if (!image) {\r\n          logger.error('Uploaded image not found at index:', index);\r\n          return;\r\n        }\r\n\r\n        // Update local state for immediate UI feedback\r\n        // The actual database update happens when user clicks Save\r\n        // Edge function (handle-trade-changes) will clean up removed images from storage\r\n        setNewTrade(prev => ({\r\n          ...prev!,\r\n          uploaded_images: prev!.uploaded_images.filter((_, i) => i !== index)\r\n        }));\r\n\r\n        logger.log(`Image ${image.id} removed from UI - will be deleted from storage on save`);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error in handleImageRemove:', error);\r\n      // showErrorSnackbar('Failed to remove image. Please try again.');\r\n    }\r\n  };\r\n  // Handle image reordering\r\n  const handleImagesReordered = async (images: Array<GridImage | GridPendingImage>) => {\r\n    logger.log(\"handleImagesReordered called with images:\",\r\n      images.map(img => ({ id: img.id, row: img.row, column: img.column, column_width: img.column_width })));\r\n\r\n    // Separate pending and uploaded images\r\n    const pending_images = images.filter(img => 'file' in img) as GridPendingImage[];\r\n    const uploadedImages = images.filter(img => !('file' in img)) as GridImage[];\r\n\r\n    // Update local state\r\n    setNewTrade(prev => ({\r\n      ...prev!,\r\n      pending_images: pending_images as PendingImage[],\r\n      uploaded_images: uploadedImages\r\n    }));\r\n\r\n  };\r\n\r\n  // Handle tag updates from the edit dialog\r\n  const handleTagUpdated = async (oldTag: string, newTag: string) => {\r\n    // Update the tags in the current form if needed\r\n    if (newTrade && newTrade.tags.includes(oldTag)) {\r\n      setNewTrade(prev => {\r\n        if (!prev) return prev;\r\n        return {\r\n          ...prev,\r\n          tags: prev.tags.map(tag => tag === oldTag ? newTag : tag).filter((tag: string) => tag !== '')\r\n        };\r\n      });\r\n    }\r\n\r\n    // Update the cached trades list\r\n    if (onTagUpdated) {\r\n      return await onTagUpdated(oldTag, newTag);\r\n    }\r\n\r\n    return { success: true, tradesUpdated: 0 };\r\n  };\r\n\r\n  const hasPendingUploads = (): boolean => newTrade!.pending_images.length > 0;\r\n\r\n  // Check if all required tag groups are present in the trade's tags\r\n  const validateRequiredTagGroups = (tags: string[]): { valid: boolean; missingGroups: string[] } => {\r\n    // Automatically add \"pair\" to required tag groups if not already present\r\n    const effectiveRequiredGroups = [...(requiredTagGroups || [])];\r\n    if (!effectiveRequiredGroups.includes(DEFAULT_PAIRS_TAG_GROUP)) {\r\n      effectiveRequiredGroups.push(DEFAULT_PAIRS_TAG_GROUP);\r\n    }\r\n\r\n    if (effectiveRequiredGroups.length === 0) {\r\n      return { valid: true, missingGroups: [] };\r\n    }\r\n\r\n    // Get all groups present in the tags\r\n    const presentGroups = new Set<string>();\r\n    tags.forEach(tag => {\r\n      if (tag.includes(':')) {\r\n        const group = tag.split(':')[0];\r\n        presentGroups.add(group);\r\n      }\r\n    });\r\n\r\n    // Find missing required groups\r\n    const missingGroups = effectiveRequiredGroups.filter(group => !presentGroups.has(group));\r\n\r\n    return {\r\n      valid: missingGroups.length === 0,\r\n      missingGroups\r\n    };\r\n  };\r\n\r\n  const handleSubmit = async (e?: React.FormEvent) => {\r\n    if (e) e.preventDefault();\r\n\r\n    if (!onAddTrade) return;\r\n    if (!newTrade) {\r\n      logger.error('Form state not initialized');\r\n      return;\r\n    }\r\n\r\n    // Prevent saving while precalculated values are loading (would result in incorrect amounts)\r\n    if (isLoadingPrecalculatedValues) {\r\n      logger.warn('Precalculated values still loading, prevented submission');\r\n      showErrorSnackbar('Please wait for risk calculations to complete');\r\n      return;\r\n    }\r\n\r\n    // Validate form\r\n    if (!newTrade.amount) {\r\n      logger.error('Validation error: Amount is required');\r\n      showErrorSnackbar('Amount is required');\r\n      return;\r\n    }\r\n    if (!newTrade.session) {\r\n      logger.error('Validation error: Session is required');\r\n      showErrorSnackbar('Session is required. Please select a trading session.');\r\n      return;\r\n    }\r\n    if (!newTrade.risk_to_reward || newTrade.risk_to_reward <= 0) {\r\n      logger.error('Validation error: Risk to reward is required');\r\n      showErrorSnackbar('Risk to reward is required');\r\n      return;\r\n    }\r\n\r\n    // Validate required tag groups\r\n    const { valid, missingGroups } = validateRequiredTagGroups(newTrade.tags);\r\n    if (!valid) {\r\n      logger.error(`Validation error: Missing required tag groups: ${missingGroups.join(', ')}`);\r\n      showErrorSnackbar(`Missing required tag groups: ${missingGroups.join(', ')}`);\r\n      return;\r\n    }\r\n\r\n    // Check if there are any pending image uploads\r\n    if (hasPendingUploads()) {\r\n      logger.warn('Image uploads pending, prevented submission');\r\n      showErrorSnackbar('Please wait for images to finish uploading');\r\n      return;\r\n    }\r\n\r\n    // Capture all data needed BEFORE closing the dialog\r\n    const tradeData = createFinalTradeData(newTrade!, trade_date);\r\n    const isTemporary = newTrade!.is_temporary;\r\n    const tradeId = newTrade!.id;\r\n\r\n    // Close dialog immediately (optimistic approach)\r\n    resetForm();\r\n    onCancel();\r\n\r\n    // Save in background\r\n    try {\r\n      if (isTemporary && tradeId) {\r\n        await onUpdateTradeProperty?.(tradeId, () => ({\r\n          ...tradeData,\r\n          is_temporary: false,\r\n          updated_at: new Date()\r\n        }));\r\n      } else {\r\n        await onAddTrade(tradeData);\r\n      }\r\n      logger.log('Trade saved successfully');\r\n    } catch (err) {\r\n      error('Error in trade submission:', err);\r\n\r\n      // Cleanup temporary trade on failure\r\n      if (isTemporary && tradeId && onDeleteTrades) {\r\n        try {\r\n          await onDeleteTrades([tradeId]);\r\n          log('Cleaned up temporary trade after failed update');\r\n        } catch (cleanupError) {\r\n          error('Failed to cleanup temporary trade:', cleanupError);\r\n        }\r\n      }\r\n\r\n      // Show error only if component is still mounted\r\n      if (isMountedRef.current) {\r\n        // Parent component handles global notifications for failures\r\n        logger.error(err instanceof Error ? err.message : 'Failed to save trade.');\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleEditSubmit = async (e?: React.FormEvent) => {\r\n    if (e) e.preventDefault();\r\n    if (!editingTrade) return;\r\n    if (!newTrade) {\r\n      logger.error('Form state not initialized');\r\n      return;\r\n    }\r\n\r\n    // Validate form\r\n    if (!newTrade.amount) {\r\n      logger.error('Validation error: Amount is required');\r\n      showErrorSnackbar('Amount is required');\r\n      return;\r\n    }\r\n    if (!newTrade.session) {\r\n      logger.error('Validation error: Session is required');\r\n      showErrorSnackbar('Session is required. Please select a trading session.');\r\n      return;\r\n    }\r\n\r\n    // Validate required tag groups\r\n    const { valid, missingGroups } = validateRequiredTagGroups(newTrade.tags);\r\n    if (!valid) {\r\n      logger.error(`Validation error: Missing required tag groups: ${missingGroups.join(', ')}`);\r\n      showErrorSnackbar(`Missing required tag groups: ${missingGroups.join(', ')}`);\r\n      return;\r\n    }\r\n\r\n    // Validate trade date is not in the future\r\n    if (newTrade.trade_date && newTrade.trade_date > new Date()) {\r\n      logger.error('Validation error: Trade date cannot be in the future');\r\n      showErrorSnackbar('Trade date cannot be in the future');\r\n      return;\r\n    }\r\n\r\n    // Check if there are any pending image uploads\r\n    // Check if there are any pending image uploads\r\n    if (hasPendingUploads()) {\r\n      logger.warn('Image uploads pending, prevented update');\r\n      showErrorSnackbar('Please wait for images to finish uploading');\r\n      return;\r\n    }\r\n\r\n    // Capture all data needed BEFORE closing the dialog\r\n    const tradeId = editingTrade.id;\r\n    const finalAmount = calculateFinalAmount(newTrade!);\r\n    let finalTags = processTagsForSubmission([...newTrade!.tags]);\r\n\r\n    // Add Partials tag if partialsTaken is true\r\n    if (newTrade!.partials_taken) {\r\n      finalTags = finalTags.filter((tag: string) => !tag.startsWith('Partials:'));\r\n      finalTags.push('Partials:Yes');\r\n    } else {\r\n      finalTags = finalTags.filter((tag: string) => !tag.startsWith('Partials:'));\r\n    }\r\n\r\n    // Prepare the images array with layout information\r\n    const updatedImages = [\r\n      ...newTrade!.pending_images.map(img => ({\r\n        url: img.preview || '',\r\n        id: img.id!,\r\n        calendar_id: calendar.id!,\r\n        pending: true,\r\n        caption: img.caption || '',\r\n        width: img.width || 0,\r\n        height: img.height || 0,\r\n        row: img.row !== undefined ? img.row : 0,\r\n        column: img.column !== undefined ? img.column : 0,\r\n        column_width: img.column_width !== undefined ? img.column_width : 100\r\n      })),\r\n      ...newTrade!.uploaded_images.map(img => ({\r\n        url: img.url || '',\r\n        id: img.id,\r\n        calendar_id: calendar.id!,\r\n        pending: img.pending,\r\n        caption: img.caption || '',\r\n        width: img.width || 0,\r\n        height: img.height || 0,\r\n        row: img.row !== undefined ? img.row : 0,\r\n        column: img.column !== undefined ? img.column : 0,\r\n        column_width: img.column_width !== undefined ? img.column_width : 100\r\n      }))\r\n    ];\r\n\r\n    // Capture form values for background update\r\n    const updateData = {\r\n      trade_type: newTrade!.trade_type,\r\n      amount: finalAmount,\r\n      name: newTrade!.name || \"\",\r\n      entry_price: newTrade!.entry_price || undefined,\r\n      exit_price: newTrade!.exit_price || undefined,\r\n      stop_loss: newTrade!.stop_loss || undefined,\r\n      take_profit: newTrade!.take_profit || undefined,\r\n      trade_date: newTrade!.trade_date,\r\n      is_temporary: newTrade?.is_temporary && !newTrade.name,\r\n      tags: finalTags || [],\r\n      risk_to_reward: newTrade!.risk_to_reward || 1,\r\n      partials_taken: newTrade!.partials_taken,\r\n      session: newTrade!.session || \"London\",\r\n      notes: newTrade!.notes || \"\",\r\n      images: updatedImages\r\n    };\r\n\r\n    // Close dialog immediately (optimistic approach)\r\n    resetForm();\r\n    onCancel();\r\n\r\n    // Update in background\r\n    try {\r\n      if (!tradeId) {\r\n        throw new Error('Cannot update trade: Missing trade ID');\r\n      }\r\n\r\n      await onUpdateTradeProperty?.(tradeId, (trade) => {\r\n        const currentDate = new Date();\r\n        const tradeDate = updateData.trade_date || trade.trade_date;\r\n        const updatedDate = new Date(tradeDate.getFullYear(), tradeDate.getMonth(), tradeDate.getDate(),\r\n          currentDate.getHours(), currentDate.getMinutes(), currentDate.getSeconds());\r\n\r\n        return {\r\n          ...trade,\r\n          ...updateData,\r\n          trade_date: updatedDate,\r\n          updated_at: new Date()\r\n        };\r\n      });\r\n\r\n      logger.log('Trade updated successfully');\r\n    } catch (err) {\r\n      logger.error('Error editing trade:', err);\r\n\r\n      // Show error only if component is still mounted\r\n      if (isMountedRef.current) {\r\n        logger.error(err instanceof Error ? err.message : 'Failed to update trade.');\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <BaseDialog\r\n        open={open}\r\n        onClose={() => {\r\n          // Only allow closing if we're not in the process of creating an empty trade\r\n          if (!isCreatingEmptyTrade && !isLoadingPrecalculatedValues) {\r\n            if (editingTrade) {\r\n              resetForm();\r\n            }\r\n            onClose();\r\n          }\r\n        }}\r\n        title=\"Daily Trades\"\r\n        maxWidth=\"md\"\r\n        fullWidth\r\n        hideCloseButton={isCreatingEmptyTrade || isLoadingPrecalculatedValues} // Disable close button when creating empty trade\r\n        primaryButtonText={(editingTrade ? 'Update Trade' : 'Add Trade')}\r\n        primaryButtonAction={(editingTrade ?\r\n          (e?: React.FormEvent) => handleEditSubmit(e) :\r\n          (e?: React.FormEvent) => handleSubmit(e)\r\n        )}\r\n        isSubmitting={isSubmitting || isCreatingEmptyTrade || isLoadingPrecalculatedValues} // Disable while creating empty trade or loading risk calculations (only for new trades)\r\n        cancelButtonAction={() => {\r\n          // Only allow canceling if we're not in the process of creating an empty trade\r\n          if (!isCreatingEmptyTrade && !isLoadingPrecalculatedValues) {\r\n            resetForm();\r\n            onCancel();\r\n          }\r\n        }}\r\n        hideFooterCancelButton={false}\r\n        sx={{ zIndex: Z_INDEX.DIALOG_POPUP }} // Higher z-index to appear above TradeGalleryDialog\r\n      >\r\n        <Box sx={{ p: 3 }}>\r\n\r\n          {/* Calendar Selection Dropdown (only shown when calendars prop is provided) */}\r\n          {isCalendarSelectionMode && (\r\n            <Box sx={{ mb: 3 }}>\r\n              <FormControl fullWidth required>\r\n                <InputLabel id=\"trade-calendar-select-label\">Calendar</InputLabel>\r\n                <Select\r\n                  labelId=\"trade-calendar-select-label\"\r\n                  id=\"trade-calendar-select\"\r\n                  value={calendar?.id || ''}\r\n                  label=\"Calendar\"\r\n                  onChange={(e) => onCalendarChange?.(e.target.value)}\r\n                  disabled={isSubmitting || isCreatingEmptyTrade}\r\n                  MenuProps={{\r\n                    sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n                  }}\r\n                >\r\n                  {calendars?.map((calendar) => (\r\n                    <MenuItem key={calendar.id} value={calendar.id}>\r\n                      {calendar.name}\r\n                    </MenuItem>\r\n                  ))}\r\n                </Select>\r\n              </FormControl>\r\n            </Box>\r\n          )}\r\n\r\n          <DayHeader\r\n            title={format(trade_date, 'EEEE, MMMM d, yyyy')}\r\n            account_balance={account_balance + precalculatedPnL}\r\n            formInputVisible={true}\r\n            total_pnl={dayTotalPnL}\r\n            onPrevDay={() => { }}\r\n            onNextDay={() => { }}\r\n          />\r\n\r\n          <Box sx={{\r\n            opacity: isCalendarSelected ? 1 : 0.5,\r\n            pointerEvents: isCalendarSelected ? 'auto' : 'none'\r\n          }}>\r\n            <TradeForm\r\n              accountBalance={account_balance}\r\n              calculateCumulativePnl={() => precalculatedPnL}\r\n              dynamicRiskSettings={dynamicRiskSettings}\r\n              calendarId={calendar?.id || ''}\r\n              requiredTagGroups={requiredTagGroups}\r\n              onTagUpdated={handleTagUpdated}\r\n              newTrade={newTrade!}\r\n              editingTrade={editingTrade}\r\n              allTags={allTags}\r\n              isSubmitting={isSubmitting}\r\n              calculateAmountFromRiskToReward={calculateAmountFromRiskToReward}\r\n              onNameChange={handleNameChange}\r\n              onAmountChange={handleAmountChange}\r\n              onTypeChange={handleTypeChange}\r\n              onEntryChange={handleEntryChange}\r\n              onExitChange={handleExitChange}\r\n              onStopLossChange={handleStopLossChange}\r\n              onTakeProfitChange={handleTakeProfitChange}\r\n              onRiskToRewardChange={handleRiskToRewardChange}\r\n              onPartialsTakenChange={handlePartialsTakenChange}\r\n              onSessionChange={handleSessionChange}\r\n              onNotesChange={handleNotesChange}\r\n              onTagsChange={handleTagsChange}\r\n              onDateChange={handleDateChange}\r\n              onImageUpload={handleImageUpload}\r\n              onImageCaptionChange={handleImageCaptionChange}\r\n              onImageRemove={handleImageRemove}\r\n              onImagesReordered={handleImagesReordered}\r\n              onSubmit={editingTrade ? handleEditSubmit : handleSubmit}\r\n              onOpenGalleryMode={onOpenGalleryMode}\r\n            />\r\n\r\n\r\n          </Box>\r\n        </Box>\r\n      </BaseDialog>\r\n\r\n      {/* Error Snackbar */}\r\n      <Snackbar\r\n        open={showError}\r\n        autoHideDuration={4000}\r\n        onClose={handleCloseError}\r\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n        sx={{ zIndex: Z_INDEX.SNACKBAR }}\r\n      >\r\n        <Alert onClose={handleCloseError} severity=\"error\" variant=\"filled\" sx={{ width: '100%' }}>\r\n          {errorMessage}\r\n        </Alert>\r\n      </Snackbar>\r\n\r\n    </>\r\n  );\r\n};\r\n\r\nexport default TradeFormDialog;\r\n","/**\r\n * NoteEditorDialog Component\r\n * Full-screen dialog for creating/editing notes\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogTitle,\r\n  DialogContent,\r\n  TextField,\r\n  IconButton,\r\n  Box,\r\n  useTheme,\r\n  alpha,\r\n  Toolbar,\r\n  Typography,\r\n  Alert,\r\n  Button,\r\n  useMediaQuery,\r\n  ToggleButtonGroup,\r\n  ToggleButton,\r\n  Chip,\r\n  Divider,\r\n  Collapse,\r\n  Autocomplete,\r\n  Menu,\r\n  MenuItem,\r\n  Popover,\r\n  Switch,\r\n  FormControlLabel,\r\n  Tooltip,\r\n} from '@mui/material';\r\nimport {\r\n  pink,\r\n  purple,\r\n  deepPurple,\r\n  indigo,\r\n  lightBlue,\r\n  cyan,\r\n  teal,\r\n  lightGreen,\r\n  lime,\r\n  yellow,\r\n  amber,\r\n  deepOrange,\r\n  brown,\r\n  grey,\r\n  blueGrey,\r\n} from '@mui/material/colors';\r\nimport {\r\n  Close as CloseIcon,\r\n  Image as ImageIcon,\r\n  PushPin as PinIcon,\r\n  PushPinOutlined as PinOutlinedIcon,\r\n  Archive as ArchiveIcon,\r\n  Unarchive as UnarchiveIcon,\r\n  Delete as DeleteIcon,\r\n  NotificationsActive as ReminderIcon,\r\n  NotificationsNone as NoReminderIcon,\r\n  ExpandMore as ExpandMoreIcon,\r\n  ExpandLess as ExpandLessIcon,\r\n  LocalOffer as TagIcon,\r\n  Label as LabelIcon,\r\n  Add as AddIcon,\r\n  Public as GlobalIcon,\r\n  Lock as PrivateIcon,\r\n} from '@mui/icons-material';\r\nimport { DatePicker } from '@mui/x-date-pickers/DatePicker';\r\nimport { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';\r\nimport { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';\r\n\r\nimport RichTextEditor, { RichTextEditorHandle } from '../common/RichTextEditor';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\nimport EditorToolbar from '../common/RichTextEditor/components/EditorToolbar';\r\nimport ImagePickerDialog from '../heroImage/ImagePickerDialog';\r\nimport ConfirmationDialog from '../common/ConfirmationDialog';\r\nimport { useAuthState } from '../../contexts/AuthStateContext';\r\nimport * as notesService from '../../services/notesService';\r\nimport { Note, ReminderType, DayAbbreviation } from '../../types/note';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { logger } from '../../utils/logger';\r\n\r\n// Default tags with display labels and internal values (for AI compatibility)\r\nexport interface TagInfo {\r\n  label: string;\r\n  subtitle: string;\r\n}\r\n\r\nexport const DEFAULT_NOTE_TAGS_MAP: Record<string, TagInfo> = {\r\n  'STRATEGY': { label: 'Strategy', subtitle: 'Long-term trading approach and rules' },\r\n  'GAME_PLAN': { label: 'Game Plan', subtitle: 'Specific plan for the upcoming session' },\r\n  'INSIGHT': { label: 'Insight', subtitle: 'Market observations and patterns' },\r\n  'LESSON_LEARNED': { label: 'Lesson Learned', subtitle: 'Review of mistakes and successes' },\r\n  'GENERAL': { label: 'General', subtitle: 'General notes and thoughts' },\r\n  'RISK_MANAGEMENT': { label: 'Risk Management', subtitle: 'Position sizing and stop-loss rules' },\r\n  'PSYCHOLOGY': { label: 'Psychology', subtitle: 'Mental state and emotional control' },\r\n  'GUIDELINE': { label: 'Guideline', subtitle: 'Instructions for the AI Assistant (Max 1)' },\r\n};\r\n\r\n// Helper to get display label for a tag (returns original if not a default tag)\r\nexport const getTagDisplayLabel = (tag: string): string => {\r\n  return DEFAULT_NOTE_TAGS_MAP[tag]?.label || tag;\r\n};\r\n\r\nexport const getTagSubtitle = (tag: string): string => {\r\n  return DEFAULT_NOTE_TAGS_MAP[tag]?.subtitle || '';\r\n};\r\n\r\ninterface NoteEditorDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  note?: Note; // If provided, edit existing note; otherwise create new\r\n  calendarId: string; // Required for new notes\r\n  onSave?: (note: Note, isCreated?: boolean) => void;\r\n  onDelete?: (noteId: string) => void;\r\n}\r\n\r\nconst NoteEditorDialog: React.FC<NoteEditorDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  note: initialNote,\r\n  calendarId,\r\n  onSave,\r\n  onDelete,\r\n}) => {\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n  const fullScreen = useMediaQuery(theme.breakpoints.down('md'));\r\n\r\n  // Ref for external toolbar control\r\n  const editorRef = useRef<RichTextEditorHandle>(null);\r\n  const [isToolbarMenuOpen, setIsToolbarMenuOpen] = useState(false);\r\n  const [editorMounted, setEditorMounted] = useState(false);\r\n\r\n  // Force re-render when editor mounts to access the ref\r\n  useEffect(() => {\r\n    if (open) {\r\n      // Small delay to ensure editor is mounted\r\n      const timer = setTimeout(() => setEditorMounted(true), 50);\r\n      return () => clearTimeout(timer);\r\n    } else {\r\n      setEditorMounted(false);\r\n    }\r\n  }, [open]);\r\n\r\n  const [note, setNote] = useState<Note | null>(null);\r\n  const [title, setTitle] = useState<string>('');\r\n  const [content, setContent] = useState('');\r\n  const [coverImage, setCoverImage] = useState<string | null>(null);\r\n  const [imagePickerOpen, setImagePickerOpen] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);\r\n  const [deleting, setDeleting] = useState(false);\r\n\r\n  // Reminder states\r\n  const [reminderType, setReminderType] = useState<ReminderType>('none');\r\n  const [reminderDate, setReminderDate] = useState<Date | null>(null);\r\n  const [reminderDays, setReminderDays] = useState<DayAbbreviation[]>([]);\r\n  const [isReminderActive, setIsReminderActive] = useState(false);\r\n  const [isReminderExpanded, setIsReminderExpanded] = useState(false);\r\n  // Color state\r\n  const [noteColor, setNoteColor] = useState(initialNote?.color);\r\n  const [colorMenuAnchor, setColorMenuAnchor] = useState<null | HTMLElement>(null);\r\n\r\n  // Tags states\r\n  const [tags, setTags] = useState<string[]>([]);\r\n  const [newTagInput, setNewTagInput] = useState('');\r\n  const [isTagsExpanded, setIsTagsExpanded] = useState(false);\r\n  const [hasExistingGuideline, setHasExistingGuideline] = useState(false);\r\n\r\n  // Global note state (null calendar_id = visible in all calendars)\r\n  const [isGlobal, setIsGlobal] = useState(false);\r\n\r\n  // Default tags list\r\n  const allDays: DayAbbreviation[] = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\r\n  const defaultTags = Object.keys(DEFAULT_NOTE_TAGS_MAP);\r\n\r\n  // Check for existing guideline note on open\r\n  useEffect(() => {\r\n    const checkGuideline = async () => {\r\n      if (open && user?.id) {\r\n        try {\r\n          const guidelineNotes = await notesService.getNotesByTag(user.id, 'GUIDELINE');\r\n          const existingGuideline = guidelineNotes.find(n => n.id !== initialNote?.id);\r\n          setHasExistingGuideline(!!existingGuideline);\r\n        } catch (error) {\r\n          console.error('Error checking for existing guideline:', error);\r\n        }\r\n      }\r\n    };\r\n    checkGuideline();\r\n  }, [open, user?.id, initialNote?.id]);\r\n\r\n\r\n  // Initialize note data when dialog opens\r\n  useEffect(() => {\r\n    if (open) {\r\n      if (initialNote) {\r\n        // Editing existing note - use passed note object\r\n        setNote(initialNote);\r\n        setTitle(initialNote.title);\r\n        setContent(initialNote.content);\r\n        setCoverImage(initialNote.cover_image);\r\n\r\n        // Initialize reminder states\r\n        setReminderType(initialNote.reminder_type || 'none');\r\n        setReminderDate(initialNote.reminder_date || null);\r\n        setReminderDays(initialNote.reminder_days || []);\r\n        setIsReminderActive(initialNote.is_reminder_active || false);\r\n        setIsReminderExpanded(false);\r\n        setNoteColor(initialNote.color);\r\n\r\n        // Initialize tags states\r\n        setTags(initialNote.tags || []);\r\n        setIsTagsExpanded(false);\r\n\r\n        // Initialize global state (null calendar_id = global note)\r\n        setIsGlobal(initialNote.calendar_id === null);\r\n      } else {\r\n        // Creating new note - reset to defaults\r\n        setNote(null);\r\n        setTitle('');\r\n        setContent('');\r\n        setCoverImage(null);\r\n\r\n        // Reset reminder states\r\n        setReminderType('none');\r\n        setReminderDate(null);\r\n        setReminderDays([]);\r\n        setIsReminderActive(false);\r\n        setIsReminderExpanded(false);\r\n        setNoteColor(undefined);\r\n\r\n        // Reset tags states\r\n        setTags([]);\r\n        setIsTagsExpanded(false);\r\n        setNewTagInput('');\r\n\r\n        // Reset global state (default to calendar-specific)\r\n        setIsGlobal(false);\r\n      }\r\n    }\r\n  }, [open, initialNote]);\r\n\r\n  const saveNote = async () => {\r\n    if (!user?.uid) return;\r\n\r\n    try {\r\n      setSaving(true);\r\n\r\n      if (note) {\r\n        // Update existing note - only save tags if not an AI note\r\n        const updates: any = {\r\n          title,\r\n          content,\r\n          cover_image: coverImage,\r\n          reminder_type: reminderType,\r\n          reminder_date: reminderDate,\r\n          reminder_days: reminderDays,\r\n          is_reminder_active: isReminderActive,\r\n          color: noteColor ?? null,\r\n          calendar_id: isGlobal ? null : calendarId, // null = global note\r\n        };\r\n\r\n        // Only update tags for user-created notes\r\n        if (!note.by_assistant) {\r\n          updates.tags = tags;\r\n        }\r\n\r\n        await notesService.updateNote(note.id, updates);\r\n\r\n        // Reload to get updated data\r\n        const updatedNote = await notesService.getNote(note.id);\r\n        if (updatedNote) {\r\n          setNote(updatedNote);\r\n          if (onSave) onSave(updatedNote, false);\r\n        }\r\n      } else {\r\n        // Create new note\r\n        const newNote = await notesService.createNote({\r\n          user_id: user.uid,\r\n          calendar_id: isGlobal ? null : calendarId, // null = global note\r\n          title,\r\n          content,\r\n          cover_image: coverImage,\r\n          reminder_type: reminderType,\r\n          reminder_date: reminderDate,\r\n          reminder_days: reminderDays,\r\n          is_reminder_active: isReminderActive,\r\n          color: (noteColor ?? null) as any,\r\n          tags,\r\n        });\r\n        setNote(newNote);\r\n        if (onSave) onSave(newNote, true);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error saving note:', error);\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  // Check if there are changes compared to the initial note\r\n  const hasChanges = () => {\r\n    if (!note) {\r\n      // For new notes, check if there's any content\r\n      const hasNonEmptyTitle = title && title.trim() !== '';\r\n      const hasNonEmptyContent = content && content.trim() !== '';\r\n      const hasCoverImage = coverImage !== null;\r\n      const hasReminder = reminderType !== 'none' && isReminderActive;\r\n      const hasTags = tags.length > 0;\r\n      const hasColor = noteColor !== undefined;\r\n\r\n      return hasNonEmptyTitle || hasNonEmptyContent || hasCoverImage || hasReminder || hasTags || hasColor;\r\n    } else {\r\n      // For existing notes, check if anything changed\r\n      const titleChanged = title !== note.title;\r\n      const contentChanged = content !== note.content;\r\n      const coverImageChanged = coverImage !== note.cover_image;\r\n      const reminderTypeChanged = reminderType !== (note.reminder_type || 'none');\r\n      const reminderDateChanged = reminderDate !== (note.reminder_date || null);\r\n      const reminderDaysChanged = JSON.stringify(reminderDays) !== JSON.stringify(note.reminder_days || []);\r\n      const reminderActiveChanged = isReminderActive !== (note.is_reminder_active || false);\r\n      const tagsChanged = JSON.stringify(tags) !== JSON.stringify(note.tags || []);\r\n      const colorChanged = noteColor !== note.color;\r\n      const globalChanged = isGlobal !== (note.calendar_id === null);\r\n\r\n      return titleChanged || contentChanged || coverImageChanged || reminderTypeChanged ||\r\n        reminderDateChanged || reminderDaysChanged || reminderActiveChanged || tagsChanged || colorChanged || globalChanged;\r\n    }\r\n  };\r\n\r\n  // Auto-save on changes (debounced) - only for existing notes\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    if (!note) return; // Don't auto-save new notes\r\n    if (!hasChanges()) return; // Don't save if nothing changed\r\n\r\n    const timeout = setTimeout(() => {\r\n      saveNote();\r\n    }, 60000); // 1 minute debounce\r\n\r\n    return () => clearTimeout(timeout);\r\n  }, [title, content, coverImage, tags, isGlobal, open, note]);\r\n\r\n  const handleClose = async () => {\r\n    // If it's a new note and has content, save it before closing\r\n    // Or if it's an existing note with changes, save before closing\r\n    if (hasChanges()) {\r\n      await saveNote();\r\n    }\r\n    onClose();\r\n  };\r\n\r\n  const handleImageSelect = (imageUrl: string) => {\r\n    setCoverImage(imageUrl);\r\n    setImagePickerOpen(false);\r\n  };\r\n\r\n  const handleRemoveCover = () => {\r\n    setCoverImage(null);\r\n  };\r\n\r\n  const handlePinNote = async () => {\r\n    if (!note) return;\r\n\r\n    try {\r\n      if (note.is_pinned) {\r\n        await notesService.unpinNote(note.id);\r\n      } else {\r\n        await notesService.pinNote(note.id);\r\n      }\r\n      setNote(prev => prev ? { ...prev, is_pinned: !prev.is_pinned } : null);\r\n      if (onSave) {\r\n        onSave({ ...note, is_pinned: !note.is_pinned });\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error toggling pin:', error);\r\n    }\r\n  };\r\n\r\n  const handleArchiveNote = async () => {\r\n    if (!note) return;\r\n\r\n    try {\r\n      if (note.is_archived) {\r\n        await notesService.unarchiveNote(note.id);\r\n        if (onSave) {\r\n          onSave({ ...note, is_archived: !note.is_archived, archived_at: note.is_archived ? null : new Date() });\r\n        }\r\n        setNote(prev => prev ? { ...prev, is_archived: false } : null);\r\n      } else {\r\n        await notesService.archiveNote(note.id);\r\n        setNote(prev => prev ? { ...prev, is_archived: true, archived_at: new Date() } : null);\r\n        // Close dialog after archiving\r\n        handleClose();\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error toggling archive:', error);\r\n    }\r\n  };\r\n\r\n  const handleDeleteNote = () => {\r\n    if (!note) return;\r\n    setDeleteConfirmOpen(true);\r\n  };\r\n\r\n  const handleConfirmDelete = async () => {\r\n    if (!note) return;\r\n\r\n    try {\r\n      setDeleting(true);\r\n      await notesService.deleteNote(note.id);\r\n      if (onDelete) onDelete(note.id);\r\n      setDeleteConfirmOpen(false);\r\n      onClose(); // Close the editor dialog\r\n    } catch (error) {\r\n      logger.error('Error deleting note:', error);\r\n      setDeleting(false);\r\n    }\r\n  };\r\n\r\n  const handleCancelDelete = () => {\r\n    setDeleteConfirmOpen(false);\r\n  };\r\n\r\n  // Reminder handlers\r\n  const handleReminderTypeChange = (event: React.MouseEvent<HTMLElement>, newType: ReminderType | null) => {\r\n    if (newType !== null) {\r\n      setReminderType(newType);\r\n      setIsReminderActive(newType !== 'none');\r\n\r\n      // Clear fields based on type\r\n      if (newType === 'none') {\r\n        setReminderDate(null);\r\n        setReminderDays([]);\r\n      } else if (newType === 'once') {\r\n        setReminderDays([]);\r\n      } else if (newType === 'weekly') {\r\n        setReminderDate(null);\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleToggleDay = (day: DayAbbreviation) => {\r\n    setReminderDays(prev => {\r\n      if (prev.includes(day)) {\r\n        return prev.filter(d => d !== day);\r\n      } else {\r\n        return [...prev, day];\r\n      }\r\n    });\r\n  };\r\n\r\n  // Tag handlers\r\n  const handleAddTag = (tagValue: string) => {\r\n    if (tagValue && !tags.includes(tagValue)) {\r\n      setTags(prev => [...prev, tagValue]);\r\n      setNewTagInput('');\r\n    }\r\n  };\r\n\r\n  const handleRemoveTag = (tagToRemove: string) => {\r\n    setTags(prev => prev.filter(tag => tag !== tagToRemove));\r\n  };\r\n\r\n  // Check if tag editing is allowed (not for AI notes)\r\n  const isTagEditingAllowed = !note?.by_assistant;\r\n\r\n  return (\r\n    <>\r\n      <Dialog\r\n        open={open}\r\n        onClose={handleClose}\r\n        fullScreen={fullScreen}\r\n        maxWidth=\"md\"\r\n        sx={{\r\n          zIndex: (theme) => theme.zIndex.modal + 100, // Ensure it's above the AIChatDrawer\r\n        }}\r\n        PaperProps={{\r\n          sx: {\r\n            height: fullScreen ? '100%' : '90vh',\r\n            m: fullScreen ? 0 : 2,\r\n          },\r\n        }}\r\n      >\r\n        {/* Toolbar with title and close */}\r\n        <Toolbar\r\n          sx={{\r\n            borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n            gap: 1,\r\n          }}\r\n        >\r\n          <Typography variant=\"h6\" sx={{ flex: 1 }}>\r\n            {note ? 'Edit Note' : 'New Note'}\r\n          </Typography>\r\n\r\n          <IconButton size=\"small\" onClick={handleClose}>\r\n            <CloseIcon />\r\n          </IconButton>\r\n        </Toolbar>\r\n\r\n        {/* Editor Toolbar - sticky in header area */}\r\n        {editorMounted && editorRef.current && (\r\n          <EditorToolbar\r\n            editorState={editorRef.current.editorState}\r\n            disabled={false}\r\n            variant=\"sticky\"\r\n            stickyPosition=\"top\"\r\n            toolbarRef={editorRef.current.toolbarRef}\r\n            onToggleInlineStyle={(style) => editorRef.current?.toggleInlineStyle(style)}\r\n            onToggleBlockType={(blockType) => editorRef.current?.toggleBlockType(blockType)}\r\n            onApplyTextColor={(color) => editorRef.current?.applyTextColor(color)}\r\n            onApplyBackgroundColor={(color) => editorRef.current?.applyBackgroundColor(color)}\r\n            onApplyHeading={(heading) => editorRef.current?.applyHeading(heading)}\r\n            onClearFormatting={() => editorRef.current?.clearFormatting()}\r\n            onLinkClick={() => editorRef.current?.handleLinkClick()}\r\n            onImageClick={() => editorRef.current?.handleImageClick()}\r\n            onMenuOpenChange={(isOpen) => {\r\n              setIsToolbarMenuOpen(isOpen);\r\n              editorRef.current?.setIsMenuOpen(isOpen);\r\n            }}\r\n          />\r\n        )}\r\n\r\n        <DialogContent\r\n          sx={{\r\n            p: 0,\r\n            overflowY: 'auto',\r\n            bgcolor: 'background.default',\r\n            ...(scrollbarStyles(theme) as any),\r\n          }}\r\n        >\r\n          {/* Cover Image */}\r\n          {coverImage && (\r\n            <Box\r\n              sx={{\r\n                position: 'relative',\r\n                width: '100%',\r\n                height: 260,\r\n                backgroundImage: `url(${coverImage})`,\r\n                backgroundSize: 'cover',\r\n                backgroundPosition: 'center',\r\n                '&:hover .cover-actions': {\r\n                  opacity: 1,\r\n                },\r\n              }}\r\n            >\r\n              <Box\r\n                className=\"cover-actions\"\r\n                sx={{\r\n                  position: 'absolute',\r\n                  bottom: 16,\r\n                  left: 16,\r\n                  display: 'flex',\r\n                  gap: 1,\r\n                  opacity: 0,\r\n                  transition: 'opacity 0.2s',\r\n                }}\r\n              >\r\n                <IconButton\r\n                  onClick={() => setImagePickerOpen(true)}\r\n                  sx={{\r\n                    bgcolor: alpha(theme.palette.background.paper, 0.9),\r\n                    '&:hover': {\r\n                      bgcolor: theme.palette.background.paper,\r\n                    },\r\n                  }}\r\n                >\r\n                  <ImageIcon />\r\n                </IconButton>\r\n                <IconButton\r\n                  onClick={handleRemoveCover}\r\n                  sx={{\r\n                    bgcolor: alpha(theme.palette.background.paper, 0.9),\r\n                    '&:hover': {\r\n                      bgcolor: theme.palette.background.paper,\r\n                    },\r\n                  }}\r\n                >\r\n                  <CloseIcon />\r\n                </IconButton>\r\n              </Box>\r\n            </Box>\r\n          )}\r\n          {/* Reminder Sub-Header */}\r\n          <Box\r\n            sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n              px: 3,\r\n              py: 1,\r\n              bgcolor: alpha(theme.palette.info.main, 0.04),\r\n              borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n            }}\r\n          >\r\n            {/* Left side - Reminder toggle */}\r\n            <Box\r\n              onClick={() => setIsReminderExpanded(!isReminderExpanded)}\r\n              sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 1,\r\n                cursor: 'pointer',\r\n                py: 0.5,\r\n                '&:hover': {\r\n                  opacity: 0.8,\r\n                },\r\n              }}\r\n            >\r\n              {isReminderActive ? (\r\n                <ReminderIcon sx={{ color: 'info.main', fontSize: '1.1rem' }} />\r\n              ) : (\r\n                <NoReminderIcon sx={{ color: 'text.secondary', fontSize: '1.1rem' }} />\r\n              )}\r\n              <Typography\r\n                variant=\"subtitle2\"\r\n                fontWeight={600}\r\n                sx={{ color: isReminderActive ? 'info.main' : 'text.secondary' }}\r\n              >\r\n                Reminder\r\n              </Typography>\r\n              {isReminderActive && reminderType !== 'none' && (\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  {reminderType === 'weekly'\r\n                    ? `${reminderDays.length} day${reminderDays.length !== 1 ? 's' : ''}`\r\n                    : 'One-time'\r\n                  }\r\n                </Typography>\r\n              )}\r\n              <IconButton size=\"small\" sx={{ color: 'text.secondary', ml: -0.5 }}>\r\n                {isReminderExpanded ? <ExpandLessIcon fontSize=\"small\" /> : <ExpandMoreIcon fontSize=\"small\" />}\r\n              </IconButton>\r\n            </Box>\r\n\r\n            {/* Right side - Action buttons */}\r\n            <Box sx={{ display: 'flex', gap: 0.5 }}>\r\n              <IconButton\r\n                size=\"small\"\r\n                onClick={() => setImagePickerOpen(true)}\r\n                title={coverImage ? 'Change cover' : 'Add cover image'}\r\n              >\r\n                <ImageIcon fontSize=\"small\" />\r\n              </IconButton>\r\n\r\n              {note && (\r\n                <>\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handlePinNote}\r\n                    title={note.is_pinned ? 'Unpin note' : 'Pin note'}\r\n                    sx={{\r\n                      color: note.is_pinned ? 'primary.main' : 'inherit',\r\n                    }}\r\n                  >\r\n                    {note.is_pinned ? <PinIcon fontSize=\"small\" /> : <PinOutlinedIcon fontSize=\"small\" />}\r\n                  </IconButton>\r\n\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handleArchiveNote}\r\n                    title={note.is_archived ? 'Unarchive note' : 'Archive note'}\r\n                  >\r\n                    {note.is_archived ? <UnarchiveIcon fontSize=\"small\" /> : <ArchiveIcon fontSize=\"small\" />}\r\n                  </IconButton>\r\n\r\n                  <IconButton\r\n                    size=\"small\"\r\n                    onClick={handleDeleteNote}\r\n                    title=\"Delete note\"\r\n                    sx={{ color: 'error.main' }}\r\n                  >\r\n                    <DeleteIcon fontSize=\"small\" />\r\n                  </IconButton>\r\n                </>\r\n              )}\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Collapsible Reminder Content */}\r\n          <Collapse in={isReminderExpanded}>\r\n            <Box sx={{ px: 3, py: 2, bgcolor: alpha(theme.palette.info.main, 0.02) }}>\r\n              <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 2 }}>\r\n                Set a reminder to display this note on specific days. Perfect for game plans, daily routines, or weekly trading strategies.\r\n              </Typography>\r\n\r\n              <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap', mb: 2 }}>\r\n                {/* Reminder Type Selector */}\r\n                <ToggleButtonGroup\r\n                  value={reminderType}\r\n                  exclusive\r\n                  onChange={handleReminderTypeChange}\r\n                  size=\"small\"\r\n                >\r\n                  <ToggleButton value=\"none\">\r\n                    <NoReminderIcon sx={{ mr: 1, fontSize: '1.2rem' }} />\r\n                    None\r\n                  </ToggleButton>\r\n                  <ToggleButton value=\"once\">\r\n                    Once\r\n                  </ToggleButton>\r\n                  <ToggleButton value=\"weekly\">\r\n                    Weekly\r\n                  </ToggleButton>\r\n                </ToggleButtonGroup>\r\n\r\n                {/* Color Template Selector */}\r\n                {/* Color Template Selector */}\r\n                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, alignItems: 'center', ml: { xs: 0, sm: 2 } }}>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mr: 1 }}>\r\n                    Color:\r\n                  </Typography>\r\n                  {(() => {\r\n                    const allPresets = [\r\n                      { value: undefined, label: 'Default', color: theme.palette.background.paper },\r\n                      { value: 'red', label: 'Red', color: theme.palette.error.main },\r\n                      { value: 'pink', label: 'Pink', color: pink[500] },\r\n                      { value: 'purple', label: 'Purple', color: purple[500] },\r\n                      { value: 'deepPurple', label: 'Deep Purple', color: deepPurple[500] },\r\n                      { value: 'indigo', label: 'Indigo', color: indigo[500] },\r\n                      { value: 'blue', label: 'Blue', color: theme.palette.info.main },\r\n                      { value: 'lightBlue', label: 'Light Blue', color: lightBlue[500] },\r\n                      { value: 'cyan', label: 'Cyan', color: cyan[500] },\r\n                      { value: 'teal', label: 'Teal', color: teal[500] },\r\n                      { value: 'green', label: 'Green', color: theme.palette.success.main },\r\n                      { value: 'lightGreen', label: 'Light Green', color: lightGreen[500] },\r\n                      { value: 'lime', label: 'Lime', color: lime[500] },\r\n                      { value: 'yellow', label: 'Yellow', color: yellow[600] },\r\n                      { value: 'amber', label: 'Amber', color: amber[500] },\r\n                      { value: 'orange', label: 'Orange', color: theme.palette.warning.main },\r\n                      { value: 'deepOrange', label: 'Deep Orange', color: deepOrange[500] },\r\n                      { value: 'brown', label: 'Brown', color: brown[500] },\r\n                      { value: 'grey', label: 'Grey', color: grey[500] },\r\n                      { value: 'blueGrey', label: 'Blue Grey', color: blueGrey[500] },\r\n                    ];\r\n\r\n                    const visiblePresets = allPresets.slice(0, 5);\r\n                    const hiddenPresets = allPresets.slice(5);\r\n\r\n                    // State for the menu (needs to be defined at component level, but for this refactor we'll use a local ref hack or just move state up. \r\n                    // Actually, I can't define state inside this expression. I must move the logic out or assume state exists.\r\n                    // I will inject the state definition in a separate replace call effectively, but wait, I can't easily do that.\r\n                    // I should have added the state in the previous step. \r\n                    // I will assume I can add the state in a separate edit to the top of the file.\r\n                    // BUT, to avoid breaking, I will use a Popover that is self-contained? No, that's messy.\r\n                    // I will render the list here assuming `colorMenuAnchor` exists, and I will add `colorMenuAnchor` in the next tool call (or previous if I could).\r\n                    // Actually, I'll allow the build to break for one second or I'll add the state FIRST efficiently.\r\n                    // For now, let's render the list and the menu trigger.\r\n\r\n                    return (\r\n                      <>\r\n                        {visiblePresets.map((preset) => (\r\n                          <Box\r\n                            key={preset.label}\r\n                            onClick={() => setNoteColor(preset.value)}\r\n                            sx={{\r\n                              width: 24,\r\n                              height: 24,\r\n                              borderRadius: '50%',\r\n                              bgcolor: preset.value ? alpha(preset.color, 0.2) : alpha(theme.palette.divider, 0.1),\r\n                              border: `2px solid ${noteColor === preset.value ? theme.palette.primary.main : alpha(theme.palette.divider, 0.2)}`,\r\n                              cursor: 'pointer',\r\n                              transition: 'transform 0.2s',\r\n                              '&:hover': {\r\n                                transform: 'scale(1.1)',\r\n                                border: `2px solid ${theme.palette.primary.main}`,\r\n                              },\r\n                            }}\r\n                            title={preset.label}\r\n                          />\r\n                        ))}\r\n\r\n                        {/* More Colors Button */}\r\n                        <Box\r\n                          onClick={(e) => setColorMenuAnchor(e.currentTarget)}\r\n                          sx={{\r\n                            width: 24,\r\n                            height: 24,\r\n                            borderRadius: '50%',\r\n                            border: `1px dashed ${theme.palette.text.secondary}`,\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            justifyContent: 'center',\r\n                            cursor: 'pointer',\r\n                            transition: 'all 0.2s',\r\n                            '&:hover': {\r\n                              borderColor: theme.palette.primary.main,\r\n                              color: theme.palette.primary.main,\r\n                              bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n                            },\r\n                          }}\r\n                          title=\"More colors\"\r\n                        >\r\n                          <AddIcon sx={{ fontSize: 16 }} />\r\n                        </Box>\r\n\r\n                        {/* Hidden Colors Menu */}\r\n                        <Popover\r\n                          open={Boolean(colorMenuAnchor)}\r\n                          anchorEl={colorMenuAnchor}\r\n                          onClose={() => setColorMenuAnchor(null)}\r\n                          anchorOrigin={{\r\n                            vertical: 'bottom',\r\n                            horizontal: 'left',\r\n                          }}\r\n                          transformOrigin={{\r\n                            vertical: 'top',\r\n                            horizontal: 'left',\r\n                          }}\r\n                          PaperProps={{\r\n                            sx: { p: 2, maxWidth: 320 }\r\n                          }}\r\n                          sx={{ zIndex: Z_INDEX.DIALOG_POPUP }}\r\n                        >\r\n                          <Typography variant=\"caption\" color=\"text.secondary\" display=\"block\" sx={{ mb: 1.5, px: 0.5 }}>\r\n                            More Colors\r\n                          </Typography>\r\n                          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>\r\n                            {hiddenPresets.map((preset) => (\r\n                              <Box\r\n                                key={preset.label}\r\n                                onClick={() => {\r\n                                  setNoteColor(preset.value);\r\n                                  setColorMenuAnchor(null);\r\n                                }}\r\n                                sx={{\r\n                                  width: 24,\r\n                                  height: 24,\r\n                                  borderRadius: '50%',\r\n                                  bgcolor: preset.value ? alpha(preset.color, 0.2) : alpha(theme.palette.divider, 0.1),\r\n                                  border: `2px solid ${noteColor === preset.value ? theme.palette.primary.main : alpha(theme.palette.divider, 0.2)}`,\r\n                                  cursor: 'pointer',\r\n                                  transition: 'transform 0.2s',\r\n                                  '&:hover': {\r\n                                    transform: 'scale(1.1)',\r\n                                    border: `2px solid ${theme.palette.primary.main}`,\r\n                                  },\r\n                                }}\r\n                                title={preset.label}\r\n                              />\r\n                            ))}\r\n                          </Box>\r\n                        </Popover>\r\n                      </>\r\n                    );\r\n                  })()}\r\n                </Box>\r\n              </Box>\r\n\r\n              {/* One-time Reminder Date Picker */}\r\n              {reminderType === 'once' && (\r\n                <LocalizationProvider dateAdapter={AdapterDateFns}>\r\n                  <DatePicker\r\n                    label=\"Reminder Date\"\r\n                    value={reminderDate}\r\n                    onChange={(newDate) => setReminderDate(newDate)}\r\n                    slotProps={{\r\n                      textField: {\r\n                        fullWidth: true,\r\n                        size: 'small',\r\n                      },\r\n                      popper: {\r\n                        sx: { zIndex: Z_INDEX.RICH_TEXT_DIALOG },\r\n                      },\r\n                    }}\r\n                  />\r\n                </LocalizationProvider>\r\n              )}\r\n\r\n              {/* Weekly Reminder Day Selector */}\r\n              {reminderType === 'weekly' && (\r\n                <Box>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\" sx={{ mb: 1 }}>\r\n                    Select days to show this reminder:\r\n                  </Typography>\r\n                  <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>\r\n                    {allDays.map((day) => (\r\n                      <Chip\r\n                        key={day}\r\n                        label={day}\r\n                        onClick={() => handleToggleDay(day)}\r\n                        color={reminderDays.includes(day) ? 'primary' : 'default'}\r\n                        variant={reminderDays.includes(day) ? 'filled' : 'outlined'}\r\n                        sx={{\r\n                          fontWeight: reminderDays.includes(day) ? 600 : 400,\r\n                          cursor: 'pointer',\r\n                        }}\r\n                      />\r\n                    ))}\r\n                  </Box>\r\n                  {reminderDays.length === 0 && (\r\n                    <Typography variant=\"caption\" color=\"error\" sx={{ mt: 1, display: 'block' }}>\r\n                      Please select at least one day\r\n                    </Typography>\r\n                  )}\r\n                </Box>\r\n              )}\r\n            </Box>\r\n          </Collapse>\r\n\r\n          {/* Visibility Sub-Header (Global/Private toggle) */}\r\n          <Box\r\n            sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n              px: 3,\r\n              py: 1,\r\n              bgcolor: alpha(theme.palette.primary.main, 0.04),\r\n              borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n            }}\r\n          >\r\n            {/* Left side - Visibility label */}\r\n            <Box\r\n              sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 1,\r\n              }}\r\n            >\r\n              {isGlobal ? (\r\n                <GlobalIcon sx={{ color: 'primary.main', fontSize: '1.1rem' }} />\r\n              ) : (\r\n                <PrivateIcon sx={{ color: 'text.secondary', fontSize: '1.1rem' }} />\r\n              )}\r\n              <Typography\r\n                variant=\"subtitle2\"\r\n                fontWeight={600}\r\n                sx={{ color: isGlobal ? 'primary.main' : 'text.secondary' }}\r\n              >\r\n                {isGlobal ? 'Global Note' : 'Calendar Note'}\r\n              </Typography>\r\n            </Box>\r\n\r\n            {/* Right side - Toggle switch */}\r\n            <Tooltip\r\n              title={isGlobal\r\n                ? 'This note is visible in all calendars'\r\n                : 'This note is only visible in the current calendar'\r\n              }\r\n              placement=\"left\"\r\n            >\r\n              <FormControlLabel\r\n                control={\r\n                  <Switch\r\n                    checked={isGlobal}\r\n                    onChange={(e) => setIsGlobal(e.target.checked)}\r\n                    size=\"small\"\r\n                    color=\"primary\"\r\n                  />\r\n                }\r\n                label={\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    {isGlobal ? 'All calendars' : 'This calendar only'}\r\n                  </Typography>\r\n                }\r\n                labelPlacement=\"start\"\r\n                sx={{ mr: 0 }}\r\n              />\r\n            </Tooltip>\r\n          </Box>\r\n\r\n          {/* Tags Sub-Header */}\r\n          <Box\r\n            onClick={() => setIsTagsExpanded(!isTagsExpanded)}\r\n            sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n              px: 3,\r\n              py: 1,\r\n              bgcolor: alpha(theme.palette.secondary.main, 0.04),\r\n              borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n              cursor: 'pointer',\r\n              '&:hover': {\r\n                opacity: 0.8,\r\n              },\r\n            }}\r\n          >\r\n            {/* Left side - Tags label */}\r\n            <Box\r\n              sx={{\r\n                display: 'flex',\r\n                alignItems: 'center',\r\n                gap: 1,\r\n              }}\r\n            >\r\n              <TagIcon sx={{ color: tags.length > 0 ? 'secondary.main' : 'text.secondary', fontSize: '1.1rem' }} />\r\n              <Typography\r\n                variant=\"subtitle2\"\r\n                fontWeight={600}\r\n                sx={{ color: tags.length > 0 ? 'secondary.main' : 'text.secondary' }}\r\n              >\r\n                Tags\r\n              </Typography>\r\n              {/* AI note indicator */}\r\n              {note?.by_assistant && (\r\n                <Typography variant=\"caption\" color=\"text.disabled\">\r\n                  (read-only)\r\n                </Typography>\r\n              )}\r\n            </Box>\r\n\r\n            {/* Right side - Tag count and expand icon */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n              {tags.length > 0 && (\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  {tags.length} tag{tags.length !== 1 ? 's' : ''}\r\n                </Typography>\r\n              )}\r\n              <IconButton size=\"small\" sx={{ color: 'text.secondary' }}>\r\n                {isTagsExpanded ? <ExpandLessIcon fontSize=\"small\" /> : <ExpandMoreIcon fontSize=\"small\" />}\r\n              </IconButton>\r\n            </Box>\r\n          </Box>\r\n\r\n          {/* Collapsible Tags Content */}\r\n          <Collapse in={isTagsExpanded}>\r\n            <Box sx={{ px: 3, py: 2, bgcolor: alpha(theme.palette.secondary.main, 0.02) }}>\r\n              {/* Existing tags */}\r\n              {tags.length > 0 && (\r\n                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5, mb: 2 }}>\r\n                  {tags.map((tag) => (\r\n                    <Chip\r\n                      key={tag}\r\n                      label={getTagDisplayLabel(tag)}\r\n                      size=\"small\"\r\n                      onDelete={isTagEditingAllowed ? () => handleRemoveTag(tag) : undefined}\r\n                      sx={{\r\n                        bgcolor: alpha(theme.palette.secondary.main, 0.1),\r\n                        color: 'secondary.main',\r\n                        fontWeight: 500,\r\n                      }}\r\n                    />\r\n                  ))}\r\n                </Box>\r\n              )}\r\n\r\n              {/* Add new tag input - only for user-created notes */}\r\n              {isTagEditingAllowed ? (\r\n                <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>\r\n                  <Autocomplete\r\n                    size=\"small\"\r\n                    options={defaultTags.filter(t => {\r\n                      if (tags.includes(t)) return false;\r\n                      if (t === 'GUIDELINE' && hasExistingGuideline) return false;\r\n                      return true;\r\n                    })}\r\n                    getOptionLabel={(option) => getTagDisplayLabel(option)}\r\n                    value={null}\r\n                    inputValue={newTagInput}\r\n                    onInputChange={(_, value, reason) => {\r\n                      if (reason !== 'reset') {\r\n                        setNewTagInput(value);\r\n                      }\r\n                    }}\r\n                    onChange={(_, value) => {\r\n                      if (value && typeof value === 'string') {\r\n                        handleAddTag(value);\r\n                      }\r\n                      setNewTagInput('');\r\n                    }}\r\n                    renderOption={(props, option) => (\r\n                      <li {...props} style={{ display: 'block' }}>\r\n                        <Box>\r\n                          <Typography variant=\"body2\" sx={{ fontWeight: 500 }}>\r\n                            {getTagDisplayLabel(option)}\r\n                          </Typography>\r\n                          <Typography variant=\"caption\" color=\"text.secondary\">\r\n                            {getTagSubtitle(option)}\r\n                          </Typography>\r\n                        </Box>\r\n                      </li>\r\n                    )}\r\n                    sx={{ flex: 1 }}\r\n                    ListboxProps={{\r\n                      sx: {\r\n                        ...scrollbarStyles(theme),\r\n                        maxHeight: 250, // Increase max height slightly for better visibility with subtitles\r\n                      }\r\n                    }}\r\n                    slotProps={{\r\n                      popper: {\r\n                        sx: { zIndex: (theme) => theme.zIndex.modal + 200 },\r\n                      },\r\n                    }}\r\n                    renderInput={(params) => (\r\n                      <TextField\r\n                        {...params}\r\n                        placeholder=\"Add a tag...\"\r\n                        InputProps={{\r\n                          ...params.InputProps,\r\n                          sx: { borderRadius: 2 },\r\n                        }}\r\n                      />\r\n                    )}\r\n                  />\r\n\r\n                </Box>\r\n              ) : (\r\n                tags.length === 0 && (\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    No tags on this note.\r\n                  </Typography>\r\n                )\r\n              )}\r\n\r\n              <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 1, display: 'block' }}>\r\n                Select a tag from the list\r\n              </Typography>\r\n            </Box>\r\n          </Collapse>\r\n\r\n          {/* Content Area */}\r\n          <Box\r\n            sx={{\r\n              maxWidth: 900,\r\n              margin: '0 auto',\r\n              px: { xs: 2, md: 6 },\r\n              py: 4,\r\n            }}\r\n          >\r\n            {/* Archived banner */}\r\n            {note && note.is_archived && (\r\n              <Alert severity=\"warning\" sx={{ mb: 2 }}>\r\n                This note is archived.\r\n                <Button\r\n                  onClick={handleArchiveNote}\r\n                  size=\"small\"\r\n                  variant=\"outlined\"\r\n                  sx={{ ml: 2 }}\r\n                >\r\n                  Unarchive\r\n                </Button>\r\n              </Alert>\r\n            )}\r\n\r\n\r\n\r\n            {/* Title */}\r\n            <TextField\r\n              value={title}\r\n              onChange={(e) => setTitle(e.target.value)}\r\n              placeholder=\"Untitled\"\r\n              fullWidth\r\n              multiline\r\n              variant=\"standard\"\r\n              InputProps={{\r\n                disableUnderline: true,\r\n                sx: {\r\n                  fontSize: '2.5rem',\r\n                  fontWeight: 700,\r\n                  lineHeight: 1.2,\r\n                  '& textarea': {\r\n                    padding: 0,\r\n                  },\r\n                },\r\n              }}\r\n              sx={{ mb: 3, mt: 3 }}\r\n            />\r\n\r\n            {/* Content */}\r\n            <RichTextEditor\r\n              ref={editorRef}\r\n              value={content}\r\n              onChange={setContent}\r\n              placeholder=\"Document your emotions, game plan, lessons learned, or trading insights...\"\r\n              minHeight={300}\r\n              maxLength={5000}\r\n              hideCharacterCount={true}\r\n              toolbarVariant=\"none\"\r\n            />\r\n          </Box>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Image Picker Dialog */}\r\n      <ImagePickerDialog\r\n        open={imagePickerOpen}\r\n        onClose={() => setImagePickerOpen(false)}\r\n        onImageSelect={handleImageSelect}\r\n        title=\"Choose a cover image\"\r\n      />\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <ConfirmationDialog\r\n        open={deleteConfirmOpen}\r\n        title=\"Delete Note\"\r\n        message=\"Are you sure you want to permanently delete this note? This action cannot be undone.\"\r\n        confirmText=\"Delete\"\r\n        cancelText=\"Cancel\"\r\n        confirmColor=\"error\"\r\n        onConfirm={handleConfirmDelete}\r\n        onCancel={handleCancelDelete}\r\n        isSubmitting={deleting}\r\n        sx={{ zIndex: Z_INDEX.LOADING_PROGRESS }}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default NoteEditorDialog;\r\n","import React, { useState, useEffect, useCallback } from 'react';\r\nimport {\r\n  TextField,\r\n  Typography,\r\n  Box,\r\n  Chip,\r\n  alpha,\r\n  useTheme,\r\n  Button,\r\n  CircularProgress\r\n} from '@mui/material';\r\nimport { Delete as DeleteIcon, AutoAwesome as AIIcon } from '@mui/icons-material';\r\nimport { getTagChipStyles, formatTagForDisplay, isGroupedTag, getTagGroup, formatTagWithCapitalizedGroup } from '../utils/tagColors';\r\nimport { BaseDialog } from './common';\r\nimport { logger } from '../utils/logger';\r\nimport { scrollbarStyles } from '../styles/scrollbarStyles';\r\nimport { tagService } from '../services/tagService';\r\nimport { useAuthState } from '../contexts/AuthStateContext';\r\n\r\ninterface TagEditDialogProps {\r\n  open: boolean;\r\n  onClose: (definitionUpdated?: boolean) => void;\r\n  tag: string;\r\n  calendarId: string;\r\n  onSuccess?: (oldTag: string, newTag: string, tradesUpdated: number) => void;\r\n  onDelete?: (deletedTag: string, tradesUpdated: number) => void;\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n  /** Pre-loaded definition from parent (skip fetch if provided) */\r\n  initialDefinition?: string;\r\n}\r\n\r\nconst TagEditDialog: React.FC<TagEditDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  tag,\r\n  calendarId,\r\n  onSuccess,\r\n  onDelete,\r\n  onTagUpdated,\r\n  initialDefinition\r\n}) => {\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n  const [newTag, setNewTag] = useState(tag);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [isDeleting, setIsDeleting] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [definition, setDefinition] = useState('');\r\n  const [originalDefinition, setOriginalDefinition] = useState('');\r\n  const [isLoadingDefinition, setIsLoadingDefinition] = useState(false);\r\n\r\n  // Fetch existing definition when dialog opens\r\n  const fetchDefinition = useCallback(async (tagName: string) => {\r\n    if (!user?.id || !tagName) return;\r\n\r\n    setIsLoadingDefinition(true);\r\n    try {\r\n      const def = await tagService.fetchTagDefinition(user.id, tagName);\r\n      setDefinition(def);\r\n      setOriginalDefinition(def);\r\n    } catch (err) {\r\n      logger.error('Error fetching tag definition:', err);\r\n    } finally {\r\n      setIsLoadingDefinition(false);\r\n    }\r\n  }, [user?.id]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (!newTag.trim() || (isGrouped && !tagName.trim())) {\r\n      setError('Tag cannot be empty');\r\n      return;\r\n    }\r\n\r\n    // Validate that the tag doesn't contain multiple colons\r\n    const colonCount = (newTag.match(/:/g) || []).length;\r\n    if (colonCount > 1) {\r\n      setError('Tags can only contain one colon (:) for category formatting');\r\n      return;\r\n    }\r\n\r\n    const tagChanged = newTag !== tag;\r\n    const definitionChanged = definition.trim() !== originalDefinition;\r\n\r\n    if (!tagChanged && !definitionChanged) {\r\n      onClose();\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const trimmedTag = tag.trim();\r\n      // Capitalize the group name before submitting\r\n      const trimmedNewTag = formatTagWithCapitalizedGroup(newTag.trim());\r\n\r\n      if (tagChanged && onTagUpdated) {\r\n        // Use the provided onTagUpdated callback for tag rename\r\n        const result = await onTagUpdated(trimmedTag, trimmedNewTag);\r\n\r\n        if (result.success) {\r\n          // Save or update the definition for the new tag name\r\n          if (user?.id) {\r\n            await tagService.saveTagDefinition(user.id, trimmedNewTag, definition, originalDefinition);\r\n          }\r\n\r\n          if (onSuccess) {\r\n            onSuccess(trimmedTag, trimmedNewTag, result.tradesUpdated || 0);\r\n          }\r\n          onClose(definitionChanged);\r\n        } else {\r\n          setError('Failed to update tag');\r\n        }\r\n      } else {\r\n        // Only definition changed, save it\r\n        if (user?.id) {\r\n          await tagService.saveTagDefinition(user.id, trimmedTag, definition, originalDefinition);\r\n        }\r\n        onClose(true);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error updating tag:', error);\r\n      setError(error instanceof Error ? error.message : 'An unknown error occurred');\r\n    } finally {\r\n      setIsSubmitting(false);\r\n    }\r\n  };\r\n\r\n  const isGrouped = isGroupedTag(tag);\r\n  // For grouped tags, extract the tag name part for the input field\r\n  const getTagNamePart = (fullTag: string) => isGroupedTag(fullTag) ? fullTag.split(':')[1] : fullTag;\r\n  const [tagName, setTagName] = useState(getTagNamePart(tag));\r\n  const [tagGroup, setTagGroup] = useState(isGrouped ? getTagGroup(tag) : '');\r\n\r\n\r\n  // Update state when tag prop changes or dialog opens\r\n  useEffect(() => {\r\n    if (open && tag) {\r\n      setNewTag(tag);\r\n      setTagName(getTagNamePart(tag));\r\n      setTagGroup(isGroupedTag(tag) ? getTagGroup(tag) : '');\r\n      setError(null);\r\n\r\n      // Use initialDefinition if provided, otherwise fetch\r\n      if (initialDefinition !== undefined) {\r\n        setDefinition(initialDefinition);\r\n        setOriginalDefinition(initialDefinition);\r\n      } else {\r\n        fetchDefinition(tag);\r\n      }\r\n    }\r\n  }, [tag, open, fetchDefinition, initialDefinition]);\r\n\r\n  const handleFormSubmit = (e?: React.FormEvent) => {\r\n    if (e) e.preventDefault();\r\n    handleSubmit(e as React.FormEvent);\r\n  };\r\n\r\n  const handleDelete = async () => {\r\n    if (!onDelete) return;\r\n\r\n    setIsDeleting(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const trimmedTag = tag.trim();\r\n\r\n      if (onTagUpdated) {\r\n        // Use the provided onTagUpdated callback with empty string to delete\r\n        const result = await onTagUpdated(trimmedTag, '');\r\n\r\n        if (result.success) {\r\n          onDelete(trimmedTag, result.tradesUpdated || 0);\r\n          onClose();\r\n        } else {\r\n          setError('Failed to delete tag');\r\n        }\r\n      } else {\r\n        setError('No tag update handler provided');\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error deleting tag:', error);\r\n      setError(error instanceof Error ? error.message : 'An unknown error occurred');\r\n    } finally {\r\n      setIsDeleting(false);\r\n    }\r\n  };\r\n\r\n\r\n\r\n  // Create a safe onClose function that checks if submission or deletion is in progress\r\n  const safeOnClose = () => {\r\n    if (!isSubmitting && !isDeleting) {\r\n      onClose();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <BaseDialog\r\n      open={open}\r\n      onClose={safeOnClose}\r\n      maxWidth=\"sm\"\r\n      fullWidth\r\n      title=\"Edit Tag\"\r\n      primaryButtonText={isSubmitting ? 'Updating...' : 'Update Tag'}\r\n      primaryButtonAction={handleFormSubmit}\r\n      isSubmitting={isSubmitting || isDeleting}\r\n      cancelButtonText=\"Cancel\"\r\n      cancelButtonAction={safeOnClose}\r\n      hideCloseButton={isSubmitting || isDeleting}\r\n      actions={\r\n        onDelete && (\r\n          <Button\r\n            variant=\"outlined\"\r\n            color=\"error\"\r\n            startIcon={isDeleting ? <CircularProgress size={16} /> : <DeleteIcon />}\r\n            onClick={handleDelete}\r\n            disabled={isSubmitting || isDeleting}\r\n            sx={{ mr: 1 }}\r\n          >\r\n            {isDeleting ? 'Deleting...' : 'Delete Tag'}\r\n          </Button>\r\n        )\r\n      }\r\n    >\r\n      <Box component=\"form\" onSubmit={handleSubmit} sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>\r\n        <Box sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          gap: 2,\r\n          p: 1,\r\n          mt: 1,\r\n          borderRadius: 1,\r\n          bgcolor: alpha(theme.palette.primary.main, 0.05),\r\n          border: `1px solid ${alpha(theme.palette.primary.main, 0.1)}`\r\n        }}>\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            This will update all trades that use this tag across all years in the calendar.\r\n          </Typography>\r\n\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 1.5,\r\n            p: 1,\r\n            borderRadius: 1,\r\n            bgcolor: theme.palette.background.paper,\r\n            border: `1px solid ${theme.palette.divider}`\r\n          }}>\r\n            <Typography variant=\"body2\" fontWeight={500}>Current tag:</Typography>\r\n            <Chip\r\n              label={formatTagForDisplay(tag)}\r\n              size=\"small\"\r\n              sx={{\r\n                ...getTagChipStyles(tag, theme),\r\n                fontWeight: 600,\r\n                boxShadow: theme.shadows[1]\r\n              }}\r\n            />\r\n          </Box>\r\n        </Box>\r\n\r\n\r\n\r\n        {isGrouped ? (\r\n          <Box sx={{ display: 'flex', gap: 2, alignItems: 'flex-start' }}>\r\n            <TextField\r\n              label=\"Group\"\r\n              value={tagGroup}\r\n              onChange={(e) => {\r\n                const newGroupName = e.target.value;\r\n                // Prevent multiple colons in group name\r\n                if ((newGroupName.match(/:/g) || []).length > 0) {\r\n                  return;\r\n                }\r\n                setTagGroup(newGroupName);\r\n                setNewTag(`${newGroupName}:${tagName}`);\r\n              }}\r\n              fullWidth\r\n              autoFocus\r\n              error={!!error}\r\n              helperText={error}\r\n              disabled={isSubmitting}\r\n              size=\"medium\"\r\n              sx={{\r\n                '& .MuiFormHelperText-root': {\r\n                  color: theme.palette.error.main,\r\n                  fontWeight: 500,\r\n                  marginTop: 1\r\n                }\r\n              }}\r\n            />\r\n\r\n            <TextField\r\n              label=\"Tag Name\"\r\n              value={tagName}\r\n              onChange={(e) => {\r\n                const newTagName = e.target.value;\r\n                // Prevent multiple colons in tag name\r\n                if ((newTagName.match(/:/g) || []).length > 0) {\r\n                  return;\r\n                }\r\n                setTagName(newTagName);\r\n                setNewTag(`${tagGroup}:${newTagName}`);\r\n              }}\r\n              fullWidth\r\n              autoFocus\r\n              error={!!error}\r\n              helperText={error}\r\n              disabled={isSubmitting}\r\n              size=\"medium\"\r\n              sx={{\r\n                '& .MuiFormHelperText-root': {\r\n                  color: theme.palette.error.main,\r\n                  fontWeight: 500,\r\n                  marginTop: 1\r\n                }\r\n              }}\r\n            />\r\n          </Box>\r\n        ) : (\r\n          <TextField\r\n            label=\"Tag Name\"\r\n            value={newTag}\r\n            onChange={(e) => {\r\n              const value = e.target.value;\r\n              // Prevent multiple colons in tag\r\n              if ((value.match(/:/g) || []).length > 1) {\r\n                return;\r\n              }\r\n              setNewTag(value);\r\n              setTagName(value);\r\n            }}\r\n            fullWidth\r\n            autoFocus\r\n            error={!!error}\r\n            helperText={error}\r\n            disabled={isSubmitting}\r\n            size=\"medium\"\r\n            sx={{\r\n              '& .MuiFormHelperText-root': {\r\n                color: theme.palette.error.main,\r\n                fontWeight: 500,\r\n                marginTop: 1\r\n              }\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Tag Definition - helps AI understand custom tags */}\r\n        <TextField\r\n          label=\"Definition (optional)\"\r\n          value={definition}\r\n          onChange={(e) => {\r\n            if (e.target.value.length <= 2024) {\r\n              setDefinition(e.target.value);\r\n            }\r\n          }}\r\n          fullWidth\r\n          multiline\r\n          rows={2}\r\n          disabled={isSubmitting || isLoadingDefinition}\r\n          placeholder=\"What does this tag mean? e.g., 'Trade taken at 0.62 Fibonacci retracement level'\"\r\n          size=\"medium\"\r\n          inputProps={{ maxLength: 2024 }}\r\n          InputProps={{\r\n            startAdornment: isLoadingDefinition ? (\r\n              <CircularProgress size={16} sx={{ mr: 1 }} />\r\n            ) : undefined\r\n          }}\r\n          helperText={\r\n            <Box component=\"span\" sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n              <AIIcon sx={{ fontSize: 14 }} />\r\n              This definition helps the AI assistant understand your custom tags\r\n            </Box>\r\n          }\r\n          sx={{\r\n            '& .MuiInputBase-input': {\r\n              ...scrollbarStyles(theme)\r\n            },\r\n            '& .MuiFormHelperText-root': {\r\n              color: theme.palette.text.secondary,\r\n              display: 'flex',\r\n              alignItems: 'center'\r\n            }\r\n          }}\r\n        />\r\n      </Box>\r\n    </BaseDialog>\r\n  );\r\n};\r\n\r\nexport default TagEditDialog;\r\n","/**\r\n * Animated Text Component\r\n * Provides ChatGPT-like typing animation for AI responses\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Typography, Box } from '@mui/material';\r\n\r\ninterface AnimatedTextProps {\r\n  text: string;\r\n  speed?: number; // Characters per second\r\n  onComplete?: () => void;\r\n  isAnimating?: boolean;\r\n  component?: React.ElementType;\r\n  sx?: any;\r\n}\r\n\r\nconst AnimatedText: React.FC<AnimatedTextProps> = ({\r\n  text,\r\n  speed = 150, // Default 150 characters per second (much faster)\r\n  onComplete,\r\n  isAnimating = true,\r\n  component = 'span',\r\n  sx\r\n}) => {\r\n  const [displayedText, setDisplayedText] = useState('');\r\n  const [currentIndex, setCurrentIndex] = useState(0);\r\n\r\n  useEffect(() => {\r\n    if (!isAnimating) {\r\n      setDisplayedText(text);\r\n      setCurrentIndex(text.length);\r\n      return;\r\n    }\r\n\r\n    if (currentIndex < text.length) {\r\n      const timer = setTimeout(() => {\r\n        setDisplayedText(text.slice(0, currentIndex + 1));\r\n        setCurrentIndex(currentIndex + 1);\r\n      }, 1000 / speed);\r\n\r\n      return () => clearTimeout(timer);\r\n    } else if (currentIndex === text.length && onComplete) {\r\n      onComplete();\r\n    }\r\n  }, [currentIndex, text, speed, isAnimating, onComplete]);\r\n\r\n  // Reset when text changes\r\n  useEffect(() => {\r\n    if (isAnimating) {\r\n      setDisplayedText('');\r\n      setCurrentIndex(0);\r\n    } else {\r\n      setDisplayedText(text);\r\n      setCurrentIndex(text.length);\r\n    }\r\n  }, [text, isAnimating]);\r\n\r\n  // Format content with basic markdown-like formatting\r\n  const formatContent = (content: string) => {\r\n    // For simple text without complex formatting, just return as is\r\n    if (!content.includes('```') && !content.includes('`') && !content.includes('**')) {\r\n      return content;\r\n    }\r\n\r\n    // Split content by code blocks and other formatting\r\n    const parts = content.split(/(```[\\s\\S]*?```|`[^`]+`|\\*\\*[^*]+\\*\\*)/);\r\n\r\n    return parts.map((part, index) => {\r\n      // Code blocks\r\n      if (part.startsWith('```') && part.endsWith('```')) {\r\n        const code = part.slice(3, -3).trim();\r\n        const lines = code.split('\\n');\r\n        const language = lines[0]?.match(/^[a-zA-Z]+$/) ? lines.shift() : '';\r\n        const codeContent = lines.join('\\n');\r\n\r\n        return (\r\n          <Box\r\n            key={index}\r\n            component=\"pre\"\r\n            sx={{\r\n              backgroundColor: 'grey.100',\r\n              p: 1.5,\r\n              borderRadius: 1,\r\n              fontFamily: 'monospace',\r\n              fontSize: '0.875rem',\r\n              overflow: 'auto',\r\n              my: 1,\r\n              whiteSpace: 'pre-wrap',\r\n              border: '1px solid',\r\n              borderColor: 'grey.300'\r\n            }}\r\n          >\r\n            {language && (\r\n              <Box component=\"span\" sx={{ color: 'primary.main', fontSize: '0.75rem', fontWeight: 'bold' }}>\r\n                {language}\r\n                {'\\n'}\r\n              </Box>\r\n            )}\r\n            {codeContent}\r\n          </Box>\r\n        );\r\n      }\r\n\r\n      // Inline code\r\n      if (part.startsWith('`') && part.endsWith('`')) {\r\n        return (\r\n          <Box\r\n            key={index}\r\n            component=\"code\"\r\n            sx={{\r\n              backgroundColor: 'grey.100',\r\n              px: 0.75,\r\n              py: 0.25,\r\n              borderRadius: 0.5,\r\n              fontFamily: 'monospace',\r\n              fontSize: '0.875em',\r\n              border: '1px solid',\r\n              borderColor: 'grey.300'\r\n            }}\r\n          >\r\n            {part.slice(1, -1)}\r\n          </Box>\r\n        );\r\n      }\r\n\r\n      // Bold text\r\n      if (part.startsWith('**') && part.endsWith('**')) {\r\n        return (\r\n          <Box\r\n            key={index}\r\n            component=\"strong\"\r\n            sx={{ fontWeight: 'bold' }}\r\n          >\r\n            {part.slice(2, -2)}\r\n          </Box>\r\n        );\r\n      }\r\n\r\n      // Regular text\r\n      return part;\r\n    });\r\n  };\r\n\r\n  return (\r\n    <Typography\r\n      component={component}\r\n      sx={{\r\n        whiteSpace: 'pre-wrap',\r\n        wordBreak: 'break-word',\r\n        ...sx\r\n      }}\r\n    >\r\n      {formatContent(displayedText)}\r\n    </Typography>\r\n  );\r\n};\r\n\r\nexport default AnimatedText;\r\n","/**\r\n * Event Card Component for AI Chat\r\n * Displays economic event details with dynamic fetching\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Chip,\r\n  useTheme,\r\n  alpha,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport {\r\n  Check as CheckIcon,\r\n  HourglassEmpty as HourglassEmptyIcon,\r\n  TrendingUp as TrendingUpIcon,\r\n  TrendingDown as TrendingDownIcon,\r\n  Remove as NeutralIcon,\r\n  ShowChart as TradeIcon\r\n} from '@mui/icons-material';\r\nimport { format, parseISO, isAfter } from 'date-fns';\r\nimport { EconomicEvent } from '../../types/economicCalendar';\r\nimport { economicCalendarService } from '../../services/economicCalendarService';\r\nimport { logger } from '../../utils/logger';\r\n\r\ninterface EventCardProps {\r\n  eventId: string;\r\n  eventData?: EconomicEvent; // Optional: pre-fetched event data from backend\r\n  compact?: boolean;\r\n  onClick?: (event: EconomicEvent) => void;\r\n  tradeCount?: number; // Number of trades associated with this event\r\n}\r\n\r\n// Helper function to format numeric values with commas\r\nconst formatEventValue = (value: string): string => {\r\n  if (!value) return value;\r\n\r\n  // Try to parse as number\r\n  const numericValue = parseFloat(value.replace(/[^\\d.-]/g, ''));\r\n\r\n  if (isNaN(numericValue)) return value;\r\n\r\n  // Format with commas and preserve original suffix (%, K, M, etc.)\r\n  const suffix = value.replace(/[0-9.-]/g, '').trim();\r\n  const formatted = numericValue.toLocaleString(undefined, {\r\n    minimumFractionDigits: 0,\r\n    maximumFractionDigits: 2\r\n  });\r\n\r\n  return suffix ? `${formatted}${suffix}` : formatted;\r\n};\r\n\r\n// Helper function to get impact color\r\nconst getImpactColor = (impact: string, theme: any) => {\r\n  switch (impact?.toLowerCase()) {\r\n    case 'high':\r\n      return theme.palette.error.main;\r\n    case 'medium':\r\n      return theme.palette.warning.main;\r\n    case 'low':\r\n      return theme.palette.info.main;\r\n    default:\r\n      return theme.palette.success.main;\r\n  }\r\n};\r\n\r\n// Helper function to format time with status\r\nconst formatTimeWithStatus = (time_utc: string) => {\r\n  const eventTime = parseISO(time_utc);\r\n  const now = new Date();\r\n  const isPassed = isAfter(now, eventTime);\r\n\r\n  return {\r\n    time: format(eventTime, 'MMM dd, h:mm a'),\r\n    isPassed,\r\n    isUpcoming: !isPassed\r\n  };\r\n};\r\n\r\n// Helper function to get trend info from actual vs forecast\r\nconst getTrendInfo = (actual_value: string, forecast_value: string, theme: any) => {\r\n  if (!actual_value || !forecast_value) return null;\r\n\r\n  const actualNum = parseFloat(actual_value.replace(/[^\\d.-]/g, ''));\r\n  const forecastNum = parseFloat(forecast_value.replace(/[^\\d.-]/g, ''));\r\n  \r\n  if (isNaN(actualNum) || isNaN(forecastNum)) return null;\r\n  \r\n  if (actualNum > forecastNum) {\r\n    return {\r\n      icon: <TrendingUpIcon sx={{ fontSize: 16, color: theme.palette.success.main }} />,\r\n      text: 'Above',\r\n      color: theme.palette.success.main\r\n    };\r\n  } else if (actualNum < forecastNum) {\r\n    return {\r\n      icon: <TrendingDownIcon sx={{ fontSize: 16, color: theme.palette.error.main }} />,\r\n      text: 'Below',\r\n      color: theme.palette.error.main\r\n    };\r\n  } else {\r\n    return {\r\n      icon: <NeutralIcon sx={{ fontSize: 16, color: theme.palette.text.secondary }} />,\r\n      text: 'As Expected',\r\n      color: theme.palette.text.secondary\r\n    };\r\n  }\r\n};\r\n\r\nconst EventCard: React.FC<EventCardProps> = ({\r\n  eventId,\r\n  eventData,\r\n  compact = false,\r\n  onClick,\r\n  tradeCount = 0\r\n}) => {\r\n  const theme = useTheme();\r\n  const [event, setEvent] = useState<EconomicEvent | null>(eventData || null);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    // Skip fetching if event data was provided\r\n    if (eventData) {\r\n      setEvent(eventData);\r\n      return;\r\n    }\r\n\r\n    const fetchEvent = async () => {\r\n      try {\r\n        setError(null);\r\n\r\n        // Fetch event by ID from economic calendar service\r\n        const fetchedEvent = await economicCalendarService.getEventById(eventId);\r\n\r\n        if (fetchedEvent) {\r\n          setEvent(fetchedEvent);\r\n        } else {\r\n          setError('Event not found');\r\n        }\r\n      } catch (err) {\r\n        logger.error('Failed to fetch economic event:', err);\r\n        setError('Failed to load event');\r\n      }\r\n    };\r\n\r\n    fetchEvent();\r\n  }, [eventId, eventData]);\r\n\r\n  // Show error state\r\n  if (error || !event) {\r\n    return (\r\n      <Paper\r\n        elevation={0}\r\n        sx={{\r\n          p: compact ? 1.5 : 2,\r\n          border: '1px solid',\r\n          borderColor: alpha(theme.palette.error.main, 0.3),\r\n          borderRadius: 2,\r\n          backgroundColor: alpha(theme.palette.error.main, 0.05),\r\n          minHeight: compact ? 80 : 100\r\n        }}\r\n      >\r\n        <Typography variant=\"body2\" color=\"error\" sx={{ textAlign: 'center' }}>\r\n          {error || 'Event not found'}\r\n        </Typography>\r\n      </Paper>\r\n    );\r\n  }\r\n\r\n  const timeInfo = formatTimeWithStatus(event.time_utc);\r\n  const trendInfo = getTrendInfo(event.actual_value, event.forecast_value, theme);\r\n\r\n  return (\r\n    <Paper\r\n      elevation={0}\r\n      sx={{\r\n        p: compact ? 1.5 : 2,\r\n        border: '1px solid',\r\n        borderColor: alpha(theme.palette.divider, 0.3),\r\n        borderRadius: 2,\r\n        backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n        cursor: onClick ? 'pointer' : 'default',\r\n        transition: 'all 0.2s ease-in-out',\r\n        '&:hover': onClick ? {\r\n          borderColor: alpha(theme.palette.primary.main, 0.5),\r\n          backgroundColor: alpha(theme.palette.primary.main, 0.02),\r\n          transform: 'translateY(-1px)',\r\n          boxShadow: theme.shadows[2]\r\n        } : {}\r\n      }}\r\n      onClick={() => onClick?.(event)}\r\n    >\r\n      <Box sx={{ display: 'flex', alignItems: 'flex-start', gap: 0.5, width: '100%' }}>\r\n        {/* Flag and Currency */}\r\n        <Box sx={{ minWidth: 32, maxWidth: 32, mt: 0.25, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 0.5, alignSelf: 'flex-start' }}>\r\n          {event.flag_url && (\r\n            <img\r\n              src={event.flag_url}\r\n              alt={event.country}\r\n              style={{\r\n                width: 20,\r\n                height: 15,\r\n                maxHeight: 15,\r\n                minHeight: 15,\r\n                display: 'block',\r\n                borderRadius: 2,\r\n                objectFit: 'cover',\r\n                border: `1px solid ${alpha(theme.palette.divider, 0.2)}`\r\n              }}\r\n            />\r\n          )}\r\n\r\n          <Typography variant=\"caption\" sx={{\r\n            fontWeight: 700,\r\n            textAlign: 'center',\r\n            fontSize: '0.7rem',\r\n            color: 'text.primary',\r\n            minWidth: 32\r\n          }}>\r\n            {event.currency}\r\n          </Typography>\r\n        </Box>\r\n\r\n        {/* Content Container */}\r\n        <Box sx={{ display: 'flex', flexDirection: 'column',   width: '100%', flex: 1 }}>\r\n          {/* First Row: Time | Status | Impact Badge */}\r\n          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>\r\n            {/* Time */}\r\n            <Typography variant=\"caption\" sx={{\r\n              fontWeight: 600,\r\n              color: timeInfo.isUpcoming ? 'text.primary' : 'text.secondary',\r\n              fontSize: '0.75rem',\r\n              minWidth: 80\r\n            }}>\r\n              {timeInfo.time}\r\n            </Typography>\r\n\r\n            {/* Status Icon */}\r\n            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minWidth: 24 }}>\r\n              {timeInfo.isPassed ? (\r\n                <CheckIcon sx={{\r\n                  color: 'success.main',\r\n                  fontSize: '1rem'\r\n                }} />\r\n              ) : (\r\n                <HourglassEmptyIcon sx={{\r\n                  color: 'warning.main',\r\n                  fontSize: '1rem'\r\n                }} />\r\n              )}\r\n            </Box>\r\n\r\n            {/* Spacer */}\r\n            <Box sx={{ flex: 1 }} />\r\n\r\n            {/* Trade Count Badge */}\r\n            {tradeCount > 0 && (\r\n              <Tooltip\r\n                title={`You've traded this event ${tradeCount} time${tradeCount > 1 ? 's' : ''}`}\r\n                arrow\r\n                placement=\"top\"\r\n              >\r\n                <Chip\r\n                  icon={<TradeIcon sx={{ fontSize: '0.7rem !important', color: 'white !important' }} />}\r\n                  label={tradeCount}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    height: 20,\r\n                    fontSize: '0.6rem',\r\n                    fontWeight: 700,\r\n                    backgroundColor: alpha(theme.palette.primary.main, 0.9),\r\n                    color: 'white',\r\n                    minWidth: 40,\r\n                    borderRadius: 1,\r\n                    cursor: 'pointer',\r\n                    '& .MuiChip-label': {\r\n                      px: 0.5,\r\n                      py: 0.25\r\n                    },\r\n                    '& .MuiChip-icon': {\r\n                      ml: 0.5,\r\n                      mr: -0.25\r\n                    }\r\n                  }}\r\n                />\r\n              </Tooltip>\r\n            )}\r\n\r\n            {/* Impact Badge */}\r\n            <Chip\r\n              label={event.impact.toUpperCase()}\r\n              size=\"small\"\r\n              sx={{\r\n                height: 20,\r\n                fontSize: '0.6rem',\r\n                fontWeight: 700,\r\n                backgroundColor: getImpactColor(event.impact, theme),\r\n                color: 'white',\r\n                minWidth: 40,\r\n                borderRadius: 1,\r\n                '& .MuiChip-label': {\r\n                  px: 0.75,\r\n                  py: 0.25\r\n                }\r\n              }}\r\n            />\r\n          </Box>\r\n\r\n          {/* Second Row: Event Name */}\r\n          <Typography variant=\"body2\" sx={{\r\n            fontWeight: 600,\r\n            fontSize: compact ? '0.85rem' : '0.9rem',\r\n            color: 'text.primary',\r\n            lineHeight: 1.3\r\n          }}>\r\n            {event.event_name}\r\n          </Typography>\r\n\r\n          {/* Third Row: Values (if available and not compact) */}\r\n          {!compact && (event.actual_value || event.forecast_value || event.previous_value) && (\r\n            <Box sx={{ display: 'flex', gap: 1.5, alignItems: 'center', flexWrap: 'wrap' }}>\r\n              {event.actual_value && (\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"caption\" sx={{ color: 'text.secondary', fontSize: '0.7rem' }}>\r\n                    A:\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" sx={{ fontWeight: 600, fontSize: '0.7rem' }}>\r\n                    {formatEventValue(event.actual_value)}\r\n                  </Typography>\r\n                  {trendInfo && trendInfo.icon}\r\n                </Box>\r\n              )}\r\n\r\n              {event.forecast_value && (\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"caption\" sx={{ color: 'text.secondary', fontSize: '0.7rem' }}>\r\n                    F:\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" sx={{ fontWeight: 600, fontSize: '0.7rem' }}>\r\n                    {formatEventValue(event.forecast_value)}\r\n                  </Typography>\r\n                </Box>\r\n              )}\r\n\r\n              {event.previous_value && (\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                  <Typography variant=\"caption\" sx={{ color: 'text.secondary', fontSize: '0.7rem' }}>\r\n                    P:\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" sx={{ fontWeight: 600, fontSize: '0.7rem' }}>\r\n                    {formatEventValue(event.previous_value)}\r\n                  </Typography>\r\n                </Box>\r\n              )}\r\n            </Box>\r\n          )}\r\n        </Box>\r\n      </Box>\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default EventCard;\r\n","/**\r\n * Expandable Card List Component\r\n * Reusable component for displaying a collapsible list with scroll capability\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Box, Button, useTheme, alpha } from '@mui/material';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\n\r\ninterface ExpandableCardListProps {\r\n  items: React.ReactNode[];\r\n  defaultVisibleCount?: number;\r\n  itemType: string; // e.g., \"trades\", \"events\"\r\n}\r\n\r\nconst ExpandableCardList: React.FC<ExpandableCardListProps> = ({\r\n  items,\r\n  defaultVisibleCount = 4,\r\n  itemType\r\n}) => {\r\n  const theme = useTheme();\r\n  const [visibleCount, setVisibleCount] = useState(0);\r\n\r\n  const totalCount = items.length;\r\n\r\n  // Keep visibility in sync with available items\r\n  useEffect(() => {\r\n    if (totalCount === 0) {\r\n      setVisibleCount(0);\r\n      return;\r\n    }\r\n\r\n    setVisibleCount(prev => {\r\n      if (prev === 0) {\r\n        return Math.min(defaultVisibleCount, totalCount);\r\n      }\r\n      return Math.min(prev, totalCount);\r\n    });\r\n  }, [totalCount, defaultVisibleCount]);\r\n\r\n  // No items to display\r\n  if (totalCount === 0) {\r\n    return null;\r\n  }\r\n\r\n  const visibleItems = items.slice(0, visibleCount);\r\n  const isExpanded = visibleCount >= totalCount;\r\n  const enableScrollable = totalCount > defaultVisibleCount && isExpanded;\r\n\r\n  return (\r\n    <>\r\n      <Box\r\n        sx={{\r\n          mt: 1,\r\n          ...(enableScrollable\r\n            ? {\r\n                maxHeight: 350,\r\n                overflowY: 'auto',\r\n                pr: 1,\r\n                border: '1px solid',\r\n                borderColor: alpha(theme.palette.divider, 0.3),\r\n                borderRadius: 0.5,\r\n                backgroundColor: alpha(theme.palette.primary.main, 0.02),\r\n                p: 1.5,\r\n                ...scrollbarStyles(theme)\r\n              }\r\n            : {})\r\n        }}\r\n      >\r\n        {visibleItems}\r\n      </Box>\r\n\r\n      {totalCount > defaultVisibleCount && visibleCount > 0 && (\r\n        <Box sx={{ mt: 2, textAlign: 'center' }}>\r\n          <Button\r\n            size=\"small\"\r\n            variant=\"outlined\"\r\n            onClick={() =>\r\n              setVisibleCount(isExpanded ? defaultVisibleCount : totalCount)\r\n            }\r\n          >\r\n            {isExpanded\r\n              ? `Collapse ${itemType}`\r\n              : `Load ${totalCount - visibleCount} more ${itemType}`}\r\n          </Button>\r\n        </Box>\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default ExpandableCardList;\r\n","/**\r\n * HTML Message Renderer Component\r\n * Safely renders HTML-formatted messages with proper styling\r\n * Supports inline trade, event, and note cards via HTML tags: <trade-ref id=\"xxx\"/>, <event-ref id=\"xxx\"/>, <note-ref id=\"xxx\"/>\r\n */\r\n\r\nimport React, { useMemo, useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  useTheme,\r\n  alpha\r\n} from '@mui/material';\r\nimport DOMPurify from 'dompurify';\r\nimport ImageZoomDialog, { ImageZoomProp } from '../ImageZoomDialog';\r\nimport TradeCard from './TradeCard';\r\nimport EventCard from './EventCard';\r\nimport { NoteListItem } from '../notes/NoteListItem';\r\nimport ExpandableCardList from './ExpandableCardList';\r\nimport type { Trade } from '../../types/trade';\r\nimport type { EconomicEvent } from '../../types/economicCalendar';\r\nimport type { Note } from '../../types/note';\r\nimport { TradeEconomicEvent } from '../../types/dualWrite';\r\nimport { eventMatchV3 } from '../../utils/eventNameUtils';\r\n\r\ninterface HtmlMessageRendererProps {\r\n  html: string;\r\n  textColor?: string;\r\n  // Embedded data for inline card replacement\r\n  embeddedTrades?: Record<string, Trade>;\r\n  embeddedEvents?: Record<string, EconomicEvent>;\r\n  embeddedNotes?: Record<string, Note>;\r\n  onTradeClick?: (tradeId: string, contextTrades: Trade[]) => void;\r\n  onEventClick?: (event: EconomicEvent) => void;\r\n  onNoteClick?: (noteId: string) => void;\r\n  trades?: Trade[]; // All trades for calculating event trade counts\r\n}\r\n\r\nconst HtmlMessageRenderer: React.FC<HtmlMessageRendererProps> = ({\r\n  html,\r\n  textColor = 'text.primary',\r\n  embeddedTrades,\r\n  embeddedEvents,\r\n  embeddedNotes,\r\n  onTradeClick,\r\n  onEventClick,\r\n  onNoteClick,\r\n  trades = []\r\n}) => {\r\n  const theme = useTheme();\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const [imageZoomOpen, setImageZoomOpen] = useState(false);\r\n  const [imageZoomProp, setImageZoomProp] = useState<ImageZoomProp | null>(null);\r\n\r\n  // Create a map of live trades for O(1) lookup\r\n  const liveTradesMap = useMemo(() => {\r\n    const map = new Map<string, Trade>();\r\n    trades.forEach(trade => {\r\n      map.set(trade.id, trade);\r\n    });\r\n    return map;\r\n  }, [trades]);\r\n\r\n  // Merge embedded trades with live data - live data takes precedence\r\n  // This ensures trade cards update when trades are edited\r\n  const mergedEmbeddedTrades = useMemo(() => {\r\n    if (!embeddedTrades) return undefined;\r\n\r\n    const merged: Record<string, Trade> = {};\r\n    Object.entries(embeddedTrades).forEach(([tradeId, embeddedTrade]) => {\r\n      // Use live trade data if available, otherwise fall back to embedded snapshot\r\n      const liveTrade = liveTradesMap.get(tradeId);\r\n      merged[tradeId] = liveTrade || embeddedTrade;\r\n    });\r\n    return merged;\r\n  }, [embeddedTrades, liveTradesMap]);\r\n\r\n  // Calculate trade count for each embedded event\r\n  const eventTradeCountMap = useMemo(() => {\r\n    const countMap = new Map<string, number>();\r\n\r\n    if (!embeddedEvents || trades.length === 0) {\r\n      return countMap;\r\n    }\r\n\r\n    Object.entries(embeddedEvents).forEach(([eventId, event]) => {\r\n      const tradeCount = trades.filter(trade => {\r\n        if (!trade.economic_events || trade.economic_events.length === 0) {\r\n          return false;\r\n        }\r\n        return trade.economic_events.some((tradeEvent: TradeEconomicEvent) => {\r\n          return eventMatchV3(tradeEvent, event);\r\n        });\r\n      }).length;\r\n\r\n      countMap.set(eventId, tradeCount);\r\n    });\r\n\r\n    return countMap;\r\n  }, [embeddedEvents, trades]);\r\n\r\n  // Parse HTML into segments with inline cards\r\n  const contentSegments = useMemo(() => {\r\n    if (!embeddedTrades && !embeddedEvents && !embeddedNotes) {\r\n      // No inline cards needed, return single HTML segment\r\n      return [{ type: 'html' as const, content: html }];\r\n    }\r\n\r\n    const segments: Array<{ type: 'html' | 'trade' | 'event' | 'note'; content: string; id?: string }> = [];\r\n    let lastIndex = 0;\r\n    let workingHtml = html;\r\n\r\n    // Find all inline references (HTML tags: <trade-ref id=\"xxx\"/>, <event-ref id=\"xxx\"/>, <note-ref id=\"xxx\"/>)\r\n    const references: Array<{ type: 'trade' | 'event' | 'note'; id: string; index: number; length: number }> = [];\r\n\r\n    // Find trade reference tags (self-closing or with closing tag)\r\n    const tradePattern = /<trade-ref\\s+id=\"([a-zA-Z0-9-_]+)\"(?:\\s*\\/)?>(?:<\\/trade-ref>)?/g;\r\n    let match;\r\n    while ((match = tradePattern.exec(workingHtml)) !== null) {\r\n      const tradeId = match[1];\r\n      if (embeddedTrades?.[tradeId]) {\r\n        references.push({\r\n          type: 'trade',\r\n          id: tradeId,\r\n          index: match.index,\r\n          length: match[0].length\r\n        });\r\n      }\r\n    }\r\n\r\n    // Find event reference tags\r\n    const eventPattern = /<event-ref\\s+id=\"([a-zA-Z0-9-_]+)\"(?:\\s*\\/)?>(?:<\\/event-ref>)?/g;\r\n    while ((match = eventPattern.exec(workingHtml)) !== null) {\r\n      const eventId = match[1];\r\n      if (embeddedEvents?.[eventId]) {\r\n        references.push({\r\n          type: 'event',\r\n          id: eventId,\r\n          index: match.index,\r\n          length: match[0].length\r\n        });\r\n      }\r\n    }\r\n\r\n    // Find note reference tags\r\n    const notePattern = /<note-ref\\s+id=\"([a-zA-Z0-9-_]+)\"(?:\\s*\\/)?>(?:<\\/note-ref>)?/g;\r\n    while ((match = notePattern.exec(workingHtml)) !== null) {\r\n      const noteId = match[1];\r\n      if (embeddedNotes?.[noteId]) {\r\n        references.push({\r\n          type: 'note',\r\n          id: noteId,\r\n          index: match.index,\r\n          length: match[0].length\r\n        });\r\n      }\r\n    }\r\n\r\n    // Sort references by index\r\n    references.sort((a, b) => a.index - b.index);\r\n\r\n    // Build segments\r\n    references.forEach(ref => {\r\n      // Add HTML before this reference\r\n      if (ref.index > lastIndex) {\r\n        const htmlSegment = workingHtml.substring(lastIndex, ref.index);\r\n        if (htmlSegment.trim()) {\r\n          segments.push({ type: 'html', content: htmlSegment });\r\n        }\r\n      }\r\n\r\n      // Add card segment\r\n      segments.push({\r\n        type: ref.type,\r\n        content: '',\r\n        id: ref.id\r\n      });\r\n\r\n      lastIndex = ref.index + ref.length;\r\n    });\r\n\r\n    // Add remaining HTML\r\n    if (lastIndex < workingHtml.length) {\r\n      const htmlSegment = workingHtml.substring(lastIndex);\r\n      if (htmlSegment.trim()) {\r\n        segments.push({ type: 'html', content: htmlSegment });\r\n      }\r\n    }\r\n\r\n    return segments.length > 0 ? segments : [{ type: 'html' as const, content: html }];\r\n  }, [html, embeddedTrades, embeddedEvents, embeddedNotes]);\r\n\r\n  // Sanitize HTML segments\r\n  const sanitizeHtml = (htmlContent: string) => {\r\n    const purify = DOMPurify(window);\r\n    return purify.sanitize(htmlContent, {\r\n      ALLOWED_TAGS: [\r\n        'p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\r\n        'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'span', 'div', 'img'\r\n      ],\r\n      ALLOWED_ATTR: ['href', 'target', 'rel', 'class', 'style', 'src', 'alt', 'width', 'height'],\r\n      KEEP_CONTENT: true\r\n    });\r\n  };\r\n\r\n  // Extract image URLs for all HTML segments\r\n  const sanitizedHtml = useMemo(() => {\r\n    return contentSegments\r\n      .filter(seg => seg.type === 'html')\r\n      .map(seg => sanitizeHtml(seg.content))\r\n      .join('');\r\n  }, [contentSegments]);\r\n\r\n  // Extract image URLs from sanitized HTML\r\n  const imageUrls = useMemo(() => {\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(sanitizedHtml, 'text/html');\r\n    const images = doc.querySelectorAll('img');\r\n    const urls = Array.from(images).map(img => img.src);\r\n    return urls;\r\n  }, [sanitizedHtml]);\r\n\r\n  // Use event delegation - attach ONE handler to container instead of individual images\r\n  // This way the handler persists even when images are re-rendered\r\n  useEffect(() => {\r\n    const container = containerRef.current;\r\n    if (!container) return;\r\n\r\n    // Handler attached to container that delegates to images\r\n    const handleContainerClick = (e: MouseEvent) => {\r\n      const target = e.target as HTMLElement;\r\n\r\n      // Check if clicked element is an image\r\n      if (target.tagName === 'IMG') {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        // Find the index of this image\r\n        const images = container.querySelectorAll('img');\r\n        const index = Array.from(images).indexOf(target as HTMLImageElement);\r\n\r\n        if (index !== -1) {\r\n          const isAIChart = imageUrls[index]?.includes('quickchart.io');\r\n          setImageZoomProp({\r\n            selectetdImageIndex: index,\r\n            allImages: imageUrls,\r\n            useSolidBackground: isAIChart\r\n          });\r\n          setImageZoomOpen(true);\r\n        }\r\n      }\r\n    };\r\n\r\n    // Attach single handler to container\r\n    container.addEventListener('click', handleContainerClick);\r\n\r\n    // Cleanup - remove handler when component unmounts\r\n    return () => {\r\n      container.removeEventListener('click', handleContainerClick);\r\n    };\r\n  }, [imageUrls]); // Only re-attach if imageUrls change\r\n\r\n  // Style images with cursor pointer\r\n  useEffect(() => {\r\n    if (!containerRef.current) return;\r\n\r\n    const timeoutId = setTimeout(() => {\r\n      if (!containerRef.current) return;\r\n\r\n      const images = containerRef.current.querySelectorAll('img');\r\n      images.forEach((img) => {\r\n        (img as HTMLImageElement).style.cursor = 'pointer';\r\n        (img as HTMLImageElement).style.userSelect = 'none';\r\n      });\r\n    }, 100);\r\n\r\n    return () => clearTimeout(timeoutId);\r\n  }, [sanitizedHtml]);\r\n\r\n  const renderContentSegments = () => {\r\n    const nodes: React.ReactNode[] = [];\r\n    let currentTradeNodes: React.ReactNode[] = [];\r\n\r\n    const flushTrades = () => {\r\n      if (currentTradeNodes.length === 0) return;\r\n\r\n      nodes.push(\r\n        <ExpandableCardList\r\n          key={`trade-list-${nodes.length}`}\r\n          items={currentTradeNodes}\r\n          itemType=\"trades\"\r\n        />\r\n      );\r\n\r\n      currentTradeNodes = [];\r\n    };\r\n\r\n    const hasTextContent = (htmlSegment: string) => {\r\n      const textOnly = htmlSegment\r\n        .replace(/<[^>]*>/g, '')\r\n        .replace(/&nbsp;/gi, ' ')\r\n        .trim();\r\n      return textOnly.length > 0;\r\n    };\r\n\r\n    contentSegments.forEach((segment, index) => {\r\n      if (segment.type === 'trade' && segment.id && mergedEmbeddedTrades?.[segment.id]) {\r\n        const trade = mergedEmbeddedTrades[segment.id];\r\n        const contextTrades = Object.values(mergedEmbeddedTrades);\r\n\r\n        currentTradeNodes.push(\r\n          <Box key={`trade-${index}`} sx={{ my: 1 }}>\r\n            <TradeCard\r\n              trade={trade}\r\n              showTags={true}\r\n              onClick={() => onTradeClick?.(trade.id, contextTrades)}\r\n            />\r\n          </Box>\r\n        );\r\n\r\n        return;\r\n      }\r\n\r\n      if (segment.type === 'html') {\r\n        const hasText = hasTextContent(segment.content);\r\n\r\n        // Only flush trades when this HTML has actual text content (e.g. section headers).\r\n        // Decorative HTML like <br> or empty <p> tags should not split trade groups.\r\n        if (hasText) {\r\n          flushTrades();\r\n        }\r\n\r\n        // Skip rendering segments that have no visible text content to avoid\r\n        // large blank gaps between sections.\r\n        if (!hasText) {\r\n          return;\r\n        }\r\n\r\n        nodes.push(\r\n          <Typography\r\n            key={`html-${index}`}\r\n            component=\"div\"\r\n            sx={{\r\n              color: textColor,\r\n              whiteSpace: 'pre-wrap',\r\n              wordBreak: 'break-word',\r\n              overflowWrap: 'anywhere'\r\n            }}\r\n            dangerouslySetInnerHTML={{ __html: sanitizeHtml(segment.content) }}\r\n          />\r\n        );\r\n        return;\r\n      }\r\n\r\n      if (segment.type === 'event' && segment.id && embeddedEvents?.[segment.id]) {\r\n        // Events should be rendered as their own block, separate from any trade group\r\n        flushTrades();\r\n\r\n        const event = embeddedEvents[segment.id];\r\n        const tradeCount = eventTradeCountMap.get(segment.id) || 0;\r\n        nodes.push(\r\n          <Box key={`event-${index}`} sx={{ my: 1 }}>\r\n            <EventCard\r\n              eventId={segment.id}\r\n              eventData={event}\r\n              onClick={onEventClick}\r\n              compact={false}\r\n              tradeCount={tradeCount}\r\n            />\r\n          </Box>\r\n        );\r\n      }\r\n\r\n      if (segment.type === 'note' && segment.id && embeddedNotes?.[segment.id]) {\r\n        // Notes should be rendered as their own block, separate from any trade group\r\n        flushTrades();\r\n\r\n        const note = embeddedNotes[segment.id];\r\n        nodes.push(\r\n          <Box key={`note-${index}`} sx={{ my: 1 }}>\r\n            <NoteListItem\r\n              note={note}\r\n              onClick={() => onNoteClick?.(segment.id!)}\r\n            />\r\n          </Box>\r\n        );\r\n      }\r\n    });\r\n\r\n    // Flush any remaining trades at the end\r\n    flushTrades();\r\n\r\n    return nodes;\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Box\r\n        ref={containerRef}\r\n        sx={{\r\n          '& p': {\r\n            margin: '0.5rem 0',\r\n            lineHeight: 1.5\r\n          },\r\n          '& strong': {\r\n            fontWeight: 600\r\n          },\r\n          '& em': {\r\n            fontStyle: 'italic'\r\n          },\r\n          '& h1, & h2, & h3, & h4, & h5, & h6': {\r\n            margin: '1rem 0 0.5rem 0',\r\n            fontWeight: 600\r\n          },\r\n          '& h1': { fontSize: '1.5rem' },\r\n          '& h2': { fontSize: '1.25rem' },\r\n          '& h3': { fontSize: '1.1rem' },\r\n          '& h4': { fontSize: '1rem' },\r\n          '& h5': { fontSize: '0.95rem' },\r\n          '& h6': { fontSize: '0.9rem' },\r\n          '& ul, & ol': {\r\n            margin: '0.5rem 0',\r\n            paddingLeft: '1.5rem'\r\n          },\r\n          '& li': {\r\n            margin: '0.25rem 0'\r\n          },\r\n          '& blockquote': {\r\n            margin: '0.5rem 0',\r\n            paddingLeft: '1rem',\r\n            borderLeft: `3px solid ${alpha(theme.palette.text.primary, 0.3)}`,\r\n            opacity: 0.8\r\n          },\r\n          '& code': {\r\n            backgroundColor: alpha(theme.palette.text.primary, 0.1),\r\n            padding: '2px 4px',\r\n            borderRadius: 1,\r\n            fontFamily: 'monospace',\r\n            fontSize: '0.9em'\r\n          },\r\n          '& pre': {\r\n            backgroundColor: alpha(theme.palette.text.primary, 0.05),\r\n            padding: '1rem',\r\n            borderRadius: 1,\r\n            overflowX: 'auto',\r\n            margin: '0.5rem 0'\r\n          },\r\n          '& pre code': {\r\n            backgroundColor: 'transparent',\r\n            padding: 0\r\n          },\r\n          '& a': {\r\n            color: 'primary.main',\r\n            textDecoration: 'underline',\r\n            cursor: 'pointer',\r\n            '&:hover': {\r\n              opacity: 0.8\r\n            }\r\n          },\r\n          '& img': {\r\n            maxWidth: '100%',\r\n            height: 'auto',\r\n            minHeight: 100,\r\n            backgroundColor: theme.palette.mode === 'dark'\r\n              ? alpha(theme.palette.background.paper, 0.8)\r\n              : alpha(theme.palette.grey[100], 0.8),\r\n            maxHeight: '300px',\r\n            borderRadius: 2,\r\n            display: 'block',\r\n            cursor: 'pointer',\r\n            transition: 'transform 0.2s, box-shadow 0.2s',\r\n            '&:hover': {\r\n              transform: 'scale(1.02)',\r\n              boxShadow: theme.shadows[4]\r\n            }\r\n          },\r\n          '& sup': {\r\n            fontSize: '0.8em',\r\n            verticalAlign: 'super'\r\n          }\r\n        }}\r\n      >\r\n        {/* Render segments (HTML and cards mixed) */}\r\n        {renderContentSegments()}\r\n      </Box>\r\n\r\n      {/* Image Zoom Dialog */}\r\n      {imageZoomProp && (\r\n        <ImageZoomDialog\r\n          open={imageZoomOpen}\r\n          onClose={() => setImageZoomOpen(false)}\r\n          imageProp={imageZoomProp}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default HtmlMessageRenderer;\r\n\r\n","/**\r\n * Citations Section Component\r\n * Displays sources and citations from AI agent tool usage\r\n * Compact pill design with favicon previews that expands to show details\r\n */\r\n\r\nimport React, { useState } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Chip,\r\n  Collapse,\r\n  useTheme,\r\n  alpha,\r\n  Popover,\r\n  Avatar,\r\n  AvatarGroup\r\n} from '@mui/material';\r\nimport {\r\n  OpenInNew as OpenInNewIcon,\r\n  ExpandMore as ExpandMoreIcon,\r\n  Language as LanguageIcon\r\n} from '@mui/icons-material';\r\nimport { Citation } from '../../types/aiChat';\r\n\r\ninterface CitationsSectionProps {\r\n  citations: Citation[];\r\n  compact?: boolean;\r\n}\r\n\r\nconst CitationsSection: React.FC<CitationsSectionProps> = ({\r\n  citations,\r\n  compact = false\r\n}) => {\r\n  const theme = useTheme();\r\n  const [expanded, setExpanded] = useState(false);\r\n  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);\r\n  const [faviconErrors, setFaviconErrors] = useState<Set<string>>(new Set());\r\n\r\n  if (!citations || citations.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const getToolColor = (toolName: string): 'default' | 'primary' | 'secondary' | 'error' | 'warning' | 'info' | 'success' => {\r\n    switch (toolName) {\r\n      case 'search_web':\r\n        return 'primary';\r\n      case 'scrape_url':\r\n        return 'secondary';\r\n      case 'execute_sql':\r\n        return 'info';\r\n      case 'price_data':\r\n        return 'success';\r\n      default:\r\n        return 'default';\r\n    }\r\n  };\r\n\r\n  const getToolLabel = (toolName: string): string => {\r\n    switch (toolName) {\r\n      case 'search_web':\r\n        return 'Web';\r\n      case 'scrape_url':\r\n        return 'Article';\r\n      case 'execute_sql':\r\n        return 'DB';\r\n      case 'price_data':\r\n        return 'Price';\r\n      default:\r\n        return toolName;\r\n    }\r\n  };\r\n\r\n  const getDomainFromUrl = (url: string): string => {\r\n    try {\r\n      const parsedUrl = new URL(url);\r\n      return parsedUrl.hostname.replace(/^www\\./, '');\r\n    } catch {\r\n      return url;\r\n    }\r\n  };\r\n\r\n  const getFaviconUrl = (url: string): string => {\r\n    try {\r\n      const domain = getDomainFromUrl(url);\r\n      // Use Google's favicon service for reliable favicon fetching\r\n      return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;\r\n    } catch {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  const handleFaviconError = (url: string) => {\r\n    setFaviconErrors(prev => new Set(prev).add(url));\r\n  };\r\n\r\n  const handleOpenUrl = (url: string) => {\r\n    window.open(url, '_blank', 'noopener,noreferrer');\r\n  };\r\n\r\n  const handleClick = (event: React.MouseEvent<HTMLElement>) => {\r\n    if (compact) {\r\n      setAnchorEl(event.currentTarget);\r\n    } else {\r\n      setExpanded(!expanded);\r\n    }\r\n  };\r\n\r\n  const handleClose = () => {\r\n    setAnchorEl(null);\r\n  };\r\n\r\n  const open = Boolean(anchorEl);\r\n\r\n  // Get unique domains for favicon display (max 4)\r\n  const uniqueCitations = citations.reduce((acc, citation) => {\r\n    const domain = getDomainFromUrl(citation.url);\r\n    if (!acc.some(c => getDomainFromUrl(c.url) === domain)) {\r\n      acc.push(citation);\r\n    }\r\n    return acc;\r\n  }, [] as Citation[]).slice(0, 4);\r\n\r\n  // Render favicon avatar\r\n  const renderFavicon = (url: string, size: number = 20) => {\r\n    const faviconUrl = getFaviconUrl(url);\r\n    const hasError = faviconErrors.has(url);\r\n\r\n    if (hasError || !faviconUrl) {\r\n      return (\r\n        <Avatar\r\n          sx={{\r\n            width: size,\r\n            height: size,\r\n            backgroundColor: alpha(theme.palette.primary.main, 0.15),\r\n            color: 'primary.main'\r\n          }}\r\n        >\r\n          <LanguageIcon sx={{ fontSize: size * 0.6 }} />\r\n        </Avatar>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Avatar\r\n        src={faviconUrl}\r\n        sx={{\r\n          width: size,\r\n          height: size,\r\n          backgroundColor: alpha(theme.palette.background.paper, 0.9),\r\n          border: `1px solid ${alpha(theme.palette.divider, 0.3)}`\r\n        }}\r\n        onError={() => handleFaviconError(url)}\r\n      >\r\n        <LanguageIcon sx={{ fontSize: size * 0.6 }} />\r\n      </Avatar>\r\n    );\r\n  };\r\n\r\n  // Render citation list content\r\n  const renderCitationsList = () => (\r\n    <Box\r\n      sx={{\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 0.5,\r\n        p: compact ? 1.5 : 0,\r\n        maxWidth: compact ? 350 : 'none',\r\n        maxHeight: compact ? 300 : 'none',\r\n        overflow: 'auto'\r\n      }}\r\n    >\r\n      {citations.map((citation) => (\r\n        <Paper\r\n          key={citation.id}\r\n          variant=\"outlined\"\r\n          sx={{\r\n            px: 1.5,\r\n            py: 1,\r\n            borderRadius: 2,\r\n            backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n            border: `1px solid ${alpha(theme.palette.divider, 0.5)}`,\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 1.5,\r\n            cursor: 'pointer',\r\n            transition: 'all 0.15s ease',\r\n            '&:hover': {\r\n              backgroundColor: alpha(theme.palette.action.hover, 0.6),\r\n              borderColor: alpha(theme.palette.primary.main, 0.5)\r\n            }\r\n          }}\r\n          onClick={() => handleOpenUrl(citation.url)}\r\n        >\r\n          {/* Favicon */}\r\n          {renderFavicon(citation.url, 22)}\r\n\r\n          {/* Main content */}\r\n          <Box sx={{ flex: 1, minWidth: 0 }}>\r\n            <Typography\r\n              variant=\"body2\"\r\n              sx={{\r\n                fontWeight: 500,\r\n                color: 'text.primary',\r\n                overflow: 'hidden',\r\n                textOverflow: 'ellipsis',\r\n                whiteSpace: 'nowrap',\r\n                fontSize: '0.8rem'\r\n              }}\r\n            >\r\n              {citation.title || getDomainFromUrl(citation.url)}\r\n            </Typography>\r\n            <Typography\r\n              variant=\"caption\"\r\n              sx={{\r\n                display: 'block',\r\n                color: 'text.secondary',\r\n                overflow: 'hidden',\r\n                textOverflow: 'ellipsis',\r\n                whiteSpace: 'nowrap',\r\n                fontSize: '0.7rem'\r\n              }}\r\n            >\r\n              {getDomainFromUrl(citation.url)}\r\n            </Typography>\r\n          </Box>\r\n\r\n          {/* Tool tag */}\r\n          {citation.toolName && (\r\n            <Chip\r\n              label={getToolLabel(citation.toolName)}\r\n              size=\"small\"\r\n              color={getToolColor(citation.toolName)}\r\n              variant=\"outlined\"\r\n              sx={{\r\n                height: 18,\r\n                fontSize: '0.6rem',\r\n                flexShrink: 0,\r\n                borderRadius: 999,\r\n                '& .MuiChip-label': { px: 0.75 }\r\n              }}\r\n            />\r\n          )}\r\n\r\n          {/* Open icon */}\r\n          <OpenInNewIcon sx={{ fontSize: 14, color: 'text.secondary', flexShrink: 0 }} />\r\n        </Paper>\r\n      ))}\r\n    </Box>\r\n  );\r\n\r\n  return (\r\n    <Box sx={{ mt: 1.5, display: 'inline-block' }}>\r\n      {/* Compact \"Sources\" pill with favicons */}\r\n      <Box\r\n        onClick={handleClick}\r\n        sx={{\r\n          display: 'inline-flex',\r\n          alignItems: 'center',\r\n          gap: 0.75,\r\n          height: 28,\r\n          px: 1,\r\n          borderRadius: 999,\r\n          backgroundColor: alpha(theme.palette.background.paper, 0.6),\r\n          border: `1px solid ${alpha(theme.palette.divider, 0.5)}`,\r\n          cursor: 'pointer',\r\n          transition: 'all 0.15s ease',\r\n          '&:hover': {\r\n            backgroundColor: alpha(theme.palette.action.hover, 0.6),\r\n            borderColor: alpha(theme.palette.primary.main, 0.4)\r\n          }\r\n        }}\r\n      >\r\n        {/* Favicon stack */}\r\n        <AvatarGroup\r\n          max={4}\r\n          sx={{\r\n            '& .MuiAvatar-root': {\r\n              width: 18,\r\n              height: 18,\r\n              fontSize: '0.6rem',\r\n              border: `1px solid ${theme.palette.background.paper}`,\r\n              backgroundColor: alpha(theme.palette.primary.main, 0.15),\r\n              color: 'primary.main'\r\n            },\r\n            '& .MuiAvatarGroup-avatar': {\r\n              marginLeft: -0.75\r\n            }\r\n          }}\r\n        >\r\n          {uniqueCitations.map((citation) => (\r\n            <Avatar\r\n              key={citation.id}\r\n              src={getFaviconUrl(citation.url)}\r\n              sx={{\r\n                width: 18,\r\n                height: 18,\r\n                backgroundColor: alpha(theme.palette.background.paper, 0.9)\r\n              }}\r\n              onError={() => handleFaviconError(citation.url)}\r\n            >\r\n              <LanguageIcon sx={{ fontSize: 10 }} />\r\n            </Avatar>\r\n          ))}\r\n        </AvatarGroup>\r\n\r\n        {/* \"Sources\" text */}\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            fontSize: '0.75rem',\r\n            fontWeight: 500,\r\n            color: 'text.secondary'\r\n          }}\r\n        >\r\n          Sources\r\n        </Typography>\r\n\r\n        {/* Expand icon */}\r\n        <ExpandMoreIcon\r\n          sx={{\r\n            fontSize: 16,\r\n            color: 'text.secondary',\r\n            transform: expanded || open ? 'rotate(180deg)' : 'rotate(0deg)',\r\n            transition: 'transform 0.2s'\r\n          }}\r\n        />\r\n      </Box>\r\n\r\n      {/* Popover for compact mode */}\r\n      {compact && (\r\n        <Popover\r\n          open={open}\r\n          anchorEl={anchorEl}\r\n          onClose={handleClose}\r\n          anchorOrigin={{\r\n            vertical: 'bottom',\r\n            horizontal: 'left'\r\n          }}\r\n          transformOrigin={{\r\n            vertical: 'top',\r\n            horizontal: 'left'\r\n          }}\r\n          PaperProps={{\r\n            sx: {\r\n              mt: 1,\r\n              borderRadius: 2,\r\n              boxShadow: theme.shadows[8]\r\n            }\r\n          }}\r\n        >\r\n          {renderCitationsList()}\r\n        </Popover>\r\n      )}\r\n\r\n      {/* Collapse for non-compact mode */}\r\n      {!compact && (\r\n        <Collapse in={expanded} timeout=\"auto\">\r\n          <Box sx={{ mt: 1 }}>\r\n            {renderCitationsList()}\r\n          </Box>\r\n        </Collapse>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default CitationsSection;\r\n","/**\r\n * Markdown Renderer Component\r\n * Renders markdown content with proper styling for tables, code blocks, and more\r\n */\r\n\r\nimport React from 'react';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport remarkGfm from 'remark-gfm';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableContainer,\r\n  TableHead,\r\n  TableRow,\r\n  useTheme,\r\n  alpha,\r\n  Chip\r\n} from '@mui/material';\r\n\r\ninterface MarkdownRendererProps {\r\n  content: string;\r\n}\r\n\r\nconst MarkdownRenderer: React.FC<MarkdownRendererProps> = ({ content }) => {\r\n  const theme = useTheme();\r\n\r\n  return (\r\n    <ReactMarkdown\r\n      remarkPlugins={[remarkGfm]}\r\n      components={{\r\n        // Table rendering\r\n        table: ({ children }) => (\r\n          <TableContainer\r\n            component={Paper}\r\n            variant=\"outlined\"\r\n            sx={{\r\n              my: 2,\r\n              maxWidth: '100%',\r\n              overflow: 'auto',\r\n              backgroundColor: theme.palette.mode === 'dark' ? 'grey.900' : 'grey.50',\r\n              border: `1px solid ${alpha(theme.palette.divider, 0.2)}`,\r\n              borderRadius: 2\r\n            }}\r\n          >\r\n            <Table size=\"small\" sx={{ minWidth: 300 }}>\r\n              {children}\r\n            </Table>\r\n          </TableContainer>\r\n        ),\r\n        thead: ({ children }) => (\r\n          <TableHead\r\n            sx={{\r\n              backgroundColor: theme.palette.mode === 'dark'\r\n                ? alpha(theme.palette.primary.main, 0.15)\r\n                : alpha(theme.palette.primary.main, 0.08)\r\n            }}\r\n          >\r\n            {children}\r\n          </TableHead>\r\n        ),\r\n        tbody: ({ children }) => <TableBody>{children}</TableBody>,\r\n        tr: ({ children }) => <TableRow>{children}</TableRow>,\r\n        th: ({ children }) => (\r\n          <TableCell\r\n            sx={{\r\n              fontWeight: 700,\r\n              fontSize: '0.875rem',\r\n              color: 'primary.main',\r\n              borderBottom: `2px solid ${theme.palette.primary.main}`,\r\n              py: 1.5,\r\n              px: 2\r\n            }}\r\n          >\r\n            {children}\r\n          </TableCell>\r\n        ),\r\n        td: ({ children }) => (\r\n          <TableCell\r\n            sx={{\r\n              fontSize: '0.85rem',\r\n              py: 1.5,\r\n              px: 2,\r\n              borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`\r\n            }}\r\n          >\r\n            {children}\r\n          </TableCell>\r\n        ),\r\n\r\n        // Code blocks\r\n        code: ({ inline, className, children, ...props }: any) => {\r\n          const match = /language-(\\w+)/.exec(className || '');\r\n          const language = match ? match[1] : '';\r\n\r\n          if (!inline && language) {\r\n            return (\r\n              <Paper\r\n                variant=\"outlined\"\r\n                sx={{\r\n                  p: 2,\r\n                  my: 1,\r\n                  backgroundColor: theme.palette.mode === 'dark' ? 'grey.900' : 'grey.50',\r\n                  fontFamily: 'monospace',\r\n                  fontSize: '0.875rem',\r\n                  overflow: 'auto'\r\n                }}\r\n              >\r\n                {language && (\r\n                  <Chip\r\n                    label={language}\r\n                    size=\"small\"\r\n                    sx={{ mb: 1, fontSize: '0.75rem' }}\r\n                  />\r\n                )}\r\n                <Typography\r\n                  component=\"pre\"\r\n                  sx={{\r\n                    margin: 0,\r\n                    whiteSpace: 'pre-wrap',\r\n                    wordBreak: 'break-word',\r\n                    overflowWrap: 'anywhere',\r\n                    fontFamily: 'inherit'\r\n                  }}\r\n                >\r\n                  {children}\r\n                </Typography>\r\n              </Paper>\r\n            );\r\n          }\r\n\r\n          // Inline code\r\n          return (\r\n            <Box\r\n              component=\"code\"\r\n              sx={{\r\n                backgroundColor: alpha(theme.palette.text.primary, 0.1),\r\n                padding: '2px 4px',\r\n                borderRadius: 1,\r\n                fontFamily: 'monospace',\r\n                fontSize: '0.875em'\r\n              }}\r\n              {...props}\r\n            >\r\n              {children}\r\n            </Box>\r\n          );\r\n        },\r\n\r\n        // Paragraphs\r\n        p: ({ children }) => (\r\n          <Typography\r\n            component=\"p\"\r\n            sx={{\r\n              mb: 1.5,\r\n              lineHeight: 1.6,\r\n              whiteSpace: 'pre-wrap',\r\n              wordBreak: 'break-word',\r\n              overflowWrap: 'anywhere'\r\n            }}\r\n          >\r\n            {children}\r\n          </Typography>\r\n        ),\r\n\r\n        // Headings\r\n        h1: ({ children }) => (\r\n          <Typography\r\n            variant=\"h5\"\r\n            sx={{ fontWeight: 700, mt: 2, mb: 1.5 }}\r\n          >\r\n            {children}\r\n          </Typography>\r\n        ),\r\n        h2: ({ children }) => (\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{ fontWeight: 600, mt: 2, mb: 1 }}\r\n          >\r\n            {children}\r\n          </Typography>\r\n        ),\r\n        h3: ({ children }) => (\r\n          <Typography\r\n            variant=\"subtitle1\"\r\n            sx={{ fontWeight: 600, mt: 1.5, mb: 1 }}\r\n          >\r\n            {children}\r\n          </Typography>\r\n        ),\r\n\r\n        // Lists\r\n        ul: ({ children }) => (\r\n          <Box component=\"ul\" sx={{ pl: 3, mb: 1.5 }}>\r\n            {children}\r\n          </Box>\r\n        ),\r\n        ol: ({ children }) => (\r\n          <Box component=\"ol\" sx={{ pl: 3, mb: 1.5 }}>\r\n            {children}\r\n          </Box>\r\n        ),\r\n        li: ({ children }) => (\r\n          <Box\r\n            component=\"li\"\r\n            sx={{\r\n              mb: 0.5,\r\n              lineHeight: 1.6,\r\n              '& > p': { mb: 0 }\r\n            }}\r\n          >\r\n            {children}\r\n          </Box>\r\n        ),\r\n\r\n        // Blockquote\r\n        blockquote: ({ children }) => (\r\n          <Box\r\n            component=\"blockquote\"\r\n            sx={{\r\n              borderLeft: `4px solid ${theme.palette.primary.main}`,\r\n              pl: 2,\r\n              py: 0.5,\r\n              my: 1.5,\r\n              fontStyle: 'italic',\r\n              color: 'text.secondary',\r\n              backgroundColor: alpha(theme.palette.primary.main, 0.05),\r\n              borderRadius: 1\r\n            }}\r\n          >\r\n            {children}\r\n          </Box>\r\n        ),\r\n\r\n        // Horizontal rule\r\n        hr: () => (\r\n          <Box\r\n            component=\"hr\"\r\n            sx={{\r\n              border: 'none',\r\n              borderTop: `1px solid ${alpha(theme.palette.divider, 0.2)}`,\r\n              my: 2\r\n            }}\r\n          />\r\n        ),\r\n\r\n        // Strong (bold)\r\n        strong: ({ children }) => (\r\n          <Box component=\"strong\" sx={{ fontWeight: 700 }}>\r\n            {children}\r\n          </Box>\r\n        ),\r\n\r\n        // Emphasis (italic)\r\n        em: ({ children }) => (\r\n          <Box component=\"em\" sx={{ fontStyle: 'italic' }}>\r\n            {children}\r\n          </Box>\r\n        )\r\n      }}\r\n    >\r\n      {content}\r\n    </ReactMarkdown>\r\n  );\r\n};\r\n\r\nexport default MarkdownRenderer;\r\n","/**\r\n * Chat Message Component\r\n * Displays user and AI messages with proper formatting\r\n */\r\n\r\nimport React, { useState } from 'react';\r\nimport {\r\n  Box,\r\n  Paper,\r\n  Typography,\r\n  Avatar,\r\n  IconButton,\r\n  Tooltip,\r\n  Chip,\r\n  Alert,\r\n  useTheme,\r\n  alpha\r\n} from '@mui/material';\r\nimport AnimatedText from './AnimatedText';\r\nimport HtmlMessageRenderer from './HtmlMessageRenderer';\r\nimport CitationsSection from './CitationsSection';\r\nimport MarkdownRenderer from './MarkdownRenderer';\r\nimport {\r\n  Person as PersonIcon,\r\n  SmartToy as AIIcon,\r\n  ContentCopy as CopyIcon,\r\n  CheckCircle as CheckIcon,\r\n  Error as ErrorIcon,\r\n  Schedule as ScheduleIcon,\r\n  Edit as EditIcon\r\n} from '@mui/icons-material';\r\nimport { ChatMessage as ChatMessageType } from '../../types/aiChat';\r\nimport { Trade } from '../../types/trade';\r\nimport { EconomicEvent } from '../../types/economicCalendar';\r\nimport { format } from 'date-fns';\r\nimport { logger } from '../../utils/logger';\r\n\r\ninterface ChatMessageProps {\r\n  message: ChatMessageType;\r\n  showTimestamp?: boolean;\r\n  isLatestMessage?: boolean;\r\n  enableAnimation?: boolean;\r\n  onTradeClick?: (tradeId: string, contextTrades: Trade[]) => void;\r\n  onEventClick?: (event: EconomicEvent) => void;\r\n  onNoteClick?: (noteId: string) => void;\r\n  onEdit?: (messageId: string) => void;\r\n  trades?: Trade[]; // All trades for calculating event trade counts\r\n}\r\n\r\nconst ChatMessage: React.FC<ChatMessageProps> = ({\r\n  message,\r\n  showTimestamp = true,\r\n  isLatestMessage = false,\r\n  enableAnimation = true,\r\n  onTradeClick,\r\n  onEventClick,\r\n  onNoteClick,\r\n  onEdit,\r\n  trades = []\r\n}) => {\r\n  const theme = useTheme();\r\n  const [copied, setCopied] = useState(false);\r\n  const isUser = message.role === 'user';\r\n  const isAssistant = message.role === 'assistant';\r\n\r\n  const handleCopy = async () => {\r\n    try {\r\n      await navigator.clipboard.writeText(message.content);\r\n      setCopied(true);\r\n      setTimeout(() => setCopied(false), 2000);\r\n      logger.log('Message copied to clipboard');\r\n    } catch (error) {\r\n      logger.error('Failed to copy message:', error);\r\n    }\r\n  };\r\n\r\n  const getStatusIcon = () => {\r\n    switch (message.status) {\r\n      case 'sending':\r\n        return <ScheduleIcon sx={{ fontSize: 14, color: 'text.secondary' }} />;\r\n      case 'sent':\r\n      case 'received':\r\n        return <CheckIcon sx={{ fontSize: 14, color: 'success.main' }} />;\r\n      case 'error':\r\n        return <ErrorIcon sx={{ fontSize: 14, color: 'error.main' }} />;\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  const getMessageBackground = () => {\r\n    if (isUser) {\r\n      return theme.palette.primary.main;\r\n    }\r\n    \r\n    if (message.status === 'error') {\r\n      return alpha(theme.palette.error.main, 0.1);\r\n    }\r\n    \r\n    return theme.palette.mode === 'dark' \r\n      ? alpha(theme.palette.background.paper, 0.8)\r\n      : alpha(theme.palette.grey[100], 0.8);\r\n  };\r\n\r\n  const getTextColor = () => {\r\n    if (isUser) {\r\n      return theme.palette.primary.contrastText;\r\n    }\r\n    \r\n    return theme.palette.text.primary;\r\n  };\r\n\r\n  // Format message content with basic markdown-like formatting\r\n  const formatContent = (content: string) => {\r\n    // Split content by code blocks\r\n    const parts = content.split(/(```[\\s\\S]*?```|`[^`]+`)/);\r\n\r\n    return parts.map((part, index) => {\r\n      // Code blocks\r\n      if (part.startsWith('```') && part.endsWith('```')) {\r\n        const code = part.slice(3, -3).trim();\r\n        const lines = code.split('\\n');\r\n        const language = lines[0]?.match(/^[a-zA-Z]+$/) ? lines.shift() : '';\r\n        const codeContent = lines.join('\\n');\r\n\r\n        return (\r\n          <Paper\r\n            key={index}\r\n            variant=\"outlined\"\r\n            sx={{\r\n              p: 2,\r\n              my: 1,\r\n              backgroundColor: theme.palette.mode === 'dark' ? 'grey.900' : 'grey.50',\r\n              fontFamily: 'monospace',\r\n              fontSize: '0.875rem',\r\n              overflow: 'auto'\r\n            }}\r\n          >\r\n            {language && (\r\n              <Chip\r\n                label={language}\r\n                size=\"small\"\r\n                sx={{ mb: 1, fontSize: '0.75rem' }}\r\n              />\r\n            )}\r\n            <Typography\r\n              component=\"pre\"\r\n              sx={{\r\n                margin: 0,\r\n                whiteSpace: 'pre-wrap',\r\n                wordBreak: 'break-word',\r\n                fontFamily: 'inherit'\r\n              }}\r\n            >\r\n              {codeContent}\r\n            </Typography>\r\n          </Paper>\r\n        );\r\n      }\r\n\r\n      // Inline code\r\n      if (part.startsWith('`') && part.endsWith('`')) {\r\n        return (\r\n          <Box\r\n            key={index}\r\n            component=\"span\"\r\n            sx={{\r\n              backgroundColor: alpha(theme.palette.text.primary, 0.1),\r\n              padding: '2px 4px',\r\n              borderRadius: 1,\r\n              fontFamily: 'monospace',\r\n              fontSize: '0.875em'\r\n            }}\r\n          >\r\n            {part.slice(1, -1)}\r\n          </Box>\r\n        );\r\n      }\r\n\r\n      // Regular text with line breaks\r\n      return (\r\n        <Typography\r\n          key={index}\r\n          component=\"span\"\r\n          sx={{\r\n            whiteSpace: 'pre-wrap',\r\n            wordBreak: 'break-word'\r\n          }}\r\n        >\r\n          {part}\r\n        </Typography>\r\n      );\r\n    });\r\n  };\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        display: 'flex',\r\n        flexDirection: isUser ? 'row-reverse' : 'row',\r\n        gap: 1.5,\r\n        mb: 3,\r\n        alignItems: 'flex-start',\r\n        px: 1,\r\n        animation: isLatestMessage && isAssistant ? 'fadeInUp 0.3s ease-out' : 'none',\r\n        '@keyframes fadeInUp': {\r\n          '0%': {\r\n            opacity: 0,\r\n            transform: 'translateY(10px)'\r\n          },\r\n          '100%': {\r\n            opacity: 1,\r\n            transform: 'translateY(0)'\r\n          }\r\n        }\r\n      }}\r\n    >\r\n      {/* Avatar */}\r\n      <Avatar\r\n        sx={{\r\n          width: 36,\r\n          height: 36,\r\n          backgroundColor: isUser ? 'primary.main' : 'secondary.main',\r\n          flexShrink: 0,\r\n          boxShadow: 1\r\n        }}\r\n      >\r\n        {isUser ? <PersonIcon sx={{ fontSize: 20 }} /> : <AIIcon sx={{ fontSize: 20 }} />}\r\n      </Avatar>\r\n\r\n      {/* Message Content */}\r\n      <Box\r\n        sx={{\r\n          maxWidth: isUser ? '80%' : '95%',\r\n          minWidth: 0,\r\n          flex: 1\r\n        }}\r\n      >\r\n        {/* Message Bubble */}\r\n        <Paper\r\n          elevation={0}\r\n          sx={{\r\n            p: 2.5,\r\n            backgroundColor: getMessageBackground(),\r\n            color: getTextColor(),\r\n            borderRadius: 4,\r\n            borderTopLeftRadius: isUser ? 4 : 1,\r\n            borderTopRightRadius: isUser ? 1 : 4,\r\n            borderBottomLeftRadius: isUser ? 4 : 4,\r\n            borderBottomRightRadius: isUser ? 4 : 4,\r\n            position: 'relative',\r\n            maxWidth: '100%',\r\n            wordBreak: 'break-word',\r\n            overflowWrap: 'anywhere',\r\n            boxShadow: isUser\r\n              ? '0 2px 8px rgba(0,0,0,0.1)'\r\n              : '0 1px 4px rgba(0,0,0,0.05)',\r\n            border: isUser ? 'none' : '1px solid',\r\n            borderColor: isUser ? 'transparent' : alpha(theme.palette.divider, 0.3),\r\n            '&:hover .message-actions': {\r\n              opacity: 1\r\n            }\r\n          }}\r\n        >\r\n          {/* Attached Images (for user messages) */}\r\n          {isUser && Array.isArray(message.images) && message.images.length > 0 && (\r\n            <Box\r\n              sx={{\r\n                display: 'flex',\r\n                flexWrap: 'wrap',\r\n                gap: 1,\r\n                mb: message.content ? 1.5 : 0\r\n              }}\r\n            >\r\n              {message.images.map((image, index) => (\r\n                <Box\r\n                  key={image.id || index}\r\n                  component=\"img\"\r\n                  src={image.url}\r\n                  alt={image.name || `Attached image ${index + 1}`}\r\n                  sx={{\r\n                    maxWidth: '100%',\r\n                    maxHeight: 200,\r\n                    borderRadius: 2,\r\n                    objectFit: 'contain',\r\n                    backgroundColor: alpha(theme.palette.common.black, 0.1),\r\n                    cursor: 'pointer',\r\n                    '&:hover': {\r\n                      opacity: 0.9\r\n                    }\r\n                  }}\r\n                  onClick={() => window.open(image.url, '_blank')}\r\n                />\r\n              ))}\r\n            </Box>\r\n          )}\r\n\r\n          {/* Message Content */}\r\n          <Box\r\n            sx={{\r\n              mb: message.error ? 1 : 0,\r\n              // Add subtle fade-in animation for streaming content\r\n              animation: message.status === 'receiving' && isAssistant ? 'subtlePulse 0.5s ease-in-out' : 'none',\r\n              '@keyframes subtlePulse': {\r\n                '0%': {\r\n                  opacity: 0.85\r\n                },\r\n                '50%': {\r\n                  opacity: 1\r\n                },\r\n                '100%': {\r\n                  opacity: 0.95\r\n                }\r\n              },\r\n              // Smooth transition for content changes\r\n              transition: 'opacity 0.5s ease-in-out'\r\n            }}\r\n          >\r\n            {/* Use HTML renderer if messageHtml is available (from Supabase AI agent) */}\r\n            {message.messageHtml ? (\r\n              <HtmlMessageRenderer\r\n                html={message.messageHtml}\r\n                embeddedTrades={message.embeddedTrades}\r\n                embeddedEvents={message.embeddedEvents}\r\n                embeddedNotes={message.embeddedNotes}\r\n                onTradeClick={onTradeClick}\r\n                onEventClick={onEventClick}\r\n                onNoteClick={onNoteClick}\r\n                trades={trades}\r\n              />\r\n            ) : isAssistant && enableAnimation && isLatestMessage ? (\r\n              <AnimatedText\r\n                text={message.content}\r\n                speed={200} // Much faster: 200 characters per second\r\n                isAnimating={message.status === 'received'}\r\n              />\r\n            ) : (\r\n              // Regular text formatting with streaming-friendly styling\r\n              <Box\r\n                sx={{\r\n                  // Smooth fade for new content chunks\r\n                  '& > *': {\r\n                    animation: message.status === 'receiving' && isAssistant ? 'fadeIn 0.3s ease-in' : 'none',\r\n                    '@keyframes fadeIn': {\r\n                      '0%': { opacity: 0 },\r\n                      '100%': { opacity: 1 }\r\n                    }\r\n                  }\r\n                }}\r\n              >\r\n                <MarkdownRenderer content={message.content} />\r\n              </Box>\r\n            )}\r\n          </Box>\r\n\r\n          {/* Citations (from Supabase AI agent) */}\r\n          {isAssistant && message.citations && message.citations.length > 0 && (\r\n            <Box sx={{ mt: 2 }}>\r\n              <CitationsSection citations={message.citations} />\r\n            </Box>\r\n          )}\r\n\r\n          {/* Error Message */}\r\n          {message.error && (\r\n            <Alert severity=\"error\" sx={{ mt: 1, fontSize: '0.875rem' }}>\r\n              {message.error}\r\n            </Alert>\r\n          )}\r\n\r\n          {/* Message Actions */}\r\n          <Box\r\n            className=\"message-actions\"\r\n            sx={{\r\n              position: 'absolute',\r\n              top: 4,\r\n              right: 4,\r\n              opacity: 0,\r\n              transition: 'opacity 0.2s',\r\n              display: 'flex',\r\n              gap: 0.5\r\n            }}\r\n          >\r\n            {/* Edit button for user messages */}\r\n            {isUser && onEdit && (\r\n              <Tooltip title=\"Edit message\">\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={() => onEdit(message.id)}\r\n                  sx={{\r\n                    backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n                    '&:hover': {\r\n                      backgroundColor: alpha(theme.palette.background.paper, 0.9)\r\n                    }\r\n                  }}\r\n                >\r\n                  <EditIcon sx={{ fontSize: 16 }} />\r\n                </IconButton>\r\n              </Tooltip>\r\n            )}\r\n\r\n            {/* Copy button for assistant/system messages */}\r\n            {!isUser && (\r\n              <Tooltip title={copied ? 'Copied!' : 'Copy message'}>\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={handleCopy}\r\n                  sx={{\r\n                    backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n                    '&:hover': {\r\n                      backgroundColor: alpha(theme.palette.background.paper, 0.9)\r\n                    }\r\n                  }}\r\n                >\r\n                  {copied ? <CheckIcon sx={{ fontSize: 16 }} /> : <CopyIcon sx={{ fontSize: 16 }} />}\r\n                </IconButton>\r\n              </Tooltip>\r\n            )}\r\n          </Box>\r\n        </Paper>\r\n\r\n        {/* Message Metadata */}\r\n        <Box\r\n          sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 1,\r\n            mt: 0.5,\r\n            px: 1,\r\n            justifyContent: isUser ? 'flex-end' : 'flex-start'\r\n          }}\r\n        >\r\n          {/* Timestamp */}\r\n          {showTimestamp && (\r\n            <Typography variant=\"caption\" color=\"text.secondary\">\r\n              {format(message.timestamp, 'HH:mm')}\r\n            </Typography>\r\n          )}\r\n\r\n          {/* Status Icon */}\r\n          {getStatusIcon()}\r\n\r\n          {/* Provider Badge */}\r\n          {/* {isAssistant && message.provider && (\r\n            <Chip\r\n              label={message.provider.toUpperCase()}\r\n              size=\"small\"\r\n              variant=\"outlined\"\r\n              sx={{ \r\n                fontSize: '0.6rem', \r\n                height: 16,\r\n                '& .MuiChip-label': { px: 0.5 }\r\n              }}\r\n            />\r\n          )} */}\r\n\r\n        </Box>\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default ChatMessage;\r\n","import React, { useEffect, useMemo, useRef, useState, forwardRef, useImperativeHandle } from 'react';\r\nimport { Editor, EditorState, ContentState, CompositeDecorator, Modifier, SelectionState } from 'draft-js';\r\nimport { Box, Chip, Popper, Paper, List, ListItem, ListItemButton, Typography, useTheme, alpha } from '@mui/material';\r\nimport { Tag as TagIcon } from '@mui/icons-material';\r\nimport { getTagChipStyles, formatTagForDisplay, isGroupedTag, getTagGroup } from '../../utils/tagColors';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\n\r\nexport interface AIChatMentionInputProps {\r\n  value: string;\r\n  onChange: (value: string) => void;\r\n  onKeyDown?: (e: React.KeyboardEvent) => void;\r\n  placeholder?: string;\r\n  disabled?: boolean;\r\n  allTags: string[];\r\n  maxRows?: number;\r\n  sx?: any;\r\n}\r\n\r\nconst createTagMentionComponent = () => {\r\n  const TagMentionEntity = ({ contentState, entityKey }: any) => {\r\n    const theme = useTheme();\r\n    const { tag } = contentState.getEntity(entityKey).getData() as { tag: string };\r\n\r\n    // Simple: render a Chip instead of the underlying text. We intentionally\r\n    // do NOT render children here so the raw text is not shown.\r\n    return (\r\n      <Chip\r\n        size=\"small\"\r\n        label={formatTagForDisplay(tag, true)}\r\n        contentEditable={false}\r\n        onMouseDown={(e) => e.preventDefault()}\r\n        sx={{\r\n          ...getTagChipStyles(tag, theme),\r\n          height: 22,\r\n          fontSize: '0.75rem',\r\n          userSelect: 'none',\r\n          verticalAlign: 'middle',\r\n          display: 'inline-flex'\r\n        }}\r\n      />\r\n    );\r\n  };\r\n  (TagMentionEntity as any).displayName = 'TagMentionEntity';\r\n  return TagMentionEntity;\r\n};\r\n\r\nconst createNoteMentionComponent = () => {\r\n  const NoteMentionEntity = ({ contentState, entityKey }: any) => {\r\n    const theme = useTheme();\r\n    const { noteTitle } = contentState.getEntity(entityKey).getData() as { noteTitle: string };\r\n\r\n    return (\r\n      <Chip\r\n        size=\"small\"\r\n        label={noteTitle}\r\n        contentEditable={false}\r\n        onMouseDown={(e) => e.preventDefault()}\r\n        sx={{\r\n          height: 22,\r\n          fontSize: '0.75rem',\r\n          userSelect: 'none',\r\n          verticalAlign: 'middle',\r\n          display: 'inline-flex',\r\n          backgroundColor: alpha(theme.palette.info.main, 0.1),\r\n          color: theme.palette.info.main,\r\n          border: `1px solid ${alpha(theme.palette.info.main, 0.3)}`,\r\n          '&:hover': {\r\n            backgroundColor: alpha(theme.palette.info.main, 0.2)\r\n          }\r\n        }}\r\n      />\r\n    );\r\n  };\r\n  (NoteMentionEntity as any).displayName = 'NoteMentionEntity';\r\n  return NoteMentionEntity;\r\n};\r\n\r\nconst AtSymbolHidden = ({ children }: any) => (\r\n  <span style={{ opacity: 0 }}>{children}</span>\r\n);\r\n\r\nconst createMentionDecorator = () =>\r\n  new CompositeDecorator([\r\n    {\r\n      // Render tag mentions as chips\r\n      strategy: (block, callback, contentState) => {\r\n        block.findEntityRanges(\r\n          ch => {\r\n            const k = ch.getEntity();\r\n            return !!k && contentState.getEntity(k).getType() === 'TAG_MENTION';\r\n          },\r\n          (start, end) => callback(start, end)\r\n        );\r\n      },\r\n      component: createTagMentionComponent()\r\n    },\r\n    {\r\n      // Render note mentions as chips\r\n      strategy: (block, callback, contentState) => {\r\n        block.findEntityRanges(\r\n          ch => {\r\n            const k = ch.getEntity();\r\n            return !!k && contentState.getEntity(k).getType() === 'NOTE_MENTION';\r\n          },\r\n          (start, end) => callback(start, end)\r\n        );\r\n      },\r\n      component: createNoteMentionComponent()\r\n    },\r\n    {\r\n      // Hide stray '@' characters that are not followed by mention text\r\n      // (i.e. '@' at the end of a word or followed by whitespace). This\r\n      // keeps '@' visible while typing (e.g. '@0.79'), but hides bugs where\r\n      // an extra '@ ' is left between chips.\r\n      strategy: (block, callback) => {\r\n        const text = block.getText();\r\n        for (let i = 0; i < text.length; i += 1) {\r\n          if (text[i] === '@') {\r\n            const next = text[i + 1];\r\n            if (!next || /\\s/.test(next)) {\r\n              callback(i, i + 1);\r\n            }\r\n          }\r\n        }\r\n      },\r\n      component: AtSymbolHidden\r\n    }\r\n  ]);\r\n\r\nconst AIChatMentionInput = forwardRef<any, AIChatMentionInputProps>(({\r\n  value, onChange, onKeyDown, placeholder, disabled, allTags, maxRows = 4, sx\r\n}, ref) => {\r\n  const theme = useTheme();\r\n  const editorRef = useRef<Editor>(null as any);\r\n  const [editorState, setEditorState] = useState(() => EditorState.createWithContent(ContentState.createFromText(value || ''), createMentionDecorator()));\r\n  const editorStateRef = useRef(editorState);\r\n  const [mention, setMention] = useState<{ open: boolean; term: string; start: number; blockKey: string } | null>(null);\r\n  const [anchorEl, setAnchorEl] = useState<HTMLElement | null>(null);\r\n  const [selectedIndex, setSelectedIndex] = useState(0);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const moveCursorToEndOnNextUpdate = useRef(false);\r\n\r\n  useImperativeHandle(ref, () => ({\r\n    focus: () => editorRef.current && (editorRef.current as any).focus?.(),\r\n    moveCursorToEnd: () => {\r\n      // Set flag to move cursor to end on next value update\r\n      moveCursorToEndOnNextUpdate.current = true;\r\n\r\n      // Also try to move it immediately if possible\r\n      const currentContent = editorStateRef.current.getCurrentContent();\r\n      const lastBlock = currentContent.getLastBlock();\r\n      const lastBlockKey = lastBlock.getKey();\r\n      const length = lastBlock.getLength();\r\n\r\n      const selection = SelectionState.createEmpty(lastBlockKey).merge({\r\n        anchorOffset: length,\r\n        focusOffset: length\r\n      }) as SelectionState;\r\n\r\n      const newState = EditorState.forceSelection(editorStateRef.current, selection);\r\n      setEditorState(newState);\r\n\r\n      // Focus after setting selection\r\n      setTimeout(() => {\r\n        (editorRef.current as any)?.focus?.();\r\n      }, 0);\r\n    },\r\n    insertNote: (noteTitle: string) => {\r\n      const state = editorStateRef.current;\r\n      const selection = state.getSelection();\r\n      const content = state.getCurrentContent();\r\n      const blockKey = selection.getStartKey();\r\n\r\n      // Add a space before if needed\r\n      let newContent = content;\r\n      const offset = selection.getStartOffset();\r\n      const block = content.getBlockForKey(blockKey);\r\n      const text = block.getText();\r\n\r\n      if (offset > 0 && !/\\s/.test(text[offset - 1])) {\r\n        const spaceSelection = SelectionState.createEmpty(blockKey).merge({\r\n          anchorOffset: offset,\r\n          focusOffset: offset\r\n        }) as SelectionState;\r\n        newContent = Modifier.insertText(newContent, spaceSelection, ' ');\r\n      }\r\n\r\n      // Insert the note token text\r\n      const noteToken = `note:${noteTitle}`;\r\n      const insertOffset = offset + (offset > 0 && !/\\s/.test(text[offset - 1]) ? 1 : 0);\r\n      const insertSelection = SelectionState.createEmpty(blockKey).merge({\r\n        anchorOffset: insertOffset,\r\n        focusOffset: insertOffset\r\n      }) as SelectionState;\r\n      newContent = Modifier.insertText(newContent, insertSelection, noteToken);\r\n\r\n      // Create entity and apply it\r\n      newContent = newContent.createEntity('NOTE_MENTION', 'IMMUTABLE', { noteTitle });\r\n      const entityKey = newContent.getLastCreatedEntityKey();\r\n\r\n      const entityRange = SelectionState.createEmpty(blockKey).merge({\r\n        anchorOffset: insertOffset,\r\n        focusOffset: insertOffset + noteToken.length\r\n      }) as SelectionState;\r\n      newContent = Modifier.applyEntity(newContent, entityRange, entityKey);\r\n\r\n      // Add trailing space\r\n      const afterNote = SelectionState.createEmpty(blockKey).merge({\r\n        anchorOffset: insertOffset + noteToken.length,\r\n        focusOffset: insertOffset + noteToken.length\r\n      }) as SelectionState;\r\n      newContent = Modifier.insertText(newContent, afterNote, ' ');\r\n\r\n      // Update state and move cursor\r\n      let newState = EditorState.push(state, newContent, 'insert-characters');\r\n      const cursorPosition = SelectionState.createEmpty(blockKey).merge({\r\n        anchorOffset: insertOffset + noteToken.length + 1,\r\n        focusOffset: insertOffset + noteToken.length + 1\r\n      }) as SelectionState;\r\n      newState = EditorState.forceSelection(newState, cursorPosition);\r\n\r\n      setEditorState(newState);\r\n      onChange(newState.getCurrentContent().getPlainText());\r\n\r\n      // Focus editor\r\n      setTimeout(() => {\r\n        (editorRef.current as any)?.focus?.();\r\n      }, 0);\r\n    }\r\n  }));\r\n\r\n  useEffect(() => {\r\n    // keep external value in sync if it changes from outside\r\n    const currentText = editorState.getCurrentContent().getPlainText();\r\n    console.log('useEffect - value prop:', value, 'current text:', currentText);\r\n    if (value !== currentText) {\r\n      console.log('useEffect - recreating editor state from value:', value);\r\n      const newContent = ContentState.createFromText(value || '');\r\n      let newState = EditorState.createWithContent(newContent, createMentionDecorator());\r\n\r\n      // If we should move cursor to end, do it now\r\n      if (moveCursorToEndOnNextUpdate.current) {\r\n        const lastBlock = newContent.getLastBlock();\r\n        const lastBlockKey = lastBlock.getKey();\r\n        const length = lastBlock.getLength();\r\n\r\n        const selection = SelectionState.createEmpty(lastBlockKey).merge({\r\n          anchorOffset: length,\r\n          focusOffset: length\r\n        }) as SelectionState;\r\n\r\n        newState = EditorState.forceSelection(newState, selection);\r\n        moveCursorToEndOnNextUpdate.current = false;\r\n\r\n        // Focus the editor\r\n        setTimeout(() => {\r\n          (editorRef.current as any)?.focus?.();\r\n        }, 0);\r\n      }\r\n\r\n      setEditorState(newState);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [value]);\r\n\r\n  useEffect(() => {\r\n    editorStateRef.current = editorState;\r\n  }, [editorState]);\r\n\r\n  const tags = useMemo(() => allTags.sort(), [allTags]);\r\n  const filtered = useMemo(() => (mention?.term ? tags.filter(t => t.toLowerCase().includes(mention.term.toLowerCase())) : tags).slice(0, 50), [tags, mention]);\r\n\r\n  function updateMentionState(state: EditorState) {\r\n    const sel = state.getSelection();\r\n    if (!sel.isCollapsed()) return setMention(null);\r\n    const content = state.getCurrentContent();\r\n    const blockKey = sel.getStartKey();\r\n    const block = content.getBlockForKey(blockKey);\r\n    const offset = sel.getStartOffset();\r\n    const text = block.getText().slice(0, offset);\r\n    const at = text.lastIndexOf('@');\r\n    if (at === -1) return setMention(null);\r\n    if (at > 0 && /[^\\s]/.test(text[at - 1])) return setMention(null);\r\n    const term = text.slice(at + 1);\r\n    if (/[^A-Za-z0-9:_.-]/.test(term)) return setMention(null);\r\n    setMention({ open: true, term, start: at, blockKey });\r\n    setAnchorEl(containerRef.current);\r\n    setSelectedIndex(0);\r\n  }\r\n\r\n  function handleChange(state: EditorState) {\r\n    const plainText = state.getCurrentContent().getPlainText();\r\n    console.log('handleChange - plain text:', plainText);\r\n    setEditorState(state);\r\n    onChange(plainText);\r\n    updateMentionState(state);\r\n  }\r\n\r\n  function handleKeyDownLocal(e: React.KeyboardEvent) {\r\n    if (mention?.open) {\r\n      if (e.key === 'ArrowDown') { e.preventDefault(); setSelectedIndex((i) => Math.min(i + 1, filtered.length - 1)); return; }\r\n      if (e.key === 'ArrowUp') { e.preventDefault(); setSelectedIndex((i) => Math.max(i - 1, 0)); return; }\r\n      if (e.key === 'Enter') { e.preventDefault(); if (filtered[selectedIndex]) insertTag(filtered[selectedIndex]); return; }\r\n      if (e.key === 'Escape') { e.preventDefault(); setMention(null); return; }\r\n    }\r\n\r\n    // Prevent @ from being inserted - we'll handle it in handleChange via updateMentionState\r\n    if (e.key === '@' && !e.ctrlKey && !e.metaKey && !e.altKey) {\r\n      // Don't prevent default - let Draft.js insert the @ so updateMentionState can detect it\r\n      // The @ will be replaced when a tag is selected\r\n    }\r\n\r\n    const sel = editorState.getSelection();\r\n    if (sel.isCollapsed()) {\r\n      const content = editorState.getCurrentContent();\r\n      const block = content.getBlockForKey(sel.getStartKey());\r\n      const offset = sel.getStartOffset();\r\n      if (e.key === 'Backspace' && offset > 0) {\r\n        const text = block.getText();\r\n        if (text[offset - 1] === ' ' && offset > 1) {\r\n          const ekBeforeSpace = block.getEntityAt(offset - 2);\r\n          if (ekBeforeSpace) {\r\n            const entityType = content.getEntity(ekBeforeSpace).getType();\r\n            if (entityType === 'TAG_MENTION' || entityType === 'NOTE_MENTION') {\r\n              e.preventDefault();\r\n              handleRemoveEntity(ekBeforeSpace, true);\r\n              return;\r\n            }\r\n          }\r\n        }\r\n\r\n        const ek = block.getEntityAt(offset - 1);\r\n        if (ek) {\r\n          const entityType = content.getEntity(ek).getType();\r\n          if (entityType === 'TAG_MENTION' || entityType === 'NOTE_MENTION') {\r\n            e.preventDefault();\r\n            handleRemoveEntity(ek);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    onKeyDown?.(e);\r\n  }\r\n\r\n  function insertTag(tag: string) {\r\n    // Always operate on the latest editor state\r\n    const state = editorStateRef.current || editorState;\r\n    const selection = state.getSelection();\r\n\r\n    // We only handle collapsed selection (caret position)\r\n    if (!selection.isCollapsed()) {\r\n      setMention(null);\r\n      return;\r\n    }\r\n\r\n    const content = state.getCurrentContent();\r\n    const blockKey = selection.getStartKey();\r\n    const block = content.getBlockForKey(blockKey);\r\n    const text = block.getText();\r\n    const offset = selection.getStartOffset();\r\n\r\n    // Find the '@' that starts this mention by scanning backwards from the cursor\r\n    let atIndex = -1;\r\n    for (let i = offset - 1; i >= 0; i -= 1) {\r\n      const ch = text[i];\r\n      if (ch === '@') {\r\n        // Require start-of-line or whitespace before '@' so we don't match emails, etc.\r\n        if (i === 0 || /\\s/.test(text[i - 1])) {\r\n          atIndex = i;\r\n        }\r\n        break;\r\n      }\r\n      if (/\\s/.test(ch)) {\r\n        // Hit whitespace before finding an '@'  no valid mention here\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (atIndex === -1) {\r\n      setMention(null);\r\n      return;\r\n    }\r\n\r\n    const mentionText = tag; // raw tag, without '@'\r\n\r\n    // Selection from '@' up to current caret position\r\n    const replaceSel = SelectionState.createEmpty(blockKey).merge({\r\n      anchorOffset: atIndex,\r\n      focusOffset: offset\r\n    }) as SelectionState;\r\n\r\n    // Step 1: replace the @mention text with the tag text\r\n    let newContent = Modifier.replaceText(content, replaceSel, mentionText);\r\n\r\n    // Step 2: create an entity for this tag and apply it over the inserted text\r\n    newContent = newContent.createEntity('TAG_MENTION', 'IMMUTABLE', { tag });\r\n    const entityKey = newContent.getLastCreatedEntityKey();\r\n\r\n    const entityRange = SelectionState.createEmpty(blockKey).merge({\r\n      anchorOffset: atIndex,\r\n      focusOffset: atIndex + mentionText.length\r\n    }) as SelectionState;\r\n    newContent = Modifier.applyEntity(newContent, entityRange, entityKey);\r\n\r\n    // Step 3: insert a trailing space after the chip\r\n    const afterMention = SelectionState.createEmpty(blockKey).merge({\r\n      anchorOffset: atIndex + mentionText.length,\r\n      focusOffset: atIndex + mentionText.length\r\n    }) as SelectionState;\r\n    newContent = Modifier.insertText(newContent, afterMention, ' ');\r\n\r\n    // Push updated content into editor state and move cursor after the space\r\n    let newState = EditorState.push(state, newContent, 'insert-characters');\r\n    const cursorPosition = SelectionState.createEmpty(blockKey).merge({\r\n      anchorOffset: atIndex + mentionText.length + 1,\r\n      focusOffset: atIndex + mentionText.length + 1\r\n    }) as SelectionState;\r\n    newState = EditorState.forceSelection(newState, cursorPosition);\r\n\r\n    console.log('Final text:', newState.getCurrentContent().getBlockForKey(blockKey).getText());\r\n    console.log('=== END INSERT TAG DEBUG ===');\r\n\r\n    setMention(null);\r\n    handleChange(newState);\r\n\r\n    // Refocus editor\r\n    setTimeout(() => {\r\n      try {\r\n        (editorRef.current as any)?.focus?.();\r\n      } catch (_) {}\r\n    }, 0);\r\n  }\r\n\r\n  function handleRemoveEntity(entityKey: string, includeFollowingSpace = false) {\r\n    const state = editorStateRef.current || editorState;\r\n    const content = state.getCurrentContent();\r\n    const blocks = content.getBlocksAsArray();\r\n    for (const b of blocks) {\r\n      let s = -1, e = -1;\r\n      b.findEntityRanges(ch => ch.getEntity() === entityKey, (start, end) => { s = start; e = end; });\r\n      if (s >= 0) {\r\n        let focusOffset = e;\r\n        if (includeFollowingSpace) {\r\n          const txt = b.getText();\r\n          if (txt[e] === ' ') focusOffset = e + 1;\r\n        }\r\n        const sel = SelectionState.createEmpty(b.getKey()).merge({ anchorOffset: s, focusOffset }) as SelectionState;\r\n        const c2 = Modifier.removeRange(content, sel, 'backward');\r\n        const st = EditorState.push(state, c2, 'remove-range');\r\n        handleChange(st);\r\n        return;\r\n      }\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Box ref={containerRef} sx={{ position: 'relative', width: '100%' }}>\r\n      <Box\r\n        onClick={() => editorRef.current && (editorRef.current as any).focus?.()}\r\n        onKeyDown={handleKeyDownLocal}\r\n        sx={{\r\n          display: 'flex', flexWrap: 'wrap', alignItems: 'center', gap: 0.5,\r\n          px: 1, py: 0.5, border: 'none', backgroundColor: 'transparent', cursor: 'text',\r\n          width: '100%', maxWidth: '100%', minWidth: 0,\r\n          '& .DraftEditor-root': { width: '100%' },\r\n          '& .public-DraftEditor-content': {\r\n            whiteSpace: 'pre-wrap',\r\n            wordBreak: 'break-word',\r\n            overflowWrap: 'anywhere',\r\n            maxHeight: `${maxRows * 1.6}em`,\r\n            overflowY: 'auto',\r\n            ...scrollbarStyles(theme)\r\n          },\r\n          '& .public-DraftEditorPlaceholder-root': { whiteSpace: 'pre-wrap' },\r\n          ...sx\r\n        }}\r\n      >\r\n        <Editor\r\n          ref={editorRef as any}\r\n          editorState={editorState}\r\n          onChange={handleChange}\r\n          readOnly={!!disabled}\r\n          placeholder={placeholder}\r\n        />\r\n      </Box>\r\n\r\n      <Popper\r\n        open={!!mention?.open}\r\n        anchorEl={anchorEl}\r\n        placement=\"top-start\"\r\n        disablePortal\r\n        sx={{ zIndex: Z_INDEX.DIALOG }}\r\n      >\r\n        <Paper\r\n          elevation={8}\r\n          sx={{\r\n            maxHeight: 220,\r\n            minWidth: 250,\r\n            maxWidth: 400,\r\n            overflow: 'hidden',\r\n            border: '1px solid',\r\n            borderColor: 'divider'\r\n          }}\r\n        >\r\n          <Box\r\n            sx={{\r\n              p: 1.5,\r\n              borderBottom: '1px solid',\r\n              borderColor: 'divider',\r\n              backgroundColor: alpha(theme.palette.primary.main, 0.04)\r\n            }}\r\n          >\r\n            <Typography\r\n              variant=\"caption\"\r\n              color=\"text.secondary\"\r\n              sx={{ display: 'flex', alignItems: 'center', gap: 0.5, fontWeight: 500 }}\r\n            >\r\n              <TagIcon sx={{ fontSize: 14 }} /> Select a tag to mention ({filtered.length} available)\r\n            </Typography>\r\n          </Box>\r\n          <List sx={{ maxHeight: 170, overflow: 'auto', p: 0, ...scrollbarStyles(theme) }}>\r\n            {filtered.length === 0 ? (\r\n              <ListItem>\r\n                <Box sx={{ p: 2, textAlign: 'center', width: '100%' }}>\r\n                  <Typography variant=\"body2\" color=\"text.secondary\">\r\n                    {allTags.length === 0\r\n                      ? 'No tags available. Add tags to your calendar to mention them here.'\r\n                      : `No tags found matching \"${mention?.term || ''}\"`}\r\n                  </Typography>\r\n                </Box>\r\n              </ListItem>\r\n            ) : (\r\n              filtered.map((tag, idx) => (\r\n                <ListItem key={tag} disablePadding>\r\n                  <ListItemButton\r\n                    selected={idx === selectedIndex}\r\n                    onMouseDown={(e) => {\r\n                      e.preventDefault(); // Prevent editor from losing focus\r\n                      insertTag(tag);\r\n                    }}\r\n                    onClick={(e) => {\r\n                      // Fallback for environments where onMouseDown does not fire (e.g. some touch devices)\r\n                      e.preventDefault();\r\n                      insertTag(tag);\r\n                    }}\r\n                    sx={{ py: 1, px: 2 }}\r\n                  >\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>\r\n                      <Chip\r\n                        label={formatTagForDisplay(tag, true)}\r\n                        size=\"small\"\r\n                        sx={{ ...getTagChipStyles(tag, theme), height: 20, fontSize: '0.7rem' }}\r\n                      />\r\n                      {isGroupedTag(tag) && (\r\n                        <Typography variant=\"caption\" color=\"text.secondary\">\r\n                          {getTagGroup(tag)}\r\n                        </Typography>\r\n                      )}\r\n                    </Box>\r\n                  </ListItemButton>\r\n                </ListItem>\r\n              ))\r\n            )}\r\n          </List>\r\n        </Paper>\r\n      </Popper>\r\n    </Box>\r\n  );\r\n});\r\n\r\nAIChatMentionInput.displayName = 'AIChatMentionInput';\r\nexport default AIChatMentionInput;\r\n\r\n","/**\r\n * AIChatInterface Component\r\n * Reusable AI chat interface that can be embedded in different containers\r\n * Contains: Messages, Templates, Typing Indicator, Input Area, Notes Popup\r\n */\r\n\r\nimport React, { useRef, useEffect, useCallback, useState, forwardRef, useImperativeHandle } from 'react';\r\nimport {\r\n  Box,\r\n  IconButton,\r\n  Button,\r\n  Typography,\r\n  Alert,\r\n  CircularProgress,\r\n  Divider,\r\n  useTheme,\r\n  alpha,\r\n  List,\r\n  ListItemButton,\r\n  Popper,\r\n  Paper,\r\n  ClickAwayListener\r\n} from '@mui/material';\r\nimport {\r\n  Send as SendIcon,\r\n  AddComment as NewChatIcon,\r\n  Stop as StopIcon,\r\n  Notes as NotesIcon,\r\n  Image as ImageIcon,\r\n  Close as CloseIcon\r\n} from '@mui/icons-material';\r\nimport ChatMessage from './ChatMessage';\r\nimport AIChatMentionInput from './AIChatMentionInput';\r\nimport { ChatMessage as ChatMessageType, AttachedImage } from '../../types/aiChat';\r\nimport { Trade } from '../../types/trade';\r\nimport { Calendar } from '../../types/calendar';\r\nimport { EconomicEvent } from '../../types/economicCalendar';\r\nimport { Note } from '../../types/note';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\nimport { logger } from '../../utils/logger';\r\nimport * as notesService from '../../services/notesService';\r\n\r\n// Image limit for AI agent requests (must match backend MAX_IMAGES_PER_REQUEST)\r\nconst MAX_IMAGES = 4;\r\n\r\n// Type for question templates\r\nexport interface QuestionTemplate {\r\n  category: string;\r\n  questions: string[];\r\n}\r\n\r\n// Default question templates for new users\r\nconst defaultQuestionTemplates = [\r\n  {\r\n    category: \"Performance Analysis\",\r\n    questions: [\r\n      \"What's my overall win rate by trading session?\",\r\n      \"Show me my monthly performance trends\",\r\n      \"Which tags have the highest win rates?\"\r\n    ]\r\n  },\r\n  {\r\n    category: \"Pattern Discovery\",\r\n    questions: [\r\n      \"Find my most profitable trading patterns\",\r\n      \"Show me trades similar to my best EUR/USD wins\",\r\n      \"Analyze my performance during high-impact news events\"\r\n    ]\r\n  },\r\n  {\r\n    category: \"Risk Management\",\r\n    questions: [\r\n      \"What's my average trade size by day of week?\",\r\n      \"Show me trades where I violated my risk management rules\",\r\n      \"Analyze correlation between trade session and profitability\"\r\n    ]\r\n  },\r\n  {\r\n    category: \"Advanced Analysis\",\r\n    questions: [\r\n      \"How does my trading performance vary across different sessions during high-impact economic events?\",\r\n      \"Compare my win rate on Mondays vs Fridays for scalping trades\",\r\n      \"Show me all my losing breakout trades on Tuesdays in the last 6 months\"\r\n    ]\r\n  }\r\n];\r\n\r\nexport interface AIChatInterfaceProps {\r\n  // Core state from useAIChat hook\r\n  messages: ChatMessageType[];\r\n  isLoading: boolean;\r\n  isTyping: boolean;\r\n  toolExecutionStatus: string;\r\n  isAtMessageLimit: boolean;\r\n\r\n  // Actions from useAIChat hook\r\n  sendMessage: (messageText: string, images?: AttachedImage[]) => Promise<void>;\r\n  cancelRequest: () => void;\r\n  setInputForEdit: (messageId: string) => { content: string; images?: AttachedImage[] } | null;\r\n  startNewChat: () => Promise<void>;\r\n  setMessages: React.Dispatch<React.SetStateAction<ChatMessageType[]>>;\r\n  getWelcomeMessage: () => ChatMessageType;\r\n\r\n  // Context\r\n  userId?: string;\r\n  calendar?: Calendar;\r\n  trades?: Trade[];\r\n\r\n  // Callbacks for interactions\r\n  onTradeClick?: (tradeId: string, contextTrades: Trade[]) => void;\r\n  onEventClick?: (event: EconomicEvent) => void;\r\n  onNoteClick?: (noteId: string, note?: Note) => void;\r\n\r\n  // Configuration\r\n  isReadOnly?: boolean;\r\n  showTemplates?: boolean;\r\n  autoScroll?: boolean;\r\n  messageLimit?: number;\r\n  questionTemplates?: QuestionTemplate[];\r\n}\r\n\r\nexport interface AIChatInterfaceRef {\r\n  focus: () => void;\r\n  scrollToBottom: () => void;\r\n}\r\n\r\nconst AIChatInterface = forwardRef<AIChatInterfaceRef, AIChatInterfaceProps>(({\r\n  messages,\r\n  isLoading,\r\n  isTyping,\r\n  toolExecutionStatus,\r\n  isAtMessageLimit,\r\n  sendMessage,\r\n  cancelRequest,\r\n  setInputForEdit,\r\n  startNewChat,\r\n  setMessages,\r\n  getWelcomeMessage,\r\n  userId,\r\n  calendar,\r\n  trades,\r\n  onTradeClick,\r\n  onEventClick,\r\n  onNoteClick,\r\n  isReadOnly = false,\r\n  showTemplates: showTemplatesProp,\r\n  autoScroll = true,\r\n  messageLimit = 50,\r\n  questionTemplates = defaultQuestionTemplates\r\n}, ref) => {\r\n  const theme = useTheme();\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const inputRef = useRef<any>(null);\r\n\r\n  // Local UI state\r\n  const [inputMessage, setInputMessage] = useState('');\r\n  const [attachedImages, setAttachedImages] = useState<AttachedImage[]>([]);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Notes context popup state\r\n  const [notesAnchorEl, setNotesAnchorEl] = useState<HTMLElement | null>(null);\r\n  const [availableNotes, setAvailableNotes] = useState<Note[]>([]);\r\n  const [notesLoading, setNotesLoading] = useState(false);\r\n\r\n  // Expose methods via ref\r\n  useImperativeHandle(ref, () => ({\r\n    focus: () => {\r\n      inputRef.current?.focus();\r\n    },\r\n    scrollToBottom: () => {\r\n      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n  }));\r\n\r\n  // Auto-scroll to bottom whenever messages change\r\n  const scrollToBottom = useCallback(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (autoScroll) {\r\n      scrollToBottom();\r\n    }\r\n  }, [messages, scrollToBottom, autoScroll]);\r\n\r\n  // Event Handlers\r\n  const handleSendMessage = async () => {\r\n    const messageText = inputMessage.trim();\r\n    if ((!messageText && attachedImages.length === 0) || isLoading) return;\r\n\r\n    const imagesToSend = attachedImages.length > 0 ? [...attachedImages] : undefined;\r\n    setInputMessage('');\r\n    setAttachedImages([]);\r\n    await sendMessage(messageText, imagesToSend);\r\n  };\r\n\r\n  // Image upload handlers\r\n  const handleImageUploadClick = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  const handleImageSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = event.target.files;\r\n    if (!files || files.length === 0) return;\r\n\r\n    const newImages: AttachedImage[] = [];\r\n\r\n    for (let i = 0; i < files.length; i++) {\r\n      const file = files[i];\r\n\r\n      // Validate file type\r\n      if (!file.type.startsWith('image/')) {\r\n        logger.warn('Skipping non-image file:', file.name);\r\n        continue;\r\n      }\r\n\r\n      // Limit file size to 10MB\r\n      if (file.size > 10 * 1024 * 1024) {\r\n        logger.warn('Skipping large file:', file.name, file.size);\r\n        continue;\r\n      }\r\n\r\n      try {\r\n        // Convert to base64 data URL\r\n        const dataUrl = await new Promise<string>((resolve, reject) => {\r\n          const reader = new FileReader();\r\n          reader.onload = () => resolve(reader.result as string);\r\n          reader.onerror = reject;\r\n          reader.readAsDataURL(file);\r\n        });\r\n\r\n        newImages.push({\r\n          id: crypto.randomUUID(),\r\n          url: dataUrl,\r\n          mimeType: file.type,\r\n          name: file.name,\r\n          size: file.size\r\n        });\r\n      } catch (error) {\r\n        logger.error('Error reading file:', error);\r\n      }\r\n    }\r\n\r\n    if (newImages.length > 0) {\r\n      setAttachedImages(prev => [...prev, ...newImages].slice(0, MAX_IMAGES));\r\n    }\r\n\r\n    // Reset file input\r\n    if (fileInputRef.current) {\r\n      fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  const handleRemoveImage = (imageId: string) => {\r\n    setAttachedImages(prev => prev.filter(img => img.id !== imageId));\r\n  };\r\n\r\n  // Handle paste event for images (Ctrl+V)\r\n  const handlePaste = useCallback(async (event: React.ClipboardEvent) => {\r\n    const items = event.clipboardData?.items;\r\n    if (!items) return;\r\n\r\n    const newImages: AttachedImage[] = [];\r\n\r\n    for (let i = 0; i < items.length; i++) {\r\n      const item = items[i];\r\n\r\n      // Check if it's an image\r\n      if (item.type.startsWith('image/')) {\r\n        event.preventDefault(); // Prevent default paste behavior for images\r\n\r\n        const file = item.getAsFile();\r\n        if (!file) continue;\r\n\r\n        // Limit file size to 10MB\r\n        if (file.size > 10 * 1024 * 1024) {\r\n          logger.warn('Skipping large pasted image:', file.size);\r\n          continue;\r\n        }\r\n\r\n        try {\r\n          // Convert to base64 data URL\r\n          const dataUrl = await new Promise<string>((resolve, reject) => {\r\n            const reader = new FileReader();\r\n            reader.onload = () => resolve(reader.result as string);\r\n            reader.onerror = reject;\r\n            reader.readAsDataURL(file);\r\n          });\r\n\r\n          newImages.push({\r\n            id: crypto.randomUUID(),\r\n            url: dataUrl,\r\n            mimeType: file.type,\r\n            name: `pasted-image-${Date.now()}.${file.type.split('/')[1] || 'png'}`,\r\n            size: file.size\r\n          });\r\n        } catch (error) {\r\n          logger.error('Error reading pasted image:', error);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (newImages.length > 0) {\r\n      setAttachedImages(prev => [...prev, ...newImages].slice(0, MAX_IMAGES));\r\n    }\r\n  }, []);\r\n\r\n  const handleCancelRequest = () => {\r\n    cancelRequest();\r\n  };\r\n\r\n  const handleEditMessage = (messageId: string) => {\r\n    const editData = setInputForEdit(messageId);\r\n    if (editData) {\r\n      setInputMessage(editData.content);\r\n      // Restore images when editing\r\n      if (editData.images && editData.images.length > 0) {\r\n        setAttachedImages(editData.images);\r\n      } else {\r\n        setAttachedImages([]);\r\n      }\r\n      setTimeout(() => inputRef.current?.focus(), 100);\r\n    }\r\n  };\r\n\r\n  const handleKeyPress = (event: React.KeyboardEvent) => {\r\n    if (event.key === 'Enter' && !event.shiftKey) {\r\n      event.preventDefault();\r\n      handleSendMessage();\r\n    }\r\n  };\r\n\r\n  const handleTemplateClick = (question: string) => {\r\n    setInputMessage(question);\r\n    setTimeout(() => inputRef.current?.focus(), 100);\r\n  };\r\n\r\n  const handleNewChat = async () => {\r\n    await startNewChat();\r\n  };\r\n\r\n  // Notes context popup handlers\r\n  const handleOpenNotesContext = async (event: React.MouseEvent<HTMLElement>) => {\r\n    if (!userId || isReadOnly) return;\r\n\r\n    if (notesAnchorEl) {\r\n      handleCloseNotesContext();\r\n      return;\r\n    }\r\n\r\n    setNotesAnchorEl(event.currentTarget);\r\n\r\n    if (availableNotes.length > 0 || notesLoading) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setNotesLoading(true);\r\n\r\n      const notes = calendar?.id\r\n        ? await notesService.getCalendarNotes(calendar.id)\r\n        : await notesService.getUserNotes(userId);\r\n\r\n      const sortedNotes = [...notes].sort((a, b) =>\r\n        new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime()\r\n      );\r\n\r\n      setAvailableNotes(sortedNotes.filter(note => !note.is_archived && !note.by_assistant));\r\n    } catch (error) {\r\n      logger.error('Error loading notes for AI context:', error);\r\n    } finally {\r\n      setNotesLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCloseNotesContext = () => {\r\n    setNotesAnchorEl(null);\r\n  };\r\n\r\n  const handleInsertNoteContext = (note: Note) => {\r\n    const title = note.title || 'Untitled';\r\n\r\n    // Use the insertNote method to create a note entity chip\r\n    if (inputRef.current?.insertNote) {\r\n      inputRef.current.insertNote(title);\r\n    }\r\n\r\n    handleCloseNotesContext();\r\n  };\r\n\r\n  // Determine what to display\r\n  const displayMessages = messages.length === 0 ? [getWelcomeMessage()] : messages;\r\n  const shouldShowTemplates = showTemplatesProp !== undefined ? showTemplatesProp : messages.length === 0;\r\n\r\n  return (\r\n    <Box sx={{\r\n      height: '100%',\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      overflow: 'hidden'\r\n    }}>\r\n      {/* Messages Area */}\r\n      <Box\r\n        sx={{\r\n          flex: 1,\r\n          overflow: 'auto',\r\n          p: 2,\r\n          pb: 1,\r\n          backgroundColor: alpha(theme.palette.background.default, 0.3),\r\n          backgroundImage: `radial-gradient(circle at 20% 80%, ${alpha(theme.palette.primary.main, 0.03)} 0%, transparent 50%),\r\n                           radial-gradient(circle at 80% 20%, ${alpha(theme.palette.secondary.main, 0.03)} 0%, transparent 50%)`,\r\n          ...scrollbarStyles(theme)\r\n        }}\r\n      >\r\n        {displayMessages.map((message, index) => (\r\n          <ChatMessage\r\n            key={message.id}\r\n            message={message}\r\n            showTimestamp={true}\r\n            isLatestMessage={index === displayMessages.length - 1}\r\n            enableAnimation={index > 0}\r\n            onTradeClick={(tradeId, contextTrades) => {\r\n              if (onTradeClick) {\r\n                onTradeClick(tradeId, contextTrades);\r\n              } else {\r\n                logger.log('Trade clicked but handler not provided:', tradeId);\r\n              }\r\n            }}\r\n            onEventClick={(event) => {\r\n              logger.log('Economic event clicked:', event);\r\n              onEventClick?.(event);\r\n            }}\r\n            onNoteClick={async (noteId) => {\r\n              logger.log('Note clicked:', noteId);\r\n              // Find the note from embedded notes in messages\r\n              const note = messages\r\n                .flatMap(m => m.embeddedNotes ? Object.values(m.embeddedNotes) : [])\r\n                .find(n => n.id === noteId);\r\n\r\n              onNoteClick?.(noteId, note || undefined);\r\n            }}\r\n            onEdit={handleEditMessage}\r\n            trades={trades}\r\n          />\r\n        ))}\r\n\r\n        {/* Question Templates - Only show when no conversation started */}\r\n        {shouldShowTemplates && (\r\n          <Box sx={{ mt: 3 }}>\r\n            <Typography\r\n              variant=\"h6\"\r\n              sx={{\r\n                mb: 2,\r\n                color: 'text.primary',\r\n                fontWeight: 600\r\n              }}\r\n            >\r\n              Try these questions:\r\n            </Typography>\r\n\r\n            {questionTemplates.map((category: QuestionTemplate, categoryIndex: number) => (\r\n              <Box key={categoryIndex} sx={{ mb: 3 }}>\r\n                <Typography\r\n                  variant=\"subtitle2\"\r\n                  sx={{\r\n                    mb: 1.5,\r\n                    color: 'primary.main',\r\n                    fontWeight: 600,\r\n                    fontSize: '0.85rem'\r\n                  }}\r\n                >\r\n                  {category.category}\r\n                </Typography>\r\n\r\n                <Box sx={{\r\n                  display: 'flex',\r\n                  flexDirection: 'column',\r\n                  gap: 1\r\n                }}>\r\n                  {category.questions.map((question, questionIndex) => (\r\n                    <Button\r\n                      key={questionIndex}\r\n                      variant=\"outlined\"\r\n                      size=\"small\"\r\n                      onClick={() => handleTemplateClick(question)}\r\n                      sx={{\r\n                        justifyContent: 'flex-start',\r\n                        textAlign: 'left',\r\n                        py: 1.5,\r\n                        px: 2,\r\n                        borderRadius: 2,\r\n                        textTransform: 'none',\r\n                        fontSize: '0.875rem',\r\n                        lineHeight: 1.4,\r\n                        borderColor: alpha(theme.palette.primary.main, 0.3),\r\n                        backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n                        '&:hover': {\r\n                          borderColor: 'primary.main',\r\n                          backgroundColor: alpha(theme.palette.primary.main, 0.08),\r\n                          transform: 'translateY(-1px)',\r\n                          boxShadow: `0 2px 8px ${alpha(theme.palette.primary.main, 0.2)}`\r\n                        },\r\n                        transition: 'all 0.2s ease-in-out'\r\n                      }}\r\n                    >\r\n                      {question}\r\n                    </Button>\r\n                  ))}\r\n                </Box>\r\n              </Box>\r\n            ))}\r\n\r\n            <Box sx={{\r\n              mt: 3,\r\n              mb: 2,\r\n              p: 2,\r\n              backgroundColor: alpha(theme.palette.info.main, 0.08),\r\n              borderRadius: 2,\r\n              border: '1px solid',\r\n              borderColor: alpha(theme.palette.info.main, 0.2)\r\n            }}>\r\n              <Typography\r\n                variant=\"body2\"\r\n                color=\"info.main\"\r\n                sx={{ fontWeight: 500 }}\r\n              >\r\n                Pro Tip: You can ask complex questions like \"I've been struggling with my breakout strategy on Tuesdays. Can you show me all my losing trades tagged 'breakout' that occurred on a Tuesday in the last 6 months, and analyze if there were any specific economic events or market conditions that contributed to these losses?\" - I'll analyze your data and provide detailed insights!\r\n              </Typography>\r\n            </Box>\r\n          </Box>\r\n        )}\r\n\r\n        {/* Typing Indicator */}\r\n        {isTyping && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            gap: 2,\r\n            p: 2,\r\n            mb: 2\r\n          }}>\r\n            <Box sx={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              gap: 1,\r\n              backgroundColor: alpha(theme.palette.grey[500], 0.1),\r\n              borderRadius: 2,\r\n              px: 2,\r\n              py: 1\r\n            }}>\r\n              <CircularProgress\r\n                size={16}\r\n                thickness={4}\r\n                sx={{ color: 'text.secondary' }}\r\n              />\r\n              <Typography\r\n                variant=\"body2\"\r\n                color=\"text.secondary\"\r\n                sx={{ fontStyle: 'italic' }}\r\n              >\r\n                {toolExecutionStatus\r\n                  ? `AI is thinking... ${toolExecutionStatus}`\r\n                  : 'AI is thinking...'}\r\n              </Typography>\r\n            </Box>\r\n          </Box>\r\n        )}\r\n\r\n        <div ref={messagesEndRef} />\r\n      </Box>\r\n\r\n      <Divider sx={{ borderColor: alpha(theme.palette.divider, 0.5) }} />\r\n\r\n      {/* Message Limit Warning */}\r\n      {isAtMessageLimit && (\r\n        <Box sx={{ p: 2, pb: 0 }}>\r\n          <Alert\r\n            severity=\"warning\"\r\n            action={\r\n              <Button\r\n                color=\"inherit\"\r\n                size=\"small\"\r\n                onClick={handleNewChat}\r\n                startIcon={<NewChatIcon />}\r\n                sx={{ fontWeight: 600 }}\r\n              >\r\n                Start New Chat\r\n              </Button>\r\n            }\r\n            sx={{\r\n              borderRadius: 2,\r\n              '& .MuiAlert-message': {\r\n                width: '100%'\r\n              }\r\n            }}\r\n          >\r\n            <Typography variant=\"body2\" sx={{ fontWeight: 600 }}>\r\n              Conversation Limit Reached\r\n            </Typography>\r\n            <Typography variant=\"caption\" color=\"text.secondary\">\r\n              This conversation has reached the maximum length of {messageLimit} messages.\r\n              Please start a new conversation to continue.\r\n            </Typography>\r\n          </Alert>\r\n        </Box>\r\n      )}\r\n\r\n      {/* Input Area */}\r\n      <Box sx={{\r\n        p: 2,\r\n        backgroundColor: alpha(theme.palette.background.paper, 0.8),\r\n        backdropFilter: 'blur(10px)'\r\n      }}>\r\n        {/* Image Preview Section */}\r\n        {attachedImages.length > 0 && (\r\n          <Box sx={{\r\n            display: 'flex',\r\n            gap: 1,\r\n            mb: 1.5,\r\n            flexWrap: 'wrap',\r\n            alignItems: 'center'\r\n          }}>\r\n            <Typography\r\n              variant=\"caption\"\r\n              sx={{\r\n                color: attachedImages.length >= MAX_IMAGES ? 'warning.main' : 'text.secondary',\r\n                fontWeight: 500,\r\n                mr: 0.5\r\n              }}\r\n            >\r\n              {attachedImages.length}/{MAX_IMAGES}\r\n            </Typography>\r\n            {attachedImages.map((image) => (\r\n              <Box\r\n                key={image.id}\r\n                sx={{\r\n                  position: 'relative',\r\n                  width: 64,\r\n                  height: 64,\r\n                  borderRadius: 1.5,\r\n                  overflow: 'hidden',\r\n                  border: '1px solid',\r\n                  borderColor: 'divider'\r\n                }}\r\n              >\r\n                <Box\r\n                  component=\"img\"\r\n                  src={image.url}\r\n                  alt={image.name || 'Attached image'}\r\n                  sx={{\r\n                    width: '100%',\r\n                    height: '100%',\r\n                    objectFit: 'cover'\r\n                  }}\r\n                />\r\n                <IconButton\r\n                  size=\"small\"\r\n                  onClick={() => handleRemoveImage(image.id)}\r\n                  sx={{\r\n                    position: 'absolute',\r\n                    top: 2,\r\n                    right: 2,\r\n                    width: 18,\r\n                    height: 18,\r\n                    backgroundColor: 'rgba(0,0,0,0.6)',\r\n                    color: 'white',\r\n                    '&:hover': {\r\n                      backgroundColor: 'rgba(0,0,0,0.8)'\r\n                    }\r\n                  }}\r\n                >\r\n                  <CloseIcon sx={{ fontSize: 12 }} />\r\n                </IconButton>\r\n              </Box>\r\n            ))}\r\n          </Box>\r\n        )}\r\n\r\n        {/* Hidden file input */}\r\n        <input\r\n          ref={fileInputRef}\r\n          type=\"file\"\r\n          accept=\"image/*\"\r\n          multiple\r\n          style={{ display: 'none' }}\r\n          onChange={handleImageSelect}\r\n        />\r\n\r\n        <Box\r\n          onPaste={handlePaste}\r\n          sx={{\r\n            display: 'flex',\r\n            gap: 1,\r\n            alignItems: 'center',\r\n            backgroundColor: 'background.paper',\r\n            borderRadius: 3,\r\n            p: 1,\r\n            border: '1px solid',\r\n            borderColor: 'divider',\r\n            '&:focus-within': {\r\n              borderColor: 'primary.main',\r\n              boxShadow: `0 0 0 1px ${alpha(theme.palette.primary.main, 0.15)}`\r\n            }\r\n          }}\r\n        >\r\n          <AIChatMentionInput\r\n            ref={inputRef}\r\n            value={inputMessage}\r\n            onChange={setInputMessage}\r\n            onKeyDown={handleKeyPress}\r\n            placeholder={calendar ? \"(use @tag to mention tags)\" : \"Ask me anything about your trading...\"}\r\n            disabled={isLoading || isAtMessageLimit}\r\n            allTags={calendar?.tags || []}\r\n            maxRows={4}\r\n            sx={{ flex: 1, minWidth: 0, fontSize: '0.95rem', lineHeight: 1.4 }}\r\n          />\r\n          {/* Image upload button */}\r\n          <IconButton\r\n            aria-label=\"Attach image\"\r\n            onClick={handleImageUploadClick}\r\n            disabled={isReadOnly || isLoading || isAtMessageLimit || attachedImages.length >= MAX_IMAGES}\r\n            size=\"small\"\r\n            sx={{\r\n              backgroundColor: attachedImages.length > 0\r\n                ? alpha(theme.palette.primary.main, 0.1)\r\n                : 'background.default',\r\n              color: attachedImages.length > 0 ? 'primary.main' : 'text.secondary',\r\n              width: 32,\r\n              height: 32,\r\n              borderRadius: 2,\r\n              border: '1px solid',\r\n              borderColor: attachedImages.length > 0 ? 'primary.main' : 'divider',\r\n              transition: 'all 0.2s ease-in-out',\r\n              '&:hover': {\r\n                backgroundColor: alpha(theme.palette.primary.main, 0.12),\r\n                borderColor: 'primary.main',\r\n                color: 'primary.main'\r\n              },\r\n              '&:disabled': {\r\n                backgroundColor: 'action.disabledBackground',\r\n                color: 'action.disabled',\r\n                borderColor: 'action.disabledBackground'\r\n              }\r\n            }}\r\n          >\r\n            <ImageIcon sx={{ fontSize: 18 }} />\r\n          </IconButton>\r\n          <IconButton\r\n            aria-label=\"Insert note context\"\r\n            onClick={handleOpenNotesContext}\r\n            disabled={isReadOnly || !userId}\r\n            size=\"small\"\r\n            sx={{\r\n              backgroundColor: 'background.default',\r\n              color: 'text.secondary',\r\n              width: 32,\r\n              height: 32,\r\n              borderRadius: 2,\r\n              border: '1px solid',\r\n              borderColor: 'divider',\r\n              transition: 'all 0.2s ease-in-out',\r\n              '&:hover': {\r\n                backgroundColor: alpha(theme.palette.primary.main, 0.06),\r\n                borderColor: 'primary.main',\r\n                color: 'primary.main'\r\n              },\r\n              '&:disabled': {\r\n                backgroundColor: 'action.disabledBackground',\r\n                color: 'action.disabled',\r\n                borderColor: 'action.disabledBackground'\r\n              }\r\n            }}\r\n          >\r\n            <NotesIcon sx={{ fontSize: 18 }} />\r\n          </IconButton>\r\n          <IconButton\r\n            onClick={isLoading ? handleCancelRequest : handleSendMessage}\r\n            disabled={(!inputMessage.trim() && attachedImages.length === 0 && !isLoading) || isAtMessageLimit}\r\n            size=\"small\"\r\n            sx={{\r\n              backgroundColor: isLoading\r\n                ? 'error.main'\r\n                : (inputMessage.trim() || attachedImages.length > 0)\r\n                  ? 'primary.main'\r\n                  : 'action.disabledBackground',\r\n              color: isLoading\r\n                ? 'error.contrastText'\r\n                : (inputMessage.trim() || attachedImages.length > 0)\r\n                  ? 'primary.contrastText'\r\n                  : 'action.disabled',\r\n              width: 36,\r\n              height: 36,\r\n              transition: 'all 0.2s ease-in-out',\r\n              '&:hover': {\r\n                backgroundColor: isLoading\r\n                  ? 'error.dark'\r\n                  : (inputMessage.trim() || attachedImages.length > 0)\r\n                    ? 'primary.dark'\r\n                    : 'action.disabledBackground',\r\n                transform: (inputMessage.trim() || attachedImages.length > 0) && !isLoading ? 'scale(1.05)' : 'none'\r\n              },\r\n              '&:disabled': {\r\n                backgroundColor: 'action.disabledBackground',\r\n                color: 'action.disabled'\r\n              }\r\n            }}\r\n          >\r\n            {isLoading ? (\r\n              <StopIcon sx={{ fontSize: 18 }} />\r\n            ) : (\r\n              <SendIcon sx={{ fontSize: 18 }} />\r\n            )}\r\n          </IconButton>\r\n        </Box>\r\n\r\n        {/* Helper Text */}\r\n        <Typography\r\n          variant=\"caption\"\r\n          color=\"text.secondary\"\r\n          sx={{\r\n            mt: 1,\r\n            display: 'block',\r\n            textAlign: 'center',\r\n            opacity: 0.7\r\n          }}\r\n        >\r\n          {`Enter to send  Shift+Enter newline  @ for tags  Up to ${MAX_IMAGES} images`}\r\n        </Typography>\r\n      </Box>\r\n\r\n      {/* Notes Context Popup */}\r\n      {notesAnchorEl && (\r\n        <ClickAwayListener onClickAway={() => setNotesAnchorEl(null)}>\r\n          <Popper\r\n            open={Boolean(notesAnchorEl)}\r\n            anchorEl={notesAnchorEl}\r\n            placement=\"top-end\"\r\n            disablePortal\r\n            sx={{ zIndex: Z_INDEX.DIALOG_POPUP }}\r\n          >\r\n            <Paper\r\n              elevation={8}\r\n              sx={{\r\n                maxWidth: 360,\r\n                maxHeight: 320,\r\n                overflow: 'hidden',\r\n                borderRadius: 2,\r\n                boxShadow: theme.shadows[8]\r\n              }}\r\n            >\r\n              <Box sx={{ p: 1.5, borderBottom: '1px solid', borderColor: 'divider' }}>\r\n                <Typography variant=\"subtitle2\" sx={{ fontWeight: 600 }}>\r\n                  Add Context\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  Select a note to insert into your message.\r\n                </Typography>\r\n              </Box>\r\n              <Box\r\n                sx={{\r\n                  maxHeight: 250,\r\n                  overflow: 'auto',\r\n                  ...scrollbarStyles(theme)\r\n                }}\r\n              >\r\n                {notesLoading ? (\r\n                  <Box sx={{ p: 2, display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                    <CircularProgress size={16} />\r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      Loading notes...\r\n                    </Typography>\r\n                  </Box>\r\n                ) : availableNotes.length === 0 ? (\r\n                  <Box sx={{ p: 2 }}>\r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      No notes found yet.\r\n                    </Typography>\r\n                  </Box>\r\n                ) : (\r\n                  <List dense sx={{ p: 0 }}>\r\n                    {availableNotes.map(note => (\r\n                      <ListItemButton\r\n                        key={note.id}\r\n                        onClick={() => handleInsertNoteContext(note)}\r\n                        sx={{\r\n                          px: 1.5,\r\n                          py: 1,\r\n                          display: 'flex',\r\n                          flexDirection: 'column',\r\n                          alignItems: 'flex-start'\r\n                        }}\r\n                      >\r\n                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, width: '100%' }}>\r\n                          <NotesIcon sx={{ fontSize: 16, color: 'text.secondary', flexShrink: 0 }} />\r\n                          <Typography\r\n                            variant=\"body2\"\r\n                            sx={{\r\n                              fontWeight: 600,\r\n                              maxWidth: 200,\r\n                              overflow: 'hidden',\r\n                              textOverflow: 'ellipsis',\r\n                              whiteSpace: 'nowrap'\r\n                            }}\r\n                          >\r\n                            {note.title || 'Untitled'}\r\n                          </Typography>\r\n                        </Box>\r\n                      </ListItemButton>\r\n                    ))}\r\n                  </List>\r\n                )}\r\n              </Box>\r\n            </Paper>\r\n          </Popper>\r\n        </ClickAwayListener>\r\n      )}\r\n    </Box>\r\n  );\r\n});\r\n\r\nAIChatInterface.displayName = 'AIChatInterface';\r\n\r\nexport default AIChatInterface;\r\n","import React, { useState } from 'react';\r\nimport {\r\n  Autocomplete,\r\n  TextField,\r\n  Chip,\r\n  Box,\r\n  Tooltip,\r\n  Button,\r\n  Snackbar,\r\n  Alert\r\n} from '@mui/material';\r\nimport { useTheme } from '@mui/material/styles';\r\nimport {\r\n  getTagChipStyles,\r\n  formatTagForDisplay,\r\n  isGroupedTag,\r\n  getTagGroup\r\n} from '../../utils/tagColors';\r\nimport TagEditDialog from '../TagEditDialog';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\n\r\ninterface TagsInputProps {\r\n  tags: string[];\r\n  allTags: string[];\r\n  onTagsChange: (event: React.SyntheticEvent, value: string[]) => void;\r\n  calendarId: string;\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n}\r\n\r\nconst TagsInput: React.FC<TagsInputProps> = ({\r\n  tags,\r\n  allTags,\r\n  onTagsChange,\r\n  calendarId,\r\n  onTagUpdated\r\n}) => {\r\n  const theme = useTheme();\r\n  const [tagToEdit, setTagToEdit] = useState<string | null>(null);\r\n  const [showWarning, setShowWarning] = useState(false);\r\n\r\n  const handleTagEditSuccess = (oldTag: string, newTag: string, tradesUpdated: number) => {\r\n    if (onTagUpdated) {\r\n      onTagUpdated(oldTag, newTag);\r\n    }\r\n  };\r\n\r\n  const handleTagDelete = (deletedTag: string, tradesUpdated: number) => {\r\n    // Remove the deleted tag from current tags if it exists\r\n    if (tags.includes(deletedTag)) {\r\n      const updatedTags = tags.filter(tag => tag !== deletedTag);\r\n      // Create a synthetic event for the onTagsChange callback\r\n      // Using 'unknown' first to avoid TypeScript strict type checking\r\n      const syntheticEvent = {} as unknown as React.SyntheticEvent;\r\n      onTagsChange(syntheticEvent, updatedTags);\r\n    }\r\n\r\n    if (onTagUpdated) {\r\n      onTagUpdated(deletedTag, ''); // Pass empty string to indicate deletion\r\n    }\r\n  };\r\n\r\n  // Validate and filter tags to prevent multiple colons\r\n  const handleTagsChangeWithValidation = (event: React.SyntheticEvent, value: string[]) => {\r\n    const validTags: string[] = [];\r\n    let hasInvalidTags = false;\r\n\r\n    value.forEach(tag => {\r\n      // Count colons in the tag\r\n      const colonCount = (tag.match(/:/g) || []).length;\r\n\r\n      if (colonCount <= 1) {\r\n        validTags.push(tag);\r\n      } else {\r\n        hasInvalidTags = true;\r\n      }\r\n    });\r\n\r\n    // Show warning if invalid tags were filtered out\r\n    if (hasInvalidTags) {\r\n      setShowWarning(true);\r\n    }\r\n\r\n    // Call the original handler with filtered tags\r\n    onTagsChange(event, validTags);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <Autocomplete\r\n        multiple\r\n        freeSolo\r\n        options={allTags}\r\n        value={tags || []}\r\n        onChange={handleTagsChangeWithValidation}\r\n        slotProps={{\r\n          popper: {\r\n            sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n          },\r\n          listbox: {\r\n            sx: {\r\n              ...scrollbarStyles(theme)\r\n            }\r\n          }\r\n        }}\r\n        renderTags={(value, getTagProps) =>\r\n          value.map((option, index) => {\r\n            const { key, ...otherProps } = getTagProps({ index });\r\n            return (\r\n              <Chip\r\n                key={key}\r\n                label={formatTagForDisplay(option, false)}\r\n                {...otherProps}\r\n                sx={getTagChipStyles(option, theme)}\r\n                title={isGroupedTag(option) ? `Group: ${getTagGroup(option)}` : undefined}\r\n              />\r\n            );\r\n          })\r\n        }\r\n        renderOption={(props, option) => {\r\n          const { key, ...restProps } = props;\r\n          return (\r\n            <li key={key} {...restProps}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                  {isGroupedTag(option) && (\r\n                    <Chip\r\n                      label={getTagGroup(option)}\r\n                      size=\"small\"\r\n                      sx={{\r\n                        ...getTagChipStyles(option, theme),\r\n                        height: '18px',\r\n                        fontSize: '0.7rem'\r\n                      }}\r\n                    />\r\n                  )}\r\n                  {formatTagForDisplay(option, true)}\r\n                </Box>\r\n                <Tooltip title=\"Edit this tag across all trades\">\r\n                  <Button\r\n                    size=\"small\"\r\n                    onClick={(e) => {\r\n                      e.stopPropagation();\r\n                      setTagToEdit(option);\r\n                    }}\r\n                    sx={{\r\n                      color: theme.palette.text.secondary,\r\n                      '&:hover': {\r\n                        color: theme.palette.primary.main\r\n                      }\r\n                    }}\r\n                  >\r\n                    Edit\r\n                  </Button>\r\n                </Tooltip>\r\n              </Box>\r\n            </li>\r\n          );\r\n        }}\r\n        renderInput={(params) => (\r\n          <TextField\r\n            {...params}\r\n            label=\"Tags\"\r\n            placeholder=\"Add tags\"\r\n            slotProps={{\r\n              htmlInput: {\r\n                ...params.inputProps,\r\n                id: 'trade-tags-input'\r\n              }\r\n            }}\r\n          />\r\n        )}\r\n      />\r\n\r\n      {tagToEdit && (\r\n        <TagEditDialog\r\n          open={!!tagToEdit}\r\n          onClose={() => setTagToEdit(null)}\r\n          tag={tagToEdit}\r\n          calendarId={calendarId}\r\n          onSuccess={handleTagEditSuccess}\r\n          onDelete={handleTagDelete}\r\n          onTagUpdated={onTagUpdated}\r\n        />\r\n      )}\r\n\r\n      <Snackbar\r\n        open={showWarning}\r\n        autoHideDuration={4000}\r\n        onClose={() => setShowWarning(false)}\r\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}\r\n        sx={{ zIndex: Z_INDEX.DIALOG_POPUP }}\r\n      >\r\n        <Alert\r\n          onClose={() => setShowWarning(false)}\r\n          severity=\"warning\"\r\n          sx={{ width: '100%' }}\r\n        >\r\n          Tags can only contain one colon (:) for category formatting. Invalid tags were removed.\r\n        </Alert>\r\n      </Snackbar>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default React.memo(TagsInput);\r\n","import { Trade } from '../types/dualWrite';\r\nimport { TradeRepository } from '../services/repository/repositories/TradeRepository';\r\nimport { logger } from './logger';\r\n\r\n/**\r\n * Fetch recent trades and generate contextual suggestions\r\n * @param calendarId Calendar ID to fetch trades from\r\n * @param currentTags Current trade tags\r\n * @param currentSession Current trade session\r\n * @param currentInput Current input value\r\n * @param maxSuggestions Maximum number of suggestions to return\r\n * @returns Array of suggested trade names\r\n */\r\nexport const fetchAndGenerateTradeNameSuggestions = async (\r\n  calendarId: string,\r\n  currentTags: string[] = [],\r\n  currentSession?: string,\r\n  currentInput: string = '',\r\n  maxSuggestions: number = 8\r\n): Promise<string[]> => {\r\n  try {\r\n    const tradeRepo = new TradeRepository();\r\n    // Fetch last 15 recent trades for suggestions\r\n    const currentYear = new Date().getFullYear();\r\n    const result = await tradeRepo.getTradesForYearPaginated(calendarId, currentYear, 1, 15);\r\n    const recentTrades = result.trades;\r\n\r\n    // If no trades found, return common patterns\r\n    if (!recentTrades || recentTrades.length === 0) {\r\n      return generateCommonTradeNamePatterns(currentInput);\r\n    }\r\n\r\n    // Generate contextual suggestions from recent trades\r\n    const contextualSuggestions = generateContextualTradeNameSuggestions(\r\n      recentTrades,\r\n      currentTags,\r\n      currentSession,\r\n      currentInput,\r\n      maxSuggestions\r\n    );\r\n\r\n    // If few contextual suggestions, add common patterns\r\n    if (contextualSuggestions.length < 5) {\r\n      const commonPatterns = generateCommonTradeNamePatterns(currentInput);\r\n      const uniquePatterns = commonPatterns.filter(pattern =>\r\n        !contextualSuggestions.includes(pattern)\r\n      );\r\n      return [...contextualSuggestions, ...uniquePatterns].slice(0, maxSuggestions);\r\n    }\r\n\r\n    return contextualSuggestions;\r\n  } catch (error) {\r\n    logger.error('Error fetching trades for autocomplete:', error);\r\n    // Fallback to common patterns on error\r\n    return generateCommonTradeNamePatterns(currentInput);\r\n  }\r\n};\r\n\r\n/**\r\n * Generate trade name suggestions based on past trades\r\n * @param allTrades Array of all trades\r\n * @param currentInput Current input value to filter suggestions\r\n * @param maxSuggestions Maximum number of suggestions to return\r\n * @returns Array of suggested trade names\r\n */\r\nexport const generateTradeNameSuggestions = (\r\n  allTrades: Trade[],\r\n  currentInput: string = '',\r\n  maxSuggestions: number = 10\r\n): string[] => {\r\n  if (!allTrades || allTrades.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Extract all unique trade names from past trades\r\n  const tradeNames = allTrades\r\n    .map(trade => trade.name)\r\n    .filter((name): name is string => Boolean(name && name.trim()))\r\n    .map(name => name.trim())\r\n    .filter(name => name !== 'New Trade') // Exclude default temporary names\r\n    .filter((name, index, array) => array.indexOf(name) === index); // Remove duplicates\r\n\r\n  // If no input, return most frequently used names\r\n  if (!currentInput.trim()) {\r\n    // Count frequency of each trade name\r\n    const nameFrequency = new Map<string, number>();\r\n    tradeNames.forEach(name => {\r\n      nameFrequency.set(name, (nameFrequency.get(name) || 0) + 1);\r\n    });\r\n\r\n    // Sort by frequency (most used first) and return top suggestions\r\n    return Array.from(nameFrequency.entries())\r\n      .sort((a, b) => b[1] - a[1])\r\n      .map(([name]) => name)\r\n      .slice(0, maxSuggestions);\r\n  }\r\n\r\n  // Filter names that match the current input (case-insensitive)\r\n  const inputLower = currentInput.toLowerCase();\r\n  const matchingNames = tradeNames.filter(name =>\r\n    name.toLowerCase().includes(inputLower)\r\n  );\r\n\r\n  // Sort matching names by relevance:\r\n  // 1. Exact matches first\r\n  // 2. Names that start with the input\r\n  // 3. Names that contain the input\r\n  const exactMatches = matchingNames.filter(name => \r\n    name.toLowerCase() === inputLower\r\n  );\r\n  \r\n  const startsWithMatches = matchingNames.filter(name => \r\n    name.toLowerCase().startsWith(inputLower) && \r\n    name.toLowerCase() !== inputLower\r\n  );\r\n  \r\n  const containsMatches = matchingNames.filter(name => \r\n    name.toLowerCase().includes(inputLower) && \r\n    !name.toLowerCase().startsWith(inputLower)\r\n  );\r\n\r\n  // Combine and limit results\r\n  const suggestions = [\r\n    ...exactMatches,\r\n    ...startsWithMatches,\r\n    ...containsMatches\r\n  ].slice(0, maxSuggestions);\r\n\r\n  return suggestions;\r\n};\r\n\r\n/**\r\n * Generate smart trade name suggestions based on current trade context\r\n * @param allTrades Array of all trades\r\n * @param currentTags Current trade tags\r\n * @param currentSession Current trade session\r\n * @param currentInput Current input value\r\n * @param maxSuggestions Maximum number of suggestions to return\r\n * @returns Array of contextual trade name suggestions\r\n */\r\nexport const generateContextualTradeNameSuggestions = (\r\n  allTrades: Trade[],\r\n  currentTags: string[] = [],\r\n  currentSession?: string,\r\n  currentInput: string = '',\r\n  maxSuggestions: number = 8\r\n): string[] => {\r\n  if (!allTrades || allTrades.length === 0) {\r\n    return generateTradeNameSuggestions(allTrades, currentInput, maxSuggestions);\r\n  }\r\n\r\n  // Find trades with similar context (same tags or session)\r\n  const contextualTrades = allTrades.filter(trade => {\r\n    if (!trade.name || trade.name.trim() === '' || trade.name === 'New Trade') {\r\n      return false;\r\n    }\r\n\r\n    // Check for matching tags\r\n    const hasMatchingTags = currentTags.length > 0 && trade.tags && \r\n      trade.tags.some(tag => currentTags.includes(tag));\r\n\r\n    // Check for matching session\r\n    const hasMatchingSession = currentSession && trade.session === currentSession;\r\n\r\n    return hasMatchingTags || hasMatchingSession;\r\n  });\r\n\r\n  // If we have contextual trades, prioritize their names\r\n  if (contextualTrades.length > 0) {\r\n    const contextualNames = generateTradeNameSuggestions(\r\n      contextualTrades, \r\n      currentInput, \r\n      Math.ceil(maxSuggestions * 0.7) // 70% of suggestions from contextual trades\r\n    );\r\n\r\n    // Fill remaining slots with general suggestions\r\n    const remainingSlots = maxSuggestions - contextualNames.length;\r\n    if (remainingSlots > 0) {\r\n      const generalNames = generateTradeNameSuggestions(\r\n        allTrades, \r\n        currentInput, \r\n        remainingSlots\r\n      ).filter(name => !contextualNames.includes(name)); // Avoid duplicates\r\n\r\n      return [...contextualNames, ...generalNames];\r\n    }\r\n\r\n    return contextualNames;\r\n  }\r\n\r\n  // Fallback to general suggestions\r\n  return generateTradeNameSuggestions(allTrades, currentInput, maxSuggestions);\r\n};\r\n\r\n/**\r\n * Generate common trade name patterns based on currency pairs and strategies\r\n * @param currentInput Current input value\r\n * @returns Array of common trade name patterns\r\n */\r\nexport const generateCommonTradeNamePatterns = (currentInput: string = ''): string[] => {\r\n  const commonPatterns = [\r\n    // Currency pairs\r\n    'EURUSD Long',\r\n    'EURUSD Short',\r\n    'GBPUSD Long',\r\n    'GBPUSD Short',\r\n    'USDJPY Long',\r\n    'USDJPY Short',\r\n    'AUDUSD Long',\r\n    'AUDUSD Short',\r\n    'USDCAD Long',\r\n    'USDCAD Short',\r\n    'NZDUSD Long',\r\n    'NZDUSD Short',\r\n    'EURJPY Long',\r\n    'EURJPY Short',\r\n    'GBPJPY Long',\r\n    'GBPJPY Short',\r\n    \r\n    // Strategy patterns\r\n    'Breakout Trade',\r\n    'Reversal Trade',\r\n    'Trend Following',\r\n    'Support Bounce',\r\n    'Resistance Rejection',\r\n    'News Trade',\r\n    'Scalp Trade',\r\n    'Swing Trade',\r\n    'Range Trade',\r\n    'Momentum Trade'\r\n  ];\r\n\r\n  if (!currentInput.trim()) {\r\n    return commonPatterns.slice(0, 5); // Return first 5 if no input\r\n  }\r\n\r\n  const inputLower = currentInput.toLowerCase();\r\n  return commonPatterns\r\n    .filter(pattern => pattern.toLowerCase().includes(inputLower))\r\n    .slice(0, 5);\r\n};","import React, { useMemo, useCallback, useState, useEffect } from 'react';\r\nimport {\r\n  TextField,\r\n  FormControl,\r\n  FormLabel,\r\n  RadioGroup,\r\n  FormControlLabel,\r\n  Radio,\r\n  Select,\r\n  MenuItem,\r\n  InputLabel,\r\n  Box,\r\n  FormControlLabel as MuiFormControlLabel,\r\n  Checkbox,\r\n  Typography,\r\n  Chip,\r\n  alpha,\r\n  useTheme,\r\n  Autocomplete,\r\n  Button,\r\n  CircularProgress,\r\n  InputAdornment\r\n} from '@mui/material';\r\nimport { DatePicker } from '@mui/x-date-pickers';\r\nimport { Trade, TradeEconomicEvent } from '../../types/dualWrite';\r\nimport { FormField } from '../StyledComponents';\r\nimport ImageUploader from './ImageUploader';\r\nimport { GridImage, GridPendingImage } from './ImageGrid';\r\nimport { formatCurrency } from '../../utils/formatters';\r\nimport TagsInput from './TagsInput';\r\nimport { isGroupedTag, getTagGroup } from '../../utils/tagColors';\r\nimport { DynamicRiskSettings } from '../../utils/dynamicRiskUtils';\r\nimport RichTextEditor from '../common/RichTextEditor';\r\nimport { fetchAndGenerateTradeNameSuggestions } from '../../utils/tradeNameSuggestions';\r\nimport { Currency } from '../../types/economicCalendar';\r\nimport { CURRENCY_PAIRS } from '../../services/tradeEconomicEventService';\r\nimport { Z_INDEX } from '../../styles/zIndex';\r\n\r\nexport const DEFAULT_PAIRS_TAG_GROUP = \"Pairs\"\r\nexport interface NewTradeForm {\r\n  id: string;\r\n  name: string;\r\n  trade_type: 'win' | 'loss' | 'breakeven';\r\n  amount: number;\r\n  entry_price: number;\r\n  exit_price: number;\r\n  stop_loss: number;\r\n  take_profit: number;\r\n  risk_to_reward: number;\r\n  trade_date?: Date | null;\r\n  tags: string[];\r\n  partials_taken: boolean;\r\n  session: 'Asia' | 'London' | 'NY AM' | 'NY PM' | '';\r\n  notes: string;\r\n  pending_images: Array<PendingImage>;\r\n  uploaded_images: Array<TradeImage>;\r\n  is_temporary?: boolean;\r\n  economic_events?: TradeEconomicEvent[];\r\n}\r\n\r\nexport interface PendingImage {\r\n  id?: string;\r\n  file: File;\r\n  preview: string;\r\n  caption?: string;\r\n  width?: number;\r\n  height?: number;\r\n  row?: number;\r\n  column?: number;\r\n  column_width?: number; // Width as percentage (0-100)\r\n}\r\n\r\nexport interface TradeImage {\r\n  url: string;\r\n  id: string;\r\n  calendar_id: string;\r\n  pending?: boolean;\r\n  caption?: string;\r\n  width?: number;\r\n  height?: number;\r\n  row?: number;\r\n  column?: number;\r\n  column_width?: number; // Width as percentage (0-100)\r\n}\r\ninterface TradeFormProps {\r\n  newTrade: NewTradeForm;\r\n  editingTrade: Trade | null;\r\n  allTags: string[];\r\n  isSubmitting: boolean;\r\n  accountBalance: number;\r\n  dynamicRiskSettings: DynamicRiskSettings;\r\n  calculateCumulativePnl(newTrade?: NewTradeForm): number;\r\n  calculateAmountFromRiskToReward: (rr: number, cumulativePnL: number) => number;\r\n  calendarId: string;\r\n  requiredTagGroups?: string[];\r\n  onTagUpdated?: (oldTag: string, newTag: string) => Promise<{ success: boolean; tradesUpdated: number }>;\r\n  onNameChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onAmountChange: (amount: number) => void;\r\n  onTypeChange: (e: any) => void;\r\n  onEntryChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onExitChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onStopLossChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onTakeProfitChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onRiskToRewardChange: (risk_to_reward: number) => void;\r\n  onPartialsTakenChange: (e: React.ChangeEvent<HTMLInputElement>) => void;\r\n  onSessionChange: (e: any) => void;\r\n  onNotesChange: (value: string) => void;\r\n  onTagsChange: (event: React.SyntheticEvent, newValue: string[]) => void;\r\n  onDateChange?: (trade_date: Date | null) => void;\r\n  onImageUpload: (files: FileList) => void;\r\n  onImageCaptionChange: (index: number, caption: string, isPending: boolean) => void;\r\n  onImageRemove: (index: number, isPending: boolean) => void;\r\n  onImagesReordered?: (images: Array<GridImage | GridPendingImage>) => void;\r\n  onSubmit: (e: React.FormEvent) => void;\r\n  // Optional props for trade link navigation in notes\r\n  trades?: Array<{ id: string;[key: string]: any }>;\r\n  onOpenGalleryMode?: (trades: any[], initialTradeId?: string, title?: string) => void;\r\n}\r\n\r\nconst TradeForm: React.FC<TradeFormProps> = ({\r\n  newTrade,\r\n  editingTrade,\r\n  allTags,\r\n  isSubmitting,\r\n  accountBalance,\r\n  dynamicRiskSettings,\r\n  calculateAmountFromRiskToReward,\r\n  calculateCumulativePnl,\r\n  calendarId,\r\n  requiredTagGroups = [],\r\n  onTagUpdated,\r\n  onNameChange,\r\n  onAmountChange,\r\n  onTypeChange,\r\n  onEntryChange,\r\n  onExitChange,\r\n  onStopLossChange,\r\n  onTakeProfitChange,\r\n  onRiskToRewardChange,\r\n  onPartialsTakenChange,\r\n  onSessionChange,\r\n  onNotesChange,\r\n  onTagsChange,\r\n  onDateChange,\r\n  onImageUpload,\r\n  onImageCaptionChange,\r\n  onImageRemove,\r\n  onImagesReordered,\r\n  onSubmit,\r\n  trades,\r\n  onOpenGalleryMode\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // State for trade name suggestions\r\n  const [tradeNameSuggestions, setTradeNameSuggestions] = useState<string[]>([]);\r\n\r\n  // Fetch and generate trade name suggestions\r\n  useEffect(() => {\r\n    const fetchSuggestions = async () => {\r\n      if (!calendarId) return;\r\n\r\n      const suggestions = await fetchAndGenerateTradeNameSuggestions(\r\n        calendarId,\r\n        newTrade.tags,\r\n        newTrade.session || undefined,\r\n        newTrade.name,\r\n        8\r\n      );\r\n      setTradeNameSuggestions(suggestions);\r\n    };\r\n\r\n    fetchSuggestions();\r\n  }, [calendarId, newTrade.tags, newTrade.session, newTrade.name]);\r\n\r\n  const tagsWithPairs = useMemo(() => {\r\n    return Array.from(new Set([...allTags, ...CURRENCY_PAIRS.map(pair => `${DEFAULT_PAIRS_TAG_GROUP}:${pair}`)]));\r\n  }, [allTags]);\r\n\r\n  // Automatically add \"pair\" to required tag groups if not already present\r\n  const effectiveRequiredTagGroups = useMemo(() => {\r\n    const groups = [...requiredTagGroups];\r\n    if (!groups.includes(DEFAULT_PAIRS_TAG_GROUP)) {\r\n      groups.push(DEFAULT_PAIRS_TAG_GROUP);\r\n    }\r\n    return groups;\r\n  }, [requiredTagGroups]);\r\n\r\n  // Calculate which required tag groups are still missing\r\n  const missingRequiredGroups = useMemo(() => {\r\n    if (!effectiveRequiredTagGroups || effectiveRequiredTagGroups.length === 0) return [];\r\n\r\n    // Get the groups that are already satisfied by current tags\r\n    const satisfiedGroups = new Set<string>();\r\n    newTrade.tags.forEach(tag => {\r\n      if (isGroupedTag(tag)) {\r\n        const group = getTagGroup(tag);\r\n        satisfiedGroups.add(group);\r\n      }\r\n    });\r\n\r\n    // Return groups that are required but not satisfied\r\n    return effectiveRequiredTagGroups.filter(group => !satisfiedGroups.has(group));\r\n  }, [effectiveRequiredTagGroups, newTrade.tags]);\r\n\r\n  const cumulativePnl = calculateCumulativePnl(newTrade);\r\n\r\n\r\n\r\n  // Calculate and update the amount based on risk\r\n  const calculateAmountFromRisk = (): number => {\r\n    if (!dynamicRiskSettings.risk_per_trade || !newTrade.risk_to_reward) return 0;\r\n\r\n    const rr = Number(newTrade.risk_to_reward);\r\n    if (isNaN(rr)) return 0;\r\n\r\n    const amount = calculateAmountFromRiskToReward(rr, Number(cumulativePnl));\r\n\r\n    // Ensure the amount is updated in the form state\r\n    // This is important to make sure the amount is saved correctly\r\n    if (!newTrade.partials_taken && amount > 0) {\r\n      // Only update if we're not in manual mode and have a valid amount\r\n      setTimeout(() => onAmountChange(amount), 0);\r\n    }\r\n\r\n    return amount;\r\n  };\r\n\r\n\r\n  const handleRiskToRewardChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const value = e.target.value;\r\n    if (value === '' || /^\\d*\\.?\\d*$/.test(value)) {\r\n      const numValue = value === '' ? 0 : parseFloat(value);\r\n      onRiskToRewardChange(numValue)\r\n\r\n      // If risk per trade is set and partials are not taken, automatically calculate and update the amount\r\n      if (dynamicRiskSettings.risk_per_trade && numValue && !newTrade.partials_taken) {\r\n        if (!isNaN(numValue)) {\r\n          const calculatedAmount = calculateAmountFromRiskToReward(numValue, cumulativePnl);\r\n          onAmountChange(calculatedAmount)\r\n        }\r\n      }\r\n    }\r\n  }, [onRiskToRewardChange, dynamicRiskSettings.risk_per_trade, newTrade.partials_taken, cumulativePnl, onAmountChange]);\r\n\r\n\r\n  return (\r\n    <form onSubmit={onSubmit}>\r\n      <FormField>\r\n        <Autocomplete\r\n          freeSolo\r\n          options={tradeNameSuggestions}\r\n          value={newTrade.name}\r\n          onInputChange={(event, newValue) => {\r\n            // Create a synthetic event for compatibility with existing handler\r\n            const syntheticEvent = {\r\n              target: { value: newValue || '' }\r\n            } as React.ChangeEvent<HTMLInputElement>;\r\n            onNameChange(syntheticEvent);\r\n          }}\r\n          slotProps={{\r\n            popper: {\r\n              sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n            }\r\n          }}\r\n          renderInput={(params) => (\r\n            <TextField\r\n              {...params}\r\n              label=\"Trade Name\"\r\n              placeholder=\"Enter a name for this trade\"\r\n              fullWidth\r\n            />\r\n          )}\r\n          renderOption={(props, option) => {\r\n            const { key, ...otherProps } = props;\r\n            return (\r\n              <Box component=\"li\" key={key} {...otherProps}>\r\n                <Typography variant=\"body2\">{option}</Typography>\r\n              </Box>\r\n            );\r\n          }}\r\n          sx={{\r\n            '& .MuiAutocomplete-option': {\r\n              fontSize: '0.875rem',\r\n            }\r\n          }}\r\n        />\r\n      </FormField>\r\n      <Box sx={{ display: 'flex', gap: 2, width: '100%' }}>\r\n        <FormField sx={{ flex: 1 }}>\r\n          <TextField\r\n            label=\"Entry Price\"\r\n            type=\"number\"\r\n            value={newTrade.entry_price == 0 ? undefined : newTrade.entry_price}\r\n            onChange={onEntryChange}\r\n            fullWidth\r\n            placeholder=\"Optional entry price\"\r\n            slotProps={{\r\n              htmlInput: { step: 0.00001 }\r\n            }}\r\n          />\r\n        </FormField>\r\n        <FormField sx={{ flex: 1 }}>\r\n          <TextField\r\n            label=\"Exit Price\"\r\n            type=\"number\"\r\n            value={newTrade.exit_price == 0 ? undefined : newTrade.exit_price}\r\n            onChange={onExitChange}\r\n            fullWidth\r\n            placeholder=\"Optional exit price\"\r\n            slotProps={{\r\n              htmlInput: { step: 0.00001 }\r\n            }}\r\n          />\r\n        </FormField>\r\n      </Box>\r\n\r\n      <Box sx={{ display: 'flex', gap: 2, width: '100%' }}>\r\n        <FormField sx={{ flex: 1 }}>\r\n          <TextField\r\n            label=\"Stop Loss\"\r\n            type=\"number\"\r\n            value={newTrade.stop_loss == 0 ? undefined : newTrade.stop_loss}\r\n            onChange={onStopLossChange}\r\n            fullWidth\r\n            placeholder=\"Optional stop loss\"\r\n            slotProps={{\r\n              htmlInput: { step: 0.00001 }\r\n            }}\r\n          />\r\n        </FormField>\r\n        <FormField sx={{ flex: 1 }}>\r\n          <TextField\r\n            label=\"Take Profit\"\r\n            type=\"number\"\r\n            value={newTrade.take_profit == 0 ? undefined : newTrade.take_profit}\r\n            onChange={onTakeProfitChange}\r\n            fullWidth\r\n            placeholder=\"Optional take profit\"\r\n            slotProps={{\r\n              htmlInput: { step: 0.00001 }\r\n            }}\r\n          />\r\n        </FormField>\r\n      </Box>\r\n\r\n      {/* Date picker - only show when editing a trade */}\r\n      {editingTrade && onDateChange && (\r\n        <FormField>\r\n          <DatePicker\r\n            label=\"Trade Date\"\r\n            value={newTrade.trade_date}\r\n            onChange={onDateChange}\r\n            slotProps={{\r\n              textField: {\r\n                fullWidth: true,\r\n                helperText: 'Change the date of this trade'\r\n              },\r\n              popper: {\r\n                sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n              }\r\n            }}\r\n          />\r\n        </FormField>\r\n      )}\r\n      <FormControl component=\"fieldset\" sx={{ mb: 2 }}>\r\n        <FormLabel component=\"legend\">Trade Type</FormLabel>\r\n        <RadioGroup\r\n          row\r\n          name=\"type\"\r\n          value={newTrade.trade_type}\r\n          onChange={onTypeChange}\r\n        >\r\n          <FormControlLabel\r\n            value=\"win\"\r\n            control={<Radio />}\r\n            label=\"Win\"\r\n          />\r\n          <FormControlLabel\r\n            value=\"loss\"\r\n            control={<Radio />}\r\n            label=\"Loss\"\r\n          />\r\n          <FormControlLabel\r\n            value=\"breakeven\"\r\n            control={<Radio />}\r\n            label=\"Breakeven\"\r\n          />\r\n        </RadioGroup>\r\n      </FormControl>\r\n      {(!dynamicRiskSettings.risk_per_trade || (dynamicRiskSettings.risk_per_trade && newTrade.partials_taken)) ? (\r\n        <FormField>\r\n          <TextField\r\n            label=\"Amount\"\r\n            type=\"number\"\r\n            value={newTrade.amount == 0 ? undefined : newTrade.amount}\r\n            onChange={(e) => onAmountChange(parseFloat(e.target.value) || 0)}\r\n            fullWidth\r\n            required\r\n            helperText={dynamicRiskSettings.risk_per_trade && newTrade.partials_taken ? \"Manual entry for partial profits\" : undefined}\r\n          />\r\n        </FormField>\r\n      ) : (\r\n        <FormField>\r\n          <TextField\r\n            label=\"Amount (Calculated from Risk)\"\r\n            type=\"number\"\r\n            value={calculateAmountFromRisk()}\r\n            sx={{\r\n              '& .MuiInputBase-input': { pointerEvents: 'none' }\r\n            }}\r\n            fullWidth\r\n            disabled\r\n            InputLabelProps={{\r\n              shrink: true\r\n            }}\r\n            helperText={\r\n              dynamicRiskSettings?.dynamic_risk_enabled &&\r\n                dynamicRiskSettings.increased_risk_percentage &&\r\n                dynamicRiskSettings.profit_threshold_percentage &&\r\n                (Number(cumulativePnl) / Number(accountBalance) * 100) >= dynamicRiskSettings.profit_threshold_percentage\r\n                ? `Based on ${dynamicRiskSettings.increased_risk_percentage}% of account balance (INCREASED from ${dynamicRiskSettings.risk_per_trade}%)`\r\n                : `Based on ${dynamicRiskSettings.risk_per_trade}% of account balance (${formatCurrency((Number(accountBalance) * (dynamicRiskSettings.risk_per_trade || 0)) / 100)})`\r\n            }\r\n          />\r\n        </FormField>\r\n      )}\r\n\r\n\r\n      {dynamicRiskSettings.risk_per_trade !== undefined && (\r\n        <FormField>\r\n          <MuiFormControlLabel\r\n            control={\r\n              <Checkbox\r\n                checked={newTrade.partials_taken}\r\n                onChange={onPartialsTakenChange}\r\n              />\r\n            }\r\n            label={\r\n              <Typography variant=\"body2\">\r\n                Partials taken (allows manual amount entry)\r\n              </Typography>\r\n            }\r\n          />\r\n        </FormField>\r\n      )}\r\n      <FormField>\r\n        <TextField\r\n          label=\"Risk to Reward\"\r\n          value={newTrade.risk_to_reward == 0 ? undefined : newTrade.risk_to_reward}\r\n          onChange={handleRiskToRewardChange}\r\n          fullWidth\r\n          type=\"number\"\r\n          slotProps={{\r\n            htmlInput: { min: 0, step: 0.1 }\r\n          }}\r\n          sx={{\r\n            // Hide number input spinners for Chrome, Safari, Edge, Opera\r\n            '& input[type=number]::-webkit-outer-spin-button, & input[type=number]::-webkit-inner-spin-button': {\r\n              WebkitAppearance: 'none',\r\n              margin: 0,\r\n            },\r\n            // Hide number input spinners for Firefox\r\n            '& input[type=number]': {\r\n              MozAppearance: 'textfield',\r\n            },\r\n          }}\r\n        />\r\n      </FormField>\r\n      <FormField>\r\n        <FormControl fullWidth required>\r\n          <InputLabel id=\"session-label\">Session *</InputLabel>\r\n          <Select\r\n            labelId=\"session-label\"\r\n            value={newTrade.session}\r\n            onChange={onSessionChange}\r\n            label=\"Session *\"\r\n            required\r\n            MenuProps={{\r\n              sx: { zIndex: Z_INDEX.DIALOG_POPUP }\r\n            }}\r\n          >\r\n            <MenuItem value=\"\">None</MenuItem>\r\n            <MenuItem value=\"Asia\">Asia</MenuItem>\r\n            <MenuItem value=\"London\">London</MenuItem>\r\n            <MenuItem value=\"NY AM\">NY AM</MenuItem>\r\n            <MenuItem value=\"NY PM\">NY PM</MenuItem>\r\n          </Select>\r\n        </FormControl>\r\n      </FormField>\r\n      <FormField>\r\n        {/* Required Tag Groups Indicator */}\r\n        {missingRequiredGroups.length > 0 && (\r\n          <Box sx={{\r\n            mb: 2,\r\n            p: 2,\r\n            borderRadius: 1,\r\n            bgcolor: alpha(theme.palette.warning.main, 0.1),\r\n            border: `1px solid ${alpha(theme.palette.warning.main, 0.3)}`\r\n          }}>\r\n            <Typography variant=\"body2\" color=\"warning.main\" sx={{ fontWeight: 600, mb: 1 }}>\r\n              Required Tag Groups\r\n            </Typography>\r\n            <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mb: 1, display: 'block' }}>\r\n              Please add at least one tag from each required group:\r\n            </Typography>\r\n            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n              {missingRequiredGroups.map(group => (\r\n                <Chip\r\n                  key={group}\r\n                  label={group}\r\n                  size=\"small\"\r\n                  color=\"warning\"\r\n                  variant=\"outlined\"\r\n                  sx={{\r\n                    fontWeight: 500,\r\n                    '& .MuiChip-label': {\r\n                      fontSize: '0.75rem'\r\n                    }\r\n                  }}\r\n                />\r\n              ))}\r\n            </Box>\r\n          </Box>\r\n        )}\r\n\r\n\r\n\r\n        <TagsInput\r\n          tags={newTrade.tags}\r\n          allTags={tagsWithPairs}\r\n          onTagsChange={onTagsChange}\r\n          calendarId={calendarId}\r\n          onTagUpdated={onTagUpdated}\r\n        />\r\n        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 0.5, display: 'block' }}>\r\n          Pro tip: Categorize tags using the format \"Category:Tag\" (e.g., \"Strategy:Breakout\", \"Setup:Double Top\").\r\n          Categorized tags are grouped together in charts, making it easier to filter and analyze your trading patterns\r\n          and identify which strategies and setups are most profitable. Note: Only one colon (:) is allowed per tag.\r\n        </Typography>\r\n      </FormField>\r\n\r\n\r\n      {/* Debug layout information */}\r\n      {/* {(() => {\r\n        logger.log(\"TradeForm rendering with images:\",\r\n          \"Pending:\", newTrade.pending_images.map(img => ({ id: img.id, row: img.row, column: img.column, column_width: img.column_width })),\r\n          \"Uploaded:\", newTrade.uploaded_images.map(img => ({ id: img.id, row: img.row, column: img.column, column_width: img.column_width })));\r\n        return null;\r\n      })()} */}\r\n\r\n      <ImageUploader\r\n        pendingImages={newTrade.pending_images}\r\n        uploadedImages={newTrade.uploaded_images}\r\n        editingTrade={editingTrade !== null}\r\n        onImageUpload={onImageUpload}\r\n        onImageCaptionChange={onImageCaptionChange}\r\n        onImageRemove={onImageRemove}\r\n        onImagesReordered={onImagesReordered}\r\n      />\r\n\r\n      <FormField>\r\n        <RichTextEditor\r\n          label=\"Notes\"\r\n          value={newTrade.notes}\r\n          onChange={onNotesChange}\r\n          placeholder=\"Add notes for this trade...\"\r\n          minHeight={150}\r\n          maxHeight={400}\r\n          maxLength={1024}\r\n          toolbarVariant=\"sticky\"\r\n          stickyPosition=\"bottom\"\r\n          calendarId={calendarId}\r\n          trades={trades}\r\n          onOpenGalleryMode={onOpenGalleryMode}\r\n        />\r\n      </FormField>\r\n\r\n      <Box sx={{ display: 'flex', justifyContent: 'flex-end', mt: 2, gap: 1 }}>\r\n        <button\r\n          type=\"submit\"\r\n          style={{ display: 'none' }}\r\n          disabled={isSubmitting}\r\n        />\r\n      </Box>\r\n    </form>\r\n  );\r\n};\r\n\r\nexport default TradeForm;\r\n","import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { Box, IconButton, TextField, CircularProgress, Typography, keyframes } from '@mui/material';\r\nimport { Delete as DeleteIcon } from '@mui/icons-material';\r\nimport { alpha, useTheme } from '@mui/material/styles';\r\nimport { PendingImage, TradeImage } from './TradeForm'; // Assuming these are defined elsewhere\r\nimport { logger } from '../../utils/logger';\r\n\r\n// Extended TradeImage interface with grid positioning properties\r\nexport interface GridImage extends TradeImage {\r\n  id: string; // Ensure ID is present\r\n  url: string;\r\n  caption?: string;\r\n  width?: number;\r\n  height?: number;\r\n  row?: number;\r\n  column?: number;\r\n  column_width?: number; // Width as percentage (0-100)\r\n}\r\n\r\n// Extended PendingImage interface with grid positioning properties\r\nexport interface GridPendingImage extends Partial<PendingImage> {\r\n  id: string; // Ensure ID is present\r\n  file?: File;\r\n  preview?: string;\r\n  caption?: string;\r\n  width?: number;\r\n  height?: number;\r\n  row?: number;\r\n  column?: number;\r\n  column_width?: number; // Width as percentage (0-100)\r\n}\r\n\r\ninterface ImageGridProps {\r\n  pendingImages: Array<PendingImage>;\r\n  uploadedImages: Array<TradeImage>;\r\n  editingTrade: boolean; // This prop seems unused in the provided snippet, but kept it\r\n  onImageCaptionChange: (index: number, caption: string, isPending: boolean) => void;\r\n  onImageRemove: (index: number, isPending: boolean) => void;\r\n  onImagesReordered?: (images: Array<GridImage | GridPendingImage>) => void; // Re-using this for layout changes\r\n}\r\n\r\n// --- Default values ---\r\nconst DEFAULT_COL_WIDTH = 100;\r\nconst MIN_COL_WIDTH_PERCENT = 10; // Minimum width for a column\r\n\r\n// Helper function to organize images into rows\r\nconst organizeImagesIntoRows = (\r\n  pendingImages: Array<PendingImage>,\r\n  uploadedImages: Array<TradeImage>\r\n): Array<Array<GridImage | GridPendingImage>> => {\r\n  logger.log(\"Input to organizeImagesIntoRows:\",\r\n    \"Pending:\", pendingImages.map(img => ({ id: img.id, row: img.row, column: img.column, columnWidth: img.column_width })),\r\n    \"Uploaded:\", uploadedImages.map(img => ({ id: img.id, row: img.row, column: img.column, columnWidth: img.column_width })));\r\n\r\n  // Combine and ensure basic grid properties exist\r\n  const allImages: Array<GridImage | GridPendingImage> = [\r\n    ...pendingImages.map((img, i) => {\r\n      const result = {\r\n        ...img,\r\n        id: img.id ?? `pending-${i}`, // Ensure ID is present\r\n        isPending: true, // Add flag for easier type checking later\r\n        row: img.row !== undefined ? img.row : undefined,\r\n        column: img.column !== undefined ? img.column : undefined,\r\n        columnWidth: img.column_width !== undefined ? img.column_width : undefined,\r\n      };\r\n      logger.log(`Processed pending image ${i}:`, result.id, result.row, result.column, result.column_width);\r\n      return result;\r\n    }),\r\n    ...uploadedImages.map((img, i) => {\r\n      const result = {\r\n        ...img,\r\n        id: img.id ?? `uploaded-${i}`, // Ensure ID is present\r\n        isPending: false,\r\n        row: img.row !== undefined ? img.row : undefined,\r\n        column: img.column !== undefined ? img.column : undefined,\r\n        columnWidth: img.column_width !== undefined ? img.column_width : undefined,\r\n      };\r\n      logger.log(`Processed uploaded image ${i}:`, result.id, result.row, result.column, result.column_width);\r\n      return result;\r\n    }),\r\n  ];\r\n\r\n  // Group by row, handling undefined rows\r\n  const rowMap: { [key: number]: Array<GridImage | GridPendingImage> } = {};\r\n  let maxDefinedRow = -1;\r\n  allImages.forEach((image) => {\r\n    if (image.row !== undefined) {\r\n      if (!rowMap[image.row]) {\r\n        rowMap[image.row] = [];\r\n      }\r\n      rowMap[image.row].push(image);\r\n      maxDefinedRow = Math.max(maxDefinedRow, image.row);\r\n    }\r\n  });\r\n\r\n  // Place images with undefined rows into a vertical layout (one per row)\r\n  let nextRowIndex = maxDefinedRow + 1;\r\n\r\n  // Filter images with undefined rows\r\n  const unassignedImages = allImages.filter(image => image.row === undefined);\r\n\r\n  // Assign rows and columns to unassigned images - always in vertical layout\r\n  unassignedImages.forEach((image, index) => {\r\n    // Each image gets its own row in vertical layout\r\n    const newRow = nextRowIndex + index;\r\n\r\n    // Assign row and column\r\n    image.row = newRow;\r\n    image.column = 0; // Always place in first column\r\n    image.column_width = 100; // Full width for vertical layout\r\n\r\n    // Add to row map\r\n    if (!rowMap[image.row]) {\r\n      rowMap[image.row] = [];\r\n    }\r\n    rowMap[image.row].push(image);\r\n  });\r\n\r\n   // Convert map to array and sort rows by index\r\n   const rows: Array<Array<GridImage | GridPendingImage>> = Object.entries(rowMap)\r\n   .sort(([a], [b]) => Number(a) - Number(b))\r\n   .map(([rowIndex, images]) => {\r\n     logger.log(`Processing row ${rowIndex} with ${images.length} images`);\r\n     return images;\r\n   });\r\n\r\n  // Sort images within each row by column, assign defaults if needed\r\n  rows.forEach((row, rIndex) => {\r\n     // Assign row index if somehow missing (shouldn't happen with above logic)\r\n     row.forEach(img => img.row = rIndex);\r\n\r\n     // Sort by column, putting undefined columns last\r\n     row.sort((a, b) => {\r\n       const colA = a.column ?? Infinity;\r\n       const colB = b.column ?? Infinity;\r\n       return colA - colB;\r\n     });\r\n\r\n     // Assign column index and default width if needed\r\n     let totalDefinedWidth = 0;\r\n     let undefinedWidthCount = 0;\r\n     row.forEach((image, cIndex) => {\r\n       image.column = cIndex; // Ensure column indices are sequential\r\n       if (image.column_width === undefined) {\r\n         undefinedWidthCount++;\r\n       } else {\r\n         totalDefinedWidth += image.column_width;\r\n       }\r\n     });\r\n\r\n     // Distribute remaining width among columns that didn't have it defined\r\n     if (undefinedWidthCount > 0) {\r\n       const remainingWidth = Math.max(0, 100 - totalDefinedWidth);\r\n       const widthPerUndefined = remainingWidth / undefinedWidthCount;\r\n       row.forEach((image) => {\r\n         if (image.column_width === undefined) {\r\n           image.column_width = widthPerUndefined;\r\n         }\r\n       });\r\n     } else if (row.length > 0 && Math.abs(totalDefinedWidth - 100) > 0.1) {\r\n        // Adjust existing widths proportionally if they don't add up to 100\r\n        const scaleFactor = 100 / totalDefinedWidth;\r\n        row.forEach(image => {\r\n            image.column_width = (image.column_width ?? 0) * scaleFactor;\r\n        });\r\n     } else if (row.length > 0 && totalDefinedWidth === 0) {\r\n        // If all widths were 0 somehow, distribute equally\r\n        const equalWidth = 100 / row.length;\r\n         row.forEach(image => {\r\n            image.column_width = equalWidth;\r\n        });\r\n     }\r\n  });\r\n\r\n  // Remove empty rows just in case\r\n  const finalRows = rows.filter((row) => row && row.length > 0);\r\n\r\n  // Log the final organized rows\r\n  logger.log(\"Final organized rows:\", finalRows.map((row, i) =>\r\n    `Row ${i}: ` + row.map(img => `(id: ${img.id}, col: ${img.column}, width: ${img.column_width}%)`).join(', ')\r\n  ));\r\n\r\n  return finalRows;\r\n};\r\n\r\n\r\nconst ImageGrid: React.FC<ImageGridProps> = ({\r\n  pendingImages,\r\n  uploadedImages,\r\n  editingTrade, // Used to determine if we should show shimmer for pending images\r\n  onImageCaptionChange,\r\n  onImageRemove,\r\n  onImagesReordered,\r\n}) => {\r\n  const theme = useTheme();\r\n  const [rows, setRows] = useState<Array<Array<GridImage | GridPendingImage>>>([]);\r\n  const [draggingImage, setDraggingImage] = useState<GridImage | GridPendingImage | null>(null);\r\n  const [dragOverRow, setDragOverRow] = useState<number | null>(null);\r\n  const [dragOverColumn, setDragOverColumn] = useState<number | null>(null);\r\n  // dragDirection state removed as it's no longer needed\r\n\r\n  // --- Resizing State ---\r\n  const [resizingState, setResizingState] = useState<{\r\n    rowIndex: number;\r\n    dividerIndex: number; // Index of the divider (0 means between col 0 and 1)\r\n    startX: number;\r\n    rowElementWidth: number;\r\n    initialWidths: number[]; // Initial widths of all items in the row\r\n  } | null>(null);\r\n  const gridContainerRef = useRef<HTMLDivElement>(null); // Ref for the main container\r\n  const dragImageRef = useRef<HTMLElement | null>(null); // Ref to track drag image for cleanup\r\n\r\n\r\n  // Organize images into rows when inputs change\r\n  useEffect(() => {\r\n    const newRows = organizeImagesIntoRows(pendingImages, uploadedImages);\r\n    // Debug the layout information\r\n    logger.log(\"Organizing images with layout info:\",\r\n      pendingImages.map(img => ({ id: img.id, row: img.row, column: img.column, columnWidth: img.column_width })),\r\n      uploadedImages.map(img => ({ id: img.id, row: img.row, column: img.column, columnWidth: img.column_width })));\r\n    // logger.log(\"Organized Rows:\", JSON.stringify(newRows, null, 2)); // Debugging\r\n    setRows(newRows);\r\n  }, [pendingImages, uploadedImages]);\r\n\r\n  // Helper to check if an image is PendingImage (using the flag added in organize)\r\n  const isPendingImage = (image: GridImage | GridPendingImage): boolean => {\r\n    // Check based on the structure or the added flag\r\n    return 'isPending' in image ? !!(image as any).isPending : 'file' in image;\r\n  };\r\n\r\n  // Helper to check if any image is currently uploading (pending images are still being uploaded)\r\n  const isAnyImageUploading = (): boolean => {\r\n    return pendingImages.length > 0;\r\n  };\r\n\r\n  // --- Drag and Drop (Reordering) Handlers ---\r\n  const handleDragStart = (\r\n    e: React.DragEvent<HTMLDivElement>,\r\n    image: GridImage | GridPendingImage,\r\n    rowIndex: number,\r\n    columnIndex: number\r\n  ) => {\r\n    // Prevent initiating drag if resize is active or any image is uploading\r\n    if (resizingState || isAnyImageUploading()) {\r\n      e.preventDefault();\r\n      return;\r\n    }\r\n    setDraggingImage(image);\r\n    // logger.log(\"Drag Start:\", image.id, `Row: ${rowIndex}`, `Col: ${columnIndex}`); // Debug\r\n    e.dataTransfer.setData('text/plain', JSON.stringify({\r\n      id: image.id, // Use image id for identification\r\n      isPending: isPendingImage(image),\r\n      sourceRowIndex: rowIndex,\r\n      sourceColumnIndex: columnIndex\r\n    }));\r\n    e.dataTransfer.effectAllowed = \"move\";\r\n\r\n    // Custom drag image with improved cleanup\r\n    const element = e.currentTarget;\r\n    const rect = element.getBoundingClientRect();\r\n    const offsetX = e.clientX - rect.left;\r\n    const offsetY = e.clientY - rect.top;\r\n    const dragImage = element.cloneNode(true) as HTMLElement;\r\n\r\n    // Apply styles to cloned drag image\r\n    dragImage.style.width = `${rect.width}px`;\r\n    dragImage.style.height = `${rect.height}px`;\r\n    dragImage.style.opacity = '0.7';\r\n    dragImage.style.position = 'absolute';\r\n    dragImage.style.top = '-1000px';\r\n    dragImage.style.left = '-1000px';\r\n    dragImage.style.pointerEvents = 'none';\r\n    dragImage.style.zIndex = '1000';\r\n\r\n    // Store reference for reliable cleanup\r\n    dragImageRef.current = dragImage;\r\n    document.body.appendChild(dragImage);\r\n    e.dataTransfer.setDragImage(dragImage, offsetX, offsetY);\r\n\r\n    // Use a longer timeout for more reliable cleanup\r\n    setTimeout(() => {\r\n        cleanupDragImage();\r\n    }, 100);\r\n  };\r\n\r\n  const handleDragOver = (\r\n    e: React.DragEvent<HTMLDivElement>,\r\n    rowIndex: number,\r\n    columnIndex: number | null // Allow null for dropping on row container\r\n  ) => {\r\n    e.preventDefault(); // Necessary to allow drop\r\n    e.dataTransfer.dropEffect = \"move\";\r\n    if (draggingImage) {\r\n      // Update target position for visual feedback\r\n      setDragOverRow(rowIndex);\r\n      // If columnIndex is null, it means hovering over row gap, target first column\r\n      setDragOverColumn(columnIndex ?? 0);\r\n    }\r\n  };\r\n\r\n  const handleDrop = (\r\n    e: React.DragEvent<HTMLDivElement>,\r\n    targetRowIndex: number,\r\n    targetColumnIndex: number | null // Null indicates dropping on row or new row area\r\n  ) => {\r\n    e.preventDefault();\r\n    e.stopPropagation(); // Prevent drop event from bubbling up if needed\r\n\r\n    if (!draggingImage) return;\r\n\r\n    const sourceData = JSON.parse(e.dataTransfer.getData('text/plain'));\r\n    const sourceRowIndex = sourceData.sourceRowIndex;\r\n    const sourceColumnIndex = sourceData.sourceColumnIndex;\r\n    const imageId = sourceData.id;\r\n    const isSourcePending = sourceData.isPending;\r\n\r\n    // Find the image being dragged using its ID and type\r\n    let imageToMove: GridImage | GridPendingImage | undefined;\r\n    let foundAtIndex: number | undefined;\r\n\r\n    const sourceCollection = isSourcePending ? pendingImages : uploadedImages;\r\n    foundAtIndex = sourceCollection.findIndex(img => img.id === imageId);\r\n\r\n    if (foundAtIndex === -1) {\r\n        logger.error(\"Could not find dragged image in original collection!\");\r\n        handleDragEnd(); // Reset state\r\n        return;\r\n    }\r\n    // Get the actual image object from the original props/state before modification\r\n    imageToMove = rows[sourceRowIndex]?.[sourceColumnIndex];\r\n\r\n     if (!imageToMove) {\r\n        logger.error(\"Inconsistency: Dragged image not found in current rows state at source index\");\r\n         // Fallback: Try finding by ID in flattened rows\r\n        const flatImages = rows.flat();\r\n        imageToMove = flatImages.find(img => img.id === imageId && isPendingImage(img) === isSourcePending);\r\n        if (!imageToMove) {\r\n            logger.error(\"Could not find dragged image anywhere!\");\r\n            handleDragEnd();\r\n            return;\r\n        }\r\n        // If found via fallback, we might not know the exact sourceRow/Col index *relative to current state*\r\n        // This indicates a potential logic issue elsewhere, but we can try to proceed\r\n        logger.warn(\"Found image via fallback, drag/drop might be slightly off.\");\r\n    }\r\n\r\n\r\n    // --- Apply the move ---\r\n    let newRows = rows.map(row => [...row]); // Deep copy rows\r\n\r\n    // 1. Remove image from its original position\r\n    let actualSourceRowIndex = -1;\r\n    let actualSourceColumnIndex = -1;\r\n     for(let r=0; r < newRows.length; r++) {\r\n         const cIndex = newRows[r].findIndex(img => img.id === imageToMove!.id && isPendingImage(img) === isPendingImage(imageToMove!));\r\n         if (cIndex !== -1) {\r\n             actualSourceRowIndex = r;\r\n             actualSourceColumnIndex = cIndex;\r\n             break;\r\n         }\r\n     }\r\n\r\n    if (actualSourceRowIndex === -1) {\r\n        logger.error(\"Cannot find image to remove during drop!\");\r\n        handleDragEnd();\r\n        return;\r\n    }\r\n\r\n    newRows[actualSourceRowIndex].splice(actualSourceColumnIndex, 1);\r\n\r\n\r\n    // 2. Determine target position\r\n    let finalTargetRowIndex = targetRowIndex;\r\n    let finalTargetColumnIndex = targetColumnIndex ?? 0; // Default to start if null\r\n\r\n     // Check if dropping onto the \"new row\" area\r\n    if (targetRowIndex === newRows.filter(r => r.length > 0).length && targetColumnIndex === null) {\r\n        finalTargetRowIndex = newRows.length; // Target the next available row index\r\n        finalTargetColumnIndex = 0;\r\n    } else if (targetColumnIndex === null) {\r\n         // Dropping between rows or on row padding? Target start of the row.\r\n        finalTargetColumnIndex = 0;\r\n    }\r\n\r\n    // 3. Insert image at the target position\r\n    // Ensure target row exists\r\n    while (newRows.length <= finalTargetRowIndex) {\r\n        newRows.push([]);\r\n    }\r\n\r\n    // Insert the image\r\n    newRows[finalTargetRowIndex].splice(finalTargetColumnIndex, 0, imageToMove);\r\n\r\n    // --- Recalculate Layout Properties ---\r\n    newRows = newRows.filter(row => row.length > 0); // Remove empty rows\r\n\r\n    newRows.forEach((row, rIndex) => {\r\n        const widthPerColumn = 100 / row.length; // Equal width distribution after move\r\n        row.forEach((img, cIndex) => {\r\n            img.row = rIndex;\r\n            img.column = cIndex;\r\n            // Reset width only if it changed row or if the row now has only one image\r\n            if (img.id === imageToMove!.id || row.length === 1 || actualSourceRowIndex !== rIndex) {\r\n               img.column_width = widthPerColumn;\r\n            }\r\n             // Ensure existing images in the target row also get widths adjusted if needed\r\n             else if (rIndex === finalTargetRowIndex && row.length > 1) {\r\n                 // This part needs refinement: Adjust widths proportionally based on *previous* widths?\r\n                 // For simplicity now, we redistribute equally in the target row upon drop.\r\n                 // A more complex approach would try to maintain relative proportions.\r\n                 img.column_width = widthPerColumn;\r\n             }\r\n             // Adjust widths in the source row if it wasn't emptied\r\n             else if (rIndex === actualSourceRowIndex && newRows[rIndex]?.length > 0) {\r\n                 const sourceRowWidth = 100 / newRows[rIndex].length;\r\n                 img.column_width = sourceRowWidth;\r\n             }\r\n\r\n             // Fallback safety check for width\r\n             if (img.column_width === undefined || img.column_width === null || isNaN(img.column_width) || img.column_width <=0) {\r\n                 img.column_width = 100 / row.length;\r\n             }\r\n        });\r\n         // Re-normalize widths for the row to ensure they sum to 100%\r\n         const currentRowTotalWidth = row.reduce((sum, img) => sum + (img.column_width || 0), 0);\r\n         if (currentRowTotalWidth > 0 && Math.abs(currentRowTotalWidth - 100) > 0.1) {\r\n             const scale = 100 / currentRowTotalWidth;\r\n             row.forEach(img => img.column_width = (img.column_width || 0) * scale);\r\n         } else if (currentRowTotalWidth === 0 && row.length > 0) {\r\n              const equalWidth = 100 / row.length;\r\n              row.forEach(img => img.column_width = equalWidth);\r\n         }\r\n    });\r\n\r\n\r\n    // Update state and notify parent\r\n    setRows(newRows);\r\n    if (onImagesReordered) {\r\n      const allImages = newRows.flat();\r\n      onImagesReordered(allImages);\r\n    }\r\n\r\n    // Reset drag state\r\n    handleDragEnd();\r\n  };\r\n\r\n  // Helper function to clean up drag image\r\n  const cleanupDragImage = () => {\r\n    if (dragImageRef.current && document.body.contains(dragImageRef.current)) {\r\n      document.body.removeChild(dragImageRef.current);\r\n    }\r\n    dragImageRef.current = null;\r\n  };\r\n\r\n  const handleDragEnd = () => {\r\n    setDraggingImage(null);\r\n    setDragOverRow(null);\r\n    setDragOverColumn(null);\r\n    // Clean up any lingering drag image\r\n    cleanupDragImage();\r\n  };\r\n\r\n  // --- Resizing Handlers ---\r\n  const handleResizeMouseDown = (\r\n      e: React.MouseEvent<HTMLDivElement>,\r\n      rowIndex: number,\r\n      dividerIndex: number // Index of the divider (between col dividerIndex and dividerIndex + 1)\r\n  ) => {\r\n      e.preventDefault();\r\n      e.stopPropagation(); // Prevent drag-start on the image behind\r\n\r\n      // Prevent resizing if any image is uploading\r\n      if (isAnyImageUploading()) {\r\n        return;\r\n      }\r\n\r\n      const rowElement = (e.target as HTMLElement).closest('.image-row-container');\r\n      if (!rowElement) return;\r\n\r\n      const rowElementWidth = rowElement.getBoundingClientRect().width;\r\n      if (rowElementWidth <= 0) return; // Avoid division by zero\r\n\r\n      // Store initial state for resizing calculation\r\n      setResizingState({\r\n          rowIndex,\r\n          dividerIndex,\r\n          startX: e.clientX,\r\n          rowElementWidth,\r\n          initialWidths: rows[rowIndex].map(img => img.column_width || 0), // Store initial widths of the row\r\n      });\r\n  };\r\n\r\n  // Helper function to normalize column widths in a row\r\n  const normalizeRowWidths = useCallback((row: Array<GridImage | GridPendingImage>, minWidth = MIN_COL_WIDTH_PERCENT) => {\r\n    if (!row || row.length === 0) return row;\r\n\r\n    // Calculate total width\r\n    const totalWidth = row.reduce((sum, img) => sum + (img.column_width || 0), 0);\r\n\r\n    // If total is already close to 100%, no need to normalize\r\n    if (Math.abs(totalWidth - 100) < 0.1) return row;\r\n\r\n    // If total is 0, distribute equally\r\n    if (totalWidth === 0) {\r\n      const equalWidth = 100 / row.length;\r\n      row.forEach(img => img.column_width = equalWidth);\r\n      return row;\r\n    }\r\n\r\n    // Scale all widths proportionally\r\n    const scaleFactor = 100 / totalWidth;\r\n    row.forEach(img => {\r\n      img.column_width = (img.column_width || 0) * scaleFactor;\r\n      // Ensure minimum width\r\n      img.column_width = Math.max(minWidth, img.column_width);\r\n    });\r\n\r\n    // Final check - if we're still not at 100% due to min width constraints,\r\n    // adjust the largest column to compensate\r\n    const newTotal = row.reduce((sum, img) => sum + (img.column_width || 0), 0);\r\n    if (Math.abs(newTotal - 100) > 0.1) {\r\n      // Find the largest column\r\n      const largestColIndex = row.reduce(\r\n        (maxIndex, img, index, arr) =>\r\n          (img.column_width || 0) > (arr[maxIndex].column_width || 0) ? index : maxIndex,\r\n        0\r\n      );\r\n      // Adjust it to make the total 100%\r\n      row[largestColIndex].column_width = (row[largestColIndex].column_width || 0) - (newTotal - 100);\r\n    }\r\n\r\n    return row;\r\n  }, []);\r\n\r\n  // Use useCallback for handlers used in effects to prevent unnecessary re-renders/listener attachments\r\n  const handleResizeMouseMove = useCallback((e: MouseEvent) => {\r\n    if (!resizingState) return;\r\n\r\n    const { rowIndex, dividerIndex, startX, rowElementWidth, initialWidths } = resizingState;\r\n\r\n    const currentX = e.clientX;\r\n    const deltaX = currentX - startX;\r\n    const deltaPercent = (deltaX / rowElementWidth) * 100;\r\n\r\n    // Create a deep copy of the rows for modification\r\n    const newRows = [...rows.map(row => [...row.map(img => ({ ...img }))])];\r\n    const targetRow = newRows[rowIndex];\r\n\r\n    // Calculate total initial width left and right of the divider\r\n    let totalInitialLeftWidth = 0;\r\n    for (let i = 0; i <= dividerIndex; i++) {\r\n      totalInitialLeftWidth += initialWidths[i];\r\n    }\r\n    let totalInitialRightWidth = 0;\r\n    for (let i = dividerIndex + 1; i < initialWidths.length; i++) {\r\n      totalInitialRightWidth += initialWidths[i];\r\n    }\r\n\r\n    // Calculate the new target total widths for left/right sections\r\n    let newTotalLeftWidth = totalInitialLeftWidth + deltaPercent;\r\n    let newTotalRightWidth = totalInitialRightWidth - deltaPercent;\r\n\r\n    // Apply minimum width constraints\r\n    const numLeftImages = dividerIndex + 1;\r\n    const numRightImages = initialWidths.length - numLeftImages;\r\n    const minTotalLeftWidth = numLeftImages * MIN_COL_WIDTH_PERCENT;\r\n    const minTotalRightWidth = numRightImages * MIN_COL_WIDTH_PERCENT;\r\n\r\n    // Clamp totals\r\n    newTotalLeftWidth = Math.max(minTotalLeftWidth, newTotalLeftWidth);\r\n    newTotalRightWidth = Math.max(minTotalRightWidth, newTotalRightWidth);\r\n\r\n    // Ensure the sum is still 100% after clamping\r\n    const currentTotal = newTotalLeftWidth + newTotalRightWidth;\r\n    if (Math.abs(currentTotal - 100) > 0.1) {\r\n      const scaleFactor = 100 / currentTotal;\r\n      newTotalLeftWidth *= scaleFactor;\r\n      newTotalRightWidth *= scaleFactor;\r\n\r\n      // Re-check min width constraints after scaling\r\n      newTotalLeftWidth = Math.max(minTotalLeftWidth, newTotalLeftWidth);\r\n      newTotalRightWidth = Math.max(minTotalRightWidth, newTotalRightWidth);\r\n\r\n      // If one side hit min, give remainder to the other\r\n      if (newTotalLeftWidth === minTotalLeftWidth) {\r\n        newTotalRightWidth = 100 - newTotalLeftWidth;\r\n      } else if (newTotalRightWidth === minTotalRightWidth) {\r\n        newTotalLeftWidth = 100 - newTotalRightWidth;\r\n      }\r\n    }\r\n\r\n    // Distribute new total widths proportionally\r\n    // Left side\r\n    for (let i = 0; i <= dividerIndex; i++) {\r\n      let newWidth = 0;\r\n      if (totalInitialLeftWidth > 0) {\r\n        const proportion = initialWidths[i] / totalInitialLeftWidth;\r\n        newWidth = newTotalLeftWidth * proportion;\r\n      } else {\r\n        newWidth = newTotalLeftWidth / numLeftImages;\r\n      }\r\n      targetRow[i].column_width = Math.max(MIN_COL_WIDTH_PERCENT, newWidth);\r\n    }\r\n\r\n    // Right side\r\n    for (let i = dividerIndex + 1; i < targetRow.length; i++) {\r\n      let newWidth = 0;\r\n      if (totalInitialRightWidth > 0) {\r\n        const proportion = initialWidths[i] / totalInitialRightWidth;\r\n        newWidth = newTotalRightWidth * proportion;\r\n      } else {\r\n        newWidth = newTotalRightWidth / numRightImages;\r\n      }\r\n      targetRow[i].column_width = Math.max(MIN_COL_WIDTH_PERCENT, newWidth);\r\n    }\r\n\r\n    // Final normalization to ensure total is exactly 100%\r\n    normalizeRowWidths(targetRow);\r\n\r\n    // Update the state visually during drag\r\n    setRows(newRows);\r\n  }, [resizingState, rows, normalizeRowWidths]); // Added normalizeRowWidths to dependencies\r\n\r\n  const handleResizeMouseUp = useCallback(() => {\r\n      if (!resizingState) return;\r\n\r\n      // Persist the final state\r\n      if (onImagesReordered) {\r\n           // Find the updated row state (rows state should be current from mouseMove)\r\n           const finalRowIndex = resizingState.rowIndex;\r\n           if (rows[finalRowIndex]) {\r\n                const allImages = rows.flat(); // Flatten the current state\r\n                onImagesReordered(allImages); // Send the updated layout\r\n           }\r\n      }\r\n      setResizingState(null); // End resizing\r\n  }, [resizingState, rows, onImagesReordered]); // Include rows and callback\r\n\r\n\r\n  // Effect to add/remove global listeners for resizing\r\n  useEffect(() => {\r\n      if (resizingState) {\r\n          window.addEventListener('mousemove', handleResizeMouseMove);\r\n          window.addEventListener('mouseup', handleResizeMouseUp);\r\n          // Optional: Add cursor style to body\r\n          document.body.style.cursor = 'col-resize';\r\n      } else {\r\n          window.removeEventListener('mousemove', handleResizeMouseMove);\r\n          window.removeEventListener('mouseup', handleResizeMouseUp);\r\n          // Optional: Reset cursor style\r\n          document.body.style.cursor = '';\r\n      }\r\n\r\n      // Cleanup function\r\n      return () => {\r\n          window.removeEventListener('mousemove', handleResizeMouseMove);\r\n          window.removeEventListener('mouseup', handleResizeMouseUp);\r\n          // Optional: Ensure cursor is reset if component unmounts during resize\r\n          document.body.style.cursor = '';\r\n      };\r\n  }, [resizingState, handleResizeMouseMove, handleResizeMouseUp]); // Add handlers to dependency array\r\n\r\n\r\n  return (\r\n    <Box sx={{ width: '100%' }} ref={gridContainerRef}>\r\n      {rows.map((row, rowIndex) => (\r\n        <Box\r\n          key={`row-${rowIndex}`}\r\n          className=\"image-row-container\" // Add class for easy selection\r\n          sx={{\r\n            display: 'flex',\r\n            width: '100%',\r\n            marginBottom: 3, // Use full property name to avoid conflicts\r\n            position: 'relative',\r\n            gap: 1, // Add small gap between columns (8px)\r\n            // All directional drop indicators removed\r\n          }}\r\n          // Add DragOver handler for dropping between rows (targets column 0)\r\n          onDragOver={(e) => handleDragOver(e, rowIndex, 0)}\r\n           // Add drop handler here too if needed for row-level drops (currently handled by image drop)\r\n           // onDrop={(e) => handleDrop(e, rowIndex, 0)} // Example if needed\r\n        >\r\n          {row.map((image, columnIndex) => {\r\n            const isPending = isPendingImage(image);\r\n            const pendingImg = isPending ? image as GridPendingImage : null;\r\n            const uploadedImg = !isPending ? image as GridImage : null;\r\n            const imageId = isPending ? pendingImg!.id : uploadedImg!.id;\r\n            const isLastColumn = columnIndex === row.length - 1;\r\n\r\n            return (\r\n              <React.Fragment key={`image-frag-${imageId}-${rowIndex}-${columnIndex}`}>\r\n                {/* Image Container */}\r\n                <Box\r\n                    key={`image-${imageId}-${rowIndex}-${columnIndex}`}\r\n                    sx={{\r\n                        position: 'relative',\r\n                        // Simplified width calculation - use percentage width directly\r\n                        width: `${image.column_width || DEFAULT_COL_WIDTH}%`,\r\n                        // No margin needed since we're using flex gap\r\n                        height: 'auto',\r\n                        borderRadius: 1,\r\n                        overflow: 'visible', // Allow potential overflow for captions if needed, adjust styling\r\n\r\n                        display: 'flex',\r\n                        flexDirection: 'column',\r\n                        opacity: draggingImage === image ? 0.5 : 1,\r\n                        backgroundColor: 'transparent',\r\n                        transition: 'border-color 0.2s, background-color 0.2s, opacity 0.2s, box-shadow 0.2s',\r\n                        // All directional drop indicators removed\r\n                        ...(draggingImage && dragOverRow === rowIndex && dragOverColumn === columnIndex && {\r\n                            backgroundColor: alpha(theme.palette.primary.main, 0.1),\r\n                        }),\r\n                        '&:hover .resize-handle': { // Show resize handle on hover of image container\r\n                            opacity: isAnyImageUploading() ? 0.2 : 1, // Dim resize handle during uploads\r\n                        },\r\n                        // Visual indication that dragging is disabled during uploads\r\n                        cursor: isAnyImageUploading() ? 'not-allowed' : 'grab',\r\n                        filter: isAnyImageUploading() ? 'grayscale(0.2)' : 'none',\r\n                    }}\r\n                    draggable={!isAnyImageUploading()} // Disable draggable attribute during uploads\r\n                    onDragStart={(e) => handleDragStart(e, image, rowIndex, columnIndex)}\r\n                    onDragOver={(e) => handleDragOver(e, rowIndex, columnIndex)}\r\n                    onDrop={(e) => handleDrop(e, rowIndex, columnIndex)}\r\n                    onDragEnd={handleDragEnd}\r\n                >\r\n                  {/* Image and Caption Content (mostly unchanged) */}\r\n                  <Box sx={{ overflow: 'hidden', borderRadius: '4px 4px 0 0' }}> {/* Inner box for image clipping */}\r\n                        {isPending ? (\r\n                            // Pending image structure (unchanged)\r\n                             <>\r\n                                <Box\r\n                                    sx={{\r\n                                        width: '100%',\r\n                                        height: 'auto',\r\n                                        // Only apply maxHeight when there are multiple images in a row\r\n                                        maxHeight: row.length > 1 ? 300 : 'none',\r\n                                        overflow: 'hidden',\r\n                                        position: 'relative',\r\n                                        backgroundColor: alpha(theme.palette.divider, 0.1), // Placeholder bg\r\n                                        aspectRatio: pendingImg?.width && pendingImg?.height ? `${pendingImg.width}/${pendingImg.height}` : '16/9', // Default aspect ratio\r\n                                    }}\r\n                                >\r\n                                {/* Uploading Indicator */}\r\n                                <Box sx={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: 'rgba(0, 0, 0, 0.5)', zIndex: 2 }}>\r\n                                    <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 1 }}>\r\n                                        <CircularProgress size={48} sx={{ color: 'white' }} />\r\n                                        <Typography variant=\"caption\" component=\"div\" sx={{ color: 'white', fontWeight: 'bold' }}>\r\n                                            Uploading...\r\n                                        </Typography>\r\n                                    </Box>\r\n                                </Box>\r\n                                {/* Image Preview */}\r\n                                <img\r\n                                    src={pendingImg?.preview}\r\n                                    alt=\"Pending Upload\"\r\n                                    style={{ display: 'block', width: '100%', height: '100%', objectFit: 'contain' }}\r\n                                />\r\n                                {/* Delete Button - always show, allows canceling upload */}\r\n                                <IconButton size=\"small\" onClick={() => onImageRemove(pendingImages.findIndex(img => img.id === image.id), true)}\r\n                                    sx={{ position: 'absolute', top: 4, right: 4, backgroundColor: 'rgba(0, 0, 0, 0.5)', color: 'white', zIndex: 10, '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.7)' } }}>\r\n                                    <DeleteIcon fontSize=\"small\" />\r\n                                </IconButton>\r\n                                </Box>\r\n                                {/* Caption Field - Multiline with smaller font */}\r\n                                <TextField\r\n                                    placeholder=\"Add a caption...\"\r\n                                    value={pendingImg?.caption || ''}\r\n                                    onChange={(e) => onImageCaptionChange(pendingImages.findIndex(img => img.id === image.id), e.target.value, true)}\r\n                                    variant=\"standard\"\r\n                                    multiline\r\n                                    minRows={1}\r\n                                    maxRows={20} // Large number to effectively disable scrolling\r\n                                    fullWidth\r\n                                    // Disable the field while image is uploading (pending images are always uploading)\r\n                                    disabled={true}\r\n                                    sx={{\r\n                                        px: 1,\r\n                                        py: 0.5,\r\n                                        backgroundColor: theme.palette.background.paper,\r\n                                        fontSize: '0.75rem', // Smaller font size\r\n                                        '& .MuiInput-underline:before': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInput-underline:after': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInput-underline:hover:not(.Mui-disabled):before': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInputBase-input': { fontSize: '0.75rem' }, // Ensure input text is also smaller\r\n                                        '& .MuiInputBase-root': { overflow: 'visible' }, // Prevent scrollbars\r\n                                        // Style for disabled state\r\n                                        '&.Mui-disabled': {\r\n                                            opacity: 0.7,\r\n                                            '& .MuiInputBase-input': { color: 'text.disabled' }\r\n                                        }\r\n                                    }}\r\n                                />\r\n                            </>\r\n                        ) : (\r\n                            // Uploaded image structure (unchanged)\r\n                            <>\r\n                                <Box\r\n                                    sx={{\r\n                                        width: '100%',\r\n                                        height: 'auto',\r\n                                        // Only apply maxHeight when there are multiple images in a row\r\n                                        maxHeight: row.length > 1 ? 300 : 'none',\r\n                                        overflow: 'hidden',\r\n                                        position: 'relative',\r\n                                        backgroundColor: alpha(theme.palette.divider, 0.1), // Placeholder bg\r\n                                        aspectRatio: uploadedImg?.width && uploadedImg?.height ? `${uploadedImg.width}/${uploadedImg.height}` : '16/9', // Default aspect ratio\r\n                                    }}\r\n                                >\r\n                                {/* Loading Placeholder (optional, could use skeleton) */}\r\n                                {/* <CircularProgress size={24} sx={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: 0.5, zIndex: 0 }} /> */}\r\n                                {/* Show shimmer for pending images when editing a trade */}\r\n                                {editingTrade && uploadedImg?.pending ? (\r\n                                    <ShimmerImageBox image={uploadedImg} theme={theme} />\r\n                                ) : (\r\n                                    /* Actual Image */\r\n                                    <img\r\n                                        src={uploadedImg?.url}\r\n                                        alt={uploadedImg?.caption || \"Uploaded image\"}\r\n                                        style={{ display: 'block', width: '100%', height: '100%', objectFit: 'contain', position: 'relative', zIndex: 1 }}\r\n                                        // onLoad/onError handlers could be added here\r\n                                    />\r\n                                )}\r\n                                 {/* Delete Button */}\r\n                                <IconButton size=\"small\" onClick={() => onImageRemove(uploadedImages.findIndex(img => img.id === image.id), false)}\r\n                                    sx={{ position: 'absolute', top: 4, right: 4, backgroundColor: 'rgba(0, 0, 0, 0.5)', color: 'white', zIndex: 10, '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.7)'} }}>\r\n                                    <DeleteIcon fontSize=\"small\" />\r\n                                </IconButton>\r\n                                </Box>\r\n                                {/* Caption Field - Multiline with smaller font */}\r\n                                <TextField\r\n                                    placeholder=\"Add a caption...\"\r\n                                    value={uploadedImg?.caption || ''}\r\n                                    onChange={(e) => onImageCaptionChange(uploadedImages.findIndex(img => img.id === image.id), e.target.value, false)}\r\n                                    variant=\"standard\"\r\n                                    multiline\r\n                                    minRows={1}\r\n                                    maxRows={20} // Large number to effectively disable scrolling\r\n                                    fullWidth\r\n                                    // Disable the field when any image is uploading\r\n                                    disabled={isAnyImageUploading() || (uploadedImg?.pending === true)}\r\n                                    sx={{\r\n                                        px: 1,\r\n                                        py: 0.5,\r\n                                        backgroundColor: theme.palette.background.paper,\r\n                                        fontSize: '0.75rem', // Smaller font size\r\n                                        '& .MuiInput-underline:before': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInput-underline:after': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInput-underline:hover:not(.Mui-disabled):before': { borderBottomColor: 'transparent' },\r\n                                        '& .MuiInputBase-input': { fontSize: '0.75rem' }, // Ensure input text is also smaller\r\n                                        '& .MuiInputBase-root': { overflow: 'visible' }, // Prevent scrollbars\r\n                                        // Style for disabled state\r\n                                        '&.Mui-disabled': {\r\n                                            opacity: 0.7,\r\n                                            '& .MuiInputBase-input': { color: 'text.disabled' }\r\n                                        }\r\n                                    }}\r\n                                />\r\n                            </>\r\n                        )}\r\n                  </Box> {/* End inner box for image clipping */}\r\n\r\n                </Box>\r\n\r\n                {/* Resize Handle (Divider) - Render between images */}\r\n                {!isLastColumn && row.length > 1 && (\r\n                  <Box\r\n                    className=\"resize-handle\"\r\n                    sx={{\r\n                      width: '8px', // Wider clickable area\r\n                      position: 'relative', // Position relative to the flex flow\r\n                      cursor: isAnyImageUploading() ? 'not-allowed' : 'col-resize',\r\n                      display: 'flex',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      flexShrink: 0, // Don't allow the handle itself to shrink\r\n                      zIndex: 10, // Higher z-index to ensure it's above images\r\n                      // Visual divider line\r\n                      '&::before': {\r\n                        content: '\"\"',\r\n                        position: 'absolute',\r\n                        top: '5%', // Extend more of the height\r\n                        bottom: '5%',\r\n                        left: '3px', // Center the visual line within the 8px handle\r\n                        width: '2px',\r\n                        backgroundColor: resizingState && resizingState.rowIndex === rowIndex && resizingState.dividerIndex === columnIndex\r\n                          ? theme.palette.primary.main // Highlight when dragging this handle\r\n                          : isAnyImageUploading()\r\n                            ? alpha(theme.palette.divider, 0.4) // Dimmed when uploads in progress\r\n                            : alpha(theme.palette.divider, 0.8), // Normal color\r\n                        // Initially invisible, only visible on hover or when resizing\r\n                        opacity: resizingState && resizingState.rowIndex === rowIndex && resizingState.dividerIndex === columnIndex ? 1 : 0,\r\n                        transition: 'opacity 0.2s, background-color 0.2s, width 0.2s',\r\n                      },\r\n                      // Hover effect - make visible when hovered\r\n                      '&:hover::before': {\r\n                        opacity: isAnyImageUploading() ? 0.3 : 1,\r\n                        width: isAnyImageUploading() ? '2px' : '3px',\r\n                        backgroundColor: isAnyImageUploading()\r\n                          ? alpha(theme.palette.divider, 0.4)\r\n                          : theme.palette.primary.light,\r\n                      },\r\n                      // Active state during resize\r\n                      ...(resizingState && resizingState.rowIndex === rowIndex && resizingState.dividerIndex === columnIndex && {\r\n                        '&::before': {\r\n                          opacity: 1,\r\n                          width: '3px',\r\n                          backgroundColor: theme.palette.primary.main,\r\n                        }\r\n                      }),\r\n                    }}\r\n                    onMouseDown={(e) => handleResizeMouseDown(e, rowIndex, columnIndex)}\r\n                  />\r\n                )}\r\n              </React.Fragment>\r\n            );\r\n          })}\r\n        </Box>\r\n      ))}\r\n\r\n      {/* Drop area for creating a new row at the end */}\r\n      {draggingImage && !isAnyImageUploading() && (\r\n        <Box\r\n          sx={{\r\n            width: '100%',\r\n            height: 80,\r\n            border: `2px dashed ${dragOverRow === rows.length && dragOverColumn === 0 ? theme.palette.primary.main : alpha(theme.palette.divider, 0.5)}`,\r\n            borderRadius: 1,\r\n            display: 'flex',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            backgroundColor: dragOverRow === rows.length && dragOverColumn === 0 ? alpha(theme.palette.primary.main, 0.1) : 'transparent',\r\n            color: theme.palette.text.secondary,\r\n            transition: 'all 0.2s ease-in-out',\r\n            marginBottom: 2,\r\n            position: 'relative',\r\n            // Visual feedback when dragging over with New Row label\r\n            ...(dragOverRow === rows.length && dragOverColumn === 0 && {\r\n              backgroundColor: alpha(theme.palette.primary.main, 0.1),\r\n              border: `2px solid ${theme.palette.primary.main}`,\r\n              '&::after': {\r\n                content: '\"New Row\"',\r\n                position: 'absolute',\r\n                top: '-10px',\r\n                right: '10px',\r\n                backgroundColor: theme.palette.primary.main,\r\n                color: theme.palette.primary.contrastText,\r\n                padding: '2px 8px',\r\n                borderRadius: '4px',\r\n                fontSize: '0.7rem',\r\n                fontWeight: 'bold',\r\n                zIndex: 10,\r\n                boxShadow: `0 2px 4px ${alpha(theme.palette.common.black, 0.2)}`\r\n              }\r\n            })\r\n          }}\r\n          onDragOver={(e) => handleDragOver(e, rows.length, 0)} // Target next row index, column 0\r\n          onDragLeave={() => { /* Reset specific visual state if needed */ }}\r\n          onDrop={(e) => handleDrop(e, rows.length, null)} // Use null for columnIndex to indicate new row area\r\n        >\r\n          Drop here to create a new row\r\n        </Box>\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\n// ShimmerImageBox component for displaying a shimmer effect during image upload\r\nconst ShimmerImageBox: React.FC<{\r\n  image: GridImage;\r\n  theme: any; // Theme is used inside the background function\r\n}> = ({ image, theme }) => {\r\n  // Define shimmer animation\r\n  const shimmer = keyframes`\r\n    0% {\r\n      background-position: -200% 0;\r\n    }\r\n    100% {\r\n      background-position: 200% 0;\r\n    }\r\n  `;\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        width: '100%',\r\n        height: 'auto',\r\n        maxHeight: 300,\r\n        overflow: 'hidden',\r\n        position: 'relative',\r\n        ...(image.width && image.height ? {\r\n          paddingTop: `${(image.height / image.width) * 100}%`\r\n        } : {})\r\n      }}\r\n    >\r\n      <Box\r\n        sx={{\r\n          position: 'absolute',\r\n          top: 0,\r\n          left: 0,\r\n          width: '100%',\r\n          height: '100%',\r\n          background: () => {\r\n            // Use slightly more pronounced colors for better visibility\r\n            const baseColor = theme.palette.mode === 'dark' ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.04)';\r\n            const shimmerColor = theme.palette.mode === 'dark' ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.1)';\r\n            return `linear-gradient(90deg, ${baseColor} 25%, ${shimmerColor} 50%, ${baseColor} 75%)`;\r\n          },\r\n          backgroundSize: '200% 100%',\r\n          animation: `${shimmer} 1.5s infinite linear`,\r\n          willChange: 'background-position', // Optimize animation performance\r\n          display: 'flex',\r\n          alignItems: 'center',\r\n          justifyContent: 'center',\r\n          zIndex: 1\r\n        }}\r\n      >\r\n        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 1 }}>\r\n          <CircularProgress size={24} color=\"primary\" />\r\n          <Typography variant=\"caption\" sx={{ color: 'text.secondary', fontWeight: 500 }}>\r\n            Uploading...\r\n          </Typography>\r\n        </Box>\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default ImageGrid;\r\n","import React, { useRef, useEffect, useState } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  Button,\r\n  IconButton,\r\n  Tooltip\r\n} from '@mui/material';\r\nimport { AddPhotoAlternate, ViewList, GridView } from '@mui/icons-material';\r\n\r\nimport { PendingImage, TradeImage } from './TradeForm';\r\nimport ImageGrid, { GridImage, GridPendingImage } from './ImageGrid';\r\n\r\ninterface ImageUploaderProps {\r\n  pendingImages: Array<PendingImage>;\r\n  uploadedImages: Array<TradeImage>;\r\n  editingTrade: boolean\r\n  onImageUpload: (files: FileList) => void;\r\n  onImageCaptionChange: (index: number, caption: string, isPending: boolean) => void;\r\n  onImageRemove: (index: number, isPending: boolean) => void;\r\n  onImagesReordered?: (images: Array<GridImage | GridPendingImage>) => void;\r\n}\r\n\r\n\r\n\r\ntype LayoutMode = 'vertical' | 'grid';\r\n\r\nconst ImageUploader: React.FC<ImageUploaderProps> = ({\r\n  pendingImages,\r\n  uploadedImages,\r\n  editingTrade,\r\n  onImageUpload,\r\n  onImageCaptionChange,\r\n  onImageRemove,\r\n  onImagesReordered\r\n}) => {\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    if (e.target.files && e.target.files.length > 0) {\r\n      onImageUpload(e.target.files);\r\n      // Reset the input value so the same file can be selected again\r\n      e.target.value = '';\r\n    }\r\n  };\r\n\r\n  const handleAddImageClick = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  // Check if any images are currently uploading (pending images are still uploading)\r\n  const isAnyImageUploading = (): boolean => {\r\n    return pendingImages.length > 0;\r\n  };\r\n\r\n  const organizeImagesVertically = () => {\r\n    if (!onImagesReordered || isAnyImageUploading()) return;\r\n\r\n    const allImages = [...pendingImages, ...uploadedImages];\r\n\r\n    // Sort images by their existing row and column values to maintain relative order\r\n    const sortedImages = [...allImages].sort((a, b) => {\r\n      const aRow = a.row ?? 0;\r\n      const bRow = b.row ?? 0;\r\n      const aCol = a.column ?? 0;\r\n      const bCol = b.column ?? 0;\r\n\r\n      if (aRow === bRow) return aCol - bCol;\r\n      return aRow - bRow;\r\n    });\r\n\r\n    // Reorganize images vertically (one per row)\r\n    const reorganizedImages = sortedImages.map((image, index) => ({\r\n      ...image,\r\n      row: index,\r\n      column: 0,\r\n      column_width: 100 // Full width for vertical layout\r\n    }));\r\n\r\n    // Split back into pending and uploaded images\r\n    const newPendingImages = reorganizedImages.filter(img => 'file' in img) as GridPendingImage[];\r\n    const newUploadedImages = reorganizedImages.filter(img => !('file' in img)) as GridImage[];\r\n\r\n    // Update the layout\r\n    onImagesReordered([...newPendingImages, ...newUploadedImages]);\r\n  };\r\n\r\n  const organizeImagesInGrid = () => {\r\n    if (!onImagesReordered || isAnyImageUploading()) return;\r\n\r\n    const allImages = [...pendingImages, ...uploadedImages];\r\n\r\n    // Sort images by their existing row and column values to maintain relative order\r\n    const sortedImages = [...allImages].sort((a, b) => {\r\n      const aRow = a.row ?? 0;\r\n      const bRow = b.row ?? 0;\r\n      const aCol = a.column ?? 0;\r\n      const bCol = b.column ?? 0;\r\n\r\n      if (aRow === bRow) return aCol - bCol;\r\n      return aRow - bRow;\r\n    });\r\n\r\n    // Calculate grid layout with max 3 columns\r\n    const maxColumns = 3;\r\n    const columnWidth = 100 / maxColumns;\r\n\r\n    const reorganizedImages = sortedImages.map((image, index) => {\r\n      const row = Math.floor(index / maxColumns);\r\n      const column = index % maxColumns;\r\n\r\n      return {\r\n        ...image,\r\n        row,\r\n        column,\r\n        columnWidth\r\n      };\r\n    });\r\n\r\n    // Split back into pending and uploaded images\r\n    const newPendingImages = reorganizedImages.filter(img => 'file' in img) as GridPendingImage[];\r\n    const newUploadedImages = reorganizedImages.filter(img => !('file' in img)) as GridImage[];\r\n\r\n    // Update the layout\r\n    onImagesReordered([...newPendingImages, ...newUploadedImages]);\r\n   \r\n  };\r\n\r\n  const handlePaste = (event: ClipboardEvent) => {\r\n    const items = event.clipboardData?.items;\r\n    if (!items) return;\r\n\r\n    const imageFiles: File[] = [];\r\n    for (let i = 0; i < items.length; i++) {\r\n      const item = items[i];\r\n      if (item.type.indexOf('image') !== -1) {\r\n        const file = item.getAsFile();\r\n        if (file) {\r\n          imageFiles.push(file);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (imageFiles.length > 0) {\r\n      const dataTransfer = new DataTransfer();\r\n      imageFiles.forEach(file => dataTransfer.items.add(file));\r\n      onImageUpload(dataTransfer.files);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Add paste event listener to the document\r\n    document.addEventListener('paste', handlePaste);\r\n\r\n    // Clean up the event listener when the component unmounts\r\n    return () => {\r\n      document.removeEventListener('paste', handlePaste);\r\n    };\r\n  }, [onImageUpload]); // Add onImageUpload to the dependency array\r\n\r\n  return (\r\n    <Box sx={{ mt: 2 }}>\r\n      <Typography variant=\"subtitle1\" sx={{ mb: 1 }}>\r\n        Images\r\n      </Typography>\r\n\r\n      <input\r\n        type=\"file\"\r\n        accept=\"image/*\"\r\n        multiple\r\n        ref={fileInputRef}\r\n        style={{ display: 'none' }}\r\n        onChange={handleFileInputChange}\r\n      />\r\n\r\n      <Box sx={{ mb: 2 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\r\n          <Button\r\n            variant=\"outlined\"\r\n            startIcon={<AddPhotoAlternate />}\r\n            onClick={handleAddImageClick}\r\n          >\r\n            Add Images\r\n          </Button>\r\n          <Box sx={{ flex: 1 }} />  {/* This will push the buttons to the right */}\r\n\r\n          <Tooltip title=\"Arrange images vertically (one per row)\">\r\n            <span> {/* Wrapper needed for disabled Tooltip */}\r\n              <IconButton\r\n                onClick={organizeImagesVertically}\r\n                color={'default'}\r\n                disabled={pendingImages.length + uploadedImages.length < 2 || isAnyImageUploading()}\r\n              >\r\n                <ViewList />\r\n              </IconButton>\r\n            </span>\r\n          </Tooltip>\r\n\r\n          <Tooltip title=\"Arrange images in a grid (max 3 columns)\">\r\n            <span> {/* Wrapper needed for disabled Tooltip */}\r\n              <IconButton\r\n                onClick={organizeImagesInGrid}\r\n                color={'default'}\r\n                disabled={pendingImages.length + uploadedImages.length < 2 || isAnyImageUploading()}\r\n              >\r\n                <GridView />\r\n              </IconButton>\r\n            </span>\r\n          </Tooltip>\r\n        </Box>\r\n        <Typography variant=\"caption\" color=\"text.secondary\" display=\"block\">\r\n          You can also paste images directly (Ctrl+V). Maximum file size: 1MB per image.\r\n        </Typography>\r\n      </Box>\r\n\r\n      {(pendingImages.length > 0 || uploadedImages.length > 0) && (\r\n        <ImageGrid\r\n          pendingImages={pendingImages}\r\n          uploadedImages={uploadedImages}\r\n          editingTrade={editingTrade}\r\n          onImageCaptionChange={onImageCaptionChange}\r\n          onImageRemove={onImageRemove}\r\n          onImagesReordered={onImagesReordered}\r\n        />\r\n      )}\r\n    </Box>\r\n  );\r\n};\r\n\r\n\r\nexport default ImageUploader;\r\n","import React, { useState, useEffect, useMemo } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  LinearProgress,\r\n  Paper\r\n} from '@mui/material';\r\nimport {\r\n  CalendarMonthOutlined,\r\n  CheckCircle as CheckIcon,\r\n  Timelapse,\r\n  TipsAndUpdates\r\n} from '@mui/icons-material';\r\nimport { alpha } from '@mui/material/styles';\r\nimport { format, startOfDay, startOfWeek, endOfWeek } from 'date-fns';\r\nimport { Trade, Calendar } from '../../types/dualWrite';\r\nimport { TradeRepository } from '../../services/repository/repositories/TradeRepository';\r\nimport { calculateCumulativePnLToDateAsync } from '../../utils/dynamicRiskUtils';\r\nimport { logger } from '../../utils/logger';\r\n\r\ninterface ProgressSectionProps {\r\n  calendarId: string;\r\n  currentBalance: number;\r\n  currentDate: Date; // The date to determine which week to show progress for\r\n  calendar: Calendar; // Calendar data to get targets from\r\n  weekTrades?: Trade[]; // Optional pre-fetched trades for the week (avoids redundant DB query)\r\n}\r\n\r\ninterface MotivationalTip {\r\n  message: string;\r\n  subMessage: string;\r\n  trades?: { r2: number; r1: number };\r\n}\r\n\r\n/**\r\n * Generate a motivational tip based on remaining amount and risk per trade\r\n */\r\nconst generateMotivationalTip = (\r\n  remainingAmount: number,\r\n  riskPerTrade: number,\r\n  totalPnL: number,\r\n  profitTarget: number\r\n): MotivationalTip | null => {\r\n  if (remainingAmount <= 0) {\r\n    return {\r\n      message: \"You've hit your target!\",\r\n      subMessage: \"Outstanding work! Consider locking in your gains or pushing further.\"\r\n    };\r\n  }\r\n\r\n  if (!riskPerTrade || riskPerTrade <= 0) {\r\n    const progressPercent = profitTarget > 0 ? Math.round((totalPnL / profitTarget) * 100) : 0;\r\n    if (progressPercent >= 75) {\r\n      return {\r\n        message: \"Almost there!\",\r\n        subMessage: \"You're so close to your target. Stay focused and trust your process.\"\r\n      };\r\n    }\r\n    if (progressPercent >= 50) {\r\n      return {\r\n        message: \"Halfway there!\",\r\n        subMessage: \"Great progress! Keep executing your strategy with discipline.\"\r\n      };\r\n    }\r\n    return {\r\n      message: \"Focus on the process\",\r\n      subMessage: \"Take it one trade at a time. Quality setups lead to consistent results.\"\r\n    };\r\n  }\r\n\r\n  const rMultiplesNeeded = remainingAmount / riskPerTrade;\r\n  const combinations = [\r\n    { r2: 1, r1: 0, total: 2 },\r\n    { r2: 0, r1: 2, total: 2 },\r\n    { r2: 1, r1: 1, total: 3 },\r\n    { r2: 2, r1: 0, total: 4 },\r\n    { r2: 0, r1: 3, total: 3 },\r\n    { r2: 1, r1: 2, total: 4 },\r\n    { r2: 2, r1: 1, total: 5 },\r\n    { r2: 0, r1: 4, total: 4 },\r\n    { r2: 3, r1: 0, total: 6 },\r\n  ];\r\n\r\n  const validCombination = combinations.find(\r\n    combo => (combo.r2 * 2 + combo.r1 * 1) >= rMultiplesNeeded\r\n  );\r\n\r\n  if (validCombination) {\r\n    const { r2, r1 } = validCombination;\r\n    const totalTrades = r2 + r1;\r\n\r\n    const encouragements = [\r\n      \"No pressure, you've got this!\",\r\n      \"Stay patient and wait for your setup.\",\r\n      \"Trust your process!\",\r\n      \"One quality trade at a time.\",\r\n      \"You're closer than you think!\",\r\n      \"Focus on execution, not the outcome.\"\r\n    ];\r\n\r\n    const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];\r\n\r\n    return {\r\n      message: `You need at least ${totalTrades} trade${totalTrades > 1 ? 's' : ''}`,\r\n      subMessage: randomEncouragement,\r\n      trades: { r2, r1 }\r\n    };\r\n  }\r\n\r\n  const tradesNeeded = Math.ceil(rMultiplesNeeded / 2);\r\n  return {\r\n    message: `About ${tradesNeeded} solid trades to go.`,\r\n    subMessage: \"Break it down into small wins. Every R counts!\"\r\n  };\r\n};\r\n\r\nconst ProgressSection: React.FC<ProgressSectionProps> = ({\r\n  calendarId,\r\n  currentBalance,\r\n  currentDate,\r\n  calendar,\r\n  weekTrades: weekTradesProp\r\n}) => {\r\n  // State - only used when weekTradesProp is not provided\r\n  const [weekTradesState, setWeekTrades] = useState<Trade[]>([]);\r\n  const [cumulativePnLBeforeWeek, setCumulativePnLBeforeWeek] = useState<number>(0);\r\n\r\n  // Use prop if provided, otherwise fall back to state (fetched from DB)\r\n  const weekTrades = weekTradesProp ?? weekTradesState;\r\n\r\n  // Extract targets from calendar\r\n  const weeklyTargetPercentage = calendar?.weekly_target;\r\n  const accountBalance = calendar?.account_balance || 0;\r\n  const riskPerTrade = calendar?.risk_per_trade;\r\n\r\n  // Get week boundaries for the current date - memoized to prevent infinite re-renders\r\n  const { weekStart, weekEnd, weekStartTime } = useMemo(() => {\r\n    const start = startOfWeek(currentDate, { weekStartsOn: 0 }); // Sunday\r\n    const end = endOfWeek(currentDate, { weekStartsOn: 0 }); // Saturday\r\n    return { weekStart: start, weekEnd: end, weekStartTime: start.getTime() };\r\n  }, [currentDate.getTime()]);\r\n\r\n  // Use calendar.id for dependency instead of calendar object to prevent re-renders\r\n  const calendarIdForEffect = calendar?.id;\r\n\r\n  // Fetch week trades and cumulative P&L before week\r\n  // Skip fetching trades if weekTrades prop is provided (optimization from parent)\r\n  useEffect(() => {\r\n    const fetchWeekData = async () => {\r\n      if (!calendarId || !calendar) return;\r\n\r\n      try {\r\n        // Only fetch trades from DB if not provided via props\r\n        if (!weekTradesProp) {\r\n          const tradeRepo = new TradeRepository();\r\n          const trades = await tradeRepo.getTradesByDateRange(calendarId, weekStart, weekEnd);\r\n          setWeekTrades(trades);\r\n        }\r\n\r\n        // Calculate cumulative P&L before the week start\r\n        const pnl = await calculateCumulativePnLToDateAsync(weekStart, calendar);\r\n        setCumulativePnLBeforeWeek(pnl);\r\n      } catch (error) {\r\n        logger.error('Error fetching week data:', error);\r\n        if (!weekTradesProp) {\r\n          setWeekTrades([]);\r\n        }\r\n        setCumulativePnLBeforeWeek(0);\r\n      }\r\n    };\r\n\r\n    fetchWeekData();\r\n  }, [calendarId, calendarIdForEffect, weekStartTime, weekTradesProp]);\r\n\r\n  // Calculate traded days (unique days with trades in current week)\r\n  const tradedDaysCount = new Set(\r\n    weekTrades.map(trade => format(startOfDay(new Date(trade.trade_date)), 'yyyy-MM-dd'))\r\n  ).size;\r\n\r\n  // Calculate total P&L for the week\r\n  const totalPnL = weekTrades.reduce((sum, trade) => sum + trade.amount, 0);\r\n\r\n  // Calculate account balance at start of week for dynamic risk\r\n  const baselineAccountValue = accountBalance + cumulativePnLBeforeWeek;\r\n\r\n  // Calculate target amount using baseline account value (accounts for dynamic risk)\r\n  const profitTarget = baselineAccountValue > 0 && weeklyTargetPercentage\r\n    ? (weeklyTargetPercentage / 100) * baselineAccountValue\r\n    : 0;\r\n\r\n  // Calculate risk amount in dollars (risk_per_trade is stored as percentage)\r\n  const riskAmountDollars = riskPerTrade && baselineAccountValue > 0\r\n    ? (riskPerTrade / 100) * baselineAccountValue\r\n    : 0;\r\n\r\n  const tradedDaysTarget = 5; // Default to 5 trading days per week\r\n\r\n  // Progress percentages\r\n  const tradedDaysProgress = Math.min((tradedDaysCount / tradedDaysTarget) * 100, 100);\r\n  const profitProgress = profitTarget > 0 ? Math.min((totalPnL / profitTarget) * 100, 100) : 0;\r\n  const profitTargetReached = totalPnL >= profitTarget;\r\n  const tradedDaysReached = tradedDaysCount >= tradedDaysTarget;\r\n\r\n  // Display values capped at targets\r\n  const displayedTradedDays = Math.min(tradedDaysCount, tradedDaysTarget);\r\n  const displayedPnL = Math.min(totalPnL, profitTarget);\r\n\r\n  // Calculate remaining amount and generate tip - memoized to prevent random changes on re-render\r\n  const motivationalTip = useMemo(() => {\r\n    const remainingAmount = profitTarget - totalPnL;\r\n    return generateMotivationalTip(\r\n      remainingAmount,\r\n      riskAmountDollars,\r\n      totalPnL,\r\n      profitTarget\r\n    );\r\n  }, [profitTarget, totalPnL, riskAmountDollars]);\r\n\r\n  // Don't render if no targets are set\r\n  if (!weeklyTargetPercentage || !accountBalance) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Paper\r\n      elevation={0}\r\n      sx={{\r\n        p: 2,\r\n        mb: 2,\r\n        backgroundColor: 'rgba(255, 255, 255, 0.05)',\r\n        borderRadius: 1\r\n      }}\r\n    >\r\n      <Typography variant=\"h6\" sx={{ mb: 2, fontWeight: 600 }}>\r\n        Progress\r\n      </Typography>\r\n\r\n      {/* Traded Days Progress */}\r\n      <Box sx={{ mb: 3 }}>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\r\n          {tradedDaysReached ? (\r\n            <CheckIcon sx={{ color: 'success.main', fontSize: 20 }} />\r\n          ) : (\r\n            <CalendarMonthOutlined  />\r\n          )}\r\n          <Typography variant=\"body2\" sx={{ color: 'text.secondary' }}>\r\n            Traded days\r\n          </Typography>\r\n        </Box>\r\n        <LinearProgress\r\n          variant=\"determinate\"\r\n          value={tradedDaysProgress}\r\n          sx={{\r\n            height: 8,\r\n            borderRadius: 1,\r\n            backgroundColor: 'rgba(255, 255, 255, 0.1)',\r\n            '& .MuiLinearProgress-bar': {\r\n              backgroundColor: tradedDaysReached ? 'success.main' : 'primary.main',\r\n              borderRadius: 1\r\n            }\r\n          }}\r\n        />\r\n        <Typography variant=\"body1\" sx={{ mt: 0.5, fontWeight: 600 }}>\r\n          {displayedTradedDays} / {tradedDaysTarget}\r\n        </Typography>\r\n      </Box>\r\n\r\n      {/* Profit Target Progress */}\r\n      <Box>\r\n        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>\r\n          {profitTargetReached ? (\r\n            <CheckIcon sx={{ color: 'success.main', fontSize: 20 }} />\r\n          ) : (\r\n             <Timelapse  />\r\n          )}\r\n          <Typography variant=\"body2\" sx={{ color: 'text.secondary' }}>\r\n            Reach your profit target of ${profitTarget.toLocaleString()}\r\n          </Typography>\r\n        </Box>\r\n        <LinearProgress\r\n          variant=\"determinate\"\r\n          value={profitProgress}\r\n          sx={{\r\n            height: 8,\r\n            borderRadius: 1,\r\n            backgroundColor: 'rgba(255, 255, 255, 0.1)',\r\n            '& .MuiLinearProgress-bar': {\r\n              backgroundColor: profitTargetReached ? 'success.main' : 'primary.main',\r\n              borderRadius: 1\r\n            }\r\n          }}\r\n        />\r\n        <Typography\r\n          variant=\"body1\"\r\n          sx={{\r\n            mt: 0.5,\r\n            fontWeight: 600,\r\n            color: totalPnL >= 0 ? 'success.main' : 'error.main'\r\n          }}\r\n        >\r\n          ${displayedPnL.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} / ${profitTarget.toLocaleString()}\r\n        </Typography>\r\n      </Box>\r\n\r\n      {/* Motivational Tip Section */}\r\n      {motivationalTip && (\r\n        <Box\r\n          sx={{\r\n            mt: 3,\r\n            p: 2,\r\n            borderRadius: 1,\r\n            backgroundColor: (theme) => alpha(theme.palette.warning.main, 0.15),\r\n            border: '1px solid',\r\n            borderColor: (theme) => alpha(theme.palette.warning.main, 0.3)\r\n          }}\r\n        >\r\n          <Box sx={{ display: 'flex', alignItems: 'flex-start', gap: 1.5 }}>\r\n            <TipsAndUpdates\r\n              sx={{\r\n                color: 'warning.main',\r\n                fontSize: 22,\r\n                mt: 0.25\r\n              }}\r\n            />\r\n            <Box sx={{ flex: 1 }}>\r\n              {/* Trade indicators when available */}\r\n              {motivationalTip.trades ? (\r\n                <>\r\n                  {/* Main message: \"You need at least X trades\" */}\r\n                  <Typography\r\n                    variant=\"body2\"\r\n                    sx={{\r\n                      fontWeight: 600,\r\n                      color: 'text.primary',\r\n                      mb: 1\r\n                    }}\r\n                  >\r\n                    {motivationalTip.message}\r\n                  </Typography>\r\n                  {/* Trade breakdown with badges */}\r\n                  <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 0.5, flexWrap: 'wrap' }}>\r\n                    {/* 2R trade indicators */}\r\n                    {Array.from({ length: motivationalTip.trades.r2 }).map((_, i) => (\r\n                      <Box\r\n                        key={`r2-${i}`}\r\n                        sx={{\r\n                          px: 0.75,\r\n                          py: 0.25,\r\n                          borderRadius: 1,\r\n                          backgroundColor: 'success.main',\r\n                          color: 'success.contrastText',\r\n                          fontSize: '0.6rem',\r\n                          fontWeight: 600\r\n                        }}\r\n                      >\r\n                        2R\r\n                      </Box>\r\n                    ))}\r\n                    {/* 1R trade indicators */}\r\n                    {Array.from({ length: motivationalTip.trades.r1 }).map((_, i) => (\r\n                      <Box\r\n                        key={`r1-${i}`}\r\n                        sx={{\r\n                          px: 0.75,\r\n                          py: 0.25,\r\n                          borderRadius: 1,\r\n                          backgroundColor: 'primary.main',\r\n                          color: 'primary.contrastText',\r\n                          fontSize: '0.6rem',\r\n                          fontWeight: 600\r\n                        }}\r\n                      >\r\n                        1R\r\n                      </Box>\r\n                    ))}\r\n                    <Typography\r\n                      variant=\"caption\"\r\n                      sx={{ color: 'text.secondary', fontWeight: 400, fontSize: '0.7rem' }}\r\n                    >\r\n                      to reach your target\r\n                    </Typography>\r\n                  </Box>\r\n                </>\r\n              ) : (\r\n                <Typography\r\n                  variant=\"body2\"\r\n                  sx={{\r\n                    fontWeight: 600,\r\n                    color: 'text.primary',\r\n                    mb: 0.5\r\n                  }}\r\n                >\r\n                  {motivationalTip.message}\r\n                </Typography>\r\n              )}\r\n              <Typography\r\n                variant=\"caption\"\r\n                sx={{\r\n                  color: 'warning.light',\r\n                  display: 'block',\r\n                  mt: 0.5\r\n                }}\r\n              >\r\n                {motivationalTip.subMessage}\r\n              </Typography>\r\n            </Box>\r\n          </Box>\r\n        </Box>\r\n      )}\r\n    </Paper>\r\n  );\r\n};\r\n\r\nexport default ProgressSection;\r\n","/**\r\n * TradeCard Component for AI Chat\r\n * Compact trade card specifically designed for displaying trade information in AI chat responses\r\n */\r\n\r\nimport React from 'react';\r\nimport {\r\n  Box,\r\n  Card,\r\n  CardContent,\r\n  Typography,\r\n  Chip,\r\n  Stack,\r\n  Tooltip,\r\n  alpha\r\n} from '@mui/material';\r\nimport {\r\n  TrendingUp as WinIcon,\r\n  TrendingDown as LossIcon,\r\n  Remove as BreakevenIcon,\r\n  Schedule as SessionIcon,\r\n  Note as NoteIcon,\r\n  Image as ImageIcon,\r\n  Balance as RiskIcon,\r\n  CalendarToday as DateIcon\r\n} from '@mui/icons-material';\r\nimport { useTheme } from '@mui/material/styles';\r\nimport { format } from 'date-fns';\r\nimport { Trade } from '../../types/trade';\r\nimport { getTagChipStyles, formatTagForDisplay, isGroupedTag, getTagGroup } from '../../utils/tagColors';\r\n\r\ninterface TradeCardProps {\r\n  trade: Trade;\r\n  showTags?: boolean;\r\n  onClick?: () => void;\r\n  showImages?: boolean;\r\n}\r\n\r\nconst TradeCard: React.FC<TradeCardProps> = ({\r\n  trade,\r\n  onClick,\r\n  showTags,\r\n  showImages = false\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  const getTradeTypeIcon = () => {\r\n    switch (trade.trade_type) {\r\n      case 'win':\r\n        return <WinIcon sx={{ fontSize: '1rem', color: 'success.main' }} />;\r\n      case 'loss':\r\n        return <LossIcon sx={{ fontSize: '1rem', color: 'error.main' }} />;\r\n      case 'breakeven':\r\n        return <BreakevenIcon sx={{ fontSize: '1rem', color: 'info.main' }} />;\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  const getTradeTypeColorName = () => {\r\n    switch (trade.trade_type) {\r\n      case 'win':\r\n        return 'success';\r\n      case 'loss':\r\n        return 'error';\r\n      case 'breakeven':\r\n        return 'info';\r\n      default:\r\n        return 'primary';\r\n    }\r\n  };\r\n\r\n  const getTradeTypeColorValue = () => {\r\n    switch (trade.trade_type) {\r\n      case 'win':\r\n        return theme.palette.success.main;\r\n      case 'loss':\r\n        return theme.palette.error.main;\r\n      case 'breakeven':\r\n        return theme.palette.info.main;\r\n      default:\r\n        return theme.palette.primary.main;\r\n    }\r\n  };\r\n\r\n  const formatAmount = (amount: number) => {\r\n    const sign = amount >= 0 ? '+' : '';\r\n    return `${sign}$${Math.abs(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  // Group tags by category for compact display\r\n  const groupedTags = trade.tags?.reduce((groups, tag) => {\r\n    if (isGroupedTag(tag)) {\r\n      const group = getTagGroup(tag);\r\n      if (!groups[group]) groups[group] = [];\r\n      groups[group].push(tag);\r\n    } else {\r\n      if (!groups['Other']) groups['Other'] = [];\r\n      groups['Other'].push(tag);\r\n    }\r\n    return groups;\r\n  }, {} as Record<string, string[]>) || {};\r\n\r\n  // Limit to first 5 tag groups\r\n  const MAX_VISIBLE_TAGS = 5;\r\n  const tagEntries = Object.entries(groupedTags);\r\n  const visibleTags = tagEntries.slice(0, MAX_VISIBLE_TAGS);\r\n  const remainingTagsCount = tagEntries.length - MAX_VISIBLE_TAGS;\r\n  const hasMoreTags = remainingTagsCount > 0;\r\n\r\n  return (\r\n    <Card\r\n      sx={{\r\n        maxWidth: 400,\r\n        cursor: onClick ? 'pointer' : 'default',\r\n        transition: 'all 0.2s ease-in-out',\r\n        border: '1px solid',\r\n        borderColor: alpha(getTradeTypeColorValue(), 0.2),\r\n        backgroundColor: alpha(getTradeTypeColorValue(), 0.05),\r\n        '&:hover': onClick ? { \r\n          boxShadow: `0 4px 12px ${alpha(getTradeTypeColorValue(), 0.2)}`,\r\n          borderColor: getTradeTypeColorValue()\r\n        } : {}\r\n      }}\r\n      onClick={onClick}\r\n    >\r\n      <CardContent sx={{ p: 2, pt: 1, '&:last-child': { pb: 1 } }}>\r\n        <Stack spacing={1}>\r\n          {/* Header */}\r\n          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\r\n            <Box sx={{ flex: 1 }}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                <Box sx={{ flex: 1 }}>\r\n                  {trade.name && (\r\n                    <Typography variant=\"subtitle2\" fontWeight=\"bold\" sx={{ mb: 0.5 }}>\r\n                      {trade.name}\r\n                    </Typography>\r\n                  )}\r\n                </Box>\r\n                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                  {getTradeTypeIcon()}\r\n                  <Typography\r\n                    variant=\"h6\"\r\n                    fontWeight=\"bold\"\r\n                    color={`${getTradeTypeColorName()}.main`}\r\n                    sx={{ fontSize: '1rem' }}\r\n                  >\r\n                    {formatAmount(trade.amount)}\r\n                  </Typography>\r\n                </Box>\r\n              </Box>\r\n              {/* Additional Info Icons */}\r\n              <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>\r\n                {trade.notes && (\r\n                  <Tooltip title=\"Has notes\">\r\n                    <NoteIcon sx={{ fontSize: '1rem', color: 'text.secondary' }} />\r\n                  </Tooltip>\r\n                )}\r\n                {Array.isArray(trade.images) && trade.images.length > 0 && showImages && (\r\n                  <Tooltip title={`${trade.images.length} image(s)`}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                      <ImageIcon sx={{ fontSize: '1rem', color: 'text.secondary' }} />\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        {trade.images.length}\r\n                      </Typography>\r\n                    </Box>\r\n                  </Tooltip>\r\n                )}\r\n                {trade.risk_to_reward &&  (\r\n                  <Tooltip title={`Risk to Reward: ${trade.risk_to_reward.toFixed(2)}`}>\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>\r\n                      <RiskIcon sx={{ fontSize: '1rem', color: 'text.secondary' }} />\r\n                      <Typography variant=\"caption\" color=\"text.secondary\">\r\n                        {trade.risk_to_reward.toFixed(2)}\r\n                      </Typography>\r\n                    </Box>\r\n                  </Tooltip>\r\n                )}\r\n                {trade.partials_taken && (\r\n                  <Tooltip title=\"Partials taken\">\r\n                    <Chip\r\n                      label=\"Partials\"\r\n                      size=\"small\"\r\n                      variant=\"outlined\"\r\n                      sx={{\r\n                        height: '18px',\r\n                        fontSize: '0.65rem',\r\n                        '& .MuiChip-label': { px: 0.5 }\r\n                      }}\r\n                    />\r\n                  </Tooltip>\r\n                )}\r\n\r\n                <>\r\n                  <DateIcon sx={{ fontSize: '0.875rem', color: 'text.secondary' }} />\r\n                  <Typography variant=\"caption\" color=\"text.secondary\" noWrap>{format(new Date(trade.trade_date), 'MMM dd, yyyy')}</Typography>\r\n                </>\r\n\r\n                {trade.session && (\r\n                  <>\r\n                    <SessionIcon sx={{ fontSize: '0.875rem', color: 'text.secondary' }} />\r\n                    <Typography variant=\"caption\" color=\"text.secondary\">\r\n                      {trade.session}\r\n                    </Typography>\r\n                  </>\r\n                )}\r\n              </Box>\r\n\r\n\r\n\r\n\r\n            </Box>\r\n          </Box>\r\n         \r\n\r\n          {/* Tags */}\r\n          {showTags && trade.tags && trade.tags.length > 0 && (\r\n            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>\r\n              {visibleTags.map(([group, groupTags]) => (\r\n                <Chip\r\n                    key={group}\r\n                    label={`${group}${groupTags.length > 1 ? ` (${groupTags.length})` : ''}`}\r\n                    size=\"small\"\r\n                    sx={{\r\n                      ...getTagChipStyles(groupTags[0], theme),\r\n                      height: '20px',\r\n                      fontSize: '0.7rem',\r\n                      '& .MuiChip-label': { px: 1 }\r\n                    }}\r\n                  />\r\n              ))}\r\n\r\n              {/* Show +N chip if there are more tags */}\r\n              {hasMoreTags && (\r\n                 <Chip\r\n                    label={`+${remainingTagsCount}`}\r\n                    size=\"small\"\r\n                    sx={{\r\n                      height: '20px',\r\n                      backgroundColor: theme.palette.mode === 'dark'\r\n                        ? 'rgba(255, 255, 255, 0.1)'\r\n                        : 'rgba(0, 0, 0, 0.08)',\r\n                      color: 'text.secondary',\r\n                      fontWeight: 600,\r\n                      border: '1px dashed',\r\n                      borderColor: 'divider',\r\n                      fontSize: '0.7rem',\r\n                      '& .MuiChip-label': { px: 1 }\r\n                    }}\r\n                  />\r\n              )}\r\n            </Box>\r\n          )}\r\n\r\n\r\n        </Stack>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default TradeCard;\r\n","import React, { useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  IconButton,\r\n  useTheme\r\n} from '@mui/material';\r\nimport { ChevronLeft, ChevronRight } from '@mui/icons-material';\r\nimport { format } from 'date-fns';\r\nimport { alpha } from '@mui/material/styles';\r\n\r\ninterface DayHeaderProps {\r\n  formInputVisible: boolean;\r\n  account_balance: number;\r\n  title:string,\r\n  total_pnl: number;\r\n  onPrevDay: () => void;\r\n  onNextDay: () => void;\r\n}\r\n\r\nconst DayHeader: React.FC<DayHeaderProps> = ({\r\n  account_balance,\r\n  formInputVisible,\r\n  total_pnl,\r\n  title,\r\n  onPrevDay,\r\n  onNextDay\r\n}) => {\r\n  const theme = useTheme();\r\n  \r\n   \r\n  \r\n  return (\r\n    <Box sx={{ mb: 3 }}>\r\n      <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', mb: 2 }}>\r\n        {!formInputVisible && <IconButton onClick={onPrevDay} size=\"small\">\r\n          <ChevronLeft />\r\n        </IconButton>}\r\n        \r\n        \r\n        {title && <Typography variant=\"h6\" sx={{ fontWeight: 600 }}>\r\n          {title}\r\n        </Typography>}\r\n        \r\n        {!formInputVisible && <IconButton onClick={onNextDay} size=\"small\">\r\n          <ChevronRight />\r\n        </IconButton>\r\n        }\r\n      </Box>\r\n      \r\n      <Box sx={{ display: 'flex', gap: 2 }}>\r\n       \r\n        \r\n        <Box\r\n          sx={{\r\n            flex: 1,\r\n            p: 2,\r\n            borderRadius: 1,\r\n            bgcolor: total_pnl >= 0\r\n              ? alpha(theme.palette.success.main, 0.1)\r\n              : alpha(theme.palette.error.main, 0.1),\r\n            border: '1px solid',\r\n            borderColor: total_pnl >= 0\r\n              ? alpha(theme.palette.success.main, 0.2)\r\n              : alpha(theme.palette.error.main, 0.2)\r\n          }}\r\n        >\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            Day P&L\r\n          </Typography>\r\n          <Typography\r\n            variant=\"h6\"\r\n            sx={{\r\n              fontWeight: 600,\r\n              color: total_pnl >= 0\r\n                ? theme.palette.success.main\r\n                : theme.palette.error.main\r\n            }}\r\n          >\r\n            {total_pnl >= 0 ? '+' : ''}{total_pnl.toLocaleString()}\r\n          </Typography>\r\n        </Box>\r\n\r\n        <Box\r\n          sx={{\r\n            flex: 1,\r\n            p: 2,\r\n            borderRadius: 1,\r\n            bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n            border: '1px solid',\r\n            borderColor: alpha(theme.palette.primary.main, 0.2)\r\n          }}\r\n        >\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            Balance Of The Day\r\n          </Typography>\r\n          <Typography variant=\"h6\" sx={{ fontWeight: 600 }}>\r\n            ${account_balance.toLocaleString()}\r\n          </Typography>\r\n        </Box>\r\n      </Box>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default DayHeader;\r\n","/**\r\n * RichTextViewer Component\r\n * Read-only viewer for Draft.js rich text content\r\n */\r\n\r\nimport React, { useMemo } from 'react';\r\nimport { Box, Typography, useTheme } from '@mui/material';\r\nimport { Editor, EditorState } from 'draft-js';\r\nimport 'draft-js/dist/Draft.css';\r\n\r\nimport { createEditorStateFromValue } from './utils/draftUtils';\r\nimport { createStyleMap } from './utils/styleUtils';\r\nimport { blockStyleFn } from './utils/editorActions';\r\nimport { createDecorator } from './utils/decoratorUtils';\r\nimport { TEXT_COLORS, BACKGROUND_COLORS } from './constants/colors';\r\n\r\ninterface RichTextViewerProps {\r\n  content: string;\r\n  minHeight?: number | string;\r\n}\r\n\r\nconst RichTextViewer: React.FC<RichTextViewerProps> = ({\r\n  content,\r\n  minHeight = 100,\r\n}) => {\r\n  const theme = useTheme();\r\n\r\n  // Create decorator for links/entities\r\n  const decorator = useMemo(() => createDecorator(), []);\r\n\r\n  // Create editor state from content\r\n  const editorState = useMemo(() => {\r\n    const state = createEditorStateFromValue(content);\r\n    return EditorState.set(state, { decorator });\r\n  }, [content, decorator]);\r\n\r\n  // Create style map for custom styles\r\n  const styleMap = useMemo(() => createStyleMap(theme, TEXT_COLORS, BACKGROUND_COLORS), [theme]);\r\n\r\n  // Custom block renderer for images\r\n  const blockRendererFn = (block: any) => {\r\n    if (block.getType() === 'atomic') {\r\n      return {\r\n        component: AtomicBlock,\r\n        editable: false,\r\n      };\r\n    }\r\n    return null;\r\n  };\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        minHeight,\r\n        '& .DraftEditor-root': {\r\n          fontSize: '1rem',\r\n          lineHeight: 1.7,\r\n          color: theme.palette.text.primary,\r\n        },\r\n        '& .public-DraftEditorPlaceholder-root': {\r\n          display: 'none',\r\n        },\r\n        '& .public-DraftEditor-content': {\r\n          minHeight,\r\n        },\r\n        // List styles\r\n        '& ul, & ol': {\r\n          margin: '0.5em 0',\r\n          paddingLeft: '1.5em',\r\n        },\r\n        '& li': {\r\n          marginBottom: '0.25em',\r\n        },\r\n        // Heading styles\r\n        '& h1': {\r\n          fontSize: '2rem',\r\n          fontWeight: 700,\r\n          margin: '1em 0 0.5em',\r\n        },\r\n        '& h2': {\r\n          fontSize: '1.5rem',\r\n          fontWeight: 600,\r\n          margin: '0.8em 0 0.4em',\r\n        },\r\n        '& h3': {\r\n          fontSize: '1.25rem',\r\n          fontWeight: 600,\r\n          margin: '0.6em 0 0.3em',\r\n        },\r\n        // Blockquote styles\r\n        '& blockquote': {\r\n          borderLeft: `3px solid ${theme.palette.primary.main}`,\r\n          paddingLeft: '1em',\r\n          marginLeft: 0,\r\n          color: theme.palette.text.secondary,\r\n          fontStyle: 'italic',\r\n        },\r\n        // Code block styles\r\n        '& pre': {\r\n          backgroundColor: theme.palette.action.hover,\r\n          padding: '1em',\r\n          borderRadius: 1,\r\n          overflow: 'auto',\r\n          fontFamily: 'monospace',\r\n        },\r\n        // Link styles\r\n        '& a': {\r\n          color: theme.palette.primary.main,\r\n          textDecoration: 'none',\r\n          '&:hover': {\r\n            textDecoration: 'underline',\r\n          },\r\n        },\r\n      }}\r\n    >\r\n      <Editor\r\n        editorState={editorState}\r\n        onChange={() => {}} // No-op for read-only\r\n        readOnly={true}\r\n        customStyleMap={styleMap}\r\n        blockStyleFn={blockStyleFn}\r\n        blockRendererFn={blockRendererFn}\r\n      />\r\n    </Box>\r\n  );\r\n};\r\n\r\n// Atomic block component for images\r\nconst AtomicBlock: React.FC<{ block: any; contentState: any }> = ({\r\n  block,\r\n  contentState,\r\n}) => {\r\n  const entity = contentState.getEntity(block.getEntityAt(0));\r\n  const type = entity.getType();\r\n  const data = entity.getData();\r\n\r\n  if (type === 'IMAGE') {\r\n    return (\r\n      <Box\r\n        component=\"img\"\r\n        src={data.src}\r\n        alt={data.alt || ''}\r\n        sx={{\r\n          maxWidth: '100%',\r\n          height: 'auto',\r\n          borderRadius: 1,\r\n          my: 1,\r\n        }}\r\n      />\r\n    );\r\n  }\r\n\r\n  return null;\r\n};\r\n\r\nexport default RichTextViewer;\r\n","/**\r\n * NoteViewerDialog Component\r\n * Read-only dialog for viewing notes in shared calendars\r\n */\r\n\r\nimport React from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  IconButton,\r\n  Box,\r\n  useTheme,\r\n  alpha,\r\n  Toolbar,\r\n  Typography,\r\n  useMediaQuery,\r\n  Chip,\r\n  Stack,\r\n} from '@mui/material';\r\nimport {\r\n  Close as CloseIcon,\r\n  PushPin as PinIcon,\r\n  SmartToy as AIIcon,\r\n} from '@mui/icons-material';\r\n\r\nimport { Note } from '../../types/note';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { getTagDisplayLabel } from './NoteEditorDialog';\r\nimport RichTextViewer from '../common/RichTextEditor/RichTextViewer';\r\nimport { format } from 'date-fns';\r\n\r\ninterface NoteViewerDialogProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  note: Note | null;\r\n}\r\n\r\nconst NoteViewerDialog: React.FC<NoteViewerDialogProps> = ({\r\n  open,\r\n  onClose,\r\n  note,\r\n}) => {\r\n  const theme = useTheme();\r\n  const fullScreen = useMediaQuery(theme.breakpoints.down('md'));\r\n\r\n  if (!note) return null;\r\n\r\n  const formattedDate = note.updated_at\r\n    ? format(new Date(note.updated_at), 'MMM d, yyyy')\r\n    : note.created_at\r\n      ? format(new Date(note.created_at), 'MMM d, yyyy')\r\n      : '';\r\n\r\n  return (\r\n    <Dialog\r\n      open={open}\r\n      onClose={onClose}\r\n      fullScreen={fullScreen}\r\n      maxWidth=\"md\"\r\n      fullWidth\r\n      PaperProps={{\r\n        sx: {\r\n          height: fullScreen ? '100%' : '85vh',\r\n          m: fullScreen ? 0 : 2,\r\n          borderRadius: fullScreen ? 0 : 3,\r\n        },\r\n      }}\r\n    >\r\n      {/* Toolbar with title and close */}\r\n      <Toolbar\r\n        sx={{\r\n          borderBottom: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n          gap: 1,\r\n          minHeight: 56,\r\n        }}\r\n      >\r\n        <Stack direction=\"row\" spacing={1} alignItems=\"center\" sx={{ flex: 1 }}>\r\n          <Typography variant=\"h6\" noWrap>\r\n            View Note\r\n          </Typography>\r\n          {note.is_pinned && (\r\n            <PinIcon sx={{ fontSize: '1rem', color: 'primary.main' }} />\r\n          )}\r\n          {note.by_assistant && (\r\n            <Chip\r\n              icon={<AIIcon sx={{ fontSize: '0.9rem !important' }} />}\r\n              label=\"AI\"\r\n              size=\"small\"\r\n              sx={{\r\n                height: 20,\r\n                '& .MuiChip-label': { px: 0.75, fontSize: '0.7rem' },\r\n                bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                color: 'primary.main',\r\n              }}\r\n            />\r\n          )}\r\n        </Stack>\r\n\r\n        <IconButton size=\"small\" onClick={onClose}>\r\n          <CloseIcon />\r\n        </IconButton>\r\n      </Toolbar>\r\n\r\n      <DialogContent\r\n        sx={{\r\n          p: 0,\r\n          overflowY: 'auto',\r\n          bgcolor: 'background.default',\r\n          ...(scrollbarStyles(theme) as any),\r\n        }}\r\n      >\r\n        {/* Cover Image */}\r\n        {note.cover_image && (\r\n          <Box\r\n            sx={{\r\n              width: '100%',\r\n              height: 220,\r\n              backgroundImage: `url(${note.cover_image})`,\r\n              backgroundSize: 'cover',\r\n              backgroundPosition: 'center',\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Content Area */}\r\n        <Box\r\n          sx={{\r\n            maxWidth: 800,\r\n            margin: '0 auto',\r\n            px: { xs: 2, md: 5 },\r\n            py: 4,\r\n          }}\r\n        >\r\n          {/* Tags */}\r\n          {note.tags && note.tags.length > 0 && (\r\n            <Stack direction=\"row\" spacing={0.5} flexWrap=\"wrap\" sx={{ mb: 2 }}>\r\n              {note.tags.map((tag) => (\r\n                <Chip\r\n                  key={tag}\r\n                  label={getTagDisplayLabel(tag)}\r\n                  size=\"small\"\r\n                  sx={{\r\n                    bgcolor: alpha(theme.palette.secondary.main, 0.1),\r\n                    color: 'secondary.main',\r\n                    fontWeight: 500,\r\n                    fontSize: '0.75rem',\r\n                    height: 24,\r\n                  }}\r\n                />\r\n              ))}\r\n            </Stack>\r\n          )}\r\n\r\n          {/* Title */}\r\n          <Typography\r\n            variant=\"h3\"\r\n            sx={{\r\n              fontWeight: 700,\r\n              lineHeight: 1.2,\r\n              mb: 2,\r\n              wordBreak: 'break-word',\r\n            }}\r\n          >\r\n            {note.title || 'Untitled'}\r\n          </Typography>\r\n\r\n          {/* Date */}\r\n          {formattedDate && (\r\n            <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mb: 3, display: 'block' }}>\r\n              {note.updated_at ? 'Updated' : 'Created'} {formattedDate}\r\n            </Typography>\r\n          )}\r\n\r\n          {/* Content */}\r\n          <Box sx={{ mt: 3 }}>\r\n            {note.content ? (\r\n              <RichTextViewer content={note.content} />\r\n            ) : (\r\n              <Typography variant=\"body1\" color=\"text.secondary\" sx={{ fontStyle: 'italic' }}>\r\n                No content\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n        </Box>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default NoteViewerDialog;\r\n","/**\r\n * NotesDrawer Component\r\n * Drawer for viewing and managing notes for a calendar or across all calendars\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport {\r\n  Box,\r\n  Typography,\r\n  TextField,\r\n  InputAdornment,\r\n  Button,\r\n  useTheme,\r\n  alpha,\r\n  Stack,\r\n  IconButton,\r\n\r\n  CircularProgress,\r\n  MenuItem,\r\n  Select,\r\n  FormControl,\r\n  Tooltip,\r\n} from '@mui/material';\r\nimport {\r\n  Search as SearchIcon,\r\n  Add as AddIcon,\r\n  Notes as NotesIcon,\r\n  Clear as ClearIcon,\r\n  SmartToy as AIIcon,\r\n  Person as PersonIcon,\r\n} from '@mui/icons-material';\r\n\r\nimport UnifiedDrawer from '../common/UnifiedDrawer';\r\nimport RoundedTabs from '../common/RoundedTabs';\r\nimport NoteListItem from './NoteListItem';\r\nimport Shimmer from '../Shimmer';\r\nimport NoteEditorDialog from './NoteEditorDialog';\r\nimport NoteViewerDialog from './NoteViewerDialog';\r\nimport { Note } from '../../types/note';\r\nimport { Calendar } from '../../types/calendar';\r\nimport * as notesService from '../../services/notesService';\r\nimport { logger } from '../../utils/logger';\r\nimport { useAuthState } from '../../contexts/AuthStateContext';\r\nimport { CalendarRepository } from '../../services/repository/repositories/CalendarRepository';\r\nimport { scrollbarStyles } from '../../styles/scrollbarStyles';\r\nimport { useNotes } from '../../hooks/useNotes';\r\n\r\ninterface NotesDrawerProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  calendarId?: string; // If provided, filter to calendar; otherwise show all\r\n  showCalendarPicker?: boolean; // Show calendar selection for new notes (HomePage)\r\n  onNoteClick?: (note: Note) => void;\r\n  isReadOnly?: boolean; // Hide edit actions for shared calendars\r\n}\r\n\r\ntype TabValue = 'all' | 'pinned' | 'archived';\r\n\r\n/**\r\n * Shimmer loading component for note list items\r\n */\r\nconst NoteListItemShimmer: React.FC = () => {\r\n  const theme = useTheme();\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        borderRadius: 2,\r\n        mb: 0.5,\r\n        py: 1.5,\r\n        px: 2,\r\n        border: `1px solid ${alpha(theme.palette.divider, 0.1)}`,\r\n        bgcolor: alpha(theme.palette.background.paper, 0.6),\r\n      }}\r\n    >\r\n      <Stack direction=\"row\" spacing={1.5} alignItems=\"center\">\r\n        <Box sx={{ flex: 1, minWidth: 0 }}>\r\n          {/* Title */}\r\n          <Box sx={{ mb: 0.5 }}>\r\n            <Shimmer height={20} width=\"60%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n          </Box>\r\n\r\n          {/* Content preview */}\r\n          <Box sx={{ mb: 0.5 }}>\r\n            <Shimmer height={16} width=\"100%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" sx={{ mb: 0.3 }} />\r\n            <Shimmer height={16} width=\"80%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n          </Box>\r\n\r\n          {/* Date */}\r\n          <Shimmer height={14} width=\"30%\" borderRadius={4} variant=\"wave\" intensity=\"medium\" />\r\n        </Box>\r\n\r\n        <Shimmer\r\n          height={60}\r\n          width={60}\r\n          borderRadius={1}\r\n          variant=\"wave\"\r\n          intensity=\"medium\"\r\n          sx={{ flexShrink: 0 }}\r\n        />\r\n      </Stack>\r\n    </Box>\r\n  );\r\n};\r\n\r\nconst NotesDrawer: React.FC<NotesDrawerProps> = ({\r\n  open,\r\n  onClose,\r\n  calendarId,\r\n  showCalendarPicker = false,\r\n  onNoteClick,\r\n  isReadOnly = false\r\n}) => {\r\n  const theme = useTheme();\r\n  const { user } = useAuthState();\r\n\r\n  const [calendars, setCalendars] = useState<Calendar[]>([]);\r\n  const [searchQuery, setSearchQuery] = useState<string>('');\r\n  const [activeTab, setActiveTab] = useState<TabValue>('all');\r\n  const [editorOpen, setEditorOpen] = useState(false);\r\n  const [selectedNote, setSelectedNote] = useState<Note | undefined>();\r\n  const [selectedCalendarForNew, setSelectedCalendarForNew] = useState<string | undefined>(calendarId);\r\n  const [selectedCalendarFilter, setSelectedCalendarFilter] = useState<string>('all'); // For filtering notes by calendar\r\n  const [creatorFilter, setCreatorFilter] = useState<'assistant' | 'me'>('me'); // Filter by creator\r\n  const [viewerOpen, setViewerOpen] = useState(false); // Read-only viewer dialog\r\n  const [viewerNote, setViewerNote] = useState<Note | null>(null);\r\n\r\n  // Use custom hook for notes management\r\n  const {\r\n    notes,\r\n    loading,\r\n    loadingMore,\r\n    hasMore,\r\n    total,\r\n    loadMore,\r\n    updateNote,\r\n    removeNote,\r\n    addNote,\r\n  } = useNotes({\r\n    userId: user?.uid,\r\n    calendarId,\r\n    isOpen: open,\r\n    activeTab,\r\n    searchQuery,\r\n    selectedCalendarFilter,\r\n    creatorFilter,\r\n  });\r\n\r\n  // Load calendars when drawer opens (for calendar picker)\r\n  useEffect(() => {\r\n    if (open && showCalendarPicker) {\r\n      loadCalendars();\r\n    }\r\n  }, [open, showCalendarPicker]);\r\n\r\n  const loadCalendars = async () => {\r\n    if (!user?.uid) return;\r\n\r\n    try {\r\n      const calendarRepo = new CalendarRepository();\r\n      const userCalendars = await calendarRepo.findByUserId(user.uid);\r\n      setCalendars(userCalendars);\r\n    } catch (error) {\r\n      logger.error('Error loading calendars:', error);\r\n      setCalendars([]);\r\n    }\r\n  };\r\n\r\n  const handleTabChange = (_event: React.SyntheticEvent, newValue: number) => {\r\n    const tabValues: TabValue[] = ['all', 'pinned', 'archived'];\r\n    setActiveTab(tabValues[newValue]);\r\n  };\r\n\r\n  const handleNewNote = () => {\r\n    if (showCalendarPicker && !calendarId) {\r\n      // In multi-calendar view, require a calendar to be selected\r\n      if (selectedCalendarFilter === 'all') {\r\n        // No calendar selected - do nothing\r\n        logger.warn('Please select a calendar to create a note');\r\n        return;\r\n      }\r\n      // Use the selected calendar from dropdown\r\n      setSelectedCalendarForNew(selectedCalendarFilter);\r\n      setSelectedNote(undefined);\r\n      setEditorOpen(true);\r\n    } else {\r\n      // In single-calendar view, use the provided calendarId\r\n      setSelectedCalendarForNew(calendarId);\r\n      setSelectedNote(undefined);\r\n      setEditorOpen(true);\r\n    }\r\n  };\r\n\r\n  const handleNoteClick = (note: Note) => {\r\n    // In read-only mode, open the viewer dialog instead of editor\r\n    if (isReadOnly) {\r\n      setViewerNote(note);\r\n      setViewerOpen(true);\r\n      if (onNoteClick) onNoteClick(note);\r\n      return;\r\n    }\r\n    setSelectedNote(note);\r\n    // For global notes (calendar_id = null), use the current calendar as fallback\r\n    // This allows editing global notes and toggling them to calendar-specific if desired\r\n    setSelectedCalendarForNew(note.calendar_id ?? calendarId ?? selectedCalendarFilter);\r\n    setEditorOpen(true);\r\n    if (onNoteClick) onNoteClick(note);\r\n  };\r\n\r\n  const handleViewerClose = () => {\r\n    setViewerOpen(false);\r\n    setViewerNote(null);\r\n  };\r\n\r\n  const handleEditorClose = () => {\r\n    setEditorOpen(false);\r\n    setSelectedNote(undefined);\r\n  };\r\n\r\n  const handlePin = async (note: Note) => {\r\n    if (!note) return;\r\n\r\n    try {\r\n      // Optimistically update UI\r\n      updateNote(note.id, { is_pinned: !note.is_pinned });\r\n\r\n      // Call backend\r\n      if (note.is_pinned) {\r\n        await notesService.unpinNote(note.id);\r\n      } else {\r\n        await notesService.pinNote(note.id);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error toggling pin:', error);\r\n      // Revert on error\r\n      updateNote(note.id, { is_pinned: note.is_pinned });\r\n    }\r\n  };\r\n\r\n  const handleArchive = async (note: Note) => {\r\n    try {\r\n      if (!note) return;\r\n\r\n      // Remove from UI immediately\r\n      removeNote(note.id);\r\n\r\n      // Call backend\r\n      if (note.is_archived) {\r\n        await notesService.unarchiveNote(note.id);\r\n      } else {\r\n        await notesService.archiveNote(note.id);\r\n      }\r\n    } catch (error) {\r\n      logger.error('Error archiving note:', error);\r\n      // Could add back to list on error, but for now just log\r\n    }\r\n  };\r\n\r\n\r\n\r\n  // Get calendar for note (for multi-calendar view)\r\n  const getCalendarForNote = (note: Note): Calendar | undefined => {\r\n    return calendars.find(c => c.id === note.calendar_id);\r\n  };\r\n\r\n  // Header actions - hide in read-only mode\r\n  const headerActions = isReadOnly ? null : (\r\n    <Button\r\n      variant=\"contained\"\r\n      size=\"small\"\r\n      startIcon={<AddIcon />}\r\n      onClick={handleNewNote}\r\n      disabled={showCalendarPicker && (calendars.length === 0 || selectedCalendarFilter === 'all')}\r\n      sx={{\r\n        borderRadius: 2,\r\n        textTransform: 'none',\r\n        fontWeight: 600,\r\n      }}\r\n    >\r\n      New Note\r\n    </Button>\r\n  );\r\n\r\n  return (\r\n    <>\r\n      <UnifiedDrawer\r\n        open={open}\r\n        onClose={onClose}\r\n        title=\"Notes\"\r\n        icon={<NotesIcon />}\r\n        headerActions={\r\n          !isReadOnly && (\r\n            <Tooltip title=\"Create new note\" arrow>\r\n              <IconButton\r\n                color=\"primary\"\r\n                onClick={handleNewNote}\r\n                disabled={showCalendarPicker && (calendars.length === 0 || selectedCalendarFilter === 'all')}\r\n                sx={{\r\n                  bgcolor: alpha(theme.palette.primary.main, 0.1),\r\n                  '&:hover': {\r\n                    bgcolor: alpha(theme.palette.primary.main, 0.2)\r\n                  }\r\n                }}\r\n              >\r\n                <AddIcon />\r\n              </IconButton>\r\n            </Tooltip>\r\n          )\r\n        }\r\n        width={{ xs: '100%', sm: 450 }}\r\n        headerVariant=\"enhanced\"\r\n        keepMounted={true}\r\n      >\r\n        <Box sx={{ display: 'flex', flexDirection: 'column', height: '100%' }}>\r\n          {/* Calendar Dropdown - only show in multi-calendar view */}\r\n          {showCalendarPicker && !calendarId && (\r\n            <Box sx={{ p: 2, pb: 1 }}>\r\n              <FormControl fullWidth size=\"small\">\r\n                <Select\r\n                  value={selectedCalendarFilter}\r\n                  onChange={(e) => setSelectedCalendarFilter(e.target.value)}\r\n                  displayEmpty\r\n                  sx={{\r\n                    borderRadius: 1,\r\n                    bgcolor: alpha(theme.palette.background.paper, 0.5),\r\n                  }}\r\n                >\r\n                  <MenuItem value=\"all\">\r\n                    <Typography variant=\"body2\" color=\"text.secondary\">\r\n                      All Calendars\r\n                    </Typography>\r\n                  </MenuItem>\r\n                  {calendars.map((calendar) => (\r\n                    <MenuItem key={calendar.id} value={calendar.id}>\r\n                      <Typography variant=\"body2\">{calendar.name}</Typography>\r\n                    </MenuItem>\r\n                  ))}\r\n                </Select>\r\n              </FormControl>\r\n            </Box>\r\n          )}\r\n\r\n          {/* Tabs */}\r\n          <Box sx={{ p: 2, pb: 1, pt: showCalendarPicker && !calendarId ? 0 : 2 }}>\r\n            <RoundedTabs\r\n              tabs={[\r\n                { label: 'All' },\r\n                { label: 'Pinned' },\r\n                { label: 'Archived' },\r\n              ]}\r\n              activeTab={['all', 'pinned', 'archived'].indexOf(activeTab)}\r\n              onTabChange={handleTabChange}\r\n              size=\"small\"\r\n              fullWidth\r\n            />\r\n          </Box>\r\n\r\n          {/* Search and Filter Row */}\r\n          <Box sx={{ px: 2, pb: 2, display: 'flex', gap: 1, alignItems: 'center' }}>\r\n            {/* Search - takes remaining space */}\r\n            <TextField\r\n              size=\"small\"\r\n              placeholder=\"Search notes...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              sx={{ flex: 1 }}\r\n              InputProps={{\r\n                startAdornment: (\r\n                  <InputAdornment position=\"start\">\r\n                    <SearchIcon sx={{ color: 'text.secondary' }} />\r\n                  </InputAdornment>\r\n                ),\r\n                endAdornment: searchQuery && (\r\n                  <InputAdornment position=\"end\">\r\n                    <IconButton\r\n                      size=\"small\"\r\n                      onClick={() => setSearchQuery('')}\r\n                      edge=\"end\"\r\n                    >\r\n                      <ClearIcon fontSize=\"small\" />\r\n                    </IconButton>\r\n                  </InputAdornment>\r\n                ),\r\n                sx: {\r\n                  borderRadius: 2,\r\n                  bgcolor: alpha(theme.palette.background.paper, 0.5),\r\n                },\r\n              }}\r\n            />\r\n\r\n            {/* Creator Filter - compact */}\r\n            <FormControl size=\"small\" sx={{ minWidth: 140 }}>\r\n              <Select\r\n                value={creatorFilter}\r\n                onChange={(e) => setCreatorFilter(e.target.value as 'assistant' | 'me')}\r\n                sx={{\r\n                  borderRadius: 1,\r\n                }}\r\n              >\r\n                <MenuItem value=\"me\">\r\n                  <Stack direction=\"row\" spacing={1} alignItems=\"center\">\r\n                    <PersonIcon sx={{ fontSize: '1rem', color: 'text.secondary' }} />\r\n                    <Typography variant=\"body2\">My Notes</Typography>\r\n                  </Stack>\r\n                </MenuItem>\r\n                <MenuItem value=\"assistant\">\r\n                  <Stack direction=\"row\" spacing={1} alignItems=\"center\">\r\n                    <AIIcon sx={{ fontSize: '1rem', color: 'primary.main' }} />\r\n                    <Typography variant=\"body2\">AI Assistant</Typography>\r\n                  </Stack>\r\n                </MenuItem>\r\n              </Select>\r\n            </FormControl>\r\n          </Box>\r\n\r\n          {/* Notes List */}\r\n          <Box\r\n            sx={{\r\n              flex: 1,\r\n              overflowY: 'auto',\r\n              px: 2,\r\n              pb: 2,\r\n              ...scrollbarStyles(theme),\r\n            }}\r\n          >\r\n            {loading ? (\r\n              <Box>\r\n                {Array.from({ length: 10 }).map((_, index) => (\r\n                  <NoteListItemShimmer key={index} />\r\n                ))}\r\n              </Box>\r\n            ) : notes.length === 0 ? (\r\n              <Stack spacing={2} alignItems=\"center\" sx={{ py: 8, textAlign: 'center' }}>\r\n                <NotesIcon sx={{ fontSize: 64, color: 'text.disabled' }} />\r\n                <Typography variant=\"h6\" color=\"text.secondary\">\r\n                  {searchQuery\r\n                    ? 'No notes found'\r\n                    : activeTab === 'pinned'\r\n                      ? 'No pinned notes'\r\n                      : activeTab === 'archived'\r\n                        ? 'No archived notes'\r\n                        : 'No notes yet'}\r\n                </Typography>\r\n                <Typography variant=\"body2\" color=\"text.disabled\">\r\n                  {searchQuery\r\n                    ? 'Try a different search term'\r\n                    : activeTab === 'all'\r\n                      ? 'Create your first note to get started'\r\n                      : ''}\r\n                </Typography>\r\n                {!searchQuery && activeTab === 'all' && !isReadOnly && (\r\n                  <Button\r\n                    variant=\"contained\"\r\n                    startIcon={<AddIcon />}\r\n                    onClick={handleNewNote}\r\n                    sx={{ mt: 2 }}\r\n                  >\r\n                    Create Note\r\n                  </Button>\r\n                )}\r\n              </Stack>\r\n            ) : (\r\n              <>\r\n                <Box>\r\n                  {notes.map((note) => (\r\n                    <NoteListItem\r\n                      key={note.id}\r\n                      note={note}\r\n                      onClick={handleNoteClick}\r\n                      onPin={isReadOnly ? undefined : handlePin}\r\n                      onArchive={isReadOnly ? undefined : handleArchive}\r\n                      onUnarchive={isReadOnly ? undefined : handleArchive}\r\n                      calendar={getCalendarForNote(note)}\r\n                      showCalendarBadge={showCalendarPicker && !calendarId}\r\n                    />\r\n                  ))}\r\n                </Box>\r\n\r\n                {/* Load More Button */}\r\n                {hasMore && (\r\n                  <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2, mb: 1 }}>\r\n                    <Button\r\n                      variant=\"outlined\"\r\n                      onClick={loadMore}\r\n                      disabled={loadingMore}\r\n                      sx={{\r\n                        borderRadius: 2,\r\n                        textTransform: 'none',\r\n                        minWidth: 120,\r\n                      }}\r\n                    >\r\n                      {loadingMore ? (\r\n                        <>\r\n                          <CircularProgress size={16} sx={{ mr: 1 }} />\r\n                          Loading...\r\n                        </>\r\n                      ) : (\r\n                        `Load More (${total - notes.length} remaining)`\r\n                      )}\r\n                    </Button>\r\n                  </Box>\r\n                )}\r\n              </>\r\n            )}\r\n          </Box>\r\n        </Box>\r\n      </UnifiedDrawer>\r\n\r\n      {/* Note Editor Dialog */}\r\n      {/* Allow editing if: we have a calendarId for new notes, OR we're editing an existing note */}\r\n      {editorOpen && (selectedCalendarForNew || selectedNote) && (\r\n        <NoteEditorDialog\r\n          open={editorOpen}\r\n          onClose={handleEditorClose}\r\n          note={selectedNote}\r\n          calendarId={selectedCalendarForNew || selectedNote?.calendar_id || calendarId || ''}\r\n          onSave={(note: Note, isCreated?: boolean) =>\r\n            isCreated ? addNote(note) : updateNote(note.id, note)\r\n          }\r\n          onDelete={(noteId: string) => removeNote(noteId)}\r\n        />\r\n      )}\r\n\r\n      {/* Note Viewer Dialog (Read-only mode) */}\r\n      <NoteViewerDialog\r\n        open={viewerOpen}\r\n        onClose={handleViewerClose}\r\n        note={viewerNote}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default NotesDrawer;\r\n","/**\r\n * useNotes Hook\r\n *\r\n * Custom hook for loading and managing notes with proper memoization\r\n * to prevent unnecessary reloads when drawer opens/closes.\r\n */\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\nimport { Note } from '../types/note';\r\nimport * as notesService from '../services/notesService';\r\nimport { logger } from '../utils/logger';\r\n\r\nexport interface UseNotesOptions {\r\n  /**\r\n   * User ID to fetch notes for\r\n   */\r\n  userId?: string;\r\n\r\n  /**\r\n   * Calendar ID to filter notes by (optional)\r\n   */\r\n  calendarId?: string;\r\n\r\n  /**\r\n   * Whether the drawer is open\r\n   */\r\n  isOpen: boolean;\r\n\r\n  /**\r\n   * Active tab filter\r\n   */\r\n  activeTab: 'all' | 'pinned' | 'archived';\r\n\r\n  /**\r\n   * Search query\r\n   */\r\n  searchQuery?: string;\r\n\r\n  /**\r\n   * Calendar filter (for multi-calendar view)\r\n   */\r\n  selectedCalendarFilter?: string;\r\n\r\n  /**\r\n   * Creator filter\r\n   */\r\n  creatorFilter: 'assistant' | 'me';\r\n\r\n  /**\r\n   * Number of notes per page\r\n   * @default 20\r\n   */\r\n  notesPerPage?: number;\r\n}\r\n\r\nexport interface UseNotesResult {\r\n  notes: Note[];\r\n  loading: boolean;\r\n  loadingMore: boolean;\r\n  hasMore: boolean;\r\n  total: number;\r\n  loadNotes: (reset?: boolean) => Promise<void>;\r\n  loadMore: () => void;\r\n  updateNote: (noteId: string, updates: Partial<Note>) => void;\r\n  removeNote: (noteId: string) => void;\r\n  addNote: (note: Note) => void;\r\n}\r\n\r\n/**\r\n * Custom hook for loading and managing notes with optimized loading behavior\r\n */\r\nexport function useNotes(options: UseNotesOptions): UseNotesResult {\r\n  const {\r\n    userId,\r\n    calendarId,\r\n    isOpen,\r\n    activeTab,\r\n    searchQuery = null,\r\n    selectedCalendarFilter = 'all',\r\n    creatorFilter,\r\n    notesPerPage = 20,\r\n  } = options;\r\n\r\n  const [notes, setNotes] = useState<Note[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [loadingMore, setLoadingMore] = useState(false);\r\n  const [hasMore, setHasMore] = useState(false);\r\n  const [total, setTotal] = useState(0);\r\n\r\n  // Use ref for offset to avoid it being in dependency array\r\n  const offsetRef = useRef(0);\r\n\r\n  // Track if we've loaded notes for the current open session\r\n  const hasLoadedRef = useRef(false);\r\n  // Track previous filter values to detect actual changes\r\n  const prevFiltersRef = useRef({\r\n    activeTab,\r\n    selectedCalendarFilter,\r\n    creatorFilter,\r\n    calendarId,\r\n    searchQuery,\r\n  });\r\n\r\n  const loadNotes = useCallback(\r\n    async (reset: boolean = false) => {\r\n      if (!userId) return;\r\n      try {\r\n        if (reset) {\r\n          setLoading(true);\r\n          offsetRef.current = 0;\r\n        } else {\r\n          setLoadingMore(true);\r\n        }\r\n\r\n        // Determine filter options based on active tab\r\n        const queryOptions: notesService.NoteQueryOptions = {\r\n          limit: notesPerPage,\r\n          offset: offsetRef.current,\r\n          searchQuery: (searchQuery || '').trim() || undefined,\r\n        };\r\n\r\n        // Apply tab-specific filters\r\n        if (activeTab === 'pinned') {\r\n          queryOptions.isPinned = true;\r\n          queryOptions.isArchived = false;\r\n        } else if (activeTab === 'archived') {\r\n          queryOptions.isArchived = true;\r\n        } else {\r\n          // 'all' tab - exclude archived notes\r\n          queryOptions.isArchived = false;\r\n        }\r\n\r\n        // Apply creator filter\r\n        if (creatorFilter === 'assistant') {\r\n          queryOptions.byAssistant = true;\r\n        } else if (creatorFilter === 'me') {\r\n          queryOptions.byAssistant = false;\r\n        }\r\n\r\n        // Query notes\r\n        let result: notesService.NoteQueryResult;\r\n        // Use calendarId prop if provided (calendar-specific view)\r\n        // Otherwise use selectedCalendarFilter from dropdown (multi-calendar view)\r\n        const effectiveCalendarId =\r\n          calendarId ||\r\n          (selectedCalendarFilter !== 'all' ? selectedCalendarFilter : undefined);\r\n\r\n        if (effectiveCalendarId) {\r\n          result = await notesService.queryCalendarNotes(\r\n            effectiveCalendarId,\r\n            queryOptions\r\n          );\r\n        } else {\r\n          result = await notesService.queryUserNotes(userId, queryOptions);\r\n        }\r\n\r\n        // Update state\r\n        if (reset) {\r\n          setNotes(result.notes);\r\n          offsetRef.current = result.notes.length;\r\n        } else {\r\n          setNotes((prev) => [...prev, ...result.notes]);\r\n          offsetRef.current += result.notes.length;\r\n        }\r\n        setHasMore(result.hasMore);\r\n        setTotal(result.total);\r\n      } catch (error) {\r\n        logger.error('Error loading notes:', error);\r\n        setNotes([]);\r\n      } finally {\r\n        setLoading(false);\r\n        setLoadingMore(false);\r\n      }\r\n    },\r\n    [\r\n      userId,\r\n      calendarId,\r\n      activeTab,\r\n      searchQuery,\r\n      selectedCalendarFilter,\r\n      creatorFilter,\r\n      notesPerPage,\r\n    ]\r\n  );\r\n\r\n  // Load notes when drawer opens (only once per session)\r\n  useEffect(() => {\r\n    if (isOpen && !hasLoadedRef.current) {\r\n      hasLoadedRef.current = true;\r\n      loadNotes(true);\r\n    }\r\n    // Don't reset hasLoadedRef when drawer closes if using keepMounted\r\n    // The drawer component will handle unmounting if needed\r\n  }, [isOpen, loadNotes]);\r\n\r\n  // Reload when filters change (only if drawer is open and already loaded)\r\n  useEffect(() => {\r\n    if (!isOpen || !hasLoadedRef.current) return;\r\n\r\n    const prev = prevFiltersRef.current;\r\n    const filtersChanged =\r\n      prev.activeTab !== activeTab ||\r\n      prev.selectedCalendarFilter !== selectedCalendarFilter ||\r\n      prev.creatorFilter !== creatorFilter ||\r\n      prev.calendarId !== calendarId;\r\n\r\n    if (filtersChanged) {\r\n      prevFiltersRef.current = {\r\n        ...prevFiltersRef.current,\r\n        activeTab,\r\n        selectedCalendarFilter,\r\n        creatorFilter,\r\n        calendarId,\r\n      };\r\n      loadNotes(true);\r\n    }\r\n  }, [\r\n    isOpen,\r\n    activeTab,\r\n    selectedCalendarFilter,\r\n    creatorFilter,\r\n    calendarId,\r\n    loadNotes,\r\n  ]);\r\n\r\n  // Debounced search effect - only runs when searchQuery actually changes\r\n  useEffect(() => {\r\n    if (!isOpen || !hasLoadedRef.current) return;\r\n\r\n    // Only trigger if searchQuery actually changed from previous value\r\n    if (prevFiltersRef.current.searchQuery === searchQuery) return;\r\n\r\n    const timeout = setTimeout(() => {\r\n      prevFiltersRef.current.searchQuery = searchQuery;\r\n      loadNotes(true);\r\n    }, 500); // 500ms debounce\r\n\r\n    return () => clearTimeout(timeout);\r\n  }, [searchQuery, isOpen, loadNotes]);\r\n\r\n  const loadMore = useCallback(() => {\r\n    loadNotes(false);\r\n  }, [loadNotes]);\r\n\r\n  const updateNote = useCallback((noteId: string, updates: Partial<Note>) => {\r\n    setNotes((prev) =>\r\n      prev.map((n) => (n.id === noteId ? { ...n, ...updates } : n))\r\n    );\r\n  }, []);\r\n\r\n  const removeNote = useCallback((noteId: string) => {\r\n    setNotes((prev) => prev.filter((n) => n.id !== noteId));\r\n  }, []);\r\n\r\n  const addNote = useCallback((note: Note) => {\r\n    setNotes((prev) => [note, ...prev]);\r\n  }, []);\r\n\r\n  return {\r\n    notes,\r\n    loading,\r\n    loadingMore,\r\n    hasMore,\r\n    total,\r\n    loadNotes,\r\n    loadMore,\r\n    updateNote,\r\n    removeNote,\r\n    addNote,\r\n  };\r\n}\r\n"],"names":["_ref","open","onClose","anchor","keepMounted","title","subtitle","icon","headerActions","children","width","xs","sm","maxWidth","zIndex","headerVariant","sx","headerSx","contentSx","theme","useTheme","enhancedDrawerStyles","background","palette","mode","backdropFilter","borderLeft","concat","alpha","divider","undefined","borderRight","boxShadow","enhancedHeaderStyles","p","borderBottom","display","alignItems","gap","paper","defaultHeaderStyles","headerStyles","_jsx","Drawer","ModalProps","_objectSpread","_jsxs","Box","height","flexDirection","borderRadius","primary","main","border","justifyContent","React","type","color","fontSize","style","flex","Typography","variant","fontWeight","mb","IconButton","onClick","size","CloseIcon","overflow","onSubmit","initialData","isSubmitting","submitButtonText","name","setName","useState","account_balance","setAccount_balance","max_daily_drawdown","setMax_daily_drawdown","weekly_target","setWeekly_target","monthly_target","setMonthly_target","yearly_target","setYearly_target","risk_per_trade","setRisk_per_trade","dynamic_risk_enabled","setDynamicRiskEnabled","increased_risk_percentage","setIncreasedRiskPercentage","profit_threshold_percentage","setProfitThresholdPercentage","hero_image_url","setHeroImageUrl","hero_image_attribution","setHeroImageAttribution","isImagePickerOpen","setIsImagePickerOpen","useEffect","_initialData$account_","_initialData$max_dail","_initialData$weekly_t","_initialData$monthly_","_initialData$yearly_t","_initialData$risk_per","_initialData$increase","_initialData$profit_t","toString","resetForm","isFormValid","trim","dialogTitle","dialogActions","_Fragment","Button","disabled","async","balance","parseFloat","maxDrawdown","weeklyTargetValue","monthlyTargetValue","yearlyTargetValue","riskPerTradeValue","increasedRiskValue","profitThresholdValue","isNaN","minWidth","CircularProgress","BaseDialog","fullWidth","actions","hideFooterCancelButton","Stack","spacing","mt","TextField","label","value","onChange","e","target","autoFocus","Card","position","borderColor","CardMedia","component","backgroundImage","backgroundSize","backgroundPosition","backgroundRepeat","content","top","left","right","bottom","common","black","Tooltip","handleRemoveImage","backgroundColor","error","DeleteIcon","px","py","photographer","startIcon","ImageIcon","borderStyle","test","InputProps","startAdornment","mr","endAdornment","ml","helperText","FormControlLabel","control","Switch","checked","ImagePickerDialog","onImageSelect","handleImageSelect","imageUrl","attribution","tagService","fetchTagDefinitions","userId","data","supabase","from","select","eq","logger","definitions","forEach","item","tag_name","definition","err","fetchTagDefinition","tagName","single","code","saveTagDefinition","originalDefinition","trimmedDef","upsert","user_id","updated_at","Date","toISOString","onConflict","this","deleteTagDefinition","delete","BOTTOM_SHEET_HEIGHTS","trades","calendar","isReadOnly","tradeOperations","onOpenGalleryMode","onUpdateTradeProperty","onEditTrade","onDeleteTrade","onDeleteMultipleTrades","onZoomImage","onUpdateCalendarProperty","isTradeUpdating","user","useAuthState","chatInterfaceRef","useRef","messages","isLoading","isTyping","toolExecutionStatus","conversations","loadingConversations","loadingMoreConversations","hasMoreConversations","totalConversationsCount","isAtMessageLimit","sendMessage","cancelRequest","setInputForEdit","loadConversations","loadMoreConversations","selectConversation","deleteConversation","startNewChat","setMessages","getWelcomeMessage","useAIChat","uid","messageLimit","autoSaveConversation","showHistoryView","setShowHistoryView","deleteDialogOpen","setDeleteDialogOpen","conversationToDelete","setConversationToDelete","historySearchQuery","setHistorySearchQuery","selectedEvent","setSelectedEvent","eventDetailDialogOpen","setEventDetailDialogOpen","selectedNote","setSelectedNote","noteEditorOpen","setNoteEditorOpen","apiKeySettingsOpen","setApiKeySettingsOpen","originalOverflow","document","body","filteredConversations","query","toLowerCase","filter","conversation","_conversation$title","_preview","includes","preview","Array","isArray","some","message","_message$content","setTimeout","_chatInterfaceRef$cur","current","focus","id","handleCancelDelete","getPreviewText","firstUserMessage","find","msg","role","substring","length","Z_INDEX","AI_DRAWER_BACKDROP","opacity","visibility","transition","cursor","AI_DRAWER","maxHeight","md","lg","borderTopLeftRadius","borderTopRightRadius","borderBottomLeftRadius","borderBottomRightRadius","transform","pointerEvents","pb","Avatar","dark","AIIcon","lineHeight","totalTrades","year_stats","Object","values","reduce","sum","yearStats","total_trades","NewChatIcon","action","hover","ArrowBackIcon","HistoryIcon","SettingsIcon","AIChatInterface","ref","onTradeClick","tradeId","contextTrades","t","log","onEventClick","event","onNoteClick","noteId","note","warn","placeholder","InputAdornment","SearchIcon","scrollbarStyles","List","map","_","index","ListItem","Shimmer","intensity","Divider","Alert","severity","disablePadding","ListItemButton","handleSelectConversation","textOverflow","whiteSpace","Chip","message_count","WebkitLineClamp","WebkitBoxOrient","ScheduleIcon","format","handleDeleteClick","conversationId","stopPropagation","flexShrink","borderTop","textTransform","pt","default","EconomicEventDetailDialog","calendarId","Dialog","DIALOG","DialogTitle","DialogContent","DialogContentText","DialogActions","ApiKeySettingsDialog","NoteEditorDialog","onSave","updatedNote","prevMessages","embeddedNotes","onDelete","_msg$embeddedNotes","remainingNotes","_objectWithoutProperties","_toPropertyKey","date","showAddForm","onDateChange","onOpenAIChatMode","weekTrades","expandedTradeId","setExpandedTradeId","dayTotalPnL","setDayTotalPnL","cumulativePnL","setCumulativePnL","eventsDrawerOpen","setEventsDrawerOpen","dateTime","getTime","calendarIdForEffect","targetDate","startOfNextDay","pnl","calculateCumulativePnLToDateAsync","fetchCumulativePnL","tradeRepo","TradeRepository","total","getTradesByDay","trade","amount","fetchDayTotalPnL","handlePrevDay","useCallback","prevDay","setDate","getDate","handleNextDay","nextDay","isAfter","startOfDay","handleTradeClick","prev","handleAddClick","handleEditClick","handleGalleryModeClick","handleOpenAIChat","handleOpenEventsDrawer","tradesLength","mergedTradeOperations","useMemo","onOpenAIChat","hideCloseButton","primaryButtonText","primaryButtonAction","EventIcon","GalleryIcon","DayHeader","formInputVisible","total_pnl","onPrevDay","onNextDay","ProgressSection","currentBalance","currentDate","TradeList","hideActions","enableBulkSelection","EconomicCalendarDrawer","initialDate","progress","isMet","tooltipText","badgeContent","bgcolor","success","CheckCircle","Flag","Math","min","max","toFixed","arrow","placement","onDateSelect","accountBalance","monthlyTarget","yearlyTarget","isSmDown","useMediaQuery","breakpoints","down","setCurrentDate","currentYear","getFullYear","months","currentMonth","getMonth","yearlyStats","stats","startOfYear","yearlyPnL","yearlyWinCount","yearlyLossCount","yearlyWinRate","yearlyGrowthPercentage","accountValueAtStartOfYear","entries","_ref2","year","yearData","parseInt","yearly_pnl","win_count","loss_count","win_rate","yearly_growth_percentage","monthlyStats","Map","monthIndex","set","monthPnL","tradeCount","accountValueAtStartOfMonth","targetProgress","growthPercentage","monthStats","monthly_stats","account_value_at_start","targetAmount","rawProgress","month_pnl","trade_count","growth_percentage","bestMonth","best_month_pnl","best_month_index","yearlyTargetProgress","CalendarToday","handleToday","handlePrevYear","subYears","ChevronLeft","textAlign","letterSpacing","handleNextYear","addYears","ChevronRight","handleYearlyGalleryMode","Paper","elevation","pl","TargetBadge","light","toLocaleString","gridTemplateColumns","TrendingUp","abs","EmojiEvents","info","CalendarMonth","month","get","hasEntries","newDate","handleMonthSelect","grey","text","allTags","onTagUpdated","requiredTagGroups","searchTerm","setSearchTerm","selectedTagGroup","setSelectedTagGroup","tagToEdit","setTagToEdit","localRequiredGroups","setLocalRequiredGroups","tagGroups","getUniqueTagGroups","filteredTags","filtered","tag","isGroupedTag","getTagGroup","term","formatTagForDisplay","groupedTags","groups","group","push","handleRequiredTagGroupsChange","required_tag_groups","gutterBottom","flexWrap","FormControl","Select","displayEmpty","FilterListIcon","MenuItem","typography","body2","tags","updatedGroups","g","InfoIcon","secondaryAction","ListItemText","getTagChipStyles","TagEditDialog","onSuccess","handleTagEditSuccess","oldTag","newTag","tradesUpdated","oldGroup","newGroup","updatedRequiredGroups","handleTagDelete","deletedTag","deletedGroup","onTagCreated","setTagName","tagGroup","setTagGroup","setDefinition","setIsSubmitting","setError","handleSubmit","preventDefault","trimmedTagName","trimmedGroup","fullTag","formatTagWithCapitalizedGroup","Error","cancelButtonText","cancelButtonAction","required","multiline","rows","inputProps","maxLength","calendarOwnerId","tagToView","setTagToView","isCreateDialogOpen","setIsCreateDialogOpen","tagDefinitions","setTagDefinitions","collapsedGroups","setCollapsedGroups","UnifiedDrawer","TagIcon","AddIcon","toggleGroup","ExpandMoreIcon","ExpandLessIcon","Collapse","in","timeout","unmountOnExit","secondary","definitionUpdated","initialDefinition","TagCreateDialog","created","currentTags","dividers","fontStyle","count","containerSx","selectedTags","onTagsChange","searchQuery","setSearchQuery","currentPage","setCurrentPage","searchResults","setSearchResults","isSearching","setIsSearching","totalCount","setTotalCount","totalPages","setTotalPages","debouncedSearchQuery","setDebouncedSearchQuery","isFilterDialogOpen","setIsFilterDialogOpen","dateFilter","setDateFilter","startDate","endDate","filteredTagOptions","filterTagsByGroup","activeFilterCount","timer","clearTimeout","result","getTradeRepository","searchTrades","page","pageSize","console","performSearch","handleDateFilterChange","handleStartDateChange","handleEndDateChange","handleClearDateFilter","handleClearAllFilters","slotProps","input","Badge","FilterIcon","minHeight","TradeCardShimmer","TradeCard","showTags","showImages","Pagination","showFirstButton","showLastButton","mx","PaperProps","SelectInput","options","Autocomplete","multiple","newValue","listbox","renderInput","params","renderTags","getTagProps","option","_getTagProps","key","chipProps","_excluded","renderOption","props","restProps","_excluded2","my","DateRangeIcon","RadioGroup","Radio","margin","DatePicker","textField","minDate","styled","padding","shape","shadows","alignContent","CalendarCell","aspectRatio","WeekdayHeader","_ref3","exportTrades","initial_balance","arguments","fileFormat","exportData","sortedTrades","sort","a","b","trade_date","_trade$tags","_trade$risk_to_reward","_trade$images","Name","Type","trade_type","charAt","toUpperCase","slice","Amount","entry_price","exit_price","Tags","join","risk_to_reward","Session","session","Notes","notes","Images","images","img","url","prepareTradeDataForExport","dateStr","fileName","exportToExcel","wb","XLSX","book_new","ws","json_to_sheet","wch","book_append_sheet","exportToCsv","headers","keys","csvRows","row","header","escaped","String","replace","csvContent","blob","Blob","URL","createObjectURL","link","createElement","setAttribute","appendChild","click","removeChild","calculateWinRate","winCount","totalWinLossTrades","calculateProfitFactor","grossProfit","grossLoss","calculateTargetProgress","allTrades","totalPnL","calculateTotalPnL","baselineAccountValue","DATE_FORMATS","parseFlexibleNumber","originalValue","numStr","parenMatch","match","percentResult","parsed","convertToFieldType","targetType","parsedDate","parse","monthNameMatch","day","indexOf","directDate","parseFlexibleDate","numberFormat","strValue","parseFlexibleBoolean","delimiter","v","Boolean","split","parseFlexibleArray","arrayDelimiter","TRADE_FIELD_METADATA","displayName","description","examples","stop_loss","take_profit","partials_taken","validateField","field","config","metadata","isValid","column","convertedValue","conversionOptions","conversionResult","expectedType","validateFieldType","suggestedFix","mapRowToTrade","mappings","rowIndex","errors","warnings","mapping","fileColumn","tagValue","formattedTag","validation","imageUrls","crypto","randomUUID","calendar_id","typeResult","parseTradeType","defaultValues","requiredFields","FIELD_PATTERNS","calculateSimilarity","str1","str2","s1","s2","matrix","len1","len2","i","j","cost","findBestFieldMatch","bestMatch","highestScore","matchReason","normalizedColumn","patterns","pattern","similarity","confidence","reason","round","isColumnCompatibleWithField","sampleValues","targetField","validValues","isCompatible","validPercentage","validCount","cleanedStr","num","isFinite","validBooleanValues","str","ColumnMapper","fileColumns","columnMappings","sampleData","onMappingChange","availableFields","mappedFields","Set","m","missingFields","has","validMappings","getConfidenceIcon","getConfidenceLabel","Warning","ErrorIcon","idx","CardContent","getSampleValues","autoDetected","isAlreadyMapped","Help","ImportPreview","previewRows","maxRows","showAll","setShowAll","expandedRow","setExpandedRow","displayRows","hasMore","formatCellValue","getRowIcon","getRowColor","TableContainer","Table","stickyHeader","TableHead","TableRow","TableCell","TableBody","isExpanded","hasIssues","mappedData","hasError","hasWarning","w","handleToggleRow","ExpandLess","ExpandMore","colSpan","errorIndex","warning","warningIndex","ValidationSummary","summary","totalRows","validRows","rowsWithWarnings","rowsWithErrors","willImport","conversions","LinearProgress","dense","ListItemIcon","SwapHoriz","conversion","Info","affectedRows","fromType","toType","TypeConverterPanel","expandedIndex","setExpandedIndex","fieldMetadata","handleToggleExpand","example","exIndex","fontFamily","original","converted","JSON","stringify","STORAGE_KEY","loadMappingTemplates","stored","localStorage","getItem","template","createdAt","lastUsed","logError","MappingTemplateManager","onApplyTemplate","templates","setTemplates","selectedTemplate","setSelectedTemplate","snackbarOpen","setSnackbarOpen","snackbarMessage","setSnackbarMessage","snackbarSeverity","setSnackbarSeverity","deleteConfirmOpen","setDeleteConfirmOpen","templateToDelete","setTemplateToDelete","loadTemplates","loaded","handleDeleteCancel","ListItemSecondaryAction","edge","templateId","Delete","accept","_event$target$files","file","files","reader","FileReader","onload","_e$target","jsonData","importedTemplates","currentTemplates","importedCount","setItem","importTemplates","readAsText","htmlFor","FileUpload","FileDownload","handleExport","json","href","download","revokeObjectURL","exportTemplates","handleApply","Snackbar","autoHideDuration","anchorOrigin","vertical","horizontal","handleDeleteConfirm","filteredTemplates","deleteMappingTemplate","STEPS","ImportMappingDialog","onImport","currentStep","setCurrentStep","fileData","setFileData","setColumnMappings","setPreviewRows","validationSummary","setValidationSummary","isProcessing","setIsProcessing","showTemplateManager","setShowTemplateManager","saveTemplateName","setSaveTemplateName","showSaveTemplate","setShowSaveTemplate","skipErrorRows","createTagsFromUnmapped","parseFile","validateData","_file$name$split$pop","parsedData","pop","parseCSV","parseExcel","detectedMappings","usedFields","add","detectColumnMapping","columns","correctedMappings","corrections","compatibility","originalTarget","validateAndCorrectMappings","correctionMessages","c","Promise","resolve","reject","Uint8Array","workbook","worksheet","Sheets","SheetNames","sheet_to_json","fileType","rowCount","onerror","readAsArrayBuffer","parseCSVLine","line","inQuotes","char","nextChar","_e$target2","lines","allErrors","originalType","validateImportData","Close","Stepper","activeStep","Step","StepLabel","Folder","Save","handleSaveTemplate","existingIndex","findIndex","newTemplate","aDate","splice","saveMappingTemplate","handleMappingChange","hasPairTags","startsWith","hasSession","handleBack","handleNext","validateRequiredFieldsMapped","col","pairColumnMapping","colName","handleImport","validTrades","templateMap","mergedMappings","currentMapping","templateMapping","updateTemplateLastUsed","DEFAULT_SCORE_SETTINGS","weights","consistency","riskManagement","performance","discipline","thresholds","minTradesForScore","lookbackPeriod","consistencyTolerance","targets","profit_factor","max_drawdown","avgRiskReward","excludedTagsFromPatterns","WorkerManager","constructor","workerFactory","worker","pendingRequests","messageIdCounter","handleMessage","response","pending","stack","payload","handleError","clear","terminate","ensureWorker","addEventListener","request","timeoutMs","postMessage","removeEventListener","isActive","tagPatternWorkerManager","getTagPatternWorkerManager","workerCode","Worker","createInlineWorker","tagPatternService","minTradesForAnalysis","minTradesForCombination","recentPeriodDays","historicalPeriodDays","analyzeTagPatterns","settings","recentCutoff","subDays","historicalCutoff","recentTrades","historicalTrades","combinations","excludedTags","minTrades","manager","generateTagCombinationsInWorker","generateTagCombinations","analyzedCombinations","combo","analyzeTagCombination","topCombinations","winRateDiff","decliningCombinations","trend","recentWinRate","historicalWinRate","insights","generateInsights","marketConditionAlerts","generateMarketConditionAlerts","tagPairs","tagTriples","pair","k","triple","matchingTrades","every","recentMatchingTrades","historicalMatchingTrades","wins","losses","winRate","avgPnL","recentWins","recentTotal","historicalWins","historicalTotal","tagCombination","recommendation","winRateDecline","alerts","sessionTag","getTagCombinationStats","scoreService","dynamicRiskSettings","updateDynamicRiskSettings","calculateScore","period","scoreSettings","periodTrades","getTradesForPeriod","lookbackDays","preferredSessions","commonTags","avgTradesPerDay","avgTradesPerWeek","avgPositionSize","tradingDays","cutoffDate","sessionCounts","acc","tagCounts","_ref4","_ref5","_ref6","normalizeTradeAmount","riskRewardTrades","profitFactor","normalizedTrades","peak","runningPnL","tradeAmount","drawdown","dayOfWeekCounts","dayOfWeek","getDay","tradingDaysArray","_ref7","_ref8","calculateTradingPattern","getHistoricalTrades","calculateConsistencyScore","score","factors","sessionConsistency","tagConsistency","timingConsistency","sizeConsistency","sessionTrades","tagTrades","avgTradeSize","sizeDeviation","calculateRiskManagementScore","riskRewardRatio","positionSizing","maxDrawdownAdherence","stopLossUsage","rrTrades","avgRR","rrDeviation","tradeSizes","avgSize","sizeVariance","pow","sizeStdDev","sqrt","lossTrades","avgLoss","winTrades","avgWin","calculatePerformanceScore","winRateConsistency","profitFactorStability","returnsConsistency","volatilityControl","currentWinRate","currentProfitFactor","winRateDeviation","pfDeviation","dailyReturns","avgReturn","ret","returnVariance","returnStdDev","calculateDisciplineScore","tradingPlanAdherence","emotionalControl","overtrading","ruleFollowing","sessionAdherence","sizeCoeffVar","currentFrequency","expectedFrequency","frequencyRatio","rulesFollowed","overall","finalOverall","currentScore","breakdown","calculateTrend","tagPatternAnalysis","recommendations","strengths","weaknesses","generateRecommendations","insight","getScoreHistory","periodsBack","history","today","dateFns","analysis","metrics","reverse","tradeDate","weekStartsOn","now","isCurrentPeriod","currentTrades","previousDate","setMonth","setFullYear","previousTrades","calculateSimpleScore","scoreDifference","threshold","updateSettings","newSettings","getSettings","calculateMultiPeriodScore","tradesCount","sampleTrade","daily","weekly","monthly","yearly","all","getScoreSummary","weeklyAnalysis","lowestScore","keyMetric","currentWeekly","compact","getScoreColor","getTrendIcon","TrendingDown","TrendingFlat","getTrendColor","ProgressBar","white","getDetailedTooltip","componentName","scoreComponents","Rule","Shield","Timeline","Psychology","direction","HelpOutline","expanded","setExpanded","scoreCategories","formatFactorName","factorKey","getScoreTooltip","categoryName","getFactorTooltip","rec","strength","weakness","category","Accordion","panel","AccordionSummary","expandIcon","flexGrow","AccordionDetails","factorValue","onPeriodChange","availablePeriods","allPeriodTabs","periodTabs","tab","chartData","entry","dateLabel","CustomTooltip","active","averageScore","latestScore","scoreChange","RoundedTabs","tabs","activeTab","currentPeriod","onTabChange","handlePeriodTabChange","newIndex","_periodTabs$newIndex","newPeriod","ResponsiveContainer","AreaChart","x1","y1","x2","y2","offset","stopColor","stopOpacity","CartesianGrid","strokeDasharray","stroke","XAxis","dataKey","tick","fill","YAxis","domain","Area","strokeWidth","LineChart","Legend","Line","dot","onExcludedTagsChange","propAllTags","tagSet","availableTags","groupedAvailableTags","categoryTags","newExcludedTags","handleAddAllInCategory","handleAddTag","useFlexGap","handleRemoveTag","tagToRemove","deleteIcon","tagStats","percentage","newSelectedTags","handleClearAll","onSettingsChange","isSaving","localSettings","setLocalSettings","hasChanges","setHasChanges","handleWeightChange","newWeights","weight","otherComponents","remaining","otherTotal","handleThresholdChange","handleTargetChange","weightTotal","RestoreRounded","handleReset","SaveRounded","handleSave","InfoOutlined","FormLabel","Slider","step","marks","TagSelector","ExcludedTagsSelector","selectedDate","setAnalysis","setIsLoading","calculateAnalysis","getInsightIcon","getSeverityColor","getWinRateColor","formatWinRate","defaultExpanded","timePeriod","isXs","setActiveTab","scorePeriod","historyPeriod","setHistoryPeriod","setSettings","setSelectedTags","setIsSaving","isCalculating","setIsCalculating","isLoadingHistory","setIsLoadingHistory","isLoadingMultiPeriod","setIsLoadingMultiPeriod","scoreAnalysis","setScoreAnalysis","scoreHistory","setScoreHistory","multiPeriodScores","setMultiPeriodScores","scoreHistoryCache","breakdownModalOpen","setBreakdownModalOpen","selectedBreakdownData","setSelectedBreakdownData","updatedSettings","calculateScoreAnalysis","cacheKey","settingsKey","cachedHistory","monthStart","monthEnd","entryDate","yearStart","yearEnd","firstKey","next","calculateScoreHistory","debug","scores","dailyScore","weeklyScore","monthlyScore","yearlyScore","calculateMultiPeriodScores","handleScoreCardClick","handleCloseBreakdownModal","handleSettingsSave","tagsOverride","score_settings","savedSettings","parsedSettings","handleTabChange","TabPanel","ScoreCard","ScoreHistory","TagPatternAnalysis","ScoreSettingsComponent","fullScreen","ScoreBreakdown","getFilteredTrades","isSameMonth","getTagDayOfWeekChartData","winRateMetric","tradesByDay","dayTrades","dayIndex","COLORS","neutral","sunday","monday","tuesday","wednesday","thursday","friday","saturday","dayData","fullDay","win_trades","loss_trades","chartBarHeights","random","Skeleton","barHeight","CustomYAxisTick","x","y","formattedValue","formatValue","dy","textAnchor","dailyChange","targetValue","setMultipleTradesDialog","axisLine","tickLine","ReferenceLine","fillOpacity","baseValue","activeDot","cx","cy","r","dataPoint","formattedDate","fullDate","CustomDailyPnLYAxisTick","isWin","isLoss","drawdownViolationValue","BarChart","Bar","radius","Cell","PnLChartsWrapper","CumulativePnLChart","DailyPnLChart","winLossData","onPieClick","innerHTML","head","win","loss","zero","breakEven","chartStyle","className","PieChart","outline","tabIndex","Pie","labelLine","outerRadius","innerRadius","percent","paddingAngle","cornerRadius","fillColor","verticalAlign","align","layout","iconSize","iconType","wrapperStyle","paddingTop","marginTop","winLossStats","bestWin","best","worstLoss","worst","winners","losers","formatCurrency","avgAmount","maxConsecutive","avgConsecutive","showClearButton","showApplyButton","handleClearTags","popper","DIALOG_POPUP","PerformanceCalculationService","getInstance","instance","calculateTagPerformanceFromTrades","primaryTags","secondaryTags","primaryTag","filteredTrades","_trade$tags2","breakevens","totalPnl","avgPnl","maxWin","maxLoss","avg_pnl","max_win","max_loss","performanceCalculationService","setPrimaryTags","setSecondaryTags","primaryTagsDialogOpen","setPrimaryTagsDialogOpen","secondaryTagsDialogOpen","setSecondaryTagsDialogOpen","filteredTagStats","setFilteredTagStats","calculateFilteredStats","tagData","MuiTooltip","TagFilterDialog","maxBarSize","stackId","endsWith","_trade$tags3","_trade$tags4","selectedMetric","setSelectedMetric","setChartData","chartDataResult","calculateData","Infinity","tickFormatter","showChartInfo","dailySummaryData","setPage","rowsPerPage","setRowsPerPage","paginatedData","startIndex","endIndex","TablePagination","rowsPerPageOptions","onPageChange","handleChangePage","newPage","onRowsPerPageChange","sessionStats","SESSION_COLORS","gridAutoRows","_session$win_rate","_session$win_rate2","_session$pnlPercentag","_session$pnlPercentag2","_trade$session","_session$session","tradeIds","averagePnL","pnlPercentage","sessionsWithTrades","mostProfitable","highestWinRate","bestAverage","_mostProfitable$win_r","_mostProfitable$win_r2","_highestWinRate$win_r","leastLosing","onTradeExpand","economicFilter","mostRecentTrade","latest","tradeStats","containWins","containLosses","containBoth","isMounted","totalTradesSum","fetchChartData","setTotalPnL","RechartsTooltip","riskRewardStats","average","getFlagUrl","flagCode","economicCorrelations","selectedImpact","setSelectedImpact","selectedCurrency","setSelectedCurrency","losingTradeCorrelations","setLosingTradeCorrelations","winningTradeCorrelations","setWinningTradeCorrelations","correlationStats","setCorrelationStats","totalLosingTrades","totalWinningTrades","highImpactLossCorrelationRate","mediumImpactLossCorrelationRate","anyEventLossCorrelationRate","highImpactWinCorrelationRate","mediumImpactWinCorrelationRate","anyEventWinCorrelationRate","losingTradesWithHighImpact","losingTradesWithMediumImpact","losingTradesWithAnyEvents","winningTradesWithHighImpact","winningTradesWithMediumImpact","winningTradesWithAnyEvents","avgLossWithEvents","avgLossWithoutEvents","avgWinWithEvents","avgWinWithoutEvents","mostCommonEventTypes","impactTabs","CURRENCY_OPTIONS","currencyTags","flat","getCurrenciesForPair","currency","impactData","high","medium","filterByCurrency","correlations","correlation","_correlation$economic","economic_events","losingTrades","winningTrades","Analytics","currentImpact","handleImpactTabChange","_impactTabs$newIndex","newImpact","InputLabel","EventNote","losingTradesWithEvents","winningTradesWithEvents","eventType","_eventType$economicEv","economicEventDetails","src","alt","objectFit","onError","avg_loss","avg_win","TIME_PERIOD_TABS","TAG_ANALYSIS_TABS","PERFORMANCE_TABS","PerformanceCharts","selectedDateProp","monthlyTargetProp","accountBalanceProp","maxDailyDrawdown","maxDailyDrawdownProp","scoreSettingsProp","tabSize","timePeriodProp","onTimePeriodChange","hideTimePeriodTabs","onPrimaryTagsChange","onSecondaryTagsChange","dynamicRiskSettingsProp","chartHeights","large","tradeSync","useTradeSyncContextOptional","lastProcessedTimestamp","internalTimePeriod","setInternalTimePeriod","setTimePeriod","performanceTab","setPerformanceTab","advancedTabVisited","setAdvancedTabVisited","tagAnalysisTab","setTagAnalysisTab","internalTrades","setInternalTrades","isLoadingData","setIsLoadingData","defaultDate","economicFilterFn","economic_calendar_filters","DEFAULT_ECONOMIC_EVENT_FILTER_SETTINGS","tradesDialog","setTradesDialog","tradeIdsString","tradesMap","updatedDialogTrades","dialogTrade","zoomedImages","setZoomedImages","performanceData","setPerformanceData","setEconomicCorrelations","calculationError","setCalculationError","dateAtNoonUTC","UTC","getNormalizedDate","rpcResult","chartError","rpc","p_calendar_id","p_time_period","p_selected_date","fetchedTrades","created_at","chartRpcData","performanceMetrics","tradesByDate","dateKey","toDateString","transformedChartData","array","prevCumulativePnl","cumulativePnl","itemDate","isIncreasing","isDecreasing","isBreakEven","loadAllData","lastSyncEvent","timestamp","normalizedTrade","normalizeTradeDates","prevTrades","tradeIndex","updatedTrades","filteredCount","handleTradeExpand","handleZoomImage","allImages","initialIndex","selectetdImageIndex","handleTagAnalysisTabChange","handlePieClick","categoryTrades","dateText","ImageZoomDialog","imageProp","TradesListDialog","handleTimePeriodTabChange","_TIME_PERIOD_TABS$new","alignSelf","ShimmerChartLoader","RiskRewardChart","WinLossStats","WinLossDistribution","DailySummaryTable","ScoreSection","TagPerformanceAnalysis","TagDayOfWeekAnalysis","SessionPerformanceAnalysis","EconomicEventCorrelationAnalysis","onImportTrades","onClearMonthTrades","showClearConfirm","setShowClearConfirm","menuAnchorEl","setMenuAnchorEl","menuOpen","showImportDialog","setShowImportDialog","isPerformanceDialogOpen","setIsPerformanceDialogOpen","performanceTimePeriod","setPerformanceTimePeriod","selectedFile","setSelectedFile","monthTrades","netAmountForThisMonth","lossCount","totalWinAmount","totalLossAmount","dailyPnL","bestDay","bestDayDate","worstDay","worstDayDate","bestEntry","worstEntry","startOfCurrentMonth","calculatePercentageOfValueAtDate","tradesBeforeMonth","isTargetMet","handleMenuClose","handleSnackbarClose","handleMonthlyGalleryMode","monthName","currentTarget","MoreVert","Menu","anchorEl","transformOrigin","_document$getElementB","getElementById","handleClearClick","handleClearConfirm","importedTrades","AccountBalance","totalProfit","onPerformanceClick","onToggleDynamicRisk","isDynamicRiskToggled","profitPercentage","effectiveRiskPercentage","totalAccountValue","SecurityIcon","minimumFractionDigits","maximumFractionDigits","DrawdownIcon","enterDelay","leaveDelay","pinnedTrades","setPinnedTrades","isLoadingPinned","setIsLoadingPinned","calendarService","fetchPinnedTrades","loadPinnedTrades","pinnedEvents","pinned_events","sortedPinnedTrades","filteredPinnedTrades","_trade$name","_trade$economic_event","_trade$notes","filteredPinnedEvents","pinnedEvent","_pinnedEvent$notes","PinIcon","ClearIcon","impactColor","getImpactColor","impact","event_id","event_name","flag_url","country","actual_result_type","event_time","time_utc","actual_value","forecast_value","previous_value","event_date","handleEventClick","NoteIcon","_calendar$year_stats$","_calendar$year_stats","_calendar$year_stats$2","initialTradeId","setZoomedImage","aiOnlyMode","fetchYear","scrollContainerRef","isLoadingTrades","setIsLoadingTrades","hasMoreTrades","setHasMoreTrades","initialTotalCount","totalTradeCount","setTotalTradeCount","isFetchMode","effectiveTrades","currentIndex","setCurrentIndex","safeCurrentIndex","currentTrade","getTradesForYearPaginated","fetchInitialTrades","loadMoreTrades","nextPage","previousTradeIdRef","aiChat","currentTradeId","tradeContext","tradeQuestionTemplates","tradeName","tradeType","questions","handleNewChat","handleDeleteConversation","isAtEnd","isAtStart","isLoadingNext","navigateNext","navigatePrevious","scrollUp","scrollBy","behavior","scrollDown","handleKeyDown","window","isInitialLoading","TOOLTIP","wordBreak","overflowWrap","CalendarIcon","ArrowForwardIcon","TradeIcon","AssistantIcon","BackIcon","TradeDetailExpanded","tradeData","animate","showAIButton","questionTemplates","autoScroll","slideInAnimation","keyframes","_templateObject","_taggedTemplateLiteral","slideUpAnimation","_templateObject2","totalCards","isHovered","hasAnimated","colorMap","pink","purple","deepPurple","indigo","lightBlue","cyan","teal","lightGreen","lime","yellow","amber","deepOrange","brown","blueGrey","getColorMap","isDark","baseColor","stackedTransform","fannedTransform","floor","animationDelay","animation","textShadow","fullDayName","onNoteSaved","onNoteDeleted","editorOpen","setEditorOpen","contentRef","scrollTop","handlePrevious","handleEditNote","handleEditorClose","handleNoteSaved","savedNote","isCreated","handleNoteDeleted","currentNote","hasMultipleNotes","EventNoteIcon","ChevronLeftIcon","ChevronRightIcon","EditIcon","cover_image","RichTextEditor","hideCharacterCount","updateNote","removeNote","setNotes","currentDayAbbr","loadReminderNotes","fetchedNotes","getReminderNotesForDay","isReminderForToday","_note$reminder_days","is_reminder_active","is_archived","reminder_type","reminder_days","useRealtimeSubscription","channelName","enabled","onChannelCreated","channel","on","_payload$payload","record","newNote","n","_payload$payload2","oldNote","old_record","isCurrentlyRelevant","wasRelevant","updated","_payload$payload3","onSubscribed","reloadNotes","useReminderNotes","setIsHovered","bottomSheetOpen","setBottomSheetOpen","initialNoteIndex","setInitialNoteIndex","setHasAnimated","visibleNotes","handleWidgetClick","handleBottomSheetClose","onMouseEnter","onMouseLeave","FLOAT_NAVIGATION","PlaceholderNoteCard","reversedIndex","originalIndex","displayIndex","displayTotal","NoteCard","NotesBottomSheet","isVisible","onPrevMonth","onNextMonth","onMonthClick","hideByTopScroll","setHideByTopScroll","isToday","update","doc","documentElement","scrollable","scrollHeight","innerHeight","scrollY","passive","finalVisible","Slide","mountOnEnter","DEFAULT_FILTER_SETTINGS","currencies","impacts","viewType","WATCHER_CONFIG","refreshOnStart","maxRefreshAge","economicEventWatcher","watchedEventGroups","callbacks","eventQueues","getRefreshKey","shouldRefreshData","lastRefreshStr","lastRefresh","timeSinceRefresh","shouldRefresh","saveRefreshTime","initialize","startWatching","economicCalendarFilters","refreshCalendarData","initializeEventQueue","watchNextEventFromQueue","_responseData$foundEv","callError","functions","invoke","responseData","updatedCount","foundEventsCount","foundEvents","existingQueue","arraysEqual","dayStart","dayEnd","endOfDay","dateRange","start","end","todaysEvents","economicCalendarService","fetchEventsPaginated","onlyUpcoming","upcomingEvents","events","lastFetched","queue","eventGroup","getNextEventGroup","watchEventGroup","releaseTime","val","stopWatching","watchKey","watched","timeoutId","stopAllWatching","clearRefreshCache","removeItem","clearAllRefreshCaches","keysToRemove","timeUntilRelease","triggerEventGroupUpdate","existing","batchEvents","currencyToCountry","originalEvent","unmappedCount","updatedEvents","results","succeeded","failed","batchEvent","fetchedData","eventToNotify","cached","unmappedEvents","eventIds","onEventsUpdated","continueWatching","refreshedQueue","getWatchingStatus","queueStatus","totalEvents","minutesSinceRefresh","needsRefresh","watchedEventsCount","eventCount","isRemoving","setOpen","handleClose","trendInfo","getTrendInfo","NeutralIcon","TrendingUpIcon","TrendingDownIcon","actual","forecast","getContrastText","parseISO","actualResultType","getActualResultStyle","CACHE_PREFIX","useHighImpactEvents","highImpactEventDates","setHighImpactEventDates","lastUpdated","setLastUpdated","currenciesKey","cleanupKey","lastCleanup","cleanupExpiredCache","clearOldCurrencyCache","monthKey","currenciesHash","cacheExpiryKey","cacheMetaKey","cachedData","cacheExpiry","cacheMeta","isPreviousMonth","targetMonth","targetYear","Number","MAX_SAFE_INTEGER","getCacheDuration","cacheAge","cacheAgeHours","currenciesInfo","eventDatesMap","meta","parseError","startOfMonth","endOfMonth","fetchEvents","limit","cacheData","metaData","monthType","expiryTime","getNextSundayExpiry","daysUntilSunday","nextSunday","setHours","cacheTypeMsg","fetchError","fetchHighImpactEvents","newCurrencies","newCurrenciesHash","cleanedCount","skippedPermanent","expiry","baseKey","playNotificationSound","audio","Audio","volume","playPromise","play","audioContext","AudioContext","webkitAudioContext","oscillator","createOscillator","gainNode","createGain","connect","destination","frequency","setValueAtTime","currentTime","exponentialRampToValueAtTime","gain","linearRampToValueAtTime","stop","close","fallbackError","useCalendarTrades","selectedCalendar","enableRealtime","setLoading","setTradesMap","setCalendar","notification","setNotification","updatingTradeIds","setUpdatingTradeIds","tradesCache","cacheAccessOrderRef","calendarUpdateTimeoutRef","pendingCalendarUpdateRef","startTransition","useTransition","updateTradesMap","updater","clearNotification","setTradesFromArray","tradesArray","newMap","generateMonthCacheKey","padStart","generateRangeCacheKey","getCachedTrades","orderArray","setCachedTrades","oldestKey","shift","clearTradesCache","updateTradeInCache","removedCount","addedCount","cachedTradesMap","hadTrade","shouldHaveTrade","yearMonth","startISO","endISO","removeTradeFromCache","fetchAllTrades","getCalendar","getAllTrades","addTrade","setTradeUpdating","broadcastTradeInsert","deleteTrades","previousMap","deletedTrades","deleteTrade","broadcastTradeDelete","handleToggleDynamicRisk","useActualAmounts","totalBatches","ceil","batchIndex","batch","effectiveRisk","calculateEffectiveRiskPercentageAsync","riskAmount","calculateRiskAmount","newAmount","calculateCalendarStats","recalculateTrades","handleImportTrades","importTrades","updatedCalendarData","newTrade","updatedTrade","_payload$payload4","deletedTrade","handleAccountBalanceChange","updateCalendar","newBalance","handleClearMonthTrades","tradesToDelete","bulkDelete","handleUpdateCalendarProperty","updatedCalendar","updateCallback","invokeError","old_tag","new_tag","loadMonthTrades","cachedTrades","getTradesByMonth","loadVisibleRangeTrades","rangeTrades","getTradesByDateRange","handleUpdateTradeProperty","createIfNotExists","existingTrade","getTrade","finalTrade","updateTrade","broadcastTradeUpdate","WeeklyPnL","weekIndex","weeklyTarget","weekStats","netAmount","targetProgressValue","isCurrentWeek","isSameWeek","weeklyTargetAmount","remainingAmount","cappedProgress","tooltipContent","createNewTradeData","uuidv4","pending_images","uploaded_images","TagFilter","onOpenDrawer","FilterAlt","Clear","CalendarDayCell","monthlyHighImpactEvents","onDayClick","isMdDown","dayStats","isCurrentMonth","isCurrentDay","dayDateString","hasHighImpactEvents","StyledCalendarDay","$isCurrentMonth","$isCurrentDay","$dayStatus","status","DayNumber","TradeAmount","TradeCount","isDrawdownViolation","TradeCalendar","_calendar$economic_ca","_weeklyStatsMap$get2","onToggleTheme","calendarIdFromParams","useParams","hookCalendar","handleAddTrade","handleDeleteTrades","handleTagUpdated","hookHandleImportTrades","showSnackbar","calendarName","heroImageUrl","heroImageAttribution","_calendarId","setSelectedDate","isMonthSelectorOpen","setIsMonthSelectorOpen","setNewTrade","setShowAddForm","setZoomedImagesState","setTradesToDelete","isDeleteDialogOpen","setIsDeleteDialogOpen","deletingTradeIds","setDeletingTradeIds","deleteError","setDeleteError","sessionTradesDialog","setSessionTradesDialog","isTagManagementDialogOpen","setIsTagManagementDialogOpen","isTagManagementDrawerOpen","setIsTagManagementDrawerOpen","isSearchDrawerOpen","setIsSearchDrawerOpen","setIsDynamicRiskToggled","showFloatingMonthNav","setShowFloatingMonthNav","pinnedTradesDrawerOpen","setPinnedTradesDrawerOpen","galleryMode","setGalleryMode","isCalendarEditOpen","setIsCalendarEditOpen","isCalendarEditSubmitting","setIsCalendarEditSubmitting","isEconomicCalendarOpen","setIsEconomicCalendarOpen","isAIChatOpen","setIsAIChatOpen","isNotesDrawerOpen","setIsNotesDrawerOpen","notifications","setNotifications","removingNotifications","setRemovingNotifications","economicCalendarUpdatedEvent","setEconomicCalendarUpdatedEvent","userCalendars","setUserCalendars","calendarRepo","CalendarRepository","calendars","findByUserId","loadUserCalendars","breadcrumbButtons","tooltip","breadcrumbRightContent","ShareButton","onUpdateItemProperty","breadcrumbItems","dropdownItems","cal","path","HomeIcon","dropdown","watchingStatus","_economic_calendar_fi","_economic_calendar_fi2","isInitialized","stableFilters","allEvents","dispatchEvent","CustomEvent","detail","useEconomicEventWatcher","callback","visibleStart","startOfWeek","visibleEnd","endOfWeek","updatedCalendarId","_calendar$economic_ca2","_calendar$economic_ca3","notificationsEnabled","addNotification","handleEventsUpdate","catch","oldestNotification","prevRemoving","newSet","handleToggleEconomicCalendar","handleToggleAIChat","ticking","handleScroll","requestAnimationFrame","section","querySelector","rect","getBoundingClientRect","_map$get","tradesForSelectedDay","sessionDialogTrades","dayStatsMap","eachDayOfInterval","dayKey","calculateDayStats","dayDate","effectiveMaxDailyDrawdown","calculateEffectiveMaxDailyDrawdown","percentageValue","weeklyStatsMap","eachWeekOfInterval","weekStart","weekKey","calculateSessionStats","sessionName","totalTradesForWinRate","handlePrevMonth","subMonths","handleNextMonth","addMonths","handleTodayClick","handleDeleteMultipleTrades","handleConfirmDelete","successMessage","errorMessage","handleDayClick","showDayDialogWhenDone","handleMonthClick","handleTagsChange","openGalleryMode","openGalleryModeAI","handleEditTrade","createEditTradeData","editTrade","createTempTrade","AnimatedBackground","FloatingMonthNavigation","onTodayClick","inset","Fade","Breadcrumbs","items","buttons","rightContent","StackedNotesWidget","AccountStats","MonthlyStats","order","backgroundClip","WebkitBackgroundClip","WebkitTextFillColor","Today","NotesIcon","_weeklyStatsMap$get","weekDays","_dayStatsMap$get","DayDialog","TradeFormDialog","image","onCancel","showForm","onAddTrade","newMainTrade","setNewMainTrade","onDeleteTrades","onAccountBalanceChange","SelectDateDialog","TagManagementDrawer","TagManagementDialog","ConfirmationDialog","confirmText","cancelText","onConfirm","confirmColor","SNACKBAR","retryDeletion","Fab","SearchDrawer","PinnedTradesDrawer","TradeGalleryDialog","closeGalleryMode","CalendarFormDialog","formData","AIChatDrawer","NotesDrawer","EconomicEventNotification","handleCloseNotification","parseDate","dateValue","fallback","transformSupabaseConversation","serializeMessages","generateConversationTitle","toLocaleDateString","ConversationRepository","AbstractBaseRepository","super","findById","findByCalendarId","_options$limit","_options$offset","countError","is","ascending","range","findByTradeId","_options$limit2","_options$offset2","findAll","createInSupabase","entity","conversationData","trade_id","insert","updateInSupabase","updates","updateData","deleteInSupabase","saveConversation","conversationTitle","_updateResult$error","_updateResult$error$m","updateResult","create","parseSupabaseError","operation","deleteByCalendarId","CONVERSATIONS_PAGE_SIZE","MESSAGE_LIMIT_DEFAULT","setIsTyping","setToolExecutionStatus","currentConversationId","setCurrentConversationId","setConversations","setLoadingConversations","setLoadingMoreConversations","setHasMoreConversations","setTotalConversationsCount","setIsAtMessageLimit","editingMessageId","setEditingMessageId","conversationRepo","abortControllerRef","cancelRequestedRef","activeRequestRef","messageUpdateTimeoutRef","pendingTextRef","parseQuotaError","errorCode","errorReason","jsonMatch","errorJson","_errorJson$error$deta","_errorJson$error$deta2","details","_unused","isApiKeyError","isQuotaError","userMessage","retryMatch","retryDelay","userHasApiKey","hasApiKey","seconds","currentOffset","saveCurrentConversation","updatedMessages","abort","aiId","messageText","trimmedMessage","baseHistory","messageIndex","originalMessage","aiMessageId","aiMessageAdded","abortController","AbortController","citations","embeddedTrades","embeddedEvents","accumulatedText","messageHtml","toolCallsInProgress","_iteratorError","_iteratorAbruptCompletion","_didIteratorError","_step","_iterator","_asyncIterator","supabaseAIChatService","sendMessageStreaming","signal","done","newMessage","return","finalMessage","conversationMessages","errorDetails","quotaErrorInfo","chatError","retryable","messageId","messageToEdit","editMessage","clearEditingState","resultText","calendarInfo","historyNote","NoteListItem","onPin","onArchive","onUnarchive","showCalendarBadge","plainText","convertFromRaw","getPlainText","extractPlainText","contentPreview","is_pinned","ReminderIcon","titleAccess","by_assistant","getTagDisplayLabel","PinOutlinedIcon","UnarchiveIcon","ArchiveIcon","_imageProp$useSolidBa","imageArray","imageData","setImageData","currentImageUrl","isAIChart","useSolidBackground","scale","setScale","setPosition","isDragging","setIsDragging","dragStart","setDragStart","imageRef","containerRef","resetZoom","handleGlobalMouseUp","onWheel","newScale","deltaY","onMouseDown","clientX","clientY","onMouseMove","newX","newY","imageRect","maxX","maxY","boundedX","boundedY","onMouseUp","userSelect","ZoomInIcon","RestartAltIcon","setImages","loading","isFromCache","setIsFromCache","dialogBaseProps","dialogProps","getDialogProps","UNSPLASH_ACCESS_KEY","process","popularSearches","generatePlaceholderImages","selectedCategory","cat","urls","small","regular","full","links","download_location","html","alt_description","username","handleSearchImages","cachedImages","unsplashCache","getCachedImages","fetch","encodeURIComponent","Authorization","ok","cacheImages","placeholderImages","removeExpiredEntries","modal","onKeyDown","CachedIcon","getEnhancedPopularSearches","combined","getPopularQueries","search","isRecentQuery","isCached","handlePopularSearchClick","getCacheStats","totalEntries","totalSize","clearCache","overflowY","overflowX","CardActionArea","highQualityUrl","photographerUsername","photographerUrl","unsplashUrl","altDescription","handleImageClick","Link","rel","textDecoration","borderBottomColor","transformSupabaseNote","archived_at","NoteRepository","findByTag","contains","queryByUserId","isPinned","isArchived","byAssistant","or","queryByCalendarId","archiveNote","unarchiveNote","moveNoteToCalendar","pinNote","unpinNote","findRemindersByDay","dayAbbreviation","findRemindersByDate","noteWithTimestamps","updatesWithTimestamp","noteRepository","getUserNotes","queryUserNotes","getNotesByTag","getCalendarNotes","queryCalendarNotes","getNote","createNote","_noteInput$cover_imag","_noteInput$by_assista","noteData","noteInput","_result$error","_result$error2","deleteNote","_result$error3","providedTrades","_calendar$year_stats2","_yearStats$monthly_st2","accountValueAtMonthStart","totalPreviousYearsPnL","statsYear","cumulativePnLAtMonthStart","targetTime","calculateCurrentEffectiveRiskPercentage","calculateCurrentTotalValue","excludeAfterDate","relevantTrades","baselineValue","baseRiskPercentage","isDynamicRiskActive","processTagsForSubmission","tagInput","pendingTag","is_temporary","column_width","onCalendarChange","editingTrade","setEditingTrade","isCreatingEmptyTrade","setIsCreatingEmptyTrade","setErrorMessage","showError","setShowError","precalculatedPnL","setPrecalculatedPnL","precalculatedRiskPercentage","setPrecalculatedRiskPercentage","isLoadingPrecalculatedValues","setIsLoadingPrecalculatedValues","originalRiskAmount","setOriginalRiskAmount","isMountedRef","isCreatingEmptyTradeRef","isCalendarSelectionMode","isCalendarSelected","tradeDateTimestamp","newTradeDateTimestamp","targetDateForPnL","getHours","getMinutes","getSeconds","isSameDay","riskPct","fetchPrecalculatedValues","prevShowFormRef","createEmptyTrade","generatedId","_prevShowFormRef$curr","_prevShowFormRef$curr2","shouldCreateTempTrade","prevShouldCreateTempTrade","_prevShowFormRef$curr3","_prevShowFormRef$curr4","_prevShowFormRef$curr5","prevEditTradeId","currentEditTradeId","derivedRiskAmount","showErrorSnackbar","handleCloseError","calculateFinalAmount","rr","calculatedAmount","calculateAmountFromRiskToReward","alternatePnL","currentPnL","riskToRewardValue","uploadImageAndTrackProgress","uploadedImage","caption","originalPendingImage","updatedImage","wasDeleted","newPendingImages","imageIndex","newUploadedImages","uploadedIndex","then","hasPendingUploads","validateRequiredTagGroups","effectiveRequiredGroups","DEFAULT_PAIRS_TAG_GROUP","valid","missingGroups","presentGroups","createFinalTradeData","finalAmount","finalTags","isTemporary","cleanupError","handleEditSubmit","updatedImages","updatedDate","labelId","MenuProps","TradeForm","calculateCumulativePnl","onNameChange","onAmountChange","onTypeChange","onEntryChange","onExitChange","onStopLossChange","onTakeProfitChange","onRiskToRewardChange","onPartialsTakenChange","onSessionChange","onNotesChange","_event","formattedTags","formatTagsWithCapitalizedGroups","onImageUpload","validFiles","oversizedFiles","invalidTypeFiles","validateFiles","FILE_SIZE_LIMITS","IMAGE_1MB","errorMessages","dimensions","Image","existingPendingImages","existingUploadedImages","maxRow","newImagesWithLayout","newRow","existingImages","newImages","tradeid","uploadPromises","successfulUploads","updatedImagesMap","existingImageIds","mergedImages","existingImg","updatedImg","newImagesToAdd","updateError","onImageCaptionChange","isPending","onImageRemove","imageId","onImagesReordered","uploadedImages","DEFAULT_NOTE_TAGS_MAP","_DEFAULT_NOTE_TAGS_MA","getTagSubtitle","_DEFAULT_NOTE_TAGS_MA2","initialNote","editorRef","isToolbarMenuOpen","setIsToolbarMenuOpen","editorMounted","setEditorMounted","setNote","setTitle","setContent","coverImage","setCoverImage","imagePickerOpen","setImagePickerOpen","saving","setSaving","deleting","setDeleting","reminderType","setReminderType","reminderDate","setReminderDate","reminderDays","setReminderDays","isReminderActive","setIsReminderActive","isReminderExpanded","setIsReminderExpanded","noteColor","setNoteColor","colorMenuAnchor","setColorMenuAnchor","setTags","newTagInput","setNewTagInput","isTagsExpanded","setIsTagsExpanded","hasExistingGuideline","setHasExistingGuideline","isGlobal","setIsGlobal","defaultTags","existingGuideline","notesService","checkGuideline","reminder_date","saveNote","titleChanged","contentChanged","coverImageChanged","reminderTypeChanged","reminderDateChanged","reminderDaysChanged","reminderActiveChanged","tagsChanged","colorChanged","globalChanged","hasNonEmptyTitle","hasNonEmptyContent","hasCoverImage","hasReminder","hasTags","handleArchiveNote","isTagEditingAllowed","Toolbar","EditorToolbar","editorState","stickyPosition","toolbarRef","onToggleInlineStyle","_editorRef$current","toggleInlineStyle","onToggleBlockType","blockType","_editorRef$current2","toggleBlockType","onApplyTextColor","_editorRef$current3","applyTextColor","onApplyBackgroundColor","_editorRef$current4","applyBackgroundColor","onApplyHeading","heading","_editorRef$current5","applyHeading","onClearFormatting","_editorRef$current6","clearFormatting","onLinkClick","_editorRef$current7","handleLinkClick","onImageClick","_editorRef$current8","onMenuOpenChange","isOpen","_editorRef$current9","setIsMenuOpen","handleRemoveCover","NoReminderIcon","handleDeleteNote","ToggleButtonGroup","exclusive","handleReminderTypeChange","newType","ToggleButton","allPresets","visiblePresets","hiddenPresets","preset","Popover","LocalizationProvider","dateAdapter","AdapterDateFns","RICH_TEXT_DIALOG","d","handleToggleDay","GlobalIcon","PrivateIcon","labelPlacement","getOptionLabel","inputValue","onInputChange","ListboxProps","disableUnderline","toolbarVariant","LOADING_PROGRESS","setNewTag","isDeleting","setIsDeleting","setOriginalDefinition","isLoadingDefinition","setIsLoadingDefinition","fetchDefinition","def","isGrouped","tagChanged","definitionChanged","trimmedTag","trimmedNewTag","getTagNamePart","safeOnClose","newGroupName","newTagName","speed","onComplete","isAnimating","displayedText","setDisplayedText","part","_lines$","language","codeContent","formatContent","formatEventValue","numericValue","suffix","formatted","eventId","eventData","setEvent","fetchedEvent","getEventById","fetchEvent","timeInfo","eventTime","isPassed","time","isUpcoming","formatTimeWithStatus","actualNum","forecastNum","CheckIcon","HourglassEmptyIcon","defaultVisibleCount","itemType","visibleCount","setVisibleCount","visibleItems","enableScrollable","pr","textColor","imageZoomOpen","setImageZoomOpen","imageZoomProp","setImageZoomProp","liveTradesMap","mergedEmbeddedTrades","merged","embeddedTrade","liveTrade","eventTradeCountMap","countMap","tradeEvent","eventMatchV3","contentSegments","segments","lastIndex","workingHtml","references","tradePattern","exec","eventPattern","notePattern","htmlSegment","sanitizeHtml","htmlContent","DOMPurify","sanitize","ALLOWED_TAGS","ALLOWED_ATTR","KEEP_CONTENT","sanitizedHtml","seg","DOMParser","parseFromString","querySelectorAll","container","handleContainerClick","_imageUrls$index","paddingLeft","renderContentSegments","nodes","currentTradeNodes","flushTrades","ExpandableCardList","segment","EventCard","hasText","dangerouslySetInnerHTML","__html","setAnchorEl","faviconErrors","setFaviconErrors","getToolColor","toolName","getToolLabel","getDomainFromUrl","hostname","getFaviconUrl","_unused2","handleFaviconError","uniqueCitations","citation","renderFavicon","faviconUrl","LanguageIcon","renderCitationsList","handleOpenUrl","OpenInNewIcon","AvatarGroup","marginLeft","ReactMarkdown","remarkPlugins","remarkGfm","components","table","thead","tbody","tr","th","td","inline","_ref9","h1","_ref10","h2","_ref11","h3","_ref12","ul","_ref13","ol","_ref14","li","_ref15","blockquote","_ref16","hr","strong","_ref17","em","_ref18","showTimestamp","isLatestMessage","enableAnimation","onEdit","copied","setCopied","isUser","isAssistant","PersonIcon","contrastText","HtmlMessageRenderer","AnimatedText","MarkdownRenderer","CitationsSection","navigator","clipboard","writeText","CopyIcon","getStatusIcon","createTagMentionComponent","TagMentionEntity","contentState","entityKey","getEntity","getData","contentEditable","createNoteMentionComponent","NoteMentionEntity","noteTitle","AtSymbolHidden","createMentionDecorator","CompositeDecorator","strategy","block","findEntityRanges","ch","getType","getText","AIChatMentionInput","forwardRef","setEditorState","EditorState","createWithContent","ContentState","createFromText","editorStateRef","mention","setMention","selectedIndex","setSelectedIndex","moveCursorToEndOnNextUpdate","useImperativeHandle","_focus","call","moveCursorToEnd","lastBlock","getCurrentContent","getLastBlock","lastBlockKey","getKey","getLength","selection","SelectionState","createEmpty","merge","anchorOffset","focusOffset","newState","forceSelection","_editorRef$current$fo","insertNote","state","getSelection","blockKey","getStartKey","newContent","getStartOffset","getBlockForKey","spaceSelection","Modifier","insertText","noteToken","insertOffset","insertSelection","createEntity","getLastCreatedEntityKey","entityRange","applyEntity","afterNote","cursorPosition","_editorRef$current2$f","currentText","_editorRef$current3$f","handleChange","sel","isCollapsed","at","lastIndexOf","updateMentionState","insertTag","atIndex","mentionText","replaceSel","replaceText","afterMention","_editorRef$current4$f","handleRemoveEntity","includeFollowingSpace","blocks","getBlocksAsArray","s","c2","removeRange","_focus2","ctrlKey","metaKey","altKey","ekBeforeSpace","getEntityAt","entityType","ek","Editor","readOnly","Popper","disablePortal","selected","defaultQuestionTemplates","showTemplates","showTemplatesProp","messagesEndRef","inputRef","inputMessage","setInputMessage","attachedImages","setAttachedImages","fileInputRef","notesAnchorEl","setNotesAnchorEl","availableNotes","setAvailableNotes","notesLoading","setNotesLoading","_inputRef$current","scrollToBottom","_messagesEndRef$curre","scrollIntoView","_messagesEndRef$curre2","handleSendMessage","imagesToSend","handlePaste","_event$clipboardData","clipboardData","getAsFile","dataUrl","readAsDataURL","mimeType","handleEditMessage","editData","_inputRef$current2","handleCloseNotesContext","displayMessages","shouldShowTemplates","ChatMessage","flatMap","categoryIndex","question","questionIndex","_inputRef$current3","handleTemplateClick","thickness","onPaste","shiftKey","handleImageUploadClick","_fileInputRef$current","sortedNotes","handleCancelRequest","StopIcon","SendIcon","ClickAwayListener","onClickAway","_inputRef$current4","handleInsertNoteContext","TagsInput","showWarning","setShowWarning","freeSolo","handleTagsChangeWithValidation","validTags","hasInvalidTags","otherProps","htmlInput","updatedTags","generateTradeNameSuggestions","currentInput","maxSuggestions","tradeNames","nameFrequency","inputLower","matchingNames","generateContextualTradeNameSuggestions","currentSession","contextualTrades","hasMatchingTags","hasMatchingSession","contextualNames","remainingSlots","generalNames","generateCommonTradeNamePatterns","commonPatterns","tradeNameSuggestions","setTradeNameSuggestions","suggestions","contextualSuggestions","uniquePatterns","fetchAndGenerateTradeNameSuggestions","fetchSuggestions","tagsWithPairs","CURRENCY_PAIRS","effectiveRequiredTagGroups","missingRequiredGroups","satisfiedGroups","handleRiskToRewardChange","numValue","FormField","calculateAmountFromRisk","InputLabelProps","shrink","MuiFormControlLabel","Checkbox","WebkitAppearance","MozAppearance","ImageUploader","pendingImages","ShimmerImageBox","shimmer","shimmerColor","willChange","setRows","draggingImage","setDraggingImage","dragOverRow","setDragOverRow","dragOverColumn","setDragOverColumn","resizingState","setResizingState","gridContainerRef","dragImageRef","newRows","organizeImagesIntoRows","columnWidth","_img$id","_img$id2","rowMap","maxDefinedRow","nextRowIndex","rIndex","_a$column","_b$column","totalDefinedWidth","undefinedWidthCount","cIndex","widthPerUndefined","scaleFactor","_image$column_width","equalWidth","finalRows","isPendingImage","isAnyImageUploading","handleDragOver","columnIndex","dataTransfer","dropEffect","handleDrop","targetRowIndex","targetColumnIndex","_rows$sourceRowIndex","sourceData","sourceRowIndex","sourceColumnIndex","isSourcePending","imageToMove","foundAtIndex","handleDragEnd","flatImages","actualSourceRowIndex","actualSourceColumnIndex","finalTargetRowIndex","finalTargetColumnIndex","widthPerColumn","_newRows$rIndex","sourceRowWidth","currentRowTotalWidth","cleanupDragImage","normalizeRowWidths","totalWidth","newTotal","largestColIndex","maxIndex","arr","handleResizeMouseMove","dividerIndex","startX","rowElementWidth","initialWidths","deltaPercent","targetRow","totalInitialLeftWidth","totalInitialRightWidth","newTotalLeftWidth","newTotalRightWidth","numLeftImages","numRightImages","minTotalLeftWidth","minTotalRightWidth","currentTotal","newWidth","handleResizeMouseUp","finalRowIndex","marginBottom","onDragOver","pendingImg","uploadedImg","isLastColumn","draggable","onDragStart","handleDragStart","setData","effectAllowed","element","offsetX","offsetY","dragImage","cloneNode","setDragImage","onDrop","onDragEnd","minRows","handleResizeMouseDown","rowElement","closest","onDragLeave","imageFiles","DataTransfer","AddPhotoAlternate","handleAddImageClick","organizeImagesVertically","reorganizedImages","_a$row","_b$row","aRow","bRow","aCol","bCol","ViewList","organizeImagesInGrid","sortedImages","_a$row2","_b$row2","_a$column2","_b$column2","GridView","ImageGrid","weekTradesProp","weekTradesState","setWeekTrades","cumulativePnLBeforeWeek","setCumulativePnLBeforeWeek","weeklyTargetPercentage","riskPerTrade","weekEnd","weekStartTime","fetchWeekData","tradedDaysCount","profitTarget","riskAmountDollars","tradedDaysProgress","profitProgress","profitTargetReached","tradedDaysReached","displayedTradedDays","displayedPnL","motivationalTip","generateMotivationalTip","subMessage","progressPercent","rMultiplesNeeded","validCombination","r2","r1","encouragements","randomEncouragement","tradesNeeded","CalendarMonthOutlined","Timelapse","TipsAndUpdates","getTradeTypeColorValue","tagEntries","visibleTags","remainingTagsCount","hasMoreTags","getTradeTypeIcon","WinIcon","LossIcon","BreakevenIcon","getTradeTypeColorName","RiskIcon","DateIcon","noWrap","SessionIcon","groupTags","AtomicBlock","decorator","createDecorator","createEditorStateFromValue","styleMap","createStyleMap","TEXT_COLORS","BACKGROUND_COLORS","customStyleMap","blockStyleFn","blockRendererFn","editable","RichTextViewer","NoteListItemShimmer","showCalendarPicker","setCalendars","selectedCalendarForNew","setSelectedCalendarForNew","selectedCalendarFilter","setSelectedCalendarFilter","creatorFilter","setCreatorFilter","viewerOpen","setViewerOpen","viewerNote","setViewerNote","loadingMore","loadMore","addNote","notesPerPage","setLoadingMore","setHasMore","setTotal","offsetRef","hasLoadedRef","prevFiltersRef","loadNotes","reset","queryOptions","effectiveCalendarId","useNotes","loadCalendars","handleNewNote","handleNoteClick","_note$calendar_id","handlePin","handleArchive","getCalendarForNote","NoteViewerDialog","handleViewerClose"],"sourceRoot":""}