# Firebase to Supabase Migration - Product Requirements Document

## Project Overview
Complete migration of the Simple Trade Tracker application from Firebase to Supabase infrastructure. This includes migrating authentication, database, storage, cloud functions, real-time subscriptions, and AI integrations while maintaining all existing functionality and user experience.

## Goals and Objectives
- **Primary Goal**: Migrate from Firebase to Supabase completely while maintaining 100% feature parity
- **Performance**: Maintain or improve application performance and response times
- **Cost Optimization**: Reduce infrastructure costs through Supabase's pricing model
- **Scalability**: Leverage PostgreSQL's advanced querying capabilities and performance
- **Security**: Maintain or enhance security posture with Supabase's Row Level Security
- **Developer Experience**: Improve development workflow with Supabase's developer tools
- **Zero Downtime**: Execute migration with minimal service disruption

## Current Firebase Architecture
### Authentication
- Firebase Auth with Google OAuth provider
- User session management and token handling
- App Check security verification

### Database (Firestore)
- Collections: calendars, sharedTrades, sharedCalendars, economicEvents
- Subcollections: calendars/{id}/years/{year} for trade data
- Real-time listeners for live updates
- Complex queries with compound indexes
- Transactions for data consistency

### Storage
- Firebase Storage for trade images
- User-based folder structure: users/{userId}/trade-images/
- Upload progress tracking and image optimization
- Automatic cleanup on trade deletion

### Cloud Functions
- **Triggers**: onTradeChangedV2, cleanupDeletedCalendarV2
- **Callable Functions**: updateTagV2, processHtmlEconomicEvents, refreshEconomicCalendar
- **Scheduled Functions**: autoRefreshEconomicCalendarV2, cleanupExpiredCalendarsV2
- **Sharing Functions**: generateTradeShareLinkV2, getSharedTradeV2, deactivateSharedTradeV2

### AI Integration
- Firebase AI Logic with Gemini models
- Vector search using Supabase (already partially implemented)
- Function calling for trading analysis

## Target Supabase Architecture
### Authentication
- Supabase Auth with Google OAuth provider
- Row Level Security (RLS) policies
- JWT token management

### Database (PostgreSQL)
- Relational tables replacing Firestore collections
- Proper foreign key relationships
- Advanced indexing for performance
- Real-time subscriptions for live updates

### Storage
- Supabase Storage with bucket-based organization
- Same folder structure and security policies
- Upload progress and optimization features

### Edge Functions
- Supabase Edge Functions replacing Firebase Cloud Functions
- Database triggers using PostgreSQL functions
- Scheduled functions using pg_cron
- HTTP endpoints for callable functions

### AI Integration
- Maintain existing vector search implementation
- Update AI functions to work with PostgreSQL data
- Optimize for Supabase's data structures

## Migration Requirements

### Phase 1: Database Schema Design & Setup
- Design PostgreSQL schema to replace Firestore structure
- Create tables: users, calendars, trades, shared_trades, shared_calendars, economic_events
- Implement proper relationships and foreign keys
- Set up indexes for performance optimization
- Create Row Level Security policies
- Design data migration scripts

### Phase 2: Authentication Migration
- Configure Supabase Auth with Google OAuth
- Create user migration scripts
- Update frontend authentication flows
- Implement session management
- Test authentication edge cases

### Phase 3: Storage Migration
- Set up Supabase Storage buckets and policies
- Create image migration scripts
- Update upload/download logic in frontend
- Implement progress tracking
- Test image operations

### Phase 4: Core Data Migration
- Implement dual-write system for safe migration
- Create data validation and consistency checks
- Execute bulk data migration from Firestore to Supabase
- Verify data integrity and completeness
- Handle migration rollback scenarios

### Phase 5: Business Logic Migration
- Convert Firebase Cloud Functions to Supabase Edge Functions
- Migrate database triggers to PostgreSQL functions
- Implement scheduled functions using pg_cron
- Update callable function endpoints
- Test all business logic thoroughly

### Phase 6: Real-time Functionality
- Replace Firestore listeners with Supabase real-time subscriptions
- Update frontend real-time event handling
- Test real-time performance and reliability
- Optimize subscription patterns

### Phase 7: Frontend Service Layer Updates
- Update all service files (calendarService.ts, authService.ts, etc.)
- Replace Firebase SDK calls with Supabase client calls
- Update data models and type definitions
- Implement error handling for Supabase-specific errors
- Update caching strategies

### Phase 8: AI Integration Updates
- Update AI functions to work with PostgreSQL data
- Optimize vector search queries
- Update function calling mechanisms
- Test AI chat functionality end-to-end

### Phase 9: Testing & Quality Assurance
- Comprehensive functional testing of all features
- Performance testing and optimization
- Security audit and penetration testing
- Load testing for scalability
- User acceptance testing

### Phase 10: Deployment & Cutover
- Prepare production deployment scripts
- Execute gradual rollout strategy
- Monitor system performance and errors
- Complete cutover from Firebase to Supabase
- Decommission Firebase resources

## Technical Requirements

### Database Schema Requirements
- Maintain data relationships and integrity
- Support complex queries for trading analytics
- Optimize for read-heavy workloads
- Handle time-series data efficiently
- Support full-text search capabilities

### Performance Requirements
- Page load times ≤ 2 seconds
- Real-time updates ≤ 100ms latency
- Support 1000+ concurrent users
- 99.9% uptime availability
- Database query response ≤ 500ms

### Security Requirements
- Row Level Security for all user data
- Secure API endpoints with proper authentication
- Encrypted data at rest and in transit
- Audit logging for sensitive operations
- GDPR compliance for user data

### Compatibility Requirements
- Maintain existing API contracts
- Support all current browsers and devices
- Backward compatibility during migration period
- No breaking changes to user workflows

## Success Criteria
- **Functional**: 100% feature parity with current Firebase implementation
- **Performance**: No degradation in application performance metrics
- **Security**: Pass security audit with no critical vulnerabilities
- **Reliability**: 99.9% uptime during and after migration
- **User Experience**: No user-facing disruptions during migration
- **Data Integrity**: 100% data migration accuracy with zero data loss
- **Cost**: Achieve target cost reduction of 30-50%

## Risk Mitigation
- **Data Loss**: Implement comprehensive backup and rollback procedures
- **Downtime**: Use dual-write strategy and gradual cutover
- **Performance Issues**: Extensive load testing and optimization
- **Security Vulnerabilities**: Security audit at each phase
- **Feature Regression**: Comprehensive automated testing suite

## Timeline and Milestones
- **Phase 1-2**: Database & Auth Setup (2-3 weeks)
- **Phase 3-4**: Storage & Data Migration (2-3 weeks)
- **Phase 5-6**: Business Logic & Real-time (3-4 weeks)
- **Phase 7-8**: Frontend & AI Updates (2-3 weeks)
- **Phase 9**: Testing & QA (2 weeks)
- **Phase 10**: Deployment & Cutover (1 week)
- **Total Timeline**: 12-16 weeks

## Dependencies
- Supabase project setup and configuration
- Database migration tools and scripts
- Comprehensive test data and scenarios
- Staging environment for testing
- Team training on Supabase technologies
