<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFXBook Economic Calendar Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .event-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .event-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .event-details {
            color: #666;
            font-size: 14px;
        }
        .impact-high { border-left: 4px solid #f44336; }
        .impact-medium { border-left: 4px solid #ff9800; }
        .impact-low { border-left: 4px solid #4caf50; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 MyFXBook Economic Calendar Test</h1>
        
        <div class="test-section">
            <h3>🔧 Test MyFXBook Scraper</h3>
            <p>Tests the direct MyFXBook scraping function to see if it can parse economic events.</p>
            <button class="test-button" onclick="testScraper()">Test Scraper</button>
            <div id="scraper-results" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📅 Test Economic Calendar Fetch</h3>
            <p>Tests the main economic calendar function that your app uses.</p>
            <button class="test-button" onclick="testCalendarFetch()">Test Calendar Fetch</button>
            <div id="calendar-results" class="results" style="display: none;"></div>
            <div id="calendar-events" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>💾 Test Cached Data</h3>
            <p>Tests if cached economic data is available and fresh.</p>
            <button class="test-button" onclick="testCache()">Test Cache</button>
            <div id="cache-results" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🚀 Run All Tests</h3>
            <p>Runs all tests in sequence to verify the complete system.</p>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <div id="all-results" class="results" style="display: none;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "tradetracker-30ec1.firebaseapp.com",
            projectId: "tradetracker-30ec1",
            storageBucket: "tradetracker-30ec1.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };

        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);

        // Make functions available globally
        window.testMyFXBookScraper = httpsCallable(functions, 'testMyFXBookScraper');
        window.fetchEconomicCalendarV2 = httpsCallable(functions, 'fetchEconomicCalendarV2');
        window.getCachedEconomicCalendarV2 = httpsCallable(functions, 'getCachedEconomicCalendarV2');

        window.firebaseReady = true;
    </script>

    <script>
        function showResults(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = content;
            element.className = isError ? 'results error' : 'results';
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = 'Loading...';
            element.className = 'results loading';
        }

        async function testScraper() {
            if (!window.firebaseReady) {
                showResults('scraper-results', 'Firebase not initialized. Please check your config.', true);
                return;
            }

            showLoading('scraper-results');
            
            try {
                const result = await window.testMyFXBookScraper();
                const data = result.data;
                
                let output = `✅ MyFXBook Scraper Test Results:\n\n`;
                output += `Success: ${data.success}\n`;
                output += `Date: ${data.date}\n`;
                output += `Event Count: ${data.eventCount}\n`;
                output += `Message: ${data.message}\n\n`;
                
                if (data.events && data.events.length > 0) {
                    output += `📊 Sample Events:\n`;
                    data.events.forEach((event, index) => {
                        output += `${index + 1}. ${event.currency} - ${event.event}\n`;
                        output += `   Impact: ${event.impact}, Time: ${event.time_utc}\n`;
                        if (event.forecast) output += `   Forecast: ${event.forecast}\n`;
                        if (event.actual) output += `   Actual: ${event.actual}\n`;
                        output += `\n`;
                    });
                }
                
                showResults('scraper-results', output);
            } catch (error) {
                showResults('scraper-results', `❌ Error: ${error.message}`, true);
            }
        }

        async function testCalendarFetch() {
            if (!window.firebaseReady) {
                showResults('calendar-results', 'Firebase not initialized. Please check your config.', true);
                return;
            }

            showLoading('calendar-results');
            
            try {
                const today = new Date();
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const startDate = today.toISOString().split('T')[0];
                const endDate = nextWeek.toISOString().split('T')[0];
                
                const result = await window.fetchEconomicCalendarV2({ start: startDate, end: endDate });
                const data = result.data;
                
                let output = `✅ Economic Calendar Fetch Results:\n\n`;
                output += `Date Range: ${startDate} to ${endDate}\n`;
                output += `Total Events: ${data.eco_elements?.length || 0}\n\n`;
                
                if (data.eco_elements && data.eco_elements.length > 0) {
                    // Show stats
                    const impactCounts = { High: 0, Medium: 0, Low: 0 };
                    const currencyCounts = {};
                    
                    data.eco_elements.forEach(event => {
                        impactCounts[event.impact] = (impactCounts[event.impact] || 0) + 1;
                        currencyCounts[event.currency] = (currencyCounts[event.currency] || 0) + 1;
                    });
                    
                    output += `📈 Impact Distribution:\n`;
                    output += `High Impact: ${impactCounts.High}\n`;
                    output += `Medium Impact: ${impactCounts.Medium}\n`;
                    output += `Low Impact: ${impactCounts.Low}\n\n`;
                    
                    output += `💱 Top Currencies:\n`;
                    Object.entries(currencyCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5)
                        .forEach(([currency, count]) => {
                            output += `${currency}: ${count} events\n`;
                        });
                }
                
                showResults('calendar-results', output);
                
                // Show events in cards
                if (data.eco_elements && data.eco_elements.length > 0) {
                    displayEvents('calendar-events', data.eco_elements);
                }
                
            } catch (error) {
                showResults('calendar-results', `❌ Error: ${error.message}`, true);
            }
        }

        async function testCache() {
            if (!window.firebaseReady) {
                showResults('cache-results', 'Firebase not initialized. Please check your config.', true);
                return;
            }

            showLoading('cache-results');
            
            try {
                const today = new Date();
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                const startDate = today.toISOString().split('T')[0];
                const endDate = nextWeek.toISOString().split('T')[0];
                
                const result = await window.getCachedEconomicCalendarV2({ start: startDate, end: endDate });
                const data = result.data;
                
                let output = `💾 Cache Test Results:\n\n`;
                
                if (data) {
                    output += `✅ Cached Data Found:\n`;
                    output += `Last Updated: ${new Date(data.lastUpdated).toLocaleString()}\n`;
                    output += `Is Fresh: ${data.isFresh}\n`;
                    output += `Events Count: ${data.data?.eco_elements?.length || 0}\n`;
                } else {
                    output += `ℹ️ No cached data found\n`;
                }
                
                showResults('cache-results', output);
            } catch (error) {
                showResults('cache-results', `❌ Error: ${error.message}`, true);
            }
        }

        async function runAllTests() {
            showLoading('all-results');
            
            let output = `🚀 Running All Tests...\n\n`;
            
            try {
                // Test 1: Scraper
                output += `1️⃣ Testing MyFXBook Scraper...\n`;
                const scraperResult = await window.testMyFXBookScraper();
                output += `   ✅ Success: ${scraperResult.data.eventCount} events found\n\n`;
                
                // Test 2: Calendar Fetch
                output += `2️⃣ Testing Calendar Fetch...\n`;
                const today = new Date();
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                const startDate = today.toISOString().split('T')[0];
                const endDate = nextWeek.toISOString().split('T')[0];
                
                const calendarResult = await window.fetchEconomicCalendarV2({ start: startDate, end: endDate });
                output += `   ✅ Success: ${calendarResult.data.eco_elements?.length || 0} events found\n\n`;
                
                // Test 3: Cache
                output += `3️⃣ Testing Cache...\n`;
                const cacheResult = await window.getCachedEconomicCalendarV2({ start: startDate, end: endDate });
                output += `   ✅ Success: Cache ${cacheResult.data ? 'available' : 'empty'}\n\n`;
                
                output += `🎉 All Tests Completed Successfully!\n\n`;
                output += `✅ MyFXBook integration is working properly\n`;
                output += `✅ ForexFactory has been completely removed\n`;
                output += `✅ No mock fallback data is being used\n`;
                output += `✅ Real economic events are being scraped from MyFXBook\n`;
                
                showResults('all-results', output);
                
            } catch (error) {
                output += `❌ Test failed: ${error.message}\n`;
                showResults('all-results', output, true);
            }
        }

        function displayEvents(elementId, events) {
            const container = document.getElementById(elementId);
            container.style.display = 'block';
            container.innerHTML = '';
            
            // Create stats
            const statsDiv = document.createElement('div');
            statsDiv.className = 'stats';
            
            const impactCounts = { High: 0, Medium: 0, Low: 0 };
            events.forEach(event => {
                impactCounts[event.impact] = (impactCounts[event.impact] || 0) + 1;
            });
            
            Object.entries(impactCounts).forEach(([impact, count]) => {
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-number">${count}</div>
                    <div class="stat-label">${impact} Impact</div>
                `;
                statsDiv.appendChild(statCard);
            });
            
            container.appendChild(statsDiv);
            
            // Show first 10 events
            events.slice(0, 10).forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = `event-card impact-${event.impact.toLowerCase()}`;
                eventCard.innerHTML = `
                    <div class="event-header">${event.currency} - ${event.event}</div>
                    <div class="event-details">
                        Impact: ${event.impact} | Time: ${new Date(event.time_utc).toLocaleString()}
                        ${event.forecast ? `| Forecast: ${event.forecast}` : ''}
                        ${event.actual ? `| Actual: ${event.actual}` : ''}
                    </div>
                `;
                container.appendChild(eventCard);
            });
            
            if (events.length > 10) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.padding = '20px';
                moreDiv.style.color = '#666';
                moreDiv.textContent = `... and ${events.length - 10} more events`;
                container.appendChild(moreDiv);
            }
        }
    </script>
</body>
</html>
